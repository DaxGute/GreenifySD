function Yc(){}function Nb(o,n){for(const c in n)o[c]=n[c];return o}function mx(o){return o()}function uy(){return Object.create(null)}function gh(o){o.forEach(mx)}function Ub(o){return typeof o=="function"}function Vb(o,n){return o!=o?n==n:o!==n||o&&typeof o=="object"||typeof o=="function"}let ed;function cI(o,n){return ed||(ed=document.createElement("a")),ed.href=n,o===ed.href}function jb(o){return Object.keys(o).length===0}function hI(o,n,c,m){if(o){const v=_x(o,n,c,m);return o[0](v)}}function _x(o,n,c,m){return o[1]&&m?Nb(c.ctx.slice(),o[1](m(n))):c.ctx}function uI(o,n,c,m){if(o[2]&&m){const v=o[2](m(c));if(n.dirty===void 0)return v;if(typeof v=="object"){const S=[],L=Math.max(n.dirty.length,v.length);for(let a=0;a<L;a+=1)S[a]=n.dirty[a]|v[a];return S}return n.dirty|v}return n.dirty}function dI(o,n,c,m,v,S){if(v){const L=_x(n,c,m,S);o.p(L,v)}}function pI(o){if(o.ctx.length>32){const n=[],c=o.ctx.length/32;for(let m=0;m<c;m++)n[m]=-1;return n}return-1}let Ad=!1;function $b(){Ad=!0}function Gb(){Ad=!1}function qb(o,n,c,m){for(;o<n;){const v=o+(n-o>>1);c(v)<=m?o=v+1:n=v}return o}function Zb(o){if(o.hydrate_init)return;o.hydrate_init=!0;let n=o.childNodes;if(o.nodeName==="HEAD"){const W=[];for(let ie=0;ie<n.length;ie++){const ge=n[ie];ge.claim_order!==void 0&&W.push(ge)}n=W}const c=new Int32Array(n.length+1),m=new Int32Array(n.length);c[0]=-1;let v=0;for(let W=0;W<n.length;W++){const ie=n[W].claim_order,ge=(v>0&&n[c[v]].claim_order<=ie?v+1:qb(1,v,ze=>n[c[ze]].claim_order,ie))-1;m[W]=c[ge]+1;const ue=ge+1;c[ue]=W,v=Math.max(ue,v)}const S=[],L=[];let a=n.length-1;for(let W=c[v]+1;W!=0;W=m[W-1]){for(S.push(n[W-1]);a>=W;a--)L.push(n[a]);a--}for(;a>=0;a--)L.push(n[a]);S.reverse(),L.sort((W,ie)=>W.claim_order-ie.claim_order);for(let W=0,ie=0;W<L.length;W++){for(;ie<S.length&&L[W].claim_order>=S[ie].claim_order;)ie++;const ge=ie<S.length?S[ie]:null;o.insertBefore(L[W],ge)}}function Wb(o,n){if(Ad){for(Zb(o),(o.actual_end_child===void 0||o.actual_end_child!==null&&o.actual_end_child.parentElement!==o)&&(o.actual_end_child=o.firstChild);o.actual_end_child!==null&&o.actual_end_child.claim_order===void 0;)o.actual_end_child=o.actual_end_child.nextSibling;n!==o.actual_end_child?(n.claim_order!==void 0||n.parentNode!==o)&&o.insertBefore(n,o.actual_end_child):o.actual_end_child=n.nextSibling}else(n.parentNode!==o||n.nextSibling!==null)&&o.appendChild(n)}function fI(o,n,c){Ad&&!c?Wb(o,n):(n.parentNode!==o||n.nextSibling!=c)&&o.insertBefore(n,c||null)}function Xb(o){o.parentNode.removeChild(o)}function Hb(o){return document.createElement(o)}function dm(o){return document.createTextNode(o)}function mI(){return dm(" ")}function _I(){return dm("")}function gI(o,n,c,m){return o.addEventListener(n,c,m),()=>o.removeEventListener(n,c,m)}function yI(o,n,c){c==null?o.removeAttribute(n):o.getAttribute(n)!==c&&o.setAttribute(n,c)}function xI(o){return o===""?null:+o}function Kb(o){return Array.from(o.childNodes)}function Yb(o){o.claim_info===void 0&&(o.claim_info={last_index:0,total_claimed:0})}function gx(o,n,c,m,v=!1){Yb(o);const S=(()=>{for(let L=o.claim_info.last_index;L<o.length;L++){const a=o[L];if(n(a)){const W=c(a);return W===void 0?o.splice(L,1):o[L]=W,v||(o.claim_info.last_index=L),a}}for(let L=o.claim_info.last_index-1;L>=0;L--){const a=o[L];if(n(a)){const W=c(a);return W===void 0?o.splice(L,1):o[L]=W,v?W===void 0&&o.claim_info.last_index--:o.claim_info.last_index=L,a}}return m()})();return S.claim_order=o.claim_info.total_claimed,o.claim_info.total_claimed+=1,S}function Jb(o,n,c,m){return gx(o,v=>v.nodeName===n,v=>{const S=[];for(let L=0;L<v.attributes.length;L++){const a=v.attributes[L];c[a.name]||S.push(a.name)}S.forEach(L=>v.removeAttribute(L))},()=>m(n))}function vI(o,n,c){return Jb(o,n,c,Hb)}function Qb(o,n){return gx(o,c=>c.nodeType===3,c=>{const m=""+n;if(c.data.startsWith(m)){if(c.data.length!==m.length)return c.splitText(m.length)}else c.data=m},()=>dm(n),!0)}function bI(o){return Qb(o," ")}function wI(o,n){n=""+n,o.wholeText!==n&&(o.data=n)}function TI(o,n){o.value=n==null?"":n}function EI(o,n,c,m){c===null?o.style.removeProperty(n):o.style.setProperty(n,c,m?"important":"")}let rh;function Jc(o){rh=o}function pm(){if(!rh)throw new Error("Function called outside component initialization");return rh}function SI(o){pm().$$.on_mount.push(o)}function II(o){pm().$$.after_update.push(o)}function AI(o,n){pm().$$.context.set(o,n)}const Xc=[],dy=[],ad=[],Rf=[],yx=Promise.resolve();let Bf=!1;function xx(){Bf||(Bf=!0,yx.then(vx))}function CI(){return xx(),yx}function Ff(o){ad.push(o)}function MI(o){Rf.push(o)}const vf=new Set;let td=0;function vx(){const o=rh;do{for(;td<Xc.length;){const n=Xc[td];td++,Jc(n),ew(n.$$)}for(Jc(null),Xc.length=0,td=0;dy.length;)dy.pop()();for(let n=0;n<ad.length;n+=1){const c=ad[n];vf.has(c)||(vf.add(c),c())}ad.length=0}while(Xc.length);for(;Rf.length;)Rf.pop()();Bf=!1,vf.clear(),Jc(o)}function ew(o){if(o.fragment!==null){o.update(),gh(o.before_update);const n=o.dirty;o.dirty=[-1],o.fragment&&o.fragment.p(o.ctx,n),o.after_update.forEach(Ff)}}const ld=new Set;let ra;function kI(){ra={r:0,c:[],p:ra}}function DI(){ra.r||gh(ra.c),ra=ra.p}function tw(o,n){o&&o.i&&(ld.delete(o),o.i(n))}function zI(o,n,c,m){if(o&&o.o){if(ld.has(o))return;ld.add(o),ra.c.push(()=>{ld.delete(o),m&&(c&&o.d(1),m())}),o.o(n)}}function PI(o,n){const c={},m={},v={$$scope:1};let S=o.length;for(;S--;){const L=o[S],a=n[S];if(a){for(const W in L)W in a||(m[W]=1);for(const W in a)v[W]||(c[W]=a[W],v[W]=1);o[S]=a}else for(const W in L)v[W]=1}for(const L in m)L in c||(c[L]=void 0);return c}function LI(o){return typeof o=="object"&&o!==null?o:{}}function RI(o,n,c){const m=o.$$.props[n];m!==void 0&&(o.$$.bound[m]=c,c(o.$$.ctx[m]))}function BI(o){o&&o.c()}function FI(o,n){o&&o.l(n)}function iw(o,n,c,m){const{fragment:v,on_mount:S,on_destroy:L,after_update:a}=o.$$;v&&v.m(n,c),m||Ff(()=>{const W=S.map(mx).filter(Ub);L?L.push(...W):gh(W),o.$$.on_mount=[]}),a.forEach(Ff)}function rw(o,n){const c=o.$$;c.fragment!==null&&(gh(c.on_destroy),c.fragment&&c.fragment.d(n),c.on_destroy=c.fragment=null,c.ctx=[])}function nw(o,n){o.$$.dirty[0]===-1&&(Xc.push(o),xx(),o.$$.dirty.fill(0)),o.$$.dirty[n/31|0]|=1<<n%31}function OI(o,n,c,m,v,S,L,a=[-1]){const W=rh;Jc(o);const ie=o.$$={fragment:null,ctx:null,props:S,update:Yc,not_equal:v,bound:uy(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(n.context||(W?W.$$.context:[])),callbacks:uy(),dirty:a,skip_bound:!1,root:n.target||W.$$.root};L&&L(ie.root);let ge=!1;if(ie.ctx=c?c(o,n.props||{},(ue,ze,...fe)=>{const it=fe.length?fe[0]:ze;return ie.ctx&&v(ie.ctx[ue],ie.ctx[ue]=it)&&(!ie.skip_bound&&ie.bound[ue]&&ie.bound[ue](it),ge&&nw(o,ue)),ze}):[],ie.update(),ge=!0,gh(ie.before_update),ie.fragment=m?m(ie.ctx):!1,n.target){if(n.hydrate){$b();const ue=Kb(n.target);ie.fragment&&ie.fragment.l(ue),ue.forEach(Xb)}else ie.fragment&&ie.fragment.c();n.intro&&tw(o.$$.fragment),iw(o,n.target,n.anchor,n.customElement),Gb(),vx()}Jc(W)}class NI{$destroy(){rw(this,1),this.$destroy=Yc}$on(n,c){const m=this.$$.callbacks[n]||(this.$$.callbacks[n]=[]);return m.push(c),()=>{const v=m.indexOf(c);v!==-1&&m.splice(v,1)}}$set(n){this.$$set&&!jb(n)&&(this.$$.skip_bound=!0,this.$$set(n),this.$$.skip_bound=!1)}}const Sl=[];function UI(o,n=Yc){let c;const m=new Set;function v(a){if(Vb(o,a)&&(o=a,c)){const W=!Sl.length;for(const ie of m)ie[1](),Sl.push(ie,o);if(W){for(let ie=0;ie<Sl.length;ie+=2)Sl[ie][0](Sl[ie+1]);Sl.length=0}}}function S(a){v(a(o))}function L(a,W=Yc){const ie=[a,W];return m.add(ie),m.size===1&&(c=n(v)||Yc),a(o),()=>{m.delete(ie),m.size===0&&(c(),c=null)}}return{set:v,update:S,subscribe:L}}var sw=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},bx={exports:{}};(function(o,n){(function(c,m){o.exports=m()})(sw,function(){var c,m,v;function S(a,W){if(!c)c=W;else if(!m)m=W;else{var ie="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+c+")(sharedChunk); ("+m+")(sharedChunk); self.onerror = null;",ge={};c(ge),v=W(ge),typeof window!="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(v.workerUrl=window.URL.createObjectURL(new Blob([ie],{type:"text/javascript"})))}}S(["exports"],function(a){var W="2.7.1",ie=ge;function ge(t,e,r,s){this.cx=3*t,this.bx=3*(r-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(s-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=s,this.p2x=r,this.p2y=s}ge.prototype.sampleCurveX=function(t){return((this.ax*t+this.bx)*t+this.cx)*t},ge.prototype.sampleCurveY=function(t){return((this.ay*t+this.by)*t+this.cy)*t},ge.prototype.sampleCurveDerivativeX=function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},ge.prototype.solveCurveX=function(t,e){var r,s,h,u,f;for(e===void 0&&(e=1e-6),h=t,f=0;f<8;f++){if(u=this.sampleCurveX(h)-t,Math.abs(u)<e)return h;var g=this.sampleCurveDerivativeX(h);if(Math.abs(g)<1e-6)break;h-=u/g}if((h=t)<(r=0))return r;if(h>(s=1))return s;for(;r<s;){if(u=this.sampleCurveX(h),Math.abs(u-t)<e)return h;t>u?r=h:s=h,h=.5*(s-r)+r}return h},ge.prototype.solve=function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))};var ue=ze;function ze(t,e){this.x=t,this.y=e}ze.prototype={clone:function(){return new ze(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,r=t.y-this.y;return e*e+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=e,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),r=Math.sin(t),s=r*this.x+e*this.y;return this.x=e*this.x-r*this.y,this.y=s,this},_rotateAround:function(t,e){var r=Math.cos(t),s=Math.sin(t),h=e.y+s*(this.x-e.x)+r*(this.y-e.y);return this.x=e.x+r*(this.x-e.x)-s*(this.y-e.y),this.y=h,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},ze.convert=function(t){return t instanceof ze?t:Array.isArray(t)?new ze(t[0],t[1]):t};var fe=typeof self!="undefined"?self:{},it=1e-6,dt=typeof Float32Array!="undefined"?Float32Array:Array;function pi(){var t=new dt(9);return dt!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function ti(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function $i(t,e,r){var s=e[0],h=e[1],u=e[2],f=e[3],g=e[4],x=e[5],w=e[6],E=e[7],I=e[8],A=e[9],z=e[10],R=e[11],O=e[12],U=e[13],Z=e[14],Q=e[15],ne=r[0],oe=r[1],ae=r[2],le=r[3];return t[0]=ne*s+oe*g+ae*I+le*O,t[1]=ne*h+oe*x+ae*A+le*U,t[2]=ne*u+oe*w+ae*z+le*Z,t[3]=ne*f+oe*E+ae*R+le*Q,t[4]=(ne=r[4])*s+(oe=r[5])*g+(ae=r[6])*I+(le=r[7])*O,t[5]=ne*h+oe*x+ae*A+le*U,t[6]=ne*u+oe*w+ae*z+le*Z,t[7]=ne*f+oe*E+ae*R+le*Q,t[8]=(ne=r[8])*s+(oe=r[9])*g+(ae=r[10])*I+(le=r[11])*O,t[9]=ne*h+oe*x+ae*A+le*U,t[10]=ne*u+oe*w+ae*z+le*Z,t[11]=ne*f+oe*E+ae*R+le*Q,t[12]=(ne=r[12])*s+(oe=r[13])*g+(ae=r[14])*I+(le=r[15])*O,t[13]=ne*h+oe*x+ae*A+le*U,t[14]=ne*u+oe*w+ae*z+le*Z,t[15]=ne*f+oe*E+ae*R+le*Q,t}function Gi(t,e,r){var s,h,u,f,g,x,w,E,I,A,z,R,O=r[0],U=r[1],Z=r[2];return e===t?(t[12]=e[0]*O+e[4]*U+e[8]*Z+e[12],t[13]=e[1]*O+e[5]*U+e[9]*Z+e[13],t[14]=e[2]*O+e[6]*U+e[10]*Z+e[14],t[15]=e[3]*O+e[7]*U+e[11]*Z+e[15]):(h=e[1],u=e[2],f=e[3],g=e[4],x=e[5],w=e[6],E=e[7],I=e[8],A=e[9],z=e[10],R=e[11],t[0]=s=e[0],t[1]=h,t[2]=u,t[3]=f,t[4]=g,t[5]=x,t[6]=w,t[7]=E,t[8]=I,t[9]=A,t[10]=z,t[11]=R,t[12]=s*O+g*U+I*Z+e[12],t[13]=h*O+x*U+A*Z+e[13],t[14]=u*O+w*U+z*Z+e[14],t[15]=f*O+E*U+R*Z+e[15]),t}function Ti(t,e,r){var s=r[0],h=r[1],u=r[2];return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*h,t[5]=e[5]*h,t[6]=e[6]*h,t[7]=e[7]*h,t[8]=e[8]*u,t[9]=e[9]*u,t[10]=e[10]*u,t[11]=e[11]*u,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function cn(t,e,r){var s=Math.sin(r),h=Math.cos(r),u=e[4],f=e[5],g=e[6],x=e[7],w=e[8],E=e[9],I=e[10],A=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=u*h+w*s,t[5]=f*h+E*s,t[6]=g*h+I*s,t[7]=x*h+A*s,t[8]=w*h-u*s,t[9]=E*h-f*s,t[10]=I*h-g*s,t[11]=A*h-x*s,t}function br(t,e,r){var s=Math.sin(r),h=Math.cos(r),u=e[0],f=e[1],g=e[2],x=e[3],w=e[8],E=e[9],I=e[10],A=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=u*h-w*s,t[1]=f*h-E*s,t[2]=g*h-I*s,t[3]=x*h-A*s,t[8]=u*s+w*h,t[9]=f*s+E*h,t[10]=g*s+I*h,t[11]=x*s+A*h,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var Xr=$i;function lo(){var t=new dt(3);return dt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Kn(t){var e=new dt(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function _a(t){return Math.hypot(t[0],t[1],t[2])}function hn(t,e,r){var s=new dt(3);return s[0]=t,s[1]=e,s[2]=r,s}function co(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t}function gs(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function ys(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t}function Zl(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t}function Hr(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function wr(t,e,r,s){return t[0]=e[0]+r[0]*s,t[1]=e[1]+r[1]*s,t[2]=e[2]+r[2]*s,t}function xs(t,e){var r=e[0],s=e[1],h=e[2],u=r*r+s*s+h*h;return u>0&&(u=1/Math.sqrt(u)),t[0]=e[0]*u,t[1]=e[1]*u,t[2]=e[2]*u,t}function Kr(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function vs(t,e,r){var s=e[0],h=e[1],u=e[2],f=r[0],g=r[1],x=r[2];return t[0]=h*x-u*g,t[1]=u*f-s*x,t[2]=s*g-h*f,t}function Tt(t,e,r){var s=e[0],h=e[1],u=e[2],f=r[3]*s+r[7]*h+r[11]*u+r[15];return t[0]=(r[0]*s+r[4]*h+r[8]*u+r[12])/(f=f||1),t[1]=(r[1]*s+r[5]*h+r[9]*u+r[13])/f,t[2]=(r[2]*s+r[6]*h+r[10]*u+r[14])/f,t}function ga(t,e,r){var s=r[0],h=r[1],u=r[2],f=e[0],g=e[1],x=e[2],w=h*x-u*g,E=u*f-s*x,I=s*g-h*f,A=h*I-u*E,z=u*w-s*I,R=s*E-h*w,O=2*r[3];return E*=O,I*=O,z*=2,R*=2,t[0]=f+(w*=O)+(A*=2),t[1]=g+E+z,t[2]=x+I+R,t}var Yn,Jn=gs,Wl=ys,bs=_a;function Yr(t,e,r){var s=e[0],h=e[1],u=e[2],f=e[3];return t[0]=r[0]*s+r[4]*h+r[8]*u+r[12]*f,t[1]=r[1]*s+r[5]*h+r[9]*u+r[13]*f,t[2]=r[2]*s+r[6]*h+r[10]*u+r[14]*f,t[3]=r[3]*s+r[7]*h+r[11]*u+r[15]*f,t}function ho(){var t=new dt(4);return dt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function ya(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function xa(t,e,r){r*=.5;var s=e[0],h=e[1],u=e[2],f=e[3],g=Math.sin(r),x=Math.cos(r);return t[0]=s*x+f*g,t[1]=h*x+u*g,t[2]=u*x-h*g,t[3]=f*x-s*g,t}function uo(t,e){return t[0]===e[0]&&t[1]===e[1]}lo(),Yn=new dt(4),dt!=Float32Array&&(Yn[0]=0,Yn[1]=0,Yn[2]=0,Yn[3]=0),lo(),hn(1,0,0),hn(0,1,0),ho(),ho(),pi(),function(){var t;t=new dt(2),dt!=Float32Array&&(t[0]=0,t[1]=0)}();const va=Math.PI/180,ws=180/Math.PI;function gt(t){return t*va}function hr(t){return t*ws}const Qn=[[0,0],[1,0],[1,1],[0,1]];function po(t){if(t<=0)return 0;if(t>=1)return 1;const e=t*t,r=e*t;return 4*(t<.5?r:3*(t-e)+r-.75)}function fo(t,e,r,s){const h=new ie(t,e,r,s);return function(u){return h.solve(u)}}const mo=fo(.25,.1,.25,1);function Ft(t,e,r){return Math.min(r,Math.max(e,t))}function In(t,e,r){return(r=Ft((r-t)/(e-t),0,1))*r*(3-2*r)}function un(t,e,r){const s=r-e,h=((t-e)%s+s)%s+e;return h===e?r:h}function es(t,e,r){if(!t.length)return r(null,[]);let s=t.length;const h=new Array(t.length);let u=null;t.forEach((f,g)=>{e(f,(x,w)=>{x&&(u=x),h[g]=w,--s==0&&r(u,h)})})}function Ts(t){const e=[];for(const r in t)e.push(t[r]);return e}function si(t,...e){for(const r of e)for(const s in r)t[s]=r[s];return t}let _o=1;function go(){return _o++}function yo(){return function t(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()}function Tr(t){return t<=1?1:Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}function ba(t){return!!t&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}function Es(t,e){t.forEach(r=>{e[r]&&(e[r]=e[r].bind(e))})}function Ss(t,e){return t.indexOf(e,t.length-e.length)!==-1}function An(t,e,r){const s={};for(const h in t)s[h]=e.call(r||this,t[h],h,t);return s}function Is(t,e,r){const s={};for(const h in t)e.call(r||this,t[h],h,t)&&(s[h]=t[h]);return s}function Er(t){return Array.isArray(t)?t.map(Er):typeof t=="object"&&t?An(t,Er):t}const wa={};function ii(t){wa[t]||(typeof console!="undefined"&&console.warn(t),wa[t]=!0)}function Sr(t,e,r){return(r.y-t.y)*(e.x-t.x)>(e.y-t.y)*(r.x-t.x)}function As(t){let e=0;for(let r,s,h=0,u=t.length,f=u-1;h<u;f=h++)r=t[h],s=t[f],e+=(s.x-r.x)*(r.y+s.y);return e}function Jr(){return typeof WorkerGlobalScope!="undefined"&&typeof self!="undefined"&&self instanceof WorkerGlobalScope}function Cs(t){const e={};if(t.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,s,h,u)=>{const f=h||u;return e[s]=!f||f.toLowerCase(),""}),e["max-age"]){const r=parseInt(e["max-age"],10);isNaN(r)?delete e["max-age"]:e["max-age"]=r}return e}let ts,dn,Fr,Cn=null;function Or(t){if(Cn==null){const e=t.navigator?t.navigator.userAgent:null;Cn=!!t.safari||!(!e||!(/\b(iPad|iPhone|iPod)\b/.test(e)||e.match("Safari")&&!e.match("Chrome")))}return Cn}function Ms(t){try{const e=fe[t];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}}const ur={now:()=>Fr!==void 0?Fr:fe.performance.now(),setNow(t){Fr=t},restoreNow(){Fr=void 0},frame(t){const e=fe.requestAnimationFrame(t);return{cancel:()=>fe.cancelAnimationFrame(e)}},getImageData(t,e=0){const r=fe.document.createElement("canvas"),s=r.getContext("2d");if(!s)throw new Error("failed to create canvas 2d context");return r.width=t.width,r.height=t.height,s.drawImage(t,0,0,t.width,t.height),s.getImageData(-e,-e,t.width+2*e,t.height+2*e)},resolveURL:t=>(ts||(ts=fe.document.createElement("a")),ts.href=t,ts.href),get devicePixelRatio(){return fe.devicePixelRatio},get prefersReducedMotion(){return!!fe.matchMedia&&(dn==null&&(dn=fe.matchMedia("(prefers-reduced-motion: reduce)")),dn.matches)}};let q;const D={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(q==null){const t=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{q={}.API_URL_REGEX!=null?new RegExp({}.API_URL_REGEX):t}catch{q=t}}return q},get EVENTS_URL(){return this.API_URL?this.API_URL.indexOf("https://api.mapbox.cn")===0?"https://events.mapbox.cn/events/v2":this.API_URL.indexOf("https://api.mapbox.com")===0?"https://events.mapbox.com/events/v2":null:null},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},B={supported:!1,testSupport:function(t){!re&&X&&(ce?he(t):G=t)}};let G,X,re=!1,ce=!1;function he(t){const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e);try{if(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,X),t.isContextLost())return;B.supported=!0}catch{}t.deleteTexture(e),re=!0}fe.document&&(X=fe.document.createElement("img"),X.onload=function(){G&&he(G),G=null,ce=!0},X.onerror=function(){re=!0,G=null},X.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const se="01",pe="NO_ACCESS_TOKEN";function Te(t){return t.indexOf("mapbox:")===0}function Se(t){return D.API_URL_REGEX.test(t)}const Me=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function We(t){const e=t.match(Me);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function Je(t){const e=t.params.length?`?${t.params.join("&")}`:"";return`${t.protocol}://${t.authority}${t.path}${e}`}function Qe(t){if(!t)return null;const e=t.split(".");if(!e||e.length!==3)return null;try{return JSON.parse(decodeURIComponent(fe.atob(e[1]).split("").map(r=>"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class tt{constructor(e){this.type=e,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(e){const r=Qe(D.ACCESS_TOKEN);let s="";return s=r&&r.u?fe.btoa(encodeURIComponent(r.u).replace(/%([0-9A-F]{2})/g,(h,u)=>String.fromCharCode(Number("0x"+u)))):D.ACCESS_TOKEN||"",e?`mapbox.eventData.${e}:${s}`:`mapbox.eventData:${s}`}fetchEventData(){const e=Ms("localStorage"),r=this.getStorageKey(),s=this.getStorageKey("uuid");if(e)try{const h=fe.localStorage.getItem(r);h&&(this.eventData=JSON.parse(h));const u=fe.localStorage.getItem(s);u&&(this.anonId=u)}catch{ii("Unable to read from LocalStorage")}}saveEventData(){const e=Ms("localStorage"),r=this.getStorageKey(),s=this.getStorageKey("uuid");if(e)try{fe.localStorage.setItem(s,this.anonId),Object.keys(this.eventData).length>=1&&fe.localStorage.setItem(r,JSON.stringify(this.eventData))}catch{ii("Unable to write to LocalStorage")}}processRequests(e){}postEvent(e,r,s,h){if(!D.EVENTS_URL)return;const u=We(D.EVENTS_URL);u.params.push(`access_token=${h||D.ACCESS_TOKEN||""}`);const f={event:this.type,created:new Date(e).toISOString(),sdkIdentifier:"mapbox-gl-js",sdkVersion:W,skuId:se,userId:this.anonId},g=r?si(f,r):f,x={url:Je(u),headers:{"Content-Type":"text/plain"},body:JSON.stringify([g])};this.pendingRequest=en(x,w=>{this.pendingRequest=null,s(w),this.saveEventData(),this.processRequests(h)})}queueRequest(e,r){this.queue.push(e),this.processRequests(r)}}const mt=new class extends tt{constructor(t){super("appUserTurnstile"),this._customAccessToken=t}postTurnstileEvent(t,e){D.EVENTS_URL&&D.ACCESS_TOKEN&&Array.isArray(t)&&t.some(r=>Te(r)||Se(r))&&this.queueRequest(Date.now(),e)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const e=Qe(D.ACCESS_TOKEN),r=e?e.u:D.ACCESS_TOKEN;let s=r!==this.eventData.tokenU;ba(this.anonId)||(this.anonId=yo(),s=!0);const h=this.queue.shift();if(this.eventData.lastSuccess){const u=new Date(this.eventData.lastSuccess),f=new Date(h),g=(h-this.eventData.lastSuccess)/864e5;s=s||g>=1||g<-1||u.getDate()!==f.getDate()}else s=!0;if(!s)return this.processRequests();this.postEvent(h,{"enabled.telemetry":!1},u=>{u||(this.eventData.lastSuccess=h,this.eventData.tokenU=r)},t)}},qt=mt.postTurnstileEvent.bind(mt),Ht=new class extends tt{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(t,e,r,s){this.skuToken=e,this.errorCb=s,D.EVENTS_URL&&(r||D.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},r):this.errorCb(new Error(pe)))}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:r}=this.queue.shift();e&&this.success[e]||(this.anonId||this.fetchEventData(),ba(this.anonId)||(this.anonId=yo()),this.postEvent(r,{skuToken:this.skuToken},s=>{s?this.errorCb(s):e&&(this.success[e]=!0)},t))}},Vt=Ht.postMapLoadEvent.bind(Ht),Kt=new class extends tt{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(t,e,r,s){if(!D.API_URL||!D.SESSION_PATH)return;const h=We(D.API_URL+D.SESSION_PATH);h.params.push(`sku=${e||""}`),h.params.push(`access_token=${s||D.ACCESS_TOKEN||""}`);const u={url:Je(h),headers:{"Content-Type":"text/plain"}};this.pendingRequest=Hd(u,f=>{this.pendingRequest=null,r(f),this.saveEventData(),this.processRequests(s)})}getSessionAPI(t,e,r,s){this.skuToken=e,this.errorCb=s,D.SESSION_PATH&&D.API_URL&&(r||D.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},r):this.errorCb(new Error(pe)))}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:r}=this.queue.shift();e&&this.success[e]||this.getSession(r,this.skuToken,s=>{s?this.errorCb(s):e&&(this.success[e]=!0)},t)}},Mn=Kt.getSessionAPI.bind(Kt),pn=new Set,Ri="mapbox-tiles";let Qr,Ta,Dh=500,Xl=50;function xo(){fe.caches&&!Qr&&(Qr=fe.caches.open(Ri))}function Hl(t){const e=t.indexOf("?");return e<0?t:t.slice(0,e)}let Ea=1/0;const Sa={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};typeof Object.freeze=="function"&&Object.freeze(Sa);class vo extends Error{constructor(e,r,s){r===401&&Se(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes"),super(e),this.status=r,this.url=s}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Kl=Jr()?()=>self.worker&&self.worker.referrer:()=>(fe.location.protocol==="blob:"?fe.parent:fe).location.href,Nr=function(t,e){if(!(/^file:/.test(r=t.url)||/^file:/.test(Kl())&&!/^\w+:/.test(r))){if(fe.fetch&&fe.Request&&fe.AbortController&&fe.Request.prototype.hasOwnProperty("signal"))return function(s,h){const u=new fe.AbortController,f=new fe.Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:Kl(),signal:u.signal});let g=!1,x=!1;const w=(E=f.url).indexOf("sku=")>0&&Se(E);var E;s.type==="json"&&f.headers.set("Accept","application/json");const I=(z,R,O)=>{if(x)return;if(z&&z.message!=="SecurityError"&&ii(z),R&&O)return A(R);const U=Date.now();fe.fetch(f).then(Z=>{if(Z.ok){const Q=w?Z.clone():null;return A(Z,Q,U)}return h(new vo(Z.statusText,Z.status,s.url))}).catch(Z=>{Z.code!==20&&h(new Error(Z.message))})},A=(z,R,O)=>{(s.type==="arrayBuffer"?z.arrayBuffer():s.type==="json"?z.json():z.text()).then(U=>{x||(R&&O&&function(Z,Q,ne){if(xo(),!Qr)return;const oe={status:Q.status,statusText:Q.statusText,headers:new fe.Headers};Q.headers.forEach((le,we)=>oe.headers.set(we,le));const ae=Cs(Q.headers.get("Cache-Control")||"");ae["no-store"]||(ae["max-age"]&&oe.headers.set("Expires",new Date(ne+1e3*ae["max-age"]).toUTCString()),new Date(oe.headers.get("Expires")).getTime()-ne<42e4||function(le,we){if(Ta===void 0)try{new Response(new ReadableStream),Ta=!0}catch{Ta=!1}Ta?we(le.body):le.blob().then(we)}(Q,le=>{const we=new fe.Response(le,oe);xo(),Qr&&Qr.then(ve=>ve.put(Hl(Z.url),we)).catch(ve=>ii(ve.message))}))}(f,R,O),g=!0,h(null,U,z.headers.get("Cache-Control"),z.headers.get("Expires")))}).catch(U=>{x||h(new Error(U.message))})};return w?function(z,R){if(xo(),!Qr)return R(null);const O=Hl(z.url);Qr.then(U=>{U.match(O).then(Z=>{const Q=function(ne){if(!ne)return!1;const oe=new Date(ne.headers.get("Expires")||0),ae=Cs(ne.headers.get("Cache-Control")||"");return oe>Date.now()&&!ae["no-cache"]}(Z);U.delete(O),Q&&U.put(O,Z.clone()),R(null,Z,Q)}).catch(R)}).catch(R)}(f,I):I(null,null),{cancel:()=>{x=!0,g||u.abort()}}}(t,e);if(Jr()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",t,e,void 0,!0)}var r;return function(s,h){const u=new fe.XMLHttpRequest;u.open(s.method||"GET",s.url,!0),s.type==="arrayBuffer"&&(u.responseType="arraybuffer");for(const f in s.headers)u.setRequestHeader(f,s.headers[f]);return s.type==="json"&&(u.responseType="text",u.setRequestHeader("Accept","application/json")),u.withCredentials=s.credentials==="include",u.onerror=()=>{h(new Error(u.statusText))},u.onload=()=>{if((u.status>=200&&u.status<300||u.status===0)&&u.response!==null){let f=u.response;if(s.type==="json")try{f=JSON.parse(u.response)}catch(g){return h(g)}h(null,f,u.getResponseHeader("Cache-Control"),u.getResponseHeader("Expires"))}else h(new vo(u.statusText,u.status,s.url))},u.send(s.body),{cancel:()=>u.abort()}}(t,e)},bo=function(t,e){return Nr(si(t,{type:"arrayBuffer"}),e)},en=function(t,e){return Nr(si(t,{method:"POST"}),e)},Hd=function(t,e){return Nr(si(t,{method:"GET"}),e)};function zh(t){const e=fe.document.createElement("a");return e.href=t,e.protocol===fe.document.location.protocol&&e.host===fe.document.location.host}const ks="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Ds,wo;Ds=[],wo=0;const Ph=function(t,e){if(B.supported&&(t.headers||(t.headers={}),t.headers.accept="image/webp,*/*"),wo>=D.MAX_PARALLEL_IMAGE_REQUESTS){const u={requestParameters:t,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Ds.push(u),u}wo++;let r=!1;const s=()=>{if(!r)for(r=!0,wo--;Ds.length&&wo<D.MAX_PARALLEL_IMAGE_REQUESTS;){const u=Ds.shift(),{requestParameters:f,callback:g,cancelled:x}=u;x||(u.cancel=Ph(f,g).cancel)}},h=bo(t,(u,f,g,x)=>{s(),u?e(u):f&&(fe.createImageBitmap?function(w,E){const I=new fe.Blob([new Uint8Array(w)],{type:"image/png"});fe.createImageBitmap(I).then(A=>{E(null,A)}).catch(A=>{E(new Error(`Could not load image because of ${A.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(f,(w,E)=>e(w,E,g,x)):function(w,E){const I=new fe.Image,A=fe.URL;I.onload=()=>{E(null,I),A.revokeObjectURL(I.src),I.onload=null,fe.requestAnimationFrame(()=>{I.src=ks})},I.onerror=()=>E(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const z=new fe.Blob([new Uint8Array(w)],{type:"image/png"});I.src=w.byteLength?A.createObjectURL(z):ks}(f,(w,E)=>e(w,E,g,x)))});return{cancel:()=>{h.cancel(),s()}}};function Lh(t,e,r){r[t]&&r[t].indexOf(e)!==-1||(r[t]=r[t]||[],r[t].push(e))}function Ia(t,e,r){if(r&&r[t]){const s=r[t].indexOf(e);s!==-1&&r[t].splice(s,1)}}class kn{constructor(e,r={}){si(this,r),this.type=e}}class Aa extends kn{constructor(e,r={}){super("error",si({error:e},r))}}class Dn{on(e,r){return this._listeners=this._listeners||{},Lh(e,r,this._listeners),this}off(e,r){return Ia(e,r,this._listeners),Ia(e,r,this._oneTimeListeners),this}once(e,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},Lh(e,r,this._oneTimeListeners),this):new Promise(s=>this.once(e,s))}fire(e,r){typeof e=="string"&&(e=new kn(e,r||{}));const s=e.type;if(this.listens(s)){e.target=this;const h=this._listeners&&this._listeners[s]?this._listeners[s].slice():[];for(const g of h)g.call(this,e);const u=this._oneTimeListeners&&this._oneTimeListeners[s]?this._oneTimeListeners[s].slice():[];for(const g of u)Ia(s,g,this._oneTimeListeners),g.call(this,e);const f=this._eventedParent;f&&(si(e,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),f.fire(e))}else e instanceof Aa&&console.error(e.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,r){return this._eventedParent=e,this._eventedParentData=r,this}}var ye=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":0.1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":true,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"cross-faded"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"cross-faded":{"type":"property-type"},"cross-faded-data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');class Ue{constructor(e,r,s,h){this.message=(e?`${e}: `:"")+s,h&&(this.identifier=h),r!=null&&r.__line__&&(this.line=r.__line__)}}function Rh(t){const e=t.value;return e?[new Ue(t.key,e,"constants have been deprecated as of v8")]:[]}function zn(t,...e){for(const r of e)for(const s in r)t[s]=r[s];return t}function li(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}function fn(t){if(Array.isArray(t))return t.map(fn);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const e={};for(const r in t)e[r]=fn(t[r]);return e}return li(t)}class tn extends Error{constructor(e,r){super(r),this.message=r,this.key=e}}class Ca{constructor(e,r=[]){this.parent=e,this.bindings={};for(const[s,h]of r)this.bindings[s]=h}concat(e){return new Ca(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Pn={kind:"null"},Ne={kind:"number"},xt={kind:"string"},pt={kind:"boolean"},rn={kind:"color"},zs={kind:"object"},ft={kind:"value"},To={kind:"collator"},Ln={kind:"formatted"},Eo={kind:"resolvedImage"};function Ir(t,e){return{kind:"array",itemType:t,N:e}}function ri(t){if(t.kind==="array"){const e=ri(t.itemType);return typeof t.N=="number"?`array<${e}, ${t.N}>`:t.itemType.kind==="value"?"array":`array<${e}>`}return t.kind}const Kd=[Pn,Ne,xt,pt,rn,Ln,zs,Ir(ft),Eo];function ir(t,e){if(e.kind==="error")return null;if(t.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!ir(t.itemType,e.itemType))&&(typeof t.N!="number"||t.N===e.N))return null}else{if(t.kind===e.kind)return null;if(t.kind==="value"){for(const r of Kd)if(!ir(r,e))return null}}return`Expected ${ri(t)} but found ${ri(e)} instead.`}function Ma(t,e){return e.some(r=>r.kind===t.kind)}function Ps(t,e){return e.some(r=>r==="null"?t===null:r==="array"?Array.isArray(t):r==="object"?t&&!Array.isArray(t)&&typeof t=="object":r===typeof t)}function Ls(t){var e={exports:{}};return t(e,e.exports),e.exports}var Rs=Ls(function(t,e){var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function s(g){return(g=Math.round(g))<0?0:g>255?255:g}function h(g){return s(g[g.length-1]==="%"?parseFloat(g)/100*255:parseInt(g))}function u(g){return(x=g[g.length-1]==="%"?parseFloat(g)/100:parseFloat(g))<0?0:x>1?1:x;var x}function f(g,x,w){return w<0?w+=1:w>1&&(w-=1),6*w<1?g+(x-g)*w*6:2*w<1?x:3*w<2?g+(x-g)*(2/3-w)*6:g}try{e.parseCSSColor=function(g){var x,w=g.replace(/ /g,"").toLowerCase();if(w in r)return r[w].slice();if(w[0]==="#")return w.length===4?(x=parseInt(w.substr(1),16))>=0&&x<=4095?[(3840&x)>>4|(3840&x)>>8,240&x|(240&x)>>4,15&x|(15&x)<<4,1]:null:w.length===7&&(x=parseInt(w.substr(1),16))>=0&&x<=16777215?[(16711680&x)>>16,(65280&x)>>8,255&x,1]:null;var E=w.indexOf("("),I=w.indexOf(")");if(E!==-1&&I+1===w.length){var A=w.substr(0,E),z=w.substr(E+1,I-(E+1)).split(","),R=1;switch(A){case"rgba":if(z.length!==4)return null;R=u(z.pop());case"rgb":return z.length!==3?null:[h(z[0]),h(z[1]),h(z[2]),R];case"hsla":if(z.length!==4)return null;R=u(z.pop());case"hsl":if(z.length!==3)return null;var O=(parseFloat(z[0])%360+360)%360/360,U=u(z[1]),Z=u(z[2]),Q=Z<=.5?Z*(U+1):Z+U-Z*U,ne=2*Z-Q;return[s(255*f(ne,Q,O+1/3)),s(255*f(ne,Q,O)),s(255*f(ne,Q,O-1/3)),R];default:return null}}return null}}catch{}});class At{constructor(e,r,s,h=1){this.r=e,this.g=r,this.b=s,this.a=h}static parse(e){if(!e)return;if(e instanceof At)return e;if(typeof e!="string")return;const r=Rs.parseCSSColor(e);return r?new At(r[0]/255*r[3],r[1]/255*r[3],r[2]/255*r[3],r[3]):void 0}toString(){const[e,r,s,h]=this.toArray();return`rgba(${Math.round(e)},${Math.round(r)},${Math.round(s)},${h})`}toArray(){const{r:e,g:r,b:s,a:h}=this;return h===0?[0,0,0,0]:[255*e/h,255*r/h,255*s/h,h]}}At.black=new At(0,0,0,1),At.white=new At(1,1,1,1),At.transparent=new At(0,0,0,0),At.red=new At(1,0,0,1),At.blue=new At(0,0,1,1);class ka{constructor(e,r,s){this.sensitivity=e?r?"variant":"case":r?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,r){return this.collator.compare(e,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Yl{constructor(e,r,s,h,u){this.text=e.normalize?e.normalize():e,this.image=r,this.scale=s,this.fontStack=h,this.textColor=u}}class lt{constructor(e){this.sections=e}static fromString(e){return new lt([new Yl(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.name.length!==0)}static factory(e){return e instanceof lt?e:lt.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const r of this.sections){if(r.image){e.push(["image",r.image.name]);continue}e.push(r.text);const s={};r.fontStack&&(s["text-font"]=["literal",r.fontStack.split(",")]),r.scale&&(s["font-scale"]=r.scale),r.textColor&&(s["text-color"]=["rgba"].concat(r.textColor.toArray())),e.push(s)}return e}}class Ar{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new Ar({name:e,available:!1}):null}serialize(){return["image",this.name]}}function Bh(t,e,r,s){return typeof t=="number"&&t>=0&&t<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof r=="number"&&r>=0&&r<=255?s===void 0||typeof s=="number"&&s>=0&&s<=1?null:`Invalid rgba value [${[t,e,r,s].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof s=="number"?[t,e,r,s]:[t,e,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Da(t){if(t===null||typeof t=="string"||typeof t=="boolean"||typeof t=="number"||t instanceof At||t instanceof ka||t instanceof lt||t instanceof Ar)return!0;if(Array.isArray(t)){for(const e of t)if(!Da(e))return!1;return!0}if(typeof t=="object"){for(const e in t)if(!Da(t[e]))return!1;return!0}return!1}function fi(t){if(t===null)return Pn;if(typeof t=="string")return xt;if(typeof t=="boolean")return pt;if(typeof t=="number")return Ne;if(t instanceof At)return rn;if(t instanceof ka)return To;if(t instanceof lt)return Ln;if(t instanceof Ar)return Eo;if(Array.isArray(t)){const e=t.length;let r;for(const s of t){const h=fi(s);if(r){if(r===h)continue;r=ft;break}r=h}return Ir(r||ft,e)}return zs}function So(t){const e=typeof t;return t===null?"":e==="string"||e==="number"||e==="boolean"?String(t):t instanceof At||t instanceof lt||t instanceof Ar?t.toString():JSON.stringify(t)}class Rn{constructor(e,r){this.type=e,this.value=r}static parse(e,r){if(e.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Da(e[1]))return r.error("invalid value");const s=e[1];let h=fi(s);const u=r.expectedType;return h.kind!=="array"||h.N!==0||!u||u.kind!=="array"||typeof u.N=="number"&&u.N!==0||(h=u),new Rn(h,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof At?["rgba"].concat(this.value.toArray()):this.value instanceof lt?this.value.serialize():this.value}}class Ei{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const za={string:xt,number:Ne,boolean:pt,object:zs};class Cr{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");let s,h=1;const u=e[0];if(u==="array"){let g,x;if(e.length>2){const w=e[1];if(typeof w!="string"||!(w in za)||w==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);g=za[w],h++}else g=ft;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return r.error('The length argument to "array" must be a positive integer literal',2);x=e[2],h++}s=Ir(g,x)}else s=za[u];const f=[];for(;h<e.length;h++){const g=r.parse(e[h],h,ft);if(!g)return null;f.push(g)}return new Cr(s,f)}evaluate(e){for(let r=0;r<this.args.length;r++){const s=this.args[r].evaluate(e);if(!ir(this.type,fi(s)))return s;if(r===this.args.length-1)throw new Ei(`Expected value to be of type ${ri(this.type)}, but found ${ri(fi(s))} instead.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,r=[e.kind];if(e.kind==="array"){const s=e.itemType;if(s.kind==="string"||s.kind==="number"||s.kind==="boolean"){r.push(s.kind);const h=e.N;(typeof h=="number"||this.args.length>1)&&r.push(h)}}return r.concat(this.args.map(s=>s.serialize()))}}class nn{constructor(e){this.type=Ln,this.sections=e}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const s=e[1];if(!Array.isArray(s)&&typeof s=="object")return r.error("First argument must be an image or text section.");const h=[];let u=!1;for(let f=1;f<=e.length-1;++f){const g=e[f];if(u&&typeof g=="object"&&!Array.isArray(g)){u=!1;let x=null;if(g["font-scale"]&&(x=r.parse(g["font-scale"],1,Ne),!x))return null;let w=null;if(g["text-font"]&&(w=r.parse(g["text-font"],1,Ir(xt)),!w))return null;let E=null;if(g["text-color"]&&(E=r.parse(g["text-color"],1,rn),!E))return null;const I=h[h.length-1];I.scale=x,I.font=w,I.textColor=E}else{const x=r.parse(e[f],1,ft);if(!x)return null;const w=x.type.kind;if(w!=="string"&&w!=="value"&&w!=="null"&&w!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");u=!0,h.push({content:x,scale:null,font:null,textColor:null})}}return new nn(h)}evaluate(e){return new lt(this.sections.map(r=>{const s=r.content.evaluate(e);return fi(s)===Eo?new Yl("",s,null,null,null):new Yl(So(s),null,r.scale?r.scale.evaluate(e):null,r.font?r.font.evaluate(e).join(","):null,r.textColor?r.textColor.evaluate(e):null)}))}eachChild(e){for(const r of this.sections)e(r.content),r.scale&&e(r.scale),r.font&&e(r.font),r.textColor&&e(r.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const r of this.sections){e.push(r.content.serialize());const s={};r.scale&&(s["font-scale"]=r.scale.serialize()),r.font&&(s["text-font"]=r.font.serialize()),r.textColor&&(s["text-color"]=r.textColor.serialize()),e.push(s)}return e}}class is{constructor(e){this.type=Eo,this.input=e}static parse(e,r){if(e.length!==2)return r.error("Expected two arguments.");const s=r.parse(e[1],1,xt);return s?new is(s):r.error("No image name provided.")}evaluate(e){const r=this.input.evaluate(e),s=Ar.fromString(r);return s&&e.availableImages&&(s.available=e.availableImages.indexOf(r)>-1),s}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const Yd={"to-boolean":pt,"to-color":rn,"to-number":Ne,"to-string":xt};class sn{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const s=e[0];if((s==="to-boolean"||s==="to-string")&&e.length!==2)return r.error("Expected one argument.");const h=Yd[s],u=[];for(let f=1;f<e.length;f++){const g=r.parse(e[f],f,ft);if(!g)return null;u.push(g)}return new sn(h,u)}evaluate(e){if(this.type.kind==="boolean")return Boolean(this.args[0].evaluate(e));if(this.type.kind==="color"){let r,s;for(const h of this.args){if(r=h.evaluate(e),s=null,r instanceof At)return r;if(typeof r=="string"){const u=e.parseColor(r);if(u)return u}else if(Array.isArray(r)&&(s=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:Bh(r[0],r[1],r[2],r[3]),!s))return new At(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new Ei(s||`Could not parse color from value '${typeof r=="string"?r:String(JSON.stringify(r))}'`)}if(this.type.kind==="number"){let r=null;for(const s of this.args){if(r=s.evaluate(e),r===null)return 0;const h=Number(r);if(!isNaN(h))return h}throw new Ei(`Could not convert ${JSON.stringify(r)} to number.`)}return this.type.kind==="formatted"?lt.fromString(So(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Ar.fromString(So(this.args[0].evaluate(e))):So(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new nn([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new is(this.args[0]).serialize();const e=[`to-${this.type.kind}`];return this.eachChild(r=>{e.push(r.serialize())}),e}}const Fh=["Unknown","Point","LineString","Polygon"];class Oh{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Fh[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,r=this.featureDistanceData.scale,{x:s,y:h}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*r-e[0])+this.featureDistanceData.bearing[1]*(h*r-e[1])}return 0}parseColor(e){let r=this._parseColorCache[e];return r||(r=this._parseColorCache[e]=At.parse(e)),r}}class dr{constructor(e,r,s,h){this.name=e,this.type=r,this._evaluate=s,this.args=h}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,r){const s=e[0],h=dr.definitions[s];if(!h)return r.error(`Unknown expression "${s}". If you wanted a literal array, use ["literal", [...]].`,0);const u=Array.isArray(h)?h[0]:h.type,f=Array.isArray(h)?[[h[1],h[2]]]:h.overloads,g=f.filter(([w])=>!Array.isArray(w)||w.length===e.length-1);let x=null;for(const[w,E]of g){x=new Ra(r.registry,r.path,null,r.scope);const I=[];let A=!1;for(let z=1;z<e.length;z++){const R=e[z],O=Array.isArray(w)?w[z-1]:w.type,U=x.parse(R,1+I.length,O);if(!U){A=!0;break}I.push(U)}if(!A)if(Array.isArray(w)&&w.length!==I.length)x.error(`Expected ${w.length} arguments, but found ${I.length} instead.`);else{for(let z=0;z<I.length;z++){const R=Array.isArray(w)?w[z]:w.type,O=I[z];x.concat(z+1).checkSubtype(R,O.type)}if(x.errors.length===0)return new dr(s,u,E,I)}}if(g.length===1)r.errors.push(...x.errors);else{const w=(g.length?g:f).map(([I])=>{return A=I,Array.isArray(A)?`(${A.map(ri).join(", ")})`:`(${ri(A.type)}...)`;var A}).join(" | "),E=[];for(let I=1;I<e.length;I++){const A=r.parse(e[I],1+E.length);if(!A)return null;E.push(ri(A.type))}r.error(`Expected arguments of type ${w}, but found (${E.join(", ")}) instead.`)}return null}static register(e,r){dr.definitions=r;for(const s in r)e[s]=dr}}class Io{constructor(e,r,s){this.type=To,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=r}static parse(e,r){if(e.length!==2)return r.error("Expected one argument.");const s=e[1];if(typeof s!="object"||Array.isArray(s))return r.error("Collator options argument must be an object.");const h=r.parse(s["case-sensitive"]!==void 0&&s["case-sensitive"],1,pt);if(!h)return null;const u=r.parse(s["diacritic-sensitive"]!==void 0&&s["diacritic-sensitive"],1,pt);if(!u)return null;let f=null;return s.locale&&(f=r.parse(s.locale,1,xt),!f)?null:new Io(h,u,f)}evaluate(e){return new ka(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}const Bn=8192;function Pa(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[0]),t[3]=Math.max(t[3],e[1])}function Ao(t,e){return!(t[0]<=e[0]||t[2]>=e[2]||t[1]<=e[1]||t[3]>=e[3])}function Nh(t,e){const r=(180+t[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360,h=Math.pow(2,e.z);return[Math.round(r*h*Bn),Math.round(s*h*Bn)]}function Uh(t,e,r){const s=t[0]-e[0],h=t[1]-e[1],u=t[0]-r[0],f=t[1]-r[1];return s*f-u*h==0&&s*u<=0&&h*f<=0}function Jl(t,e){let r=!1;for(let f=0,g=e.length;f<g;f++){const x=e[f];for(let w=0,E=x.length;w<E-1;w++){if(Uh(t,x[w],x[w+1]))return!1;(h=x[w])[1]>(s=t)[1]!=(u=x[w+1])[1]>s[1]&&s[0]<(u[0]-h[0])*(s[1]-h[1])/(u[1]-h[1])+h[0]&&(r=!r)}}var s,h,u;return r}function Vh(t,e){for(let r=0;r<e.length;r++)if(Jl(t,e[r]))return!0;return!1}function Ql(t,e,r,s){const h=s[0]-r[0],u=s[1]-r[1],f=(t[0]-r[0])*u-h*(t[1]-r[1]),g=(e[0]-r[0])*u-h*(e[1]-r[1]);return f>0&&g<0||f<0&&g>0}function Jd(t,e,r){for(const w of r)for(let E=0;E<w.length-1;++E)if((g=[(f=w[E+1])[0]-(u=w[E])[0],f[1]-u[1]])[0]*(x=[(h=e)[0]-(s=t)[0],h[1]-s[1]])[1]-g[1]*x[0]!=0&&Ql(s,h,u,f)&&Ql(u,f,s,h))return!0;var s,h,u,f,g,x;return!1}function jh(t,e){for(let r=0;r<t.length;++r)if(!Jl(t[r],e))return!1;for(let r=0;r<t.length-1;++r)if(Jd(t[r],t[r+1],e))return!1;return!0}function Qd(t,e){for(let r=0;r<e.length;r++)if(jh(t,e[r]))return!0;return!1}function ec(t,e,r){const s=[];for(let h=0;h<t.length;h++){const u=[];for(let f=0;f<t[h].length;f++){const g=Nh(t[h][f],r);Pa(e,g),u.push(g)}s.push(u)}return s}function $h(t,e,r){const s=[];for(let h=0;h<t.length;h++){const u=ec(t[h],e,r);s.push(u)}return s}function tc(t,e,r,s){if(t[0]<r[0]||t[0]>r[2]){const h=.5*s;let u=t[0]-r[0]>h?-s:r[0]-t[0]>h?s:0;u===0&&(u=t[0]-r[2]>h?-s:r[2]-t[0]>h?s:0),t[0]+=u}Pa(e,t)}function Gh(t,e,r,s){const h=Math.pow(2,s.z)*Bn,u=[s.x*Bn,s.y*Bn],f=[];for(const g of t)for(const x of g){const w=[x.x+u[0],x.y+u[1]];tc(w,e,r,h),f.push(w)}return f}function qh(t,e,r,s){const h=Math.pow(2,s.z)*Bn,u=[s.x*Bn,s.y*Bn],f=[];for(const x of t){const w=[];for(const E of x){const I=[E.x+u[0],E.y+u[1]];Pa(e,I),w.push(I)}f.push(w)}if(e[2]-e[0]<=h/2){(g=e)[0]=g[1]=1/0,g[2]=g[3]=-1/0;for(const x of f)for(const w of x)tc(w,e,r,h)}var g;return f}class rs{constructor(e,r){this.type=pt,this.geojson=e,this.geometries=r}static parse(e,r){if(e.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Da(e[1])){const s=e[1];if(s.type==="FeatureCollection")for(let h=0;h<s.features.length;++h){const u=s.features[h].geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new rs(s,s.features[h].geometry)}else if(s.type==="Feature"){const h=s.geometry.type;if(h==="Polygon"||h==="MultiPolygon")return new rs(s,s.geometry)}else if(s.type==="Polygon"||s.type==="MultiPolygon")return new rs(s,s)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(r,s){const h=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],f=r.canonicalID();if(s.type==="Polygon"){const g=ec(s.coordinates,u,f),x=Gh(r.geometry(),h,u,f);if(!Ao(h,u))return!1;for(const w of x)if(!Jl(w,g))return!1}if(s.type==="MultiPolygon"){const g=$h(s.coordinates,u,f),x=Gh(r.geometry(),h,u,f);if(!Ao(h,u))return!1;for(const w of x)if(!Vh(w,g))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(r,s){const h=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],f=r.canonicalID();if(s.type==="Polygon"){const g=ec(s.coordinates,u,f),x=qh(r.geometry(),h,u,f);if(!Ao(h,u))return!1;for(const w of x)if(!jh(w,g))return!1}if(s.type==="MultiPolygon"){const g=$h(s.coordinates,u,f),x=qh(r.geometry(),h,u,f);if(!Ao(h,u))return!1;for(const w of x)if(!Qd(w,g))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}function Bs(t){if(t instanceof dr&&(t.name==="get"&&t.args.length===1||t.name==="feature-state"||t.name==="has"&&t.args.length===1||t.name==="properties"||t.name==="geometry-type"||t.name==="id"||/^filter-/.test(t.name))||t instanceof rs)return!1;let e=!0;return t.eachChild(r=>{e&&!Bs(r)&&(e=!1)}),e}function Co(t){if(t instanceof dr&&t.name==="feature-state")return!1;let e=!0;return t.eachChild(r=>{e&&!Co(r)&&(e=!1)}),e}function Mo(t,e){if(t instanceof dr&&e.indexOf(t.name)>=0)return!1;let r=!0;return t.eachChild(s=>{r&&!Mo(s,e)&&(r=!1)}),r}class La{constructor(e,r){this.type=r.type,this.name=e,this.boundExpression=r}static parse(e,r){if(e.length!==2||typeof e[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const s=e[1];return r.scope.has(s)?new La(s,r.scope.get(s)):r.error(`Unknown variable "${s}". Make sure "${s}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ra{constructor(e,r=[],s,h=new Ca,u=[]){this.registry=e,this.path=r,this.key=r.map(f=>`[${f}]`).join(""),this.scope=h,this.errors=u,this.expectedType=s}parse(e,r,s,h,u={}){return r?this.concat(r,s,h)._parse(e,u):this._parse(e,u)}_parse(e,r){function s(h,u,f){return f==="assert"?new Cr(u,[h]):f==="coerce"?new sn(u,[h]):h}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const h=e[0];if(typeof h!="string")return this.error(`Expression name must be a string, but found ${typeof h} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const u=this.registry[h];if(u){let f=u.parse(e,this);if(!f)return null;if(this.expectedType){const g=this.expectedType,x=f.type;if(g.kind!=="string"&&g.kind!=="number"&&g.kind!=="boolean"&&g.kind!=="object"&&g.kind!=="array"||x.kind!=="value")if(g.kind!=="color"&&g.kind!=="formatted"&&g.kind!=="resolvedImage"||x.kind!=="value"&&x.kind!=="string"){if(this.checkSubtype(g,x))return null}else f=s(f,g,r.typeAnnotation||"coerce");else f=s(f,g,r.typeAnnotation||"assert")}if(!(f instanceof Rn)&&f.type.kind!=="resolvedImage"&&Ba(f)){const g=new Oh;try{f=new Rn(f.type,f.evaluate(g))}catch(x){return this.error(x.message),null}}return f}return this.error(`Unknown expression "${h}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,r,s){const h=typeof e=="number"?this.path.concat(e):this.path,u=s?this.scope.concat(s):this.scope;return new Ra(this.registry,h,r||null,u,this.errors)}error(e,...r){const s=`${this.key}${r.map(h=>`[${h}]`).join("")}`;this.errors.push(new tn(s,e))}checkSubtype(e,r){const s=ir(e,r);return s&&this.error(s),s}}function Ba(t){if(t instanceof La)return Ba(t.boundExpression);if(t instanceof dr&&t.name==="error"||t instanceof Io||t instanceof rs)return!1;const e=t instanceof sn||t instanceof Cr;let r=!0;return t.eachChild(s=>{r=e?r&&Ba(s):r&&s instanceof Rn}),!!r&&Bs(t)&&Mo(t,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function ko(t,e){const r=t.length-1;let s,h,u=0,f=r,g=0;for(;u<=f;)if(g=Math.floor((u+f)/2),s=t[g],h=t[g+1],s<=e){if(g===r||e<h)return g;u=g+1}else{if(!(s>e))throw new Ei("Input is not a number.");f=g-1}return 0}class Do{constructor(e,r,s){this.type=e,this.input=r,this.labels=[],this.outputs=[];for(const[h,u]of s)this.labels.push(h),this.outputs.push(u)}static parse(e,r){if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");const s=r.parse(e[1],1,Ne);if(!s)return null;const h=[];let u=null;r.expectedType&&r.expectedType.kind!=="value"&&(u=r.expectedType);for(let f=1;f<e.length;f+=2){const g=f===1?-1/0:e[f],x=e[f+1],w=f,E=f+1;if(typeof g!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',w);if(h.length&&h[h.length-1][0]>=g)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',w);const I=r.parse(x,E,u);if(!I)return null;u=u||I.type,h.push([g,I])}return new Do(u,s,h)}evaluate(e){const r=this.labels,s=this.outputs;if(r.length===1)return s[0].evaluate(e);const h=this.input.evaluate(e);if(h<=r[0])return s[0].evaluate(e);const u=r.length;return h>=r[u-1]?s[u-1].evaluate(e):s[ko(r,h)].evaluate(e)}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let r=0;r<this.labels.length;r++)r>0&&e.push(this.labels[r]),e.push(this.outputs[r].serialize());return e}}function Lt(t,e,r){return t*(1-r)+e*r}var Fa=Object.freeze({__proto__:null,number:Lt,color:function(t,e,r){return new At(Lt(t.r,e.r,r),Lt(t.g,e.g,r),Lt(t.b,e.b,r),Lt(t.a,e.a,r))},array:function(t,e,r){return t.map((s,h)=>Lt(s,e[h],r))}});const Zh=.95047,zo=1.08883,ic=4/29,Oa=6/29,Wh=3*Oa*Oa,ep=Math.PI/180,tp=180/Math.PI;function Na(t){return t>.008856451679035631?Math.pow(t,1/3):t/Wh+ic}function Ua(t){return t>Oa?t*t*t:Wh*(t-ic)}function Va(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function Po(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function Xh(t){const e=Po(t.r),r=Po(t.g),s=Po(t.b),h=Na((.4124564*e+.3575761*r+.1804375*s)/Zh),u=Na((.2126729*e+.7151522*r+.072175*s)/1);return{l:116*u-16,a:500*(h-u),b:200*(u-Na((.0193339*e+.119192*r+.9503041*s)/zo)),alpha:t.a}}function Hh(t){let e=(t.l+16)/116,r=isNaN(t.a)?e:e+t.a/500,s=isNaN(t.b)?e:e-t.b/200;return e=1*Ua(e),r=Zh*Ua(r),s=zo*Ua(s),new At(Va(3.2404542*r-1.5371385*e-.4985314*s),Va(-.969266*r+1.8760108*e+.041556*s),Va(.0556434*r-.2040259*e+1.0572252*s),t.alpha)}function ip(t,e,r){const s=e-t;return t+r*(s>180||s<-180?s-360*Math.round(s/360):s)}const Lo={forward:Xh,reverse:Hh,interpolate:function(t,e,r){return{l:Lt(t.l,e.l,r),a:Lt(t.a,e.a,r),b:Lt(t.b,e.b,r),alpha:Lt(t.alpha,e.alpha,r)}}},Ro={forward:function(t){const{l:e,a:r,b:s}=Xh(t),h=Math.atan2(s,r)*tp;return{h:h<0?h+360:h,c:Math.sqrt(r*r+s*s),l:e,alpha:t.a}},reverse:function(t){const e=t.h*ep,r=t.c;return Hh({l:t.l,a:Math.cos(e)*r,b:Math.sin(e)*r,alpha:t.alpha})},interpolate:function(t,e,r){return{h:ip(t.h,e.h,r),c:Lt(t.c,e.c,r),l:Lt(t.l,e.l,r),alpha:Lt(t.alpha,e.alpha,r)}}};var Kh=Object.freeze({__proto__:null,lab:Lo,hcl:Ro});class rr{constructor(e,r,s,h,u){this.type=e,this.operator=r,this.interpolation=s,this.input=h,this.labels=[],this.outputs=[];for(const[f,g]of u)this.labels.push(f),this.outputs.push(g)}static interpolationFactor(e,r,s,h){let u=0;if(e.name==="exponential")u=ja(r,e.base,s,h);else if(e.name==="linear")u=ja(r,1,s,h);else if(e.name==="cubic-bezier"){const f=e.controlPoints;u=new ie(f[0],f[1],f[2],f[3]).solve(ja(r,1,s,h))}return u}static parse(e,r){let[s,h,u,...f]=e;if(!Array.isArray(h)||h.length===0)return r.error("Expected an interpolation type expression.",1);if(h[0]==="linear")h={name:"linear"};else if(h[0]==="exponential"){const w=h[1];if(typeof w!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);h={name:"exponential",base:w}}else{if(h[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(h[0])}`,1,0);{const w=h.slice(1);if(w.length!==4||w.some(E=>typeof E!="number"||E<0||E>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);h={name:"cubic-bezier",controlPoints:w}}}if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(u=r.parse(u,2,Ne),!u)return null;const g=[];let x=null;s==="interpolate-hcl"||s==="interpolate-lab"?x=rn:r.expectedType&&r.expectedType.kind!=="value"&&(x=r.expectedType);for(let w=0;w<f.length;w+=2){const E=f[w],I=f[w+1],A=w+3,z=w+4;if(typeof E!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',A);if(g.length&&g[g.length-1][0]>=E)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',A);const R=r.parse(I,z,x);if(!R)return null;x=x||R.type,g.push([E,R])}return x.kind==="number"||x.kind==="color"||x.kind==="array"&&x.itemType.kind==="number"&&typeof x.N=="number"?new rr(x,s,h,u,g):r.error(`Type ${ri(x)} is not interpolatable.`)}evaluate(e){const r=this.labels,s=this.outputs;if(r.length===1)return s[0].evaluate(e);const h=this.input.evaluate(e);if(h<=r[0])return s[0].evaluate(e);const u=r.length;if(h>=r[u-1])return s[u-1].evaluate(e);const f=ko(r,h),g=rr.interpolationFactor(this.interpolation,h,r[f],r[f+1]),x=s[f].evaluate(e),w=s[f+1].evaluate(e);return this.operator==="interpolate"?Fa[this.type.kind.toLowerCase()](x,w,g):this.operator==="interpolate-hcl"?Ro.reverse(Ro.interpolate(Ro.forward(x),Ro.forward(w),g)):Lo.reverse(Lo.interpolate(Lo.forward(x),Lo.forward(w),g))}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const r=[this.operator,e,this.input.serialize()];for(let s=0;s<this.labels.length;s++)r.push(this.labels[s],this.outputs[s].serialize());return r}}function ja(t,e,r,s){const h=s-r,u=t-r;return h===0?0:e===1?u/h:(Math.pow(e,u)-1)/(Math.pow(e,h)-1)}class ns{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expectected at least one argument.");let s=null;const h=r.expectedType;h&&h.kind!=="value"&&(s=h);const u=[];for(const g of e.slice(1)){const x=r.parse(g,1+u.length,s,void 0,{typeAnnotation:"omit"});if(!x)return null;s=s||x.type,u.push(x)}const f=h&&u.some(g=>ir(h,g.type));return new ns(f?ft:s,u)}evaluate(e){let r,s=null,h=0;for(const u of this.args){if(h++,s=u.evaluate(e),s&&s instanceof Ar&&!s.available&&(r||(r=s),s=null,h===this.args.length))return r;if(s!==null)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(r=>{e.push(r.serialize())}),e}}class $a{constructor(e,r){this.type=r.type,this.bindings=[].concat(e),this.result=r}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const r of this.bindings)e(r[1]);e(this.result)}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const s=[];for(let u=1;u<e.length-1;u+=2){const f=e[u];if(typeof f!="string")return r.error(`Expected string, but found ${typeof f} instead.`,u);if(/[^a-zA-Z0-9_]/.test(f))return r.error("Variable names must contain only alphanumeric characters or '_'.",u);const g=r.parse(e[u+1],u+1);if(!g)return null;s.push([f,g])}const h=r.parse(e[e.length-1],e.length-1,r.expectedType,s);return h?new $a(s,h):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[r,s]of this.bindings)e.push(r,s.serialize());return e.push(this.result.serialize()),e}}class rc{constructor(e,r,s){this.type=e,this.index=r,this.input=s}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=r.parse(e[1],1,Ne),h=r.parse(e[2],2,Ir(r.expectedType||ft));return s&&h?new rc(h.type.itemType,s,h):null}evaluate(e){const r=this.index.evaluate(e),s=this.input.evaluate(e);if(r<0)throw new Ei(`Array index out of bounds: ${r} < 0.`);if(r>=s.length)throw new Ei(`Array index out of bounds: ${r} > ${s.length-1}.`);if(r!==Math.floor(r))throw new Ei(`Array index must be an integer, but found ${r} instead.`);return s[r]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class nc{constructor(e,r){this.type=pt,this.needle=e,this.haystack=r}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=r.parse(e[1],1,ft),h=r.parse(e[2],2,ft);return s&&h?Ma(s.type,[pt,xt,Ne,Pn,ft])?new nc(s,h):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${ri(s.type)} instead`):null}evaluate(e){const r=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!s)return!1;if(!Ps(r,["boolean","string","number","null"]))throw new Ei(`Expected first argument to be of type boolean, string, number or null, but found ${ri(fi(r))} instead.`);if(!Ps(s,["string","array"]))throw new Ei(`Expected second argument to be of type array or string, but found ${ri(fi(s))} instead.`);return s.indexOf(r)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Ur{constructor(e,r,s){this.type=Ne,this.needle=e,this.haystack=r,this.fromIndex=s}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const s=r.parse(e[1],1,ft),h=r.parse(e[2],2,ft);if(!s||!h)return null;if(!Ma(s.type,[pt,xt,Ne,Pn,ft]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${ri(s.type)} instead`);if(e.length===4){const u=r.parse(e[3],3,Ne);return u?new Ur(s,h,u):null}return new Ur(s,h)}evaluate(e){const r=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!Ps(r,["boolean","string","number","null"]))throw new Ei(`Expected first argument to be of type boolean, string, number or null, but found ${ri(fi(r))} instead.`);if(!Ps(s,["string","array"]))throw new Ei(`Expected second argument to be of type array or string, but found ${ri(fi(s))} instead.`);if(this.fromIndex){const h=this.fromIndex.evaluate(e);return s.indexOf(r,h)}return s.indexOf(r)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Ga{constructor(e,r,s,h,u,f){this.inputType=e,this.type=r,this.input=s,this.cases=h,this.outputs=u,this.otherwise=f}static parse(e,r){if(e.length<5)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return r.error("Expected an even number of arguments.");let s,h;r.expectedType&&r.expectedType.kind!=="value"&&(h=r.expectedType);const u={},f=[];for(let w=2;w<e.length-1;w+=2){let E=e[w];const I=e[w+1];Array.isArray(E)||(E=[E]);const A=r.concat(w);if(E.length===0)return A.error("Expected at least one branch label.");for(const R of E){if(typeof R!="number"&&typeof R!="string")return A.error("Branch labels must be numbers or strings.");if(typeof R=="number"&&Math.abs(R)>Number.MAX_SAFE_INTEGER)return A.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof R=="number"&&Math.floor(R)!==R)return A.error("Numeric branch labels must be integer values.");if(s){if(A.checkSubtype(s,fi(R)))return null}else s=fi(R);if(u[String(R)]!==void 0)return A.error("Branch labels must be unique.");u[String(R)]=f.length}const z=r.parse(I,w,h);if(!z)return null;h=h||z.type,f.push(z)}const g=r.parse(e[1],1,ft);if(!g)return null;const x=r.parse(e[e.length-1],e.length-1,h);return x?g.type.kind!=="value"&&r.concat(1).checkSubtype(s,g.type)?null:new Ga(s,h,g,u,f,x):null}evaluate(e){const r=this.input.evaluate(e);return(fi(r)===this.inputType&&this.outputs[this.cases[r]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],r=Object.keys(this.cases).sort(),s=[],h={};for(const f of r){const g=h[this.cases[f]];g===void 0?(h[this.cases[f]]=s.length,s.push([this.cases[f],[f]])):s[g][1].push(f)}const u=f=>this.inputType.kind==="number"?Number(f):f;for(const[f,g]of s)e.push(g.length===1?u(g[0]):g.map(u)),e.push(this.outputs[f].serialize());return e.push(this.otherwise.serialize()),e}}class Fn{constructor(e,r,s){this.type=e,this.branches=r,this.otherwise=s}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return r.error("Expected an odd number of arguments.");let s;r.expectedType&&r.expectedType.kind!=="value"&&(s=r.expectedType);const h=[];for(let f=1;f<e.length-1;f+=2){const g=r.parse(e[f],f,pt);if(!g)return null;const x=r.parse(e[f+1],f+1,s);if(!x)return null;h.push([g,x]),s=s||x.type}const u=r.parse(e[e.length-1],e.length-1,s);return u?new Fn(s,h,u):null}evaluate(e){for(const[r,s]of this.branches)if(r.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[r,s]of this.branches)e(r),e(s);e(this.otherwise)}outputDefined(){return this.branches.every(([e,r])=>r.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(r=>{e.push(r.serialize())}),e}}class Bo{constructor(e,r,s,h){this.type=e,this.input=r,this.beginIndex=s,this.endIndex=h}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const s=r.parse(e[1],1,ft),h=r.parse(e[2],2,Ne);if(!s||!h)return null;if(!Ma(s.type,[Ir(ft),xt,ft]))return r.error(`Expected first argument to be of type array or string, but found ${ri(s.type)} instead`);if(e.length===4){const u=r.parse(e[3],3,Ne);return u?new Bo(s.type,s,h,u):null}return new Bo(s.type,s,h)}evaluate(e){const r=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!Ps(r,["string","array"]))throw new Ei(`Expected first argument to be of type array or string, but found ${ri(fi(r))} instead.`);if(this.endIndex){const h=this.endIndex.evaluate(e);return r.slice(s,h)}return r.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function Yh(t,e){return t==="=="||t==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function qa(t,e,r,s){return s.compare(e,r)===0}function On(t,e,r){const s=t!=="=="&&t!=="!=";return class wx{constructor(u,f,g){this.type=pt,this.lhs=u,this.rhs=f,this.collator=g,this.hasUntypedArgument=u.type.kind==="value"||f.type.kind==="value"}static parse(u,f){if(u.length!==3&&u.length!==4)return f.error("Expected two or three arguments.");const g=u[0];let x=f.parse(u[1],1,ft);if(!x)return null;if(!Yh(g,x.type))return f.concat(1).error(`"${g}" comparisons are not supported for type '${ri(x.type)}'.`);let w=f.parse(u[2],2,ft);if(!w)return null;if(!Yh(g,w.type))return f.concat(2).error(`"${g}" comparisons are not supported for type '${ri(w.type)}'.`);if(x.type.kind!==w.type.kind&&x.type.kind!=="value"&&w.type.kind!=="value")return f.error(`Cannot compare types '${ri(x.type)}' and '${ri(w.type)}'.`);s&&(x.type.kind==="value"&&w.type.kind!=="value"?x=new Cr(w.type,[x]):x.type.kind!=="value"&&w.type.kind==="value"&&(w=new Cr(x.type,[w])));let E=null;if(u.length===4){if(x.type.kind!=="string"&&w.type.kind!=="string"&&x.type.kind!=="value"&&w.type.kind!=="value")return f.error("Cannot use collator to compare non-string types.");if(E=f.parse(u[3],3,To),!E)return null}return new wx(x,w,E)}evaluate(u){const f=this.lhs.evaluate(u),g=this.rhs.evaluate(u);if(s&&this.hasUntypedArgument){const x=fi(f),w=fi(g);if(x.kind!==w.kind||x.kind!=="string"&&x.kind!=="number")throw new Ei(`Expected arguments for "${t}" to be (string, string) or (number, number), but found (${x.kind}, ${w.kind}) instead.`)}if(this.collator&&!s&&this.hasUntypedArgument){const x=fi(f),w=fi(g);if(x.kind!=="string"||w.kind!=="string")return e(u,f,g)}return this.collator?r(u,f,g,this.collator.evaluate(u)):e(u,f,g)}eachChild(u){u(this.lhs),u(this.rhs),this.collator&&u(this.collator)}outputDefined(){return!0}serialize(){const u=[t];return this.eachChild(f=>{u.push(f.serialize())}),u}}}const Jh=On("==",function(t,e,r){return e===r},qa),sc=On("!=",function(t,e,r){return e!==r},function(t,e,r,s){return!qa(0,e,r,s)}),oc=On("<",function(t,e,r){return e<r},function(t,e,r,s){return s.compare(e,r)<0}),Qh=On(">",function(t,e,r){return e>r},function(t,e,r,s){return s.compare(e,r)>0}),ac=On("<=",function(t,e,r){return e<=r},function(t,e,r,s){return s.compare(e,r)<=0}),eu=On(">=",function(t,e,r){return e>=r},function(t,e,r,s){return s.compare(e,r)>=0});class Za{constructor(e,r,s,h,u){this.type=xt,this.number=e,this.locale=r,this.currency=s,this.minFractionDigits=h,this.maxFractionDigits=u}static parse(e,r){if(e.length!==3)return r.error("Expected two arguments.");const s=r.parse(e[1],1,Ne);if(!s)return null;const h=e[2];if(typeof h!="object"||Array.isArray(h))return r.error("NumberFormat options argument must be an object.");let u=null;if(h.locale&&(u=r.parse(h.locale,1,xt),!u))return null;let f=null;if(h.currency&&(f=r.parse(h.currency,1,xt),!f))return null;let g=null;if(h["min-fraction-digits"]&&(g=r.parse(h["min-fraction-digits"],1,Ne),!g))return null;let x=null;return h["max-fraction-digits"]&&(x=r.parse(h["max-fraction-digits"],1,Ne),!x)?null:new Za(s,u,f,g,x)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Wa{constructor(e){this.type=Ne,this.input=e}static parse(e,r){if(e.length!==2)return r.error(`Expected 1 argument, but found ${e.length-1} instead.`);const s=r.parse(e[1],1);return s?s.type.kind!=="array"&&s.type.kind!=="string"&&s.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${ri(s.type)} instead.`):new Wa(s):null}evaluate(e){const r=this.input.evaluate(e);if(typeof r=="string"||Array.isArray(r))return r.length;throw new Ei(`Expected value to be of type string or array, but found ${ri(fi(r))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(r=>{e.push(r.serialize())}),e}}const Vr={"==":Jh,"!=":sc,">":Qh,"<":oc,">=":eu,"<=":ac,array:Cr,at:rc,boolean:Cr,case:Fn,coalesce:ns,collator:Io,format:nn,image:is,in:nc,"index-of":Ur,interpolate:rr,"interpolate-hcl":rr,"interpolate-lab":rr,length:Wa,let:$a,literal:Rn,match:Ga,number:Cr,"number-format":Za,object:Cr,slice:Bo,step:Do,string:Cr,"to-boolean":sn,"to-color":sn,"to-number":sn,"to-string":sn,var:La,within:rs};function lc(t,[e,r,s,h]){e=e.evaluate(t),r=r.evaluate(t),s=s.evaluate(t);const u=h?h.evaluate(t):1,f=Bh(e,r,s,u);if(f)throw new Ei(f);return new At(e/255*u,r/255*u,s/255*u,u)}function cc(t,e){return t in e}function Fo(t,e){const r=e[t];return r===void 0?null:r}function Nn(t){return{type:t}}function tu(t){return{result:"success",value:t}}function mn(t){return{result:"error",value:t}}function Fs(t){return t["property-type"]==="data-driven"||t["property-type"]==="cross-faded-data-driven"}function iu(t){return!!t.expression&&t.expression.parameters.indexOf("zoom")>-1}function hc(t){return!!t.expression&&t.expression.interpolated}function Dt(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":t===null?"null":typeof t}function Xa(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function Ha(t){return t}function Oo(t,e){const r=e.type==="color",s=t.stops&&typeof t.stops[0][0]=="object",h=s||!(s||t.property!==void 0),u=t.type||(hc(e)?"exponential":"interval");if(r&&((t=zn({},t)).stops&&(t.stops=t.stops.map(w=>[w[0],At.parse(w[1])])),t.default=At.parse(t.default?t.default:e.default)),t.colorSpace&&t.colorSpace!=="rgb"&&!Kh[t.colorSpace])throw new Error(`Unknown color space: ${t.colorSpace}`);let f,g,x;if(u==="exponential")f=ru;else if(u==="interval")f=rp;else if(u==="categorical"){f=Ka,g=Object.create(null);for(const w of t.stops)g[w[0]]=w[1];x=typeof t.stops[0][0]}else{if(u!=="identity")throw new Error(`Unknown function type "${u}"`);f=np}if(s){const w={},E=[];for(let z=0;z<t.stops.length;z++){const R=t.stops[z],O=R[0].zoom;w[O]===void 0&&(w[O]={zoom:O,type:t.type,property:t.property,default:t.default,stops:[]},E.push(O)),w[O].stops.push([R[0].value,R[1]])}const I=[];for(const z of E)I.push([w[z].zoom,Oo(w[z],e)]);const A={name:"linear"};return{kind:"composite",interpolationType:A,interpolationFactor:rr.interpolationFactor.bind(void 0,A),zoomStops:I.map(z=>z[0]),evaluate:({zoom:z},R)=>ru({stops:I,base:t.base},e,z).evaluate(z,R)}}if(h){const w=u==="exponential"?{name:"exponential",base:t.base!==void 0?t.base:1}:null;return{kind:"camera",interpolationType:w,interpolationFactor:rr.interpolationFactor.bind(void 0,w),zoomStops:t.stops.map(E=>E[0]),evaluate:({zoom:E})=>f(t,e,E,g,x)}}return{kind:"source",evaluate(w,E){const I=E&&E.properties?E.properties[t.property]:void 0;return I===void 0?Bi(t.default,e.default):f(t,e,I,g,x)}}}function Bi(t,e,r){return t!==void 0?t:e!==void 0?e:r!==void 0?r:void 0}function Ka(t,e,r,s,h){return Bi(typeof r===h?s[r]:void 0,t.default,e.default)}function rp(t,e,r){if(Dt(r)!=="number")return Bi(t.default,e.default);const s=t.stops.length;if(s===1||r<=t.stops[0][0])return t.stops[0][1];if(r>=t.stops[s-1][0])return t.stops[s-1][1];const h=ko(t.stops.map(u=>u[0]),r);return t.stops[h][1]}function ru(t,e,r){const s=t.base!==void 0?t.base:1;if(Dt(r)!=="number")return Bi(t.default,e.default);const h=t.stops.length;if(h===1||r<=t.stops[0][0])return t.stops[0][1];if(r>=t.stops[h-1][0])return t.stops[h-1][1];const u=ko(t.stops.map(E=>E[0]),r),f=function(E,I,A,z){const R=z-A,O=E-A;return R===0?0:I===1?O/R:(Math.pow(I,O)-1)/(Math.pow(I,R)-1)}(r,s,t.stops[u][0],t.stops[u+1][0]),g=t.stops[u][1],x=t.stops[u+1][1];let w=Fa[e.type]||Ha;if(t.colorSpace&&t.colorSpace!=="rgb"){const E=Kh[t.colorSpace];w=(I,A)=>E.reverse(E.interpolate(E.forward(I),E.forward(A),f))}return typeof g.evaluate=="function"?{evaluate(...E){const I=g.evaluate.apply(void 0,E),A=x.evaluate.apply(void 0,E);if(I!==void 0&&A!==void 0)return w(I,A,f)}}:w(g,x,f)}function np(t,e,r){return e.type==="color"?r=At.parse(r):e.type==="formatted"?r=lt.fromString(r.toString()):e.type==="resolvedImage"?r=Ar.fromString(r.toString()):Dt(r)===e.type||e.type==="enum"&&e.values[r]||(r=void 0),Bi(r,t.default,e.default)}dr.register(Vr,{error:[{kind:"error"},[xt],(t,[e])=>{throw new Ei(e.evaluate(t))}],typeof:[xt,[ft],(t,[e])=>ri(fi(e.evaluate(t)))],"to-rgba":[Ir(Ne,4),[rn],(t,[e])=>e.evaluate(t).toArray()],rgb:[rn,[Ne,Ne,Ne],lc],rgba:[rn,[Ne,Ne,Ne,Ne],lc],has:{type:pt,overloads:[[[xt],(t,[e])=>cc(e.evaluate(t),t.properties())],[[xt,zs],(t,[e,r])=>cc(e.evaluate(t),r.evaluate(t))]]},get:{type:ft,overloads:[[[xt],(t,[e])=>Fo(e.evaluate(t),t.properties())],[[xt,zs],(t,[e,r])=>Fo(e.evaluate(t),r.evaluate(t))]]},"feature-state":[ft,[xt],(t,[e])=>Fo(e.evaluate(t),t.featureState||{})],properties:[zs,[],t=>t.properties()],"geometry-type":[xt,[],t=>t.geometryType()],id:[ft,[],t=>t.id()],zoom:[Ne,[],t=>t.globals.zoom],pitch:[Ne,[],t=>t.globals.pitch||0],"distance-from-center":[Ne,[],t=>t.distanceFromCenter()],"heatmap-density":[Ne,[],t=>t.globals.heatmapDensity||0],"line-progress":[Ne,[],t=>t.globals.lineProgress||0],"sky-radial-progress":[Ne,[],t=>t.globals.skyRadialProgress||0],accumulated:[ft,[],t=>t.globals.accumulated===void 0?null:t.globals.accumulated],"+":[Ne,Nn(Ne),(t,e)=>{let r=0;for(const s of e)r+=s.evaluate(t);return r}],"*":[Ne,Nn(Ne),(t,e)=>{let r=1;for(const s of e)r*=s.evaluate(t);return r}],"-":{type:Ne,overloads:[[[Ne,Ne],(t,[e,r])=>e.evaluate(t)-r.evaluate(t)],[[Ne],(t,[e])=>-e.evaluate(t)]]},"/":[Ne,[Ne,Ne],(t,[e,r])=>e.evaluate(t)/r.evaluate(t)],"%":[Ne,[Ne,Ne],(t,[e,r])=>e.evaluate(t)%r.evaluate(t)],ln2:[Ne,[],()=>Math.LN2],pi:[Ne,[],()=>Math.PI],e:[Ne,[],()=>Math.E],"^":[Ne,[Ne,Ne],(t,[e,r])=>Math.pow(e.evaluate(t),r.evaluate(t))],sqrt:[Ne,[Ne],(t,[e])=>Math.sqrt(e.evaluate(t))],log10:[Ne,[Ne],(t,[e])=>Math.log(e.evaluate(t))/Math.LN10],ln:[Ne,[Ne],(t,[e])=>Math.log(e.evaluate(t))],log2:[Ne,[Ne],(t,[e])=>Math.log(e.evaluate(t))/Math.LN2],sin:[Ne,[Ne],(t,[e])=>Math.sin(e.evaluate(t))],cos:[Ne,[Ne],(t,[e])=>Math.cos(e.evaluate(t))],tan:[Ne,[Ne],(t,[e])=>Math.tan(e.evaluate(t))],asin:[Ne,[Ne],(t,[e])=>Math.asin(e.evaluate(t))],acos:[Ne,[Ne],(t,[e])=>Math.acos(e.evaluate(t))],atan:[Ne,[Ne],(t,[e])=>Math.atan(e.evaluate(t))],min:[Ne,Nn(Ne),(t,e)=>Math.min(...e.map(r=>r.evaluate(t)))],max:[Ne,Nn(Ne),(t,e)=>Math.max(...e.map(r=>r.evaluate(t)))],abs:[Ne,[Ne],(t,[e])=>Math.abs(e.evaluate(t))],round:[Ne,[Ne],(t,[e])=>{const r=e.evaluate(t);return r<0?-Math.round(-r):Math.round(r)}],floor:[Ne,[Ne],(t,[e])=>Math.floor(e.evaluate(t))],ceil:[Ne,[Ne],(t,[e])=>Math.ceil(e.evaluate(t))],"filter-==":[pt,[xt,ft],(t,[e,r])=>t.properties()[e.value]===r.value],"filter-id-==":[pt,[ft],(t,[e])=>t.id()===e.value],"filter-type-==":[pt,[xt],(t,[e])=>t.geometryType()===e.value],"filter-<":[pt,[xt,ft],(t,[e,r])=>{const s=t.properties()[e.value],h=r.value;return typeof s==typeof h&&s<h}],"filter-id-<":[pt,[ft],(t,[e])=>{const r=t.id(),s=e.value;return typeof r==typeof s&&r<s}],"filter->":[pt,[xt,ft],(t,[e,r])=>{const s=t.properties()[e.value],h=r.value;return typeof s==typeof h&&s>h}],"filter-id->":[pt,[ft],(t,[e])=>{const r=t.id(),s=e.value;return typeof r==typeof s&&r>s}],"filter-<=":[pt,[xt,ft],(t,[e,r])=>{const s=t.properties()[e.value],h=r.value;return typeof s==typeof h&&s<=h}],"filter-id-<=":[pt,[ft],(t,[e])=>{const r=t.id(),s=e.value;return typeof r==typeof s&&r<=s}],"filter->=":[pt,[xt,ft],(t,[e,r])=>{const s=t.properties()[e.value],h=r.value;return typeof s==typeof h&&s>=h}],"filter-id->=":[pt,[ft],(t,[e])=>{const r=t.id(),s=e.value;return typeof r==typeof s&&r>=s}],"filter-has":[pt,[ft],(t,[e])=>e.value in t.properties()],"filter-has-id":[pt,[],t=>t.id()!==null&&t.id()!==void 0],"filter-type-in":[pt,[Ir(xt)],(t,[e])=>e.value.indexOf(t.geometryType())>=0],"filter-id-in":[pt,[Ir(ft)],(t,[e])=>e.value.indexOf(t.id())>=0],"filter-in-small":[pt,[xt,Ir(ft)],(t,[e,r])=>r.value.indexOf(t.properties()[e.value])>=0],"filter-in-large":[pt,[xt,Ir(ft)],(t,[e,r])=>function(s,h,u,f){for(;u<=f;){const g=u+f>>1;if(h[g]===s)return!0;h[g]>s?f=g-1:u=g+1}return!1}(t.properties()[e.value],r.value,0,r.value.length-1)],all:{type:pt,overloads:[[[pt,pt],(t,[e,r])=>e.evaluate(t)&&r.evaluate(t)],[Nn(pt),(t,e)=>{for(const r of e)if(!r.evaluate(t))return!1;return!0}]]},any:{type:pt,overloads:[[[pt,pt],(t,[e,r])=>e.evaluate(t)||r.evaluate(t)],[Nn(pt),(t,e)=>{for(const r of e)if(r.evaluate(t))return!0;return!1}]]},"!":[pt,[pt],(t,[e])=>!e.evaluate(t)],"is-supported-script":[pt,[xt],(t,[e])=>{const r=t.globals&&t.globals.isSupportedScript;return!r||r(e.evaluate(t))}],upcase:[xt,[xt],(t,[e])=>e.evaluate(t).toUpperCase()],downcase:[xt,[xt],(t,[e])=>e.evaluate(t).toLowerCase()],concat:[xt,Nn(ft),(t,e)=>e.map(r=>So(r.evaluate(t))).join("")],"resolved-locale":[xt,[To],(t,[e])=>e.evaluate(t).resolvedLocale()]});class uc{constructor(e,r){this.expression=e,this._warningHistory={},this._evaluator=new Oh,this._defaultValue=r?function(s){return s.type==="color"&&Xa(s.default)?new At(0,0,0,0):s.type==="color"?At.parse(s.default)||null:s.default===void 0?null:s.default}(r):null,this._enumValues=r&&r.type==="enum"?r.values:null}evaluateWithoutErrorHandling(e,r,s,h,u,f,g,x){return this._evaluator.globals=e,this._evaluator.feature=r,this._evaluator.featureState=s,this._evaluator.canonical=h,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=f,this._evaluator.featureTileCoord=g||null,this._evaluator.featureDistanceData=x||null,this.expression.evaluate(this._evaluator)}evaluate(e,r,s,h,u,f,g,x){this._evaluator.globals=e,this._evaluator.feature=r||null,this._evaluator.featureState=s||null,this._evaluator.canonical=h,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=f||null,this._evaluator.featureTileCoord=g||null,this._evaluator.featureDistanceData=x||null;try{const w=this.expression.evaluate(this._evaluator);if(w==null||typeof w=="number"&&w!=w)return this._defaultValue;if(this._enumValues&&!(w in this._enumValues))throw new Ei(`Expected value to be one of ${Object.keys(this._enumValues).map(E=>JSON.stringify(E)).join(", ")}, but found ${JSON.stringify(w)} instead.`);return w}catch(w){return this._warningHistory[w.message]||(this._warningHistory[w.message]=!0,typeof console!="undefined"&&console.warn(w.message)),this._defaultValue}}}function Os(t){return Array.isArray(t)&&t.length>0&&typeof t[0]=="string"&&t[0]in Vr}function No(t,e){const r=new Ra(Vr,[],e?function(h){const u={color:rn,string:xt,number:Ne,enum:xt,boolean:pt,formatted:Ln,resolvedImage:Eo};return h.type==="array"?Ir(u[h.value]||ft,h.length):u[h.type]}(e):void 0),s=r.parse(t,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return s?tu(new uc(s,e)):mn(r.errors)}class Uo{constructor(e,r){this.kind=e,this._styleExpression=r,this.isStateDependent=e!=="constant"&&!Co(r.expression)}evaluateWithoutErrorHandling(e,r,s,h,u,f){return this._styleExpression.evaluateWithoutErrorHandling(e,r,s,h,u,f)}evaluate(e,r,s,h,u,f){return this._styleExpression.evaluate(e,r,s,h,u,f)}}class dc{constructor(e,r,s,h){this.kind=e,this.zoomStops=s,this._styleExpression=r,this.isStateDependent=e!=="camera"&&!Co(r.expression),this.interpolationType=h}evaluateWithoutErrorHandling(e,r,s,h,u,f){return this._styleExpression.evaluateWithoutErrorHandling(e,r,s,h,u,f)}evaluate(e,r,s,h,u,f){return this._styleExpression.evaluate(e,r,s,h,u,f)}interpolationFactor(e,r,s){return this.interpolationType?rr.interpolationFactor(this.interpolationType,e,r,s):0}}function nu(t,e){if((t=No(t,e)).result==="error")return t;const r=t.value.expression,s=Bs(r);if(!s&&!Fs(e))return mn([new tn("","data expressions not supported")]);const h=Mo(r,["zoom","pitch","distance-from-center"]);if(!h&&!iu(e))return mn([new tn("","zoom expressions not supported")]);const u=Ya(r);return u||h?u instanceof tn?mn([u]):u instanceof rr&&!hc(e)?mn([new tn("",'"interpolate" expressions cannot be used with this property')]):tu(u?new dc(s?"camera":"composite",t.value,u.labels,u instanceof rr?u.interpolation:void 0):new Uo(s?"constant":"source",t.value)):mn([new tn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Ns{constructor(e,r){this._parameters=e,this._specification=r,zn(this,Oo(this._parameters,this._specification))}static deserialize(e){return new Ns(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Ya(t){let e=null;if(t instanceof $a)e=Ya(t.result);else if(t instanceof ns){for(const r of t.args)if(e=Ya(r),e)break}else(t instanceof Do||t instanceof rr)&&t.input instanceof dr&&t.input.name==="zoom"&&(e=t);return e instanceof tn||t.eachChild(r=>{const s=Ya(r);s instanceof tn?e=s:!e&&s?e=new tn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&s&&e!==s&&(e=new tn("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}function Mr(t){const e=t.key,r=t.value,s=t.valueSpec||{},h=t.objectElementValidators||{},u=t.style,f=t.styleSpec;let g=[];const x=Dt(r);if(x!=="object")return[new Ue(e,r,`object expected, ${x} found`)];for(const w in r){const E=w.split(".")[0],I=s[E]||s["*"];let A;if(h[E])A=h[E];else if(s[E])A=Si;else if(h["*"])A=h["*"];else{if(!s["*"]){g.push(new Ue(e,r[w],`unknown property "${w}"`));continue}A=Si}g=g.concat(A({key:(e&&`${e}.`)+w,value:r[w],valueSpec:I,style:u,styleSpec:f,object:r,objectKey:w},r))}for(const w in s)h[w]||s[w].required&&s[w].default===void 0&&r[w]===void 0&&g.push(new Ue(e,r,`missing required property "${w}"`));return g}function pc(t){const e=t.value,r=t.valueSpec,s=t.style,h=t.styleSpec,u=t.key,f=t.arrayElementValidator||Si;if(Dt(e)!=="array")return[new Ue(u,e,`array expected, ${Dt(e)} found`)];if(r.length&&e.length!==r.length)return[new Ue(u,e,`array length ${r.length} expected, length ${e.length} found`)];if(r["min-length"]&&e.length<r["min-length"])return[new Ue(u,e,`array length at least ${r["min-length"]} expected, length ${e.length} found`)];let g={type:r.value,values:r.values,minimum:r.minimum,maximum:r.maximum};h.$version<7&&(g.function=r.function),Dt(r.value)==="object"&&(g=r.value);let x=[];for(let w=0;w<e.length;w++)x=x.concat(f({array:e,arrayIndex:w,value:e[w],valueSpec:g,style:s,styleSpec:h,key:`${u}[${w}]`}));return x}function su(t){const e=t.key,r=t.value,s=t.valueSpec;let h=Dt(r);if(h==="number"&&r!=r&&(h="NaN"),h!=="number")return[new Ue(e,r,`number expected, ${h} found`)];if("minimum"in s){let u=s.minimum;if(Dt(s.minimum)==="array"&&(u=s.minimum[t.arrayIndex]),r<u)return[new Ue(e,r,`${r} is less than the minimum value ${u}`)]}if("maximum"in s){let u=s.maximum;if(Dt(s.maximum)==="array"&&(u=s.maximum[t.arrayIndex]),r>u)return[new Ue(e,r,`${r} is greater than the maximum value ${u}`)]}return[]}function Ja(t){const e=t.valueSpec,r=li(t.value.type);let s,h,u,f={};const g=r!=="categorical"&&t.value.property===void 0,x=!g,w=Dt(t.value.stops)==="array"&&Dt(t.value.stops[0])==="array"&&Dt(t.value.stops[0][0])==="object",E=Mr({key:t.key,value:t.value,valueSpec:t.styleSpec.function,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{stops:function(z){if(r==="identity")return[new Ue(z.key,z.value,'identity function may not have a "stops" property')];let R=[];const O=z.value;return R=R.concat(pc({key:z.key,value:O,valueSpec:z.valueSpec,style:z.style,styleSpec:z.styleSpec,arrayElementValidator:I})),Dt(O)==="array"&&O.length===0&&R.push(new Ue(z.key,O,"array must have at least one stop")),R},default:function(z){return Si({key:z.key,value:z.value,valueSpec:e,style:z.style,styleSpec:z.styleSpec})}}});return r==="identity"&&g&&E.push(new Ue(t.key,t.value,'missing required property "property"')),r==="identity"||t.value.stops||E.push(new Ue(t.key,t.value,'missing required property "stops"')),r==="exponential"&&t.valueSpec.expression&&!hc(t.valueSpec)&&E.push(new Ue(t.key,t.value,"exponential functions not supported")),t.styleSpec.$version>=8&&(x&&!Fs(t.valueSpec)?E.push(new Ue(t.key,t.value,"property functions not supported")):g&&!iu(t.valueSpec)&&E.push(new Ue(t.key,t.value,"zoom functions not supported"))),r!=="categorical"&&!w||t.value.property!==void 0||E.push(new Ue(t.key,t.value,'"property" property is required')),E;function I(z){let R=[];const O=z.value,U=z.key;if(Dt(O)!=="array")return[new Ue(U,O,`array expected, ${Dt(O)} found`)];if(O.length!==2)return[new Ue(U,O,`array length 2 expected, length ${O.length} found`)];if(w){if(Dt(O[0])!=="object")return[new Ue(U,O,`object expected, ${Dt(O[0])} found`)];if(O[0].zoom===void 0)return[new Ue(U,O,"object stop key must have zoom")];if(O[0].value===void 0)return[new Ue(U,O,"object stop key must have value")];if(u&&u>li(O[0].zoom))return[new Ue(U,O[0].zoom,"stop zoom values must appear in ascending order")];li(O[0].zoom)!==u&&(u=li(O[0].zoom),h=void 0,f={}),R=R.concat(Mr({key:`${U}[0]`,value:O[0],valueSpec:{zoom:{}},style:z.style,styleSpec:z.styleSpec,objectElementValidators:{zoom:su,value:A}}))}else R=R.concat(A({key:`${U}[0]`,value:O[0],valueSpec:{},style:z.style,styleSpec:z.styleSpec},O));return Os(fn(O[1]))?R.concat([new Ue(`${U}[1]`,O[1],"expressions are not allowed in function stops.")]):R.concat(Si({key:`${U}[1]`,value:O[1],valueSpec:e,style:z.style,styleSpec:z.styleSpec}))}function A(z,R){const O=Dt(z.value),U=li(z.value),Z=z.value!==null?z.value:R;if(s){if(O!==s)return[new Ue(z.key,Z,`${O} stop domain type must match previous stop domain type ${s}`)]}else s=O;if(O!=="number"&&O!=="string"&&O!=="boolean")return[new Ue(z.key,Z,"stop domain value must be a number, string, or boolean")];if(O!=="number"&&r!=="categorical"){let Q=`number expected, ${O} found`;return Fs(e)&&r===void 0&&(Q+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Ue(z.key,Z,Q)]}return r!=="categorical"||O!=="number"||isFinite(U)&&Math.floor(U)===U?r!=="categorical"&&O==="number"&&h!==void 0&&U<h?[new Ue(z.key,Z,"stop domain values must appear in ascending order")]:(h=U,r==="categorical"&&U in f?[new Ue(z.key,Z,"stop domain values must be unique")]:(f[U]=!0,[])):[new Ue(z.key,Z,`integer expected, found ${U}`)]}}function _n(t){const e=(t.expressionContext==="property"?nu:No)(fn(t.value),t.valueSpec);if(e.result==="error")return e.value.map(s=>new Ue(`${t.key}${s.key}`,t.value,s.message));const r=e.value.expression||e.value._styleExpression.expression;if(t.expressionContext==="property"&&t.propertyKey==="text-font"&&!r.outputDefined())return[new Ue(t.key,t.value,`Invalid data expression for "${t.propertyKey}". Output values must be contained as literals within the expression.`)];if(t.expressionContext==="property"&&t.propertyType==="layout"&&!Co(r))return[new Ue(t.key,t.value,'"feature-state" data expressions are not supported with layout properties.')];if(t.expressionContext==="filter")return fc(r,t);if(t.expressionContext&&t.expressionContext.indexOf("cluster")===0){if(!Mo(r,["zoom","feature-state"]))return[new Ue(t.key,t.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(t.expressionContext==="cluster-initial"&&!Bs(r))return[new Ue(t.key,t.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function fc(t,e){const r=new Set(["zoom","feature-state","pitch","distance-from-center"]);for(const h of e.valueSpec.expression.parameters)r.delete(h);if(r.size===0)return[];const s=[];return t instanceof dr&&r.has(t.name)?[new Ue(e.key,e.value,`["${t.name}"] expression is not supported in a filter for a ${e.object.type} layer with id: ${e.object.id}`)]:(t.eachChild(h=>{s.push(...fc(h,e))}),s)}function Qa(t){const e=t.key,r=t.value,s=t.valueSpec,h=[];return Array.isArray(s.values)?s.values.indexOf(li(r))===-1&&h.push(new Ue(e,r,`expected one of [${s.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(s.values).indexOf(li(r))===-1&&h.push(new Ue(e,r,`expected one of [${Object.keys(s.values).join(", ")}], ${JSON.stringify(r)} found`)),h}function el(t){if(t===!0||t===!1)return!0;if(!Array.isArray(t)||t.length===0)return!1;switch(t[0]){case"has":return t.length>=2&&t[1]!=="$id"&&t[1]!=="$type";case"in":return t.length>=3&&(typeof t[1]!="string"||Array.isArray(t[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return t.length!==3||Array.isArray(t[1])||Array.isArray(t[2]);case"any":case"all":for(const e of t.slice(1))if(!el(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function tl(t,e="fill"){if(t==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};el(t)||(t=rl(t));const r=t;let s=!0;try{s=function(w){if(!Us(w))return w;let E=fn(w);return ou(E),E=il(E),E}(r)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(r,null,2)}
        `)}const h=ye[`filter_${e}`],u=No(s,h);let f=null;if(u.result==="error")throw new Error(u.value.map(w=>`${w.key}: ${w.message}`).join(", "));f=(w,E,I)=>u.value.evaluate(w,E,{},I);let g=null,x=null;if(s!==r){const w=No(r,h);if(w.result==="error")throw new Error(w.value.map(E=>`${E.key}: ${E.message}`).join(", "));g=(E,I,A,z,R)=>w.value.evaluate(E,I,{},A,void 0,void 0,z,R),x=!Bs(w.value.expression)}return f=f,{filter:f,dynamicFilter:g||void 0,needGeometry:mc(s),needFeature:!!x}}function il(t){if(!Array.isArray(t))return t;const e=function(r){if(sp.has(r[0])){for(let s=1;s<r.length;s++)if(Us(r[s]))return!0}return r}(t);return e===!0?e:e.map(r=>il(r))}function ou(t){let e=!1;const r=[];if(t[0]==="case"){for(let s=1;s<t.length-1;s+=2)e=e||Us(t[s]),r.push(t[s+1]);r.push(t[t.length-1])}else if(t[0]==="match"){e=e||Us(t[1]);for(let s=2;s<t.length-1;s+=2)r.push(t[s+1]);r.push(t[t.length-1])}else if(t[0]==="step"){e=e||Us(t[1]);for(let s=1;s<t.length-1;s+=2)r.push(t[s+1])}e&&(t.length=0,t.push("any",...r));for(let s=1;s<t.length;s++)ou(t[s])}function Us(t){if(!Array.isArray(t))return!1;if((e=t[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let r=1;r<t.length;r++)if(Us(t[r]))return!0;return!1}const sp=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function op(t,e){return t<e?-1:t>e?1:0}function mc(t){if(!Array.isArray(t))return!1;if(t[0]==="within")return!0;for(let e=1;e<t.length;e++)if(mc(t[e]))return!0;return!1}function rl(t){if(!t)return!0;const e=t[0];return t.length<=1?e!=="any":e==="=="?_c(t[1],t[2],"=="):e==="!="?nl(_c(t[1],t[2],"==")):e==="<"||e===">"||e==="<="||e===">="?_c(t[1],t[2],e):e==="any"?(r=t.slice(1),["any"].concat(r.map(rl))):e==="all"?["all"].concat(t.slice(1).map(rl)):e==="none"?["all"].concat(t.slice(1).map(rl).map(nl)):e==="in"?au(t[1],t.slice(2)):e==="!in"?nl(au(t[1],t.slice(2))):e==="has"?lu(t[1]):e==="!has"?nl(lu(t[1])):e!=="within"||t;var r}function _c(t,e,r){switch(t){case"$type":return[`filter-type-${r}`,e];case"$id":return[`filter-id-${r}`,e];default:return[`filter-${r}`,t,e]}}function au(t,e){if(e.length===0)return!1;switch(t){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(r=>typeof r!=typeof e[0])?["filter-in-large",t,["literal",e.sort(op)]]:["filter-in-small",t,["literal",e]]}}function lu(t){switch(t){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",t]}}function nl(t){return["!",t]}function gc(t){if(el(fn(t.value))){const e=fn(t.layerType);return _n(zn({},t,{expressionContext:"filter",valueSpec:t.styleSpec[`filter_${e||"fill"}`]}))}return cu(t)}function cu(t){const e=t.value,r=t.key;if(Dt(e)!=="array")return[new Ue(r,e,`array expected, ${Dt(e)} found`)];const s=t.styleSpec;let h,u=[];if(e.length<1)return[new Ue(r,e,"filter array must have at least 1 element")];switch(u=u.concat(Qa({key:`${r}[0]`,value:e[0],valueSpec:s.filter_operator,style:t.style,styleSpec:t.styleSpec})),li(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&li(e[1])==="$type"&&u.push(new Ue(r,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&u.push(new Ue(r,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(h=Dt(e[1]),h!=="string"&&u.push(new Ue(`${r}[1]`,e[1],`string expected, ${h} found`)));for(let f=2;f<e.length;f++)h=Dt(e[f]),li(e[1])==="$type"?u=u.concat(Qa({key:`${r}[${f}]`,value:e[f],valueSpec:s.geometry_type,style:t.style,styleSpec:t.styleSpec})):h!=="string"&&h!=="number"&&h!=="boolean"&&u.push(new Ue(`${r}[${f}]`,e[f],`string, number, or boolean expected, ${h} found`));break;case"any":case"all":case"none":for(let f=1;f<e.length;f++)u=u.concat(cu({key:`${r}[${f}]`,value:e[f],style:t.style,styleSpec:t.styleSpec}));break;case"has":case"!has":h=Dt(e[1]),e.length!==2?u.push(new Ue(r,e,`filter array for "${e[0]}" operator must have 2 elements`)):h!=="string"&&u.push(new Ue(`${r}[1]`,e[1],`string expected, ${h} found`));break;case"within":h=Dt(e[1]),e.length!==2?u.push(new Ue(r,e,`filter array for "${e[0]}" operator must have 2 elements`)):h!=="object"&&u.push(new Ue(`${r}[1]`,e[1],`object expected, ${h} found`))}return u}function Vo(t,e){const r=t.key,s=t.style,h=t.styleSpec,u=t.value,f=t.objectKey,g=h[`${e}_${t.layerType}`];if(!g)return[];const x=f.match(/^(.*)-transition$/);if(e==="paint"&&x&&g[x[1]]&&g[x[1]].transition)return Si({key:r,value:u,valueSpec:h.transition,style:s,styleSpec:h});const w=t.valueSpec||g[f];if(!w)return[new Ue(r,u,`unknown property "${f}"`)];let E;if(Dt(u)==="string"&&Fs(w)&&!w.tokens&&(E=/^{([^}]+)}$/.exec(u)))return[new Ue(r,u,`"${f}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(E[1])} }\`.`)];const I=[];return t.layerType==="symbol"&&(f==="text-field"&&s&&!s.glyphs&&I.push(new Ue(r,u,'use of "text-field" requires a style "glyphs" property')),f==="text-font"&&Xa(fn(u))&&li(u.type)==="identity"&&I.push(new Ue(r,u,'"text-font" does not support identity functions'))),I.concat(Si({key:t.key,value:u,valueSpec:w,style:s,styleSpec:h,expressionContext:"property",propertyType:e,propertyKey:f}))}function hu(t){return Vo(t,"paint")}function uu(t){return Vo(t,"layout")}function jo(t){let e=[];const r=t.value,s=t.key,h=t.style,u=t.styleSpec;r.type||r.ref||e.push(new Ue(s,r,'either "type" or "ref" is required'));let f=li(r.type);const g=li(r.ref);if(r.id){const x=li(r.id);for(let w=0;w<t.arrayIndex;w++){const E=h.layers[w];li(E.id)===x&&e.push(new Ue(s,r.id,`duplicate layer id "${r.id}", previously used at line ${E.id.__line__}`))}}if("ref"in r){let x;["type","source","source-layer","filter","layout"].forEach(w=>{w in r&&e.push(new Ue(s,r[w],`"${w}" is prohibited for ref layers`))}),h.layers.forEach(w=>{li(w.id)===g&&(x=w)}),x?x.ref?e.push(new Ue(s,r.ref,"ref cannot reference another ref layer")):f=li(x.type):e.push(new Ue(s,r.ref,`ref layer "${g}" not found`))}else if(f!=="background"&&f!=="sky")if(r.source){const x=h.sources&&h.sources[r.source],w=x&&li(x.type);x?w==="vector"&&f==="raster"?e.push(new Ue(s,r.source,`layer "${r.id}" requires a raster source`)):w==="raster"&&f!=="raster"?e.push(new Ue(s,r.source,`layer "${r.id}" requires a vector source`)):w!=="vector"||r["source-layer"]?w==="raster-dem"&&f!=="hillshade"?e.push(new Ue(s,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):f!=="line"||!r.paint||!r.paint["line-gradient"]||w==="geojson"&&x.lineMetrics||e.push(new Ue(s,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new Ue(s,r,`layer "${r.id}" must specify a "source-layer"`)):e.push(new Ue(s,r.source,`source "${r.source}" not found`))}else e.push(new Ue(s,r,'missing required property "source"'));return e=e.concat(Mr({key:s,value:r,valueSpec:u.layer,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Si({key:`${s}.type`,value:r.type,valueSpec:u.layer.type,style:t.style,styleSpec:t.styleSpec,object:r,objectKey:"type"}),filter:x=>gc(zn({layerType:f},x)),layout:x=>Mr({layer:r,key:x.key,value:x.value,style:x.style,styleSpec:x.styleSpec,objectElementValidators:{"*":w=>uu(zn({layerType:f},w))}}),paint:x=>Mr({layer:r,key:x.key,value:x.value,style:x.style,styleSpec:x.styleSpec,objectElementValidators:{"*":w=>hu(zn({layerType:f},w))}})}})),e}function Vs(t){const e=t.value,r=t.key,s=Dt(e);return s!=="string"?[new Ue(r,e,`string expected, ${s} found`)]:[]}const yc={promoteId:function({key:t,value:e}){if(Dt(e)==="string")return Vs({key:t,value:e});{const r=[];for(const s in e)r.push(...Vs({key:`${t}.${s}`,value:e[s]}));return r}}};function du(t){const e=t.value,r=t.key,s=t.styleSpec,h=t.style;if(!e.type)return[new Ue(r,e,'"type" is required')];const u=li(e.type);let f;switch(u){case"vector":case"raster":case"raster-dem":return f=Mr({key:r,value:e,valueSpec:s[`source_${u.replace("-","_")}`],style:t.style,styleSpec:s,objectElementValidators:yc}),f;case"geojson":if(f=Mr({key:r,value:e,valueSpec:s.source_geojson,style:h,styleSpec:s,objectElementValidators:yc}),e.cluster)for(const g in e.clusterProperties){const[x,w]=e.clusterProperties[g],E=typeof x=="string"?[x,["accumulated"],["get",g]]:x;f.push(..._n({key:`${r}.${g}.map`,value:w,expressionContext:"cluster-map"})),f.push(..._n({key:`${r}.${g}.reduce`,value:E,expressionContext:"cluster-reduce"}))}return f;case"video":return Mr({key:r,value:e,valueSpec:s.source_video,style:h,styleSpec:s});case"image":return Mr({key:r,value:e,valueSpec:s.source_image,style:h,styleSpec:s});case"canvas":return[new Ue(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Qa({key:`${r}.type`,value:e.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:h,styleSpec:s})}}function xc(t){const e=t.value,r=t.styleSpec,s=r.light,h=t.style;let u=[];const f=Dt(e);if(e===void 0)return u;if(f!=="object")return u=u.concat([new Ue("light",e,`object expected, ${f} found`)]),u;for(const g in e){const x=g.match(/^(.*)-transition$/);u=u.concat(x&&s[x[1]]&&s[x[1]].transition?Si({key:g,value:e[g],valueSpec:r.transition,style:h,styleSpec:r}):s[g]?Si({key:g,value:e[g],valueSpec:s[g],style:h,styleSpec:r}):[new Ue(g,e[g],`unknown property "${g}"`)])}return u}function vc(t){const e=t.value,r=t.key,s=t.style,h=t.styleSpec,u=h.terrain;let f=[];const g=Dt(e);if(e===void 0)return f;if(g!=="object")return f=f.concat([new Ue("terrain",e,`object expected, ${g} found`)]),f;for(const x in e){const w=x.match(/^(.*)-transition$/);f=f.concat(w&&u[w[1]]&&u[w[1]].transition?Si({key:x,value:e[x],valueSpec:h.transition,style:s,styleSpec:h}):u[x]?Si({key:x,value:e[x],valueSpec:u[x],style:s,styleSpec:h}):[new Ue(x,e[x],`unknown property "${x}"`)])}if(e.source){const x=s.sources&&s.sources[e.source],w=x&&li(x.type);x?w!=="raster-dem"&&f.push(new Ue(r,e.source,`terrain cannot be used with a source of type ${w}, it only be used with a "raster-dem" source type`)):f.push(new Ue(r,e.source,`source "${e.source}" not found`))}else f.push(new Ue(r,e,'terrain is missing required property "source"'));return f}function bc(t){const e=t.value,r=t.style,s=t.styleSpec,h=s.fog;let u=[];const f=Dt(e);if(e===void 0)return u;if(f!=="object")return u=u.concat([new Ue("fog",e,`object expected, ${f} found`)]),u;for(const g in e){const x=g.match(/^(.*)-transition$/);u=u.concat(x&&h[x[1]]&&h[x[1]].transition?Si({key:g,value:e[g],valueSpec:s.transition,style:r,styleSpec:s}):h[g]?Si({key:g,value:e[g],valueSpec:h[g],style:r,styleSpec:s}):[new Ue(g,e[g],`unknown property "${g}"`)])}return u}const wc={"*":()=>[],array:pc,boolean:function(t){const e=t.value,r=t.key,s=Dt(e);return s!=="boolean"?[new Ue(r,e,`boolean expected, ${s} found`)]:[]},number:su,color:function(t){const e=t.key,r=t.value,s=Dt(r);return s!=="string"?[new Ue(e,r,`color expected, ${s} found`)]:Rs.parseCSSColor(r)===null?[new Ue(e,r,`color expected, "${r}" found`)]:[]},constants:Rh,enum:Qa,filter:gc,function:Ja,layer:jo,object:Mr,source:du,light:xc,terrain:vc,fog:bc,string:Vs,formatted:function(t){return Vs(t).length===0?[]:_n(t)},resolvedImage:function(t){return Vs(t).length===0?[]:_n(t)},projection:function(t){const e=t.value,r=t.styleSpec,s=r.projection,h=t.style;let u=[];const f=Dt(e);if(f==="object")for(const g in e)u=u.concat(Si({key:g,value:e[g],valueSpec:s[g],style:h,styleSpec:r}));else f!=="string"&&(u=u.concat([new Ue("projection",e,`object or string expected, ${f} found`)]));return u}};function Si(t){const e=t.value,r=t.valueSpec,s=t.styleSpec;return r.expression&&Xa(li(e))?Ja(t):r.expression&&Os(fn(e))?_n(t):r.type&&wc[r.type]?wc[r.type](t):Mr(zn({},t,{valueSpec:r.type?s[r.type]:r}))}function Tc(t){const e=t.value,r=t.key,s=Vs(t);return s.length||(e.indexOf("{fontstack}")===-1&&s.push(new Ue(r,e,'"glyphs" url must include a "{fontstack}" token')),e.indexOf("{range}")===-1&&s.push(new Ue(r,e,'"glyphs" url must include a "{range}" token'))),s}function gn(t,e=ye){let r=[];return r=r.concat(Si({key:"",value:t,valueSpec:e.$root,styleSpec:e,style:t,objectElementValidators:{glyphs:Tc,"*":()=>[]}})),t.constants&&(r=r.concat(Rh({key:"constants",value:t.constants,style:t,styleSpec:e}))),pu(r)}function pu(t){return[].concat(t).sort((e,r)=>e.line-r.line)}function jr(t){return function(...e){return pu(t.apply(this,e))}}gn.source=jr(du),gn.light=jr(xc),gn.terrain=jr(vc),gn.fog=jr(bc),gn.layer=jr(jo),gn.filter=jr(gc),gn.paintProperty=jr(hu),gn.layoutProperty=jr(uu);const js=gn,$s=js.light,ap=js.fog,Ec=js.paintProperty,lp=js.layoutProperty;function fu(t,e){let r=!1;if(e&&e.length)for(const s of e)t.fire(new Aa(new Error(s.message))),r=!0;return r}var $o=qi;function qi(t,e,r){var s=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;var h=new Int32Array(this.arrayBuffer);t=h[0],this.d=(e=h[1])+2*(r=h[2]);for(var u=0;u<this.d*this.d;u++){var f=h[3+u],g=h[3+u+1];s.push(f===g?null:h.subarray(f,g))}var x=h[3+s.length+1];this.keys=h.subarray(h[3+s.length],x),this.bboxes=h.subarray(x),this.insert=this._insertReadonly}else{this.d=e+2*r;for(var w=0;w<this.d*this.d;w++)s.push([]);this.keys=[],this.bboxes=[]}this.n=e,this.extent=t,this.padding=r,this.scale=e/t,this.uid=0;var E=r/e*t;this.min=-E,this.max=t+E}qi.prototype.insert=function(t,e,r,s,h){this._forEachCell(e,r,s,h,this._insertCell,this.uid++),this.keys.push(t),this.bboxes.push(e),this.bboxes.push(r),this.bboxes.push(s),this.bboxes.push(h)},qi.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},qi.prototype._insertCell=function(t,e,r,s,h,u){this.cells[h].push(u)},qi.prototype.query=function(t,e,r,s,h){var u=this.min,f=this.max;if(t<=u&&e<=u&&f<=r&&f<=s&&!h)return Array.prototype.slice.call(this.keys);var g=[];return this._forEachCell(t,e,r,s,this._queryCell,g,{},h),g},qi.prototype._queryCell=function(t,e,r,s,h,u,f,g){var x=this.cells[h];if(x!==null)for(var w=this.keys,E=this.bboxes,I=0;I<x.length;I++){var A=x[I];if(f[A]===void 0){var z=4*A;(g?g(E[z+0],E[z+1],E[z+2],E[z+3]):t<=E[z+2]&&e<=E[z+3]&&r>=E[z+0]&&s>=E[z+1])?(f[A]=!0,u.push(w[A])):f[A]=!1}}},qi.prototype._forEachCell=function(t,e,r,s,h,u,f,g){for(var x=this._convertToCellCoord(t),w=this._convertToCellCoord(e),E=this._convertToCellCoord(r),I=this._convertToCellCoord(s),A=x;A<=E;A++)for(var z=w;z<=I;z++){var R=this.d*z+A;if((!g||g(this._convertFromCellCoord(A),this._convertFromCellCoord(z),this._convertFromCellCoord(A+1),this._convertFromCellCoord(z+1)))&&h.call(this,t,e,r,s,R,u,f,g))return}},qi.prototype._convertFromCellCoord=function(t){return(t-this.padding)/this.scale},qi.prototype._convertToCellCoord=function(t){return Math.max(0,Math.min(this.d-1,Math.floor(t*this.scale)+this.padding))},qi.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var t=this.cells,e=3+this.cells.length+1+1,r=0,s=0;s<this.cells.length;s++)r+=this.cells[s].length;var h=new Int32Array(e+r+this.keys.length+this.bboxes.length);h[0]=this.extent,h[1]=this.n,h[2]=this.padding;for(var u=e,f=0;f<t.length;f++){var g=t[f];h[3+f]=u,h.set(g,u),u+=g.length}return h[3+t.length]=u,h.set(this.keys,u),h[3+t.length+1]=u+=this.keys.length,h.set(this.bboxes,u),u+=this.bboxes.length,h.buffer};const{ImageData:Go,ImageBitmap:Gs}=fe,qo={};function je(t,e,r={}){Object.defineProperty(e,"_classRegistryKey",{value:t,writeable:!1}),qo[t]={klass:e,omit:r.omit||[],shallow:r.shallow||[]}}je("Object",Object),$o.serialize=function(t,e){const r=t.toArrayBuffer();return e&&e.push(r),{buffer:r}},$o.deserialize=function(t){return new $o(t.buffer)},je("Grid",$o),je("Color",At),je("Error",Error),je("ResolvedImage",Ar),je("StylePropertyFunction",Ns),je("StyleExpression",uc,{omit:["_evaluator"]}),je("ZoomDependentExpression",dc),je("ZoomConstantExpression",Uo),je("CompoundExpression",dr,{omit:["_evaluate"]});for(const t in Vr)Vr[t]._classRegistryKey||je(`Expression_${t}`,Vr[t]);function qs(t){return t&&typeof ArrayBuffer!="undefined"&&(t instanceof ArrayBuffer||t.constructor&&t.constructor.name==="ArrayBuffer")}function mu(t){return Gs&&t instanceof Gs}function Zo(t,e){if(t==null||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp)return t;if(qs(t)||mu(t))return e&&e.push(t),t;if(ArrayBuffer.isView(t)){const r=t;return e&&e.push(r.buffer),r}if(t instanceof Go)return e&&e.push(t.data.buffer),t;if(Array.isArray(t)){const r=[];for(const s of t)r.push(Zo(s,e));return r}if(typeof t=="object"){const r=t.constructor,s=r._classRegistryKey;if(!s)throw new Error("can't serialize object of unregistered class");const h=r.serialize?r.serialize(t,e):{};if(!r.serialize){for(const u in t){if(!t.hasOwnProperty(u)||qo[s].omit.indexOf(u)>=0)continue;const f=t[u];h[u]=qo[s].shallow.indexOf(u)>=0?f:Zo(f,e)}t instanceof Error&&(h.message=t.message)}if(h.$name)throw new Error("$name property is reserved for worker serialization logic.");return s!=="Object"&&(h.$name=s),h}throw new Error("can't serialize object of type "+typeof t)}function Un(t){if(t==null||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp||qs(t)||mu(t)||ArrayBuffer.isView(t)||t instanceof Go)return t;if(Array.isArray(t))return t.map(Un);if(typeof t=="object"){const e=t.$name||"Object",{klass:r}=qo[e];if(!r)throw new Error(`can't deserialize unregistered class ${e}`);if(r.deserialize)return r.deserialize(t);const s=Object.create(r.prototype);for(const h of Object.keys(t)){if(h==="$name")continue;const u=t[h];s[h]=qo[e].shallow.indexOf(h)>=0?u:Un(u)}return s}throw new Error("can't deserialize object of type "+typeof t)}class d{constructor(){this.first=!0}update(e,r){const s=Math.floor(e);return this.first?(this.first=!1,this.lastIntegerZoom=s,this.lastIntegerZoomTime=0,this.lastZoom=e,this.lastFloorZoom=s,!0):(this.lastFloorZoom>s?(this.lastIntegerZoom=s+1,this.lastIntegerZoomTime=r):this.lastFloorZoom<s&&(this.lastIntegerZoom=s,this.lastIntegerZoomTime=r),e!==this.lastZoom&&(this.lastZoom=e,this.lastFloorZoom=s,!0))}}const i=t=>t>=1536&&t<=1791,l=t=>t>=1872&&t<=1919,p=t=>t>=2208&&t<=2303,_=t=>t>=11904&&t<=12031,y=t=>t>=12032&&t<=12255,b=t=>t>=12272&&t<=12287,T=t=>t>=12288&&t<=12351,C=t=>t>=12352&&t<=12447,M=t=>t>=12448&&t<=12543,k=t=>t>=12544&&t<=12591,P=t=>t>=12704&&t<=12735,F=t=>t>=12736&&t<=12783,j=t=>t>=12784&&t<=12799,N=t=>t>=12800&&t<=13055,$=t=>t>=13056&&t<=13311,ee=t=>t>=13312&&t<=19903,V=t=>t>=19968&&t<=40959,Y=t=>t>=40960&&t<=42127,J=t=>t>=42128&&t<=42191,H=t=>t>=44032&&t<=55215,K=t=>t>=63744&&t<=64255,te=t=>t>=64336&&t<=65023,de=t=>t>=65040&&t<=65055,_e=t=>t>=65072&&t<=65103,Be=t=>t>=65104&&t<=65135,ke=t=>t>=65136&&t<=65279,Ce=t=>t>=65280&&t<=65519;function xe(t){for(const e of t)if(Ee(e.charCodeAt(0)))return!0;return!1}function me(t){for(const e of t)if(!Ae(e.charCodeAt(0)))return!1;return!0}function Ae(t){return!(i(t)||l(t)||p(t)||te(t)||ke(t))}function Ee(t){return!(t!==746&&t!==747&&(t<4352||!(P(t)||k(t)||_e(t)&&!(t>=65097&&t<=65103)||K(t)||$(t)||_(t)||F(t)||!(!T(t)||t>=12296&&t<=12305||t>=12308&&t<=12319||t===12336)||ee(t)||V(t)||N(t)||(e=>e>=12592&&e<=12687)(t)||(e=>e>=43360&&e<=43391)(t)||(e=>e>=55216&&e<=55295)(t)||(e=>e>=4352&&e<=4607)(t)||H(t)||C(t)||b(t)||(e=>e>=12688&&e<=12703)(t)||y(t)||j(t)||M(t)&&t!==12540||!(!Ce(t)||t===65288||t===65289||t===65293||t>=65306&&t<=65310||t===65339||t===65341||t===65343||t>=65371&&t<=65503||t===65507||t>=65512&&t<=65519)||!(!Be(t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||(e=>e>=5120&&e<=5759)(t)||(e=>e>=6320&&e<=6399)(t)||de(t)||(e=>e>=19904&&e<=19967)(t)||Y(t)||J(t))))}function Xe(t){return!(Ee(t)||function(e){return!!((r=>r>=128&&r<=255)(e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||(r=>r>=8192&&r<=8303)(e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||(r=>r>=8448&&r<=8527)(e)||(r=>r>=8528&&r<=8591)(e)||(r=>r>=8960&&r<=9215)(e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||(r=>r>=9216&&r<=9279)(e)&&e!==9251||(r=>r>=9280&&r<=9311)(e)||(r=>r>=9312&&r<=9471)(e)||(r=>r>=9632&&r<=9727)(e)||(r=>r>=9728&&r<=9983)(e)&&!(e>=9754&&e<=9759)||(r=>r>=11008&&r<=11263)(e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||T(e)||M(e)||(r=>r>=57344&&r<=63743)(e)||_e(e)||Be(e)||Ce(e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(t))}function et(t){return t>=1424&&t<=2303||te(t)||ke(t)}function ht(t,e){return!(!e&&et(t)||t>=2304&&t<=3583||t>=3840&&t<=4255||(r=>r>=6016&&r<=6143)(t))}function Re(t){for(const e of t)if(et(e.charCodeAt(0)))return!0;return!1}const Ke="deferred",st="loading",Rt="loaded";let jt=null,nt="unavailable",_t=null;const Yt=function(t){t&&typeof t=="string"&&t.indexOf("NetworkError")>-1&&(nt="error"),jt&&jt(t)};function vi(){nr.fire(new kn("pluginStateChange",{pluginStatus:nt,pluginURL:_t}))}const nr=new Dn,kr=function(){return nt},$r=function(){if(nt!==Ke||!_t)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");nt=st,vi(),_t&&bo({url:_t},t=>{t?Yt(t):(nt=Rt,vi())})},Et={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>nt===Rt||Et.applyArabicShaping!=null,isLoading:()=>nt===st,setState(t){nt=t.pluginStatus,_t=t.pluginURL},isParsed:()=>Et.applyArabicShaping!=null&&Et.processBidirectionalText!=null&&Et.processStyledBidirectionalText!=null,getPluginURL:()=>_t};class ot{constructor(e,r){this.zoom=e,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.zoomHistory=r.zoomHistory,this.transition=r.transition,this.pitch=r.pitch):(this.now=0,this.fadeDuration=0,this.zoomHistory=new d,this.transition={},this.pitch=0)}isSupportedScript(e){return function(r,s){for(const h of r)if(!ht(h.charCodeAt(0),s))return!1;return!0}(e,Et.isLoaded())}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const e=this.zoom,r=e-Math.floor(e),s=this.crossFadingFactor();return e>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:r+(1-r)*s}:{fromScale:.5,toScale:1,t:1-(1-s)*r}}}class vt{constructor(e,r){this.property=e,this.value=r,this.expression=function(s,h){if(Xa(s))return new Ns(s,h);if(Os(s)){const u=nu(s,h);if(u.result==="error")throw new Error(u.value.map(f=>`${f.key}: ${f.message}`).join(", "));return u.value}{let u=s;return typeof s=="string"&&h.type==="color"&&(u=At.parse(s)),{kind:"constant",evaluate:()=>u}}}(r===void 0?e.specification.default:r,e.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,r,s){return this.property.possiblyEvaluate(this,e,r,s)}}class oi{constructor(e){this.property=e,this.value=new vt(e,void 0)}transitioned(e,r){return new Wt(this.property,this.value,r,si({},e.transition,this.transition),e.now)}untransitioned(){return new Wt(this.property,this.value,null,{},0)}}class pr{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues)}getValue(e){return Er(this._values[e].value.value)}setValue(e,r){this._values.hasOwnProperty(e)||(this._values[e]=new oi(this._values[e].property)),this._values[e].value=new vt(this._values[e].property,r===null?void 0:Er(r))}getTransition(e){return Er(this._values[e].transition)}setTransition(e,r){this._values.hasOwnProperty(e)||(this._values[e]=new oi(this._values[e].property)),this._values[e].transition=Er(r)||void 0}serialize(){const e={};for(const r of Object.keys(this._values)){const s=this.getValue(r);s!==void 0&&(e[r]=s);const h=this.getTransition(r);h!==void 0&&(e[`${r}-transition`]=h)}return e}transitioned(e,r){const s=new fr(this._properties);for(const h of Object.keys(this._values))s._values[h]=this._values[h].transitioned(e,r._values[h]);return s}untransitioned(){const e=new fr(this._properties);for(const r of Object.keys(this._values))e._values[r]=this._values[r].untransitioned();return e}}class Wt{constructor(e,r,s,h,u){const f=h.delay||0,g=h.duration||0;u=u||0,this.property=e,this.value=r,this.begin=u+f,this.end=this.begin+g,e.specification.transition&&(h.delay||h.duration)&&(this.prior=s)}possiblyEvaluate(e,r,s){const h=e.now||0,u=this.value.possiblyEvaluate(e,r,s),f=this.prior;if(f){if(h>this.end)return this.prior=null,u;if(this.value.isDataDriven())return this.prior=null,u;if(h<this.begin)return f.possiblyEvaluate(e,r,s);{const g=(h-this.begin)/(this.end-this.begin);return this.property.interpolate(f.possiblyEvaluate(e,r,s),u,po(g))}}return u}}class fr{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,r,s){const h=new ss(this._properties);for(const u of Object.keys(this._values))h._values[u]=this._values[u].possiblyEvaluate(e,r,s);return h}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Wo{constructor(e){this._properties=e,this._values=Object.create(e.defaultPropertyValues)}getValue(e){return Er(this._values[e].value)}setValue(e,r){this._values[e]=new vt(this._values[e].property,r===null?void 0:Er(r))}serialize(){const e={};for(const r of Object.keys(this._values)){const s=this.getValue(r);s!==void 0&&(e[r]=s)}return e}possiblyEvaluate(e,r,s){const h=new ss(this._properties);for(const u of Object.keys(this._values))h._values[u]=this._values[u].possiblyEvaluate(e,r,s);return h}}class sr{constructor(e,r,s){this.property=e,this.value=r,this.parameters=s}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,r,s,h){return this.property.evaluate(this.value,this.parameters,e,r,s,h)}}class ss{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class Ge{constructor(e){this.specification=e}possiblyEvaluate(e,r){return e.expression.evaluate(r)}interpolate(e,r,s){const h=Fa[this.specification.type];return h?h(e,r,s):e}}class Ye{constructor(e,r){this.specification=e,this.overrides=r}possiblyEvaluate(e,r,s,h){return new sr(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(r,null,{},s,h)}:e.expression,r)}interpolate(e,r,s){if(e.value.kind!=="constant"||r.value.kind!=="constant")return e;if(e.value.value===void 0||r.value.value===void 0)return new sr(this,{kind:"constant",value:void 0},e.parameters);const h=Fa[this.specification.type];return h?new sr(this,{kind:"constant",value:h(e.value.value,r.value.value,s)},e.parameters):e}evaluate(e,r,s,h,u,f){return e.kind==="constant"?e.value:e.evaluate(r,s,h,u,f)}}class Ii extends Ye{possiblyEvaluate(e,r,s,h){if(e.value===void 0)return new sr(this,{kind:"constant",value:void 0},r);if(e.expression.kind==="constant"){const u=e.expression.evaluate(r,null,{},s,h),f=e.property.specification.type==="resolvedImage"&&typeof u!="string"?u.name:u,g=this._calculate(f,f,f,r);return new sr(this,{kind:"constant",value:g},r)}if(e.expression.kind==="camera"){const u=this._calculate(e.expression.evaluate({zoom:r.zoom-1}),e.expression.evaluate({zoom:r.zoom}),e.expression.evaluate({zoom:r.zoom+1}),r);return new sr(this,{kind:"constant",value:u},r)}return new sr(this,e.expression,r)}evaluate(e,r,s,h,u,f){if(e.kind==="source"){const g=e.evaluate(r,s,h,u,f);return this._calculate(g,g,g,r)}return e.kind==="composite"?this._calculate(e.evaluate({zoom:Math.floor(r.zoom)-1},s,h),e.evaluate({zoom:Math.floor(r.zoom)},s,h),e.evaluate({zoom:Math.floor(r.zoom)+1},s,h),r):e.value}_calculate(e,r,s,h){return h.zoom>h.zoomHistory.lastIntegerZoom?{from:e,to:r,other:s}:{from:s,to:r,other:e}}interpolate(e){return e}}class os{constructor(e){this.specification=e}possiblyEvaluate(e,r,s,h){if(e.value!==void 0){if(e.expression.kind==="constant"){const u=e.expression.evaluate(r,null,{},s,h);return this._calculate(u,u,u,r)}return this._calculate(e.expression.evaluate(new ot(Math.floor(r.zoom-1),r)),e.expression.evaluate(new ot(Math.floor(r.zoom),r)),e.expression.evaluate(new ot(Math.floor(r.zoom+1),r)),r)}}_calculate(e,r,s,h){return h.zoom>h.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:s,to:r}}interpolate(e){return e}}class Vn{constructor(e){this.specification=e}possiblyEvaluate(e,r,s,h){return!!e.expression.evaluate(r,null,{},s,h)}interpolate(){return!1}}class Fi{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const r in e){const s=e[r];s.specification.overridable&&this.overridableProperties.push(r);const h=this.defaultPropertyValues[r]=new vt(s,void 0),u=this.defaultTransitionablePropertyValues[r]=new oi(s);this.defaultTransitioningPropertyValues[r]=u.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=h.possiblyEvaluate({})}}}function n_(t,e){return 256*(t=Ft(Math.floor(t),0,255))+Ft(Math.floor(e),0,255)}je("DataDrivenProperty",Ye),je("DataConstantProperty",Ge),je("CrossFadedDataDrivenProperty",Ii),je("CrossFadedProperty",os),je("ColorRampProperty",Vn);const b0={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Sc{constructor(e,r){this._structArray=e,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class mi{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,r){return e._trim(),r&&(e.isTransferred=!0,r.push(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const r=Object.create(this.prototype);return r.arrayBuffer=e.arrayBuffer,r.length=e.length,r.capacity=e.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function ni(t,e=1){let r=0,s=0;return{members:t.map(h=>{const u=b0[h.type].BYTES_PER_ELEMENT,f=r=s_(r,Math.max(e,u)),g=h.components||1;return s=Math.max(s,u),r+=u*g,{name:h.name,type:h.type,components:g,offset:f}}),size:s_(r,Math.max(s,e)),alignment:e}}function s_(t,e){return Math.ceil(t/e)*e}class sl extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r){const s=this.length;return this.resize(s+1),this.emplace(s,e,r)}emplace(e,r,s){const h=2*e;return this.int16[h+0]=r,this.int16[h+1]=s,e}}sl.prototype.bytesPerElement=4,je("StructArrayLayout2i4",sl);class ol extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,s,h){const u=this.length;return this.resize(u+1),this.emplace(u,e,r,s,h)}emplace(e,r,s,h,u){const f=4*e;return this.int16[f+0]=r,this.int16[f+1]=s,this.int16[f+2]=h,this.int16[f+3]=u,e}}ol.prototype.bytesPerElement=8,je("StructArrayLayout4i8",ol);class cp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,s,h,u,f,g){const x=this.length;return this.resize(x+1),this.emplace(x,e,r,s,h,u,f,g)}emplace(e,r,s,h,u,f,g,x){const w=6*e,E=12*e,I=3*e;return this.int16[w+0]=r,this.int16[w+1]=s,this.uint8[E+4]=h,this.uint8[E+5]=u,this.uint8[E+6]=f,this.uint8[E+7]=g,this.float32[I+2]=x,e}}cp.prototype.bytesPerElement=12,je("StructArrayLayout2i4ub1f12",cp);class al extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,s){const h=this.length;return this.resize(h+1),this.emplace(h,e,r,s)}emplace(e,r,s,h){const u=3*e;return this.float32[u+0]=r,this.float32[u+1]=s,this.float32[u+2]=h,e}}al.prototype.bytesPerElement=12,je("StructArrayLayout3f12",al);class Zs extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,s,h,u,f,g,x,w,E){const I=this.length;return this.resize(I+1),this.emplace(I,e,r,s,h,u,f,g,x,w,E)}emplace(e,r,s,h,u,f,g,x,w,E,I){const A=10*e;return this.uint16[A+0]=r,this.uint16[A+1]=s,this.uint16[A+2]=h,this.uint16[A+3]=u,this.uint16[A+4]=f,this.uint16[A+5]=g,this.uint16[A+6]=x,this.uint16[A+7]=w,this.uint16[A+8]=E,this.uint16[A+9]=I,e}}Zs.prototype.bytesPerElement=20,je("StructArrayLayout10ui20",Zs);class _u extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,s,h,u,f,g,x){const w=this.length;return this.resize(w+1),this.emplace(w,e,r,s,h,u,f,g,x)}emplace(e,r,s,h,u,f,g,x,w){const E=8*e;return this.uint16[E+0]=r,this.uint16[E+1]=s,this.uint16[E+2]=h,this.uint16[E+3]=u,this.uint16[E+4]=f,this.uint16[E+5]=g,this.uint16[E+6]=x,this.uint16[E+7]=w,e}}_u.prototype.bytesPerElement=16,je("StructArrayLayout8ui16",_u);class hp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,s,h,u,f,g,x,w,E,I,A,z,R,O,U){const Z=this.length;return this.resize(Z+1),this.emplace(Z,e,r,s,h,u,f,g,x,w,E,I,A,z,R,O,U)}emplace(e,r,s,h,u,f,g,x,w,E,I,A,z,R,O,U,Z){const Q=16*e;return this.int16[Q+0]=r,this.int16[Q+1]=s,this.int16[Q+2]=h,this.int16[Q+3]=u,this.uint16[Q+4]=f,this.uint16[Q+5]=g,this.uint16[Q+6]=x,this.uint16[Q+7]=w,this.int16[Q+8]=E,this.int16[Q+9]=I,this.int16[Q+10]=A,this.int16[Q+11]=z,this.int16[Q+12]=R,this.int16[Q+13]=O,this.int16[Q+14]=U,this.int16[Q+15]=Z,e}}hp.prototype.bytesPerElement=32,je("StructArrayLayout4i4ui4i4i32",hp);class up extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint32[1*e+0]=r,e}}up.prototype.bytesPerElement=4,je("StructArrayLayout1ul4",up);class dp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,s,h,u,f,g,x,w,E,I,A,z){const R=this.length;return this.resize(R+1),this.emplace(R,e,r,s,h,u,f,g,x,w,E,I,A,z)}emplace(e,r,s,h,u,f,g,x,w,E,I,A,z,R){const O=20*e,U=10*e;return this.int16[O+0]=r,this.int16[O+1]=s,this.int16[O+2]=h,this.int16[O+3]=u,this.int16[O+4]=f,this.float32[U+3]=g,this.float32[U+4]=x,this.float32[U+5]=w,this.float32[U+6]=E,this.int16[O+14]=I,this.uint32[U+8]=A,this.uint16[O+18]=z,this.uint16[O+19]=R,e}}dp.prototype.bytesPerElement=40,je("StructArrayLayout5i4f1i1ul2ui40",dp);class gu extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,s,h,u,f,g){const x=this.length;return this.resize(x+1),this.emplace(x,e,r,s,h,u,f,g)}emplace(e,r,s,h,u,f,g,x){const w=8*e;return this.int16[w+0]=r,this.int16[w+1]=s,this.int16[w+2]=h,this.int16[w+4]=u,this.int16[w+5]=f,this.int16[w+6]=g,this.int16[w+7]=x,e}}gu.prototype.bytesPerElement=16,je("StructArrayLayout3i2i2i16",gu);class pp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,s,h,u){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,s,h,u)}emplace(e,r,s,h,u,f){const g=4*e,x=8*e;return this.float32[g+0]=r,this.float32[g+1]=s,this.float32[g+2]=h,this.int16[x+6]=u,this.int16[x+7]=f,e}}pp.prototype.bytesPerElement=16,je("StructArrayLayout2f1f2i16",pp);class fp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,s,h){const u=this.length;return this.resize(u+1),this.emplace(u,e,r,s,h)}emplace(e,r,s,h,u){const f=12*e,g=3*e;return this.uint8[f+0]=r,this.uint8[f+1]=s,this.float32[g+1]=h,this.float32[g+2]=u,e}}fp.prototype.bytesPerElement=12,je("StructArrayLayout2ub2f12",fp);class Gr extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,s){const h=this.length;return this.resize(h+1),this.emplace(h,e,r,s)}emplace(e,r,s,h){const u=3*e;return this.uint16[u+0]=r,this.uint16[u+1]=s,this.uint16[u+2]=h,e}}Gr.prototype.bytesPerElement=6,je("StructArrayLayout3ui6",Gr);class mp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,r,s,h,u,f,g,x,w,E,I,A,z,R,O,U,Z,Q,ne,oe,ae){const le=this.length;return this.resize(le+1),this.emplace(le,e,r,s,h,u,f,g,x,w,E,I,A,z,R,O,U,Z,Q,ne,oe,ae)}emplace(e,r,s,h,u,f,g,x,w,E,I,A,z,R,O,U,Z,Q,ne,oe,ae,le){const we=30*e,ve=15*e,Fe=60*e;return this.int16[we+0]=r,this.int16[we+1]=s,this.int16[we+2]=h,this.float32[ve+2]=u,this.float32[ve+3]=f,this.uint16[we+8]=g,this.uint16[we+9]=x,this.uint32[ve+5]=w,this.uint32[ve+6]=E,this.uint32[ve+7]=I,this.uint16[we+16]=A,this.uint16[we+17]=z,this.uint16[we+18]=R,this.float32[ve+10]=O,this.float32[ve+11]=U,this.uint8[Fe+48]=Z,this.uint8[Fe+49]=Q,this.uint8[Fe+50]=ne,this.uint32[ve+13]=oe,this.int16[we+28]=ae,this.uint8[Fe+58]=le,e}}mp.prototype.bytesPerElement=60,je("StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60",mp);class _p extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,r,s,h,u,f,g,x,w,E,I,A,z,R,O,U,Z,Q,ne,oe,ae,le,we,ve,Fe,Pe,be,Le,Oe,Ie){const Ve=this.length;return this.resize(Ve+1),this.emplace(Ve,e,r,s,h,u,f,g,x,w,E,I,A,z,R,O,U,Z,Q,ne,oe,ae,le,we,ve,Fe,Pe,be,Le,Oe,Ie)}emplace(e,r,s,h,u,f,g,x,w,E,I,A,z,R,O,U,Z,Q,ne,oe,ae,le,we,ve,Fe,Pe,be,Le,Oe,Ie,Ve){const qe=38*e,wt=19*e;return this.int16[qe+0]=r,this.int16[qe+1]=s,this.int16[qe+2]=h,this.float32[wt+2]=u,this.float32[wt+3]=f,this.int16[qe+8]=g,this.int16[qe+9]=x,this.int16[qe+10]=w,this.int16[qe+11]=E,this.int16[qe+12]=I,this.int16[qe+13]=A,this.uint16[qe+14]=z,this.uint16[qe+15]=R,this.uint16[qe+16]=O,this.uint16[qe+17]=U,this.uint16[qe+18]=Z,this.uint16[qe+19]=Q,this.uint16[qe+20]=ne,this.uint16[qe+21]=oe,this.uint16[qe+22]=ae,this.uint16[qe+23]=le,this.uint16[qe+24]=we,this.uint16[qe+25]=ve,this.uint16[qe+26]=Fe,this.uint16[qe+27]=Pe,this.uint16[qe+28]=be,this.uint32[wt+15]=Le,this.float32[wt+16]=Oe,this.float32[wt+17]=Ie,this.float32[wt+18]=Ve,e}}_p.prototype.bytesPerElement=76,je("StructArrayLayout3i2f6i15ui1ul3f76",_p);class yu extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.float32[1*e+0]=r,e}}yu.prototype.bytesPerElement=4,je("StructArrayLayout1f4",yu);class gp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,s){const h=this.length;return this.resize(h+1),this.emplace(h,e,r,s)}emplace(e,r,s,h){const u=3*e;return this.int16[u+0]=r,this.int16[u+1]=s,this.int16[u+2]=h,e}}gp.prototype.bytesPerElement=6,je("StructArrayLayout3i6",gp);class Ic extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,s,h,u,f,g){const x=this.length;return this.resize(x+1),this.emplace(x,e,r,s,h,u,f,g)}emplace(e,r,s,h,u,f,g,x){const w=7*e;return this.float32[w+0]=r,this.float32[w+1]=s,this.float32[w+2]=h,this.float32[w+3]=u,this.float32[w+4]=f,this.float32[w+5]=g,this.float32[w+6]=x,e}}Ic.prototype.bytesPerElement=28,je("StructArrayLayout7f28",Ic);class yp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,s,h){const u=this.length;return this.resize(u+1),this.emplace(u,e,r,s,h)}emplace(e,r,s,h,u){const f=6*e;return this.uint32[3*e+0]=r,this.uint16[f+2]=s,this.uint16[f+3]=h,this.uint16[f+4]=u,e}}yp.prototype.bytesPerElement=12,je("StructArrayLayout1ul3ui12",yp);class Ws extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r){const s=this.length;return this.resize(s+1),this.emplace(s,e,r)}emplace(e,r,s){const h=2*e;return this.uint16[h+0]=r,this.uint16[h+1]=s,e}}Ws.prototype.bytesPerElement=4,je("StructArrayLayout2ui4",Ws);class xu extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint16[1*e+0]=r,e}}xu.prototype.bytesPerElement=2,je("StructArrayLayout1ui2",xu);class vu extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r){const s=this.length;return this.resize(s+1),this.emplace(s,e,r)}emplace(e,r,s){const h=2*e;return this.float32[h+0]=r,this.float32[h+1]=s,e}}vu.prototype.bytesPerElement=8,je("StructArrayLayout2f8",vu);class xp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,s,h){const u=this.length;return this.resize(u+1),this.emplace(u,e,r,s,h)}emplace(e,r,s,h,u){const f=4*e;return this.float32[f+0]=r,this.float32[f+1]=s,this.float32[f+2]=h,this.float32[f+3]=u,e}}xp.prototype.bytesPerElement=16,je("StructArrayLayout4f16",xp);class o_ extends Sc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}o_.prototype.size=40;class vp extends dp{get(e){return new o_(this,e)}}je("CollisionBoxArray",vp);class a_ extends Sc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}a_.prototype.size=60;class l_ extends mp{get(e){return new a_(this,e)}}je("PlacedSymbolArray",l_);class c_ extends Sc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(e){this._structArray.uint32[this._pos4+15]=e}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}}c_.prototype.size=76;class h_ extends _p{get(e){return new c_(this,e)}}je("SymbolInstanceArray",h_);class u_ extends yu{getoffsetX(e){return this.float32[1*e+0]}}je("GlyphOffsetArray",u_);class d_ extends gp{getx(e){return this.int16[3*e+0]}gety(e){return this.int16[3*e+1]}gettileUnitDistanceFromAnchor(e){return this.int16[3*e+2]}}je("SymbolLineVertexArray",d_);class p_ extends Sc{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}p_.prototype.size=12;class f_ extends yp{get(e){return new p_(this,e)}}je("FeatureIndexArray",f_);class m_ extends Sc{get a_centroid_pos0(){return this._structArray.uint16[this._pos2+0]}get a_centroid_pos1(){return this._structArray.uint16[this._pos2+1]}}m_.prototype.size=4;class __ extends Ws{get(e){return new m_(this,e)}}je("FillExtrusionCentroidArray",__);const w0=ni([{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"}]),T0=ni([{name:"a_dash_to",components:4,type:"Uint16"},{name:"a_dash_from",components:4,type:"Uint16"}]);var g_=Ls(function(t){t.exports=function(e,r){var s,h,u,f,g,x,w,E;for(h=e.length-(s=3&e.length),u=r,g=3432918353,x=461845907,E=0;E<h;)w=255&e.charCodeAt(E)|(255&e.charCodeAt(++E))<<8|(255&e.charCodeAt(++E))<<16|(255&e.charCodeAt(++E))<<24,++E,u=27492+(65535&(f=5*(65535&(u=(u^=w=(65535&(w=(w=(65535&w)*g+(((w>>>16)*g&65535)<<16)&4294967295)<<15|w>>>17))*x+(((w>>>16)*x&65535)<<16)&4294967295)<<13|u>>>19))+((5*(u>>>16)&65535)<<16)&4294967295))+((58964+(f>>>16)&65535)<<16);switch(w=0,s){case 3:w^=(255&e.charCodeAt(E+2))<<16;case 2:w^=(255&e.charCodeAt(E+1))<<8;case 1:u^=w=(65535&(w=(w=(65535&(w^=255&e.charCodeAt(E)))*g+(((w>>>16)*g&65535)<<16)&4294967295)<<15|w>>>17))*x+(((w>>>16)*x&65535)<<16)&4294967295}return u^=e.length,u=2246822507*(65535&(u^=u>>>16))+((2246822507*(u>>>16)&65535)<<16)&4294967295,u=3266489909*(65535&(u^=u>>>13))+((3266489909*(u>>>16)&65535)<<16)&4294967295,(u^=u>>>16)>>>0}}),E0=Ls(function(t){t.exports=function(e,r){for(var s,h=e.length,u=r^h,f=0;h>=4;)s=1540483477*(65535&(s=255&e.charCodeAt(f)|(255&e.charCodeAt(++f))<<8|(255&e.charCodeAt(++f))<<16|(255&e.charCodeAt(++f))<<24))+((1540483477*(s>>>16)&65535)<<16),u=1540483477*(65535&u)+((1540483477*(u>>>16)&65535)<<16)^(s=1540483477*(65535&(s^=s>>>24))+((1540483477*(s>>>16)&65535)<<16)),h-=4,++f;switch(h){case 3:u^=(255&e.charCodeAt(f+2))<<16;case 2:u^=(255&e.charCodeAt(f+1))<<8;case 1:u=1540483477*(65535&(u^=255&e.charCodeAt(f)))+((1540483477*(u>>>16)&65535)<<16)}return u=1540483477*(65535&(u^=u>>>13))+((1540483477*(u>>>16)&65535)<<16),(u^=u>>>15)>>>0}}),Ac=g_,S0=E0;Ac.murmur3=g_,Ac.murmur2=S0;class bu{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(e,r,s,h){this.ids.push(y_(e)),this.positions.push(r,s,h)}getPositions(e){const r=y_(e);let s=0,h=this.ids.length-1;for(;s<h;){const f=s+h>>1;this.ids[f]>=r?h=f:s=f+1}const u=[];for(;this.ids[s]===r;)u.push({index:this.positions[3*s],start:this.positions[3*s+1],end:this.positions[3*s+2]}),s++;return u}static serialize(e,r){const s=new Float64Array(e.ids),h=new Uint32Array(e.positions);return bp(s,h,0,s.length-1),r&&r.push(s.buffer,h.buffer),{ids:s,positions:h}}static deserialize(e){const r=new bu;return r.ids=e.ids,r.positions=e.positions,r.indexed=!0,r}}function y_(t){const e=+t;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Ac(String(t))}function bp(t,e,r,s){for(;r<s;){const h=t[r+s>>1];let u=r-1,f=s+1;for(;;){do u++;while(t[u]<h);do f--;while(t[f]>h);if(u>=f)break;wu(t,u,f),wu(e,3*u,3*f),wu(e,3*u+1,3*f+1),wu(e,3*u+2,3*f+2)}f-r<s-f?(bp(t,e,r,f),r=f+1):(bp(t,e,f+1,s),s=f)}}function wu(t,e,r){const s=t[e];t[e]=t[r],t[r]=s}je("FeaturePositionMap",bu);class as{constructor(e,r){this.gl=e.gl,this.location=r}}class Tu extends as{constructor(e,r){super(e,r),this.current=0}set(e){this.current!==e&&(this.current=e,this.gl.uniform1f(this.location,e))}}class x_ extends as{constructor(e,r){super(e,r),this.current=[0,0,0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]&&e[3]===this.current[3]||(this.current=e,this.gl.uniform4f(this.location,e[0],e[1],e[2],e[3]))}}class v_ extends as{constructor(e,r){super(e,r),this.current=At.transparent}set(e){e.r===this.current.r&&e.g===this.current.g&&e.b===this.current.b&&e.a===this.current.a||(this.current=e,this.gl.uniform4f(this.location,e.r,e.g,e.b,e.a))}}const I0=new Float32Array(16),A0=new Float32Array(9),C0=new Float32Array(4);function wp(t){return[n_(255*t.r,255*t.g),n_(255*t.b,255*t.a)]}class Cc{constructor(e,r,s){this.value=e,this.uniformNames=r.map(h=>`u_${h}`),this.type=s}setUniform(e,r,s){e.set(s.constantOr(this.value))}getBinding(e,r,s){return this.type==="color"?new v_(e,r):new Tu(e,r)}}class ll{constructor(e,r){this.uniformNames=r.map(s=>`u_${s}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(e,r){this.pixelRatioFrom=r.pixelRatio,this.pixelRatioTo=e.pixelRatio,this.patternFrom=r.tl.concat(r.br),this.patternTo=e.tl.concat(e.br)}setUniform(e,r,s,h){const u=h==="u_pattern_to"||h==="u_dash_to"?this.patternTo:h==="u_pattern_from"||h==="u_dash_from"?this.patternFrom:h==="u_pixel_ratio_to"?this.pixelRatioTo:h==="u_pixel_ratio_from"?this.pixelRatioFrom:null;u&&e.set(u)}getBinding(e,r,s){return s==="u_pattern_from"||s==="u_pattern_to"||s==="u_dash_from"||s==="u_dash_to"?new x_(e,r):new Tu(e,r)}}class ls{constructor(e,r,s,h){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=r.map(u=>({name:`a_${u}`,type:"Float32",components:s==="color"?2:1,offset:0})),this.paintVertexArray=new h}populatePaintArray(e,r,s,h,u,f){const g=this.paintVertexArray.length,x=this.expression.evaluate(new ot(0),r,{},u,h,f);this.paintVertexArray.resize(e),this._setPaintValue(g,e,x)}updatePaintArray(e,r,s,h,u){const f=this.expression.evaluate({zoom:0},s,h,void 0,u);this._setPaintValue(e,r,f)}_setPaintValue(e,r,s){if(this.type==="color"){const h=wp(s);for(let u=e;u<r;u++)this.paintVertexArray.emplace(u,h[0],h[1])}else{for(let h=e;h<r;h++)this.paintVertexArray.emplace(h,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class yn{constructor(e,r,s,h,u,f){this.expression=e,this.uniformNames=r.map(g=>`u_${g}_t`),this.type=s,this.useIntegerZoom=h,this.zoom=u,this.maxValue=0,this.paintVertexAttributes=r.map(g=>({name:`a_${g}`,type:"Float32",components:s==="color"?4:2,offset:0})),this.paintVertexArray=new f}populatePaintArray(e,r,s,h,u,f){const g=this.expression.evaluate(new ot(this.zoom),r,{},u,h,f),x=this.expression.evaluate(new ot(this.zoom+1),r,{},u,h,f),w=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(w,e,g,x)}updatePaintArray(e,r,s,h,u){const f=this.expression.evaluate({zoom:this.zoom},s,h,void 0,u),g=this.expression.evaluate({zoom:this.zoom+1},s,h,void 0,u);this._setPaintValue(e,r,f,g)}_setPaintValue(e,r,s,h){if(this.type==="color"){const u=wp(s),f=wp(h);for(let g=e;g<r;g++)this.paintVertexArray.emplace(g,u[0],u[1],f[0],f[1])}else{for(let u=e;u<r;u++)this.paintVertexArray.emplace(u,s,h);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(h))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,r){const s=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,h=Ft(this.expression.interpolationFactor(s,this.zoom,this.zoom+1),0,1);e.set(h)}getBinding(e,r,s){return new Tu(e,r)}}class Xs{constructor(e,r,s,h,u,f,g){this.expression=e,this.type=s,this.useIntegerZoom=h,this.zoom=u,this.layerId=g,this.paintVertexAttributes=(s==="array"?T0:w0).members;for(let x=0;x<r.length;++x);this.zoomInPaintVertexArray=new f,this.zoomOutPaintVertexArray=new f}populatePaintArray(e,r,s){const h=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(e),this.zoomOutPaintVertexArray.resize(e),this._setPaintValues(h,e,r.patterns&&r.patterns[this.layerId],s)}updatePaintArray(e,r,s,h,u,f){this._setPaintValues(e,r,s.patterns&&s.patterns[this.layerId],f)}_setPaintValues(e,r,s,h){if(!h||!s)return;const{min:u,mid:f,max:g}=s,x=h[u],w=h[f],E=h[g];if(x&&w&&E)for(let I=e;I<r;I++)this._setPaintValue(this.zoomInPaintVertexArray,I,w,x),this._setPaintValue(this.zoomOutPaintVertexArray,I,w,E)}_setPaintValue(e,r,s,h){e.emplace(r,s.tl[0],s.tl[1],s.br[0],s.br[1],h.tl[0],h.tl[1],h.br[0],h.br[1],s.pixelRatio,h.pixelRatio)}upload(e){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=e.createVertexBuffer(this.zoomInPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=e.createVertexBuffer(this.zoomOutPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class cs{constructor(e,r,s=()=>!0){this.binders={},this._buffers=[];const h=[];for(const u in e.paint._values){if(!s(u))continue;const f=e.paint.get(u);if(!(f instanceof sr&&Fs(f.property.specification)))continue;const g=k0(u,e.type),x=f.value,w=f.property.specification.type,E=f.property.useIntegerZoom,I=f.property.specification["property-type"],A=I==="cross-faded"||I==="cross-faded-data-driven",z=String(u)==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant";if(x.kind!=="constant"||z)if(x.kind==="source"||z||A){const R=b_(u,w,"source");this.binders[u]=A?new Xs(x,g,w,E,r,R,e.id):new ls(x,g,w,R),h.push(`/a_${u}`)}else{const R=b_(u,w,"composite");this.binders[u]=new yn(x,g,w,E,r,R),h.push(`/z_${u}`)}else this.binders[u]=A?new ll(x.value,g):new Cc(x.value,g,w),h.push(`/u_${u}`)}this.cacheKey=h.sort().join("")}getMaxValue(e){const r=this.binders[e];return r instanceof ls||r instanceof yn?r.maxValue:0}populatePaintArrays(e,r,s,h,u,f){for(const g in this.binders){const x=this.binders[g];(x instanceof ls||x instanceof yn||x instanceof Xs)&&x.populatePaintArray(e,r,s,h,u,f)}}setConstantPatternPositions(e,r){for(const s in this.binders){const h=this.binders[s];h instanceof ll&&h.setConstantPatternPositions(e,r)}}updatePaintArrays(e,r,s,h,u,f){let g=!1;for(const x in e){const w=r.getPositions(x);for(const E of w){const I=s.feature(E.index);for(const A in this.binders){const z=this.binders[A];if((z instanceof ls||z instanceof yn||z instanceof Xs)&&z.expression.isStateDependent===!0){const R=h.paint.get(A);z.expression=R.value,z.updatePaintArray(E.start,E.end,I,e[x],u,f),g=!0}}}}return g}defines(){const e=[];for(const r in this.binders){const s=this.binders[r];(s instanceof Cc||s instanceof ll)&&e.push(...s.uniformNames.map(h=>`#define HAS_UNIFORM_${h}`))}return e}getBinderAttributes(){const e=[];for(const r in this.binders){const s=this.binders[r];if(s instanceof ls||s instanceof yn||s instanceof Xs)for(let h=0;h<s.paintVertexAttributes.length;h++)e.push(s.paintVertexAttributes[h].name)}return e}getBinderUniforms(){const e=[];for(const r in this.binders){const s=this.binders[r];if(s instanceof Cc||s instanceof ll||s instanceof yn)for(const h of s.uniformNames)e.push(h)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e,r){const s=[];for(const h in this.binders){const u=this.binders[h];if(u instanceof Cc||u instanceof ll||u instanceof yn){for(const f of u.uniformNames)if(r[f]){const g=u.getBinding(e,r[f],f);s.push({name:f,property:h,binding:g})}}}return s}setUniforms(e,r,s,h){for(const{name:u,property:f,binding:g}of r)this.binders[f].setUniform(g,h,s.get(f),u)}updatePaintBuffers(e){this._buffers=[];for(const r in this.binders){const s=this.binders[r];if(e&&s instanceof Xs){const h=e.fromScale===2?s.zoomInPaintVertexBuffer:s.zoomOutPaintVertexBuffer;h&&this._buffers.push(h)}else(s instanceof ls||s instanceof yn)&&s.paintVertexBuffer&&this._buffers.push(s.paintVertexBuffer)}}upload(e){for(const r in this.binders){const s=this.binders[r];(s instanceof ls||s instanceof yn||s instanceof Xs)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const r=this.binders[e];(r instanceof ls||r instanceof yn||r instanceof Xs)&&r.destroy()}}}class Xo{constructor(e,r,s=()=>!0){this.programConfigurations={};for(const h of e)this.programConfigurations[h.id]=new cs(h,r,s);this.needsUpload=!1,this._featureMap=new bu,this._bufferOffset=0}populatePaintArrays(e,r,s,h,u,f,g){for(const x in this.programConfigurations)this.programConfigurations[x].populatePaintArrays(e,r,h,u,f,g);r.id!==void 0&&this._featureMap.add(r.id,s,this._bufferOffset,e),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,r,s,h,u){for(const f of s)this.needsUpload=this.programConfigurations[f.id].updatePaintArrays(e,this._featureMap,r,f,h,u)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const M0={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"line-dasharray":["dash_to","dash_from"]};function k0(t,e){return M0[t]||[t.replace(`${e}-`,"").replace(/-/g,"_")]}const D0={"line-pattern":{source:Zs,composite:Zs},"fill-pattern":{source:Zs,composite:Zs},"fill-extrusion-pattern":{source:Zs,composite:Zs},"line-dasharray":{source:_u,composite:_u}},z0={color:{source:vu,composite:xp},number:{source:yu,composite:vu}};function b_(t,e,r){const s=D0[t];return s&&s[r]||z0[e][r]}je("ConstantBinder",Cc),je("CrossFadedConstantBinder",ll),je("SourceExpressionBinder",ls),je("CrossFadedCompositeBinder",Xs),je("CompositeExpressionBinder",yn),je("ProgramConfiguration",cs,{omit:["_buffers"]}),je("ProgramConfigurationSet",Xo);const Eu="-transition";class xn extends Dn{constructor(e,r){if(super(),this.id=e.id,this.type=e.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,e.type!=="custom"&&(this.metadata=(e=e).metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type!=="background"&&e.type!=="sky"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),r.layout&&(this._unevaluatedLayout=new Wo(r.layout)),r.paint)){this._transitionablePaint=new pr(r.paint);for(const s in e.paint)this.setPaintProperty(s,e.paint[s],{validate:!1});for(const s in e.layout)this.setLayoutProperty(s,e.layout[s],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new ss(r.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,r,s={}){r!=null&&this._validate(lp,`layers.${this.id}.layout.${e}`,e,r,s)||(e!=="visibility"?this._unevaluatedLayout.setValue(e,r):this.visibility=r)}getPaintProperty(e){return Ss(e,Eu)?this._transitionablePaint.getTransition(e.slice(0,-Eu.length)):this._transitionablePaint.getValue(e)}setPaintProperty(e,r,s={}){if(r!=null&&this._validate(Ec,`layers.${this.id}.paint.${e}`,e,r,s))return!1;if(Ss(e,Eu))return this._transitionablePaint.setTransition(e.slice(0,-Eu.length),r||void 0),!1;{const h=this._transitionablePaint._values[e],u=h.property.specification["property-type"]==="cross-faded-data-driven",f=h.value.isDataDriven(),g=h.value;this._transitionablePaint.setValue(e,r),this._handleSpecialPaintPropertyUpdate(e);const x=this._transitionablePaint._values[e].value;return x.isDataDriven()||f||u||this._handleOverridablePaintPropertyUpdate(e,g,x)}}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getProgramConfiguration(e){return null}_handleOverridablePaintPropertyUpdate(e,r,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,r){e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,r)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,r)}serialize(){const e={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(e.layout=e.layout||{},e.layout.visibility=this.visibility),Is(e,(r,s)=>!(r===void 0||s==="layout"&&!Object.keys(r).length||s==="paint"&&!Object.keys(r).length))}_validate(e,r,s,h,u={}){return(!u||u.validate!==!1)&&fu(this,e.call(js,{key:r,layerType:this.type,objectKey:s,value:h,styleSpec:ye,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const e in this.paint._values){const r=this.paint.get(e);if(r instanceof sr&&Fs(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=tl(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const P0=ni([{name:"a_pos",components:2,type:"Int16"}],4),{members:L0}=P0;class _i{constructor(e=[]){this.segments=e}prepareSegment(e,r,s,h){let u=this.segments[this.segments.length-1];return e>_i.MAX_VERTEX_ARRAY_LENGTH&&ii(`Max vertices per segment is ${_i.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!u||u.vertexLength+e>_i.MAX_VERTEX_ARRAY_LENGTH||u.sortKey!==h)&&(u={vertexOffset:r.length,primitiveOffset:s.length,vertexLength:0,primitiveLength:0},h!==void 0&&(u.sortKey=h),this.segments.push(u)),u}get(){return this.segments}destroy(){for(const e of this.segments)for(const r in e.vaos)e.vaos[r].destroy()}static simpleSegment(e,r,s,h){return new _i([{vertexOffset:e,primitiveOffset:r,vertexLength:s,primitiveLength:h,vaos:{},sortKey:0}])}}_i.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,je("SegmentVector",_i);var yt=8192;class Ho{constructor(e,r){e&&(r?this.setSouthWest(e).setNorthEast(r):e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof Ot?new Ot(e.lng,e.lat):Ot.convert(e),this}setSouthWest(e){return this._sw=e instanceof Ot?new Ot(e.lng,e.lat):Ot.convert(e),this}extend(e){const r=this._sw,s=this._ne;let h,u;if(e instanceof Ot)h=e,u=e;else{if(!(e instanceof Ho))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(Ho.convert(e)):this.extend(Ot.convert(e)):this;if(h=e._sw,u=e._ne,!h||!u)return this}return r||s?(r.lng=Math.min(h.lng,r.lng),r.lat=Math.min(h.lat,r.lat),s.lng=Math.max(u.lng,s.lng),s.lat=Math.max(u.lat,s.lat)):(this._sw=new Ot(h.lng,h.lat),this._ne=new Ot(u.lng,u.lat)),this}getCenter(){return new Ot((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Ot(this.getWest(),this.getNorth())}getSouthEast(){return new Ot(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:r,lat:s}=Ot.convert(e);let h=this._sw.lng<=r&&r<=this._ne.lng;return this._sw.lng>this._ne.lng&&(h=this._sw.lng>=r&&r>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&h}static convert(e){return!e||e instanceof Ho?e:new Ho(e)}}const w_=63710088e-1;class Ot{constructor(e,r){if(isNaN(e)||isNaN(r))throw new Error(`Invalid LngLat object: (${e}, ${r})`);if(this.lng=+e,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Ot(un(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const r=Math.PI/180,s=this.lat*r,h=e.lat*r,u=Math.sin(s)*Math.sin(h)+Math.cos(s)*Math.cos(h)*Math.cos((e.lng-this.lng)*r);return w_*Math.acos(Math.min(u,1))}toBounds(e=0){const r=360*e/40075017,s=r/Math.cos(Math.PI/180*this.lat);return new Ho(new Ot(this.lng-s,this.lat-r),new Ot(this.lng+s,this.lat+r))}static convert(e){if(e instanceof Ot)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Ot(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Ot(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const T_=2*Math.PI*w_;function E_(t){return T_*Math.cos(t*Math.PI/180)}function cl(t){return(180+t)/360}function hl(t){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t*Math.PI/360)))/360}function vn(t,e){return t/E_(e)}function hs(t){return 360*t-180}function on(t){return 360/Math.PI*Math.atan(Math.exp((180-360*t)*Math.PI/180))-90}function S_(t,e){return t*E_(on(e))}const jn=85.051129;class Su{constructor(e,r,s=0){this.x=+e,this.y=+r,this.z=+s}static fromLngLat(e,r=0){const s=Ot.convert(e);return new Su(cl(s.lng),hl(s.lat),vn(r,s.lat))}toLngLat(){return new Ot(hs(this.x),on(this.y))}toAltitude(){return S_(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/T_*(e=on(this.y),1/Math.cos(e*Math.PI/180));var e}}function Tp(t,e,r,s,h,u,f,g,x){const w=(e+s)/2,E=(r+h)/2,I=new ue(w,E);g(I),function(A,z,R,O,U,Z){const Q=R-U,ne=O-Z;return Math.abs((O-z)*Q-(R-A)*ne)/Math.hypot(Q,ne)}(I.x,I.y,u.x,u.y,f.x,f.y)>=x?(Tp(t,e,r,w,E,u,I,g,x),Tp(t,w,E,s,h,I,f,g,x)):t.push(f)}function R0(t,e,r){const s=[];let h,u,f;for(const g of t){const{x,y:w}=g;e(g),f?Tp(s,h,u,x,w,f,g,e,r):s.push(g),h=x,u=w,f=g}return s}const Ep=Math.pow(2,14)-1,I_=-Ep-1;function B0(t,e){const r=Math.round(t.x*e),s=Math.round(t.y*e);return t.x=Ft(r,I_,Ep),t.y=Ft(s,I_,Ep),(r<t.x||r>t.x+1||s<t.y||s>t.y+1)&&ii("Geometry exceeds allowed extent, reduce your vector tile buffer size"),t}function us(t,e,r){const s=t.loadGeometry(),h=t.extent,u=yt/h;if(e&&r&&r.projection.isReprojectedInTileSpace){const f=1<<e.z,{scale:g,x,y:w,projection:E}=r,I=A=>{const z=hs((e.x+A.x/h)/f),R=on((e.y+A.y/h)/f),O=E.project(z,R);A.x=(O.x*g-x)*h,A.y=(O.y*g-w)*h};for(let A=0;A<s.length;A++)if(t.type!==1)s[A]=R0(s[A],I,1);else{const z=[];for(const R of s[A])R.x<0||R.x>=h||R.y<0||R.y>=h||(I(R),z.push(R));s[A]=z}}for(const f of s)for(const g of f)B0(g,u);return s}function Ko(t,e){return{type:t.type,id:t.id,properties:t.properties,geometry:e?us(t):[]}}function Iu(t,e,r,s,h){t.emplaceBack(2*e+(s+1)/2,2*r+(h+1)/2)}class Sp{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new sl,this.indexArray=new Gr,this.segments=new _i,this.programConfigurations=new Xo(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,s,h){const u=this.layers[0],f=[];let g=null;u.type==="circle"&&(g=u.layout.get("circle-sort-key"));for(const{feature:x,id:w,index:E,sourceLayerIndex:I}of e){const A=this.layers[0]._featureFilter.needGeometry,z=Ko(x,A);if(!this.layers[0]._featureFilter.filter(new ot(this.zoom),z,s))continue;const R=g?g.evaluate(z,{},s):void 0,O={id:w,properties:x.properties,type:x.type,sourceLayerIndex:I,index:E,geometry:A?z.geometry:us(x,s,h),patterns:{},sortKey:R};f.push(O)}g&&f.sort((x,w)=>x.sortKey-w.sortKey);for(const x of f){const{geometry:w,index:E,sourceLayerIndex:I}=x,A=e[E].feature;this.addFeature(x,w,E,r.availableImages,s),r.featureIndex.insert(A,w,E,I,this.index)}}update(e,r,s,h){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,s,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,L0),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,r,s,h,u){for(const f of r)for(const g of f){const x=g.x,w=g.y;if(x<0||x>=yt||w<0||w>=yt)continue;const E=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),I=E.vertexLength;Iu(this.layoutVertexArray,x,w,-1,-1),Iu(this.layoutVertexArray,x,w,1,-1),Iu(this.layoutVertexArray,x,w,1,1),Iu(this.layoutVertexArray,x,w,-1,1),this.indexArray.emplaceBack(I,I+1,I+2),this.indexArray.emplaceBack(I,I+3,I+2),E.vertexLength+=4,E.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},h,u)}}function A_(t,e){for(let r=0;r<t.length;r++)if(ul(e,t[r]))return!0;for(let r=0;r<e.length;r++)if(ul(t,e[r]))return!0;return!!Ip(t,e)}function F0(t,e,r){return!!ul(t,e)||!!Ap(e,t,r)}function C_(t,e){if(t.length===1)return k_(e,t[0]);for(let r=0;r<e.length;r++){const s=e[r];for(let h=0;h<s.length;h++)if(ul(t,s[h]))return!0}for(let r=0;r<t.length;r++)if(k_(e,t[r]))return!0;for(let r=0;r<e.length;r++)if(Ip(t,e[r]))return!0;return!1}function O0(t,e,r){if(t.length>1){if(Ip(t,e))return!0;for(let s=0;s<e.length;s++)if(Ap(e[s],t,r))return!0}for(let s=0;s<t.length;s++)if(Ap(t[s],e,r))return!0;return!1}function Ip(t,e){if(t.length===0||e.length===0)return!1;for(let r=0;r<t.length-1;r++){const s=t[r],h=t[r+1];for(let u=0;u<e.length-1;u++)if(N0(s,h,e[u],e[u+1]))return!0}return!1}function N0(t,e,r,s){return Sr(t,r,s)!==Sr(e,r,s)&&Sr(t,e,r)!==Sr(t,e,s)}function Ap(t,e,r){const s=r*r;if(e.length===1)return t.distSqr(e[0])<s;for(let h=1;h<e.length;h++)if(M_(t,e[h-1],e[h])<s)return!0;return!1}function M_(t,e,r){const s=e.distSqr(r);if(s===0)return t.distSqr(e);const h=((t.x-e.x)*(r.x-e.x)+(t.y-e.y)*(r.y-e.y))/s;return t.distSqr(h<0?e:h>1?r:r.sub(e)._mult(h)._add(e))}function k_(t,e){let r,s,h,u=!1;for(let f=0;f<t.length;f++){r=t[f];for(let g=0,x=r.length-1;g<r.length;x=g++)s=r[g],h=r[x],s.y>e.y!=h.y>e.y&&e.x<(h.x-s.x)*(e.y-s.y)/(h.y-s.y)+s.x&&(u=!u)}return u}function ul(t,e){let r=!1;for(let s=0,h=t.length-1;s<t.length;h=s++){const u=t[s],f=t[h];u.y>e.y!=f.y>e.y&&e.x<(f.x-u.x)*(e.y-u.y)/(f.y-u.y)+u.x&&(r=!r)}return r}function D_(t,e,r,s,h){for(const f of t)if(e<=f.x&&r<=f.y&&s>=f.x&&h>=f.y)return!0;const u=[new ue(e,r),new ue(e,h),new ue(s,h),new ue(s,r)];if(t.length>2){for(const f of u)if(ul(t,f))return!0}for(let f=0;f<t.length-1;f++)if(U0(t[f],t[f+1],u))return!0;return!1}function U0(t,e,r){const s=r[0],h=r[2];if(t.x<s.x&&e.x<s.x||t.x>h.x&&e.x>h.x||t.y<s.y&&e.y<s.y||t.y>h.y&&e.y>h.y)return!1;const u=Sr(t,e,r[0]);return u!==Sr(t,e,r[1])||u!==Sr(t,e,r[2])||u!==Sr(t,e,r[3])}function dl(t,e,r){const s=e.paint.get(t).value;return s.kind==="constant"?s.value:r.programConfigurations.get(e.id).getMaxValue(t)}function Au(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function z_(t,e,r,s,h){if(!e[0]&&!e[1])return t;const u=ue.convert(e)._mult(h);r==="viewport"&&u._rotate(-s);const f=[];for(let g=0;g<t.length;g++)f.push(t[g].sub(u));return f}function P_(t,e,r,s){const h=ue.convert(t)._mult(s);return e==="viewport"&&h._rotate(-r),h}je("CircleBucket",Sp,{omit:["layers"]});const V0=new Fi({"circle-sort-key":new Ye(ye.layout_circle["circle-sort-key"])});var j0={paint:new Fi({"circle-radius":new Ye(ye.paint_circle["circle-radius"]),"circle-color":new Ye(ye.paint_circle["circle-color"]),"circle-blur":new Ye(ye.paint_circle["circle-blur"]),"circle-opacity":new Ye(ye.paint_circle["circle-opacity"]),"circle-translate":new Ge(ye.paint_circle["circle-translate"]),"circle-translate-anchor":new Ge(ye.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ge(ye.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ge(ye.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ye(ye.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ye(ye.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ye(ye.paint_circle["circle-stroke-opacity"])}),layout:V0};class Cp{constructor(e,r){this.points=e,this.planes=r}static fromInvProjectionMatrix(e,r,s,h){const u=Math.pow(2,s),f=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(x=>{const w=Yr([],x,e),E=1/w[3]/r*u;return function(I,A,z){return I[0]=A[0]*z[0],I[1]=A[1]*z[1],I[2]=A[2]*z[2],I[3]=A[3]*z[3],I}(w,w,[E,E,h?1/w[3]:E,E])}),g=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(x=>{const w=xs([],vs([],Jn([],f[x[0]],f[x[1]]),Jn([],f[x[2]],f[x[1]]))),E=-Kr(w,f[x[1]]);return w.concat(E)});return new Cp(f,g)}}class bn{constructor(e,r){this.min=e,this.max=r,this.center=Hr([],co([],this.min,this.max),.5)}quadrant(e){const r=[e%2==0,e<2],s=Kn(this.min),h=Kn(this.max);for(let u=0;u<r.length;u++)s[u]=r[u]?this.min[u]:this.center[u],h[u]=r[u]?this.center[u]:this.max[u];return h[2]=this.max[2],new bn(s,h)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,r=this.max;return[[e[0],e[1],e[2]],[r[0],e[1],e[2]],[r[0],r[1],e[2]],[e[0],r[1],e[2]],[e[0],e[1],r[2]],[r[0],e[1],r[2]],[r[0],r[1],r[2]],[e[0],r[1],r[2]]]}intersects(e){const r=this.getCorners();let s=!0;for(let h=0;h<e.planes.length;h++){const u=e.planes[h];let f=0;for(let g=0;g<r.length;g++)f+=Kr(u,r[g])+u[3]>=0;if(f===0)return 0;f!==r.length&&(s=!1)}if(s)return 2;for(let h=0;h<3;h++){let u=Number.MAX_VALUE,f=-Number.MAX_VALUE;for(let g=0;g<e.points.length;g++){const x=e.points[g][h]-this.min[h];u=Math.min(u,x),f=Math.max(f,x)}if(f<0||u>this.max[h]-this.min[h])return 0}return 1}}function L_(t,e,r,s,h,u,f,g,x){if(u&&t.queryGeometry.isAboveHorizon)return!1;u&&(x*=t.pixelToTileUnitsFactor);for(const w of e)for(const E of w){const I=E.add(g),A=h&&r.elevation?r.elevation.exaggeration()*h.getElevationAt(I.x,I.y,!0):0,z=u?I:$0(I,A,s),R=u?t.tilespaceRays.map(U=>q0(U,A)):t.queryGeometry.screenGeometry,O=Yr([],[E.x,E.y,A,1],s);if(!f&&u?x*=O[3]/r.cameraToCenterDistance:f&&!u&&(x*=r.cameraToCenterDistance/O[3]),F0(R,z,x))return!0}return!1}function $0(t,e,r){const s=Yr([],[t.x,t.y,e,1],r);return new ue(s[0]/s[3],s[1]/s[3])}const R_=hn(0,0,0),G0=hn(0,0,1);function q0(t,e){const r=lo();return R_[2]=e,t.intersectsPlane(R_,G0,r),new ue(r[0],r[1])}class B_ extends Sp{}function Mp(t,{width:e,height:r},s,h){if(h){if(h instanceof Uint8ClampedArray)h=new Uint8Array(h.buffer);else if(h.length!==e*r*s)throw new RangeError("mismatched image size")}else h=new Uint8Array(e*r*s);return t.width=e,t.height=r,t.data=h,t}function F_(t,{width:e,height:r},s){if(e===t.width&&r===t.height)return;const h=Mp({},{width:e,height:r},s);kp(t,h,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,e),height:Math.min(t.height,r)},s),t.width=e,t.height=r,t.data=h.data}function kp(t,e,r,s,h,u){if(h.width===0||h.height===0)return e;if(h.width>t.width||h.height>t.height||r.x>t.width-h.width||r.y>t.height-h.height)throw new RangeError("out of range source coordinates for image copy");if(h.width>e.width||h.height>e.height||s.x>e.width-h.width||s.y>e.height-h.height)throw new RangeError("out of range destination coordinates for image copy");const f=t.data,g=e.data;for(let x=0;x<h.height;x++){const w=((r.y+x)*t.width+r.x)*u,E=((s.y+x)*e.width+s.x)*u;for(let I=0;I<h.width*u;I++)g[E+I]=f[w+I]}return e}je("HeatmapBucket",B_,{omit:["layers"]});class Hs{constructor(e,r){Mp(this,e,1,r)}resize(e){F_(this,e,1)}clone(){return new Hs({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,s,h,u){kp(e,r,s,h,u,1)}}class qr{constructor(e,r){Mp(this,e,4,r)}resize(e){F_(this,e,4)}replace(e,r){r?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new qr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,s,h,u){kp(e,r,s,h,u,4)}}je("AlphaImage",Hs),je("RGBAImage",qr);var Z0={paint:new Fi({"heatmap-radius":new Ye(ye.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ye(ye.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ge(ye.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Vn(ye.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ge(ye.paint_heatmap["heatmap-opacity"])})};function Dp(t){const e={},r=t.resolution||256,s=t.clips?t.clips.length:1,h=t.image||new qr({width:r,height:s}),u=(f,g,x)=>{e[t.evaluationKey]=x;const w=t.expression.evaluate(e);h.data[f+g+0]=Math.floor(255*w.r/w.a),h.data[f+g+1]=Math.floor(255*w.g/w.a),h.data[f+g+2]=Math.floor(255*w.b/w.a),h.data[f+g+3]=Math.floor(255*w.a)};if(t.clips)for(let f=0,g=0;f<s;++f,g+=4*r)for(let x=0,w=0;x<r;x++,w+=4){const E=x/(r-1),{start:I,end:A}=t.clips[f];u(g,w,I*(1-E)+A*E)}else for(let f=0,g=0;f<r;f++,g+=4)u(0,g,f/(r-1));return h}var W0={paint:new Fi({"hillshade-illumination-direction":new Ge(ye.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Ge(ye.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ge(ye.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ge(ye.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ge(ye.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ge(ye.paint_hillshade["hillshade-accent-color"])})};const X0=ni([{name:"a_pos",components:2,type:"Int16"}],4),{members:H0}=X0;var Cu=Mu,K0=Mu;function Mu(t,e,r){r=r||2;var s,h,u,f,g,x,w,E=e&&e.length,I=E?e[0]*r:t.length,A=O_(t,0,I,r,!0),z=[];if(!A||A.next===A.prev)return z;if(E&&(A=function(O,U,Z,Q){var ne,oe,ae,le=[];for(ne=0,oe=U.length;ne<oe;ne++)(ae=O_(O,U[ne]*Q,ne<oe-1?U[ne+1]*Q:O.length,Q,!1))===ae.next&&(ae.steiner=!0),le.push(n1(ae));for(le.sort(t1),ne=0;ne<le.length;ne++)Z=Ks(Z=i1(le[ne],Z),Z.next);return Z}(t,e,A,r)),t.length>80*r){s=u=t[0],h=f=t[1];for(var R=r;R<I;R+=r)(g=t[R])<s&&(s=g),(x=t[R+1])<h&&(h=x),g>u&&(u=g),x>f&&(f=x);w=(w=Math.max(u-s,f-h))!==0?1/w:0}return Mc(A,z,r,s,h,w),z}function O_(t,e,r,s,h){var u,f;if(h===Lp(t,e,r,s)>0)for(u=e;u<r;u+=s)f=V_(u,t[u],t[u+1],f);else for(u=r-s;u>=e;u-=s)f=V_(u,t[u],t[u+1],f);return f&&ku(f,f.next)&&(Dc(f),f=f.next),f}function Ks(t,e){if(!t)return t;e||(e=t);var r,s=t;do if(r=!1,s.steiner||!ku(s,s.next)&&gi(s.prev,s,s.next)!==0)s=s.next;else{if(Dc(s),(s=e=s.prev)===s.next)break;r=!0}while(r||s!==e);return e}function Mc(t,e,r,s,h,u,f){if(t){!f&&u&&function(E,I,A,z){var R=E;do R.z===null&&(R.z=zp(R.x,R.y,I,A,z)),R.prevZ=R.prev,R.nextZ=R.next,R=R.next;while(R!==E);R.prevZ.nextZ=null,R.prevZ=null,function(O){var U,Z,Q,ne,oe,ae,le,we,ve=1;do{for(Z=O,O=null,oe=null,ae=0;Z;){for(ae++,Q=Z,le=0,U=0;U<ve&&(le++,Q=Q.nextZ);U++);for(we=ve;le>0||we>0&&Q;)le!==0&&(we===0||!Q||Z.z<=Q.z)?(ne=Z,Z=Z.nextZ,le--):(ne=Q,Q=Q.nextZ,we--),oe?oe.nextZ=ne:O=ne,ne.prevZ=oe,oe=ne;Z=Q}oe.nextZ=null,ve*=2}while(ae>1)}(R)}(t,s,h,u);for(var g,x,w=t;t.prev!==t.next;)if(g=t.prev,x=t.next,u?J0(t,s,h,u):Y0(t))e.push(g.i/r),e.push(t.i/r),e.push(x.i/r),Dc(t),t=x.next,w=x.next;else if((t=x)===w){f?f===1?Mc(t=Q0(Ks(t),e,r),e,r,s,h,u,2):f===2&&e1(t,e,r,s,h,u):Mc(Ks(t),e,r,s,h,u,1);break}}}function Y0(t){var e=t.prev,r=t,s=t.next;if(gi(e,r,s)>=0)return!1;for(var h=t.next.next;h!==t.prev;){if(pl(e.x,e.y,r.x,r.y,s.x,s.y,h.x,h.y)&&gi(h.prev,h,h.next)>=0)return!1;h=h.next}return!0}function J0(t,e,r,s){var h=t.prev,u=t,f=t.next;if(gi(h,u,f)>=0)return!1;for(var g=h.x>u.x?h.x>f.x?h.x:f.x:u.x>f.x?u.x:f.x,x=h.y>u.y?h.y>f.y?h.y:f.y:u.y>f.y?u.y:f.y,w=zp(h.x<u.x?h.x<f.x?h.x:f.x:u.x<f.x?u.x:f.x,h.y<u.y?h.y<f.y?h.y:f.y:u.y<f.y?u.y:f.y,e,r,s),E=zp(g,x,e,r,s),I=t.prevZ,A=t.nextZ;I&&I.z>=w&&A&&A.z<=E;){if(I!==t.prev&&I!==t.next&&pl(h.x,h.y,u.x,u.y,f.x,f.y,I.x,I.y)&&gi(I.prev,I,I.next)>=0||(I=I.prevZ,A!==t.prev&&A!==t.next&&pl(h.x,h.y,u.x,u.y,f.x,f.y,A.x,A.y)&&gi(A.prev,A,A.next)>=0))return!1;A=A.nextZ}for(;I&&I.z>=w;){if(I!==t.prev&&I!==t.next&&pl(h.x,h.y,u.x,u.y,f.x,f.y,I.x,I.y)&&gi(I.prev,I,I.next)>=0)return!1;I=I.prevZ}for(;A&&A.z<=E;){if(A!==t.prev&&A!==t.next&&pl(h.x,h.y,u.x,u.y,f.x,f.y,A.x,A.y)&&gi(A.prev,A,A.next)>=0)return!1;A=A.nextZ}return!0}function Q0(t,e,r){var s=t;do{var h=s.prev,u=s.next.next;!ku(h,u)&&N_(h,s,s.next,u)&&kc(h,u)&&kc(u,h)&&(e.push(h.i/r),e.push(s.i/r),e.push(u.i/r),Dc(s),Dc(s.next),s=t=u),s=s.next}while(s!==t);return Ks(s)}function e1(t,e,r,s,h,u){var f=t;do{for(var g=f.next.next;g!==f.prev;){if(f.i!==g.i&&s1(f,g)){var x=U_(f,g);return f=Ks(f,f.next),x=Ks(x,x.next),Mc(f,e,r,s,h,u),void Mc(x,e,r,s,h,u)}g=g.next}f=f.next}while(f!==t)}function t1(t,e){return t.x-e.x}function i1(t,e){var r=function(u,f){var g,x=f,w=u.x,E=u.y,I=-1/0;do{if(E<=x.y&&E>=x.next.y&&x.next.y!==x.y){var A=x.x+(E-x.y)*(x.next.x-x.x)/(x.next.y-x.y);if(A<=w&&A>I){if(I=A,A===w){if(E===x.y)return x;if(E===x.next.y)return x.next}g=x.x<x.next.x?x:x.next}}x=x.next}while(x!==f);if(!g)return null;if(w===I)return g;var z,R=g,O=g.x,U=g.y,Z=1/0;x=g;do w>=x.x&&x.x>=O&&w!==x.x&&pl(E<U?w:I,E,O,U,E<U?I:w,E,x.x,x.y)&&(z=Math.abs(E-x.y)/(w-x.x),kc(x,u)&&(z<Z||z===Z&&(x.x>g.x||x.x===g.x&&r1(g,x)))&&(g=x,Z=z)),x=x.next;while(x!==R);return g}(t,e);if(!r)return e;var s=U_(r,t),h=Ks(r,r.next);return Ks(s,s.next),e===r?h:e}function r1(t,e){return gi(t.prev,t,e.prev)<0&&gi(e.next,t,t.next)<0}function zp(t,e,r,s,h){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*h)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-s)*h)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function n1(t){var e=t,r=t;do(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next;while(e!==t);return r}function pl(t,e,r,s,h,u,f,g){return(h-f)*(e-g)-(t-f)*(u-g)>=0&&(t-f)*(s-g)-(r-f)*(e-g)>=0&&(r-f)*(u-g)-(h-f)*(s-g)>=0}function s1(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(r,s){var h=r;do{if(h.i!==r.i&&h.next.i!==r.i&&h.i!==s.i&&h.next.i!==s.i&&N_(h,h.next,r,s))return!0;h=h.next}while(h!==r);return!1}(t,e)&&(kc(t,e)&&kc(e,t)&&function(r,s){var h=r,u=!1,f=(r.x+s.x)/2,g=(r.y+s.y)/2;do h.y>g!=h.next.y>g&&h.next.y!==h.y&&f<(h.next.x-h.x)*(g-h.y)/(h.next.y-h.y)+h.x&&(u=!u),h=h.next;while(h!==r);return u}(t,e)&&(gi(t.prev,t,e.prev)||gi(t,e.prev,e))||ku(t,e)&&gi(t.prev,t,t.next)>0&&gi(e.prev,e,e.next)>0)}function gi(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function ku(t,e){return t.x===e.x&&t.y===e.y}function N_(t,e,r,s){var h=zu(gi(t,e,r)),u=zu(gi(t,e,s)),f=zu(gi(r,s,t)),g=zu(gi(r,s,e));return h!==u&&f!==g||!(h!==0||!Du(t,r,e))||!(u!==0||!Du(t,s,e))||!(f!==0||!Du(r,t,s))||!(g!==0||!Du(r,e,s))}function Du(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function zu(t){return t>0?1:t<0?-1:0}function kc(t,e){return gi(t.prev,t,t.next)<0?gi(t,e,t.next)>=0&&gi(t,t.prev,e)>=0:gi(t,e,t.prev)<0||gi(t,t.next,e)<0}function U_(t,e){var r=new Pp(t.i,t.x,t.y),s=new Pp(e.i,e.x,e.y),h=t.next,u=e.prev;return t.next=e,e.prev=t,r.next=h,h.prev=r,s.next=r,r.prev=s,u.next=s,s.prev=u,s}function V_(t,e,r,s){var h=new Pp(t,e,r);return s?(h.next=s.next,h.prev=s,s.next.prev=h,s.next=h):(h.prev=h,h.next=h),h}function Dc(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Pp(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Lp(t,e,r,s){for(var h=0,u=e,f=r-s;u<r;u+=s)h+=(t[f]-t[u])*(t[u+1]+t[f+1]),f=u;return h}function o1(t,e,r,s,h){j_(t,e,r||0,s||t.length-1,h||a1)}function j_(t,e,r,s,h){for(;s>r;){if(s-r>600){var u=s-r+1,f=e-r+1,g=Math.log(u),x=.5*Math.exp(2*g/3),w=.5*Math.sqrt(g*x*(u-x)/u)*(f-u/2<0?-1:1);j_(t,e,Math.max(r,Math.floor(e-f*x/u+w)),Math.min(s,Math.floor(e+(u-f)*x/u+w)),h)}var E=t[e],I=r,A=s;for(zc(t,r,e),h(t[s],E)>0&&zc(t,r,s);I<A;){for(zc(t,I,A),I++,A--;h(t[I],E)<0;)I++;for(;h(t[A],E)>0;)A--}h(t[r],E)===0?zc(t,r,A):zc(t,++A,s),A<=e&&(r=A+1),e<=A&&(s=A-1)}}function zc(t,e,r){var s=t[e];t[e]=t[r],t[r]=s}function a1(t,e){return t<e?-1:t>e?1:0}function Rp(t,e){const r=t.length;if(r<=1)return[t];const s=[];let h,u;for(let f=0;f<r;f++){const g=As(t[f]);g!==0&&(t[f].area=Math.abs(g),u===void 0&&(u=g<0),u===g<0?(h&&s.push(h),h=[t[f]]):h.push(t[f]))}if(h&&s.push(h),e>1)for(let f=0;f<s.length;f++)s[f].length<=e||(o1(s[f],e,1,s[f].length-1,l1),s[f]=s[f].slice(0,e));return s}function l1(t,e){return e.area-t.area}function Bp(t,e,r){const s=r.patternDependencies;let h=!1;for(const u of e){const f=u.paint.get(`${t}-pattern`);f.isConstant()||(h=!0);const g=f.constantOr(null);g&&(h=!0,s[g.to]=!0,s[g.from]=!0)}return h}function Fp(t,e,r,s,h){const u=h.patternDependencies;for(const f of e){const g=f.paint.get(`${t}-pattern`).value;if(g.kind!=="constant"){let x=g.evaluate({zoom:s-1},r,{},h.availableImages),w=g.evaluate({zoom:s},r,{},h.availableImages),E=g.evaluate({zoom:s+1},r,{},h.availableImages);x=x&&x.name?x.name:x,w=w&&w.name?w.name:w,E=E&&E.name?E.name:E,u[x]=!0,u[w]=!0,u[E]=!0,r.patterns[f.id]={min:x,mid:w,max:E}}}return r}Mu.deviation=function(t,e,r,s){var h=e&&e.length,u=Math.abs(Lp(t,0,h?e[0]*r:t.length,r));if(h)for(var f=0,g=e.length;f<g;f++)u-=Math.abs(Lp(t,e[f]*r,f<g-1?e[f+1]*r:t.length,r));var x=0;for(f=0;f<s.length;f+=3){var w=s[f]*r,E=s[f+1]*r,I=s[f+2]*r;x+=Math.abs((t[w]-t[I])*(t[E+1]-t[w+1])-(t[w]-t[E])*(t[I+1]-t[w+1]))}return u===0&&x===0?0:Math.abs((x-u)/u)},Mu.flatten=function(t){for(var e=t[0][0].length,r={vertices:[],holes:[],dimensions:e},s=0,h=0;h<t.length;h++){for(var u=0;u<t[h].length;u++)for(var f=0;f<e;f++)r.vertices.push(t[h][u][f]);h>0&&r.holes.push(s+=t[h-1].length)}return r},Cu.default=K0;class Pu{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new sl,this.indexArray=new Gr,this.indexArray2=new Ws,this.programConfigurations=new Xo(e.layers,e.zoom),this.segments=new _i,this.segments2=new _i,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,s,h){this.hasPattern=Bp("fill",this.layers,r);const u=this.layers[0].layout.get("fill-sort-key"),f=[];for(const{feature:g,id:x,index:w,sourceLayerIndex:E}of e){const I=this.layers[0]._featureFilter.needGeometry,A=Ko(g,I);if(!this.layers[0]._featureFilter.filter(new ot(this.zoom),A,s))continue;const z=u?u.evaluate(A,{},s,r.availableImages):void 0,R={id:x,properties:g.properties,type:g.type,sourceLayerIndex:E,index:w,geometry:I?A.geometry:us(g,s,h),patterns:{},sortKey:z};f.push(R)}u&&f.sort((g,x)=>g.sortKey-x.sortKey);for(const g of f){const{geometry:x,index:w,sourceLayerIndex:E}=g;if(this.hasPattern){const I=Fp("fill",this.layers,g,this.zoom,r);this.patternFeatures.push(I)}else this.addFeature(g,x,w,s,{},r.availableImages);r.featureIndex.insert(e[w].feature,x,w,E,this.index)}}update(e,r,s,h){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,s,h)}addFeatures(e,r,s,h){for(const u of this.patternFeatures)this.addFeature(u,u.geometry,u.index,r,s,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,H0),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,r,s,h,u,f=[]){for(const g of Rp(r,500)){let x=0;for(const R of g)x+=R.length;const w=this.segments.prepareSegment(x,this.layoutVertexArray,this.indexArray),E=w.vertexLength,I=[],A=[];for(const R of g){if(R.length===0)continue;R!==g[0]&&A.push(I.length/2);const O=this.segments2.prepareSegment(R.length,this.layoutVertexArray,this.indexArray2),U=O.vertexLength;this.layoutVertexArray.emplaceBack(R[0].x,R[0].y),this.indexArray2.emplaceBack(U+R.length-1,U),I.push(R[0].x),I.push(R[0].y);for(let Z=1;Z<R.length;Z++)this.layoutVertexArray.emplaceBack(R[Z].x,R[Z].y),this.indexArray2.emplaceBack(U+Z-1,U+Z),I.push(R[Z].x),I.push(R[Z].y);O.vertexLength+=R.length,O.primitiveLength+=R.length}const z=Cu(I,A);for(let R=0;R<z.length;R+=3)this.indexArray.emplaceBack(E+z[R],E+z[R+1],E+z[R+2]);w.vertexLength+=x,w.primitiveLength+=z.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,u,f,h)}}je("FillBucket",Pu,{omit:["layers","patternFeatures"]});const c1=new Fi({"fill-sort-key":new Ye(ye.layout_fill["fill-sort-key"])});var h1={paint:new Fi({"fill-antialias":new Ge(ye.paint_fill["fill-antialias"]),"fill-opacity":new Ye(ye.paint_fill["fill-opacity"]),"fill-color":new Ye(ye.paint_fill["fill-color"]),"fill-outline-color":new Ye(ye.paint_fill["fill-outline-color"]),"fill-translate":new Ge(ye.paint_fill["fill-translate"]),"fill-translate-anchor":new Ge(ye.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ii(ye.paint_fill["fill-pattern"])}),layout:c1};const u1=ni([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),d1=ni([{name:"a_centroid_pos",components:2,type:"Uint16"}]),{members:p1}=u1;var $_=fl;function fl(t,e,r,s,h){this.properties={},this.extent=r,this.type=0,this._pbf=t,this._geometry=-1,this._keys=s,this._values=h,t.readFields(f1,this,e)}function f1(t,e,r){t==1?e.id=r.readVarint():t==2?function(s,h){for(var u=s.readVarint()+s.pos;s.pos<u;){var f=h._keys[s.readVarint()],g=h._values[s.readVarint()];h.properties[f]=g}}(r,e):t==3?e.type=r.readVarint():t==4&&(e._geometry=r.pos)}function m1(t){for(var e,r,s=0,h=0,u=t.length,f=u-1;h<u;f=h++)s+=((r=t[f]).x-(e=t[h]).x)*(e.y+r.y);return s}fl.types=["Unknown","Point","LineString","Polygon"],fl.prototype.loadGeometry=function(){var t=this._pbf;t.pos=this._geometry;for(var e,r=t.readVarint()+t.pos,s=1,h=0,u=0,f=0,g=[];t.pos<r;){if(h<=0){var x=t.readVarint();s=7&x,h=x>>3}if(h--,s===1||s===2)u+=t.readSVarint(),f+=t.readSVarint(),s===1&&(e&&g.push(e),e=[]),e.push(new ue(u,f));else{if(s!==7)throw new Error("unknown command "+s);e&&e.push(e[0].clone())}}return e&&g.push(e),g},fl.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,r=1,s=0,h=0,u=0,f=1/0,g=-1/0,x=1/0,w=-1/0;t.pos<e;){if(s<=0){var E=t.readVarint();r=7&E,s=E>>3}if(s--,r===1||r===2)(h+=t.readSVarint())<f&&(f=h),h>g&&(g=h),(u+=t.readSVarint())<x&&(x=u),u>w&&(w=u);else if(r!==7)throw new Error("unknown command "+r)}return[f,x,g,w]},fl.prototype.toGeoJSON=function(t,e,r){var s,h,u=this.extent*Math.pow(2,r),f=this.extent*t,g=this.extent*e,x=this.loadGeometry(),w=fl.types[this.type];function E(z){for(var R=0;R<z.length;R++){var O=z[R];z[R]=[360*(O.x+f)/u-180,360/Math.PI*Math.atan(Math.exp((180-360*(O.y+g)/u)*Math.PI/180))-90]}}switch(this.type){case 1:var I=[];for(s=0;s<x.length;s++)I[s]=x[s][0];E(x=I);break;case 2:for(s=0;s<x.length;s++)E(x[s]);break;case 3:for(x=function(z){var R=z.length;if(R<=1)return[z];for(var O,U,Z=[],Q=0;Q<R;Q++){var ne=m1(z[Q]);ne!==0&&(U===void 0&&(U=ne<0),U===ne<0?(O&&Z.push(O),O=[z[Q]]):O.push(z[Q]))}return O&&Z.push(O),Z}(x),s=0;s<x.length;s++)for(h=0;h<x[s].length;h++)E(x[s][h])}x.length===1?x=x[0]:w="Multi"+w;var A={type:"Feature",geometry:{type:w,coordinates:x},properties:this.properties};return"id"in this&&(A.id=this.id),A};var G_=q_;function q_(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(_1,this,e),this.length=this._features.length}function _1(t,e,r){t===15?e.version=r.readVarint():t===1?e.name=r.readString():t===5?e.extent=r.readVarint():t===2?e._features.push(r.pos):t===3?e._keys.push(r.readString()):t===4&&e._values.push(function(s){for(var h=null,u=s.readVarint()+s.pos;s.pos<u;){var f=s.readVarint()>>3;h=f===1?s.readString():f===2?s.readFloat():f===3?s.readDouble():f===4?s.readVarint64():f===5?s.readVarint():f===6?s.readSVarint():f===7?s.readBoolean():null}return h}(r))}function g1(t,e,r){if(t===3){var s=new G_(r,r.readVarint()+r.pos);s.length&&(e[s.name]=s)}}q_.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new $_(this._pbf,e,this.extent,this._keys,this._values)};var Yo={VectorTile:function(t,e){this.layers=t.readFields(g1,{},e)},VectorTileFeature:$_,VectorTileLayer:G_};const y1=Yo.VectorTileFeature.types,x1=Math.pow(2,13);function Pc(t,e,r,s,h,u,f,g){t.emplaceBack((e<<1)+f,(r<<1)+u,(Math.floor(s*x1)<<1)+h,Math.round(g))}class Z_{constructor(){this.acc=new ue(0,0),this.polyCount=[]}startRing(e){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new ue(e.x,e.y),this.max=new ue(e.x,e.y))}append(e,r){this.currentPolyCount.edges++,this.acc._add(e);let s=!!this.borders;const h=this.min,u=this.max;e.x<h.x?(h.x=e.x,s=!0):e.x>u.x&&(u.x=e.x,s=!0),e.y<h.y?(h.y=e.y,s=!0):e.y>u.y&&(u.y=e.y,s=!0),((e.x===0||e.x===yt)&&e.x===r.x)!=((e.y===0||e.y===yt)&&e.y===r.y)&&this.processBorderOverlap(e,r),s&&this.checkBorderIntersection(e,r)}checkBorderIntersection(e,r){r.x<0!=e.x<0&&this.addBorderIntersection(0,Lt(r.y,e.y,(0-r.x)/(e.x-r.x))),r.x>yt!=e.x>yt&&this.addBorderIntersection(1,Lt(r.y,e.y,(yt-r.x)/(e.x-r.x))),r.y<0!=e.y<0&&this.addBorderIntersection(2,Lt(r.x,e.x,(0-r.y)/(e.y-r.y))),r.y>yt!=e.y>yt&&this.addBorderIntersection(3,Lt(r.x,e.x,(yt-r.y)/(e.y-r.y)))}addBorderIntersection(e,r){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const s=this.borders[e];r<s[0]&&(s[0]=r),r>s[1]&&(s[1]=r)}processBorderOverlap(e,r){if(e.x===r.x){if(e.y===r.y)return;const s=e.x===0?0:1;this.addBorderIntersection(s,r.y),this.addBorderIntersection(s,e.y)}else{const s=e.y===0?2:3;this.addBorderIntersection(s,r.x),this.addBorderIntersection(s,e.x)}}centroid(){const e=this.polyCount.reduce((r,s)=>r+s.edges,0);return e!==0?this.acc.div(e)._round():new ue(0,0)}span(){return new ue(this.max.x-this.min.x,this.max.y-this.min.y)}intersectsCount(){return this.borders.reduce((e,r)=>e+ +(r[0]!==Number.MAX_VALUE),0)}}class Op{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new ol,this.centroidVertexArray=new __,this.indexArray=new Gr,this.programConfigurations=new Xo(e.layers,e.zoom),this.segments=new _i,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.enableTerrain=e.enableTerrain}populate(e,r,s,h){this.features=[],this.hasPattern=Bp("fill-extrusion",this.layers,r),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDone=[!1,!1,!1,!1],this.tileToMeter=function(u){const f=Math.exp(Math.PI*(1-u.y/(1<<u.z)*2));return 80150034*f/(f*f+1)/yt/(1<<u.z)}(s);for(const{feature:u,id:f,index:g,sourceLayerIndex:x}of e){const w=this.layers[0]._featureFilter.needGeometry,E=Ko(u,w);if(!this.layers[0]._featureFilter.filter(new ot(this.zoom),E,s))continue;const I={id:f,sourceLayerIndex:x,index:g,geometry:w?E.geometry:us(u,s,h),properties:u.properties,type:u.type,patterns:{}},A=this.layoutVertexArray.length;this.hasPattern?this.features.push(Fp("fill-extrusion",this.layers,I,this.zoom,r)):this.addFeature(I,I.geometry,g,s,{},r.availableImages),r.featureIndex.insert(u,I.geometry,g,x,this.index,A)}this.sortBorders()}addFeatures(e,r,s,h){for(const u of this.features){const{geometry:f}=u;this.addFeature(u,f,u.index,r,s,h)}this.sortBorders()}update(e,r,s,h){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,s,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,p1),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.centroidVertexArray.length!==0&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,d1.members,!0),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,r,s,h,u,f){const g=this.enableTerrain?new Z_:null;for(const w of Rp(r,500)){let E=0,I=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);if(w.length===0||(x=w[0]).every(U=>U.x<=0)||x.every(U=>U.x>=yt)||x.every(U=>U.y<=0)||x.every(U=>U.y>=yt))continue;for(let U=0;U<w.length;U++){const Z=w[U];if(Z.length===0)continue;E+=Z.length;let Q=0;g&&g.startRing(Z[0]);for(let ne=0;ne<Z.length;ne++){const oe=Z[ne];if(ne>=1){const ae=Z[ne-1];if(!v1(oe,ae)){g&&g.append(oe,ae),I.vertexLength+4>_i.MAX_VERTEX_ARRAY_LENGTH&&(I=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const le=oe.sub(ae)._perp(),we=le.x/(Math.abs(le.x)+Math.abs(le.y)),ve=le.y>0?1:0,Fe=ae.dist(oe);Q+Fe>32768&&(Q=0),Pc(this.layoutVertexArray,oe.x,oe.y,we,ve,0,0,Q),Pc(this.layoutVertexArray,oe.x,oe.y,we,ve,0,1,Q),Q+=Fe,Pc(this.layoutVertexArray,ae.x,ae.y,we,ve,0,0,Q),Pc(this.layoutVertexArray,ae.x,ae.y,we,ve,0,1,Q);const Pe=I.vertexLength;this.indexArray.emplaceBack(Pe,Pe+2,Pe+1),this.indexArray.emplaceBack(Pe+1,Pe+2,Pe+3),I.vertexLength+=4,I.primitiveLength+=2}}}}if(I.vertexLength+E>_i.MAX_VERTEX_ARRAY_LENGTH&&(I=this.segments.prepareSegment(E,this.layoutVertexArray,this.indexArray)),y1[e.type]!=="Polygon")continue;const A=[],z=[],R=I.vertexLength;for(let U=0;U<w.length;U++){const Z=w[U];if(Z.length!==0){Z!==w[0]&&z.push(A.length/2);for(let Q=0;Q<Z.length;Q++){const ne=Z[Q];Pc(this.layoutVertexArray,ne.x,ne.y,0,0,1,1,0),A.push(ne.x),A.push(ne.y),g&&g.currentPolyCount.top++}}}const O=Cu(A,z);for(let U=0;U<O.length;U+=3)this.indexArray.emplaceBack(R+O[U],R+O[U+2],R+O[U+1]);I.primitiveLength+=O.length/3,I.vertexLength+=E}var x;if(g&&g.polyCount.length>0){if(g.borders){g.vertexArrayOffset=this.centroidVertexArray.length;const w=g.borders,E=this.featuresOnBorder.push(g)-1;for(let I=0;I<4;I++)w[I][0]!==Number.MAX_VALUE&&this.borders[I].push(E)}this.encodeCentroid(g.borders?void 0:g.centroid(),g)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,u,f,h)}sortBorders(){for(let e=0;e<4;e++)this.borders[e].sort((r,s)=>this.featuresOnBorder[r].borders[e][0]-this.featuresOnBorder[s].borders[e][0])}encodeCentroid(e,r,s=!0){let h,u;if(e)if(e.y!==0){const g=r.span()._mult(this.tileToMeter);h=(Math.max(e.x,1)<<3)+Math.min(7,Math.round(g.x/10)),u=(Math.max(e.y,1)<<3)+Math.min(7,Math.round(g.y/10))}else h=Math.ceil(7*(e.x+450)),u=0;else h=0,u=+s;let f=s?this.centroidVertexArray.length:r.vertexArrayOffset;for(const g of r.polyCount){s&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*g.edges+g.top);for(let x=0;x<2*g.edges;x++)this.centroidVertexArray.emplace(f++,0,u),this.centroidVertexArray.emplace(f++,h,u);for(let x=0;x<g.top;x++)this.centroidVertexArray.emplace(f++,h,u)}}}function v1(t,e){return t.x===e.x&&(t.x<0||t.x>yt)||t.y===e.y&&(t.y<0||t.y>yt)}je("FillExtrusionBucket",Op,{omit:["layers","features"]}),je("PartMetadata",Z_);var b1={paint:new Fi({"fill-extrusion-opacity":new Ge(ye["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ye(ye["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ge(ye["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ge(ye["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ii(ye["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Ye(ye["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ye(ye["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Ge(ye["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})};function Lc(t,e){return t.x*e.x+t.y*e.y}function W_(t,e){if(t.length===1){let r=0;const s=e[r++];let h;for(;!h||s.equals(h);)if(h=e[r++],!h)return 1/0;for(;r<e.length;r++){const u=e[r],f=t[0],g=h.sub(s),x=u.sub(s),w=f.sub(s),E=Lc(g,g),I=Lc(g,x),A=Lc(x,x),z=Lc(w,g),R=Lc(w,x),O=E*A-I*I,U=(A*z-I*R)/O,Z=(E*R-I*z)/O,Q=s.z*(1-U-Z)+h.z*U+u.z*Z;if(isFinite(Q))return Q}return 1/0}{let r=1/0;for(const s of e)r=Math.min(r,s.z);return r}}function X_(t){const e=new ue(t[0],t[1]);return e.z=t[2],e}function w1(t,e,r,s,h,u,f,g){const x=f*h.getElevationAt(t,e,!0,!0),w=u[0]!==0,E=w?u[1]===0?f*(u[0]/7-450):f*function(I,A,z){const R=Math.floor(A[0]/8),O=Math.floor(A[1]/8),U=10*(A[0]-8*R),Z=10*(A[1]-8*O),Q=I.getElevationAt(R,O,!0,!0),ne=I.getMeterToDEM(z),oe=Math.floor(.5*(U*ne-1)),ae=Math.floor(.5*(Z*ne-1)),le=I.tileCoordToPixel(R,O),we=2*oe+1,ve=2*ae+1,Fe=function(Ve,qe,wt,Gt,St){return[Ve.getElevationAtPixel(qe,wt,!0),Ve.getElevationAtPixel(qe+St,wt,!0),Ve.getElevationAtPixel(qe,wt+St,!0),Ve.getElevationAtPixel(qe+Gt,wt+St,!0)]}(I,le.x-oe,le.y-ae,we,ve),Pe=Math.abs(Fe[0]-Fe[1]),be=Math.abs(Fe[2]-Fe[3]),Le=Math.abs(Fe[0]-Fe[2])+Math.abs(Fe[1]-Fe[3]),Oe=Math.min(.25,.5*ne*(Pe+be)/we),Ie=Math.min(.25,.5*ne*Le/ve);return Q+Math.max(Oe*U,Ie*Z)}(h,u,g):x;return{base:x+(r===0)?-1:r,top:w?Math.max(E+s,x+r+2):x+s}}const T1=ni([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:E1}=T1,S1=ni([{name:"a_packed",components:3,type:"Float32"}]),{members:I1}=S1,A1=Yo.VectorTileFeature.types,C1=Math.cos(Math.PI/180*37.5);class Lu{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new cp,this.layoutVertexArray2=new al,this.indexArray=new Gr,this.programConfigurations=new Xo(e.layers,e.zoom),this.segments=new _i,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,s,h){this.hasPattern=Bp("line",this.layers,r);const u=this.layers[0].layout.get("line-sort-key"),f=[];for(const{feature:E,id:I,index:A,sourceLayerIndex:z}of e){const R=this.layers[0]._featureFilter.needGeometry,O=Ko(E,R);if(!this.layers[0]._featureFilter.filter(new ot(this.zoom),O,s))continue;const U=u?u.evaluate(O,{},s):void 0,Z={id:I,properties:E.properties,type:E.type,sourceLayerIndex:z,index:A,geometry:R?O.geometry:us(E,s,h),patterns:{},sortKey:U};f.push(Z)}u&&f.sort((E,I)=>E.sortKey-I.sortKey);const{lineAtlas:g,featureIndex:x}=r,w=this.addConstantDashes(g);for(const E of f){const{geometry:I,index:A,sourceLayerIndex:z}=E;if(w&&this.addFeatureDashes(E,g),this.hasPattern){const R=Fp("line",this.layers,E,this.zoom,r);this.patternFeatures.push(R)}else this.addFeature(E,I,A,s,g.positions,r.availableImages);x.insert(e[A].feature,I,A,z,this.index)}}addConstantDashes(e){let r=!1;for(const s of this.layers){const h=s.paint.get("line-dasharray").value,u=s.layout.get("line-cap").value;if(h.kind!=="constant"||u.kind!=="constant")r=!0;else{const f=u.value,g=h.value;if(!g)continue;e.addDash(g.from,f),e.addDash(g.to,f),g.other&&e.addDash(g.other,f)}}return r}addFeatureDashes(e,r){const s=this.zoom;for(const h of this.layers){const u=h.paint.get("line-dasharray").value,f=h.layout.get("line-cap").value;if(u.kind==="constant"&&f.kind==="constant")continue;let g,x,w,E,I,A;if(u.kind==="constant"){const U=u.value;if(!U)continue;g=U.other||U.to,x=U.to,w=U.from}else g=u.evaluate({zoom:s-1},e),x=u.evaluate({zoom:s},e),w=u.evaluate({zoom:s+1},e);f.kind==="constant"?E=I=A=f.value:(E=f.evaluate({zoom:s-1},e),I=f.evaluate({zoom:s},e),A=f.evaluate({zoom:s+1},e)),r.addDash(g,E),r.addDash(x,I),r.addDash(w,A);const z=r.getKey(g,E),R=r.getKey(x,I),O=r.getKey(w,A);e.patterns[h.id]={min:z,mid:R,max:O}}}update(e,r,s,h){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,s,h)}addFeatures(e,r,s,h){for(const u of this.patternFeatures)this.addFeature(u,u.geometry,u.index,r,s,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,I1)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,E1),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,r,s,h,u,f){const g=this.layers[0].layout,x=g.get("line-join").evaluate(e,{}),w=g.get("line-cap").evaluate(e,{}),E=g.get("line-miter-limit"),I=g.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const A of r)this.addLine(A,e,x,w,E,I);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,u,f,h)}addLine(e,r,s,h,u,f){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Z=0;Z<e.length-1;Z++)this.totalDistance+=e[Z].dist(e[Z+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const g=A1[r.type]==="Polygon";let x=e.length;for(;x>=2&&e[x-1].equals(e[x-2]);)x--;let w=0;for(;w<x-1&&e[w].equals(e[w+1]);)w++;if(x<(g?3:2))return;s==="bevel"&&(u=1.05);const E=this.overscaling<=16?122880/(512*this.overscaling):0,I=this.segments.prepareSegment(10*x,this.layoutVertexArray,this.indexArray);let A,z,R,O,U;this.e1=this.e2=-1,g&&(A=e[x-2],U=e[w].sub(A)._unit()._perp());for(let Z=w;Z<x;Z++){if(R=Z===x-1?g?e[w+1]:void 0:e[Z+1],R&&e[Z].equals(R))continue;U&&(O=U),A&&(z=A),A=e[Z],U=R?R.sub(A)._unit()._perp():O,O=O||U;let Q=O.add(U);Q.x===0&&Q.y===0||Q._unit();const ne=O.x*U.x+O.y*U.y,oe=Q.x*U.x+Q.y*U.y,ae=oe!==0?1/oe:1/0,le=2*Math.sqrt(2-2*oe),we=oe<C1&&z&&R,ve=O.x*U.y-O.y*U.x>0;if(we&&Z>w){const be=A.dist(z);if(be>2*E){const Le=A.sub(A.sub(z)._mult(E/be)._round());this.updateDistance(z,Le),this.addCurrentVertex(Le,O,0,0,I),z=Le}}const Fe=z&&R;let Pe=Fe?s:g?"butt":h;if(Fe&&Pe==="round"&&(ae<f?Pe="miter":ae<=2&&(Pe="fakeround")),Pe==="miter"&&ae>u&&(Pe="bevel"),Pe==="bevel"&&(ae>2&&(Pe="flipbevel"),ae<u&&(Pe="miter")),z&&this.updateDistance(z,A),Pe==="miter")Q._mult(ae),this.addCurrentVertex(A,Q,0,0,I);else if(Pe==="flipbevel"){if(ae>100)Q=U.mult(-1);else{const be=ae*O.add(U).mag()/O.sub(U).mag();Q._perp()._mult(be*(ve?-1:1))}this.addCurrentVertex(A,Q,0,0,I),this.addCurrentVertex(A,Q.mult(-1),0,0,I)}else if(Pe==="bevel"||Pe==="fakeround"){const be=-Math.sqrt(ae*ae-1),Le=ve?be:0,Oe=ve?0:be;if(z&&this.addCurrentVertex(A,O,Le,Oe,I),Pe==="fakeround"){const Ie=Math.round(180*le/Math.PI/20);for(let Ve=1;Ve<Ie;Ve++){let qe=Ve/Ie;if(qe!==.5){const Gt=qe-.5;qe+=qe*Gt*(qe-1)*((1.0904+ne*(ne*(3.55645-1.43519*ne)-3.2452))*Gt*Gt+(.848013+ne*(.215638*ne-1.06021)))}const wt=U.sub(O)._mult(qe)._add(O)._unit()._mult(ve?-1:1);this.addHalfVertex(A,wt.x,wt.y,!1,ve,0,I)}}R&&this.addCurrentVertex(A,U,-Le,-Oe,I)}else if(Pe==="butt")this.addCurrentVertex(A,Q,0,0,I);else if(Pe==="square"){const be=z?1:-1;z||this.addCurrentVertex(A,Q,be,be,I),this.addCurrentVertex(A,Q,0,0,I),z&&this.addCurrentVertex(A,Q,be,be,I)}else Pe==="round"&&(z&&(this.addCurrentVertex(A,O,0,0,I),this.addCurrentVertex(A,O,1,1,I,!0)),R&&(this.addCurrentVertex(A,U,-1,-1,I,!0),this.addCurrentVertex(A,U,0,0,I)));if(we&&Z<x-1){const be=A.dist(R);if(be>2*E){const Le=A.add(R.sub(A)._mult(E/be)._round());this.updateDistance(A,Le),this.addCurrentVertex(Le,U,0,0,I),A=Le}}}}addCurrentVertex(e,r,s,h,u,f=!1){const g=r.y*h-r.x,x=-r.y-r.x*h;this.addHalfVertex(e,r.x+r.y*s,r.y-r.x*s,f,!1,s,u),this.addHalfVertex(e,g,x,f,!0,-h,u)}addHalfVertex({x:e,y:r},s,h,u,f,g,x){this.layoutVertexArray.emplaceBack((e<<1)+(u?1:0),(r<<1)+(f?1:0),Math.round(63*s)+128,Math.round(63*h)+128,1+(g===0?0:g<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineSoFar);const w=x.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,w),x.primitiveLength++),f?this.e2=w:this.e1=w}updateScaledDistance(){if(this.lineClips){const e=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=e*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(e,r){this.distance+=e.dist(r),this.updateScaledDistance()}}je("LineBucket",Lu,{omit:["layers","patternFeatures"]});const M1=new Fi({"line-cap":new Ye(ye.layout_line["line-cap"]),"line-join":new Ye(ye.layout_line["line-join"]),"line-miter-limit":new Ge(ye.layout_line["line-miter-limit"]),"line-round-limit":new Ge(ye.layout_line["line-round-limit"]),"line-sort-key":new Ye(ye.layout_line["line-sort-key"])});var H_={paint:new Fi({"line-opacity":new Ye(ye.paint_line["line-opacity"]),"line-color":new Ye(ye.paint_line["line-color"]),"line-translate":new Ge(ye.paint_line["line-translate"]),"line-translate-anchor":new Ge(ye.paint_line["line-translate-anchor"]),"line-width":new Ye(ye.paint_line["line-width"]),"line-gap-width":new Ye(ye.paint_line["line-gap-width"]),"line-offset":new Ye(ye.paint_line["line-offset"]),"line-blur":new Ye(ye.paint_line["line-blur"]),"line-dasharray":new Ii(ye.paint_line["line-dasharray"]),"line-pattern":new Ii(ye.paint_line["line-pattern"]),"line-gradient":new Vn(ye.paint_line["line-gradient"])}),layout:M1};const K_=new class extends Ye{possiblyEvaluate(t,e){return e=new ot(Math.floor(e.zoom),{now:e.now,fadeDuration:e.fadeDuration,zoomHistory:e.zoomHistory,transition:e.transition}),super.possiblyEvaluate(t,e)}evaluate(t,e,r,s){return e=si({},e,{zoom:Math.floor(e.zoom)}),super.evaluate(t,e,r,s)}}(H_.paint.properties["line-width"].specification);function Y_(t,e){return e>0?e+2*t:t}K_.useIntegerZoom=!0;const k1=ni([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"},{name:"a_z_tile_anchor",components:4,type:"Int16"}],4),D1=ni([{name:"a_projected_pos",components:3,type:"Float32"}],4);ni([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const z1=ni([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),P1=ni([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);ni([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const J_=ni([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),L1=ni([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);ni([{name:"triangle",components:3,type:"Uint16"}]),ni([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),ni([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),ni([{type:"Float32",name:"offsetX"}]),ni([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);var Ni=24;const $n=128;function Np(t,e){const{expression:r}=e;if(r.kind==="constant")return{kind:"constant",layoutSize:r.evaluate(new ot(t+1))};if(r.kind==="source")return{kind:"source"};{const{zoomStops:s,interpolationType:h}=r;let u=0;for(;u<s.length&&s[u]<=t;)u++;u=Math.max(0,u-1);let f=u;for(;f<s.length&&s[f]<t+1;)f++;f=Math.min(s.length-1,f);const g=s[u],x=s[f];return r.kind==="composite"?{kind:"composite",minZoom:g,maxZoom:x,interpolationType:h}:{kind:"camera",minZoom:g,maxZoom:x,minSize:r.evaluate(new ot(g)),maxSize:r.evaluate(new ot(x)),interpolationType:h}}}function Ru(t,{uSize:e,uSizeT:r},{lowerSize:s,upperSize:h}){return t.kind==="source"?s/$n:t.kind==="composite"?Lt(s/$n,h/$n,r):e}function ml(t,e){let r=0,s=0;if(t.kind==="constant")s=t.layoutSize;else if(t.kind!=="source"){const{interpolationType:h,minZoom:u,maxZoom:f}=t,g=h?Ft(rr.interpolationFactor(h,e,u,f),0,1):0;t.kind==="camera"?s=Lt(t.minSize,t.maxSize,g):r=g}return{uSizeT:r,uSize:s}}var R1=Object.freeze({__proto__:null,getSizeData:Np,evaluateSizeForFeature:Ru,evaluateSizeForZoom:ml,SIZE_PACK_FACTOR:$n});function B1(t,e,r){return t.sections.forEach(s=>{s.text=function(h,u,f){const g=u.layout.get("text-transform").evaluate(f,{});return g==="uppercase"?h=h.toLocaleUpperCase():g==="lowercase"&&(h=h.toLocaleLowerCase()),Et.applyArabicShaping&&(h=Et.applyArabicShaping(h)),h}(s.text,e,r)}),t}const Rc={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42"};function F1(t){return t==="\uFE36"||t==="\uFE48"||t==="\uFE38"||t==="\uFE44"||t==="\uFE42"||t==="\uFE3E"||t==="\uFE3C"||t==="\uFE3A"||t==="\uFE18"||t==="\uFE40"||t==="\uFE10"||t==="\uFE13"||t==="\uFE14"||t==="\uFF40"||t==="\uFFE3"||t==="\uFE11"||t==="\uFE12"}function O1(t){return t==="\uFE35"||t==="\uFE47"||t==="\uFE37"||t==="\uFE43"||t==="\uFE41"||t==="\uFE3D"||t==="\uFE3B"||t==="\uFE39"||t==="\uFE17"||t==="\uFE3F"}var Q_=function(t,e,r,s,h){var u,f,g=8*h-s-1,x=(1<<g)-1,w=x>>1,E=-7,I=r?h-1:0,A=r?-1:1,z=t[e+I];for(I+=A,u=z&(1<<-E)-1,z>>=-E,E+=g;E>0;u=256*u+t[e+I],I+=A,E-=8);for(f=u&(1<<-E)-1,u>>=-E,E+=s;E>0;f=256*f+t[e+I],I+=A,E-=8);if(u===0)u=1-w;else{if(u===x)return f?NaN:1/0*(z?-1:1);f+=Math.pow(2,s),u-=w}return(z?-1:1)*f*Math.pow(2,u-s)},eg=function(t,e,r,s,h,u){var f,g,x,w=8*u-h-1,E=(1<<w)-1,I=E>>1,A=h===23?Math.pow(2,-24)-Math.pow(2,-77):0,z=s?0:u-1,R=s?1:-1,O=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(g=isNaN(e)?1:0,f=E):(f=Math.floor(Math.log(e)/Math.LN2),e*(x=Math.pow(2,-f))<1&&(f--,x*=2),(e+=f+I>=1?A/x:A*Math.pow(2,1-I))*x>=2&&(f++,x/=2),f+I>=E?(g=0,f=E):f+I>=1?(g=(e*x-1)*Math.pow(2,h),f+=I):(g=e*Math.pow(2,I-1)*Math.pow(2,h),f=0));h>=8;t[r+z]=255&g,z+=R,g/=256,h-=8);for(f=f<<h|g,w+=h;w>0;t[r+z]=255&f,z+=R,f/=256,w-=8);t[r+z-R]|=128*O},Bc=$t;function $t(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}$t.Varint=0,$t.Fixed64=1,$t.Bytes=2,$t.Fixed32=5;var Up=4294967296,tg=1/Up,ig=typeof TextDecoder=="undefined"?null:new TextDecoder("utf8");function ds(t){return t.type===$t.Bytes?t.readVarint()+t.pos:t.pos+1}function _l(t,e,r){return r?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function rg(t,e,r){var s=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));r.realloc(s);for(var h=r.pos-1;h>=t;h--)r.buf[h+s]=r.buf[h]}function N1(t,e){for(var r=0;r<t.length;r++)e.writeVarint(t[r])}function U1(t,e){for(var r=0;r<t.length;r++)e.writeSVarint(t[r])}function V1(t,e){for(var r=0;r<t.length;r++)e.writeFloat(t[r])}function j1(t,e){for(var r=0;r<t.length;r++)e.writeDouble(t[r])}function $1(t,e){for(var r=0;r<t.length;r++)e.writeBoolean(t[r])}function G1(t,e){for(var r=0;r<t.length;r++)e.writeFixed32(t[r])}function q1(t,e){for(var r=0;r<t.length;r++)e.writeSFixed32(t[r])}function Z1(t,e){for(var r=0;r<t.length;r++)e.writeFixed64(t[r])}function W1(t,e){for(var r=0;r<t.length;r++)e.writeSFixed64(t[r])}function Bu(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function gl(t,e,r){t[r]=e,t[r+1]=e>>>8,t[r+2]=e>>>16,t[r+3]=e>>>24}function ng(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}function X1(t,e,r){e.glyphs=[],t===1&&r.readMessage(H1,e)}function H1(t,e,r){if(t===3){const{id:s,bitmap:h,width:u,height:f,left:g,top:x,advance:w}=r.readMessage(K1,{});e.glyphs.push({id:s,bitmap:new Hs({width:u+6,height:f+6},h),metrics:{width:u,height:f,left:g,top:x,advance:w}})}else t===4?e.ascender=r.readSVarint():t===5&&(e.descender=r.readSVarint())}function K1(t,e,r){t===1?e.id=r.readVarint():t===2?e.bitmap=r.readBytes():t===3?e.width=r.readVarint():t===4?e.height=r.readVarint():t===5?e.left=r.readSVarint():t===6?e.top=r.readSVarint():t===7&&(e.advance=r.readVarint())}function Vp(t){let e=0,r=0;for(const f of t)e+=f.w*f.h,r=Math.max(r,f.w);t.sort((f,g)=>g.h-f.h);const s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),r),h:1/0}];let h=0,u=0;for(const f of t)for(let g=s.length-1;g>=0;g--){const x=s[g];if(!(f.w>x.w||f.h>x.h)){if(f.x=x.x,f.y=x.y,u=Math.max(u,f.y+f.h),h=Math.max(h,f.x+f.w),f.w===x.w&&f.h===x.h){const w=s.pop();g<s.length&&(s[g]=w)}else f.h===x.h?(x.x+=f.w,x.w-=f.w):f.w===x.w?(x.y+=f.h,x.h-=f.h):(s.push({x:x.x+f.w,y:x.y,w:x.w-f.w,h:f.h}),x.y+=f.h,x.h-=f.h);break}}return{w:h,h:u,fill:e/(h*u)||0}}$t.prototype={destroy:function(){this.buf=null},readFields:function(t,e,r){for(r=r||this.length;this.pos<r;){var s=this.readVarint(),h=s>>3,u=this.pos;this.type=7&s,t(h,e,this),this.pos===u&&this.skip(s)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=Bu(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=ng(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=Bu(this.buf,this.pos)+Bu(this.buf,this.pos+4)*Up;return this.pos+=8,t},readSFixed64:function(){var t=Bu(this.buf,this.pos)+ng(this.buf,this.pos+4)*Up;return this.pos+=8,t},readFloat:function(){var t=Q_(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=Q_(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,r,s=this.buf;return e=127&(r=s[this.pos++]),r<128?e:(e|=(127&(r=s[this.pos++]))<<7,r<128?e:(e|=(127&(r=s[this.pos++]))<<14,r<128?e:(e|=(127&(r=s[this.pos++]))<<21,r<128?e:function(h,u,f){var g,x,w=f.buf;if(g=(112&(x=w[f.pos++]))>>4,x<128||(g|=(127&(x=w[f.pos++]))<<3,x<128)||(g|=(127&(x=w[f.pos++]))<<10,x<128)||(g|=(127&(x=w[f.pos++]))<<17,x<128)||(g|=(127&(x=w[f.pos++]))<<24,x<128)||(g|=(1&(x=w[f.pos++]))<<31,x<128))return _l(h,g,u);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(r=s[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&ig?function(r,s,h){return ig.decode(r.subarray(s,h))}(this.buf,e,t):function(r,s,h){for(var u="",f=s;f<h;){var g,x,w,E=r[f],I=null,A=E>239?4:E>223?3:E>191?2:1;if(f+A>h)break;A===1?E<128&&(I=E):A===2?(192&(g=r[f+1]))==128&&(I=(31&E)<<6|63&g)<=127&&(I=null):A===3?(x=r[f+2],(192&(g=r[f+1]))==128&&(192&x)==128&&((I=(15&E)<<12|(63&g)<<6|63&x)<=2047||I>=55296&&I<=57343)&&(I=null)):A===4&&(x=r[f+2],w=r[f+3],(192&(g=r[f+1]))==128&&(192&x)==128&&(192&w)==128&&((I=(15&E)<<18|(63&g)<<12|(63&x)<<6|63&w)<=65535||I>=1114112)&&(I=null)),I===null?(I=65533,A=1):I>65535&&(I-=65536,u+=String.fromCharCode(I>>>10&1023|55296),I=56320|1023&I),u+=String.fromCharCode(I),f+=A}return u}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==$t.Bytes)return t.push(this.readVarint(e));var r=ds(this);for(t=t||[];this.pos<r;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==$t.Bytes)return t.push(this.readSVarint());var e=ds(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==$t.Bytes)return t.push(this.readBoolean());var e=ds(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==$t.Bytes)return t.push(this.readFloat());var e=ds(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==$t.Bytes)return t.push(this.readDouble());var e=ds(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==$t.Bytes)return t.push(this.readFixed32());var e=ds(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==$t.Bytes)return t.push(this.readSFixed32());var e=ds(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==$t.Bytes)return t.push(this.readFixed64());var e=ds(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==$t.Bytes)return t.push(this.readSFixed64());var e=ds(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===$t.Varint)for(;this.buf[this.pos++]>127;);else if(e===$t.Bytes)this.pos=this.readVarint()+this.pos;else if(e===$t.Fixed32)this.pos+=4;else{if(e!==$t.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),gl(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),gl(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),gl(this.buf,-1&t,this.pos),gl(this.buf,Math.floor(t*tg),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),gl(this.buf,-1&t,this.pos),gl(this.buf,Math.floor(t*tg),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(e,r){var s,h;if(e>=0?(s=e%4294967296|0,h=e/4294967296|0):(h=~(-e/4294967296),4294967295^(s=~(-e%4294967296))?s=s+1|0:(s=0,h=h+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(u,f,g){g.buf[g.pos++]=127&u|128,u>>>=7,g.buf[g.pos++]=127&u|128,u>>>=7,g.buf[g.pos++]=127&u|128,u>>>=7,g.buf[g.pos++]=127&u|128,g.buf[g.pos]=127&(u>>>=7)}(s,0,r),function(u,f){var g=(7&u)<<4;f.buf[f.pos++]|=g|((u>>>=3)?128:0),u&&(f.buf[f.pos++]=127&u|((u>>>=7)?128:0),u&&(f.buf[f.pos++]=127&u|((u>>>=7)?128:0),u&&(f.buf[f.pos++]=127&u|((u>>>=7)?128:0),u&&(f.buf[f.pos++]=127&u|((u>>>=7)?128:0),u&&(f.buf[f.pos++]=127&u)))))}(h,r)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(s,h,u){for(var f,g,x=0;x<h.length;x++){if((f=h.charCodeAt(x))>55295&&f<57344){if(!g){f>56319||x+1===h.length?(s[u++]=239,s[u++]=191,s[u++]=189):g=f;continue}if(f<56320){s[u++]=239,s[u++]=191,s[u++]=189,g=f;continue}f=g-55296<<10|f-56320|65536,g=null}else g&&(s[u++]=239,s[u++]=191,s[u++]=189,g=null);f<128?s[u++]=f:(f<2048?s[u++]=f>>6|192:(f<65536?s[u++]=f>>12|224:(s[u++]=f>>18|240,s[u++]=f>>12&63|128),s[u++]=f>>6&63|128),s[u++]=63&f|128)}return u}(this.buf,t,this.pos);var r=this.pos-e;r>=128&&rg(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeFloat:function(t){this.realloc(4),eg(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),eg(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var r=0;r<e;r++)this.buf[this.pos++]=t[r]},writeRawMessage:function(t,e){this.pos++;var r=this.pos;t(e,this);var s=this.pos-r;s>=128&&rg(r,s,this),this.pos=r-1,this.writeVarint(s),this.pos+=s},writeMessage:function(t,e,r){this.writeTag(t,$t.Bytes),this.writeRawMessage(e,r)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,N1,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,U1,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,$1,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,V1,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,j1,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,G1,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,q1,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,Z1,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,W1,e)},writeBytesField:function(t,e){this.writeTag(t,$t.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,$t.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,$t.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,$t.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,$t.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,$t.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,$t.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,$t.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,$t.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,$t.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}};class jp{constructor(e,{pixelRatio:r,version:s,stretchX:h,stretchY:u,content:f}){this.paddedRect=e,this.pixelRatio=r,this.stretchX=h,this.stretchY=u,this.content=f,this.version=s}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class sg{constructor(e,r){const s={},h={};this.haveRenderCallbacks=[];const u=[];this.addImages(e,s,u),this.addImages(r,h,u);const{w:f,h:g}=Vp(u),x=new qr({width:f||1,height:g||1});for(const w in e){const E=e[w],I=s[w].paddedRect;qr.copy(E.data,x,{x:0,y:0},{x:I.x+1,y:I.y+1},E.data)}for(const w in r){const E=r[w],I=h[w].paddedRect,A=I.x+1,z=I.y+1,R=E.data.width,O=E.data.height;qr.copy(E.data,x,{x:0,y:0},{x:A,y:z},E.data),qr.copy(E.data,x,{x:0,y:O-1},{x:A,y:z-1},{width:R,height:1}),qr.copy(E.data,x,{x:0,y:0},{x:A,y:z+O},{width:R,height:1}),qr.copy(E.data,x,{x:R-1,y:0},{x:A-1,y:z},{width:1,height:O}),qr.copy(E.data,x,{x:0,y:0},{x:A+R,y:z},{width:1,height:O})}this.image=x,this.iconPositions=s,this.patternPositions=h}addImages(e,r,s){for(const h in e){const u=e[h],f={x:0,y:0,w:u.data.width+2,h:u.data.height+2};s.push(f),r[h]=new jp(f,u),u.hasRenderCallback&&this.haveRenderCallbacks.push(h)}}patchUpdatedImages(e,r){e.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const s in e.updatedImages)this.patchUpdatedImage(this.iconPositions[s],e.getImage(s),r),this.patchUpdatedImage(this.patternPositions[s],e.getImage(s),r)}patchUpdatedImage(e,r,s){if(!e||!r||e.version===r.version)return;e.version=r.version;const[h,u]=e.tl;s.update(r.data,void 0,{x:h,y:u})}}je("ImagePosition",jp),je("ImageAtlas",sg);const Zr={horizontal:1,vertical:2,horizontalOnly:3};class Fc{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,r){const s=new Fc;return s.scale=e||1,s.fontStack=r,s}static forImage(e){const r=new Fc;return r.imageName=e,r}}class yl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,r){const s=new yl;for(let h=0;h<e.sections.length;h++){const u=e.sections[h];u.image?s.addImageSection(u):s.addTextSection(u,r)}return s}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCharCode(e){return this.text.charCodeAt(e)}verticalizePunctuation(e){this.text=function(r,s){let h="";for(let u=0;u<r.length;u++){const f=r.charCodeAt(u+1)||null,g=r.charCodeAt(u-1)||null;h+=!s&&(f&&Xe(f)&&!Rc[r[u+1]]||g&&Xe(g)&&!Rc[r[u-1]])||!Rc[r[u]]?r[u]:Rc[r[u]]}return h}(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&Fu[this.text.charCodeAt(s)];s++)e++;let r=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&Fu[this.text.charCodeAt(s)];s--)r--;this.text=this.text.substring(e,r),this.sectionIndex=this.sectionIndex.slice(e,r)}substring(e,r){const s=new yl;return s.text=this.text.substring(e,r),s.sectionIndex=this.sectionIndex.slice(e,r),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,r)=>Math.max(e,this.sections[r].scale),0)}addTextSection(e,r){this.text+=e.text,this.sections.push(Fc.forText(e.scale,e.fontStack||r));const s=this.sections.length-1;for(let h=0;h<e.text.length;++h)this.sectionIndex.push(s)}addImageSection(e){const r=e.image?e.image.name:"";if(r.length===0)return void ii("Can't add FormattedSection with an empty image.");const s=this.getNextImageSectionCharCode();s?(this.text+=String.fromCharCode(s),this.sections.push(Fc.forImage(r)),this.sectionIndex.push(this.sections.length-1)):ii("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function $p(t,e,r,s,h,u,f,g,x,w,E,I,A,z,R,O){const U=yl.fromFeature(t,h);let Z;I===Zr.vertical&&U.verticalizePunctuation(A);const{processBidirectionalText:Q,processStyledBidirectionalText:ne}=Et;if(Q&&U.sections.length===1){Z=[];const le=Q(U.toString(),Gp(U,w,u,e,s,z,R));for(const we of le){const ve=new yl;ve.text=we,ve.sections=U.sections;for(let Fe=0;Fe<we.length;Fe++)ve.sectionIndex.push(0);Z.push(ve)}}else if(ne){Z=[];const le=ne(U.text,U.sectionIndex,Gp(U,w,u,e,s,z,R));for(const we of le){const ve=new yl;ve.text=we[0],ve.sectionIndex=we[1],ve.sections=U.sections,Z.push(ve)}}else Z=function(le,we){const ve=[],Fe=le.text;let Pe=0;for(const be of we)ve.push(le.substring(Pe,be)),Pe=be;return Pe<Fe.length&&ve.push(le.substring(Pe,Fe.length)),ve}(U,Gp(U,w,u,e,s,z,R));const oe=[],ae={positionedLines:oe,text:U.toString(),top:E[1],bottom:E[1],left:E[0],right:E[0],writingMode:I,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(le,we,ve,Fe,Pe,be,Le,Oe,Ie,Ve,qe,wt){let Gt=0,St=0,It=0;const De=Oe==="right"?1:Oe==="left"?0:.5;let zt=!1;for(const Pt of Pe){const bt=Pt.getSections();for(const Qt of bt){if(Qt.imageName)continue;const xi=we[Qt.fontStack];if(xi&&(zt=xi.ascender!==void 0&&xi.descender!==void 0,!zt))break}if(!zt)break}let Ct=0;for(const Pt of Pe){Pt.trim();const bt=Pt.getMaxScale(),Qt=(bt-1)*Ni,xi={positionedGlyphs:[],lineOffset:0};le.positionedLines[Ct]=xi;const ci=xi.positionedGlyphs;let bi=0;if(!Pt.length()){St+=be,++Ct;continue}let Ui=0,_r=0;for(let Jt=0;Jt<Pt.length();Jt++){const Ci=Pt.getSection(Jt),ln=Pt.getSectionIndex(Jt),Oi=Pt.getCharCode(Jt);let Nt=Ci.scale,Mi=null,ei=null,Wi=null,wi=Ni,Xi=0;const or=!(Ie===Zr.horizontal||!qe&&!Ee(Oi)||qe&&(Fu[Oi]||(yi=Oi,i(yi)||l(yi)||p(yi)||te(yi)||ke(yi))));if(Ci.imageName){const ar=Fe[Ci.imageName];if(!ar)continue;Wi=Ci.imageName,le.iconsInText=le.iconsInText||!0,ei=ar.paddedRect;const ki=ar.displaySize;Nt=Nt*Ni/wt,Mi={width:ki[0],height:ki[1],left:1,top:-3,advance:or?ki[1]:ki[0],localGlyph:!1},Xi=zt?-Mi.height*Nt:bt*Ni-17-ki[1]*Nt,wi=Mi.advance;const Tn=(or?ki[0]:ki[1])*Nt-Ni*bt;Tn>0&&Tn>bi&&(bi=Tn)}else{const ar=ve[Ci.fontStack];if(!ar)continue;ar[Oi]&&(ei=ar[Oi]);const ki=we[Ci.fontStack];if(!ki)continue;const Tn=ki.glyphs[Oi];if(!Tn)continue;if(Mi=Tn.metrics,wi=Oi!==8203?Ni:0,zt){const El=ki.ascender!==void 0?Math.abs(ki.ascender):0,Gc=ki.descender!==void 0?Math.abs(ki.descender):0,qc=(El+Gc)*Nt;Ui<qc&&(Ui=qc,_r=(El-Gc)/2*Nt),Xi=-El*Nt}else Xi=(bt-Nt)*Ni-17}or?(le.verticalizable=!0,ci.push({glyph:Oi,imageName:Wi,x:Gt,y:St+Xi,vertical:or,scale:Nt,localGlyph:Mi.localGlyph,fontStack:Ci.fontStack,sectionIndex:ln,metrics:Mi,rect:ei}),Gt+=wi*Nt+Ve):(ci.push({glyph:Oi,imageName:Wi,x:Gt,y:St+Xi,vertical:or,scale:Nt,localGlyph:Mi.localGlyph,fontStack:Ci.fontStack,sectionIndex:ln,metrics:Mi,rect:ei}),Gt+=Mi.advance*Nt+Ve)}ci.length!==0&&(It=Math.max(Gt-Ve,It),zt?hg(ci,De,bi,_r,be*bt/2):hg(ci,De,bi,0,be/2)),Gt=0;const gr=be*bt+bi;xi.lineOffset=Math.max(bi,Qt),St+=gr,++Ct}var yi;const ai=St,{horizontalAlign:Ai,verticalAlign:Zi}=qp(Le);(function(Pt,bt,Qt,xi,ci,bi){const Ui=(bt-Qt)*ci,_r=-bi*xi;for(const gr of Pt)for(const Jt of gr.positionedGlyphs)Jt.x+=Ui,Jt.y+=_r})(le.positionedLines,De,Ai,Zi,It,ai),le.top+=-Zi*ai,le.bottom=le.top+ai,le.left+=-Ai*It,le.right=le.left+It,le.hasBaseline=zt}(ae,e,r,s,Z,f,g,x,I,w,A,O),!function(le){for(const we of le)if(we.positionedGlyphs.length!==0)return!1;return!0}(oe)&&ae}const Fu={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Y1={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function og(t,e,r,s,h,u){if(e.imageName){const f=s[e.imageName];return f?f.displaySize[0]*e.scale*Ni/u+h:0}{const f=r[e.fontStack],g=f&&f.glyphs[t];return g?g.metrics.advance*e.scale+h:0}}function ag(t,e,r,s){const h=Math.pow(t-e,2);return s?t<e?h/2:2*h:h+Math.abs(r)*r}function J1(t,e,r){let s=0;return t===10&&(s-=1e4),r&&(s+=150),t!==40&&t!==65288||(s+=50),e!==41&&e!==65289||(s+=50),s}function lg(t,e,r,s,h,u){let f=null,g=ag(e,r,h,u);for(const x of s){const w=ag(e-x.x,r,h,u)+x.badness;w<=g&&(f=x,g=w)}return{index:t,x:e,priorBreak:f,badness:g}}function cg(t){return t?cg(t.priorBreak).concat(t.index):[]}function Gp(t,e,r,s,h,u,f){if(u!=="point")return[];if(!t)return[];const g=[],x=function(A,z,R,O,U,Z){let Q=0;for(let ne=0;ne<A.length();ne++){const oe=A.getSection(ne);Q+=og(A.getCharCode(ne),oe,O,U,z,Z)}return Q/Math.max(1,Math.ceil(Q/R))}(t,e,r,s,h,f),w=t.text.indexOf("\u200B")>=0;let E=0;for(let A=0;A<t.length();A++){const z=t.getSection(A),R=t.getCharCode(A);if(Fu[R]||(E+=og(R,z,s,h,e,f)),A<t.length()-1){const O=!((I=R)<11904||!(P(I)||k(I)||_e(I)||K(I)||$(I)||_(I)||F(I)||T(I)||ee(I)||V(I)||N(I)||Ce(I)||C(I)||b(I)||y(I)||j(I)||M(I)||de(I)||J(I)||Y(I)));(Y1[R]||O||z.imageName)&&g.push(lg(A+1,E,x,g,J1(R,t.getCharCode(A+1),O&&w),!1))}}var I;return cg(lg(t.length(),E,x,g,0,!0))}function qp(t){let e=.5,r=.5;switch(t){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(t){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:e,verticalAlign:r}}function hg(t,e,r,s,h){if(!(e||r||s||h))return;const u=t.length-1,f=t[u],g=(f.x+f.metrics.advance*f.scale)*e;for(let x=0;x<=u;x++)t[x].x-=g,t[x].y+=r+s+h}function Q1(t,e,r){const{horizontalAlign:s,verticalAlign:h}=qp(r),u=e[0]-t.displaySize[0]*s,f=e[1]-t.displaySize[1]*h;return{image:t,top:f,bottom:f+t.displaySize[1],left:u,right:u+t.displaySize[0]}}function ug(t,e,r,s,h,u){const f=t.image;let g;if(f.content){const U=f.content,Z=f.pixelRatio||1;g=[U[0]/Z,U[1]/Z,f.displaySize[0]-U[2]/Z,f.displaySize[1]-U[3]/Z]}const x=e.left*u,w=e.right*u;let E,I,A,z;r==="width"||r==="both"?(z=h[0]+x-s[3],I=h[0]+w+s[1]):(z=h[0]+(x+w-f.displaySize[0])/2,I=z+f.displaySize[0]);const R=e.top*u,O=e.bottom*u;return r==="height"||r==="both"?(E=h[1]+R-s[0],A=h[1]+O+s[2]):(E=h[1]+(R+O-f.displaySize[1])/2,A=E+f.displaySize[1]),{image:f,top:E,right:I,bottom:A,left:z,collisionPadding:g}}class ps extends ue{constructor(e,r,s,h,u){super(e,r),this.angle=h,this.z=s,u!==void 0&&(this.segment=u)}clone(){return new ps(this.x,this.y,this.z,this.angle,this.segment)}}function dg(t,e,r,s,h){if(e.segment===void 0)return!0;let u=e,f=e.segment+1,g=0;for(;g>-r/2;){if(f--,f<0)return!1;g-=t[f].dist(u),u=t[f]}g+=t[f].dist(t[f+1]),f++;const x=[];let w=0;for(;g<r/2;){const E=t[f],I=t[f+1];if(!I)return!1;let A=t[f-1].angleTo(E)-E.angleTo(I);for(A=Math.abs((A+3*Math.PI)%(2*Math.PI)-Math.PI),x.push({distance:g,angleDelta:A}),w+=A;g-x[0].distance>s;)w-=x.shift().angleDelta;if(w>h)return!1;f++,g+=E.dist(I)}return!0}function pg(t){let e=0;for(let r=0;r<t.length-1;r++)e+=t[r].dist(t[r+1]);return e}function fg(t,e,r){return t?.6*e*r:0}function mg(t,e){return Math.max(t?t.right-t.left:0,e?e.right-e.left:0)}function eb(t,e,r,s,h,u){const f=fg(r,h,u),g=mg(r,s)*u;let x=0;const w=pg(t)/2;for(let E=0;E<t.length-1;E++){const I=t[E],A=t[E+1],z=I.dist(A);if(x+z>w){const R=(w-x)/z,O=Lt(I.x,A.x,R),U=Lt(I.y,A.y,R),Z=new ps(O,U,0,A.angleTo(I),E);return!f||dg(t,Z,g,f,e)?Z:void 0}x+=z}}function tb(t,e,r,s,h,u,f,g,x){const w=fg(s,u,f),E=mg(s,h),I=E*f,A=t[0].x===0||t[0].x===x||t[0].y===0||t[0].y===x;return e-I<e/4&&(e=I+e/4),_g(t,A?e/2*g%e:(E/2+2*u)*f*g%e,e,w,r,I,A,!1,x)}function _g(t,e,r,s,h,u,f,g,x){const w=u/2,E=pg(t);let I=0,A=e-r,z=[];for(let R=0;R<t.length-1;R++){const O=t[R],U=t[R+1],Z=O.dist(U),Q=U.angleTo(O);for(;A+r<I+Z;){A+=r;const ne=(A-I)/Z,oe=Lt(O.x,U.x,ne),ae=Lt(O.y,U.y,ne);if(oe>=0&&oe<x&&ae>=0&&ae<x&&A-w>=0&&A+w<=E){const le=new ps(oe,ae,0,Q,R);le._round(),s&&!dg(t,le,u,s,h)||z.push(le)}}I+=Z}return g||z.length||f||(z=_g(t,I/2,r,s,h,u,f,!0,x)),z}function gg(t,e,r,s,h){const u=[];for(let f=0;f<t.length;f++){const g=t[f];let x;for(let w=0;w<g.length-1;w++){let E=g[w],I=g[w+1];E.x<e&&I.x<e||(E.x<e?E=new ue(e,E.y+(e-E.x)/(I.x-E.x)*(I.y-E.y))._round():I.x<e&&(I=new ue(e,E.y+(e-E.x)/(I.x-E.x)*(I.y-E.y))._round()),E.y<r&&I.y<r||(E.y<r?E=new ue(E.x+(r-E.y)/(I.y-E.y)*(I.x-E.x),r)._round():I.y<r&&(I=new ue(E.x+(r-E.y)/(I.y-E.y)*(I.x-E.x),r)._round()),E.x>=s&&I.x>=s||(E.x>=s?E=new ue(s,E.y+(s-E.x)/(I.x-E.x)*(I.y-E.y))._round():I.x>=s&&(I=new ue(s,E.y+(s-E.x)/(I.x-E.x)*(I.y-E.y))._round()),E.y>=h&&I.y>=h||(E.y>=h?E=new ue(E.x+(h-E.y)/(I.y-E.y)*(I.x-E.x),h)._round():I.y>=h&&(I=new ue(E.x+(h-E.y)/(I.y-E.y)*(I.x-E.x),h)._round()),x&&E.equals(x[x.length-1])||(x=[E],u.push(x)),x.push(I)))))}}return u}je("Anchor",ps);const Oc=1e20;function yg(t,e,r,s,h,u,f,g,x){for(let w=e;w<e+s;w++)xg(t,r*u+w,u,h,f,g,x);for(let w=r;w<r+h;w++)xg(t,w*u+e,1,s,f,g,x)}function xg(t,e,r,s,h,u,f){u[0]=0,f[0]=-Oc,f[1]=Oc,h[0]=t[e];for(let g=1,x=0,w=0;g<s;g++){h[g]=t[e+g*r];const E=g*g;do{const I=u[x];w=(h[g]-h[I]+E-I*I)/(g-I)/2}while(w<=f[x]&&--x>-1);x++,u[x]=g,f[x]=w,f[x+1]=Oc}for(let g=0,x=0;g<s;g++){for(;f[x+1]<g;)x++;const w=u[x],E=g-w;t[e+g*r]=h[w]+E*E}}const Zp={none:0,ideographs:1,all:2};class xl{constructor(e,r,s){this.requestManager=e,this.localGlyphMode=r,this.localFontFamily=s,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,r){const s=[];for(const h in e)for(const u of e[h])s.push({stack:h,id:u});es(s,({stack:h,id:u},f)=>{let g=this.entries[h];g||(g=this.entries[h]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let x=g.glyphs[u];if(x!==void 0)return void f(null,{stack:h,id:u,glyph:x});if(x=this._tinySDF(g,h,u),x)return g.glyphs[u]=x,void f(null,{stack:h,id:u,glyph:x});const w=Math.floor(u/256);if(256*w>65535)return void f(new Error("glyphs > 65535 not supported"));if(g.ranges[w])return void f(null,{stack:h,id:u,glyph:x});let E=g.requests[w];E||(E=g.requests[w]=[],xl.loadGlyphRange(h,w,this.url,this.requestManager,(I,A)=>{if(A){g.ascender=A.ascender,g.descender=A.descender;for(const z in A.glyphs)this._doesCharSupportLocalGlyph(+z)||(g.glyphs[+z]=A.glyphs[+z]);g.ranges[w]=!0}for(const z of E)z(I,A);delete g.requests[w]})),E.push((I,A)=>{I?f(I):A&&f(null,{stack:h,id:u,glyph:A.glyphs[u]||null})})},(h,u)=>{if(h)r(h);else if(u){const f={};for(const{stack:g,id:x,glyph:w}of u)f[g]===void 0&&(f[g]={}),f[g].glyphs===void 0&&(f[g].glyphs={}),f[g].glyphs[x]=w&&{id:w.id,bitmap:w.bitmap.clone(),metrics:w.metrics},f[g].ascender=this.entries[g].ascender,f[g].descender=this.entries[g].descender;r(null,f)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Zp.none&&(this.localGlyphMode===Zp.all?!!this.localFontFamily:!!this.localFontFamily&&(V(e)||H(e)||C(e)||M(e))||T(e))}_tinySDF(e,r,s){const h=this.localFontFamily;if(!h||!this._doesCharSupportLocalGlyph(s))return;let u=e.tinySDF;if(!u){let O="400";/bold/i.test(r)?O="900":/medium/i.test(r)?O="500":/light/i.test(r)&&(O="200"),u=e.tinySDF=new xl.TinySDF({fontFamily:h,fontWeight:O,fontSize:48,buffer:6,radius:16}),u.fontWeight=O}if(this.localGlyphs[u.fontWeight][s])return this.localGlyphs[u.fontWeight][s];const f=String.fromCharCode(s),{data:g,width:x,height:w,glyphWidth:E,glyphHeight:I,glyphLeft:A,glyphTop:z,glyphAdvance:R}=u.draw(f);return this.localGlyphs[u.fontWeight][s]={id:s,bitmap:new Hs({width:x,height:w},g),metrics:{width:E/2,height:I/2,left:A/2,top:z/2-27,advance:R/2,localGlyph:!0}}}}function vg(t,e,r,s){const h=[],u=t.image,f=u.pixelRatio,g=u.paddedRect.w-2,x=u.paddedRect.h-2,w=t.right-t.left,E=t.bottom-t.top,I=u.stretchX||[[0,g]],A=u.stretchY||[[0,x]],z=(be,Le)=>be+Le[1]-Le[0],R=I.reduce(z,0),O=A.reduce(z,0),U=g-R,Z=x-O;let Q=0,ne=R,oe=0,ae=O,le=0,we=U,ve=0,Fe=Z;if(u.content&&s){const be=u.content;Q=Ou(I,0,be[0]),oe=Ou(A,0,be[1]),ne=Ou(I,be[0],be[2]),ae=Ou(A,be[1],be[3]),le=be[0]-Q,ve=be[1]-oe,we=be[2]-be[0]-ne,Fe=be[3]-be[1]-ae}const Pe=(be,Le,Oe,Ie)=>{const Ve=Nu(be.stretch-Q,ne,w,t.left),qe=Uu(be.fixed-le,we,be.stretch,R),wt=Nu(Le.stretch-oe,ae,E,t.top),Gt=Uu(Le.fixed-ve,Fe,Le.stretch,O),St=Nu(Oe.stretch-Q,ne,w,t.left),It=Uu(Oe.fixed-le,we,Oe.stretch,R),De=Nu(Ie.stretch-oe,ae,E,t.top),zt=Uu(Ie.fixed-ve,Fe,Ie.stretch,O),Ct=new ue(Ve,wt),yi=new ue(St,wt),ai=new ue(St,De),Ai=new ue(Ve,De),Zi=new ue(qe/f,Gt/f),Pt=new ue(It/f,zt/f),bt=e*Math.PI/180;if(bt){const ci=Math.sin(bt),bi=Math.cos(bt),Ui=[bi,-ci,ci,bi];Ct._matMult(Ui),yi._matMult(Ui),Ai._matMult(Ui),ai._matMult(Ui)}const Qt=be.stretch+be.fixed,xi=Le.stretch+Le.fixed;return{tl:Ct,tr:yi,bl:Ai,br:ai,tex:{x:u.paddedRect.x+1+Qt,y:u.paddedRect.y+1+xi,w:Oe.stretch+Oe.fixed-Qt,h:Ie.stretch+Ie.fixed-xi},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Zi,pixelOffsetBR:Pt,minFontScaleX:we/f/w,minFontScaleY:Fe/f/E,isSDF:r}};if(s&&(u.stretchX||u.stretchY)){const be=bg(I,U,R),Le=bg(A,Z,O);for(let Oe=0;Oe<be.length-1;Oe++){const Ie=be[Oe],Ve=be[Oe+1];for(let qe=0;qe<Le.length-1;qe++)h.push(Pe(Ie,Le[qe],Ve,Le[qe+1]))}}else h.push(Pe({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:g+1},{fixed:0,stretch:x+1}));return h}function Ou(t,e,r){let s=0;for(const h of t)s+=Math.max(e,Math.min(r,h[1]))-Math.max(e,Math.min(r,h[0]));return s}function bg(t,e,r){const s=[{fixed:-1,stretch:0}];for(const[h,u]of t){const f=s[s.length-1];s.push({fixed:h-f.stretch,stretch:f.stretch}),s.push({fixed:h-f.stretch,stretch:f.stretch+(u-h)})}return s.push({fixed:e+1,stretch:r}),s}function Nu(t,e,r,s){return t/e*r+s}function Uu(t,e,r,s){return t-e*r/s}function ib(t,e,r,s){const h=e+t.positionedLines[s].lineOffset;return s===0?r+h/2:r+(h+(e+t.positionedLines[s-1].lineOffset))/2}xl.loadGlyphRange=function(t,e,r,s,h){const u=256*e,f=u+255,g=s.transformRequest(s.normalizeGlyphsURL(r).replace("{fontstack}",t).replace("{range}",`${u}-${f}`),Sa.Glyphs);bo(g,(x,w)=>{if(x)h(x);else if(w){const E={},I=function(A){return new Bc(A).readFields(X1,{})}(w);for(const A of I.glyphs)E[A.id]=A;h(null,{glyphs:E,ascender:I.ascender,descender:I.descender})}})},xl.TinySDF=class{constructor({fontSize:t=24,buffer:e=3,radius:r=8,cutoff:s=.25,fontFamily:h="sans-serif",fontWeight:u="normal",fontStyle:f="normal"}){this.buffer=e,this.cutoff=s,this.radius=r;const g=this.size=t+4*e,x=this._createCanvas(g),w=this.ctx=x.getContext("2d",{willReadFrequently:!0});w.font=`${f} ${u} ${t}px ${h}`,w.textBaseline="alphabetic",w.textAlign="left",w.fillStyle="black",this.gridOuter=new Float64Array(g*g),this.gridInner=new Float64Array(g*g),this.f=new Float64Array(g),this.z=new Float64Array(g+1),this.v=new Uint16Array(g)}_createCanvas(t){const e=document.createElement("canvas");return e.width=e.height=t,e}draw(t){const{width:e,actualBoundingBoxAscent:r,actualBoundingBoxDescent:s,actualBoundingBoxLeft:h,actualBoundingBoxRight:u}=this.ctx.measureText(t),f=Math.floor(r),g=Math.min(this.size-this.buffer,Math.ceil(u-h)),x=Math.min(this.size-this.buffer,Math.ceil(r)+Math.ceil(s)),w=g+2*this.buffer,E=x+2*this.buffer,I=w*E,A=new Uint8ClampedArray(I),z={data:A,width:w,height:E,glyphWidth:g,glyphHeight:x,glyphTop:f,glyphLeft:0,glyphAdvance:e};if(g===0||x===0)return z;const{ctx:R,buffer:O,gridInner:U,gridOuter:Z}=this;R.clearRect(O,O,g,x),R.fillText(t,O,O+f+1);const Q=R.getImageData(O,O,g,x);Z.fill(Oc,0,I),U.fill(0,0,I);for(let ne=0;ne<x;ne++)for(let oe=0;oe<g;oe++){const ae=Q.data[4*(ne*g+oe)+3]/255;if(ae===0)continue;const le=(ne+O)*w+oe+O;if(ae===1)Z[le]=0,U[le]=Oc;else{const we=.5-ae;Z[le]=we>0?we*we:0,U[le]=we<0?we*we:0}}yg(Z,0,0,w,E,w,this.f,this.v,this.z),yg(U,O,O,g,x,w,this.f,this.v,this.z);for(let ne=0;ne<I;ne++){const oe=Math.sqrt(Z[ne])-Math.sqrt(U[ne]);A[ne]=Math.round(255-255*(oe/this.radius+this.cutoff))}return z}};class rb{constructor(e=[],r=nb){if(this.data=e,this.length=this.data.length,this.compare=r,this.length>0)for(let s=(this.length>>1)-1;s>=0;s--)this._down(s)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const e=this.data[0],r=this.data.pop();return this.length--,this.length>0&&(this.data[0]=r,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:r,compare:s}=this,h=r[e];for(;e>0;){const u=e-1>>1,f=r[u];if(s(h,f)>=0)break;r[e]=f,e=u}r[e]=h}_down(e){const{data:r,compare:s}=this,h=this.length>>1,u=r[e];for(;e<h;){let f=1+(e<<1),g=r[f];const x=f+1;if(x<this.length&&s(r[x],g)<0&&(f=x,g=r[x]),s(g,u)>=0)break;r[e]=g,e=f}r[e]=u}}function nb(t,e){return t<e?-1:t>e?1:0}function sb(t,e=1,r=!1){let s=1/0,h=1/0,u=-1/0,f=-1/0;const g=t[0];for(let z=0;z<g.length;z++){const R=g[z];(!z||R.x<s)&&(s=R.x),(!z||R.y<h)&&(h=R.y),(!z||R.x>u)&&(u=R.x),(!z||R.y>f)&&(f=R.y)}const x=Math.min(u-s,f-h);let w=x/2;const E=new rb([],ob);if(x===0)return new ue(s,h);for(let z=s;z<u;z+=x)for(let R=h;R<f;R+=x)E.push(new vl(z+w,R+w,w,t));let I=function(z){let R=0,O=0,U=0;const Z=z[0];for(let Q=0,ne=Z.length,oe=ne-1;Q<ne;oe=Q++){const ae=Z[Q],le=Z[oe],we=ae.x*le.y-le.x*ae.y;O+=(ae.x+le.x)*we,U+=(ae.y+le.y)*we,R+=3*we}return new vl(O/R,U/R,0,z)}(t),A=E.length;for(;E.length;){const z=E.pop();(z.d>I.d||!I.d)&&(I=z,r&&console.log("found best %d after %d probes",Math.round(1e4*z.d)/1e4,A)),z.max-I.d<=e||(w=z.h/2,E.push(new vl(z.p.x-w,z.p.y-w,w,t)),E.push(new vl(z.p.x+w,z.p.y-w,w,t)),E.push(new vl(z.p.x-w,z.p.y+w,w,t)),E.push(new vl(z.p.x+w,z.p.y+w,w,t)),A+=4)}return r&&(console.log(`num probes: ${A}`),console.log(`best distance: ${I.d}`)),I.p}function ob(t,e){return e.max-t.max}function vl(t,e,r,s){this.p=new ue(t,e),this.h=r,this.d=function(h,u){let f=!1,g=1/0;for(let x=0;x<u.length;x++){const w=u[x];for(let E=0,I=w.length,A=I-1;E<I;A=E++){const z=w[E],R=w[A];z.y>h.y!=R.y>h.y&&h.x<(R.x-z.x)*(h.y-z.y)/(R.y-z.y)+z.x&&(f=!f),g=Math.min(g,M_(h,z,R))}}return(f?1:-1)*Math.sqrt(g)}(this.p,s),this.max=this.d+this.h*Math.SQRT2}const Wp=Number.POSITIVE_INFINITY,ab=Math.sqrt(2);function wg(t,e){return e[1]!==Wp?function(r,s,h){let u=0,f=0;switch(s=Math.abs(s),h=Math.abs(h),r){case"top-right":case"top-left":case"top":f=h-7;break;case"bottom-right":case"bottom-left":case"bottom":f=7-h}switch(r){case"top-right":case"bottom-right":case"right":u=-s;break;case"top-left":case"bottom-left":case"left":u=s}return[u,f]}(t,e[0],e[1]):function(r,s){let h=0,u=0;s<0&&(s=0);const f=s/ab;switch(r){case"top-right":case"top-left":u=f-7;break;case"bottom-right":case"bottom-left":u=7-f;break;case"bottom":u=7-s;break;case"top":u=s-7}switch(r){case"top-right":case"bottom-right":h=-f;break;case"top-left":case"bottom-left":h=f;break;case"left":h=s;break;case"right":h=-s}return[h,u]}(t,e[0])}function lb(t,e,r,s,h,u,f,g,x,w){t.createArrays(),t.tilePixelRatio=yt/(512*t.overscaling),t.compareText={},t.iconsNeedLinear=!1;const E=t.layers[0].layout,I=t.layers[0]._unevaluatedLayout._values,A={};if(t.textSizeData.kind==="composite"){const{minZoom:O,maxZoom:U}=t.textSizeData;A.compositeTextSizes=[I["text-size"].possiblyEvaluate(new ot(O),g),I["text-size"].possiblyEvaluate(new ot(U),g)]}if(t.iconSizeData.kind==="composite"){const{minZoom:O,maxZoom:U}=t.iconSizeData;A.compositeIconSizes=[I["icon-size"].possiblyEvaluate(new ot(O),g),I["icon-size"].possiblyEvaluate(new ot(U),g)]}A.layoutTextSize=I["text-size"].possiblyEvaluate(new ot(x+1),g),A.layoutIconSize=I["icon-size"].possiblyEvaluate(new ot(x+1),g),A.textMaxSize=I["text-size"].possiblyEvaluate(new ot(18),g);const z=E.get("text-rotation-alignment")==="map"&&E.get("symbol-placement")!=="point",R=E.get("text-size");for(const O of t.features){const U=E.get("text-font").evaluate(O,{},g).join(","),Z=R.evaluate(O,{},g),Q=A.layoutTextSize.evaluate(O,{},g),ne=(A.layoutIconSize.evaluate(O,{},g),{horizontal:{},vertical:void 0}),oe=O.text;let ae,le=[0,0];if(oe){const Fe=oe.toString(),Pe=E.get("text-letter-spacing").evaluate(O,{},g)*Ni,be=E.get("text-line-height").evaluate(O,{},g)*Ni,Le=me(Fe)?Pe:0,Oe=E.get("text-anchor").evaluate(O,{},g),Ie=E.get("text-variable-anchor");if(!Ie){const It=E.get("text-radial-offset").evaluate(O,{},g);le=It?wg(Oe,[It*Ni,Wp]):E.get("text-offset").evaluate(O,{},g).map(De=>De*Ni)}let Ve=z?"center":E.get("text-justify").evaluate(O,{},g);const qe=E.get("symbol-placement"),wt=qe==="point",Gt=qe==="point"?E.get("text-max-width").evaluate(O,{},g)*Ni:0,St=It=>{t.allowVerticalPlacement&&xe(Fe)&&(ne.vertical=$p(oe,e,r,h,U,Gt,be,Oe,It,Le,le,Zr.vertical,!0,qe,Q,Z))};if(!z&&Ie){const It=Ve==="auto"?Ie.map(zt=>Xp(zt)):[Ve];let De=!1;for(let zt=0;zt<It.length;zt++){const Ct=It[zt];if(!ne.horizontal[Ct])if(De)ne.horizontal[Ct]=ne.horizontal[0];else{const yi=$p(oe,e,r,h,U,Gt,be,"center",Ct,Le,le,Zr.horizontal,!1,qe,Q,Z);yi&&(ne.horizontal[Ct]=yi,De=yi.positionedLines.length===1)}}St("left")}else{if(Ve==="auto"&&(Ve=Xp(Oe)),wt||E.get("text-writing-mode").indexOf("horizontal")>=0||!xe(Fe)){const It=$p(oe,e,r,h,U,Gt,be,Oe,Ve,Le,le,Zr.horizontal,!1,qe,Q,Z);It&&(ne.horizontal[Ve]=It)}St(qe==="point"?"left":Ve)}}let we=!1;if(O.icon&&O.icon.name){const Fe=s[O.icon.name];Fe&&(ae=Q1(h[O.icon.name],E.get("icon-offset").evaluate(O,{},g),E.get("icon-anchor").evaluate(O,{},g)),we=Fe.sdf,t.sdfIcons===void 0?t.sdfIcons=Fe.sdf:t.sdfIcons!==Fe.sdf&&ii("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Fe.pixelRatio!==t.pixelRatio||E.get("icon-rotate").constantOr(1)!==0)&&(t.iconsNeedLinear=!0))}const ve=Eg(ne.horizontal)||ne.vertical;t.iconsInText||(t.iconsInText=!!ve&&ve.iconsInText),(ve||ae)&&cb(t,O,ne,ae,s,A,Q,0,le,we,f,g,w)}u&&t.generateCollisionDebugBuffers(x,t.collisionBoxArray)}function Xp(t){switch(t){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function cb(t,e,r,s,h,u,f,g,x,w,E,I,A){let z=u.textMaxSize.evaluate(e,{},I);z===void 0&&(z=f);const R=t.layers[0].layout,O=R.get("icon-offset").evaluate(e,{},I),U=Eg(r.horizontal)||r.vertical,Z=f/24,Q=t.tilePixelRatio*z/24,ne=t.tilePixelRatio*R.get("symbol-spacing"),oe=R.get("text-padding")*t.tilePixelRatio,ae=R.get("icon-padding")*t.tilePixelRatio,le=gt(R.get("text-max-angle")),we=R.get("text-rotation-alignment")==="map"&&R.get("symbol-placement")!=="point",ve=R.get("icon-rotation-alignment")==="map"&&R.get("symbol-placement")!=="point",Fe=R.get("symbol-placement"),Pe=ne/2,be=R.get("icon-text-fit");let Le;s&&be!=="none"&&(t.allowVerticalPlacement&&r.vertical&&(Le=ug(s,r.vertical,be,R.get("icon-text-fit-padding"),O,Z)),U&&(s=ug(s,U,be,R.get("icon-text-fit-padding"),O,Z)));const Oe=(Ie,Ve,qe)=>{if(Ve.x<0||Ve.x>=yt||Ve.y<0||Ve.y>=yt)return;const{x:wt,y:Gt,z:St}=A.projectTilePoint(Ve.x,Ve.y,qe),It=new ps(wt,Gt,St,0,void 0);(function(De,zt,Ct,yi,ai,Ai,Zi,Pt,bt,Qt,xi,ci,bi,Ui,_r,gr,Jt,Ci,ln,Oi,Nt,Mi,ei,Wi,wi){const Xi=De.addToLineVertexArray(zt,yi);let or,ar,ki,Tn,El,Gc,qc,sy=0,oy=0,ay=0,ly=0,ff=-1,mf=-1;const Wn={};let cy=Ac(""),_f=0,gf=0;if(bt._unevaluatedLayout.getValue("text-radial-offset")===void 0?[_f,gf]=bt.layout.get("text-offset").evaluate(Nt,{},wi).map(Pr=>Pr*Ni):(_f=bt.layout.get("text-radial-offset").evaluate(Nt,{},wi)*Ni,gf=Wp),De.allowVerticalPlacement&&ai.vertical){const Pr=ai.vertical;if(_r)Gc=Hp(Pr),Pt&&(qc=Hp(Pt));else{const Lr=bt.layout.get("text-rotate").evaluate(Nt,{},wi)+90;ki=Vu(Qt,Ct,zt,xi,ci,bi,Pr,Ui,Lr,gr),Pt&&(Tn=Vu(Qt,Ct,zt,xi,ci,bi,Pt,Ci,Lr))}}if(Ai){const Pr=bt.layout.get("icon-rotate").evaluate(Nt,{},wi),Lr=bt.layout.get("icon-text-fit")!=="none",Zc=vg(Ai,Pr,ei,Lr),xf=Pt?vg(Pt,Pr,ei,Lr):void 0;ar=Vu(Qt,Ct,zt,xi,ci,bi,Ai,Ci,Pr),sy=4*Zc.length;const hy=De.iconSizeData;let ta=null;hy.kind==="source"?(ta=[$n*bt.layout.get("icon-size").evaluate(Nt,{},wi)],ta[0]>Ys&&ii(`${De.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):hy.kind==="composite"&&(ta=[$n*Mi.compositeIconSizes[0].evaluate(Nt,{},wi),$n*Mi.compositeIconSizes[1].evaluate(Nt,{},wi)],(ta[0]>Ys||ta[1]>Ys)&&ii(`${De.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),De.addSymbols(De.icon,Zc,ta,Oi,ln,Nt,!1,Ct,zt,Xi.lineStartIndex,Xi.lineLength,-1,Wi,wi),ff=De.icon.placedSymbolArray.length-1,xf&&(oy=4*xf.length,De.addSymbols(De.icon,xf,ta,Oi,ln,Nt,Zr.vertical,Ct,zt,Xi.lineStartIndex,Xi.lineLength,-1,Wi,wi),mf=De.icon.placedSymbolArray.length-1)}for(const Pr in ai.horizontal){const Lr=ai.horizontal[Pr];or||(cy=Ac(Lr.text),_r?El=Hp(Lr):or=Vu(Qt,Ct,zt,xi,ci,bi,Lr,Ui,bt.layout.get("text-rotate").evaluate(Nt,{},wi),gr));const Zc=Lr.positionedLines.length===1;if(ay+=Tg(De,Ct,zt,Lr,Zi,bt,_r,Nt,gr,Xi,ai.vertical?Zr.horizontal:Zr.horizontalOnly,Zc?Object.keys(ai.horizontal):[Pr],Wn,ff,Mi,Wi,wi),Zc)break}ai.vertical&&(ly+=Tg(De,Ct,zt,ai.vertical,Zi,bt,_r,Nt,gr,Xi,Zr.vertical,["vertical"],Wn,mf,Mi,Wi,wi));let io=-1;const yf=(Pr,Lr)=>Pr?Math.max(Pr,Lr):Lr;io=yf(El,io),io=yf(Gc,io),io=yf(qc,io);const Ob=io>-1?1:0;De.glyphOffsetArray.length>=Js.MAX_GLYPHS&&ii("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Nt.sortKey!==void 0&&De.addToSortKeyRanges(De.symbolInstances.length,Nt.sortKey),De.symbolInstances.emplaceBack(Ct.x,Ct.y,Ct.z,zt.x,zt.y,Wn.right>=0?Wn.right:-1,Wn.center>=0?Wn.center:-1,Wn.left>=0?Wn.left:-1,Wn.vertical>=0?Wn.vertical:-1,ff,mf,cy,or!==void 0?or:De.collisionBoxArray.length,or!==void 0?or+1:De.collisionBoxArray.length,ki!==void 0?ki:De.collisionBoxArray.length,ki!==void 0?ki+1:De.collisionBoxArray.length,ar!==void 0?ar:De.collisionBoxArray.length,ar!==void 0?ar+1:De.collisionBoxArray.length,Tn||De.collisionBoxArray.length,Tn?Tn+1:De.collisionBoxArray.length,xi,ay,ly,sy,oy,Ob,0,_f,gf,io)})(t,Ve,It,Ie,r,s,h,Le,t.layers[0],t.collisionBoxArray,e.index,e.sourceLayerIndex,t.index,oe,we,x,0,ae,ve,O,e,u,w,E,I)};if(Fe==="line")for(const Ie of gg(e.geometry,0,0,yt,yt)){const Ve=tb(Ie,ne,le,r.vertical||U,s,24,Q,t.overscaling,yt);for(const qe of Ve){const wt=U;wt&&hb(t,wt.text,Pe,qe)||Oe(Ie,qe,I)}}else if(Fe==="line-center"){for(const Ie of e.geometry)if(Ie.length>1){const Ve=eb(Ie,le,r.vertical||U,s,24,Q);Ve&&Oe(Ie,Ve,I)}}else if(e.type==="Polygon")for(const Ie of Rp(e.geometry,0)){const Ve=sb(Ie,16);Oe(Ie[0],new ps(Ve.x,Ve.y,0,0,void 0),I)}else if(e.type==="LineString")for(const Ie of e.geometry)Oe(Ie,new ps(Ie[0].x,Ie[0].y,0,0,void 0),I);else if(e.type==="Point")for(const Ie of e.geometry)for(const Ve of Ie)Oe([Ve],new ps(Ve.x,Ve.y,0,0,void 0),I)}const Ys=32640;function Tg(t,e,r,s,h,u,f,g,x,w,E,I,A,z,R,O,U){const Z=function(oe,ae,le,we,ve,Fe,Pe,be){const Le=[];if(ae.positionedLines.length===0)return Le;const Oe=we.layout.get("text-rotate").evaluate(Fe,{})*Math.PI/180,Ie=function(St){const It=St[0],De=St[1],zt=It*De;return zt>0?[It,-De]:zt<0?[-It,De]:It===0?[De,It]:[De,-It]}(le);let Ve=Math.abs(ae.top-ae.bottom);for(const St of ae.positionedLines)Ve-=St.lineOffset;const qe=ae.positionedLines.length,wt=Ve/qe;let Gt=ae.top-le[1];for(let St=0;St<qe;++St){const It=ae.positionedLines[St];Gt=ib(ae,wt,Gt,St);for(const De of It.positionedGlyphs){if(!De.rect)continue;const zt=De.rect||{};let Ct=4,yi=!0,ai=1,Ai=0;if(De.imageName){const ei=Pe[De.imageName];if(!ei)continue;if(ei.sdf){ii("SDF images are not supported in formatted text and will be ignored.");continue}yi=!1,ai=ei.pixelRatio,Ct=1/ai}const Zi=(ve||be)&&De.vertical,Pt=De.metrics.advance*De.scale/2,bt=De.metrics,Qt=De.rect;if(Qt===null)continue;be&&ae.verticalizable&&(Ai=De.imageName?Pt-De.metrics.width*De.scale/2:0);const xi=ve?[De.x+Pt,De.y]:[0,0];let ci=[0,0],bi=[0,0],Ui=!1;ve||(Zi?(bi=[De.x+Pt+Ie[0],De.y+Ie[1]-Ai],Ui=!0):ci=[De.x+Pt+le[0],De.y+le[1]-Ai]);const _r=Qt.w*De.scale/(ai*(De.localGlyph?2:1)),gr=Qt.h*De.scale/(ai*(De.localGlyph?2:1));let Jt,Ci,ln,Oi;if(Zi){const ei=De.y-Gt,Wi=new ue(-Pt,Pt-ei),wi=-Math.PI/2,Xi=new ue(...bi);Jt=new ue(-Pt+ci[0],ci[1]),Jt._rotateAround(wi,Wi)._add(Xi),Jt.x+=-ei+Pt,Jt.y-=(bt.left-Ct)*De.scale;const or=De.imageName?bt.advance*De.scale:Ni*De.scale,ar=String.fromCharCode(De.glyph);F1(ar)?Jt.x+=(1-Ct)*De.scale:O1(ar)?Jt.x+=or-bt.height*De.scale+(-Ct-1)*De.scale:Jt.x+=De.imageName||bt.width+2*Ct===Qt.w&&bt.height+2*Ct===Qt.h?(or-gr)/2:(or-(bt.height+2*Ct)*De.scale)/2,Ci=new ue(Jt.x,Jt.y-_r),ln=new ue(Jt.x+gr,Jt.y),Oi=new ue(Jt.x+gr,Jt.y-_r)}else{const ei=(bt.left-Ct)*De.scale-Pt+ci[0],Wi=(-bt.top-Ct)*De.scale+ci[1],wi=ei+_r,Xi=Wi+gr;Jt=new ue(ei,Wi),Ci=new ue(wi,Wi),ln=new ue(ei,Xi),Oi=new ue(wi,Xi)}if(Oe){let ei;ei=ve?new ue(0,0):Ui?new ue(Ie[0],Ie[1]):new ue(le[0],le[1]),Jt._rotateAround(Oe,ei),Ci._rotateAround(Oe,ei),ln._rotateAround(Oe,ei),Oi._rotateAround(Oe,ei)}const Nt=new ue(0,0),Mi=new ue(0,0);Le.push({tl:Jt,tr:Ci,bl:ln,br:Oi,tex:zt,writingMode:ae.writingMode,glyphOffset:xi,sectionIndex:De.sectionIndex,isSDF:yi,pixelOffsetTL:Nt,pixelOffsetBR:Mi,minFontScaleX:0,minFontScaleY:0})}}return Le}(0,s,x,u,f,g,h,t.allowVerticalPlacement),Q=t.textSizeData;let ne=null;Q.kind==="source"?(ne=[$n*u.layout.get("text-size").evaluate(g,{},U)],ne[0]>Ys&&ii(`${t.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):Q.kind==="composite"&&(ne=[$n*R.compositeTextSizes[0].evaluate(g,{},U),$n*R.compositeTextSizes[1].evaluate(g,{},U)],(ne[0]>Ys||ne[1]>Ys)&&ii(`${t.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),t.addSymbols(t.text,Z,ne,x,f,g,E,e,r,w.lineStartIndex,w.lineLength,z,O,U);for(const oe of I)A[oe]=t.text.placedSymbolArray.length-1;return 4*Z.length}function Eg(t){for(const e in t)return t[e];return null}function Vu(t,e,r,s,h,u,f,g,x,w){let E=f.top,I=f.bottom,A=f.left,z=f.right;const R=f.collisionPadding;if(R&&(A-=R[0],E-=R[1],z+=R[2],I+=R[3]),x){const O=new ue(A,E),U=new ue(z,E),Z=new ue(A,I),Q=new ue(z,I),ne=gt(x);let oe=new ue(0,0);w&&(oe=new ue(w[0],w[1])),O._rotateAround(ne,oe),U._rotateAround(ne,oe),Z._rotateAround(ne,oe),Q._rotateAround(ne,oe),A=Math.min(O.x,U.x,Z.x,Q.x),z=Math.max(O.x,U.x,Z.x,Q.x),E=Math.min(O.y,U.y,Z.y,Q.y),I=Math.max(O.y,U.y,Z.y,Q.y)}return t.emplaceBack(e.x,e.y,e.z,r.x,r.y,A,E,z,I,g,s,h,u),t.length-1}function Hp(t){t.collisionPadding&&(t.top-=t.collisionPadding[1],t.bottom+=t.collisionPadding[3]);const e=t.bottom-t.top;return e>0?Math.max(10,e):null}function hb(t,e,r,s){const h=t.compareText;if(e in h){const u=h[e];for(let f=u.length-1;f>=0;f--)if(s.dist(u[f])<r)return!0}else h[e]=[];return h[e].push(s),!1}const ub=Yo.VectorTileFeature.types,db=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function ju(t,e,r,s,h,u,f,g,x,w,E,I,A,z,R,O){const U=E?Math.min(Ys,Math.round(E[0])):0,Z=E?Math.min(Ys,Math.round(E[1])):0;t.emplaceBack(e,r,Math.round(32*f),Math.round(32*g),x,w,(U<<1)+(I?1:0),Z,16*A,16*z,256*R,256*O,s,h,u,0)}function Kp(t,e,r){t.emplaceBack(e.x,e.y,r),t.emplaceBack(e.x,e.y,r),t.emplaceBack(e.x,e.y,r),t.emplaceBack(e.x,e.y,r)}function pb(t){for(const e of t.sections)if(Re(e.text))return!0;return!1}class Yp{constructor(e){this.layoutVertexArray=new hp,this.indexArray=new Gr,this.programConfigurations=e,this.segments=new _i,this.dynamicLayoutVertexArray=new al,this.opacityVertexArray=new up,this.placedSymbolArray=new l_}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(e,r,s,h){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,k1.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,D1.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,db,!0),this.opacityVertexBuffer.itemSize=1),(s||h)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}je("SymbolBuffers",Yp);class Jp{constructor(e,r,s){this.layoutVertexArray=new e,this.layoutAttributes=r,this.indexArray=new s,this.segments=new _i,this.collisionVertexArray=new fp,this.collisionVertexArrayExt=new al}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,z1.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,P1.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}je("CollisionBuffers",Jp);class Js{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(f=>f.id),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=ti([]),this.placementViewportMatrix=ti([]);const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Np(this.zoom,r["text-size"]),this.iconSizeData=Np(this.zoom,r["icon-size"]);const s=this.layers[0].layout,h=s.get("symbol-sort-key"),u=s.get("symbol-z-order");this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey=u!=="viewport-y"&&h.constantOr(1)!==void 0,this.sortFeaturesByY=(u==="viewport-y"||u==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map(f=>Zr[f]),this.stateDependentLayerIds=this.layers.filter(f=>f.isStateDependent()).map(f=>f.id),this.sourceID=e.sourceID}createArrays(){this.text=new Yp(new Xo(this.layers,this.zoom,e=>/^text/.test(e))),this.icon=new Yp(new Xo(this.layers,this.zoom,e=>/^icon/.test(e))),this.glyphOffsetArray=new u_,this.lineVertexArray=new d_,this.symbolInstances=new h_}calculateGlyphDependencies(e,r,s,h,u){for(let f=0;f<e.length;f++)if(r[e.charCodeAt(f)]=!0,h&&u){const g=Rc[e.charAt(f)];g&&(r[g.charCodeAt(0)]=!0)}}populate(e,r,s,h){const u=this.layers[0],f=u.layout,g=f.get("text-font"),x=f.get("text-field"),w=f.get("icon-image"),E=(x.value.kind!=="constant"||x.value.value instanceof lt&&!x.value.value.isEmpty()||x.value.value.toString().length>0)&&(g.value.kind!=="constant"||g.value.value.length>0),I=w.value.kind!=="constant"||!!w.value.value||Object.keys(w.parameters).length>0,A=f.get("symbol-sort-key");if(this.features=[],!E&&!I)return;const z=r.iconDependencies,R=r.glyphDependencies,O=r.availableImages,U=new ot(this.zoom);for(const{feature:Z,id:Q,index:ne,sourceLayerIndex:oe}of e){const ae=u._featureFilter.needGeometry,le=Ko(Z,ae);if(!u._featureFilter.filter(U,le,s))continue;let we,ve;if(ae||(le.geometry=us(Z,s,h)),E){const Pe=u.getValueAndResolveTokens("text-field",le,s,O),be=lt.factory(Pe);pb(be)&&(this.hasRTLText=!0),(!this.hasRTLText||kr()==="unavailable"||this.hasRTLText&&Et.isParsed())&&(we=B1(be,u,le))}if(I){const Pe=u.getValueAndResolveTokens("icon-image",le,s,O);ve=Pe instanceof Ar?Pe:Ar.fromString(Pe)}if(!we&&!ve)continue;const Fe=this.sortFeaturesByKey?A.evaluate(le,{},s):void 0;if(this.features.push({id:Q,text:we,icon:ve,index:ne,sourceLayerIndex:oe,geometry:le.geometry,properties:Z.properties,type:ub[Z.type],sortKey:Fe}),ve&&(z[ve.name]=!0),we){const Pe=g.evaluate(le,{},s).join(","),be=f.get("text-rotation-alignment")==="map"&&f.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Zr.vertical)>=0;for(const Le of we.sections)if(Le.image)z[Le.image.name]=!0;else{const Oe=xe(we.toString()),Ie=Le.fontStack||Pe,Ve=R[Ie]=R[Ie]||{};this.calculateGlyphDependencies(Le.text,Ve,be,this.allowVerticalPlacement,Oe)}}}f.get("symbol-placement")==="line"&&(this.features=function(Z){const Q={},ne={},oe=[];let ae=0;function le(Pe){oe.push(Z[Pe]),ae++}function we(Pe,be,Le){const Oe=ne[Pe];return delete ne[Pe],ne[be]=Oe,oe[Oe].geometry[0].pop(),oe[Oe].geometry[0]=oe[Oe].geometry[0].concat(Le[0]),Oe}function ve(Pe,be,Le){const Oe=Q[be];return delete Q[be],Q[Pe]=Oe,oe[Oe].geometry[0].shift(),oe[Oe].geometry[0]=Le[0].concat(oe[Oe].geometry[0]),Oe}function Fe(Pe,be,Le){const Oe=Le?be[0][be[0].length-1]:be[0][0];return`${Pe}:${Oe.x}:${Oe.y}`}for(let Pe=0;Pe<Z.length;Pe++){const be=Z[Pe],Le=be.geometry,Oe=be.text?be.text.toString():null;if(!Oe){le(Pe);continue}const Ie=Fe(Oe,Le),Ve=Fe(Oe,Le,!0);if(Ie in ne&&Ve in Q&&ne[Ie]!==Q[Ve]){const qe=ve(Ie,Ve,Le),wt=we(Ie,Ve,oe[qe].geometry);delete Q[Ie],delete ne[Ve],ne[Fe(Oe,oe[wt].geometry,!0)]=wt,oe[qe].geometry=null}else Ie in ne?we(Ie,Ve,Le):Ve in Q?ve(Ie,Ve,Le):(le(Pe),Q[Ie]=ae-1,ne[Ve]=ae-1)}return oe.filter(Pe=>Pe.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((Z,Q)=>Z.sortKey-Q.sortKey)}update(e,r,s,h){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(e,r,this.layers,s,h),this.icon.programConfigurations.updatePaintArrays(e,r,this.layers,s,h))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,r){const s=this.lineVertexArray.length;if(e.segment!==void 0){let h=e.dist(r[e.segment+1]),u=e.dist(r[e.segment]);const f={};for(let g=e.segment+1;g<r.length;g++)f[g]={x:r[g].x,y:r[g].y,tileUnitDistanceFromAnchor:h},g<r.length-1&&(h+=r[g+1].dist(r[g]));for(let g=e.segment||0;g>=0;g--)f[g]={x:r[g].x,y:r[g].y,tileUnitDistanceFromAnchor:u},g>0&&(u+=r[g-1].dist(r[g]));for(let g=0;g<r.length;g++){const x=f[g];this.lineVertexArray.emplaceBack(x.x,x.y,x.tileUnitDistanceFromAnchor)}}return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,r,s,h,u,f,g,x,w,E,I,A,z,R){const O=e.indexArray,U=e.layoutVertexArray,Z=e.segments.prepareSegment(4*r.length,U,O,this.canOverlap?f.sortKey:void 0),Q=this.glyphOffsetArray.length,ne=Z.vertexLength,oe=this.allowVerticalPlacement&&g===Zr.vertical?Math.PI/2:0,ae=f.text&&f.text.sections;for(let le=0;le<r.length;le++){const{tl:we,tr:ve,bl:Fe,br:Pe,tex:be,pixelOffsetTL:Le,pixelOffsetBR:Oe,minFontScaleX:Ie,minFontScaleY:Ve,glyphOffset:qe,isSDF:wt,sectionIndex:Gt}=r[le],St=Z.vertexLength,It=qe[1];ju(U,x.x,x.y,x.z,w.x,w.y,we.x,It+we.y,be.x,be.y,s,wt,Le.x,Le.y,Ie,Ve),ju(U,x.x,x.y,x.z,w.x,w.y,ve.x,It+ve.y,be.x+be.w,be.y,s,wt,Oe.x,Le.y,Ie,Ve),ju(U,x.x,x.y,x.z,w.x,w.y,Fe.x,It+Fe.y,be.x,be.y+be.h,s,wt,Le.x,Oe.y,Ie,Ve),ju(U,x.x,x.y,x.z,w.x,w.y,Pe.x,It+Pe.y,be.x+be.w,be.y+be.h,s,wt,Oe.x,Oe.y,Ie,Ve),Kp(e.dynamicLayoutVertexArray,x,oe),O.emplaceBack(St,St+1,St+2),O.emplaceBack(St+1,St+2,St+3),Z.vertexLength+=4,Z.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(qe[0]),le!==r.length-1&&Gt===r[le+1].sectionIndex||e.programConfigurations.populatePaintArrays(U.length,f,f.index,{},z,R,ae&&ae[Gt])}e.placedSymbolArray.emplaceBack(x.x,x.y,x.z,w.x,w.y,Q,this.glyphOffsetArray.length-Q,ne,E,I,w.segment,s?s[0]:0,s?s[1]:0,h[0],h[1],g,0,!1,0,A,0)}_commitLayoutVertex(e,r,s,h,u,f,g){e.emplaceBack(r,s,h,u,f,Math.round(g.x),Math.round(g.y))}_addCollisionDebugVertices(e,r,s,h,u,f,g){const x=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),w=x.vertexLength,E=g.tileAnchorX,I=g.tileAnchorY;for(let z=0;z<4;z++)s.collisionVertexArray.emplaceBack(0,0,0,0);s.collisionVertexArrayExt.emplaceBack(r,-e.padding,-e.padding),s.collisionVertexArrayExt.emplaceBack(r,e.padding,-e.padding),s.collisionVertexArrayExt.emplaceBack(r,e.padding,e.padding),s.collisionVertexArrayExt.emplaceBack(r,-e.padding,e.padding),this._commitLayoutVertex(s.layoutVertexArray,h,u,f,E,I,new ue(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,h,u,f,E,I,new ue(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,h,u,f,E,I,new ue(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,h,u,f,E,I,new ue(e.x1,e.y2)),x.vertexLength+=4;const A=s.indexArray;A.emplaceBack(w,w+1),A.emplaceBack(w+1,w+2),A.emplaceBack(w+2,w+3),A.emplaceBack(w+3,w),x.primitiveLength+=4}_addTextDebugCollisionBoxes(e,r,s,h,u,f){for(let g=h;g<u;g++){const x=s.get(g),w=this.getSymbolInstanceTextSize(e,f,r,g);this._addCollisionDebugVertices(x,w,this.textCollisionBox,x.projectedAnchorX,x.projectedAnchorY,x.projectedAnchorZ,f)}}_addIconDebugCollisionBoxes(e,r,s,h,u,f){for(let g=h;g<u;g++){const x=s.get(g),w=this.getSymbolInstanceIconSize(e,r,g);this._addCollisionDebugVertices(x,w,this.iconCollisionBox,x.projectedAnchorX,x.projectedAnchorY,x.projectedAnchorZ,f)}}generateCollisionDebugBuffers(e,r){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Jp(gu,J_.members,Ws),this.iconCollisionBox=new Jp(gu,J_.members,Ws);const s=ml(this.iconSizeData,e),h=ml(this.textSizeData,e);for(let u=0;u<this.symbolInstances.length;u++){const f=this.symbolInstances.get(u);this._addTextDebugCollisionBoxes(h,e,r,f.textBoxStartIndex,f.textBoxEndIndex,f),this._addTextDebugCollisionBoxes(h,e,r,f.verticalTextBoxStartIndex,f.verticalTextBoxEndIndex,f),this._addIconDebugCollisionBoxes(s,e,r,f.iconBoxStartIndex,f.iconBoxEndIndex,f),this._addIconDebugCollisionBoxes(s,e,r,f.verticalIconBoxStartIndex,f.verticalIconBoxEndIndex,f)}}getSymbolInstanceTextSize(e,r,s,h){const u=this.text.placedSymbolArray.get(r.rightJustifiedTextSymbolIndex>=0?r.rightJustifiedTextSymbolIndex:r.centerJustifiedTextSymbolIndex>=0?r.centerJustifiedTextSymbolIndex:r.leftJustifiedTextSymbolIndex>=0?r.leftJustifiedTextSymbolIndex:r.verticalPlacedTextSymbolIndex>=0?r.verticalPlacedTextSymbolIndex:h),f=Ru(this.textSizeData,e,u)/Ni;return this.tilePixelRatio*f}getSymbolInstanceIconSize(e,r,s){const h=this.icon.placedSymbolArray.get(s),u=Ru(this.iconSizeData,e,h);return this.tilePixelRatio*u}_commitDebugCollisionVertexUpdate(e,r,s){e.emplaceBack(r,-s,-s),e.emplaceBack(r,s,-s),e.emplaceBack(r,s,s),e.emplaceBack(r,-s,s)}_updateTextDebugCollisionBoxes(e,r,s,h,u,f){for(let g=h;g<u;g++){const x=s.get(g),w=this.getSymbolInstanceTextSize(e,f,r,g);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,w,x.padding)}}_updateIconDebugCollisionBoxes(e,r,s,h,u){for(let f=h;f<u;f++){const g=s.get(f),x=this.getSymbolInstanceIconSize(e,r,f);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,x,g.padding)}}updateCollisionDebugBuffers(e,r){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const s=ml(this.iconSizeData,e),h=ml(this.textSizeData,e);for(let u=0;u<this.symbolInstances.length;u++){const f=this.symbolInstances.get(u);this._updateTextDebugCollisionBoxes(h,e,r,f.textBoxStartIndex,f.textBoxEndIndex,f),this._updateTextDebugCollisionBoxes(h,e,r,f.verticalTextBoxStartIndex,f.verticalTextBoxEndIndex,f),this._updateIconDebugCollisionBoxes(s,e,r,f.iconBoxStartIndex,f.iconBoxEndIndex),this._updateIconDebugCollisionBoxes(s,e,r,f.verticalIconBoxStartIndex,f.verticalIconBoxEndIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,r,s,h,u,f,g,x,w){const E={};for(let I=r;I<s;I++){const A=e.get(I);E.textBox={x1:A.x1,y1:A.y1,x2:A.x2,y2:A.y2,padding:A.padding,projectedAnchorX:A.projectedAnchorX,projectedAnchorY:A.projectedAnchorY,projectedAnchorZ:A.projectedAnchorZ,tileAnchorX:A.tileAnchorX,tileAnchorY:A.tileAnchorY},E.textFeatureIndex=A.featureIndex;break}for(let I=h;I<u;I++){const A=e.get(I);E.verticalTextBox={x1:A.x1,y1:A.y1,x2:A.x2,y2:A.y2,padding:A.padding,projectedAnchorX:A.projectedAnchorX,projectedAnchorY:A.projectedAnchorY,projectedAnchorZ:A.projectedAnchorZ,tileAnchorX:A.tileAnchorX,tileAnchorY:A.tileAnchorY},E.verticalTextFeatureIndex=A.featureIndex;break}for(let I=f;I<g;I++){const A=e.get(I);E.iconBox={x1:A.x1,y1:A.y1,x2:A.x2,y2:A.y2,padding:A.padding,projectedAnchorX:A.projectedAnchorX,projectedAnchorY:A.projectedAnchorY,projectedAnchorZ:A.projectedAnchorZ,tileAnchorX:A.tileAnchorX,tileAnchorY:A.tileAnchorY},E.iconFeatureIndex=A.featureIndex;break}for(let I=x;I<w;I++){const A=e.get(I);E.verticalIconBox={x1:A.x1,y1:A.y1,x2:A.x2,y2:A.y2,padding:A.padding,projectedAnchorX:A.projectedAnchorX,projectedAnchorY:A.projectedAnchorY,projectedAnchorZ:A.projectedAnchorZ,tileAnchorX:A.tileAnchorX,tileAnchorY:A.tileAnchorY},E.verticalIconFeatureIndex=A.featureIndex;break}return E}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const s=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(e,r){const s=e.placedSymbolArray.get(r),h=s.vertexStartIndex+4*s.numGlyphs;for(let u=s.vertexStartIndex;u<h;u+=4)e.indexArray.emplaceBack(u,u+1,u+2),e.indexArray.emplaceBack(u+1,u+2,u+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(e),s=Math.cos(e),h=[],u=[],f=[];for(let g=0;g<this.symbolInstances.length;++g){f.push(g);const x=this.symbolInstances.get(g);h.push(0|Math.round(r*x.tileAnchorX+s*x.tileAnchorY)),u.push(x.featureIndex)}return f.sort((g,x)=>h[g]-h[x]||u[x]-u[g]),f}addToSortKeyRanges(e,r){const s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===r?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const s=this.symbolInstances.get(r);this.featureSortOrder.push(s.featureIndex),[s.rightJustifiedTextSymbolIndex,s.centerJustifiedTextSymbolIndex,s.leftJustifiedTextSymbolIndex].forEach((h,u,f)=>{h>=0&&f.indexOf(h)===u&&this.addIndicesForPlacedSymbol(this.text,h)}),s.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,s.verticalPlacedTextSymbolIndex),s.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,s.placedIconSymbolIndex),s.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,s.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}je("SymbolBucket",Js,{omit:["layers","collisionBoxArray","features","compareText"]}),Js.MAX_GLYPHS=65535,Js.addDynamicAttributes=Kp;const fb=new Fi({"symbol-placement":new Ge(ye.layout_symbol["symbol-placement"]),"symbol-spacing":new Ge(ye.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ge(ye.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ye(ye.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ge(ye.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Ge(ye.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Ge(ye.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ge(ye.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ge(ye.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ye(ye.layout_symbol["icon-size"]),"icon-text-fit":new Ge(ye.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ge(ye.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ye(ye.layout_symbol["icon-image"]),"icon-rotate":new Ye(ye.layout_symbol["icon-rotate"]),"icon-padding":new Ge(ye.layout_symbol["icon-padding"]),"icon-keep-upright":new Ge(ye.layout_symbol["icon-keep-upright"]),"icon-offset":new Ye(ye.layout_symbol["icon-offset"]),"icon-anchor":new Ye(ye.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ge(ye.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ge(ye.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ge(ye.layout_symbol["text-rotation-alignment"]),"text-field":new Ye(ye.layout_symbol["text-field"]),"text-font":new Ye(ye.layout_symbol["text-font"]),"text-size":new Ye(ye.layout_symbol["text-size"]),"text-max-width":new Ye(ye.layout_symbol["text-max-width"]),"text-line-height":new Ye(ye.layout_symbol["text-line-height"]),"text-letter-spacing":new Ye(ye.layout_symbol["text-letter-spacing"]),"text-justify":new Ye(ye.layout_symbol["text-justify"]),"text-radial-offset":new Ye(ye.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ge(ye.layout_symbol["text-variable-anchor"]),"text-anchor":new Ye(ye.layout_symbol["text-anchor"]),"text-max-angle":new Ge(ye.layout_symbol["text-max-angle"]),"text-writing-mode":new Ge(ye.layout_symbol["text-writing-mode"]),"text-rotate":new Ye(ye.layout_symbol["text-rotate"]),"text-padding":new Ge(ye.layout_symbol["text-padding"]),"text-keep-upright":new Ge(ye.layout_symbol["text-keep-upright"]),"text-transform":new Ye(ye.layout_symbol["text-transform"]),"text-offset":new Ye(ye.layout_symbol["text-offset"]),"text-allow-overlap":new Ge(ye.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Ge(ye.layout_symbol["text-ignore-placement"]),"text-optional":new Ge(ye.layout_symbol["text-optional"])});var Qp={paint:new Fi({"icon-opacity":new Ye(ye.paint_symbol["icon-opacity"]),"icon-color":new Ye(ye.paint_symbol["icon-color"]),"icon-halo-color":new Ye(ye.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ye(ye.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ye(ye.paint_symbol["icon-halo-blur"]),"icon-translate":new Ge(ye.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ge(ye.paint_symbol["icon-translate-anchor"]),"text-opacity":new Ye(ye.paint_symbol["text-opacity"]),"text-color":new Ye(ye.paint_symbol["text-color"],{runtimeType:rn,getOverride:t=>t.textColor,hasOverride:t=>!!t.textColor}),"text-halo-color":new Ye(ye.paint_symbol["text-halo-color"]),"text-halo-width":new Ye(ye.paint_symbol["text-halo-width"]),"text-halo-blur":new Ye(ye.paint_symbol["text-halo-blur"]),"text-translate":new Ge(ye.paint_symbol["text-translate"]),"text-translate-anchor":new Ge(ye.paint_symbol["text-translate-anchor"])}),layout:fb};class Sg{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:Pn,this.defaultValue=e}evaluate(e){if(e.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(e.formattedSection))return r.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}je("FormatSectionOverride",Sg,{omit:["defaultValue"]});class $u extends xn{constructor(e){super(e,Qp)}recalculate(e,r){super.recalculate(e,r),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const s=this.layout.get("text-writing-mode");if(s){const h=[];for(const u of s)h.indexOf(u)<0&&h.push(u);this.layout._values["text-writing-mode"]=h}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(e,r,s,h){const u=this.layout.get(e).evaluate(r,{},s,h),f=this._unevaluatedLayout._values[e];return f.isDataDriven()||Os(f.value)||!u?u:function(g,x){return x.replace(/{([^{}]+)}/g,(w,E)=>E in g?String(g[E]):"")}(r.properties,u)}createBucket(e){return new Js(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of Qp.paint.overridableProperties){if(!$u.hasPaintOverride(this.layout,e))continue;const r=this.paint.get(e),s=new Sg(r),h=new uc(s,r.property.specification);let u=null;u=r.value.kind==="constant"||r.value.kind==="source"?new Uo("source",h):new dc("composite",h,r.value.zoomStops,r.value._interpolationType),this.paint._values[e]=new sr(r.property,u,r.parameters)}}_handleOverridablePaintPropertyUpdate(e,r,s){return!(!this.layout||r.isDataDriven()||s.isDataDriven())&&$u.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,r){const s=e.get("text-field"),h=Qp.paint.properties[r];let u=!1;const f=g=>{for(const x of g)if(h.overrides&&h.overrides.hasOverride(x))return void(u=!0)};if(s.value.kind==="constant"&&s.value.value instanceof lt)f(s.value.value.sections);else if(s.value.kind==="source"){const g=w=>{u||(w instanceof Rn&&fi(w.value)===Ln?f(w.value.sections):w instanceof nn?f(w.sections):w.eachChild(g))},x=s.value;x._styleExpression&&g(x._styleExpression.expression)}return u}getProgramConfiguration(e){return new cs(this,e)}}var mb={paint:new Fi({"background-color":new Ge(ye.paint_background["background-color"]),"background-pattern":new os(ye.paint_background["background-pattern"]),"background-opacity":new Ge(ye.paint_background["background-opacity"])})},_b={paint:new Fi({"raster-opacity":new Ge(ye.paint_raster["raster-opacity"]),"raster-hue-rotate":new Ge(ye.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ge(ye.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ge(ye.paint_raster["raster-brightness-max"]),"raster-saturation":new Ge(ye.paint_raster["raster-saturation"]),"raster-contrast":new Ge(ye.paint_raster["raster-contrast"]),"raster-resampling":new Ge(ye.paint_raster["raster-resampling"]),"raster-fade-duration":new Ge(ye.paint_raster["raster-fade-duration"])})};class gb extends xn{constructor(e){super(e,{}),this.implementation=e}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}var yb={paint:new Fi({"sky-type":new Ge(ye.paint_sky["sky-type"]),"sky-atmosphere-sun":new Ge(ye.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Ge(ye.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Ge(ye.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Ge(ye.paint_sky["sky-gradient-radius"]),"sky-gradient":new Vn(ye.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Ge(ye.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Ge(ye.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Ge(ye.paint_sky["sky-opacity"])})};function ef(t,e,r){const s=hn(0,0,1),h=ya(ho());return function(u,f,g){g*=.5;var x=f[0],w=f[1],E=f[2],I=f[3],A=Math.sin(g),z=Math.cos(g);u[0]=x*z-E*A,u[1]=w*z+I*A,u[2]=E*z+x*A,u[3]=I*z-w*A}(h,h,r?-gt(t)+Math.PI:gt(t)),xa(h,h,-gt(e)),ga(s,s,h),xs(s,s)}const xb={circle:class extends xn{constructor(t){super(t,j0)}createBucket(t){return new Sp(t)}queryRadius(t){const e=t;return dl("circle-radius",this,e)+dl("circle-stroke-width",this,e)+Au(this.paint.get("circle-translate"))}queryIntersectsFeature(t,e,r,s,h,u,f,g){const x=P_(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),u.angle,t.pixelToTileUnitsFactor),w=this.paint.get("circle-radius").evaluate(e,r)+this.paint.get("circle-stroke-width").evaluate(e,r);return L_(t,s,u,f,g,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",x,w)}getProgramIds(){return["circle"]}getProgramConfiguration(t){return new cs(this,t)}},heatmap:class extends xn{createBucket(t){return new B_(t)}constructor(t){super(t,Z0),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Dp({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(t){return dl("heatmap-radius",this,t)}queryIntersectsFeature(t,e,r,s,h,u,f,g){const x=this.paint.get("heatmap-radius").evaluate(e,r);return L_(t,s,u,f,g,!0,!0,new ue(0,0),x)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(t){return new cs(this,t)}},hillshade:class extends xn{constructor(t){super(t,W0)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getProgramConfiguration(t){return new cs(this,t)}},fill:class extends xn{constructor(t){super(t,h1)}getProgramIds(){const t=this.paint.get("fill-pattern"),e=t&&t.constantOr(1),r=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&r.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),r}getProgramConfiguration(t){return new cs(this,t)}recalculate(t,e){super.recalculate(t,e);const r=this.paint._values["fill-outline-color"];r.value.kind==="constant"&&r.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(t){return new Pu(t)}queryRadius(){return Au(this.paint.get("fill-translate"))}queryIntersectsFeature(t,e,r,s,h,u){return!t.queryGeometry.isAboveHorizon&&C_(z_(t.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),u.angle,t.pixelToTileUnitsFactor),s)}isTileClipped(){return!0}},"fill-extrusion":class extends xn{constructor(t){super(t,b1)}createBucket(t){return new Op(t)}queryRadius(){return Au(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(t){return new cs(this,t)}queryIntersectsFeature(t,e,r,s,h,u,f,g,x){const w=P_(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),u.angle,t.pixelToTileUnitsFactor),E=this.paint.get("fill-extrusion-height").evaluate(e,r),I=this.paint.get("fill-extrusion-base").evaluate(e,r),A=[0,0],z=g&&u.elevation,R=u.elevation?u.elevation.exaggeration():1;if(z){const Z=t.tile.getBucket(this).centroidVertexArray,Q=x+1;if(Q<Z.length){const ne=Z.get(Q);A[0]=ne.a_centroid_pos0,A[1]=ne.a_centroid_pos1}}if(A[0]===0&&A[1]===1)return!1;const O=function(Z,Q,ne,oe,ae,le,we,ve,Fe){return le?function(Pe,be,Le,Oe,Ie,Ve,qe,wt,Gt){const St=[],It=[],De=[0,0,0,1];for(const zt of Pe){const Ct=[],yi=[];for(const ai of zt){const Ai=ai.x+Oe.x,Zi=ai.y+Oe.y,Pt=w1(Ai,Zi,be,Le,Ve,qe,wt,Gt);De[0]=Ai,De[1]=Zi,De[2]=Pt.base,De[3]=1,Yr(De,De,Ie),De[3]=Math.max(De[3],1e-5);const bt=X_([De[0]/De[3],De[1]/De[3],De[2]/De[3]]);De[0]=Ai,De[1]=Zi,De[2]=Pt.top,De[3]=1,Yr(De,De,Ie),De[3]=Math.max(De[3],1e-5);const Qt=X_([De[0]/De[3],De[1]/De[3],De[2]/De[3]]);Ct.push(bt),yi.push(Qt)}St.push(Ct),It.push(yi)}return[St,It]}(Z,Q,ne,oe,ae,le,we,ve,Fe):function(Pe,be,Le,Oe,Ie){const Ve=[],qe=[],wt=Ie[8]*be,Gt=Ie[9]*be,St=Ie[10]*be,It=Ie[11]*be,De=Ie[8]*Le,zt=Ie[9]*Le,Ct=Ie[10]*Le,yi=Ie[11]*Le;for(const ai of Pe){const Ai=[],Zi=[];for(const Pt of ai){const bt=Pt.x+Oe.x,Qt=Pt.y+Oe.y,xi=Ie[0]*bt+Ie[4]*Qt+Ie[12],ci=Ie[1]*bt+Ie[5]*Qt+Ie[13],bi=Ie[2]*bt+Ie[6]*Qt+Ie[14],Ui=Ie[3]*bt+Ie[7]*Qt+Ie[15],_r=xi+wt,gr=ci+Gt,Jt=bi+St,Ci=Math.max(Ui+It,1e-5),ln=xi+De,Oi=ci+zt,Nt=bi+Ct,Mi=Math.max(Ui+yi,1e-5),ei=new ue(_r/Ci,gr/Ci);ei.z=Jt/Ci,Ai.push(ei);const Wi=new ue(ln/Mi,Oi/Mi);Wi.z=Nt/Mi,Zi.push(Wi)}Ve.push(Ai),qe.push(Zi)}return[Ve,qe]}(Z,Q,ne,oe,ae)}(s,I,E,w,f,z?g:null,A,R,u.center.lat),U=t.queryGeometry;return function(Z,Q,ne){let oe=1/0;C_(ne,Q)&&(oe=W_(ne,Q[0]));for(let ae=0;ae<Q.length;ae++){const le=Q[ae],we=Z[ae];for(let ve=0;ve<le.length-1;ve++){const Fe=le[ve],Pe=[Fe,le[ve+1],we[ve+1],we[ve],Fe];A_(ne,Pe)&&(oe=Math.min(oe,W_(ne,Pe)))}}return oe!==1/0&&oe}(O[0],O[1],U.isPointQuery()?U.screenBounds:U.screenGeometry)}},line:class extends xn{constructor(t){super(t,H_),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(t){if(t==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Do,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(t,e){super.recalculate(t,e),this.paint._values["line-floorwidth"]=K_.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,t)}createBucket(t){return new Lu(t)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(t){return new cs(this,t)}queryRadius(t){const e=t,r=Y_(dl("line-width",this,e),dl("line-gap-width",this,e)),s=dl("line-offset",this,e);return r/2+Math.abs(s)+Au(this.paint.get("line-translate"))}queryIntersectsFeature(t,e,r,s,h,u){if(t.queryGeometry.isAboveHorizon)return!1;const f=z_(t.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),u.angle,t.pixelToTileUnitsFactor),g=t.pixelToTileUnitsFactor/2*Y_(this.paint.get("line-width").evaluate(e,r),this.paint.get("line-gap-width").evaluate(e,r)),x=this.paint.get("line-offset").evaluate(e,r);return x&&(s=function(w,E){const I=[],A=new ue(0,0);for(let z=0;z<w.length;z++){const R=w[z],O=[];for(let U=0;U<R.length;U++){const Z=R[U-1],Q=R[U],ne=R[U+1],oe=U===0?A:Q.sub(Z)._unit()._perp(),ae=U===R.length-1?A:ne.sub(Q)._unit()._perp(),le=oe._add(ae)._unit();le._mult(1/(le.x*ae.x+le.y*ae.y)),O.push(le._mult(E)._add(Q))}I.push(O)}return I}(s,x*t.pixelToTileUnitsFactor)),function(w,E,I){for(let A=0;A<E.length;A++){const z=E[A];if(w.length>=3){for(let R=0;R<z.length;R++)if(ul(w,z[R]))return!0}if(O0(w,z,I))return!0}return!1}(f,s,g)}isTileClipped(){return!0}},symbol:$u,background:class extends xn{constructor(t){super(t,mb)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends xn{constructor(t){super(t,_b)}getProgramIds(){return["raster"]}},sky:class extends xn{constructor(t){super(t,yb),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="sky-gradient"?this._updateColorRamp():t!=="sky-atmosphere-sun"&&t!=="sky-atmosphere-halo-color"&&t!=="sky-atmosphere-color"&&t!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Dp({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(t){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=t.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}}getCenter(t,e){const r=this.paint.get("sky-type");if(r==="atmosphere"){const s=this.paint.get("sky-atmosphere-sun"),h=!s,u=t.style.light,f=u.properties.get("position");return h&&u.properties.get("anchor")==="viewport"&&ii("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),h?ef(f.azimuthal,90-f.polar,e):ef(s[0],90-s[1],e)}if(r==="gradient"){const s=this.paint.get("sky-gradient-center");return ef(s[0],90-s[1],e)}}is3D(){return!1}isSky(){return!0}markSkyboxValid(t){this._skyboxInvalidated=!1,this._lightPosition=t.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const t=this.paint.get("sky-type");return t==="atmosphere"?["skyboxCapture","skybox"]:t==="gradient"?["skyboxGradient"]:null}}},{HTMLImageElement:Ig,HTMLCanvasElement:Ag,HTMLVideoElement:Cg,ImageData:Mg,ImageBitmap:Gu}=fe;class qu{constructor(e,r,s,h){this.context=e,this.format=s,this.texture=e.gl.createTexture(),this.update(r,h)}update(e,r,s){const{width:h,height:u}=e,{context:f}=this,{gl:g}=f;if(g.bindTexture(g.TEXTURE_2D,this.texture),f.pixelStoreUnpackFlipY.set(!1),f.pixelStoreUnpack.set(1),f.pixelStoreUnpackPremultiplyAlpha.set(this.format===g.RGBA&&(!r||r.premultiply!==!1)),s||this.size&&this.size[0]===h&&this.size[1]===u){const{x,y:w}=s||{x:0,y:0};e instanceof Ig||e instanceof Ag||e instanceof Cg||e instanceof Mg||Gu&&e instanceof Gu?g.texSubImage2D(g.TEXTURE_2D,0,x,w,g.RGBA,g.UNSIGNED_BYTE,e):g.texSubImage2D(g.TEXTURE_2D,0,x,w,h,u,g.RGBA,g.UNSIGNED_BYTE,e.data)}else this.size=[h,u],e instanceof Ig||e instanceof Ag||e instanceof Cg||e instanceof Mg||Gu&&e instanceof Gu?g.texImage2D(g.TEXTURE_2D,0,this.format,this.format,g.UNSIGNED_BYTE,e):g.texImage2D(g.TEXTURE_2D,0,this.format,h,u,0,this.format,g.UNSIGNED_BYTE,e.data);this.useMipmap=Boolean(r&&r.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&g.generateMipmap(g.TEXTURE_2D)}bind(e,r){const{context:s}=this,{gl:h}=s;h.bindTexture(h.TEXTURE_2D,this.texture),e!==this.filter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,this.useMipmap?e===h.NEAREST?h.NEAREST_MIPMAP_NEAREST:h.LINEAR_MIPMAP_NEAREST:e),this.filter=e),r!==this.wrap&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,r),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,r),this.wrap=r)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class tf{constructor(e,r){this.width=e,this.height=r,this.nextRow=0,this.image=new Hs({width:e,height:r}),this.positions={},this.uploaded=!1}getDash(e,r){const s=this.getKey(e,r);return this.positions[s]}trim(){const e=this.width,r=this.height=Tr(this.nextRow);this.image.resize({width:e,height:r})}getKey(e,r){return e.join(",")+r}getDashRanges(e,r,s){const h=[];let u=e.length%2==1?-e[e.length-1]*s:0,f=e[0]*s,g=!0;h.push({left:u,right:f,isDash:g,zeroLength:e[0]===0});let x=e[0];for(let w=1;w<e.length;w++){g=!g;const E=e[w];u=x*s,x+=E,f=x*s,h.push({left:u,right:f,isDash:g,zeroLength:E===0})}return h}addRoundDash(e,r,s){const h=r/2;for(let u=-s;u<=s;u++){const f=this.width*(this.nextRow+s+u);let g=0,x=e[g];for(let w=0;w<this.width;w++){w/x.right>1&&(x=e[++g]);const E=Math.abs(w-x.left),I=Math.abs(w-x.right),A=Math.min(E,I);let z;const R=u/s*(h+1);if(x.isDash){const O=h-Math.abs(R);z=Math.sqrt(A*A+O*O)}else z=h-Math.sqrt(A*A+R*R);this.image.data[f+w]=Math.max(0,Math.min(255,z+128))}}}addRegularDash(e,r){for(let x=e.length-1;x>=0;--x){const w=e[x],E=e[x+1];w.zeroLength?e.splice(x,1):E&&E.isDash===w.isDash&&(E.left=w.left,e.splice(x,1))}const s=e[0],h=e[e.length-1];s.isDash===h.isDash&&(s.left=h.left-this.width,h.right=s.right+this.width);const u=this.width*this.nextRow;let f=0,g=e[f];for(let x=0;x<this.width;x++){x/g.right>1&&(g=e[++f]);const w=Math.abs(x-g.left),E=Math.abs(x-g.right),I=Math.min(w,E);this.image.data[u+x]=Math.max(0,Math.min(255,(g.isDash?I:-I)+r+128))}}addDash(e,r){const s=this.getKey(e,r);if(this.positions[s])return this.positions[s];const h=r==="round",u=h?7:0,f=2*u+1;if(this.nextRow+f>this.height)return ii("LineAtlas out of space"),null;e.length===0&&e.push(1);let g=0;for(let E=0;E<e.length;E++)e[E]<0&&(ii("Negative value is found in line dasharray, replacing values with 0"),e[E]=0),g+=e[E];if(g!==0){const E=this.width/g,I=this.getDashRanges(e,this.width,E);h?this.addRoundDash(I,E,u):this.addRegularDash(I,r==="square"?.5*E:0)}const x=this.nextRow+u;this.nextRow+=f;const w={tl:[x,u],br:[g,0]};return this.positions[s]=w,w}}je("LineAtlas",tf);class vb{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel!="undefined"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){delete this._channel,this._callback=()=>{}}}const bb=fe.performance;function kg(t){const e=t?t.url.toString():void 0;return bb.getEntriesByName(e)}class wb{constructor(){this.tasks={},this.taskQueue=[],Es(["process"],this),this.invoker=new vb(this.process),this.nextId=0}add(e,r){const s=this.nextId++,h=function({type:u,isSymbolTile:f,zoom:g}){return g=g||0,u==="message"?0:u!=="maybePrepare"||f?u!=="parseTile"||f?u==="parseTile"&&f?300-g:u==="maybePrepare"&&f?400-g:500:200-g:100-g}(r);if(h===0){Jr();try{e()}finally{}return{cancel:()=>{}}}return this.tasks[s]={fn:e,metadata:r,priority:h,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}}}process(){Jr();try{if(this.taskQueue=this.taskQueue.filter(s=>!!this.tasks[s]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const r=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!r)return;r.fn()}finally{}}pick(){let e=null,r=1/0;for(let h=0;h<this.taskQueue.length;h++){const u=this.tasks[this.taskQueue[h]];u.priority<r&&(r=u.priority,e=h)}if(e===null)return null;const s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}function Dg(t,e,r){var s=2*Math.PI*6378137/256/Math.pow(2,r);return[t*s-2*Math.PI*6378137/2,e*s-2*Math.PI*6378137/2]}class Zu{constructor(e,r,s){this.z=e,this.x=r,this.y=s,this.key=Nc(0,e,e,r,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,r){const s=function(u,f,g){var x=Dg(256*u,256*(f=Math.pow(2,g)-f-1),g),w=Dg(256*(u+1),256*(f+1),g);return x[0]+","+x[1]+","+w[0]+","+w[1]}(this.x,this.y,this.z),h=function(u,f,g){let x,w="";for(let E=u;E>0;E--)x=1<<E-1,w+=(f&x?1:0)+(g&x?2:0);return w}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace("{z}",String(this.z)).replace("{x}",String(this.x)).replace("{y}",String(r==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",h).replace("{bbox-epsg-3857}",s)}toString(){return`${this.z}/${this.x}/${this.y}`}}class rf{constructor(e,r){this.wrap=e,this.canonical=r,this.key=Nc(e,r.z,r.z,r.x,r.y)}}class mr{constructor(e,r,s,h,u){this.overscaledZ=e,this.wrap=r,this.canonical=new Zu(s,+h,+u),this.key=r===0&&e===s?this.canonical.key:Nc(r,e,s,h,u)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const r=this.canonical.z-e;return e>this.canonical.z?new mr(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new mr(e,this.wrap,e,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(e,r=!0){if(this.overscaledZ===e&&r)return this.key;if(e>this.canonical.z)return Nc(this.wrap*+r,e,this.canonical.z,this.canonical.x,this.canonical.y);{const s=this.canonical.z-e;return Nc(this.wrap*+r,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const r=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.x===this.canonical.x>>r&&e.canonical.y===this.canonical.y>>r}children(e){if(this.overscaledZ>=e)return[new mr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,s=2*this.canonical.x,h=2*this.canonical.y;return[new mr(r,this.wrap,r,s,h),new mr(r,this.wrap,r,s+1,h),new mr(r,this.wrap,r,s,h+1),new mr(r,this.wrap,r,s+1,h+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new mr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new mr(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new rf(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Nc(t,e,r,s,h){const u=1<<Math.min(r,22);let f=u*(h%u)+s%u;return t&&r<22&&(f+=u*u*((t<0?-2*t-1:2*t)%(1<<2*(22-r)))),16*(32*f+r)+(e-r)}je("CanonicalTileID",Zu),je("OverscaledTileID",mr,{omit:["projMatrix"]});class bl{constructor(e,r,s){this.func=e,this.mask=r,this.range=s}}bl.ReadOnly=!1,bl.ReadWrite=!0,bl.disabled=new bl(519,bl.ReadOnly,[0,1]);const nf=7680;class sf{constructor(e,r,s,h,u,f){this.test=e,this.ref=r,this.mask=s,this.fail=h,this.depthFail=u,this.pass=f}}sf.disabled=new sf({func:519,mask:0},0,0,nf,nf,nf);class Gn{constructor(e,r,s){this.blendFunction=e,this.blendColor=r,this.mask=s}}Gn.Replace=[1,0],Gn.disabled=new Gn(Gn.Replace,At.transparent,[!1,!1,!1,!1]),Gn.unblended=new Gn(Gn.Replace,At.transparent,[!0,!0,!0,!0]),Gn.alphaBlended=new Gn([1,771],At.transparent,[!0,!0,!0,!0]);const of=1029,af=2305;class wn{constructor(e,r,s){this.enable=e,this.mode=r,this.frontFace=s}}wn.disabled=new wn(!1,of,af),wn.backCCW=new wn(!0,of,af),wn.backCW=new wn(!0,of,2304),wn.frontCW=new wn(!0,1028,2304),wn.frontCCW=new wn(!0,1028,af);class zg{constructor(e){this._stringToNumber={},this._numberToString=[];for(let r=0;r<e.length;r++){const s=e[r];this._stringToNumber[s]=r,this._numberToString[r]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}class Pg{constructor(e,r,s,h,u){this.type="Feature",this._vectorTileFeature=e,e._z=r,e._x=s,e._y=h,this.properties=e.properties,this.id=u}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={geometry:this.geometry};for(const r in this)r!=="_geometry"&&r!=="_vectorTileFeature"&&(e[r]=this[r]);return e}}class Tb{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,r,s){const h=String(r);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][h]=this.stateChanges[e][h]||{},si(this.stateChanges[e][h],s),this.deletedStates[e]===null){this.deletedStates[e]={};for(const u in this.state[e])u!==h&&(this.deletedStates[e][u]=null)}else if(this.deletedStates[e]&&this.deletedStates[e][h]===null){this.deletedStates[e][h]={};for(const u in this.state[e][h])s[u]||(this.deletedStates[e][h][u]=null)}else for(const u in s)this.deletedStates[e]&&this.deletedStates[e][h]&&this.deletedStates[e][h][u]===null&&delete this.deletedStates[e][h][u]}removeFeatureState(e,r,s){if(this.deletedStates[e]===null)return;const h=String(r);if(this.deletedStates[e]=this.deletedStates[e]||{},s&&r!==void 0)this.deletedStates[e][h]!==null&&(this.deletedStates[e][h]=this.deletedStates[e][h]||{},this.deletedStates[e][h][s]=null);else if(r!==void 0)if(this.stateChanges[e]&&this.stateChanges[e][h])for(s in this.deletedStates[e][h]={},this.stateChanges[e][h])this.deletedStates[e][h][s]=null;else this.deletedStates[e][h]=null;else this.deletedStates[e]=null}getState(e,r){const s=String(r),h=si({},(this.state[e]||{})[s],(this.stateChanges[e]||{})[s]);if(this.deletedStates[e]===null)return{};if(this.deletedStates[e]){const u=this.deletedStates[e][r];if(u===null)return{};for(const f in u)delete h[f]}return h}initializeTileState(e,r){e.setFeatureState(this.state,r)}coalesceChanges(e,r){const s={};for(const h in this.stateChanges){this.state[h]=this.state[h]||{};const u={};for(const f in this.stateChanges[h])this.state[h][f]||(this.state[h][f]={}),si(this.state[h][f],this.stateChanges[h][f]),u[f]=this.state[h][f];s[h]=u}for(const h in this.deletedStates){this.state[h]=this.state[h]||{};const u={};if(this.deletedStates[h]===null)for(const f in this.state[h])u[f]={},this.state[h][f]={};else for(const f in this.deletedStates[h]){if(this.deletedStates[h][f]===null)this.state[h][f]={};else for(const g of Object.keys(this.deletedStates[h][f]))delete this.state[h][f][g];u[f]=this.state[h][f]}s[h]=s[h]||{},si(s[h],u)}if(this.stateChanges={},this.deletedStates={},Object.keys(s).length!==0)for(const h in e)e[h].setFeatureState(s,r)}}class Lg{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,r){const s=this.toIdx(e,r);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,r){return this.leaves[this.toIdx(e,r)]}toIdx(e,r){return r*this.size+e}}function Rg(t,e,r,s){let h=0,u=Number.MAX_VALUE;for(let f=0;f<3;f++)if(Math.abs(s[f])<1e-15){if(r[f]<t[f]||r[f]>e[f])return null}else{const g=1/s[f];let x=(t[f]-r[f])*g,w=(e[f]-r[f])*g;if(x>w){const E=x;x=w,w=E}if(x>h&&(h=x),w<u&&(u=w),h>u)return null}return h}function Bg(t,e,r,s,h,u,f,g,x,w,E){const I=s-t,A=h-e,z=u-r,R=f-t,O=g-e,U=x-r,Z=E[1]*U-E[2]*O,Q=E[2]*R-E[0]*U,ne=E[0]*O-E[1]*R,oe=I*Z+A*Q+z*ne;if(Math.abs(oe)<1e-15)return null;const ae=1/oe,le=w[0]-t,we=w[1]-e,ve=w[2]-r,Fe=(le*Z+we*Q+ve*ne)*ae;if(Fe<0||Fe>1)return null;const Pe=we*z-ve*A,be=ve*I-le*z,Le=le*A-we*I,Oe=(E[0]*Pe+E[1]*be+E[2]*Le)*ae;return Oe<0||Fe+Oe>1?null:(R*Pe+O*be+U*Le)*ae}function Fg(t,e,r){return(t-e)/(r-e)}function Og(t,e,r,s,h,u,f,g,x){const w=1<<r,E=u-s,I=f-h,A=(t+1)/w*E+s,z=(e+0)/w*I+h,R=(e+1)/w*I+h;g[0]=(t+0)/w*E+s,g[1]=z,x[0]=A,x[1]=R}class Ng{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const r=function(u){const f=Math.ceil(Math.log2(u.dim/8)),g=[];let x=Math.ceil(Math.pow(2,f));const w=1/x,E=(z,R,O,U,Z)=>{const Q=U?1:0,ne=(z+1)*O-Q,oe=R*O,ae=(R+1)*O-Q;Z[0]=z*O,Z[1]=oe,Z[2]=ne,Z[3]=ae};let I=new Lg(x);const A=[];for(let z=0;z<x*x;z++){E(z%x,Math.floor(z/x),w,!1,A);const R=Qs(A[0],A[1],u),O=Qs(A[2],A[1],u),U=Qs(A[2],A[3],u),Z=Qs(A[0],A[3],u);I.minimums.push(Math.min(R,O,U,Z)),I.maximums.push(Math.max(R,O,U,Z)),I.leaves.push(1)}for(g.push(I),x/=2;x>=1;x/=2){const z=g[g.length-1];I=new Lg(x);for(let R=0;R<x*x;R++){E(R%x,Math.floor(R/x),2,!0,A);const O=z.getElevation(A[0],A[1]),U=z.getElevation(A[2],A[1]),Z=z.getElevation(A[2],A[3]),Q=z.getElevation(A[0],A[3]),ne=z.isLeaf(A[0],A[1]),oe=z.isLeaf(A[2],A[1]),ae=z.isLeaf(A[2],A[3]),le=z.isLeaf(A[0],A[3]),we=Math.min(O.min,U.min,Z.min,Q.min),ve=Math.max(O.max,U.max,Z.max,Q.max),Fe=ne&&oe&&ae&&le;I.maximums.push(ve),I.minimums.push(we),I.leaves.push(ve-we<=5&&Fe?1:0)}g.push(I)}return g}(this.dem),s=r.length-1,h=r[s];this._addNode(h.minimums[0],h.maximums[0],h.leaves[0]),this._construct(r,0,0,s,0)}raycastRoot(e,r,s,h,u,f,g=1){return Rg([e,r,-100],[s,h,this.maximums[0]*g],u,f)}raycast(e,r,s,h,u,f,g=1){if(!this.nodeCount)return null;const x=this.raycastRoot(e,r,s,h,u,f,g);if(x==null)return null;const w=[],E=[],I=[],A=[],z=[{idx:0,t:x,nodex:0,nodey:0,depth:0}];for(;z.length>0;){const{idx:R,t:O,nodex:U,nodey:Z,depth:Q}=z.pop();if(this.leaves[R]){Og(U,Z,Q,e,r,s,h,I,A);const oe=1<<Q,ae=(U+0)/oe,le=(U+1)/oe,we=(Z+0)/oe,ve=(Z+1)/oe,Fe=Qs(ae,we,this.dem)*g,Pe=Qs(le,we,this.dem)*g,be=Qs(le,ve,this.dem)*g,Le=Qs(ae,ve,this.dem)*g,Oe=Bg(I[0],I[1],Fe,A[0],I[1],Pe,A[0],A[1],be,u,f),Ie=Bg(A[0],A[1],be,I[0],A[1],Le,I[0],I[1],Fe,u,f),Ve=Math.min(Oe!==null?Oe:Number.MAX_VALUE,Ie!==null?Ie:Number.MAX_VALUE);if(Ve!==Number.MAX_VALUE)return Ve;{const qe=wr([],u,f,O);if(Ug(Fe,Pe,Le,be,Fg(qe[0],I[0],A[0]),Fg(qe[1],I[1],A[1]))>=qe[2])return O}continue}let ne=0;for(let oe=0;oe<this._siblingOffset.length;oe++){Og((U<<1)+this._siblingOffset[oe][0],(Z<<1)+this._siblingOffset[oe][1],Q+1,e,r,s,h,I,A),I[2]=-100,A[2]=this.maximums[this.childOffsets[R]+oe]*g;const ae=Rg(I,A,u,f);if(ae!=null){const le=ae;w[oe]=le;let we=!1;for(let ve=0;ve<ne&&!we;ve++)le>=w[E[ve]]&&(E.splice(ve,0,oe),we=!0);we||(E[ne]=oe),ne++}}for(let oe=0;oe<ne;oe++){const ae=E[oe];z.push({idx:this.childOffsets[R]+ae,t:w[ae],nodex:(U<<1)+this._siblingOffset[ae][0],nodey:(Z<<1)+this._siblingOffset[ae][1],depth:Q+1})}}return null}_addNode(e,r,s){return this.minimums.push(e),this.maximums.push(r),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,r,s,h,u){if(e[h].isLeaf(r,s)===1)return;this.childOffsets[u]||(this.childOffsets[u]=this.nodeCount);const f=h-1,g=e[f];let x,w=0;for(let E=0;E<this._siblingOffset.length;E++){const I=2*r+this._siblingOffset[E][0],A=2*s+this._siblingOffset[E][1],z=g.getElevation(I,A),R=g.isLeaf(I,A),O=this._addNode(z.min,z.max,R);R&&(w|=1<<E),x||(x=O)}for(let E=0;E<this._siblingOffset.length;E++)w&1<<E||this._construct(e,2*r+this._siblingOffset[E][0],2*s+this._siblingOffset[E][1],f,x+E)}}function Ug(t,e,r,s,h,u){return Lt(Lt(t,r,u),Lt(e,s,u),h)}function Qs(t,e,r){const s=r.dim,h=Ft(t*s-.5,0,s-1),u=Ft(e*s-.5,0,s-1),f=Math.floor(h),g=Math.floor(u),x=Math.min(f+1,s-1),w=Math.min(g+1,s-1);return Ug(r.get(f,g),r.get(x,g),r.get(f,w),r.get(x,w),h-f,u-g)}const Vg={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};class Wu{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,r,s,h=!1,u=!1){if(this.uid=e,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(s&&s!=="mapbox"&&s!=="terrarium")return ii(`"${s}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=r.height;const f=this.dim=r.height-2;if(this.data=new Uint32Array(r.data.buffer),this.encoding=s||"mapbox",this.borderReady=h,!h){for(let g=0;g<f;g++)this.data[this._idx(-1,g)]=this.data[this._idx(0,g)],this.data[this._idx(f,g)]=this.data[this._idx(f-1,g)],this.data[this._idx(g,-1)]=this.data[this._idx(g,0)],this.data[this._idx(g,f)]=this.data[this._idx(g,f-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(f,-1)]=this.data[this._idx(f-1,0)],this.data[this._idx(-1,f)]=this.data[this._idx(0,f-1)],this.data[this._idx(f,f)]=this.data[this._idx(f-1,f-1)],u&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new Ng(this)}get(e,r,s=!1){const h=new Uint8Array(this.data.buffer);s&&(e=Ft(e,-1,this.dim),r=Ft(r,-1,this.dim));const u=4*this._idx(e,r);return(this.encoding==="terrarium"?this._unpackTerrarium:this._unpackMapbox)(h[u],h[u+1],h[u+2])}static getUnpackVector(e){return Vg[e]}get unpackVector(){return Vg[this.encoding]}_idx(e,r){if(e<-1||e>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(r+1)*this.stride+(e+1)}_unpackMapbox(e,r,s){return(256*e*256+256*r+s)/10-1e4}_unpackTerrarium(e,r,s){return 256*e+r+s/256-32768}static pack(e,r){const s=[0,0,0,0],h=Wu.getUnpackVector(r);let u=Math.floor((e+h[3])/h[2]);return s[2]=u%256,u=Math.floor(u/256),s[1]=u%256,u=Math.floor(u/256),s[0]=u,s}getPixels(){return new qr({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(e,r,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let h=r*this.dim,u=r*this.dim+this.dim,f=s*this.dim,g=s*this.dim+this.dim;switch(r){case-1:h=u-1;break;case 1:u=h+1}switch(s){case-1:f=g-1;break;case 1:g=f+1}const x=-r*this.dim,w=-s*this.dim;for(let E=f;E<g;E++)for(let I=h;I<u;I++)this.data[this._idx(I,E)]=e.data[this._idx(I+x,E+w)]}onDeserialize(){this._tree&&(this._tree.dem=this)}}je("DEMData",Wu),je("DemMinMaxQuadTree",Ng,{omit:["dem"]});class Eb{constructor(e,r){this.max=e,this.onRemove=r,this.reset()}reset(){for(const e in this.data)for(const r of this.data[e])r.timeout&&clearTimeout(r.timeout),this.onRemove(r.value);return this.data={},this.order=[],this}add(e,r,s){const h=e.wrapped().key;this.data[h]===void 0&&(this.data[h]=[]);const u={value:r,timeout:void 0};if(s!==void 0&&(u.timeout=setTimeout(()=>{this.remove(e,u)},s)),this.data[h].push(u),this.order.push(h),this.order.length>this.max){const f=this._getAndRemoveByKey(this.order[0]);f&&this.onRemove(f)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const r=this.data[e].shift();return r.timeout&&clearTimeout(r.timeout),this.data[e].length===0&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),r.value}getByKey(e){const r=this.data[e];return r?r[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,r){if(!this.has(e))return this;const s=e.wrapped().key,h=r===void 0?0:this.data[s].indexOf(r),u=this.data[s][h];return this.data[s].splice(h,1),u.timeout&&clearTimeout(u.timeout),this.data[s].length===0&&delete this.data[s],this.onRemove(u.value),this.order.splice(this.order.indexOf(s),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const r=this._getAndRemoveByKey(this.order[0]);r&&this.onRemove(r)}return this}filter(e){const r=[];for(const s in this.data)for(const h of this.data[s])e(h.value)||r.push(h);for(const s of r)this.remove(s.value.tileID,s)}}class Jo extends Dn{constructor(e,r,s){super(),this.id=e,this._onlySymbols=s,r.on("data",h=>{h.dataType==="source"&&h.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&h.dataType==="source"&&h.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),r.on("error",()=>{this._sourceErrored=!0}),this._source=r,this._tiles={},this._cache=new Eb(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=null,this._maxTileCacheSize=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new Tb}onAdd(e){this.map=e,this._minTileCacheSize=e?e._minTileCacheSize:null,this._maxTileCacheSize=e?e._maxTileCacheSize:null}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const e in this._tiles){const r=this._tiles[e];if(r.state!=="loaded"&&r.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(e,r){return e.isSymbolTile=this._onlySymbols,this._source.loadTile(e,r)}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e,()=>{})}_abortTile(e){if(this._source.abortTile)return this._source.abortTile(e,()=>{})}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const r in this._tiles){const s=this._tiles[r];s.upload(e),s.prepare(this.map.style.imageManager)}}getIds(){return Ts(this._tiles).map(e=>e.tileID).sort(jg).map(e=>e.key)}getRenderableIds(e){const r=[];for(const s in this._tiles)this._isIdRenderable(+s,e)&&r.push(this._tiles[s]);return e?r.sort((s,h)=>{const u=s.tileID,f=h.tileID,g=new ue(u.canonical.x,u.canonical.y)._rotate(this.transform.angle),x=new ue(f.canonical.x,f.canonical.y)._rotate(this.transform.angle);return u.overscaledZ-f.overscaledZ||x.y-g.y||x.x-g.x}).map(s=>s.tileID.key):r.map(s=>s.tileID).sort(jg).map(s=>s.key)}hasRenderableParent(e){const r=this.findLoadedParent(e,0);return!!r&&this._isIdRenderable(r.tileID.key)}_isIdRenderable(e,r){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(r||!this._tiles[e].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)this._tiles[e].state!=="errored"&&this._reloadTile(+e,"reloading")}}_reloadTile(e,r){const s=this._tiles[e];s&&(s.state!=="loading"&&(s.state=r),this._loadTile(s,this._tileLoaded.bind(this,s,e,r)))}_tileLoaded(e,r,s,h){if(h)if(e.state="errored",h.status!==404)this._source.fire(new Aa(h,{tile:e}));else if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const u=this.map.painter.terrain;this.update(this.transform,u.getScaledDemTileSize(),!0),u.resetTileLookupCache(this.id)}else this.update(this.transform);else e.timeAdded=ur.now(),s==="expired"&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(r,e),this._source.type==="raster-dem"&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null),this._source.fire(new kn("data",{dataType:"source",tile:e,coord:e.tileID,sourceCacheId:this.id}))}_backfillDEM(e){const r=this.getRenderableIds();for(let h=0;h<r.length;h++){const u=r[h];if(e.neighboringTiles&&e.neighboringTiles[u]){const f=this.getTileByID(u);s(e,f),s(f,e)}}function s(h,u){if(!h.dem||h.dem.borderReady)return;h.needsHillshadePrepare=!0,h.needsDEMTextureUpload=!0;let f=u.tileID.canonical.x-h.tileID.canonical.x;const g=u.tileID.canonical.y-h.tileID.canonical.y,x=Math.pow(2,h.tileID.canonical.z),w=u.tileID.key;f===0&&g===0||Math.abs(g)>1||(Math.abs(f)>1&&(Math.abs(f+x)===1?f+=x:Math.abs(f-x)===1&&(f-=x)),u.dem&&h.dem&&(h.dem.backfillBorder(u.dem,f,g),h.neighboringTiles&&h.neighboringTiles[w]&&(h.neighboringTiles[w].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,r,s,h){for(const u in this._tiles){let f=this._tiles[u];if(h[u]||!f.hasData()||f.tileID.overscaledZ<=r||f.tileID.overscaledZ>s)continue;let g=f.tileID;for(;f&&f.tileID.overscaledZ>r+1;){const w=f.tileID.scaledTo(f.tileID.overscaledZ-1);f=this._tiles[w.key],f&&f.hasData()&&(g=w)}let x=g;for(;x.overscaledZ>r;)if(x=x.scaledTo(x.overscaledZ-1),e[x.key]){h[g.key]=g;break}}}findLoadedParent(e,r){if(e.key in this._loadedParentTiles){const s=this._loadedParentTiles[e.key];return s&&s.tileID.overscaledZ>=r?s:null}for(let s=e.overscaledZ-1;s>=r;s--){const h=e.scaledTo(s),u=this._getLoadedTile(h);if(u)return u}}_getLoadedTile(e){const r=this._tiles[e.key];return r&&r.hasData()?r:this._cache.getByKey(this._source.reparseOverscaled?e.wrapped().key:e.canonical.key)}updateCacheSize(e,r){r=r||this._source.tileSize;const s=Math.ceil(e.width/r)+1,h=Math.ceil(e.height/r)+1,u=Math.floor(s*h*5),f=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,u):u,g=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,f):f;this._cache.setMaxSize(g)}handleWrapJump(e){const r=Math.round((e-(this._prevLng===void 0?e:this._prevLng))/360);if(this._prevLng=e,r){const s={};for(const h in this._tiles){const u=this._tiles[h];u.tileID=u.tileID.unwrapTo(u.tileID.wrap+r),s[u.tileID.key]=u}this._tiles=s;for(const h in this._timers)clearTimeout(this._timers[h]),delete this._timers[h];for(const h in this._tiles)this._setTileReloadTimer(+h,this._tiles[h])}}update(e,r,s){if(this.transform=e,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!s)return;let h;this.updateCacheSize(e,r),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?h=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(g=>new mr(g.canonical.z,g.wrap,g.canonical.z,g.canonical.x,g.canonical.y)):(h=e.coveringTiles({tileSize:r||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!s,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(h=h.filter(g=>this._source.hasTile(g)))):h=[];const u=this._updateRetainedTiles(h);if($g(this._source.type)&&h.length!==0){const g={},x={},w=Object.keys(u);for(const I of w){const A=u[I],z=this._tiles[I];if(!z||z.fadeEndTime&&z.fadeEndTime<=ur.now())continue;const R=this.findLoadedParent(A,Math.max(A.overscaledZ-Jo.maxOverzooming,this._source.minzoom));R&&(this._addTile(R.tileID),g[R.tileID.key]=R.tileID),x[I]=A}const E=h[h.length-1].overscaledZ;for(const I in this._tiles){const A=this._tiles[I];if(u[I]||!A.hasData())continue;let z=A.tileID;for(;z.overscaledZ>E;){z=z.scaledTo(z.overscaledZ-1);const R=this._tiles[z.key];if(R&&R.hasData()&&x[z.key]){u[I]=A.tileID;break}}}for(const I in g)u[I]||(this._coveredTiles[I]=!0,u[I]=g[I])}for(const g in u)this._tiles[g].clearFadeHold();const f=function(g,x){const w=[];for(const E in g)E in x||w.push(E);return w}(this._tiles,u);for(const g of f){const x=this._tiles[g];x.hasSymbolBuckets&&!x.holdingForFade()?x.setHoldDuration(this.map._fadeDuration):x.hasSymbolBuckets&&!x.symbolFadeFinished()||this._removeTile(+g)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(+e)}_updateRetainedTiles(e){const r={};if(e.length===0)return r;const s={},h=e.reduce((w,E)=>Math.min(w,E.overscaledZ),1/0),u=e[0].overscaledZ,f=Math.max(u-Jo.maxOverzooming,this._source.minzoom),g=Math.max(u+Jo.maxUnderzooming,this._source.minzoom),x={};for(const w of e){const E=this._addTile(w);r[w.key]=w,E.hasData()||h<this._source.maxzoom&&(x[w.key]=w)}this._retainLoadedChildren(x,h,g,r);for(const w of e){let E=this._tiles[w.key];if(E.hasData())continue;if(w.canonical.z>=this._source.maxzoom){const A=w.children(this._source.maxzoom)[0],z=this.getTile(A);if(z&&z.hasData()){r[A.key]=A;continue}}else{const A=w.children(this._source.maxzoom);if(r[A[0].key]&&r[A[1].key]&&r[A[2].key]&&r[A[3].key])continue}let I=E.wasRequested();for(let A=w.overscaledZ-1;A>=f;--A){const z=w.scaledTo(A);if(s[z.key]||(s[z.key]=!0,E=this.getTile(z),!E&&I&&(E=this._addTile(z)),E&&(r[z.key]=z,I=E.wasRequested(),E.hasData())))break}}return r}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const r=[];let s,h=this._tiles[e].tileID;for(;h.overscaledZ>0;){if(h.key in this._loadedParentTiles){s=this._loadedParentTiles[h.key];break}r.push(h.key);const u=h.scaledTo(h.overscaledZ-1);if(s=this._getLoadedTile(u),s)break;h=u}for(const u of r)this._loadedParentTiles[u]=s}}_addTile(e){let r=this._tiles[e.key];if(r)return r;r=this._cache.getAndRemove(e),r&&(this._setTileReloadTimer(e.key,r),r.tileID=e,this._state.initializeTileState(r,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,r)));const s=Boolean(r);if(!s){const h=this.map?this.map.painter:null,u=this._source.type==="raster"||this._source.type==="raster-dem";r=new cf(e,this._source.tileSize*e.overscaleFactor(),this.transform.tileZoom,h,u),this._loadTile(r,this._tileLoaded.bind(this,r,e.key,r.state))}return r?(r.uses++,this._tiles[e.key]=r,s||this._source.fire(new kn("dataloading",{tile:r,coord:r.tileID,dataType:"source"})),r):null}_setTileReloadTimer(e,r){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const s=r.getExpiryTimeout();s&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e]},s))}_removeTile(e){const r=this._tiles[e];r&&(r.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),r.uses>0||(r.hasData()&&r.state!=="reloading"?this._cache.add(r.tileID,r,r.getExpiryTimeout()):(r.aborted=!0,this._abortTile(r),this._unloadTile(r))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(+e);this._source._clear&&this._source._clear(),this._cache.reset()}tilesIn(e,r,s){const h=[],u=this.transform;if(!u)return h;for(const f in this._tiles){const g=this._tiles[f];if(s&&g.clearQueryDebugViz(),g.holdingForFade())continue;const x=e.containsTile(g,u,r);x&&h.push(x)}return h}getVisibleCoordinates(e){const r=this.getRenderableIds(e).map(s=>this._tiles[s].tileID);for(const s of r)s.projMatrix=this.transform.calculateProjMatrix(s.toUnwrapped());return r}hasTransition(){if(this._source.hasTransition())return!0;if($g(this._source.type))for(const e in this._tiles){const r=this._tiles[e];if(r.fadeEndTime!==void 0&&r.fadeEndTime>=ur.now())return!0}return!1}setFeatureState(e,r,s){this._state.updateState(e=e||"_geojsonTileLayer",r,s)}removeFeatureState(e,r,s){this._state.removeFeatureState(e=e||"_geojsonTileLayer",r,s)}getFeatureState(e,r){return this._state.getState(e=e||"_geojsonTileLayer",r)}setDependencies(e,r,s){const h=this._tiles[e];h&&h.setDependencies(r,s)}reloadTilesForDependencies(e,r){for(const s in this._tiles)this._tiles[s].hasDependency(e,r)&&this._reloadTile(+s,"reloading");this._cache.filter(s=>!s.hasDependency(e,r))}_preloadTiles(e,r){const s=new Map,h=Array.isArray(e)?e:[e],u=this.map.painter.terrain,f=this.usedForTerrain&&u?u.getScaledDemTileSize():this._source.tileSize;for(const w of h){const E=w.coveringTiles({tileSize:f,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const I of E)s.set(I.key,I);this.usedForTerrain&&w.updateElevation(!1)}const g=Array.from(s.values()),x=this._source.type==="raster"||this._source.type==="raster-dem";es(g,(w,E)=>{const I=new cf(w,this._source.tileSize*w.overscaleFactor(),this.transform.tileZoom,this.map.painter,x);this._loadTile(I,A=>{this._source.type==="raster-dem"&&I.dem&&this._backfillDEM(I),E(A,I)})},r)}}function jg(t,e){const r=Math.abs(2*t.wrap)-+(t.wrap<0),s=Math.abs(2*e.wrap)-+(e.wrap<0);return t.overscaledZ-e.overscaledZ||s-r||e.canonical.y-t.canonical.y||e.canonical.x-t.canonical.x}function $g(t){return t==="raster"||t==="image"||t==="video"}Jo.maxOverzooming=10,Jo.maxUnderzooming=3;class Xu{constructor(e,r,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=r,this._offset=s}static create(e,r,s){const h=s||e.findDEMTileFor(r);if(!h||!h.dem)return;const u=h.dem,f=h.tileID,g=1<<r.canonical.z-f.canonical.z;return new Xu(h,h.tileSize/yt/g,[(r.canonical.x/g-f.canonical.x)*u.dim,(r.canonical.y/g-f.canonical.y)*u.dim])}tileCoordToPixel(e,r){const s=r*this._scale+this._offset[1],h=Math.floor(e*this._scale+this._offset[0]),u=Math.floor(s);return new ue(h,u)}getElevationAt(e,r,s,h){const u=e*this._scale+this._offset[0],f=r*this._scale+this._offset[1],g=Math.floor(u),x=Math.floor(f),w=this._dem;return h=!!h,s?Lt(Lt(w.get(g,x,h),w.get(g,x+1,h),f-x),Lt(w.get(g+1,x,h),w.get(g+1,x+1,h),f-x),u-g):w.get(g,x,h)}getElevationAtPixel(e,r,s){return this._dem.get(e,r,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*vn(1,e)*this._dem.stride}}class Gg{constructor(e,r){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new $o(yt,16,0),this.featureIndexArray=new f_,this.promoteId=r}insert(e,r,s,h,u,f=0){const g=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,h,u,f);const x=this.grid;for(let w=0;w<r.length;w++){const E=r[w],I=[1/0,1/0,-1/0,-1/0];for(let A=0;A<E.length;A++){const z=E[A];I[0]=Math.min(I[0],z.x),I[1]=Math.min(I[1],z.y),I[2]=Math.max(I[2],z.x),I[3]=Math.max(I[3],z.y)}I[0]<yt&&I[1]<yt&&I[2]>=0&&I[3]>=0&&x.insert(g,I[0],I[1],I[2],I[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Yo.VectorTile(new Bc(this.rawTileData)).layers,this.sourceLayerCoder=new zg(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,r,s,h){this.loadVTLayers();const u=e.params||{},f=tl(u.filter),g=e.tileResult,x=e.transform,w=g.bufferedTilespaceBounds,E=this.grid.query(w.min.x,w.min.y,w.max.x,w.max.y,(R,O,U,Z)=>D_(g.bufferedTilespaceGeometry,R,O,U,Z));E.sort(Sb);let I=null;x.elevation&&E.length>0&&(I=Xu.create(x.elevation,this.tileID));const A={};let z;for(let R=0;R<E.length;R++){const O=E[R];if(O===z)continue;z=O;const U=this.featureIndexArray.get(O);let Z=null;this.loadMatchingFeature(A,U,f,u.layers,u.availableImages,r,s,h,(Q,ne,oe,ae=0)=>(Z||(Z=us(Q,this.tileID.canonical,e.tileTransform)),ne.queryIntersectsFeature(g,Q,oe,Z,this.z,e.transform,e.pixelPosMatrix,I,ae)))}return A}loadMatchingFeature(e,r,s,h,u,f,g,x,w){const{featureIndex:E,bucketIndex:I,sourceLayerIndex:A,layoutVertexArrayOffset:z}=r,R=this.bucketLayerIDs[I];if(h&&!function(Q,ne){for(let oe=0;oe<Q.length;oe++)if(ne.indexOf(Q[oe])>=0)return!0;return!1}(h,R))return;const O=this.sourceLayerCoder.decode(A),U=this.vtLayers[O].feature(E);if(s.needGeometry){const Q=Ko(U,!0);if(!s.filter(new ot(this.tileID.overscaledZ),Q,this.tileID.canonical))return}else if(!s.filter(new ot(this.tileID.overscaledZ),U))return;const Z=this.getId(U,O);for(let Q=0;Q<R.length;Q++){const ne=R[Q];if(h&&h.indexOf(ne)<0)continue;const oe=f[ne];if(!oe)continue;let ae={};Z!==void 0&&x&&(ae=x.getState(oe.sourceLayer||"_geojsonTileLayer",Z));const le=si({},g[ne]);le.paint=qg(le.paint,oe.paint,U,ae,u),le.layout=qg(le.layout,oe.layout,U,ae,u);const we=!w||w(U,oe,ae,z);if(!we)continue;const ve=new Pg(U,this.z,this.x,this.y,Z);ve.layer=le;let Fe=e[ne];Fe===void 0&&(Fe=e[ne]=[]),Fe.push({featureIndex:E,feature:ve,intersectionZ:we})}}lookupSymbolFeatures(e,r,s,h,u,f,g,x){const w={};this.loadVTLayers();const E=tl(u);for(const I of e)this.loadMatchingFeature(w,{bucketIndex:s,sourceLayerIndex:h,featureIndex:I,layoutVertexArrayOffset:0},E,f,g,x,r);return w}loadFeature(e){const{featureIndex:r,sourceLayerIndex:s}=e;this.loadVTLayers();const h=this.sourceLayerCoder.decode(s),u=this.vtFeatures[h];if(u[r])return u[r];const f=this.vtLayers[h].feature(r);return u[r]=f,f}hasLayer(e){for(const r of this.bucketLayerIDs)for(const s of r)if(e===s)return!0;return!1}getId(e,r){let s=e.id;return this.promoteId&&(s=e.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[r]],typeof s=="boolean"&&(s=Number(s))),s}}function qg(t,e,r,s,h){return An(t,(u,f)=>{const g=e instanceof ss?e.get(f):null;return g&&g.evaluate?g.evaluate(r,s,h):g})}function Sb(t,e){return e-t}je("FeatureIndex",Gg,{omit:["rawTileData","sourceLayerCoder"]});var Ib=ni([{name:"a_pos",type:"Int16",components:2}]);const an=32,qn=33,eo=new Uint16Array(8184);for(let t=0;t<2046;t++){let e=t+2,r=0,s=0,h=0,u=0,f=0,g=0;for(1&e?h=u=f=an:r=s=g=an;(e>>=1)>1;){const w=r+h>>1,E=s+u>>1;1&e?(h=r,u=s,r=f,s=g):(r=h,s=u,h=f,u=g),f=w,g=E}const x=4*t;eo[x+0]=r,eo[x+1]=s,eo[x+2]=h,eo[x+3]=u}const Zn=new Uint16Array(2178),to=new Uint8Array(1089),Hu=new Uint16Array(1089);function Zg(t){return t===0?-.03125:t===32?.03125:0}var lf=ni([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const Wg={type:2,extent:yt,loadGeometry:()=>[[new ue(0,0),new ue(8193,0),new ue(8193,8193),new ue(0,8193),new ue(0,0)]]};class cf{constructor(e,r,s,h,u){this.tileID=e,this.uid=go(),this.uses=0,this.tileSize=r,this.tileZoom=s,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=u,this.expiredRequestCount=0,this.state="loading",h&&h.transform&&(this.projection=h.transform.projection)}registerFadeDuration(e){const r=e+this.timeAdded;r<ur.now()||this.fadeEndTime&&r<this.fadeEndTime||(this.fadeEndTime=r)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=wl(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(e,r,s){if(this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=function(h,u){const f={};if(!u)return f;for(const g of h){const x=g.layerIds.map(w=>u.getLayer(w)).filter(Boolean);if(x.length!==0){g.layers=x,g.stateDependentLayerIds&&(g.stateDependentLayers=g.stateDependentLayerIds.map(w=>x.filter(E=>E.id===w)[0]));for(const w of x)f[w.id]=g}}return f}(e.buckets,r.style),this.hasSymbolBuckets=!1;for(const h in this.buckets){const u=this.buckets[h];if(u instanceof Js){if(this.hasSymbolBuckets=!0,!s)break;u.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const h in this.buckets){const u=this.buckets[h];if(u instanceof Js&&u.hasRTLText){this.hasRTLText=!0,Et.isLoading()||Et.isLoaded()||kr()!=="deferred"||$r();break}}this.queryPadding=0;for(const h in this.buckets){const u=this.buckets[h];this.queryPadding=Math.max(this.queryPadding,r.style.getLayer(h).queryRadius(u))}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage),e.lineAtlas&&(this.lineAtlas=e.lineAtlas)}else this.collisionBoxArray=new vp}unloadVectorData(){if(this.hasData()){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugIndexBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this.globeGridBuffer&&(this.globeGridBuffer.destroy(),this.globeGridBuffer=null),this.globePoleBuffer&&(this.globePoleBuffer.destroy(),this.globePoleBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(e){return this.buckets[e.id]}upload(e){for(const s in this.buckets){const h=this.buckets[s];h.uploadPending()&&h.upload(e)}const r=e.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new qu(e,this.imageAtlas.image,r.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new qu(e,this.glyphAtlasImage,r.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new qu(e,this.lineAtlas.image,r.ALPHA),this.lineAtlas.uploaded=!0)}prepare(e){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture)}queryRenderedFeatures(e,r,s,h,u,f,g,x){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:h,pixelPosMatrix:g,transform:f,params:u,tileTransform:this.tileTransform},e,r,s):{}}querySourceFeatures(e,r){const s=this.latestFeatureIndex;if(!s||!s.rawTileData)return;const h=s.loadVTLayers(),u=r?r.sourceLayer:"",f=h._geojsonTileLayer||h[u];if(!f)return;const g=tl(r&&r.filter),{z:x,x:w,y:E}=this.tileID.canonical,I={z:x,x:w,y:E};for(let A=0;A<f.length;A++){const z=f.feature(A);if(g.needGeometry){const U=Ko(z,!0);if(!g.filter(new ot(this.tileID.overscaledZ),U,this.tileID.canonical))continue}else if(!g.filter(new ot(this.tileID.overscaledZ),z))continue;const R=s.getId(z,u),O=new Pg(z,x,w,E,R);O.tile=I,e.push(O)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(e){const r=this.expirationTime;if(e.cacheControl){const s=Cs(e.cacheControl);s["max-age"]&&(this.expirationTime=Date.now()+1e3*s["max-age"])}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){const s=Date.now();let h=!1;if(this.expirationTime>s)h=!1;else if(r)if(this.expirationTime<r)h=!0;else{const u=this.expirationTime-r;u?this.expirationTime=s+Math.max(u,3e4):h=!0}else h=!0;h?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(e,r){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(e).length===0||!r)return;const s=this.latestFeatureIndex.loadVTLayers(),h=r.style.listImages();for(const u in this.buckets){if(!r.style.hasLayer(u))continue;const f=this.buckets[u],g=f.layers[0].sourceLayer||"_geojsonTileLayer",x=s[g],w=e[g];if(!x||!w||Object.keys(w).length===0)continue;if(f.update(w,x,h,this.imageAtlas&&this.imageAtlas.patternPositions||{}),f instanceof Lu||f instanceof Pu){const I=r.style._getSourceCache(f.layers[0].source);r._terrain&&r._terrain.enabled&&I&&f.programConfigurations.needsUpload&&r._terrain._clearRenderCacheForTile(I.id,this.tileID)}const E=r&&r.style&&r.style.getLayer(u);E&&(this.queryPadding=Math.max(this.queryPadding,E.queryRadius(f)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<ur.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(e){this.symbolFadeHoldUntil=ur.now()+e}setDependencies(e,r){const s={};for(const h of r)s[h]=!0;this.dependencies[e]=s}hasDependency(e,r){for(const s of e){const h=this.dependencies[s];if(h){for(const u of r)if(h[u])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(e,r){if(!r||r.name==="mercator"||this._tileDebugBuffer)return;const s=us(Wg,this.tileID.canonical,this.tileTransform)[0],h=new sl,u=new xu;for(let f=0;f<s.length;f++){const{x:g,y:x}=s[f];h.emplaceBack(g,x),u.emplaceBack(f)}u.emplaceBack(0),this._tileDebugIndexBuffer=e.createIndexBuffer(u),this._tileDebugBuffer=e.createVertexBuffer(h,lf.members),this._tileDebugSegments=_i.simpleSegment(0,0,h.length,u.length)}_makeTileBoundsBuffers(e,r){if(this._tileBoundsBuffer||!r||r.name==="mercator")return;const s=us(Wg,this.tileID.canonical,this.tileTransform)[0];let h,u;if(this.isRaster){const f=function(g,x){const w=wl(g,x),E=Math.pow(2,g.z);for(let U=0;U<qn;U++)for(let Z=0;Z<qn;Z++){const Q=hs((g.x+(Z+Zg(Z))/an)/E),ne=on((g.y+(U+Zg(U))/an)/E),oe=x.project(Q,ne),ae=U*qn+Z;Zn[2*ae+0]=Math.round((oe.x*w.scale-w.x)*yt),Zn[2*ae+1]=Math.round((oe.y*w.scale-w.y)*yt)}to.fill(0),Hu.fill(0);for(let U=2045;U>=0;U--){const Z=4*U,Q=eo[Z+0],ne=eo[Z+1],oe=eo[Z+2],ae=eo[Z+3],le=Q+oe>>1,we=ne+ae>>1,ve=le+we-ne,Fe=we+Q-le,Pe=ne*qn+Q,be=ae*qn+oe,Le=we*qn+le,Oe=Math.hypot((Zn[2*Pe+0]+Zn[2*be+0])/2-Zn[2*Le+0],(Zn[2*Pe+1]+Zn[2*be+1])/2-Zn[2*Le+1])>=16;if(to[Le]=to[Le]||(Oe?1:0),U<1022){const Ie=(ne+Fe>>1)*qn+(Q+ve>>1),Ve=(ae+Fe>>1)*qn+(oe+ve>>1);to[Le]=to[Le]||to[Ie]||to[Ve]}}const I=new ol,A=new Gr;let z=0;function R(U,Z){const Q=Z*qn+U;return Hu[Q]===0&&(I.emplaceBack(Zn[2*Q+0],Zn[2*Q+1],U*yt/an,Z*yt/an),Hu[Q]=++z),Hu[Q]-1}function O(U,Z,Q,ne,oe,ae){const le=U+Q>>1,we=Z+ne>>1;if(Math.abs(U-oe)+Math.abs(Z-ae)>1&&to[we*qn+le])O(oe,ae,U,Z,le,we),O(Q,ne,oe,ae,le,we);else{const ve=R(U,Z),Fe=R(Q,ne),Pe=R(oe,ae);A.emplaceBack(ve,Fe,Pe)}}return O(0,0,an,an,an,0),O(an,an,0,0,0,an),{vertices:I,indices:A}}(this.tileID.canonical,r);h=f.vertices,u=f.indices}else{h=new ol,u=new Gr;for(const{x:g,y:x}of s)h.emplaceBack(g,x,0,0);const f=Cu(h.int16,void 0,4);for(let g=0;g<f.length;g+=3)u.emplaceBack(f[g],f[g+1],f[g+2])}this._tileBoundsBuffer=e.createVertexBuffer(h,lf.members),this._tileBoundsIndexBuffer=e.createIndexBuffer(u),this._tileBoundsSegments=_i.simpleSegment(0,0,h.length,u.length)}}const Ab=ni([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_merc_pos",components:2},{type:"Float32",name:"a_uv",components:2}]),Cb=ni([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Xg}=Ab;function Qo(t,e){const r=t.fovAboveCenter,s=t.elevation?t.elevation.getMinElevationBelowMSL()*e:0,h=(t._camera.position[2]*t.worldSize-s)/Math.cos(t._pitch),u=Math.sin(r)*h/Math.sin(Math.max(Math.PI/2-t._pitch-r,.01)),f=Math.sin(t._pitch)*u+h;return Math.min(1.01*f,h*(1/t._horizonShift))}const hf=yt/Math.PI/2,Dr=-hf,zr=hf,Mb=[new bn([Dr,Dr,Dr],[zr,zr,zr]),new bn([Dr,Dr,Dr],[0,0,zr]),new bn([0,Dr,Dr],[zr,0,zr]),new bn([Dr,0,Dr],[0,zr,zr]),new bn([0,0,Dr],[zr,zr,zr])];function Ku(t){if(t.z<=1)return Mb[t.z+2*t.y+t.x];const[e,r]=Hg(t),s=[Yu(e[0],e[1]),Yu(e[0],r[1]),Yu(r[0],e[1]),Yu(r[0],r[1])],h=[zr,zr,zr],u=[Dr,Dr,Dr];for(const f of s)h[0]=Math.min(h[0],f[0]),h[1]=Math.min(h[1],f[1]),h[2]=Math.min(h[2],f[2]),u[0]=Math.max(u[0],f[0]),u[1]=Math.max(u[1],f[1]),u[2]=Math.max(u[2],f[2]);return new bn(h,u)}function Hg(t){const e=Math.pow(2,t.z),r=t.x/e,s=(t.x+1)/e,h=(t.y+1)/e;return[[on(t.y/e),hs(r)],[on(h),hs(s)]]}function uf(t,e,r,s){return r=gt(r),s||(s=hf),[t*Math.sin(r)*s,-e*s,t*Math.cos(r)*s]}function Yu(t,e,r){return uf(Math.cos(gt(t)),Math.sin(gt(t)),e,r)}function Kg(t){return 16383/Math.max(...Jn([],t.max,t.min))}function Yg(t){const e=ti(new Float64Array(16)),r=1/Kg(t);return Gi(e,e,t.min),Ti(e,e,[r,r,r]),e}function Jg(t,e,r){const s=e/(2*Math.PI),h=function(f){const g=yt/(2*Math.PI);return f/(2*Math.PI)/g}(e);if(!r){const f=Ft(t.center.lat,-85.051129,jn);r=[cl(t.center.lng)*e,hl(f)*e]}const u=ti(new Float64Array(16));return Gi(u,u,[r[0],r[1],-s]),Ti(u,u,[h,h,h]),cn(u,u,gt(-t._center.lat)),br(u,u,gt(-t._center.lng)),u}class df{constructor(e){const r=this._createGridIndices();this.gridIndexBuffer=e.createIndexBuffer(r,!0),this.gridSegments=_i.simpleSegment(0,0,4225,8192);const s=this._createPoleTriangleIndices();this.poleIndexBuffer=e.createIndexBuffer(s,!0),this.poleSegments=_i.simpleSegment(0,0,66,64);const h=new Ic;h.emplaceBack(-1,1,1,0,0,0,0),h.emplaceBack(1,1,1,0,0,1,0),h.emplaceBack(1,-1,1,0,0,1,1),h.emplaceBack(-1,-1,1,0,0,0,1);const u=new Gr;u.emplaceBack(0,1,2),u.emplaceBack(2,3,0),this.atmosphereVertexBuffer=e.createVertexBuffer(h,Cb.members),this.atmosphereIndexBuffer=e.createIndexBuffer(u),this.atmosphereSegments=_i.simpleSegment(0,0,4,2)}destroy(){this.poleIndexBuffer.destroy(),this.gridIndexBuffer.destroy(),this.poleSegments.destroy(),this.gridSegments.destroy(),this.atmosphereVertexBuffer.destroy(),this.atmosphereIndexBuffer.destroy(),this.atmosphereSegments.destroy(),this.wireframeIndexBuffer&&(this.wireframeIndexBuffer.destroy(),this.wireframeSegments.destroy())}static createPoleTriangleVertices(e,r,s){const h=new Ic,u=r/Math.PI/2;h.emplaceBack(0,-u,0,0,0,.5,s?0:1);const f=360/e,g=Math.cos(gt(85)),x=Math.sin(gt(85));for(let E=0;E<=64;E++){const I=E/64,A=uf(g,x,0*(1-(w=I))+f*w,u);h.emplaceBack(A[0],A[1],A[2],0,0,I,s?0:1)}var w;return h}_createPoleTriangleIndices(){const e=new Gr;for(let r=0;r<=64;r++)e.emplaceBack(0,r+1,r+2);return e}static createGridVertices(e){const r=Math.pow(2,e.z),s=(x,w,E)=>x*(1-E)+w*E,[h,u]=Hg(e),f=new Ic,g=function(x){const w=ti(new Float64Array(16)),E=Kg(x);var I,A;return Ti(w,w,[E,E,E]),Gi(w,w,((I=[])[0]=-(A=x.min)[0],I[1]=-A[1],I[2]=-A[2],I)),w}(Ku(e));f.reserve(4096);for(let x=0;x<65;x++){const w=s(h[0],u[0],x/64),E=hl(w),I=E*r-e.y,A=Math.sin(gt(w)),z=Math.cos(gt(w));for(let R=0;R<65;R++){const O=R/64,U=s(h[1],u[1],O),Z=uf(z,A,U);Tt(Z,Z,g);const Q=cl(U);f.emplaceBack(Z[0],Z[1],Z[2],Q,E,O,I)}}return f}_createGridIndices(){const e=new Gr,r=(s,h)=>{const u=65*h+s;e.emplaceBack(u+1,u,u+65),e.emplaceBack(u+65,u+65+1,u+1)};for(let s=0;s<64;s++)for(let h=0;h<64;h++)r(h,s);return e}getWirefameBuffer(e){if(!this.wireframeSegments){const r=this._createWireframeGrid();this.wireframeIndexBuffer=e.createIndexBuffer(r),this.wireframeSegments=_i.simpleSegment(0,0,4096,r.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}_createWireframeGrid(){const e=new Ws,r=(s,h)=>{const u=65*h+s;e.emplaceBack(u,u+1),e.emplaceBack(u,u+65),e.emplaceBack(u,u+65+1)};for(let s=0;s<64;s++)for(let h=0;h<64;h++)r(h,s);return e}}function wl(t,e){if(!e.isReprojectedInTileSpace)return{scale:1<<t.z,x:t.x,y:t.y,x2:t.x+1,y2:t.y+1,projection:e};const r=Math.pow(2,-t.z),s=t.x*r,h=(t.x+1)*r,u=t.y*r,f=(t.y+1)*r,g=hs(s),x=hs(h),w=on(u),E=on(f),I=e.project(g,w),A=e.project(x,w),z=e.project(x,E),R=e.project(g,E);let O=Math.min(I.x,A.x,z.x,R.x),U=Math.min(I.y,A.y,z.y,R.y),Z=Math.max(I.x,A.x,z.x,R.x),Q=Math.max(I.y,A.y,z.y,R.y);const ne=r/16;function oe(le,we,ve,Fe,Pe,be){const Le=(ve+Pe)/2,Oe=(Fe+be)/2,Ie=e.project(hs(Le),on(Oe)),Ve=Math.max(0,O-Ie.x,U-Ie.y,Ie.x-Z,Ie.y-Q);O=Math.min(O,Ie.x),Z=Math.max(Z,Ie.x),U=Math.min(U,Ie.y),Q=Math.max(Q,Ie.y),Ve>ne&&(oe(le,Ie,ve,Fe,Le,Oe),oe(Ie,we,Le,Oe,Pe,be))}oe(I,A,s,u,h,u),oe(A,z,h,u,h,f),oe(z,R,h,f,s,f),oe(R,I,s,f,s,u),O-=ne,U-=ne,Z+=ne,Q+=ne;const ae=1/Math.max(Z-O,Q-U);return{scale:ae,x:O*ae,y:U*ae,x2:Z*ae,y2:Q*ae,projection:e}}class Qg{constructor(e){const r={},s=[];for(const g in e){const x=e[g],w=r[g]={};for(const E in x.glyphs){const I=x.glyphs[+E];if(!I||I.bitmap.width===0||I.bitmap.height===0)continue;const A=I.metrics.localGlyph?2:1,z={x:0,y:0,w:I.bitmap.width+2*A,h:I.bitmap.height+2*A};s.push(z),w[E]=z}}const{w:h,h:u}=Vp(s),f=new Hs({width:h||1,height:u||1});for(const g in e){const x=e[g];for(const w in x.glyphs){const E=x.glyphs[+w];if(!E||E.bitmap.width===0||E.bitmap.height===0)continue;const I=r[g][w],A=E.metrics.localGlyph?2:1;Hs.copy(E.bitmap,f,{x:0,y:0},{x:I.x+A,y:I.y+A},E.bitmap)}}this.image=f,this.positions=r}}je("GlyphAtlas",Qg);class kb{constructor(e){this.tileID=new mr(e.tileID.overscaledZ,e.tileID.wrap,e.tileID.canonical.z,e.tileID.canonical.x,e.tileID.canonical.y),this.tileZoom=e.tileZoom,this.uid=e.uid,this.zoom=e.zoom,this.canonical=e.tileID.canonical,this.pixelRatio=e.pixelRatio,this.tileSize=e.tileSize,this.source=e.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=e.showCollisionBoxes,this.collectResourceTiming=!!e.collectResourceTiming,this.returnDependencies=!!e.returnDependencies,this.promoteId=e.promoteId,this.enableTerrain=!!e.enableTerrain,this.isSymbolTile=e.isSymbolTile,this.tileTransform=wl(e.tileID.canonical,e.projection),this.projection=e.projection}parse(e,r,s,h,u){this.status="parsing",this.data=e,this.collisionBoxArray=new vp;const f=new zg(Object.keys(e.layers).sort()),g=new Gg(this.tileID,this.promoteId);g.bucketLayerIDs=[];const x={},w=new tf(256,256),E={featureIndex:g,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:w,availableImages:s},I=r.familiesBySource[this.source];for(const ae in I){const le=e.layers[ae];if(!le)continue;let we=!1,ve=!1;for(const be of I[ae])be[0].type==="symbol"?we=!0:ve=!0;if(this.isSymbolTile===!0&&!we||this.isSymbolTile===!1&&!ve)continue;le.version===1&&ii(`Vector tile source "${this.source}" layer "${ae}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Fe=f.encode(ae),Pe=[];for(let be=0;be<le.length;be++){const Le=le.feature(be),Oe=g.getId(Le,ae);Pe.push({feature:Le,id:Oe,index:be,sourceLayerIndex:Fe})}for(const be of I[ae]){const Le=be[0];this.isSymbolTile!==void 0&&Le.type==="symbol"!==this.isSymbolTile||Le.minzoom&&this.zoom<Math.floor(Le.minzoom)||Le.maxzoom&&this.zoom>=Le.maxzoom||Le.visibility!=="none"&&(pf(be,this.zoom,s),(x[Le.id]=Le.createBucket({index:g.bucketLayerIDs.length,layers:be,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Fe,sourceID:this.source,enableTerrain:this.enableTerrain,availableImages:s})).populate(Pe,E,this.tileID.canonical,this.tileTransform),g.bucketLayerIDs.push(be.map(Oe=>Oe.id)))}}let A,z,R,O;w.trim();const U={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Z=An(E.glyphDependencies,ae=>Object.keys(ae).map(Number));Object.keys(Z).length?h.send("getGlyphs",{uid:this.uid,stacks:Z},(ae,le)=>{A||(A=ae,z=le,oe.call(this))},void 0,!1,U):z={};const Q=Object.keys(E.iconDependencies);Q.length?h.send("getImages",{icons:Q,source:this.source,tileID:this.tileID,type:"icons"},(ae,le)=>{A||(A=ae,R=le,oe.call(this))},void 0,!1,U):R={};const ne=Object.keys(E.patternDependencies);function oe(){if(A)return u(A);if(z&&R&&O){const ae=new Qg(z),le=new sg(R,O);for(const we in x){const ve=x[we];ve instanceof Js?(pf(ve.layers,this.zoom,s),lb(ve,z,ae.positions,R,le.iconPositions,this.showCollisionBoxes,s,this.tileID.canonical,this.tileZoom,this.projection),ve.projection=this.projection.name):ve.hasPattern&&(ve instanceof Lu||ve instanceof Pu||ve instanceof Op)&&(pf(ve.layers,this.zoom,s),ve.addFeatures(E,this.tileID.canonical,le.patternPositions,s))}this.status="done",u(null,{buckets:Ts(x).filter(we=>!we.isEmpty()),featureIndex:g,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:ae.image,lineAtlas:w,imageAtlas:le,glyphMap:this.returnDependencies?z:null,iconMap:this.returnDependencies?R:null,glyphPositions:this.returnDependencies?ae.positions:null})}}ne.length?h.send("getImages",{icons:ne,source:this.source,tileID:this.tileID,type:"patterns"},(ae,le)=>{A||(A=ae,O=le,oe.call(this))},void 0,!1,U):O={},oe.call(this)}}function pf(t,e,r){const s=new ot(e);for(const h of t)h.recalculate(s,r)}class ey{constructor(e){this.entries={},this.scheduler=e}request(e,r,s,h){const u=this.entries[e]=this.entries[e]||{callbacks:[]};if(u.result){const[f,g]=u.result;return this.scheduler?this.scheduler.add(()=>{h(f,g)},r):h(f,g),()=>{}}return u.callbacks.push(h),u.cancel||(u.cancel=s((f,g)=>{u.result=[f,g];for(const x of u.callbacks)this.scheduler?this.scheduler.add(()=>{x(f,g)},r):x(f,g);setTimeout(()=>delete this.entries[e],3e3)})),()=>{u.result||(u.callbacks=u.callbacks.filter(f=>f!==h),u.callbacks.length||(u.cancel(),delete this.entries[e]))}}}function ty(t,e,r){const s=JSON.stringify(t.request);return t.data&&(this.deduped.entries[s]={result:[null,t.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:t.isSymbolTile,zoom:t.tileZoom},h=>{const u=bo(t.request,(f,g,x,w)=>{f?h(f):g&&h(null,{vectorTile:r?void 0:new Yo.VectorTile(new Bc(g)),rawData:g,cacheControl:x,expires:w})});return()=>{u.cancel(),h()}},e)}const Db=ti(new Float64Array(16));class ea{constructor(e,r){this._tr=e,this._worldSize=r}createInversionMatrix(){return Db}createTileMatrix(e){let r,s,h;const u=e.canonical,f=ti(new Float64Array(16)),g=this._tr.projection;if(g.isReprojectedInTileSpace){const x=wl(u,g);r=1,s=x.x+e.wrap*x.scale,h=x.y,Ti(f,f,[r/x.scale,r/x.scale,this._tr.pixelsPerMeter/this._worldSize])}else r=this._worldSize/this._tr.zoomScale(u.z),s=(u.x+Math.pow(2,u.z)*e.wrap)*r,h=u.y*r;return Gi(f,f,[s,h,0]),Ti(f,f,[r/yt,r/yt,1]),f}pointCoordinate(e,r,s){const h=this._tr.horizonLineFromTop(!1),u=new ue(e,Math.max(h,r));return this._tr.rayIntersectionCoordinate(this._tr.pointRayIntersection(u,s))}upVector(){return[0,0,1]}upVectorScale(){return 1}}var zb={name:"albers",range:[4,7],center:[-96,37.5],parallels:[29.5,45.5],zAxisUnit:"meters",conic:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],initializeConstants(){if(this.constants&&uo(this.parallels,this.constants.parallels))return;const t=Math.sin(gt(this.parallels[0])),e=(t+Math.sin(gt(this.parallels[1])))/2,r=1+t*(2*e-t),s=Math.sqrt(r)/e;this.constants={n:e,c:r,r0:s,parallels:this.parallels}},project(t,e){this.initializeConstants();const r=gt(t-this.center[0]),s=gt(e),{n:h,c:u,r0:f}=this.constants,g=Math.sqrt(u-2*h*Math.sin(s))/h;return{x:g*Math.sin(r*h),y:g*Math.cos(r*h)-f,z:0}},unproject(t,e){this.initializeConstants();const{n:r,c:s,r0:h}=this.constants,u=h+e;let f=Math.atan2(t,Math.abs(u))*Math.sign(u);u*r<0&&(f-=Math.PI*Math.sign(t)*Math.sign(u));const g=gt(this.center[0])*r;f=un(f,-Math.PI-g,Math.PI-g);const x=hr(f/r)+this.center[0],w=Math.asin(Ft((s-(t*t+u*u)*r*r)/(2*r),-1,1)),E=Ft(hr(w),-85.051129,jn);return new Ot(x,E)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>vn(1,t)*e,farthestPixelDistance(t){return Qo(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new ea(t,e)};const Uc=1.340264,Vc=-.081106,jc=893e-6,$c=.003796,Ju=Math.sqrt(3)/2;var Pb={name:"equalEarth",center:[0,0],range:[3.5,7],zAxisUnit:"meters",isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project(t,e){e=e/180*Math.PI,t=t/180*Math.PI;const r=Math.asin(Ju*Math.sin(e)),s=r*r,h=s*s*s;return{x:.5*(t*Math.cos(r)/(Ju*(Uc+3*Vc*s+h*(7*jc+9*$c*s)))/Math.PI+.5),y:1-.5*(r*(Uc+Vc*s+h*(jc+$c*s))/Math.PI+1),z:0}},unproject(t,e){t=(2*t-.5)*Math.PI;let r=e=(2*(1-e)-1)*Math.PI,s=r*r,h=s*s*s;for(let w,E,I,A=0;A<12&&(E=r*(Uc+Vc*s+h*(jc+$c*s))-e,I=Uc+3*Vc*s+h*(7*jc+9*$c*s),w=E/I,r=Ft(r-w,-Math.PI/3,Math.PI/3),s=r*r,h=s*s*s,!(Math.abs(w)<1e-12));++A);const u=Ju*t*(Uc+3*Vc*s+h*(7*jc+9*$c*s))/Math.cos(r),f=Math.asin(Math.sin(r)/Ju),g=Ft(180*u/Math.PI,-180,180),x=Ft(180*f/Math.PI,-85.051129,jn);return new Ot(g,x)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>vn(1,t)*e,farthestPixelDistance(t){return Qo(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new ea(t,e)},Lb={name:"equirectangular",supportsWorldCopies:!0,center:[0,0],range:[3.5,7],zAxisUnit:"meters",wrap:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project:(t,e)=>({x:.5+t/360,y:.5-e/360,z:0}),unproject(t,e){const r=360*(t-.5),s=Ft(360*(.5-e),-85.051129,jn);return new Ot(r,s)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>vn(1,t)*e,farthestPixelDistance(t){return Qo(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new ea(t,e)};const Tl=Math.PI/2;function Qu(t){return Math.tan((Tl+t)/2)}var Rb={name:"lambertConformalConic",range:[3.5,7],zAxisUnit:"meters",center:[0,30],parallels:[30,30],conic:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],initializeConstants(){if(this.constants&&uo(this.parallels,this.constants.parallels))return;const t=gt(this.parallels[0]),e=gt(this.parallels[1]),r=Math.cos(t),s=t===e?Math.sin(t):Math.log(r/Math.cos(e))/Math.log(Qu(e)/Qu(t)),h=r*Math.pow(Qu(t),s)/s;this.constants={n:s,f:h,parallels:this.parallels}},project(t,e){this.initializeConstants(),e=gt(e),t=gt(t-this.center[0]);const r=1e-6,{n:s,f:h}=this.constants;h>0?e<-Tl+r&&(e=-Tl+r):e>Tl-r&&(e=Tl-r);const u=h/Math.pow(Qu(e),s),f=u*Math.sin(s*t),g=h-u*Math.cos(s*t);return{x:.5*(f/Math.PI+.5),y:1-.5*(g/Math.PI+.5),z:0}},unproject(t,e){this.initializeConstants(),t=(2*t-.5)*Math.PI,e=(2*(1-e)-.5)*Math.PI;const{n:r,f:s}=this.constants,h=s-e,u=Math.sign(h),f=Math.sign(r)*Math.sqrt(t*t+h*h);let g=Math.atan2(t,Math.abs(h))*u;h*r<0&&(g-=Math.PI*Math.sign(t)*u);const x=Ft(hr(g/r)+this.center[0],-180,180),w=Ft(hr(2*Math.atan(Math.pow(s/f,1/r))-Tl),-85.051129,jn);return new Ot(x,w)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>vn(1,t)*e,farthestPixelDistance(t){return Qo(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new ea(t,e)},Bb={name:"mercator",wrap:!0,requiresDraping:!1,supportsWorldCopies:!0,supportsTerrain:!0,supportsFog:!0,supportsFreeCamera:!0,zAxisUnit:"meters",center:[0,0],project:(t,e)=>({x:cl(t),y:hl(e),z:0}),unproject(t,e){const r=hs(t),s=on(e);return new Ot(r,s)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>vn(1,t)*e,farthestPixelDistance(t){return Qo(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new ea(t,e)};const iy=gt(jn);var Fb={name:"naturalEarth",center:[0,0],range:[3.5,7],isReprojectedInTileSpace:!0,zAxisUnit:"meters",unsupportedLayers:["custom"],project(t,e){const r=(e=gt(e))*e,s=r*r;return{x:.5*((t=gt(t))*(.8707-.131979*r+s*(s*(.003971*r-.001529*s)-.013791))/Math.PI+.5),y:1-.5*(e*(1.007226+r*(.015085+s*(.028874*r-.044475-.005916*s)))/Math.PI+1),z:0}},unproject(t,e){t=(2*t-.5)*Math.PI;let r=e=(2*(1-e)-1)*Math.PI,s=25,h=0,u=r*r;do{u=r*r;const x=u*u;h=(r*(1.007226+u*(.015085+x*(.028874*u-.044475-.005916*x)))-e)/(1.007226+u*(.045255+x*(.259866*u-.311325-.005916*11*x))),r=Ft(r-h,-iy,iy)}while(Math.abs(h)>1e-6&&--s>0);u=r*r;const f=Ft(hr(t/(.8707+u*(u*(u*u*u*(.003971-.001529*u)-.013791)-.131979))),-180,180),g=hr(r);return new Ot(f,g)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>vn(1,t)*e,farthestPixelDistance(t){return Qo(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new ea(t,e)};const ry=gt(jn),ny={albers:zb,equalEarth:Pb,equirectangular:Lb,lambertConformalConic:Rb,mercator:Bb,naturalEarth:Fb,winkelTripel:{name:"winkelTripel",center:[0,0],range:[3.5,7],zAxisUnit:"meters",isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project(t,e){e=gt(e),t=gt(t);const r=Math.cos(e),s=2/Math.PI,h=Math.acos(r*Math.cos(t/2)),u=Math.sin(h)/h,f=.5*(t*s+2*r*Math.sin(t/2)/u)||0,g=.5*(e+Math.sin(e)/u)||0;return{x:.5*(f/Math.PI+.5),y:1-.5*(g/Math.PI+1),z:0}},unproject(t,e){let r=t=(2*t-.5)*Math.PI,s=e=(2*(1-e)-1)*Math.PI,h=25;const u=1e-6;let f=0,g=0;do{const x=Math.cos(s),w=Math.sin(s),E=2*w*x,I=w*w,A=x*x,z=Math.cos(r/2),R=Math.sin(r/2),O=2*z*R,U=R*R,Z=1-A*z*z,Q=Z?1/Z:0,ne=Z?Math.acos(x*z)*Math.sqrt(1/Z):0,oe=.5*(2*ne*x*R+2*r/Math.PI)-t,ae=.5*(ne*w+s)-e,le=.5*Q*(A*U+ne*x*z*I)+1/Math.PI,we=Q*(O*E/4-ne*w*R),ve=.125*Q*(E*R-ne*w*A*O),Fe=.5*Q*(I*z+ne*U*x)+.5,Pe=we*ve-Fe*le;f=(ae*we-oe*Fe)/Pe,g=(oe*ve-ae*le)/Pe,r=Ft(r-f,-Math.PI,Math.PI),s=Ft(s-g,-ry,ry)}while((Math.abs(f)>u||Math.abs(g)>u)&&--h>0);return new Ot(hr(r),hr(s))},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>vn(1,t)*e,farthestPixelDistance(t){return Qo(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new ea(t,e)}};a.ARRAY_TYPE=dt,a.AUTH_ERR_MSG=pe,a.Aabb=bn,a.Actor=class{constructor(t,e,r){this.target=t,this.parent=e,this.mapId=r,this.callbacks={},this.cancelCallbacks={},Es(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=Jr()?t:fe,this.scheduler=new wb}send(t,e,r,s,h=!1,u){const f=Math.round(1e18*Math.random()).toString(36).substring(0,10);r&&(r.metadata=u,this.callbacks[f]=r);const g=Or(this.globalScope)?void 0:[];return this.target.postMessage({id:f,type:t,hasCallback:!!r,targetMapId:s,mustQueue:h,sourceMapId:this.mapId,data:Zo(e,g)},g),{cancel:()=>{r&&delete this.callbacks[f],this.target.postMessage({id:f,type:"<cancel>",targetMapId:s,sourceMapId:this.mapId})}}}receive(t){const e=t.data,r=e.id;if(r&&(!e.targetMapId||this.mapId===e.targetMapId))if(e.type==="<cancel>"){const s=this.cancelCallbacks[r];delete this.cancelCallbacks[r],s&&s.cancel()}else if(e.mustQueue||Jr()){const s=this.callbacks[r];this.cancelCallbacks[r]=this.scheduler.add(()=>this.processTask(r,e),s&&s.metadata||{type:"message"})}else this.processTask(r,e)}processTask(t,e){if(e.type==="<response>"){const r=this.callbacks[t];delete this.callbacks[t],r&&(e.error?r(Un(e.error)):r(null,Un(e.data)))}else{const r=Or(this.globalScope)?void 0:[],s=e.hasCallback?(u,f)=>{delete this.cancelCallbacks[t],this.target.postMessage({id:t,type:"<response>",sourceMapId:this.mapId,error:u?Zo(u):null,data:Zo(f,r)},r)}:u=>{},h=Un(e.data);if(this.parent[e.type])this.parent[e.type](e.sourceMapId,h,s);else if(this.parent.getWorkerSource){const u=e.type.split(".");this.parent.getWorkerSource(e.sourceMapId,u[0],h.source)[u[1]](h,s)}else s(new Error(`Could not find function ${e.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}},a.CanonicalTileID=Zu,a.Color=At,a.ColorMode=Gn,a.CullFaceMode=wn,a.DEMData=Wu,a.DataConstantProperty=Ge,a.DedupedRequest=ey,a.DepthMode=bl,a.EXTENT=yt,a.Elevation=class{getAtPointOrZero(t,e=0){return this.getAtPoint(t,e)||0}getAtPoint(t,e,r=!0){e==null&&(e=null);const s=this._source();if(!s||t.y<0||t.y>1)return e;const h=s.getSource().maxzoom,u=1<<h,f=Math.floor(t.x),g=t.x-f,x=new mr(h,f,h,Math.floor(g*u),Math.floor(t.y*u)),w=this.findDEMTileFor(x);if(!w||!w.dem)return e;const E=w.dem,I=1<<w.tileID.canonical.z,A=(g*I-w.tileID.canonical.x)*E.dim,z=(t.y*I-w.tileID.canonical.y)*E.dim,R=Math.floor(A),O=Math.floor(z);return(r?this.exaggeration():1)*Lt(Lt(E.get(R,O),E.get(R,O+1),z-O),Lt(E.get(R+1,O),E.get(R+1,O+1),z-O),A-R)}getAtTileOffset(t,e,r){const s=1<<t.canonical.z;return this.getAtPointOrZero(new Su(t.wrap+(t.canonical.x+e/yt)/s,(t.canonical.y+r/yt)/s))}getAtTileOffsetFunc(t,e){return r=>{const s=this.getAtTileOffset(t,r.x,r.y),h=e.upVector(t.canonical,r.x,r.y);return Hr(h,h,s*e.upVectorScale(t.canonical)),h}}getForTilePoints(t,e,r,s){const h=Xu.create(this,t,s);return!!h&&(e.forEach(u=>{u[2]=this.exaggeration()*h.getElevationAt(u[0],u[1],r)}),!0)}getMinMaxForTile(t){const e=this.findDEMTileFor(t);if(!e||!e.dem)return null;const r=e.dem.tree,s=e.tileID,h=1<<t.canonical.z-s.canonical.z;let u=t.canonical.x/h-s.canonical.x,f=t.canonical.y/h-s.canonical.y,g=0;for(let x=0;x<t.canonical.z-s.canonical.z&&!r.leaves[g];x++){u*=2,f*=2;const w=2*Math.floor(f)+Math.floor(u);g=r.childOffsets[g]+w,u%=1,f%=1}return{min:this.exaggeration()*r.minimums[g],max:this.exaggeration()*r.maximums[g]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(t,e,r){throw new Error("Pure virtual method called.")}pointCoordinate(t){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(t){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}},a.ErrorEvent=Aa,a.EvaluationParameters=ot,a.Event=kn,a.Evented=Dn,a.Frustum=Cp,a.GLOBE_ZOOM_THRESHOLD_MAX=6,a.GlobeSharedBuffers=df,a.GlyphManager=xl,a.ImagePosition=jp,a.LineAtlas=tf,a.LngLat=Ot,a.LngLatBounds=Ho,a.LocalGlyphMode=Zp,a.MAX_MERCATOR_LATITUDE=jn,a.MercatorCoordinate=Su,a.ONE_EM=Ni,a.OverscaledTileID=mr,a.Properties=Fi,a.RGBAImage=qr,a.Ray=class{constructor(t,e){this.pos=t,this.dir=e}intersectsPlane(t,e,r){const s=Kr(e,this.dir);if(Math.abs(s)<1e-6)return!1;const h=((t[0]-this.pos[0])*e[0]+(t[1]-this.pos[1])*e[1]+(t[2]-this.pos[2])*e[2])/s;return r[0]=this.pos[0]+this.dir[0]*h,r[1]=this.pos[1]+this.dir[1]*h,r[2]=this.pos[2]+this.dir[2]*h,!0}closestPointOnSphere(t,e,r){if(function(A,z){var R=A[0],O=A[1],U=A[2],Z=z[0],Q=z[1],ne=z[2];return Math.abs(R-Z)<=it*Math.max(1,Math.abs(R),Math.abs(Z))&&Math.abs(O-Q)<=it*Math.max(1,Math.abs(O),Math.abs(Q))&&Math.abs(U-ne)<=it*Math.max(1,Math.abs(U),Math.abs(ne))}(this.pos,t)||e===0)return r[0]=r[1]=r[2]=0,!1;const[s,h,u]=this.dir,f=this.pos[0]-t[0],g=this.pos[1]-t[1],x=this.pos[2]-t[2],w=s*s+h*h+u*u,E=2*(f*s+g*h+x*u),I=E*E-4*w*(f*f+g*g+x*x-e*e);if(I<0){const A=Math.max(-E/2,0),z=f+s*A,R=g+h*A,O=x+u*A,U=Math.hypot(z,R,O);return r[0]=z*e/U,r[1]=R*e/U,r[2]=O*e/U,!1}{const A=(-E-Math.sqrt(I))/(2*w);if(A<0){const z=Math.hypot(f,g,x);return r[0]=f*e/z,r[1]=g*e/z,r[2]=x*e/z,!1}return r[0]=f+s*A,r[1]=g+h*A,r[2]=x+u*A,!0}}},a.RequestManager=class{constructor(t,e,r){this._transformRequestFn=t,this._customAccessToken=e,this._silenceAuthErrors=!!r,this._createSkuToken()}_createSkuToken(){const t=function(){let e="";for(let r=0;r<10;r++)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",se,e].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,e){return this._transformRequestFn&&this._transformRequestFn(t,e)||{url:t}}normalizeStyleURL(t,e){if(!Te(t))return t;const r=We(t);return r.path=`/styles/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||e)}normalizeGlyphsURL(t,e){if(!Te(t))return t;const r=We(t);return r.path=`/fonts/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||e)}normalizeSourceURL(t,e){if(!Te(t))return t;const r=We(t);return r.path=`/v4/${r.authority}.json`,r.params.push("secure"),this._makeAPIURL(r,this._customAccessToken||e)}normalizeSpriteURL(t,e,r,s){const h=We(t);return Te(t)?(h.path=`/styles/v1${h.path}/sprite${e}${r}`,this._makeAPIURL(h,this._customAccessToken||s)):(h.path+=`${e}${r}`,Je(h))}normalizeTileURL(t,e,r){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!Te(t))return t;const s=We(t);s.path=s.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${e||r&&s.authority!=="raster"&&r===512?"@2x":""}${B.supported?".webp":"$1"}`),s.authority==="raster"?s.path=`/${D.RASTER_URL_PREFIX}${s.path}`:(s.path=s.path.replace(/^.+\/v4\//,"/"),s.path=`/${D.TILE_URL_VERSION}${s.path}`);const h=this._customAccessToken||function(u){for(const f of u){const g=f.match(/^access_token=(.*)$/);if(g)return g[1]}return null}(s.params)||D.ACCESS_TOKEN;return D.REQUIRE_ACCESS_TOKEN&&h&&this._skuToken&&s.params.push(`sku=${this._skuToken}`),this._makeAPIURL(s,h)}canonicalizeTileURL(t,e){const r=We(t);if(!r.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!r.path.match(/\.[\w]+$/))return t;let s="mapbox://";r.path.match(/^\/raster\/v1\//)?s+=`raster/${r.path.replace(`/${D.RASTER_URL_PREFIX}/`,"")}`:s+=`tiles/${r.path.replace(`/${D.TILE_URL_VERSION}/`,"")}`;let h=r.params;return e&&(h=h.filter(u=>!u.match(/^access_token=/))),h.length&&(s+=`?${h.join("&")}`),s}canonicalizeTileset(t,e){const r=!!e&&Te(e),s=[];for(const h of t.tiles||[])Se(h)?s.push(this.canonicalizeTileURL(h,r)):s.push(h);return s}_makeAPIURL(t,e){const r="See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes",s=We(D.API_URL);if(t.protocol=s.protocol,t.authority=s.authority,t.protocol==="http"){const h=t.params.indexOf("secure");h>=0&&t.params.splice(h,1)}if(s.path!=="/"&&(t.path=`${s.path}${t.path}`),!D.REQUIRE_ACCESS_TOKEN)return Je(t);if(e=e||D.ACCESS_TOKEN,!this._silenceAuthErrors){if(!e)throw new Error(`An API access token is required to use Mapbox GL. ${r}`);if(e[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${r}`)}return t.params=t.params.filter(h=>h.indexOf("access_token")===-1),t.params.push(`access_token=${e||""}`),Je(t)}},a.ResourceType=Sa,a.SegmentVector=_i,a.SourceCache=Jo,a.StencilMode=sf,a.StructArrayLayout1ui2=xu,a.StructArrayLayout2f1f2i16=pp,a.StructArrayLayout2i4=sl,a.StructArrayLayout2ui4=Ws,a.StructArrayLayout3f12=al,a.StructArrayLayout3ui6=Gr,a.StructArrayLayout4i8=ol,a.Texture=qu,a.Tile=cf,a.Transitionable=pr,a.Uniform1f=Tu,a.Uniform1i=class extends as{constructor(t,e){super(t,e),this.current=0}set(t){this.current!==t&&(this.current=t,this.gl.uniform1i(this.location,t))}},a.Uniform2f=class extends as{constructor(t,e){super(t,e),this.current=[0,0]}set(t){t[0]===this.current[0]&&t[1]===this.current[1]||(this.current=t,this.gl.uniform2f(this.location,t[0],t[1]))}},a.Uniform3f=class extends as{constructor(t,e){super(t,e),this.current=[0,0,0]}set(t){t[0]===this.current[0]&&t[1]===this.current[1]&&t[2]===this.current[2]||(this.current=t,this.gl.uniform3f(this.location,t[0],t[1],t[2]))}},a.Uniform4f=x_,a.UniformColor=v_,a.UniformMatrix2f=class extends as{constructor(t,e){super(t,e),this.current=C0}set(t){for(let e=0;e<4;e++)if(t[e]!==this.current[e]){this.current=t,this.gl.uniformMatrix2fv(this.location,!1,t);break}}},a.UniformMatrix3f=class extends as{constructor(t,e){super(t,e),this.current=A0}set(t){for(let e=0;e<9;e++)if(t[e]!==this.current[e]){this.current=t,this.gl.uniformMatrix3fv(this.location,!1,t);break}}},a.UniformMatrix4f=class extends as{constructor(t,e){super(t,e),this.current=I0}set(t){if(t[12]!==this.current[12]||t[0]!==this.current[0])return this.current=t,void this.gl.uniformMatrix4fv(this.location,!1,t);for(let e=1;e<16;e++)if(t[e]!==this.current[e]){this.current=t,this.gl.uniformMatrix4fv(this.location,!1,t);break}}},a.UnwrappedTileID=rf,a.ValidationError=Ue,a.VectorTileWorkerSource=class extends Dn{constructor(t,e,r,s,h){super(),this.actor=t,this.layerIndex=e,this.availableImages=r,this.loadVectorData=h||ty,this.loading={},this.loaded={},this.deduped=new ey(t.scheduler),this.isSpriteLoaded=s,this.scheduler=t.scheduler}loadTile(t,e){const r=t.uid,s=t&&t.request,h=s&&s.collectResourceTiming,u=this.loading[r]=new kb(t);u.abort=this.loadVectorData(t,(f,g)=>{const x=!this.loading[r];if(delete this.loading[r],x||f||!g)return u.status="done",x||(this.loaded[r]=u),e(f);const w=g.rawData,E={};g.expires&&(E.expires=g.expires),g.cacheControl&&(E.cacheControl=g.cacheControl),u.vectorTile=g.vectorTile||new Yo.VectorTile(new Bc(w));const I=()=>{u.parse(u.vectorTile,this.layerIndex,this.availableImages,this.actor,(A,z)=>{if(A||!z)return e(A);const R={};if(h){const O=kg(s);O.length>0&&(R.resourceTiming=JSON.parse(JSON.stringify(O)))}e(null,si({rawTileData:w.slice(0)},z,E,R))})};this.isSpriteLoaded?I():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(I,{type:"parseTile",isSymbolTile:t.isSymbolTile,zoom:t.tileZoom}):I()}),this.loaded=this.loaded||{},this.loaded[r]=u})}reloadTile(t,e){const r=this.loaded,s=t.uid,h=this;if(r&&r[s]){const u=r[s];u.showCollisionBoxes=t.showCollisionBoxes,u.enableTerrain=!!t.enableTerrain,u.projection=t.projection;const f=(g,x)=>{const w=u.reloadCallback;w&&(delete u.reloadCallback,u.parse(u.vectorTile,h.layerIndex,this.availableImages,h.actor,w)),e(g,x)};u.status==="parsing"?u.reloadCallback=f:u.status==="done"&&(u.vectorTile?u.parse(u.vectorTile,this.layerIndex,this.availableImages,this.actor,f):f())}}abortTile(t,e){const r=t.uid,s=this.loading[r];s&&(s.abort&&s.abort(),delete this.loading[r]),e()}removeTile(t,e){const r=this.loaded,s=t.uid;r&&r[s]&&delete r[s],e()}},a.WritingMode=Zr,a.ZoomHistory=d,a.add=co,a.addDynamicAttributes=Kp,a.adjoint=function(t,e){var r=e[0],s=e[1],h=e[2],u=e[3],f=e[4],g=e[5],x=e[6],w=e[7],E=e[8];return t[0]=f*E-g*w,t[1]=h*w-s*E,t[2]=s*g-h*f,t[3]=g*x-u*E,t[4]=r*E-h*x,t[5]=h*u-r*g,t[6]=u*w-f*x,t[7]=s*x-r*w,t[8]=r*f-s*u,t},a.asyncAll=es,a.bezier=fo,a.bindAll=Es,a.boundsAttributes=lf,a.bufferConvexPolygon=function(t,e){const r=[];for(let s=0;s<t.length;s++){const h=un(s-1,-1,t.length-1),u=un(s+1,-1,t.length-1),f=t[s],g=t[u],x=t[h].sub(f).unit(),w=g.sub(f).unit(),E=w.angleWithSep(x.x,x.y),I=x.add(w).unit().mult(-1*e/Math.sin(E/2));r.push(f.add(I))}return r},a.cacheEntryPossiblyAdded=function(t){Ea++,Ea>Xl&&(t.getActor().send("enforceCacheSizeLimit",Dh),Ea=0)},a.calculateGlobeMatrix=Jg,a.calculateGlobeMercatorMatrix=function(t){const e=t.worldSize,r=Ft(t.center.lat,-85.051129,jn),s=new ue(cl(t.center.lng)*e,hl(r)*e),h=vn(1,t.center.lat)*e,u=t.pixelsPerMeter,f=e/(h/t.pixelsPerMeter),g=ti(new Float64Array(16));return Gi(g,g,[s.x,s.y,0]),Ti(g,g,[f,f,u]),g},a.clamp=Ft,a.clearTileCache=function(t){const e=fe.caches.delete(Ri);t&&e.catch(t).then(()=>t())},a.clipLine=gg,a.clone=function(t){var e=new dt(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},a.clone$1=Er,a.collisionCircleLayout=L1,a.config=D,a.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},a.create=function(){var t=new dt(16);return dt!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},a.create$1=pi,a.createExpression=No,a.createLayout=ni,a.createStyleLayer=function(t){return t.type==="custom"?new gb(t):new xb[t.type](t)},a.cross=vs,a.degToRad=gt,a.div=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t},a.dot=Kr,a.ease=mo,a.easeCubicInOut=po,a.emitValidationErrors=fu,a.endsWith=Ss,a.enforceCacheSizeLimit=function(t){xo(),Qr&&Qr.then(e=>{e.keys().then(r=>{for(let s=0;s<r.length-t;s++)e.delete(r[s])})})},a.evaluateSizeForFeature=Ru,a.evaluateSizeForZoom=ml,a.evaluateVariableOffset=wg,a.evented=nr,a.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},a.exactEquals$1=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},a.exported=ur,a.exported$1=B,a.extend=si,a.extend$1=zn,a.filterObject=Is,a.fromMat4=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},a.fromQuat=function(t,e){var r=e[0],s=e[1],h=e[2],u=e[3],f=r+r,g=s+s,x=h+h,w=r*f,E=s*f,I=s*g,A=h*f,z=h*g,R=h*x,O=u*f,U=u*g,Z=u*x;return t[0]=1-I-R,t[1]=E+Z,t[2]=A-U,t[3]=0,t[4]=E-Z,t[5]=1-w-R,t[6]=z+O,t[7]=0,t[8]=A+U,t[9]=z-O,t[10]=1-w-I,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},a.fromRotation=function(t,e){var r=Math.sin(e),s=Math.cos(e);return t[0]=s,t[1]=r,t[2]=0,t[3]=-r,t[4]=s,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},a.furthestTileCorner=function(t){const e=Math.round((t+45+360)%360/90)%4;return Qn[e]},a.getAABBPointSquareDist=function(t,e,r){let s=0;for(let h=0;h<2;++h){const u=r?r[h]:0;t[h]>u&&(s+=(t[h]-u)*(t[h]-u)),e[h]<u&&(s+=(u-e[h])*(u-e[h]))}return s},a.getAnchorAlignment=qp,a.getAnchorJustification=Xp,a.getBounds=function(t){let e=1/0,r=1/0,s=-1/0,h=-1/0;for(const u of t)e=Math.min(e,u.x),r=Math.min(r,u.y),s=Math.max(s,u.x),h=Math.max(h,u.y);return{min:new ue(e,r),max:new ue(s,h)}},a.getColumn=function(t,e){return[t[4*e],t[4*e+1],t[4*e+2],t[4*e+3]]},a.getImage=Ph,a.getJSON=function(t,e){return Nr(si(t,{type:"json"}),e)},a.getMapSessionAPI=Mn,a.getPerformanceMeasurement=kg,a.getProjection=function(t){const e=ny[t.name];if(!e)throw new Error(`Invalid projection name: ${t.name}`);return e.conic?function(r,s){if(s.parallels&&Math.abs(s.parallels[0]+s.parallels[1])<.01){let h=function(u){const f=Math.max(.01,Math.cos(gt(u))),g=1/(2*Math.max(Math.PI*f,1/f));return{wrap:!0,supportsWorldCopies:!0,unsupportedLayers:["custom"],project(x,w){const E=gt(x)*f,I=Math.sin(gt(w))/f;return{x:E*g+.5,y:-I*g+.5,z:0}},unproject(x,w){const E=-(w-.5)/g,I=Ft(hr((x-.5)/g)/f,-180,180),A=Math.asin(Ft(E*f,-1,1)),z=Ft(hr(A),-85.051129,jn);return new Ot(I,z)}}}(s.parallels[0]);if(s.name==="lambertConformalConic"){const{project:u,unproject:f}=ny.mercator;h={wrap:!0,supportsWorldCopies:!0,project:u,unproject:f}}return si({},r,s,h)}return si({},r,s)}(e,t):e},a.getRTLTextPluginStatus=kr,a.getReferrer=Kl,a.getTilePoint=function(t,{x:e,y:r},s=0){return new ue(((e-s)*t.scale-t.x)*yt,(r*t.scale-t.y)*yt)},a.getTileVec3=function(t,e,r=0){return hn(((e.x-r)*t.scale-t.x)*yt,(e.y*t.scale-t.y)*yt,S_(e.z,e.y))},a.getVideo=function(t,e){const r=fe.document.createElement("video");r.muted=!0,r.onloadstart=function(){e(null,r)};for(let s=0;s<t.length;s++){const h=fe.document.createElement("source");zh(t[s])||(r.crossOrigin="Anonymous"),h.src=t[s],r.appendChild(h)}return{cancel:()=>{}}},a.globeBuffersForTileMesh=function(t,e,r,s){const h=t.context,u=t.transform;let f=e.globeGridBuffer,g=e.globePoleBuffer;if(!f){const x=df.createGridVertices(r.canonical);f=e.globeGridBuffer=h.createVertexBuffer(x,Xg,!1)}if(!g){const x=df.createPoleTriangleVertices(s,u.tileSize*s,r.canonical.y===0);g=e.globePoleBuffer=h.createVertexBuffer(x,Xg,!1)}return[f,g]},a.globeDenormalizeECEF=Yg,a.globeMatrixForTile=function(t,e){const r=Yg(Ku(t)),s=((h=new Float64Array(16))[0]=(u=e)[0],h[1]=u[1],h[2]=u[2],h[3]=u[3],h[4]=u[4],h[5]=u[5],h[6]=u[6],h[7]=u[7],h[8]=u[8],h[9]=u[9],h[10]=u[10],h[11]=u[11],h[12]=u[12],h[13]=u[13],h[14]=u[14],h[15]=u[15],h);var h,u;return Xr(s,s,r),s},a.globePoleMatrixForTile=function(t,e,r){const s=ti(new Float64Array(16)),h=Math.pow(2,t.z),u=(t.x-h/2)/h*Math.PI*2,f=r.point,g=r.worldSize/(r.tileSize*h);return Gi(s,s,[f.x,f.y,-r.worldSize/Math.PI/2]),Ti(s,s,[g,g,g]),cn(s,s,gt(-r._center.lat)),br(s,s,gt(-r._center.lng)),br(s,s,u),e&&Ti(s,s,[1,-1,1]),s},a.globeTileBounds=Ku,a.globeToMercatorTransition=function(t){return In(5,6,t)},a.identity=ti,a.identity$1=ya,a.invert=function(t,e){var r=e[0],s=e[1],h=e[2],u=e[3],f=e[4],g=e[5],x=e[6],w=e[7],E=e[8],I=e[9],A=e[10],z=e[11],R=e[12],O=e[13],U=e[14],Z=e[15],Q=r*g-s*f,ne=r*x-h*f,oe=r*w-u*f,ae=s*x-h*g,le=s*w-u*g,we=h*w-u*x,ve=E*O-I*R,Fe=E*U-A*R,Pe=E*Z-z*R,be=I*U-A*O,Le=I*Z-z*O,Oe=A*Z-z*U,Ie=Q*Oe-ne*Le+oe*be+ae*Pe-le*Fe+we*ve;return Ie?(t[0]=(g*Oe-x*Le+w*be)*(Ie=1/Ie),t[1]=(h*Le-s*Oe-u*be)*Ie,t[2]=(O*we-U*le+Z*ae)*Ie,t[3]=(A*le-I*we-z*ae)*Ie,t[4]=(x*Pe-f*Oe-w*Fe)*Ie,t[5]=(r*Oe-h*Pe+u*Fe)*Ie,t[6]=(U*oe-R*we-Z*ne)*Ie,t[7]=(E*we-A*oe+z*ne)*Ie,t[8]=(f*Le-g*Pe+w*ve)*Ie,t[9]=(s*Pe-r*Le-u*ve)*Ie,t[10]=(R*le-O*oe+Z*Q)*Ie,t[11]=(I*oe-E*le-z*Q)*Ie,t[12]=(g*Fe-f*be-x*ve)*Ie,t[13]=(r*be-s*Fe+h*ve)*Ie,t[14]=(O*ne-R*ae-U*Q)*Ie,t[15]=(E*ae-I*ne+A*Q)*Ie,t):null},a.isMapAuthenticated=function(t){return pn.has(t)},a.isMapboxURL=Te,a.isSafariWithAntialiasingBug=function(t){const e=t.navigator?t.navigator.userAgent:null;return!!Or(t)&&e&&(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},a.latFromMercatorY=on,a.len=bs,a.length=_a,a.length$1=function(t){return Math.hypot(t[0],t[1],t[2],t[3])},a.loadVectorTile=ty,a.makeRequest=Nr,a.mercatorXfromLng=cl,a.mercatorYfromLat=hl,a.mercatorZfromAltitude=vn,a.mul=Xr,a.mul$1=Wl,a.multiply=function(t,e,r){var s=e[0],h=e[1],u=e[2],f=e[3],g=e[4],x=e[5],w=e[6],E=e[7],I=e[8],A=r[0],z=r[1],R=r[2],O=r[3],U=r[4],Z=r[5],Q=r[6],ne=r[7],oe=r[8];return t[0]=A*s+z*f+R*w,t[1]=A*h+z*g+R*E,t[2]=A*u+z*x+R*I,t[3]=O*s+U*f+Z*w,t[4]=O*h+U*g+Z*E,t[5]=O*u+U*x+Z*I,t[6]=Q*s+ne*f+oe*w,t[7]=Q*h+ne*g+oe*E,t[8]=Q*u+ne*x+oe*I,t},a.multiply$1=$i,a.multiply$2=ys,a.nextPowerOfTwo=Tr,a.normalize=xs,a.normalize$1=function(t,e){var r=e[0],s=e[1],h=e[2],u=e[3],f=r*r+s*s+h*h+u*u;return f>0&&(f=1/Math.sqrt(f)),t[0]=r*f,t[1]=s*f,t[2]=h*f,t[3]=u*f,t},a.number=Lt,a.ortho=function(t,e,r,s,h,u,f){var g=1/(e-r),x=1/(s-h),w=1/(u-f);return t[0]=-2*g,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*x,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*w,t[11]=0,t[12]=(e+r)*g,t[13]=(h+s)*x,t[14]=(f+u)*w,t[15]=1,t},a.pbf=Bc,a.perspective=function(t,e,r,s,h){var u,f=1/Math.tan(e/2);return t[0]=f/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=f,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,h!=null&&h!==1/0?(t[10]=(h+s)*(u=1/(s-h)),t[14]=2*h*s*u):(t[10]=-1,t[14]=-2*s),t},a.pick=function(t,e){const r={};for(let s=0;s<e.length;s++){const h=e[s];h in t&&(r[h]=t[h])}return r},a.plugin=Et,a.pointGeometry=ue,a.polygonIntersectsBox=D_,a.polygonIntersectsPolygon=A_,a.polygonizeBounds=function(t,e,r=0,s=!0){const h=new ue(r,r),u=t.sub(h),f=e.add(h),g=[u,new ue(f.x,u.y),f,new ue(u.x,f.y)];return s&&g.push(u),g},a.posAttributes=Ib,a.postMapLoadEvent=Vt,a.postTurnstileEvent=qt,a.potpack=Vp,a.prevPowerOfTwo=function(t){return t<=1?1:Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},a.radToDeg=hr,a.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],a.registerForPluginStateChange=function(t){return t({pluginStatus:nt,pluginURL:_t}),nr.on("pluginStateChange",t),t},a.removeAuthState=function(t){pn.delete(t)},a.renderColorRamp=Dp,a.rotateX=cn,a.rotateX$1=xa,a.rotateY=br,a.rotateZ=function(t,e,r){var s=Math.sin(r),h=Math.cos(r),u=e[0],f=e[1],g=e[2],x=e[3],w=e[4],E=e[5],I=e[6],A=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=u*h+w*s,t[1]=f*h+E*s,t[2]=g*h+I*s,t[3]=x*h+A*s,t[4]=w*h-u*s,t[5]=E*h-f*s,t[6]=I*h-g*s,t[7]=A*h-x*s,t},a.rotateZ$1=function(t,e,r){r*=.5;var s=e[0],h=e[1],u=e[2],f=e[3],g=Math.sin(r),x=Math.cos(r);return t[0]=s*x+h*g,t[1]=h*x-s*g,t[2]=u*x+f*g,t[3]=f*x-u*g,t},a.scale=Ti,a.scale$1=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t},a.scale$2=Hr,a.scaleAndAdd=wr,a.setCacheLimits=function(t,e){Dh=t,Xl=e},a.setColumn=function(t,e,r){t[4*e+0]=r[0],t[4*e+1]=r[1],t[4*e+2]=r[2],t[4*e+3]=r[3]},a.setRTLTextPlugin=function(t,e,r=!1){if(nt===Ke||nt===st||nt===Rt)throw new Error("setRTLTextPlugin cannot be called multiple times.");_t=ur.resolveURL(t),nt=Ke,jt=e,vi(),r||$r()},a.smoothstep=In,a.spec=ye,a.storeAuthState=function(t,e){e?pn.add(t):pn.delete(t)},a.sub=Jn,a.subtract=gs,a.symbolSize=R1,a.tileAABB=function(t,e,r,s,h,u,f,g,x){if(x.name==="globe"){const z=Ku(new rf(u,new Zu(r,s,h)).canonical).getCorners(),R=Number.MAX_VALUE,O=[-R,-R,-R],U=[R,R,R],Z=Jg(t,e);for(let Q=0;Q<z.length;Q++)Tt(z[Q],z[Q],Z),E=U,I=z[Q],(w=U)[0]=Math.min(E[0],I[0]),w[1]=Math.min(E[1],I[1]),w[2]=Math.min(E[2],I[2]),Zl(O,O,z[Q]);return new bn(U,O)}var w,E,I;const A=wl({z:r,x:s,y:h},x);return new bn([(u+A.x/A.scale)*e,e*(A.y/A.scale),f],[(u+A.x2/A.scale)*e,e*(A.y2/A.scale),g])},a.tileTransform=wl,a.transformMat3=function(t,e,r){var s=e[0],h=e[1],u=e[2];return t[0]=s*r[0]+h*r[3]+u*r[6],t[1]=s*r[1]+h*r[4]+u*r[7],t[2]=s*r[2]+h*r[5]+u*r[8],t},a.transformMat4=Tt,a.transformMat4$1=Yr,a.transformQuat=ga,a.translate=Gi,a.transpose=function(t,e){if(t===e){var r=e[1],s=e[2],h=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=s,t[7]=h}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},a.triggerPluginCompletionEvent=Yt,a.uniqueId=go,a.validateCustomStyleLayer=function(t){const e=[],r=t.id;return r===void 0&&e.push({message:`layers.${r}: missing required property "id"`}),t.render===void 0&&e.push({message:`layers.${r}: missing required method "render"`}),t.renderingMode&&t.renderingMode!=="2d"&&t.renderingMode!=="3d"&&e.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),e},a.validateFog=ap,a.validateLight=$s,a.validateStyle=js,a.values=Ts,a.vectorTile=Yo,a.version=W,a.warnOnce=ii,a.window=fe,a.wrap=un}),S(["./shared"],function(a){function W(q){const D=typeof q;if(D==="number"||D==="boolean"||D==="string"||q==null)return JSON.stringify(q);if(Array.isArray(q)){let X="[";for(const re of q)X+=`${W(re)},`;return`${X}]`}const B=Object.keys(q).sort();let G="{";for(let X=0;X<B.length;X++)G+=`${JSON.stringify(B[X])}:${W(q[B[X]])},`;return`${G}}`}function ie(q){let D="";for(const B of a.refProperties)D+=`/${W(q[B])}`;return D}class ge{constructor(D){this.keyCache={},D&&this.replace(D)}replace(D){this._layerConfigs={},this._layers={},this.update(D,[])}update(D,B){for(const X of D)this._layerConfigs[X.id]=X,(this._layers[X.id]=a.createStyleLayer(X)).compileFilter(),this.keyCache[X.id]&&delete this.keyCache[X.id];for(const X of B)delete this.keyCache[X],delete this._layerConfigs[X],delete this._layers[X];this.familiesBySource={};const G=function(X,re){const ce={};for(let se=0;se<X.length;se++){const pe=re&&re[X[se].id]||ie(X[se]);re&&(re[X[se].id]=pe);let Te=ce[pe];Te||(Te=ce[pe]=[]),Te.push(X[se])}const he=[];for(const se in ce)he.push(ce[se]);return he}(a.values(this._layerConfigs),this.keyCache);for(const X of G){const re=X.map(Se=>this._layers[Se.id]),ce=re[0];if(ce.visibility==="none")continue;const he=ce.source||"";let se=this.familiesBySource[he];se||(se=this.familiesBySource[he]={});const pe=ce.sourceLayer||"_geojsonTileLayer";let Te=se[pe];Te||(Te=se[pe]=[]),Te.push(re)}}}const{ImageBitmap:ue}=a.window;class ze{loadTile(D,B){const{uid:G,encoding:X,rawImageData:re,padding:ce,buildQuadTree:he}=D,se=ue&&re instanceof ue?this.getImageData(re,ce):re;B(null,new a.DEMData(G,se,X,ce<1,he))}getImageData(D,B){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(D.width,D.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=D.width,this.offscreenCanvas.height=D.height,this.offscreenCanvasContext.drawImage(D,0,0,D.width,D.height);const G=this.offscreenCanvasContext.getImageData(-B,-B,D.width+2*B,D.height+2*B);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),new a.RGBAImage({width:G.width,height:G.height},G.data)}}var fe=function q(D,B){var G,X=D&&D.type;if(X==="FeatureCollection")for(G=0;G<D.features.length;G++)q(D.features[G],B);else if(X==="GeometryCollection")for(G=0;G<D.geometries.length;G++)q(D.geometries[G],B);else if(X==="Feature")q(D.geometry,B);else if(X==="Polygon")it(D.coordinates,B);else if(X==="MultiPolygon")for(G=0;G<D.coordinates.length;G++)it(D.coordinates[G],B);return D};function it(q,D){if(q.length!==0){dt(q[0],D);for(var B=1;B<q.length;B++)dt(q[B],!D)}}function dt(q,D){for(var B=0,G=0,X=0,re=q.length,ce=re-1;X<re;ce=X++){var he=(q[X][0]-q[ce][0])*(q[ce][1]+q[X][1]),se=B+he;G+=Math.abs(B)>=Math.abs(he)?B-se+he:he-se+B,B=se}B+G>=0!=!!D&&q.reverse()}const pi=a.vectorTile.VectorTileFeature.prototype.toGeoJSON;class ti{constructor(D){this._feature=D,this.extent=a.EXTENT,this.type=D.type,this.properties=D.tags,"id"in D&&!isNaN(D.id)&&(this.id=parseInt(D.id,10))}loadGeometry(){if(this._feature.type===1){const D=[];for(const B of this._feature.geometry)D.push([new a.pointGeometry(B[0],B[1])]);return D}{const D=[];for(const B of this._feature.geometry){const G=[];for(const X of B)G.push(new a.pointGeometry(X[0],X[1]));D.push(G)}return D}}toGeoJSON(D,B,G){return pi.call(this,D,B,G)}}class $i{constructor(D){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=a.EXTENT,this.length=D.length,this._features=D}feature(D){return new ti(this._features[D])}}var Gi=a.vectorTile.VectorTileFeature,Ti=cn;function cn(q,D){this.options=D||{},this.features=q,this.length=q.length}function br(q,D){this.id=typeof q.id=="number"?q.id:void 0,this.type=q.type,this.rawGeometry=q.type===1?[q.geometry]:q.geometry,this.properties=q.tags,this.extent=D||4096}cn.prototype.feature=function(q){return new br(this.features[q],this.options.extent)},br.prototype.loadGeometry=function(){var q=this.rawGeometry;this.geometry=[];for(var D=0;D<q.length;D++){for(var B=q[D],G=[],X=0;X<B.length;X++)G.push(new a.pointGeometry(B[X][0],B[X][1]));this.geometry.push(G)}return this.geometry},br.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var q=this.geometry,D=1/0,B=-1/0,G=1/0,X=-1/0,re=0;re<q.length;re++)for(var ce=q[re],he=0;he<ce.length;he++){var se=ce[he];D=Math.min(D,se.x),B=Math.max(B,se.x),G=Math.min(G,se.y),X=Math.max(X,se.y)}return[D,G,B,X]},br.prototype.toGeoJSON=Gi.prototype.toGeoJSON;var Xr=Kn,lo=Ti;function Kn(q){var D=new a.pbf;return function(B,G){for(var X in B.layers)G.writeMessage(3,_a,B.layers[X])}(q,D),D.finish()}function _a(q,D){var B;D.writeVarintField(15,q.version||1),D.writeStringField(1,q.name||""),D.writeVarintField(5,q.extent||4096);var G={keys:[],values:[],keycache:{},valuecache:{}};for(B=0;B<q.length;B++)G.feature=q.feature(B),D.writeMessage(2,hn,G);var X=G.keys;for(B=0;B<X.length;B++)D.writeStringField(3,X[B]);var re=G.values;for(B=0;B<re.length;B++)D.writeMessage(4,Hr,re[B])}function hn(q,D){var B=q.feature;B.id!==void 0&&D.writeVarintField(1,B.id),D.writeMessage(2,co,q),D.writeVarintField(3,B.type),D.writeMessage(4,Zl,B)}function co(q,D){var B=q.feature,G=q.keys,X=q.values,re=q.keycache,ce=q.valuecache;for(var he in B.properties){var se=B.properties[he],pe=re[he];if(se!==null){pe===void 0&&(G.push(he),re[he]=pe=G.length-1),D.writeVarint(pe);var Te=typeof se;Te!=="string"&&Te!=="boolean"&&Te!=="number"&&(se=JSON.stringify(se));var Se=Te+":"+se,Me=ce[Se];Me===void 0&&(X.push(se),ce[Se]=Me=X.length-1),D.writeVarint(Me)}}}function gs(q,D){return(D<<3)+(7&q)}function ys(q){return q<<1^q>>31}function Zl(q,D){for(var B=q.loadGeometry(),G=q.type,X=0,re=0,ce=B.length,he=0;he<ce;he++){var se=B[he],pe=1;G===1&&(pe=se.length),D.writeVarint(gs(1,pe));for(var Te=G===3?se.length-1:se.length,Se=0;Se<Te;Se++){Se===1&&G!==1&&D.writeVarint(gs(2,Te-1));var Me=se[Se].x-X,We=se[Se].y-re;D.writeVarint(ys(Me)),D.writeVarint(ys(We)),X+=Me,re+=We}G===3&&D.writeVarint(gs(7,1))}}function Hr(q,D){var B=typeof q;B==="string"?D.writeStringField(1,q):B==="boolean"?D.writeBooleanField(7,q):B==="number"&&(q%1!=0?D.writeDoubleField(3,q):q<0?D.writeSVarintField(6,q):D.writeVarintField(5,q))}function wr(q,D,B,G,X,re){if(X-G<=B)return;const ce=G+X>>1;xs(q,D,ce,G,X,re%2),wr(q,D,B,G,ce-1,re+1),wr(q,D,B,ce+1,X,re+1)}function xs(q,D,B,G,X,re){for(;X>G;){if(X-G>600){const pe=X-G+1,Te=B-G+1,Se=Math.log(pe),Me=.5*Math.exp(2*Se/3),We=.5*Math.sqrt(Se*Me*(pe-Me)/pe)*(Te-pe/2<0?-1:1);xs(q,D,B,Math.max(G,Math.floor(B-Te*Me/pe+We)),Math.min(X,Math.floor(B+(pe-Te)*Me/pe+We)),re)}const ce=D[2*B+re];let he=G,se=X;for(Kr(q,D,G,B),D[2*X+re]>ce&&Kr(q,D,G,X);he<se;){for(Kr(q,D,he,se),he++,se--;D[2*he+re]<ce;)he++;for(;D[2*se+re]>ce;)se--}D[2*G+re]===ce?Kr(q,D,G,se):(se++,Kr(q,D,se,X)),se<=B&&(G=se+1),B<=se&&(X=se-1)}}function Kr(q,D,B,G){vs(q,B,G),vs(D,2*B,2*G),vs(D,2*B+1,2*G+1)}function vs(q,D,B){const G=q[D];q[D]=q[B],q[B]=G}function Tt(q,D,B,G){const X=q-B,re=D-G;return X*X+re*re}Xr.fromVectorTileJs=Kn,Xr.fromGeojsonVt=function(q,D){D=D||{};var B={};for(var G in q)B[G]=new Ti(q[G].features,D),B[G].name=G,B[G].version=D.version,B[G].extent=D.extent;return Kn({layers:B})},Xr.GeoJSONWrapper=lo;const ga=q=>q[0],Yn=q=>q[1];class Jn{constructor(D,B=ga,G=Yn,X=64,re=Float64Array){this.nodeSize=X,this.points=D;const ce=D.length<65536?Uint16Array:Uint32Array,he=this.ids=new ce(D.length),se=this.coords=new re(2*D.length);for(let pe=0;pe<D.length;pe++)he[pe]=pe,se[2*pe]=B(D[pe]),se[2*pe+1]=G(D[pe]);wr(he,se,X,0,he.length-1,0)}range(D,B,G,X){return function(re,ce,he,se,pe,Te,Se){const Me=[0,re.length-1,0],We=[];let Je,Qe;for(;Me.length;){const tt=Me.pop(),mt=Me.pop(),qt=Me.pop();if(mt-qt<=Se){for(let Kt=qt;Kt<=mt;Kt++)Je=ce[2*Kt],Qe=ce[2*Kt+1],Je>=he&&Je<=pe&&Qe>=se&&Qe<=Te&&We.push(re[Kt]);continue}const Ht=Math.floor((qt+mt)/2);Je=ce[2*Ht],Qe=ce[2*Ht+1],Je>=he&&Je<=pe&&Qe>=se&&Qe<=Te&&We.push(re[Ht]);const Vt=(tt+1)%2;(tt===0?he<=Je:se<=Qe)&&(Me.push(qt),Me.push(Ht-1),Me.push(Vt)),(tt===0?pe>=Je:Te>=Qe)&&(Me.push(Ht+1),Me.push(mt),Me.push(Vt))}return We}(this.ids,this.coords,D,B,G,X,this.nodeSize)}within(D,B,G){return function(X,re,ce,he,se,pe){const Te=[0,X.length-1,0],Se=[],Me=se*se;for(;Te.length;){const We=Te.pop(),Je=Te.pop(),Qe=Te.pop();if(Je-Qe<=pe){for(let Vt=Qe;Vt<=Je;Vt++)Tt(re[2*Vt],re[2*Vt+1],ce,he)<=Me&&Se.push(X[Vt]);continue}const tt=Math.floor((Qe+Je)/2),mt=re[2*tt],qt=re[2*tt+1];Tt(mt,qt,ce,he)<=Me&&Se.push(X[tt]);const Ht=(We+1)%2;(We===0?ce-se<=mt:he-se<=qt)&&(Te.push(Qe),Te.push(tt-1),Te.push(Ht)),(We===0?ce+se>=mt:he+se>=qt)&&(Te.push(tt+1),Te.push(Je),Te.push(Ht))}return Se}(this.ids,this.coords,D,B,G,this.nodeSize)}}const Wl={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:q=>q},bs=Math.fround||(Yr=new Float32Array(1),q=>(Yr[0]=+q,Yr[0]));var Yr;class ho{constructor(D){this.options=Qn(Object.create(Wl),D),this.trees=new Array(this.options.maxZoom+1)}load(D){const{log:B,minZoom:G,maxZoom:X,nodeSize:re}=this.options;B&&console.time("total time");const ce=`prepare ${D.length} points`;B&&console.time(ce),this.points=D;let he=[];for(let se=0;se<D.length;se++)D[se].geometry&&he.push(xa(D[se],se));this.trees[X+1]=new Jn(he,po,fo,re,Float32Array),B&&console.timeEnd(ce);for(let se=X;se>=G;se--){const pe=+Date.now();he=this._cluster(he,se),this.trees[se]=new Jn(he,po,fo,re,Float32Array),B&&console.log("z%d: %d clusters in %dms",se,he.length,+Date.now()-pe)}return B&&console.timeEnd("total time"),this}getClusters(D,B){let G=((D[0]+180)%360+360)%360-180;const X=Math.max(-90,Math.min(90,D[1]));let re=D[2]===180?180:((D[2]+180)%360+360)%360-180;const ce=Math.max(-90,Math.min(90,D[3]));if(D[2]-D[0]>=360)G=-180,re=180;else if(G>re){const Te=this.getClusters([G,X,180,ce],B),Se=this.getClusters([-180,X,re,ce],B);return Te.concat(Se)}const he=this.trees[this._limitZoom(B)],se=he.range(ws(G),gt(ce),ws(re),gt(X)),pe=[];for(const Te of se){const Se=he.points[Te];pe.push(Se.numPoints?uo(Se):this.points[Se.index])}return pe}getChildren(D){const B=this._getOriginId(D),G=this._getOriginZoom(D),X="No cluster with the specified id.",re=this.trees[G];if(!re)throw new Error(X);const ce=re.points[B];if(!ce)throw new Error(X);const he=this.options.radius/(this.options.extent*Math.pow(2,G-1)),se=re.within(ce.x,ce.y,he),pe=[];for(const Te of se){const Se=re.points[Te];Se.parentId===D&&pe.push(Se.numPoints?uo(Se):this.points[Se.index])}if(pe.length===0)throw new Error(X);return pe}getLeaves(D,B,G){const X=[];return this._appendLeaves(X,D,B=B||10,G=G||0,0),X}getTile(D,B,G){const X=this.trees[this._limitZoom(D)],re=Math.pow(2,D),{extent:ce,radius:he}=this.options,se=he/ce,pe=(G-se)/re,Te=(G+1+se)/re,Se={features:[]};return this._addTileFeatures(X.range((B-se)/re,pe,(B+1+se)/re,Te),X.points,B,G,re,Se),B===0&&this._addTileFeatures(X.range(1-se/re,pe,1,Te),X.points,re,G,re,Se),B===re-1&&this._addTileFeatures(X.range(0,pe,se/re,Te),X.points,-1,G,re,Se),Se.features.length?Se:null}getClusterExpansionZoom(D){let B=this._getOriginZoom(D)-1;for(;B<=this.options.maxZoom;){const G=this.getChildren(D);if(B++,G.length!==1)break;D=G[0].properties.cluster_id}return B}_appendLeaves(D,B,G,X,re){const ce=this.getChildren(B);for(const he of ce){const se=he.properties;if(se&&se.cluster?re+se.point_count<=X?re+=se.point_count:re=this._appendLeaves(D,se.cluster_id,G,X,re):re<X?re++:D.push(he),D.length===G)break}return re}_addTileFeatures(D,B,G,X,re,ce){for(const he of D){const se=B[he],pe=se.numPoints;let Te,Se,Me;if(pe)Te=va(se),Se=se.x,Me=se.y;else{const Qe=this.points[se.index];Te=Qe.properties,Se=ws(Qe.geometry.coordinates[0]),Me=gt(Qe.geometry.coordinates[1])}const We={type:1,geometry:[[Math.round(this.options.extent*(Se*re-G)),Math.round(this.options.extent*(Me*re-X))]],tags:Te};let Je;pe?Je=se.id:this.options.generateId?Je=se.index:this.points[se.index].id&&(Je=this.points[se.index].id),Je!==void 0&&(We.id=Je),ce.features.push(We)}}_limitZoom(D){return Math.max(this.options.minZoom,Math.min(+D,this.options.maxZoom+1))}_cluster(D,B){const G=[],{radius:X,extent:re,reduce:ce,minPoints:he}=this.options,se=X/(re*Math.pow(2,B));for(let pe=0;pe<D.length;pe++){const Te=D[pe];if(Te.zoom<=B)continue;Te.zoom=B;const Se=this.trees[B+1],Me=Se.within(Te.x,Te.y,se),We=Te.numPoints||1;let Je=We;for(const Qe of Me){const tt=Se.points[Qe];tt.zoom>B&&(Je+=tt.numPoints||1)}if(Je>We&&Je>=he){let Qe=Te.x*We,tt=Te.y*We,mt=ce&&We>1?this._map(Te,!0):null;const qt=(pe<<5)+(B+1)+this.points.length;for(const Ht of Me){const Vt=Se.points[Ht];if(Vt.zoom<=B)continue;Vt.zoom=B;const Kt=Vt.numPoints||1;Qe+=Vt.x*Kt,tt+=Vt.y*Kt,Vt.parentId=qt,ce&&(mt||(mt=this._map(Te,!0)),ce(mt,this._map(Vt)))}Te.parentId=qt,G.push(ya(Qe/Je,tt/Je,qt,Je,mt))}else if(G.push(Te),Je>1)for(const Qe of Me){const tt=Se.points[Qe];tt.zoom<=B||(tt.zoom=B,G.push(tt))}}return G}_getOriginId(D){return D-this.points.length>>5}_getOriginZoom(D){return(D-this.points.length)%32}_map(D,B){if(D.numPoints)return B?Qn({},D.properties):D.properties;const G=this.points[D.index].properties,X=this.options.map(G);return B&&X===G?Qn({},X):X}}function ya(q,D,B,G,X){return{x:bs(q),y:bs(D),zoom:1/0,id:B,parentId:-1,numPoints:G,properties:X}}function xa(q,D){const[B,G]=q.geometry.coordinates;return{x:bs(ws(B)),y:bs(gt(G)),zoom:1/0,index:D,parentId:-1}}function uo(q){return{type:"Feature",id:q.id,properties:va(q),geometry:{type:"Point",coordinates:[(D=q.x,360*(D-.5)),hr(q.y)]}};var D}function va(q){const D=q.numPoints,B=D>=1e4?`${Math.round(D/1e3)}k`:D>=1e3?Math.round(D/100)/10+"k":D;return Qn(Qn({},q.properties),{cluster:!0,cluster_id:q.id,point_count:D,point_count_abbreviated:B})}function ws(q){return q/360+.5}function gt(q){const D=Math.sin(q*Math.PI/180),B=.5-.25*Math.log((1+D)/(1-D))/Math.PI;return B<0?0:B>1?1:B}function hr(q){const D=(180-360*q)*Math.PI/180;return 360*Math.atan(Math.exp(D))/Math.PI-90}function Qn(q,D){for(const B in D)q[B]=D[B];return q}function po(q){return q.x}function fo(q){return q.y}function mo(q,D,B,G){for(var X,re=G,ce=B-D>>1,he=B-D,se=q[D],pe=q[D+1],Te=q[B],Se=q[B+1],Me=D+3;Me<B;Me+=3){var We=Ft(q[Me],q[Me+1],se,pe,Te,Se);if(We>re)X=Me,re=We;else if(We===re){var Je=Math.abs(Me-ce);Je<he&&(X=Me,he=Je)}}re>G&&(X-D>3&&mo(q,D,X,G),q[X+2]=re,B-X>3&&mo(q,X,B,G))}function Ft(q,D,B,G,X,re){var ce=X-B,he=re-G;if(ce!==0||he!==0){var se=((q-B)*ce+(D-G)*he)/(ce*ce+he*he);se>1?(B=X,G=re):se>0&&(B+=ce*se,G+=he*se)}return(ce=q-B)*ce+(he=D-G)*he}function In(q,D,B,G){var X={id:q===void 0?null:q,type:D,geometry:B,tags:G,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(re){var ce=re.geometry,he=re.type;if(he==="Point"||he==="MultiPoint"||he==="LineString")un(re,ce);else if(he==="Polygon"||he==="MultiLineString")for(var se=0;se<ce.length;se++)un(re,ce[se]);else if(he==="MultiPolygon")for(se=0;se<ce.length;se++)for(var pe=0;pe<ce[se].length;pe++)un(re,ce[se][pe])}(X),X}function un(q,D){for(var B=0;B<D.length;B+=3)q.minX=Math.min(q.minX,D[B]),q.minY=Math.min(q.minY,D[B+1]),q.maxX=Math.max(q.maxX,D[B]),q.maxY=Math.max(q.maxY,D[B+1])}function es(q,D,B,G){if(D.geometry){var X=D.geometry.coordinates,re=D.geometry.type,ce=Math.pow(B.tolerance/((1<<B.maxZoom)*B.extent),2),he=[],se=D.id;if(B.promoteId?se=D.properties[B.promoteId]:B.generateId&&(se=G||0),re==="Point")Ts(X,he);else if(re==="MultiPoint")for(var pe=0;pe<X.length;pe++)Ts(X[pe],he);else if(re==="LineString")si(X,he,ce,!1);else if(re==="MultiLineString"){if(B.lineMetrics){for(pe=0;pe<X.length;pe++)si(X[pe],he=[],ce,!1),q.push(In(se,"LineString",he,D.properties));return}_o(X,he,ce,!1)}else if(re==="Polygon")_o(X,he,ce,!0);else{if(re!=="MultiPolygon"){if(re==="GeometryCollection"){for(pe=0;pe<D.geometry.geometries.length;pe++)es(q,{id:se,geometry:D.geometry.geometries[pe],properties:D.properties},B,G);return}throw new Error("Input data is not a valid GeoJSON object.")}for(pe=0;pe<X.length;pe++){var Te=[];_o(X[pe],Te,ce,!0),he.push(Te)}}q.push(In(se,re,he,D.properties))}}function Ts(q,D){D.push(go(q[0])),D.push(yo(q[1])),D.push(0)}function si(q,D,B,G){for(var X,re,ce=0,he=0;he<q.length;he++){var se=go(q[he][0]),pe=yo(q[he][1]);D.push(se),D.push(pe),D.push(0),he>0&&(ce+=G?(X*pe-se*re)/2:Math.sqrt(Math.pow(se-X,2)+Math.pow(pe-re,2))),X=se,re=pe}var Te=D.length-3;D[2]=1,mo(D,0,Te,B),D[Te+2]=1,D.size=Math.abs(ce),D.start=0,D.end=D.size}function _o(q,D,B,G){for(var X=0;X<q.length;X++){var re=[];si(q[X],re,B,G),D.push(re)}}function go(q){return q/360+.5}function yo(q){var D=Math.sin(q*Math.PI/180),B=.5-.25*Math.log((1+D)/(1-D))/Math.PI;return B<0?0:B>1?1:B}function Tr(q,D,B,G,X,re,ce,he){if(G/=D,re>=(B/=D)&&ce<G)return q;if(ce<B||re>=G)return null;for(var se=[],pe=0;pe<q.length;pe++){var Te=q[pe],Se=Te.geometry,Me=Te.type,We=X===0?Te.minX:Te.minY,Je=X===0?Te.maxX:Te.maxY;if(We>=B&&Je<G)se.push(Te);else if(!(Je<B||We>=G)){var Qe=[];if(Me==="Point"||Me==="MultiPoint")ba(Se,Qe,B,G,X);else if(Me==="LineString")Es(Se,Qe,B,G,X,!1,he.lineMetrics);else if(Me==="MultiLineString")An(Se,Qe,B,G,X,!1);else if(Me==="Polygon")An(Se,Qe,B,G,X,!0);else if(Me==="MultiPolygon")for(var tt=0;tt<Se.length;tt++){var mt=[];An(Se[tt],mt,B,G,X,!0),mt.length&&Qe.push(mt)}if(Qe.length){if(he.lineMetrics&&Me==="LineString"){for(tt=0;tt<Qe.length;tt++)se.push(In(Te.id,Me,Qe[tt],Te.tags));continue}Me!=="LineString"&&Me!=="MultiLineString"||(Qe.length===1?(Me="LineString",Qe=Qe[0]):Me="MultiLineString"),Me!=="Point"&&Me!=="MultiPoint"||(Me=Qe.length===3?"Point":"MultiPoint"),se.push(In(Te.id,Me,Qe,Te.tags))}}}return se.length?se:null}function ba(q,D,B,G,X){for(var re=0;re<q.length;re+=3){var ce=q[re+X];ce>=B&&ce<=G&&(D.push(q[re]),D.push(q[re+1]),D.push(q[re+2]))}}function Es(q,D,B,G,X,re,ce){for(var he,se,pe=Ss(q),Te=X===0?Er:wa,Se=q.start,Me=0;Me<q.length-3;Me+=3){var We=q[Me],Je=q[Me+1],Qe=q[Me+2],tt=q[Me+3],mt=q[Me+4],qt=X===0?We:Je,Ht=X===0?tt:mt,Vt=!1;ce&&(he=Math.sqrt(Math.pow(We-tt,2)+Math.pow(Je-mt,2))),qt<B?Ht>B&&(se=Te(pe,We,Je,tt,mt,B),ce&&(pe.start=Se+he*se)):qt>G?Ht<G&&(se=Te(pe,We,Je,tt,mt,G),ce&&(pe.start=Se+he*se)):Is(pe,We,Je,Qe),Ht<B&&qt>=B&&(se=Te(pe,We,Je,tt,mt,B),Vt=!0),Ht>G&&qt<=G&&(se=Te(pe,We,Je,tt,mt,G),Vt=!0),!re&&Vt&&(ce&&(pe.end=Se+he*se),D.push(pe),pe=Ss(q)),ce&&(Se+=he)}var Kt=q.length-3;We=q[Kt],Je=q[Kt+1],Qe=q[Kt+2],(qt=X===0?We:Je)>=B&&qt<=G&&Is(pe,We,Je,Qe),Kt=pe.length-3,re&&Kt>=3&&(pe[Kt]!==pe[0]||pe[Kt+1]!==pe[1])&&Is(pe,pe[0],pe[1],pe[2]),pe.length&&D.push(pe)}function Ss(q){var D=[];return D.size=q.size,D.start=q.start,D.end=q.end,D}function An(q,D,B,G,X,re){for(var ce=0;ce<q.length;ce++)Es(q[ce],D,B,G,X,re,!1)}function Is(q,D,B,G){q.push(D),q.push(B),q.push(G)}function Er(q,D,B,G,X,re){var ce=(re-D)/(G-D);return q.push(re),q.push(B+(X-B)*ce),q.push(1),ce}function wa(q,D,B,G,X,re){var ce=(re-B)/(X-B);return q.push(D+(G-D)*ce),q.push(re),q.push(1),ce}function ii(q,D){for(var B=[],G=0;G<q.length;G++){var X,re=q[G],ce=re.type;if(ce==="Point"||ce==="MultiPoint"||ce==="LineString")X=Sr(re.geometry,D);else if(ce==="MultiLineString"||ce==="Polygon"){X=[];for(var he=0;he<re.geometry.length;he++)X.push(Sr(re.geometry[he],D))}else if(ce==="MultiPolygon")for(X=[],he=0;he<re.geometry.length;he++){for(var se=[],pe=0;pe<re.geometry[he].length;pe++)se.push(Sr(re.geometry[he][pe],D));X.push(se)}B.push(In(re.id,ce,X,re.tags))}return B}function Sr(q,D){var B=[];B.size=q.size,q.start!==void 0&&(B.start=q.start,B.end=q.end);for(var G=0;G<q.length;G+=3)B.push(q[G]+D,q[G+1],q[G+2]);return B}function As(q,D){if(q.transformed)return q;var B,G,X,re=1<<q.z,ce=q.x,he=q.y;for(B=0;B<q.features.length;B++){var se=q.features[B],pe=se.geometry,Te=se.type;if(se.geometry=[],Te===1)for(G=0;G<pe.length;G+=2)se.geometry.push(Jr(pe[G],pe[G+1],D,re,ce,he));else for(G=0;G<pe.length;G++){var Se=[];for(X=0;X<pe[G].length;X+=2)Se.push(Jr(pe[G][X],pe[G][X+1],D,re,ce,he));se.geometry.push(Se)}}return q.transformed=!0,q}function Jr(q,D,B,G,X,re){return[Math.round(B*(q*G-X)),Math.round(B*(D*G-re))]}function Cs(q,D,B,G,X){for(var re=D===X.maxZoom?0:X.tolerance/((1<<D)*X.extent),ce={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:B,y:G,z:D,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},he=0;he<q.length;he++){ce.numFeatures++,ts(ce,q[he],re,X);var se=q[he].minX,pe=q[he].minY,Te=q[he].maxX,Se=q[he].maxY;se<ce.minX&&(ce.minX=se),pe<ce.minY&&(ce.minY=pe),Te>ce.maxX&&(ce.maxX=Te),Se>ce.maxY&&(ce.maxY=Se)}return ce}function ts(q,D,B,G){var X=D.geometry,re=D.type,ce=[];if(re==="Point"||re==="MultiPoint")for(var he=0;he<X.length;he+=3)ce.push(X[he]),ce.push(X[he+1]),q.numPoints++,q.numSimplified++;else if(re==="LineString")dn(ce,X,q,B,!1,!1);else if(re==="MultiLineString"||re==="Polygon")for(he=0;he<X.length;he++)dn(ce,X[he],q,B,re==="Polygon",he===0);else if(re==="MultiPolygon")for(var se=0;se<X.length;se++){var pe=X[se];for(he=0;he<pe.length;he++)dn(ce,pe[he],q,B,!0,he===0)}if(ce.length){var Te=D.tags||null;if(re==="LineString"&&G.lineMetrics){for(var Se in Te={},D.tags)Te[Se]=D.tags[Se];Te.mapbox_clip_start=X.start/X.size,Te.mapbox_clip_end=X.end/X.size}var Me={geometry:ce,type:re==="Polygon"||re==="MultiPolygon"?3:re==="LineString"||re==="MultiLineString"?2:1,tags:Te};D.id!==null&&(Me.id=D.id),q.features.push(Me)}}function dn(q,D,B,G,X,re){var ce=G*G;if(G>0&&D.size<(X?ce:G))B.numPoints+=D.length/3;else{for(var he=[],se=0;se<D.length;se+=3)(G===0||D[se+2]>ce)&&(B.numSimplified++,he.push(D[se]),he.push(D[se+1])),B.numPoints++;X&&function(pe,Te){for(var Se=0,Me=0,We=pe.length,Je=We-2;Me<We;Je=Me,Me+=2)Se+=(pe[Me]-pe[Je])*(pe[Me+1]+pe[Je+1]);if(Se>0===Te)for(Me=0,We=pe.length;Me<We/2;Me+=2){var Qe=pe[Me],tt=pe[Me+1];pe[Me]=pe[We-2-Me],pe[Me+1]=pe[We-1-Me],pe[We-2-Me]=Qe,pe[We-1-Me]=tt}}(he,re),q.push(he)}}function Fr(q,D){var B=(D=this.options=function(X,re){for(var ce in re)X[ce]=re[ce];return X}(Object.create(this.options),D)).debug;if(B&&console.time("preprocess data"),D.maxZoom<0||D.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(D.promoteId&&D.generateId)throw new Error("promoteId and generateId cannot be used together.");var G=function(X,re){var ce=[];if(X.type==="FeatureCollection")for(var he=0;he<X.features.length;he++)es(ce,X.features[he],re,he);else es(ce,X.type==="Feature"?X:{geometry:X},re);return ce}(q,D);this.tiles={},this.tileCoords=[],B&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",D.indexMaxZoom,D.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(G=function(X,re){var ce=re.buffer/re.extent,he=X,se=Tr(X,1,-1-ce,ce,0,-1,2,re),pe=Tr(X,1,1-ce,2+ce,0,-1,2,re);return(se||pe)&&(he=Tr(X,1,-ce,1+ce,0,-1,2,re)||[],se&&(he=ii(se,1).concat(he)),pe&&(he=he.concat(ii(pe,-1)))),he}(G,D)).length&&this.splitTile(G,0,0,0),B&&(G.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function Cn(q,D,B){return 32*((1<<q)*B+D)+q}function Or(q,D){const B=q.tileID.canonical;if(!this._geoJSONIndex)return D(null,null);const G=this._geoJSONIndex.getTile(B.z,B.x,B.y);if(!G)return D(null,null);const X=new $i(G.features);let re=Xr(X);re.byteOffset===0&&re.byteLength===re.buffer.byteLength||(re=new Uint8Array(re)),D(null,{vectorTile:X,rawData:re.buffer})}Fr.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},Fr.prototype.splitTile=function(q,D,B,G,X,re,ce){for(var he=[q,D,B,G],se=this.options,pe=se.debug;he.length;){G=he.pop(),B=he.pop(),D=he.pop(),q=he.pop();var Te=1<<D,Se=Cn(D,B,G),Me=this.tiles[Se];if(!Me&&(pe>1&&console.time("creation"),Me=this.tiles[Se]=Cs(q,D,B,G,se),this.tileCoords.push({z:D,x:B,y:G}),pe)){pe>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",D,B,G,Me.numFeatures,Me.numPoints,Me.numSimplified),console.timeEnd("creation"));var We="z"+D;this.stats[We]=(this.stats[We]||0)+1,this.total++}if(Me.source=q,X){if(D===se.maxZoom||D===X)continue;var Je=1<<X-D;if(B!==Math.floor(re/Je)||G!==Math.floor(ce/Je))continue}else if(D===se.indexMaxZoom||Me.numPoints<=se.indexMaxPoints)continue;if(Me.source=null,q.length!==0){pe>1&&console.time("clipping");var Qe,tt,mt,qt,Ht,Vt,Kt=.5*se.buffer/se.extent,Mn=.5-Kt,pn=.5+Kt,Ri=1+Kt;Qe=tt=mt=qt=null,Ht=Tr(q,Te,B-Kt,B+pn,0,Me.minX,Me.maxX,se),Vt=Tr(q,Te,B+Mn,B+Ri,0,Me.minX,Me.maxX,se),q=null,Ht&&(Qe=Tr(Ht,Te,G-Kt,G+pn,1,Me.minY,Me.maxY,se),tt=Tr(Ht,Te,G+Mn,G+Ri,1,Me.minY,Me.maxY,se),Ht=null),Vt&&(mt=Tr(Vt,Te,G-Kt,G+pn,1,Me.minY,Me.maxY,se),qt=Tr(Vt,Te,G+Mn,G+Ri,1,Me.minY,Me.maxY,se),Vt=null),pe>1&&console.timeEnd("clipping"),he.push(Qe||[],D+1,2*B,2*G),he.push(tt||[],D+1,2*B,2*G+1),he.push(mt||[],D+1,2*B+1,2*G),he.push(qt||[],D+1,2*B+1,2*G+1)}}},Fr.prototype.getTile=function(q,D,B){var G=this.options,X=G.extent,re=G.debug;if(q<0||q>24)return null;var ce=1<<q,he=Cn(q,D=(D%ce+ce)%ce,B);if(this.tiles[he])return As(this.tiles[he],X);re>1&&console.log("drilling down to z%d-%d-%d",q,D,B);for(var se,pe=q,Te=D,Se=B;!se&&pe>0;)pe--,Te=Math.floor(Te/2),Se=Math.floor(Se/2),se=this.tiles[Cn(pe,Te,Se)];return se&&se.source?(re>1&&console.log("found parent tile z%d-%d-%d",pe,Te,Se),re>1&&console.time("drilling down"),this.splitTile(se.source,pe,Te,Se,q,D,B),re>1&&console.timeEnd("drilling down"),this.tiles[he]?As(this.tiles[he],X):null):null};class Ms extends a.VectorTileWorkerSource{constructor(D,B,G,X,re){super(D,B,G,X,Or),re&&(this.loadGeoJSON=re)}loadData(D,B){const G=D&&D.request,X=G&&G.collectResourceTiming;this.loadGeoJSON(D,(re,ce)=>{if(re||!ce)return B(re);if(typeof ce!="object")return B(new Error(`Input data given to '${D.source}' is not a valid GeoJSON object.`));{fe(ce,!0);try{if(D.filter){const se=a.createExpression(D.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(se.result==="error")throw new Error(se.value.map(Te=>`${Te.key}: ${Te.message}`).join(", "));const pe=ce.features.filter(Te=>se.value.evaluate({zoom:0},Te));ce={type:"FeatureCollection",features:pe}}this._geoJSONIndex=D.cluster?new ho(function({superclusterOptions:se,clusterProperties:pe}){if(!pe||!se)return se;const Te={},Se={},Me={accumulated:null,zoom:0},We={properties:null},Je=Object.keys(pe);for(const Qe of Je){const[tt,mt]=pe[Qe],qt=a.createExpression(mt),Ht=a.createExpression(typeof tt=="string"?[tt,["accumulated"],["get",Qe]]:tt);Te[Qe]=qt.value,Se[Qe]=Ht.value}return se.map=Qe=>{We.properties=Qe;const tt={};for(const mt of Je)tt[mt]=Te[mt].evaluate(Me,We);return tt},se.reduce=(Qe,tt)=>{We.properties=tt;for(const mt of Je)Me.accumulated=Qe[mt],Qe[mt]=Se[mt].evaluate(Me,We)},se}(D)).load(ce.features):function(se,pe){return new Fr(se,pe)}(ce,D.geojsonVtOptions)}catch(se){return B(se)}this.loaded={};const he={};if(X){const se=a.getPerformanceMeasurement(G);se&&(he.resourceTiming={},he.resourceTiming[D.source]=JSON.parse(JSON.stringify(se)))}B(null,he)}})}reloadTile(D,B){const G=this.loaded;return G&&G[D.uid]?super.reloadTile(D,B):this.loadTile(D,B)}loadGeoJSON(D,B){if(D.request)a.getJSON(D.request,B);else{if(typeof D.data!="string")return B(new Error(`Input data given to '${D.source}' is not a valid GeoJSON object.`));try{return B(null,JSON.parse(D.data))}catch{return B(new Error(`Input data given to '${D.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(D,B){try{B(null,this._geoJSONIndex.getClusterExpansionZoom(D.clusterId))}catch(G){B(G)}}getClusterChildren(D,B){try{B(null,this._geoJSONIndex.getChildren(D.clusterId))}catch(G){B(G)}}getClusterLeaves(D,B){try{B(null,this._geoJSONIndex.getLeaves(D.clusterId,D.limit,D.offset))}catch(G){B(G)}}}class ur{constructor(D){this.self=D,this.actor=new a.Actor(D,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=a.getProjection({name:"mercator"}),this.workerSourceTypes={vector:a.VectorTileWorkerSource,geojson:Ms},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(B,G)=>{if(this.workerSourceTypes[B])throw new Error(`Worker source with name "${B}" already registered.`);this.workerSourceTypes[B]=G},this.self.registerRTLTextPlugin=B=>{if(a.plugin.isParsed())throw new Error("RTL text plugin already registered.");a.plugin.applyArabicShaping=B.applyArabicShaping,a.plugin.processBidirectionalText=B.processBidirectionalText,a.plugin.processStyledBidirectionalText=B.processStyledBidirectionalText}}clearCaches(D,B,G){delete this.layerIndexes[D],delete this.availableImages[D],delete this.workerSources[D],delete this.demWorkerSources[D],G()}checkIfReady(D,B,G){G()}setReferrer(D,B){this.referrer=B}spriteLoaded(D,B){this.isSpriteLoaded[D]=B;for(const G in this.workerSources[D]){const X=this.workerSources[D][G];for(const re in X)X[re]instanceof a.VectorTileWorkerSource&&(X[re].isSpriteLoaded=B,X[re].fire(new a.Event("isSpriteLoaded")))}}setImages(D,B,G){this.availableImages[D]=B;for(const X in this.workerSources[D]){const re=this.workerSources[D][X];for(const ce in re)re[ce].availableImages=B}G()}enableTerrain(D,B,G){this.terrain=B,G()}setProjection(D,B){this.projections[D]=a.getProjection(B)}setLayers(D,B,G){this.getLayerIndex(D).replace(B),G()}updateLayers(D,B,G){this.getLayerIndex(D).update(B.layers,B.removedIds),G()}loadTile(D,B,G){const X=this.enableTerrain?a.extend({enableTerrain:this.terrain},B):B;X.projection=this.projections[D]||this.defaultProjection,this.getWorkerSource(D,B.type,B.source).loadTile(X,G)}loadDEMTile(D,B,G){const X=this.enableTerrain?a.extend({buildQuadTree:this.terrain},B):B;this.getDEMWorkerSource(D,B.source).loadTile(X,G)}reloadTile(D,B,G){const X=this.enableTerrain?a.extend({enableTerrain:this.terrain},B):B;X.projection=this.projections[D]||this.defaultProjection,this.getWorkerSource(D,B.type,B.source).reloadTile(X,G)}abortTile(D,B,G){this.getWorkerSource(D,B.type,B.source).abortTile(B,G)}removeTile(D,B,G){this.getWorkerSource(D,B.type,B.source).removeTile(B,G)}removeSource(D,B,G){if(!this.workerSources[D]||!this.workerSources[D][B.type]||!this.workerSources[D][B.type][B.source])return;const X=this.workerSources[D][B.type][B.source];delete this.workerSources[D][B.type][B.source],X.removeSource!==void 0?X.removeSource(B,G):G()}loadWorkerSource(D,B,G){try{this.self.importScripts(B.url),G()}catch(X){G(X.toString())}}syncRTLPluginState(D,B,G){try{a.plugin.setState(B);const X=a.plugin.getPluginURL();if(a.plugin.isLoaded()&&!a.plugin.isParsed()&&X!=null){this.self.importScripts(X);const re=a.plugin.isParsed();G(re?void 0:new Error(`RTL Text Plugin failed to import scripts from ${X}`),re)}}catch(X){G(X.toString())}}getAvailableImages(D){let B=this.availableImages[D];return B||(B=[]),B}getLayerIndex(D){let B=this.layerIndexes[D];return B||(B=this.layerIndexes[D]=new ge),B}getWorkerSource(D,B,G){return this.workerSources[D]||(this.workerSources[D]={}),this.workerSources[D][B]||(this.workerSources[D][B]={}),this.workerSources[D][B][G]||(this.workerSources[D][B][G]=new this.workerSourceTypes[B]({send:(X,re,ce,he,se,pe)=>{this.actor.send(X,re,ce,D,se,pe)},scheduler:this.actor.scheduler},this.getLayerIndex(D),this.getAvailableImages(D),this.isSpriteLoaded[D])),this.workerSources[D][B][G]}getDEMWorkerSource(D,B){return this.demWorkerSources[D]||(this.demWorkerSources[D]={}),this.demWorkerSources[D][B]||(this.demWorkerSources[D][B]=new ze),this.demWorkerSources[D][B]}enforceCacheSizeLimit(D,B){a.enforceCacheSizeLimit(B)}getWorkerPerformanceMetrics(D,B,G){G(void 0,void 0)}}return typeof WorkerGlobalScope!="undefined"&&typeof self!="undefined"&&self instanceof WorkerGlobalScope&&(self.worker=new ur(self)),ur}),S(["./shared"],function(a){var W=ie;function ie(d){return!function(i){return typeof window=="undefined"||typeof document=="undefined"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var p,_,y=new Blob([""],{type:"text/javascript"}),b=URL.createObjectURL(y);try{_=new Worker(b),p=!0}catch{p=!1}return _&&_.terminate(),URL.revokeObjectURL(b),p}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var p=document.createElement("canvas");p.width=p.height=1;var _=p.getContext("2d");if(!_)return!1;var y=_.getImageData(0,0,1,1);return y&&y.width===p.width}()?(ge[l=i&&i.failIfMajorPerformanceCaveat]===void 0&&(ge[l]=function(p){var _,y=function(b){var T=document.createElement("canvas"),C=Object.create(ie.webGLContextAttributes);return C.failIfMajorPerformanceCaveat=b,T.getContext("webgl",C)||T.getContext("experimental-webgl",C)}(p);if(!y)return!1;try{_=y.createShader(y.VERTEX_SHADER)}catch{return!1}return!(!_||y.isContextLost())&&(y.shaderSource(_,"void main() {}"),y.compileShader(_),y.getShaderParameter(_,y.COMPILE_STATUS)===!0)}(l)),ge[l]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var l}(d)}var ge={};function ue(d,i){var l=i[0],p=i[1],_=i[2],y=i[3],b=l*y-_*p;return b?(d[0]=y*(b=1/b),d[1]=-p*b,d[2]=-_*b,d[3]=l*b,d):null}function ze(d,i){if(Array.isArray(d)){if(!Array.isArray(i)||d.length!==i.length)return!1;for(let l=0;l<d.length;l++)if(!ze(d[l],i[l]))return!1;return!0}if(typeof d=="object"&&d!==null&&i!==null){if(typeof i!="object"||Object.keys(d).length!==Object.keys(i).length)return!1;for(const l in d)if(!ze(d[l],i[l]))return!1;return!0}return d===i}ie.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const fe={create:function(d,i,l){const p=a.window.document.createElement(d);return i!==void 0&&(p.className=i),l&&l.appendChild(p),p},createSVG:function(d,i,l){const p=a.window.document.createElementNS("http://www.w3.org/2000/svg",d);for(const _ of Object.keys(i))p.setAttributeNS(null,_,i[_]);return l&&l.appendChild(p),p}},it=a.window.document&&a.window.document.documentElement.style,dt=it&&it.userSelect!==void 0?"userSelect":"WebkitUserSelect";let pi;fe.disableDrag=function(){it&&dt&&(pi=it[dt],it[dt]="none")},fe.enableDrag=function(){it&&dt&&(it[dt]=pi)};const ti=function(d){d.preventDefault(),d.stopPropagation(),a.window.removeEventListener("click",ti,!0)};function $i(d,i,l){const p=d.offsetWidth===i.width?1:d.offsetWidth/i.width;return new a.pointGeometry((l.clientX-i.left)*p,(l.clientY-i.top)*p)}function Gi(d){const{userImage:i}=d;return!!(i&&i.render&&i.render())&&(d.data.replace(new Uint8Array(i.data.buffer)),!0)}fe.suppressClick=function(){a.window.addEventListener("click",ti,!0),a.window.setTimeout(()=>{a.window.removeEventListener("click",ti,!0)},0)},fe.mousePos=function(d,i){const l=d.getBoundingClientRect();return $i(d,l,i)},fe.touchPos=function(d,i){const l=d.getBoundingClientRect(),p=[];for(let _=0;_<i.length;_++)p.push($i(d,l,i[_]));return p},fe.mouseButton=function(d){return a.window.InstallTrigger!==void 0&&d.button===2&&d.ctrlKey&&a.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:d.button};class Ti extends a.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new a.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(i){if(this.loaded!==i&&(this.loaded=i,i)){for(const{ids:l,callback:p}of this.requestors)this._notify(l,p);this.requestors=[]}}getImage(i){return this.images[i]}addImage(i,l){this._validate(i,l)&&(this.images[i]=l)}_validate(i,l){let p=!0;return this._validateStretch(l.stretchX,l.data&&l.data.width)||(this.fire(new a.ErrorEvent(new Error(`Image "${i}" has invalid "stretchX" value`))),p=!1),this._validateStretch(l.stretchY,l.data&&l.data.height)||(this.fire(new a.ErrorEvent(new Error(`Image "${i}" has invalid "stretchY" value`))),p=!1),this._validateContent(l.content,l)||(this.fire(new a.ErrorEvent(new Error(`Image "${i}" has invalid "content" value`))),p=!1),p}_validateStretch(i,l){if(!i)return!0;let p=0;for(const _ of i){if(_[0]<p||_[1]<_[0]||l<_[1])return!1;p=_[1]}return!0}_validateContent(i,l){return!(i&&(i.length!==4||i[0]<0||l.data.width<i[0]||i[1]<0||l.data.height<i[1]||i[2]<0||l.data.width<i[2]||i[3]<0||l.data.height<i[3]||i[2]<i[0]||i[3]<i[1]))}updateImage(i,l){l.version=this.images[i].version+1,this.images[i]=l,this.updatedImages[i]=!0}removeImage(i){const l=this.images[i];delete this.images[i],delete this.patterns[i],l.userImage&&l.userImage.onRemove&&l.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(i,l){let p=!0;if(!this.isLoaded())for(const _ of i)this.images[_]||(p=!1);this.isLoaded()||p?this._notify(i,l):this.requestors.push({ids:i,callback:l})}_notify(i,l){const p={};for(const _ of i){this.images[_]||this.fire(new a.Event("styleimagemissing",{id:_}));const y=this.images[_];y?p[_]={data:y.data.clone(),pixelRatio:y.pixelRatio,sdf:y.sdf,version:y.version,stretchX:y.stretchX,stretchY:y.stretchY,content:y.content,hasRenderCallback:Boolean(y.userImage&&y.userImage.render)}:a.warnOnce(`Image "${_}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}l(null,p)}getPixelSize(){const{width:i,height:l}=this.atlasImage;return{width:i,height:l}}getPattern(i){const l=this.patterns[i],p=this.getImage(i);if(!p)return null;if(l&&l.position.version===p.version)return l.position;if(l)l.position.version=p.version;else{const _={w:p.data.width+2,h:p.data.height+2,x:0,y:0},y=new a.ImagePosition(_,p);this.patterns[i]={bin:_,position:y}}return this._updatePatternAtlas(),this.patterns[i].position}bind(i){const l=i.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new a.Texture(i,this.atlasImage,l.RGBA),this.atlasTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE)}_updatePatternAtlas(){const i=[];for(const y in this.patterns)i.push(this.patterns[y].bin);const{w:l,h:p}=a.potpack(i),_=this.atlasImage;_.resize({width:l||1,height:p||1});for(const y in this.patterns){const{bin:b}=this.patterns[y],T=b.x+1,C=b.y+1,M=this.images[y].data,k=M.width,P=M.height;a.RGBAImage.copy(M,_,{x:0,y:0},{x:T,y:C},{width:k,height:P}),a.RGBAImage.copy(M,_,{x:0,y:P-1},{x:T,y:C-1},{width:k,height:1}),a.RGBAImage.copy(M,_,{x:0,y:0},{x:T,y:C+P},{width:k,height:1}),a.RGBAImage.copy(M,_,{x:k-1,y:0},{x:T-1,y:C},{width:1,height:P}),a.RGBAImage.copy(M,_,{x:0,y:0},{x:T+k,y:C},{width:1,height:P})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(i){for(const l of i){if(this.callbackDispatchedThisFrame[l])continue;this.callbackDispatchedThisFrame[l]=!0;const p=this.images[l];Gi(p)&&this.updateImage(l,p)}}}const cn=new a.Properties({anchor:new a.DataConstantProperty(a.spec.light.anchor),position:new class{constructor(){this.specification=a.spec.light.position}possiblyEvaluate(d,i){return function([l,p,_]){const y=a.degToRad(p+90),b=a.degToRad(_);return{x:l*Math.cos(y)*Math.sin(b),y:l*Math.sin(y)*Math.sin(b),z:l*Math.cos(b),azimuthal:p,polar:_}}(d.expression.evaluate(i))}interpolate(d,i,l){return{x:a.number(d.x,i.x,l),y:a.number(d.y,i.y,l),z:a.number(d.z,i.z,l),azimuthal:a.number(d.azimuthal,i.azimuthal,l),polar:a.number(d.polar,i.polar,l)}}},color:new a.DataConstantProperty(a.spec.light.color),intensity:new a.DataConstantProperty(a.spec.light.intensity)}),br="-transition";class Xr extends a.Evented{constructor(i){super(),this._transitionable=new a.Transitionable(cn),this.setLight(i),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(i,l={}){if(!this._validate(a.validateLight,i,l))for(const p in i){const _=i[p];a.endsWith(p,br)?this._transitionable.setTransition(p.slice(0,-br.length),_):this._transitionable.setValue(p,_)}}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}_validate(i,l,p){return(!p||p.validate!==!1)&&a.emitValidationErrors(this,i.call(a.validateStyle,a.extend({value:l,style:{glyphs:!0,sprite:!0},styleSpec:a.spec})))}}const lo=new a.Properties({source:new a.DataConstantProperty(a.spec.terrain.source),exaggeration:new a.DataConstantProperty(a.spec.terrain.exaggeration)}),Kn="-transition";class _a extends a.Evented{constructor(i,l){super(),this._transitionable=new a.Transitionable(lo),this.set(i),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=l}get(){return this._transitionable.serialize()}set(i){for(const l in i){const p=i[l];a.endsWith(l,Kn)?this._transitionable.setTransition(l.slice(0,-Kn.length),p):this._transitionable.setValue(l,p)}}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}}function hn(d,i,l,p){const _=a.smoothstep(45,65,l),[y,b]=co(d,p),T=a.length(i);let C=1-Math.min(1,Math.exp((T-y)/(b-y)*-6));return C*=C*C,C=Math.min(1,1.00747*C),C*_*d.alpha}function co(d,i){const l=.5/Math.tan(.5*i);return[d.range[0]+l,d.range[1]+l]}const gs=new a.Properties({range:new a.DataConstantProperty(a.spec.fog.range),color:new a.DataConstantProperty(a.spec.fog.color),"horizon-blend":new a.DataConstantProperty(a.spec.fog["horizon-blend"])}),ys="-transition";class Zl extends a.Evented{constructor(i,l){super(),this._transitionable=new a.Transitionable(gs),this.set(i),this._transitioning=this._transitionable.untransitioned(),this._transform=l}get state(){return{range:this.properties.get("range"),horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(i,l={}){if(!this._validate(a.validateFog,i,l))for(const p in i){const _=i[p];a.endsWith(p,ys)?this._transitionable.setTransition(p.slice(0,-ys.length),_):this._transitionable.setValue(p,_)}}getOpacity(i){if(!this._transform.projection.supportsFog)return 0;const l=this.properties&&this.properties.get("color")||1;return a.smoothstep(45,65,i)*l.a}getOpacityAtLatLng(i,l){return this._transform.projection.supportsFog?function(p,_,y){const b=a.MercatorCoordinate.fromLngLat(_),T=y.elevation?y.elevation.getAtPointOrZero(b):0,C=[b.x,b.y,T];return a.transformMat4(C,C,y.mercatorFogMatrix),hn(p,C,y.pitch,y._fov)}(this.state,i,l):0}getFovAdjustedRange(i){return this._transform.projection.supportsFog?co(this.state,i):[0,1]}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}_validate(i,l,p){return(!p||p.validate!==!1)&&a.emitValidationErrors(this,i.call(a.validateStyle,a.extend({value:l,style:{glyphs:!0,sprite:!0},styleSpec:a.spec})))}}class Hr{constructor(i,l){this.workerPool=i,this.actors=[],this.currentActor=0,this.id=a.uniqueId();const p=this.workerPool.acquire(this.id);for(let _=0;_<p.length;_++){const y=new Hr.Actor(p[_],l,this.id);y.name=`Worker ${_}`,this.actors.push(y)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(i,l,p){a.asyncAll(this.actors,(_,y)=>{_.send(i,l,y)},p=p||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(i=>{i.remove()}),this.actors=[],this.workerPool.release(this.id)}}function wr(d,i,l){return i*(a.EXTENT/(d.tileSize*Math.pow(2,l-d.tileID.overscaledZ)))}Hr.Actor=a.Actor;class xs{constructor(i,l,p){this.context=i;const _=i.gl;this.buffer=_.createBuffer(),this.dynamicDraw=Boolean(p),this.context.unbindVAO(),i.bindElementBuffer.set(this.buffer),_.bufferData(_.ELEMENT_ARRAY_BUFFER,l.arrayBuffer,this.dynamicDraw?_.DYNAMIC_DRAW:_.STATIC_DRAW),this.dynamicDraw||delete l.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(i){const l=this.context.gl;this.context.unbindVAO(),this.bind(),l.bufferSubData(l.ELEMENT_ARRAY_BUFFER,0,i.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Kr={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class vs{constructor(i,l,p,_){this.length=l.length,this.attributes=p,this.itemSize=l.bytesPerElement,this.dynamicDraw=_,this.context=i;const y=i.gl;this.buffer=y.createBuffer(),i.bindVertexBuffer.set(this.buffer),y.bufferData(y.ARRAY_BUFFER,l.arrayBuffer,this.dynamicDraw?y.DYNAMIC_DRAW:y.STATIC_DRAW),this.dynamicDraw||delete l.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(i){const l=this.context.gl;this.bind(),l.bufferSubData(l.ARRAY_BUFFER,0,i.arrayBuffer)}enableAttributes(i,l){for(let p=0;p<this.attributes.length;p++){const _=l.attributes[this.attributes[p].name];_!==void 0&&i.enableVertexAttribArray(_)}}setVertexAttribPointers(i,l,p){for(let _=0;_<this.attributes.length;_++){const y=this.attributes[_],b=l.attributes[y.name];b!==void 0&&i.vertexAttribPointer(b,y.components,i[Kr[y.type]],!1,this.itemSize,y.offset+this.itemSize*(p||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Tt{constructor(i){this.gl=i.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(i){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ga extends Tt{getDefault(){return a.Color.transparent}set(i){const l=this.current;(i.r!==l.r||i.g!==l.g||i.b!==l.b||i.a!==l.a||this.dirty)&&(this.gl.clearColor(i.r,i.g,i.b,i.a),this.current=i,this.dirty=!1)}}class Yn extends Tt{getDefault(){return 1}set(i){(i!==this.current||this.dirty)&&(this.gl.clearDepth(i),this.current=i,this.dirty=!1)}}class Jn extends Tt{getDefault(){return 0}set(i){(i!==this.current||this.dirty)&&(this.gl.clearStencil(i),this.current=i,this.dirty=!1)}}class Wl extends Tt{getDefault(){return[!0,!0,!0,!0]}set(i){const l=this.current;(i[0]!==l[0]||i[1]!==l[1]||i[2]!==l[2]||i[3]!==l[3]||this.dirty)&&(this.gl.colorMask(i[0],i[1],i[2],i[3]),this.current=i,this.dirty=!1)}}class bs extends Tt{getDefault(){return!0}set(i){(i!==this.current||this.dirty)&&(this.gl.depthMask(i),this.current=i,this.dirty=!1)}}class Yr extends Tt{getDefault(){return 255}set(i){(i!==this.current||this.dirty)&&(this.gl.stencilMask(i),this.current=i,this.dirty=!1)}}class ho extends Tt{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(i){const l=this.current;(i.func!==l.func||i.ref!==l.ref||i.mask!==l.mask||this.dirty)&&(this.gl.stencilFunc(i.func,i.ref,i.mask),this.current=i,this.dirty=!1)}}class ya extends Tt{getDefault(){const i=this.gl;return[i.KEEP,i.KEEP,i.KEEP]}set(i){const l=this.current;(i[0]!==l[0]||i[1]!==l[1]||i[2]!==l[2]||this.dirty)&&(this.gl.stencilOp(i[0],i[1],i[2]),this.current=i,this.dirty=!1)}}class xa extends Tt{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;i?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),this.current=i,this.dirty=!1}}class uo extends Tt{getDefault(){return[0,1]}set(i){const l=this.current;(i[0]!==l[0]||i[1]!==l[1]||this.dirty)&&(this.gl.depthRange(i[0],i[1]),this.current=i,this.dirty=!1)}}class va extends Tt{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;i?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),this.current=i,this.dirty=!1}}class ws extends Tt{getDefault(){return this.gl.LESS}set(i){(i!==this.current||this.dirty)&&(this.gl.depthFunc(i),this.current=i,this.dirty=!1)}}class gt extends Tt{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;i?l.enable(l.BLEND):l.disable(l.BLEND),this.current=i,this.dirty=!1}}class hr extends Tt{getDefault(){const i=this.gl;return[i.ONE,i.ZERO]}set(i){const l=this.current;(i[0]!==l[0]||i[1]!==l[1]||this.dirty)&&(this.gl.blendFunc(i[0],i[1]),this.current=i,this.dirty=!1)}}class Qn extends Tt{getDefault(){return a.Color.transparent}set(i){const l=this.current;(i.r!==l.r||i.g!==l.g||i.b!==l.b||i.a!==l.a||this.dirty)&&(this.gl.blendColor(i.r,i.g,i.b,i.a),this.current=i,this.dirty=!1)}}class po extends Tt{getDefault(){return this.gl.FUNC_ADD}set(i){(i!==this.current||this.dirty)&&(this.gl.blendEquation(i),this.current=i,this.dirty=!1)}}class fo extends Tt{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;i?l.enable(l.CULL_FACE):l.disable(l.CULL_FACE),this.current=i,this.dirty=!1}}class mo extends Tt{getDefault(){return this.gl.BACK}set(i){(i!==this.current||this.dirty)&&(this.gl.cullFace(i),this.current=i,this.dirty=!1)}}class Ft extends Tt{getDefault(){return this.gl.CCW}set(i){(i!==this.current||this.dirty)&&(this.gl.frontFace(i),this.current=i,this.dirty=!1)}}class In extends Tt{getDefault(){return null}set(i){(i!==this.current||this.dirty)&&(this.gl.useProgram(i),this.current=i,this.dirty=!1)}}class un extends Tt{getDefault(){return this.gl.TEXTURE0}set(i){(i!==this.current||this.dirty)&&(this.gl.activeTexture(i),this.current=i,this.dirty=!1)}}class es extends Tt{getDefault(){const i=this.gl;return[0,0,i.drawingBufferWidth,i.drawingBufferHeight]}set(i){const l=this.current;(i[0]!==l[0]||i[1]!==l[1]||i[2]!==l[2]||i[3]!==l[3]||this.dirty)&&(this.gl.viewport(i[0],i[1],i[2],i[3]),this.current=i,this.dirty=!1)}}class Ts extends Tt{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.bindFramebuffer(l.FRAMEBUFFER,i),this.current=i,this.dirty=!1}}class si extends Tt{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.bindRenderbuffer(l.RENDERBUFFER,i),this.current=i,this.dirty=!1}}class _o extends Tt{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.bindTexture(l.TEXTURE_2D,i),this.current=i,this.dirty=!1}}class go extends Tt{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.bindBuffer(l.ARRAY_BUFFER,i),this.current=i,this.dirty=!1}}class yo extends Tt{getDefault(){return null}set(i){const l=this.gl;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,i),this.current=i,this.dirty=!1}}class Tr extends Tt{constructor(i){super(i),this.vao=i.extVertexArrayObject}getDefault(){return null}set(i){this.vao&&(i!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(i),this.current=i,this.dirty=!1)}}class ba extends Tt{getDefault(){return 4}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_ALIGNMENT,i),this.current=i,this.dirty=!1}}class Es extends Tt{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i),this.current=i,this.dirty=!1}}class Ss extends Tt{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,i),this.current=i,this.dirty=!1}}class An extends Tt{constructor(i,l){super(i),this.context=i,this.parent=l}getDefault(){return null}}class Is extends An{setDirty(){this.dirty=!0}set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,i,0),this.current=i,this.dirty=!1}}class Er extends An{attachment(){return this.gl.DEPTH_ATTACHMENT}set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferRenderbuffer(l.FRAMEBUFFER,this.attachment(),l.RENDERBUFFER,i),this.current=i,this.dirty=!1}}class wa extends Er{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class ii{constructor(i,l,p,_){this.context=i,this.width=l,this.height=p;const y=this.framebuffer=i.gl.createFramebuffer();this.colorAttachment=new Is(i,y),_&&(this.depthAttachment=new Er(i,y))}destroy(){const i=this.context.gl,l=this.colorAttachment.get();if(l&&i.deleteTexture(l),this.depthAttachment){const p=this.depthAttachment.get();p&&i.deleteRenderbuffer(p)}i.deleteFramebuffer(this.framebuffer)}}class Sr{constructor(i){this.gl=i,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new ga(this),this.clearDepth=new Yn(this),this.clearStencil=new Jn(this),this.colorMask=new Wl(this),this.depthMask=new bs(this),this.stencilMask=new Yr(this),this.stencilFunc=new ho(this),this.stencilOp=new ya(this),this.stencilTest=new xa(this),this.depthRange=new uo(this),this.depthTest=new va(this),this.depthFunc=new ws(this),this.blend=new gt(this),this.blendFunc=new hr(this),this.blendColor=new Qn(this),this.blendEquation=new po(this),this.cullFace=new fo(this),this.cullFaceSide=new mo(this),this.frontFace=new Ft(this),this.program=new In(this),this.activeTexture=new un(this),this.viewport=new es(this),this.bindFramebuffer=new Ts(this),this.bindRenderbuffer=new si(this),this.bindTexture=new _o(this),this.bindVertexBuffer=new go(this),this.bindElementBuffer=new yo(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new Tr(this),this.pixelStoreUnpack=new ba(this),this.pixelStoreUnpackPremultiplyAlpha=new Es(this),this.pixelStoreUnpackFlipY=new Ss(this),this.extTextureFilterAnisotropic=i.getExtension("EXT_texture_filter_anisotropic")||i.getExtension("MOZ_EXT_texture_filter_anisotropic")||i.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=i.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extTextureHalfFloat=i.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(i.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=i.getExtension("EXT_color_buffer_half_float")),this.extTimerQuery=i.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(i,l){return new xs(this,i,l)}createVertexBuffer(i,l,p){return new vs(this,i,l,p)}createRenderbuffer(i,l,p){const _=this.gl,y=_.createRenderbuffer();return this.bindRenderbuffer.set(y),_.renderbufferStorage(_.RENDERBUFFER,i,l,p),this.bindRenderbuffer.set(null),y}createFramebuffer(i,l,p){return new ii(this,i,l,p)}clear({color:i,depth:l,stencil:p}){const _=this.gl;let y=0;i&&(y|=_.COLOR_BUFFER_BIT,this.clearColor.set(i),this.colorMask.set([!0,!0,!0,!0])),l!==void 0&&(y|=_.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(l),this.depthMask.set(!0)),p!==void 0&&(y|=_.STENCIL_BUFFER_BIT,this.clearStencil.set(p),this.stencilMask.set(255)),_.clear(y)}setCullFace(i){i.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(i.mode),this.frontFace.set(i.frontFace))}setDepthMode(i){i.func!==this.gl.ALWAYS||i.mask?(this.depthTest.set(!0),this.depthFunc.set(i.func),this.depthMask.set(i.mask),this.depthRange.set(i.range)):this.depthTest.set(!1)}setStencilMode(i){i.test.func!==this.gl.ALWAYS||i.mask?(this.stencilTest.set(!0),this.stencilMask.set(i.mask),this.stencilOp.set([i.fail,i.depthFail,i.pass]),this.stencilFunc.set({func:i.test.func,ref:i.ref,mask:i.test.mask})):this.stencilTest.set(!1)}setColorMode(i){ze(i.blendFunction,a.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(i.blendFunction),this.blendColor.set(i.blendColor)),this.colorMask.set(i.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class As{constructor(i,l,p,_){this.screenBounds=i,this.cameraPoint=l,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=p,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this.screenGeometry.map(y=>_.pointCoordinate3D(y)),this.cameraGeometry=this.bufferedCameraGeometry(0)}static createFromScreenPoints(i,l){let p,_;if(i instanceof a.pointGeometry||typeof i[0]=="number"){const y=a.pointGeometry.convert(i);p=[a.pointGeometry.convert(i)],_=l.isPointAboveHorizon(y)}else{const y=a.pointGeometry.convert(i[0]),b=a.pointGeometry.convert(i[1]);p=[y,b],_=a.polygonizeBounds(y,b).every(T=>l.isPointAboveHorizon(T))}return new As(p,l.getCameraPoint(),_,l)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(i){return a.polygonizeBounds(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],i)}bufferedCameraGeometry(i){const l=this.screenBounds[0],p=this.screenBounds.length===1?this.screenBounds[0].add(new a.pointGeometry(1,1)):this.screenBounds[1],_=a.polygonizeBounds(l,p,0,!1);return this.cameraPoint.y>p.y&&(this.cameraPoint.x>l.x&&this.cameraPoint.x<p.x?_.splice(3,0,this.cameraPoint):this.cameraPoint.x>=p.x?_[2]=this.cameraPoint:this.cameraPoint.x<=l.x&&(_[3]=this.cameraPoint)),a.bufferConvexPolygon(_,i)}containsTile(i,l,p){const _=i.queryPadding+1,y=i.tileID.wrap,b=p?this._bufferedCameraMercator(_,l).map(N=>a.getTilePoint(i.tileTransform,N,y)):this._bufferedScreenMercator(_,l).map(N=>a.getTilePoint(i.tileTransform,N,y)),T=this.screenGeometryMercator.map(N=>a.getTileVec3(i.tileTransform,N,y)),C=T.map(N=>new a.pointGeometry(N[0],N[1])),M=l.getFreeCameraOptions().position||new a.MercatorCoordinate(0,0,0),k=a.getTileVec3(i.tileTransform,M,y),P=T.map(N=>{const $=a.sub(N,N,k);return a.normalize($,$),new a.Ray(k,$)}),F=wr(i,1,l.zoom);if(a.polygonIntersectsBox(b,0,0,a.EXTENT,a.EXTENT))return{queryGeometry:this,tilespaceGeometry:C,tilespaceRays:P,bufferedTilespaceGeometry:b,bufferedTilespaceBounds:(j=a.getBounds(b),j.min.x=a.clamp(j.min.x,0,a.EXTENT),j.min.y=a.clamp(j.min.y,0,a.EXTENT),j.max.x=a.clamp(j.max.x,0,a.EXTENT),j.max.y=a.clamp(j.max.y,0,a.EXTENT),j),tile:i,tileID:i.tileID,pixelToTileUnitsFactor:F};var j}_bufferedScreenMercator(i,l){const p=Jr(i);if(this._screenRaycastCache[p])return this._screenRaycastCache[p];{const _=this.bufferedScreenGeometry(i).map(y=>l.pointCoordinate3D(y));return this._screenRaycastCache[p]=_,_}}_bufferedCameraMercator(i,l){const p=Jr(i);if(this._cameraRaycastCache[p])return this._cameraRaycastCache[p];{const _=this.bufferedCameraGeometry(i).map(y=>l.pointCoordinate3D(y));return this._cameraRaycastCache[p]=_,_}}}function Jr(d){return 100*d|0}function Cs(d,i,l){const p=function(_,y){if(_)return l(_);if(y){const b=a.pick(a.extend(y,d),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);y.vector_layers&&(b.vectorLayers=y.vector_layers,b.vectorLayerIds=b.vectorLayers.map(T=>T.id)),b.tiles=i.canonicalizeTileset(b,d.url),l(null,b)}};return d.url?a.getJSON(i.transformRequest(i.normalizeSourceURL(d.url),a.ResourceType.Source),p):a.exported.frame(()=>p(null,d))}class ts{constructor(i,l,p){this.bounds=a.LngLatBounds.convert(this.validateBounds(i)),this.minzoom=l||0,this.maxzoom=p||24}validateBounds(i){return Array.isArray(i)&&i.length===4?[Math.max(-180,i[0]),Math.max(-90,i[1]),Math.min(180,i[2]),Math.min(90,i[3])]:[-180,-90,180,90]}contains(i){const l=Math.pow(2,i.z),p=Math.floor(a.mercatorXfromLng(this.bounds.getWest())*l),_=Math.floor(a.mercatorYfromLat(this.bounds.getNorth())*l),y=Math.ceil(a.mercatorXfromLng(this.bounds.getEast())*l),b=Math.ceil(a.mercatorYfromLat(this.bounds.getSouth())*l);return i.x>=p&&i.x<y&&i.y>=_&&i.y<b}}class dn extends a.Evented{constructor(i,l,p,_){super(),this.id=i,this.dispatcher=p,this.setEventedParent(_),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=a.extend({type:"raster"},l),a.extend(this,a.pick(l,["url","scheme","tileSize"]))}load(){this._loaded=!1,this.fire(new a.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=Cs(this._options,this.map._requestManager,(i,l)=>{this._tileJSONRequest=null,this._loaded=!0,i?this.fire(new a.ErrorEvent(i)):l&&(a.extend(this,l),l.bounds&&(this.tileBounds=new ts(l.bounds,this.minzoom,this.maxzoom)),a.postTurnstileEvent(l.tiles),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}onAdd(i){this.map=i,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return a.extend({},this._options)}hasTile(i){return!this.tileBounds||this.tileBounds.contains(i.canonical)}loadTile(i,l){const p=a.exported.devicePixelRatio>=2,_=this.map._requestManager.normalizeTileURL(i.tileID.canonical.url(this.tiles,this.scheme),p,this.tileSize);i.request=a.getImage(this.map._requestManager.transformRequest(_,a.ResourceType.Tile),(y,b,T,C)=>{if(delete i.request,i.aborted)i.state="unloaded",l(null);else if(y)i.state="errored",l(y);else if(b){this.map._refreshExpiredTiles&&i.setExpiryData({cacheControl:T,expires:C});const M=this.map.painter.context,k=M.gl;i.texture=this.map.painter.getTileTexture(b.width),i.texture?i.texture.update(b,{useMipmap:!0}):(i.texture=new a.Texture(M,b,k.RGBA,{useMipmap:!0}),i.texture.bind(k.LINEAR,k.CLAMP_TO_EDGE),M.extTextureFilterAnisotropic&&k.texParameterf(k.TEXTURE_2D,M.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,M.extTextureFilterAnisotropicMax)),i.state="loaded",a.cacheEntryPossiblyAdded(this.dispatcher),l(null)}})}abortTile(i,l){i.request&&(i.request.cancel(),delete i.request),l()}unloadTile(i,l){i.texture&&this.map.painter.saveTileTexture(i.texture),l()}hasTransition(){return!1}}let Fr;function Cn(d,i,l,p,_,y,b,T){const C=[d,l,_,i,p,y,1,1,1],M=[b,T,1],k=a.adjoint([],C),[P,F,j]=a.transformMat3(M,M,a.transpose(k,k));return a.multiply(C,[P,0,0,0,F,0,0,0,j],C)}class Or extends a.Evented{constructor(i,l,p,_){super(),this.id=i,this.dispatcher=p,this.coordinates=l.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(_),this.options=l}load(i,l){this._loaded=!1,this.fire(new a.Event("dataloading",{dataType:"source"})),this.url=this.options.url,a.getImage(this.map._requestManager.transformRequest(this.url,a.ResourceType.Image),(p,_)=>{this._loaded=!0,p?this.fire(new a.ErrorEvent(p)):_&&(this.image=a.exported.getImageData(_),this.width=this.image.width,this.height=this.image.height,i&&(this.coordinates=i),l&&l(),this._finishLoading())})}loaded(){return this._loaded}updateImage(i){return this.image&&i.url?(this.options.url=i.url,this.load(i.coordinates,()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(i){this.map=i,this.load()}setCoordinates(i){this.coordinates=i,delete this._boundsArray;const l=i.map(a.MercatorCoordinate.fromLngLat);return this.tileID=function(p){let _=1/0,y=1/0,b=-1/0,T=-1/0;for(const P of p)_=Math.min(_,P.x),y=Math.min(y,P.y),b=Math.max(b,P.x),T=Math.max(T,P.y);const C=Math.max(b-_,T-y),M=Math.max(0,Math.floor(-Math.log(C)/Math.LN2)),k=Math.pow(2,M);return new a.CanonicalTileID(M,Math.floor((_+b)/2*k),Math.floor((y+T)/2*k))}(l),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){delete this._boundsArray}_makeBoundsArray(){const i=a.tileTransform(this.tileID,this.map.transform.projection),[l,p,_,y]=this.coordinates.map(b=>{const T=i.projection.project(b[0],b[1]);return a.getTilePoint(i,T)._round()});return this.perspectiveTransform=function(b,T,C,M,k,P,F,j,N,$){const ee=Cn(0,0,b,0,0,T,b,T),V=Cn(C,M,k,P,F,j,N,$);return a.multiply(V,a.adjoint(ee,ee),V),[V[6]/V[8]*b/a.EXTENT,V[7]/V[8]*T/a.EXTENT]}(this.width,this.height,l.x,l.y,p.x,p.y,y.x,y.y,_.x,_.y),this._boundsArray=new a.StructArrayLayout4i8,this._boundsArray.emplaceBack(l.x,l.y,0,0),this._boundsArray.emplaceBack(p.x,p.y,a.EXTENT,0),this._boundsArray.emplaceBack(y.x,y.y,0,a.EXTENT),this._boundsArray.emplaceBack(_.x,_.y,a.EXTENT,a.EXTENT),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const i=this.map.painter.context,l=i.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=i.createVertexBuffer(this._boundsArray,a.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=a.SegmentVector.simpleSegment(0,0,4,2)),this.texture||(this.texture=new a.Texture(i,this.image,l.RGBA),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE));for(const p in this.tiles){const _=this.tiles[p];_.state!=="loaded"&&(_.state="loaded",_.texture=this.texture)}}loadTile(i,l){this.tileID&&this.tileID.equals(i.tileID.canonical)?(this.tiles[String(i.tileID.wrap)]=i,i.buckets={},l(null)):(i.state="errored",l(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}const Ms={vector:class extends a.Evented{constructor(d,i,l,p){if(super(),this.id=d,this.dispatcher=l,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,a.extend(this,a.pick(i,["url","scheme","tileSize","promoteId"])),this._options=a.extend({type:"vector"},i),this._collectResourceTiming=i.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(p),this._tileWorkers={},this._deduped=new a.DedupedRequest}load(){this._loaded=!1,this.fire(new a.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=Cs(this._options,this.map._requestManager,(d,i)=>{this._tileJSONRequest=null,this._loaded=!0,d?this.fire(new a.ErrorEvent(d)):i&&(a.extend(this,i),i.bounds&&(this.tileBounds=new ts(i.bounds,this.minzoom,this.maxzoom)),a.postTurnstileEvent(i.tiles,this.map._requestManager._customAccessToken),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}hasTile(d){return!this.tileBounds||this.tileBounds.contains(d.canonical)}onAdd(d){this.map=d,this.load()}setSourceProperty(d){this._tileJSONRequest&&this._tileJSONRequest.cancel(),d();const i=this.map.style._getSourceCaches(this.id);for(const l of i)l.clearTiles();this.load()}setTiles(d){return this.setSourceProperty(()=>{this._options.tiles=d}),this}setUrl(d){return this.setSourceProperty(()=>{this.url=d,this._options.url=d}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return a.extend({},this._options)}loadTile(d,i){const l=this.map._requestManager.normalizeTileURL(d.tileID.canonical.url(this.tiles,this.scheme)),p={request:this.map._requestManager.transformRequest(l,a.ResourceType.Tile),data:void 0,uid:d.uid,tileID:d.tileID,tileZoom:d.tileZoom,zoom:d.tileID.overscaledZ,tileSize:this.tileSize*d.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:a.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:d.isSymbolTile};if(p.request.collectResourceTiming=this._collectResourceTiming,d.actor&&d.state!=="expired")d.state==="loading"?d.reloadCallback=i:d.request=d.actor.send("reloadTile",p,_.bind(this));else if(d.actor=this._tileWorkers[l]=this._tileWorkers[l]||this.dispatcher.getActor(),this.dispatcher.ready)d.request=d.actor.send("loadTile",p,_.bind(this),void 0,!0);else{const y=a.loadVectorTile.call({deduped:this._deduped},p,(b,T)=>{b||!T?_.call(this,b):(p.data={cacheControl:T.cacheControl,expires:T.expires,rawData:T.rawData.slice(0)},d.actor&&d.actor.send("loadTile",p,_.bind(this),void 0,!0))},!0);d.request={cancel:y}}function _(y,b){return delete d.request,d.aborted?i(null):y&&y.status!==404?i(y):(b&&b.resourceTiming&&(d.resourceTiming=b.resourceTiming),this.map._refreshExpiredTiles&&b&&d.setExpiryData(b),d.loadVectorData(b,this.map.painter),a.cacheEntryPossiblyAdded(this.dispatcher),i(null),void(d.reloadCallback&&(this.loadTile(d,d.reloadCallback),d.reloadCallback=null)))}}abortTile(d){d.request&&(d.request.cancel(),delete d.request),d.actor&&d.actor.send("abortTile",{uid:d.uid,type:this.type,source:this.id})}unloadTile(d){d.unloadVectorData(),d.actor&&d.actor.send("removeTile",{uid:d.uid,type:this.type,source:this.id})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}},raster:dn,"raster-dem":class extends dn{constructor(d,i,l,p){super(d,i,l,p),this.type="raster-dem",this.maxzoom=22,this._options=a.extend({type:"raster-dem"},i),this.encoding=i.encoding||"mapbox"}loadTile(d,i){const l=this.map._requestManager.normalizeTileURL(d.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function p(_,y){_&&(d.state="errored",i(_)),y&&(d.dem=y,d.dem.onDeserialize(),d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0,d.state="loaded",i(null))}d.request=a.getImage(this.map._requestManager.transformRequest(l,a.ResourceType.Tile),function(_,y,b,T){if(delete d.request,d.aborted)d.state="unloaded",i(null);else if(_)d.state="errored",i(_);else if(y){this.map._refreshExpiredTiles&&d.setExpiryData({cacheControl:b,expires:T});const C=a.window.ImageBitmap&&y instanceof a.window.ImageBitmap&&(Fr==null&&(Fr=a.window.OffscreenCanvas&&new a.window.OffscreenCanvas(1,1).getContext("2d")&&typeof a.window.createImageBitmap=="function"),Fr),M=1-(y.width-a.prevPowerOfTwo(y.width))/2;M<1||d.neighboringTiles||(d.neighboringTiles=this._getNeighboringTiles(d.tileID));const k=C?y:a.exported.getImageData(y,M),P={uid:d.uid,coord:d.tileID,source:this.id,rawImageData:k,encoding:this.encoding,padding:M};d.actor&&d.state!=="expired"||(d.actor=this.dispatcher.getActor(),d.actor.send("loadDEMTile",P,p.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(d){const i=d.canonical,l=Math.pow(2,i.z),p=(i.x-1+l)%l,_=i.x===0?d.wrap-1:d.wrap,y=(i.x+1+l)%l,b=i.x+1===l?d.wrap+1:d.wrap,T={};return T[new a.OverscaledTileID(d.overscaledZ,_,i.z,p,i.y).key]={backfilled:!1},T[new a.OverscaledTileID(d.overscaledZ,b,i.z,y,i.y).key]={backfilled:!1},i.y>0&&(T[new a.OverscaledTileID(d.overscaledZ,_,i.z,p,i.y-1).key]={backfilled:!1},T[new a.OverscaledTileID(d.overscaledZ,d.wrap,i.z,i.x,i.y-1).key]={backfilled:!1},T[new a.OverscaledTileID(d.overscaledZ,b,i.z,y,i.y-1).key]={backfilled:!1}),i.y+1<l&&(T[new a.OverscaledTileID(d.overscaledZ,_,i.z,p,i.y+1).key]={backfilled:!1},T[new a.OverscaledTileID(d.overscaledZ,d.wrap,i.z,i.x,i.y+1).key]={backfilled:!1},T[new a.OverscaledTileID(d.overscaledZ,b,i.z,y,i.y+1).key]={backfilled:!1}),T}unloadTile(d){d.demTexture&&this.map.painter.saveTileTexture(d.demTexture),d.fbo&&(d.fbo.destroy(),delete d.fbo),d.dem&&delete d.dem,delete d.neighboringTiles,d.state="unloaded"}},geojson:class extends a.Evented{constructor(d,i,l,p){super(),this.id=d,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=l.getActor(),this.setEventedParent(p),this._data=i.data,this._options=a.extend({},i),this._collectResourceTiming=i.collectResourceTiming,i.maxzoom!==void 0&&(this.maxzoom=i.maxzoom),i.type&&(this.type=i.type),i.attribution&&(this.attribution=i.attribution),this.promoteId=i.promoteId;const _=a.EXTENT/this.tileSize;this.workerOptions=a.extend({source:this.id,cluster:i.cluster||!1,geojsonVtOptions:{buffer:(i.buffer!==void 0?i.buffer:128)*_,tolerance:(i.tolerance!==void 0?i.tolerance:.375)*_,extent:a.EXTENT,maxZoom:this.maxzoom,lineMetrics:i.lineMetrics||!1,generateId:i.generateId||!1},superclusterOptions:{maxZoom:i.clusterMaxZoom!==void 0?i.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,i.clusterMinPoints||2),extent:a.EXTENT,radius:(i.clusterRadius!==void 0?i.clusterRadius:50)*_,log:!1,generateId:i.generateId||!1},clusterProperties:i.clusterProperties,filter:i.filter},i.workerOptions)}onAdd(d){this.map=d,this.setData(this._data)}setData(d){return this._data=d,this._updateWorkerData(),this}getClusterExpansionZoom(d,i){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:d,source:this.id},i),this}getClusterChildren(d,i){return this.actor.send("geojson.getClusterChildren",{clusterId:d,source:this.id},i),this}getClusterLeaves(d,i,l,p){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:d,limit:i,offset:l},p),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new a.Event("dataloading",{dataType:"source"})),this._loaded=!1;const d=a.extend({},this.workerOptions),i=this._data;typeof i=="string"?(d.request=this.map._requestManager.transformRequest(a.exported.resolveURL(i),a.ResourceType.Source),d.request.collectResourceTiming=this._collectResourceTiming):d.data=JSON.stringify(i),this._pendingLoad=this.actor.send(`${this.type}.loadData`,d,(l,p)=>{if(this._loaded=!0,this._pendingLoad=null,l)this.fire(new a.ErrorEvent(l));else{const _={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&p&&p.resourceTiming&&p.resourceTiming[this.id]&&(_.resourceTiming=p.resourceTiming[this.id]),this.fire(new a.Event("data",_)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(d,i){const l=d.actor?"reloadTile":"loadTile";d.actor=this.actor,d.request=this.actor.send(l,{type:this.type,uid:d.uid,tileID:d.tileID,tileZoom:d.tileZoom,zoom:d.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:a.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(p,_)=>(delete d.request,d.unloadVectorData(),d.aborted?i(null):p?i(p):(d.loadVectorData(_,this.map.painter,l==="reloadTile"),i(null))),void 0,l==="loadTile")}abortTile(d){d.request&&(d.request.cancel(),delete d.request),d.aborted=!0}unloadTile(d){d.unloadVectorData(),this.actor.send("removeTile",{uid:d.uid,type:this.type,source:this.id})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return a.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends Or{constructor(d,i,l,p){super(d,i,l,p),this.roundZoom=!0,this.type="video",this.options=i}load(){this._loaded=!1;const d=this.options;this.urls=[];for(const i of d.urls)this.urls.push(this.map._requestManager.transformRequest(i,a.ResourceType.Source).url);a.getVideo(this.urls,(i,l)=>{this._loaded=!0,i?this.fire(new a.ErrorEvent(i)):l&&(this.video=l,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(d){if(this.video){const i=this.video.seekable;d<i.start(0)||d>i.end(0)?this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${i.start(0)} and ${i.end(0)}-second mark.`))):this.video.currentTime=d}}getVideo(){return this.video}onAdd(d){this.map||(this.map=d,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const d=this.map.painter.context,i=d.gl;this.texture?this.video.paused||(this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGBA,i.UNSIGNED_BYTE,this.video)):(this.texture=new a.Texture(d,this.video,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=d.createVertexBuffer(this._boundsArray,a.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=a.SegmentVector.simpleSegment(0,0,4,2));for(const l in this.tiles){const p=this.tiles[l];p.state!=="loaded"&&(p.state="loaded",p.texture=this.texture)}}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:Or,canvas:class extends Or{constructor(d,i,l,p){super(d,i,l,p),i.coordinates?Array.isArray(i.coordinates)&&i.coordinates.length===4&&!i.coordinates.some(_=>!Array.isArray(_)||_.length!==2||_.some(y=>typeof y!="number"))||this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${d}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${d}`,null,'missing required property "coordinates"'))),i.animate&&typeof i.animate!="boolean"&&this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${d}`,null,'optional "animate" property must be a boolean value'))),i.canvas?typeof i.canvas=="string"||i.canvas instanceof a.window.HTMLCanvasElement||this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${d}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${d}`,null,'missing required property "canvas"'))),this.options=i,this.animate=i.animate===void 0||i.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof a.window.HTMLCanvasElement?this.options.canvas:a.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new a.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(d){this.map=d,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let d=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,d=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,d=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const i=this.map.painter.context,l=i.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=i.createVertexBuffer(this._boundsArray,a.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=a.SegmentVector.simpleSegment(0,0,4,2)),this.texture?(d||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new a.Texture(i,this.canvas,l.RGBA,{premultiply:!0});for(const p in this.tiles){const _=this.tiles[p];_.state!=="loaded"&&(_.state="loaded",_.texture=this.texture)}}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const d of[this.canvas.width,this.canvas.height])if(isNaN(d)||d<=0)return!0;return!1}}},ur=function(d,i,l,p){const _=new Ms[i.type](d,i,l,p);if(_.id!==d)throw new Error(`Expected Source id to be ${d} instead of ${_.id}`);return a.bindAll(["load","abort","unload","serialize","prepare"],_),_};function q(d,i){const l=a.identity([]);return a.scale(l,l,[.5*d.width,.5*-d.height,1]),a.translate(l,l,[1,-1,0]),a.multiply$1(l,l,d.calculateProjMatrix(i.toUnwrapped()))}function D(d,i,l,p,_,y,b,T=!1){const C=d.tilesIn(p,b,T);C.sort(G);const M=[];for(const P of C)M.push({wrappedTileID:P.tile.tileID.wrapped().key,queryResults:P.tile.queryRenderedFeatures(i,l,d._state,P,_,y,q(d.transform,P.tile.tileID),T)});const k=function(P){const F={},j={};for(const N of P){const $=N.queryResults,ee=N.wrappedTileID,V=j[ee]=j[ee]||{};for(const Y in $){const J=$[Y],H=V[Y]=V[Y]||{},K=F[Y]=F[Y]||[];for(const te of J)H[te.featureIndex]||(H[te.featureIndex]=!0,K.push(te))}}return F}(M);for(const P in k)k[P].forEach(F=>{const j=F.feature,N=d.getFeatureState(j.layer["source-layer"],j.id);j.source=j.layer.source,j.layer["source-layer"]&&(j.sourceLayer=j.layer["source-layer"]),j.state=N});return k}function B(d,i){const l=d.getRenderableIds().map(y=>d.getTileByID(y)),p=[],_={};for(let y=0;y<l.length;y++){const b=l[y],T=b.tileID.canonical.key;_[T]||(_[T]=!0,b.querySourceFeatures(p,i))}return p}function G(d,i){const l=d.tileID,p=i.tileID;return l.overscaledZ-p.overscaledZ||l.canonical.y-p.canonical.y||l.wrap-p.wrap||l.canonical.x-p.canonical.x}function X(){return Un.workerClass!=null?new Un.workerClass:new a.window.Worker(Un.workerUrl)}const re="mapboxgl_preloaded_worker_pool";class ce{constructor(){this.active={}}acquire(i){if(!this.workers)for(this.workers=[];this.workers.length<ce.workerCount;)this.workers.push(new X);return this.active[i]=!0,this.workers.slice()}release(i){delete this.active[i],this.numActive()===0&&(this.workers.forEach(l=>{l.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[re]}numActive(){return Object.keys(this.active).length}}let he;function se(){return he||(he=new ce),he}function pe(d,i){const l={};for(const p in d)p!=="ref"&&(l[p]=d[p]);return a.refProperties.forEach(p=>{p in i&&(l[p]=i[p])}),l}function Te(d){d=d.slice();const i=Object.create(null);for(let l=0;l<d.length;l++)i[d[l].id]=d[l];for(let l=0;l<d.length;l++)"ref"in d[l]&&(d[l]=pe(d[l],i[d[l].ref]));return d}ce.workerCount=2;const Se={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function Me(d,i,l){l.push({command:Se.addSource,args:[d,i[d]]})}function We(d,i,l){i.push({command:Se.removeSource,args:[d]}),l[d]=!0}function Je(d,i,l,p){We(d,l,p),Me(d,i,l)}function Qe(d,i,l){let p;for(p in d[l])if(d[l].hasOwnProperty(p)&&p!=="data"&&!ze(d[l][p],i[l][p]))return!1;for(p in i[l])if(i[l].hasOwnProperty(p)&&p!=="data"&&!ze(d[l][p],i[l][p]))return!1;return!0}function tt(d,i,l,p,_,y){let b;for(b in i=i||{},d=d||{})d.hasOwnProperty(b)&&(ze(d[b],i[b])||l.push({command:y,args:[p,b,i[b],_]}));for(b in i)i.hasOwnProperty(b)&&!d.hasOwnProperty(b)&&(ze(d[b],i[b])||l.push({command:y,args:[p,b,i[b],_]}))}function mt(d){return d.id}function qt(d,i){return d[i.id]=i,d}class Ht{constructor(i,l){this.reset(i,l)}reset(i,l){this.points=i||[],this._distances=[0];for(let p=1;p<this.points.length;p++)this._distances[p]=this._distances[p-1]+this.points[p].dist(this.points[p-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(l||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(i){if(this.points.length===1)return this.points[0];i=a.clamp(i,0,1);let l=1,p=this._distances[l];const _=i*this.paddedLength+this.padding;for(;p<_&&l<this._distances.length;)p=this._distances[++l];const y=l-1,b=this._distances[y],T=p-b,C=T>0?(_-b)/T:0;return this.points[y].mult(1-C).add(this.points[l].mult(C))}}class Vt{constructor(i,l,p){const _=this.boxCells=[],y=this.circleCells=[];this.xCellCount=Math.ceil(i/p),this.yCellCount=Math.ceil(l/p);for(let b=0;b<this.xCellCount*this.yCellCount;b++)_.push([]),y.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=i,this.height=l,this.xScale=this.xCellCount/i,this.yScale=this.yCellCount/l,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(i,l,p,_,y){this._forEachCell(l,p,_,y,this._insertBoxCell,this.boxUid++),this.boxKeys.push(i),this.bboxes.push(l),this.bboxes.push(p),this.bboxes.push(_),this.bboxes.push(y)}insertCircle(i,l,p,_){this._forEachCell(l-_,p-_,l+_,p+_,this._insertCircleCell,this.circleUid++),this.circleKeys.push(i),this.circles.push(l),this.circles.push(p),this.circles.push(_)}_insertBoxCell(i,l,p,_,y,b){this.boxCells[y].push(b)}_insertCircleCell(i,l,p,_,y,b){this.circleCells[y].push(b)}_query(i,l,p,_,y,b){if(p<0||i>this.width||_<0||l>this.height)return!y&&[];const T=[];if(i<=0&&l<=0&&this.width<=p&&this.height<=_){if(y)return!0;for(let C=0;C<this.boxKeys.length;C++)T.push({key:this.boxKeys[C],x1:this.bboxes[4*C],y1:this.bboxes[4*C+1],x2:this.bboxes[4*C+2],y2:this.bboxes[4*C+3]});for(let C=0;C<this.circleKeys.length;C++){const M=this.circles[3*C],k=this.circles[3*C+1],P=this.circles[3*C+2];T.push({key:this.circleKeys[C],x1:M-P,y1:k-P,x2:M+P,y2:k+P})}return b?T.filter(b):T}return this._forEachCell(i,l,p,_,this._queryCell,T,{hitTest:y,seenUids:{box:{},circle:{}}},b),y?T.length>0:T}_queryCircle(i,l,p,_,y){const b=i-p,T=i+p,C=l-p,M=l+p;if(T<0||b>this.width||M<0||C>this.height)return!_&&[];const k=[];return this._forEachCell(b,C,T,M,this._queryCellCircle,k,{hitTest:_,circle:{x:i,y:l,radius:p},seenUids:{box:{},circle:{}}},y),_?k.length>0:k}query(i,l,p,_,y){return this._query(i,l,p,_,!1,y)}hitTest(i,l,p,_,y){return this._query(i,l,p,_,!0,y)}hitTestCircle(i,l,p,_){return this._queryCircle(i,l,p,!0,_)}_queryCell(i,l,p,_,y,b,T,C){const M=T.seenUids,k=this.boxCells[y];if(k!==null){const F=this.bboxes;for(const j of k)if(!M.box[j]){M.box[j]=!0;const N=4*j;if(i<=F[N+2]&&l<=F[N+3]&&p>=F[N+0]&&_>=F[N+1]&&(!C||C(this.boxKeys[j]))){if(T.hitTest)return b.push(!0),!0;b.push({key:this.boxKeys[j],x1:F[N],y1:F[N+1],x2:F[N+2],y2:F[N+3]})}}}const P=this.circleCells[y];if(P!==null){const F=this.circles;for(const j of P)if(!M.circle[j]){M.circle[j]=!0;const N=3*j;if(this._circleAndRectCollide(F[N],F[N+1],F[N+2],i,l,p,_)&&(!C||C(this.circleKeys[j]))){if(T.hitTest)return b.push(!0),!0;{const $=F[N],ee=F[N+1],V=F[N+2];b.push({key:this.circleKeys[j],x1:$-V,y1:ee-V,x2:$+V,y2:ee+V})}}}}}_queryCellCircle(i,l,p,_,y,b,T,C){const M=T.circle,k=T.seenUids,P=this.boxCells[y];if(P!==null){const j=this.bboxes;for(const N of P)if(!k.box[N]){k.box[N]=!0;const $=4*N;if(this._circleAndRectCollide(M.x,M.y,M.radius,j[$+0],j[$+1],j[$+2],j[$+3])&&(!C||C(this.boxKeys[N])))return b.push(!0),!0}}const F=this.circleCells[y];if(F!==null){const j=this.circles;for(const N of F)if(!k.circle[N]){k.circle[N]=!0;const $=3*N;if(this._circlesCollide(j[$],j[$+1],j[$+2],M.x,M.y,M.radius)&&(!C||C(this.circleKeys[N])))return b.push(!0),!0}}}_forEachCell(i,l,p,_,y,b,T,C){const M=this._convertToXCellCoord(i),k=this._convertToYCellCoord(l),P=this._convertToXCellCoord(p),F=this._convertToYCellCoord(_);for(let j=M;j<=P;j++)for(let N=k;N<=F;N++)if(y.call(this,i,l,p,_,this.xCellCount*N+j,b,T,C))return}_convertToXCellCoord(i){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(i*this.xScale)))}_convertToYCellCoord(i){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(i*this.yScale)))}_circlesCollide(i,l,p,_,y,b){const T=_-i,C=y-l,M=p+b;return M*M>T*T+C*C}_circleAndRectCollide(i,l,p,_,y,b,T){const C=(b-_)/2,M=Math.abs(i-(_+C));if(M>C+p)return!1;const k=(T-y)/2,P=Math.abs(l-(y+k));if(P>k+p)return!1;if(M<=C||P<=k)return!0;const F=M-C,j=P-k;return F*F+j*j<=p*p}}const Kt=Math.tan(85*Math.PI/180);function Mn(d,i,l,p,_,y){let b=a.create();if(l){if(_.projection.name==="globe")b=a.calculateGlobeMatrix(_,_.worldSize/_._projectionScaler,[0,0]),a.multiply$1(b,b,a.globeDenormalizeECEF(a.globeTileBounds(i)));else{const T=ue([],y);b[0]=T[0],b[1]=T[1],b[4]=T[2],b[5]=T[3]}p||a.rotateZ(b,b,_.angle)}else a.multiply$1(b,_.labelPlaneMatrix,d);return b}function pn(d,i,l,p,_,y){if(l){if(_.projection.name==="globe"){const b=Mn(d,i,l,p,_,y);return a.invert(b,b),a.multiply$1(b,d,b),b}{const b=a.clone(d),T=a.identity([]);return T[0]=y[0],T[1]=y[1],T[4]=y[2],T[5]=y[3],a.multiply$1(b,b,T),p||a.rotateZ(b,b,-_.angle),b}}return _.glCoordMatrix}function Ri(d,i,l=0){const p=[d.x,d.y,l,1];l?a.transformMat4$1(p,p,i):bo(p,p,i);const _=p[3];return{point:new a.pointGeometry(p[0]/_,p[1]/_),signedDistanceFromCamera:_}}function Qr(d,i){return Math.min(.5+d/i*.5,1.5)}function Ta(d,i){const l=d[0]/d[3],p=d[1]/d[3];return l>=-i[0]&&l<=i[0]&&p>=-i[1]&&p<=i[1]}function Dh(d,i,l,p,_,y,b,T,C,M){const k=l.transform,P=p?d.textSizeData:d.iconSizeData,F=a.evaluateSizeForZoom(P,l.transform.zoom),j=[256/l.width*2+1,256/l.height*2+1],N=p?d.text.dynamicLayoutVertexArray:d.icon.dynamicLayoutVertexArray;N.clear();const $=d.lineVertexArray,ee=p?d.text.placedSymbolArray:d.icon.placedSymbolArray,V=l.transform.width/l.transform.height;let Y=!1;for(let J=0;J<ee.length;J++){const H=ee.get(J);if(H.writingMode!==a.WritingMode.vertical||Y||J!==0&&ee.get(J-1).writingMode===a.WritingMode.horizontal||(Y=!0),H.hidden||H.writingMode===a.WritingMode.vertical&&!Y){Nr(H.numGlyphs,N);continue}Y=!1;const K=new a.pointGeometry(H.tileAnchorX,H.tileAnchorY),te=C?C(K):[0,0,0],de=k.projection.projectTilePoint(K.x,K.y,M.canonical),_e=[de.x+te[0],de.y+te[1],de.z+te[2]],Be=[..._e,1];if(a.transformMat4$1(Be,Be,i),!Ta(Be,j)){Nr(H.numGlyphs,N);continue}const ke=Qr(l.transform.cameraToCenterDistance,Be[3]),Ce=a.evaluateSizeForFeature(P,F,H),xe=b?Ce/ke:Ce*ke,me=Ri(new a.pointGeometry(_e[0],_e[1]),_,_e[2]);if(me.signedDistanceFromCamera<=0){Nr(H.numGlyphs,N);continue}let Ae={};const Ee=b?null:C,Xe=Hl(H,xe,!1,T,i,_,y,d.glyphOffsetArray,$,N,me.point,K,Ae,V,Ee,k.projection,M);Y=Xe.useVertical,Ee&&Xe.needsFlipping&&(Ae={}),(Xe.notEnoughRoom||Y||Xe.needsFlipping&&Hl(H,xe,!0,T,i,_,y,d.glyphOffsetArray,$,N,me.point,K,Ae,V,Ee,k.projection,M).notEnoughRoom)&&Nr(H.numGlyphs,N)}p?d.text.dynamicLayoutVertexBuffer.updateData(N):d.icon.dynamicLayoutVertexBuffer.updateData(N)}function Xl(d,i,l,p,_,y,b,T,C,M,k,P,F,j,N){const $=T.glyphStartIndex+T.numGlyphs,ee=T.lineStartIndex,V=T.lineStartIndex+T.lineLength,Y=i.getoffsetX(T.glyphStartIndex),J=i.getoffsetX($-1),H=vo(d*Y,l,p,_,y,b,T.segment,ee,V,C,M,k,P,F,!0,j,N);if(!H)return null;const K=vo(d*J,l,p,_,y,b,T.segment,ee,V,C,M,k,P,F,!0,j,N);return K?{first:H,last:K}:null}function xo(d,i,l,p){return d.writingMode===a.WritingMode.horizontal&&Math.abs(l.y-i.y)>Math.abs(l.x-i.x)*p?{useVertical:!0}:d.writingMode===a.WritingMode.vertical?i.y<l.y?{needsFlipping:!0}:null:d.flipState!==0&&function(_,y,b){const T=(y.x-_.x)*b;return T===0||Math.abs((y.y-_.y)/T)>Kt}(i,l,p)?d.flipState===1?{needsFlipping:!0}:null:i.x>l.x?{needsFlipping:!0}:null}function Hl(d,i,l,p,_,y,b,T,C,M,k,P,F,j,N,$,ee){const V=i/24,Y=d.lineOffsetX*V,J=d.lineOffsetY*V;let H;if(d.numGlyphs>1){const K=d.glyphStartIndex+d.numGlyphs,te=d.lineStartIndex,de=d.lineStartIndex+d.lineLength,_e=Xl(V,T,Y,J,l,k,P,d,C,y,F,N,!1,$,ee);if(!_e)return{notEnoughRoom:!0};const Be=Ri(_e.first.point,b).point,ke=Ri(_e.last.point,b).point;if(p&&!l){const Ce=xo(d,Be,ke,j);if(d.flipState=Ce&&Ce.needsFlipping?1:2,Ce)return Ce}H=[_e.first];for(let Ce=d.glyphStartIndex+1;Ce<K-1;Ce++)H.push(vo(V*T.getoffsetX(Ce),Y,J,l,k,P,d.segment,te,de,C,y,F,N,!1,!1,$,ee));H.push(_e.last)}else{if(p&&!l){const te=Ri(P,_).point,de=d.lineStartIndex+d.segment+1,_e=new a.pointGeometry(C.getx(de),C.gety(de)),Be=Ri(_e,_),ke=xo(d,te,Be.signedDistanceFromCamera>0?Be.point:Sa(P,_e,te,1,_,void 0,$,ee.canonical),j);if(d.flipState=ke&&ke.needsFlipping?1:2,ke)return ke}const K=vo(V*T.getoffsetX(d.glyphStartIndex),Y,J,l,k,P,d.segment,d.lineStartIndex,d.lineStartIndex+d.lineLength,C,y,F,N,!1,!1,$,ee);if(!K)return{notEnoughRoom:!0};H=[K]}for(const K of H)a.addDynamicAttributes(M,K.point,K.angle);return{}}function Ea(d,i,l,p,_){const y=p.projectTilePoint(d.x,d.y,i);if(!_)return Ri(y,l,y.z);const b=_(d);return Ri(new a.pointGeometry(y.x+b[0],y.y+b[1]),l,y.z+b[2])}function Sa(d,i,l,p,_,y,b,T){const C=Ea(d.add(d.sub(i)._unit()),T,_,b,y).point,M=l.sub(C);return l.add(M._mult(p/M.mag()))}function vo(d,i,l,p,_,y,b,T,C,M,k,P,F,j,N,$,ee){const V=p?d-i:d+i;let Y=V>0?1:-1,J=0;p&&(Y*=-1,J=Math.PI),Y<0&&(J+=Math.PI);let H=Y>0?T+b:T+b+1,K=_,te=_,de=0,_e=0;const Be=Math.abs(V),ke=[],Ce=[];let xe=y;const me=()=>{const Re=H-Y;return de===0?y:new a.pointGeometry(M.getx(Re),M.gety(Re))},Ae=()=>Sa(me(),xe,te,Be-de+1,k,F,$,ee.canonical);for(;de+_e<=Be;){if(H+=Y,H<T||H>=C)return null;if(te=K,ke.push(K),j&&Ce.push(xe||me()),K=P[H],K===void 0){xe=new a.pointGeometry(M.getx(H),M.gety(H));const Re=Ea(xe,ee.canonical,k,$,F);K=Re.signedDistanceFromCamera>0?P[H]=Re.point:Ae()}else xe=null;de+=_e,_e=te.dist(K)}N&&F&&(xe=xe||new a.pointGeometry(M.getx(H),M.gety(H)),P[H]=K=P[H]===void 0?K:Ae(),_e=te.dist(K));const Ee=(Be-de)/_e,Xe=K.sub(te),et=Xe.mult(Ee)._add(te);l&&et._add(Xe._unit()._perp()._mult(l*Y));const ht=J+Math.atan2(K.y-te.y,K.x-te.x);return ke.push(et),j&&(xe=xe||new a.pointGeometry(M.getx(H),M.gety(H)),Ce.push(function(Re,Ke,st){const Rt=1-st;return new a.pointGeometry(Re.x*Rt+Ke.x*st,Re.y*Rt+Ke.y*st)}(Ce.length>0?Ce[Ce.length-1]:xe,xe,Ee))),{point:et,angle:ht,path:ke,tilePath:Ce}}const Kl=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Nr(d,i){for(let l=0;l<d;l++){const p=i.length;i.resize(p+4),i.float32.set(Kl,3*p)}}function bo(d,i,l){const p=i[0],_=i[1];return d[0]=l[0]*p+l[4]*_+l[12],d[1]=l[1]*p+l[5]*_+l[13],d[3]=l[3]*p+l[7]*_+l[15],d}const en=100;class Hd{constructor(i,l,p=new Vt(i.width+200,i.height+200,25),_=new Vt(i.width+200,i.height+200,25)){this.transform=i,this.grid=p,this.ignoredGrid=_,this.pitchfactor=Math.cos(i._pitch)*i.cameraToCenterDistance,this.screenRightBoundary=i.width+en,this.screenBottomBoundary=i.height+en,this.gridRightBoundary=i.width+200,this.gridBottomBoundary=i.height+200,this.fogState=l}placeCollisionBox(i,l,p,_,y,b,T){let C=l.projectedAnchorX,M=l.projectedAnchorY,k=l.projectedAnchorZ;const P=l.elevation,F=l.tileID;if(P&&F){const H=this.transform.projection.createTileTransform(this.transform,this.transform.worldSize),K=H.upVector(F.canonical,l.tileAnchorX,l.tileAnchorY),te=H.upVectorScale(F.canonical);C+=K[0]*P*te,M+=K[1]*P*te,k+=K[2]*P*te}const j=this.projectAndGetPerspectiveRatio(b,C,M,k,l.tileID),N=y*j.perspectiveRatio,$=(l.x1*i+p.x-l.padding)*N+j.point.x,ee=(l.y1*i+p.y-l.padding)*N+j.point.y,V=(l.x2*i+p.x+l.padding)*N+j.point.x,Y=(l.y2*i+p.y+l.padding)*N+j.point.y,J=j.perspectiveRatio<=.55||j.aboveHorizon;return!this.isInsideGrid($,ee,V,Y)||!_&&this.grid.hitTest($,ee,V,Y,T)||J?{box:[],offscreen:!1}:{box:[$,ee,V,Y],offscreen:this.isOffscreen($,ee,V,Y)}}placeCollisionCircles(i,l,p,_,y,b,T,C,M,k,P,F,j,N){const $=[],ee=this.transform.elevation,V=this.transform.projection.createTileTransform(this.transform,this.transform.worldSize),Y=ee?ee.getAtTileOffsetFunc(N,V):Ee=>[0,0,0],J=new a.pointGeometry(l.tileAnchorX,l.tileAnchorY),H=this.transform.projection.projectTilePoint(l.tileAnchorX,l.tileAnchorY,N.canonical),K=Y(J),te=[H.x+K[0],H.y+K[1],H.z+K[2]],de=this.projectAndGetPerspectiveRatio(b,te[0],te[1],te[2],N),{perspectiveRatio:_e}=de,Be=(k?y/_e:y*_e)/a.ONE_EM,ke=Ri(new a.pointGeometry(te[0],te[1]),T,te[2]).point,Ce=de.signedDistanceFromCamera>0?Xl(Be,_,l.lineOffsetX*Be,l.lineOffsetY*Be,!1,ke,J,l,p,T,{},ee&&!k?Y:null,k&&!!ee,this.transform.projection,N):null;let xe=!1,me=!1,Ae=!0;if(Ce&&!de.aboveHorizon){const Ee=.5*F*_e+j,Xe=new a.pointGeometry(-100,-100),et=new a.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),ht=new Ht,Re=Ce.first,Ke=Ce.last;let st=[];for(let nt=Re.path.length-1;nt>=1;nt--)st.push(Re.path[nt]);for(let nt=1;nt<Ke.path.length;nt++)st.push(Ke.path[nt]);const Rt=2.5*Ee;if(C){const nt=st.map(ee?(_t,Yt)=>{const vi=Y(Yt<Re.path.length-1?Re.tilePath[Re.path.length-1-Yt]:Ke.tilePath[Yt-Re.path.length+2]);return Ri(_t,C,vi[2])}:_t=>Ri(_t,C));st=nt.some(_t=>_t.signedDistanceFromCamera<=0)?[]:nt.map(_t=>_t.point)}let jt=[];if(st.length>0){const nt=st[0].clone(),_t=st[0].clone();for(let Yt=1;Yt<st.length;Yt++)nt.x=Math.min(nt.x,st[Yt].x),nt.y=Math.min(nt.y,st[Yt].y),_t.x=Math.max(_t.x,st[Yt].x),_t.y=Math.max(_t.y,st[Yt].y);jt=nt.x>=Xe.x&&_t.x<=et.x&&nt.y>=Xe.y&&_t.y<=et.y?[st]:_t.x<Xe.x||nt.x>et.x||_t.y<Xe.y||nt.y>et.y?[]:a.clipLine([st],Xe.x,Xe.y,et.x,et.y)}for(const nt of jt){ht.reset(nt,.25*Ee);let _t=0;_t=ht.length<=.5*Ee?1:Math.ceil(ht.paddedLength/Rt)+1;for(let Yt=0;Yt<_t;Yt++){const vi=Yt/Math.max(_t-1,1),nr=ht.lerp(vi),kr=nr.x+en,$r=nr.y+en;$.push(kr,$r,Ee,0);const Et=kr-Ee,ot=$r-Ee,vt=kr+Ee,oi=$r+Ee;if(Ae=Ae&&this.isOffscreen(Et,ot,vt,oi),me=me||this.isInsideGrid(Et,ot,vt,oi),!i&&this.grid.hitTestCircle(kr,$r,Ee,P)&&(xe=!0,!M))return{circles:[],offscreen:!1,collisionDetected:xe}}}}return{circles:!M&&xe||!me?[]:$,offscreen:Ae,collisionDetected:xe}}queryRenderedSymbols(i){if(i.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const l=[];let p=1/0,_=1/0,y=-1/0,b=-1/0;for(const k of i){const P=new a.pointGeometry(k.x+en,k.y+en);p=Math.min(p,P.x),_=Math.min(_,P.y),y=Math.max(y,P.x),b=Math.max(b,P.y),l.push(P)}const T=this.grid.query(p,_,y,b).concat(this.ignoredGrid.query(p,_,y,b)),C={},M={};for(const k of T){const P=k.key;if(C[P.bucketInstanceId]===void 0&&(C[P.bucketInstanceId]={}),C[P.bucketInstanceId][P.featureIndex])continue;const F=[new a.pointGeometry(k.x1,k.y1),new a.pointGeometry(k.x2,k.y1),new a.pointGeometry(k.x2,k.y2),new a.pointGeometry(k.x1,k.y2)];a.polygonIntersectsPolygon(l,F)&&(C[P.bucketInstanceId][P.featureIndex]=!0,M[P.bucketInstanceId]===void 0&&(M[P.bucketInstanceId]=[]),M[P.bucketInstanceId].push(P.featureIndex))}return M}insertCollisionBox(i,l,p,_,y){(l?this.ignoredGrid:this.grid).insert({bucketInstanceId:p,featureIndex:_,collisionGroupID:y},i[0],i[1],i[2],i[3])}insertCollisionCircles(i,l,p,_,y){const b=l?this.ignoredGrid:this.grid,T={bucketInstanceId:p,featureIndex:_,collisionGroupID:y};for(let C=0;C<i.length;C+=4)b.insertCircle(T,i[C],i[C+1],i[C+2])}projectAndGetPerspectiveRatio(i,l,p,_,y){const b=[l,p,_||0,1];let T=!1;if(_||this.transform.pitch>0){a.transformMat4$1(b,b,i);let C=!1;this.fogState&&y&&(C=function(M,k,P,F,j,N){const $=N.calculateFogTileMatrix(j),ee=[k,P,F];return a.transformMat4(ee,ee,$),hn(M,ee,N.pitch,N._fov)}(this.fogState,l,p,_||0,y.toUnwrapped(),this.transform)>.9),T=b[2]>b[3]||C}else bo(b,b,i);return{point:new a.pointGeometry((b[0]/b[3]+1)/2*this.transform.width+en,(-b[1]/b[3]+1)/2*this.transform.height+en),perspectiveRatio:Math.min(.5+this.transform.cameraToCenterDistance/b[3]*.5,1.5),signedDistanceFromCamera:b[3],aboveHorizon:T}}isOffscreen(i,l,p,_){return p<en||i>=this.screenRightBoundary||_<en||l>this.screenBottomBoundary}isInsideGrid(i,l,p,_){return p>=0&&i<this.gridRightBoundary&&_>=0&&l<this.gridBottomBoundary}getViewportMatrix(){const i=a.identity([]);return a.translate(i,i,[-100,-100,0]),i}}class zh{constructor(i,l,p,_){this.opacity=i?Math.max(0,Math.min(1,i.opacity+(i.placed?l:-l))):_&&p?1:0,this.placed=p}isHidden(){return this.opacity===0&&!this.placed}}class ks{constructor(i,l,p,_,y,b=!1){this.text=new zh(i?i.text:null,l,p,y),this.icon=new zh(i?i.icon:null,l,_,y),this.clipped=b}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Ds{constructor(i,l,p,_=!1){this.text=i,this.icon=l,this.skipFade=p,this.clipped=_}}class wo{constructor(){this.invProjMatrix=a.create(),this.viewportMatrix=a.create(),this.circles=[]}}class Ph{constructor(i,l,p,_,y){this.bucketInstanceId=i,this.featureIndex=l,this.sourceLayerIndex=p,this.bucketIndex=_,this.tileID=y}}class Lh{constructor(i){this.crossSourceCollisions=i,this.maxGroupID=0,this.collisionGroups={}}get(i){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[i]){const l=++this.maxGroupID;this.collisionGroups[i]={ID:l,predicate:p=>p.collisionGroupID===l}}return this.collisionGroups[i]}}function Ia(d,i,l,p,_){const{horizontalAlign:y,verticalAlign:b}=a.getAnchorAlignment(d),T=-(y-.5)*i,C=-(b-.5)*l,M=a.evaluateVariableOffset(d,p);return new a.pointGeometry(T+M[0]*_,C+M[1]*_)}function kn(d,i,l,p,_){const y=new a.pointGeometry(d,i);return l&&y._rotate(p?_:-_),y}class Aa{constructor(i,l,p,_,y){this.transform=i.clone(),this.collisionIndex=new Hd(this.transform,y),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=l,this.retainedQueryData={},this.collisionGroups=new Lh(p),this.collisionCircleArrays={},this.prevPlacement=_,_&&(_.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(i,l,p,_){const y=p.getBucket(l),b=p.latestFeatureIndex;if(!y||!b||l.id!==y.layerIds[0])return;const T=y.layers[0].layout,C=p.collisionBoxArray,M=Math.pow(2,this.transform.zoom-p.tileID.overscaledZ),k=p.tileSize/a.EXTENT,P=p.tileID.toUnwrapped(),F=this.transform.calculateProjMatrix(P),j=T.get("text-pitch-alignment")==="map",N=T.get("text-rotation-alignment")==="map";l.compileFilter();const $=l.dynamicFilter(),ee=l.dynamicFilterNeedsFeature(),V=this.transform.calculatePixelsToTileUnitsMatrix(p),Y=Mn(F,p.tileID.canonical,j,N,this.transform,V);let J=null;if(j){const te=pn(F,p.tileID.canonical,j,N,this.transform,V);J=a.multiply$1([],this.transform.labelPlaneMatrix,te)}let H=null;$&&p.latestFeatureIndex&&(H={unwrappedTileID:P,dynamicFilter:$,dynamicFilterNeedsFeature:ee,featureIndex:p.latestFeatureIndex}),this.retainedQueryData[y.bucketInstanceId]=new Ph(y.bucketInstanceId,b,y.sourceLayerIndex,y.index,p.tileID);const K={bucket:y,layout:T,posMatrix:F,textLabelPlaneMatrix:Y,labelToScreenMatrix:J,clippingData:H,scale:M,textPixelRatio:k,holdingForFade:p.holdingForFade(),collisionBoxArray:C,partiallyEvaluatedTextSize:a.evaluateSizeForZoom(y.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:a.evaluateSizeForZoom(y.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(y.sourceID)};if(_)for(const te of y.sortKeyRanges){const{sortKey:de,symbolInstanceStart:_e,symbolInstanceEnd:Be}=te;i.push({sortKey:de,symbolInstanceStart:_e,symbolInstanceEnd:Be,parameters:K})}else i.push({symbolInstanceStart:0,symbolInstanceEnd:y.symbolInstances.length,parameters:K})}attemptAnchorPlacement(i,l,p,_,y,b,T,C,M,k,P,F,j,N,$,ee,V,Y){const J=[F.textOffset0,F.textOffset1],H=Ia(i,p,_,J,y),K=this.collisionIndex.placeCollisionBox(y,l,kn(H.x,H.y,b,T,this.transform.angle),P,C,M,k.predicate);if((!ee||this.collisionIndex.placeCollisionBox(N.getSymbolInstanceIconSize(Y,this.transform.zoom,j),ee,kn(H.x,H.y,b,T,this.transform.angle),P,C,M,k.predicate).box.length!==0)&&K.box.length>0){let te;return this.prevPlacement&&this.prevPlacement.variableOffsets[F.crossTileID]&&this.prevPlacement.placements[F.crossTileID]&&this.prevPlacement.placements[F.crossTileID].text&&(te=this.prevPlacement.variableOffsets[F.crossTileID].anchor),this.variableOffsets[F.crossTileID]={textOffset:J,width:p,height:_,anchor:i,textScale:y,prevAnchor:te},this.markUsedJustification(N,i,F,$),N.allowVerticalPlacement&&(this.markUsedOrientation(N,$,F),this.placedOrientations[F.crossTileID]=$),{shift:H,placedGlyphBoxes:K}}}placeLayerBucketPart(i,l,p,_){const{bucket:y,layout:b,posMatrix:T,textLabelPlaneMatrix:C,labelToScreenMatrix:M,clippingData:k,textPixelRatio:P,holdingForFade:F,collisionBoxArray:j,partiallyEvaluatedTextSize:N,partiallyEvaluatedIconSize:$,collisionGroup:ee}=i.parameters,V=b.get("text-optional"),Y=b.get("icon-optional"),J=b.get("text-allow-overlap"),H=b.get("icon-allow-overlap"),K=b.get("text-rotation-alignment")==="map",te=b.get("text-pitch-alignment")==="map",de=b.get("icon-text-fit")!=="none",_e=b.get("symbol-z-order")==="viewport-y",Be=J&&(H||!y.hasIconData()||Y),ke=H&&(J||!y.hasTextData()||V);!y.collisionArrays&&j&&y.deserializeCollisionBoxes(j),p&&_&&y.updateCollisionDebugBuffers(this.transform.zoom,j);const Ce=(xe,me,Ae)=>{if(k){const Et={zoom:this.transform.zoom,pitch:this.transform.pitch};let ot=null;if(k.dynamicFilterNeedsFeature){const vt=this.retainedQueryData[y.bucketInstanceId];ot=k.featureIndex.loadFeature({featureIndex:xe.featureIndex,bucketIndex:vt.bucketIndex,sourceLayerIndex:vt.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,k.dynamicFilter)(Et,ot,this.retainedQueryData[y.bucketInstanceId].tileID.canonical,new a.pointGeometry(xe.tileAnchorX,xe.tileAnchorY),this.transform.calculateDistanceTileData(k.unwrappedTileID)))return this.placements[xe.crossTileID]=new Ds(!1,!1,!1,!0),void(l[xe.crossTileID]=!0)}if(l[xe.crossTileID])return;if(F)return void(this.placements[xe.crossTileID]=new Ds(!1,!1,!1));let Ee=!1,Xe=!1,et=!0,ht=null,Re={box:null,offscreen:null},Ke={box:null,offscreen:null},st=null,Rt=null,jt=null,nt=0,_t=0,Yt=0;Ae.textFeatureIndex?nt=Ae.textFeatureIndex:xe.useRuntimeCollisionCircles&&(nt=xe.featureIndex),Ae.verticalTextFeatureIndex&&(_t=Ae.verticalTextFeatureIndex);const vi=Et=>{Et.tileID=this.retainedQueryData[y.bucketInstanceId].tileID,(this.transform.elevation||Et.elevation)&&(Et.elevation=this.transform.elevation?this.transform.elevation.getAtTileOffset(this.retainedQueryData[y.bucketInstanceId].tileID,Et.tileAnchorX,Et.tileAnchorY):0)},nr=Ae.textBox;if(nr){vi(nr);const Et=vt=>{let oi=a.WritingMode.horizontal;if(y.allowVerticalPlacement&&!vt&&this.prevPlacement){const pr=this.prevPlacement.placedOrientations[xe.crossTileID];pr&&(this.placedOrientations[xe.crossTileID]=pr,oi=pr,this.markUsedOrientation(y,oi,xe))}return oi},ot=(vt,oi)=>{if(y.allowVerticalPlacement&&xe.numVerticalGlyphVertices>0&&Ae.verticalTextBox){for(const pr of y.writingModes)if(pr===a.WritingMode.vertical?(Re=oi(),Ke=Re):Re=vt(),Re&&Re.box&&Re.box.length)break}else Re=vt()};if(b.get("text-variable-anchor")){let vt=b.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[xe.crossTileID]){const Wt=this.prevPlacement.variableOffsets[xe.crossTileID];vt.indexOf(Wt.anchor)>0&&(vt=vt.filter(fr=>fr!==Wt.anchor),vt.unshift(Wt.anchor))}const oi=(Wt,fr,Wo)=>{const sr=y.getSymbolInstanceTextSize(N,xe,this.transform.zoom,me),ss=(Wt.x2-Wt.x1)*sr+2*Wt.padding,Ge=(Wt.y2-Wt.y1)*sr+2*Wt.padding,Ye=de&&!H?fr:null;Ye&&vi(Ye);let Ii={box:[],offscreen:!1};const os=J?2*vt.length:vt.length;for(let Vn=0;Vn<os;++Vn){const Fi=this.attemptAnchorPlacement(vt[Vn%vt.length],Wt,ss,Ge,sr,K,te,P,T,ee,Vn>=vt.length,xe,me,y,Wo,Ye,N,$);if(Fi&&(Ii=Fi.placedGlyphBoxes,Ii&&Ii.box&&Ii.box.length)){Ee=!0,ht=Fi.shift;break}}return Ii};ot(()=>oi(nr,Ae.iconBox,a.WritingMode.horizontal),()=>{const Wt=Ae.verticalTextBox;return Wt&&vi(Wt),y.allowVerticalPlacement&&!(Re&&Re.box&&Re.box.length)&&xe.numVerticalGlyphVertices>0&&Wt?oi(Wt,Ae.verticalIconBox,a.WritingMode.vertical):{box:null,offscreen:null}}),Re&&(Ee=Re.box,et=Re.offscreen);const pr=Et(Re&&Re.box);if(!Ee&&this.prevPlacement){const Wt=this.prevPlacement.variableOffsets[xe.crossTileID];Wt&&(this.variableOffsets[xe.crossTileID]=Wt,this.markUsedJustification(y,Wt.anchor,xe,pr))}}else{const vt=(oi,pr)=>{const Wt=y.getSymbolInstanceTextSize(N,xe,this.transform.zoom,me),fr=this.collisionIndex.placeCollisionBox(Wt,oi,new a.pointGeometry(0,0),J,P,T,ee.predicate);return fr&&fr.box&&fr.box.length&&(this.markUsedOrientation(y,pr,xe),this.placedOrientations[xe.crossTileID]=pr),fr};ot(()=>vt(nr,a.WritingMode.horizontal),()=>{const oi=Ae.verticalTextBox;return y.allowVerticalPlacement&&xe.numVerticalGlyphVertices>0&&oi?(vi(oi),vt(oi,a.WritingMode.vertical)):{box:null,offscreen:null}}),Et(Re&&Re.box&&Re.box.length)}}if(st=Re,Ee=st&&st.box&&st.box.length>0,et=st&&st.offscreen,xe.useRuntimeCollisionCircles){const Et=y.text.placedSymbolArray.get(xe.centerJustifiedTextSymbolIndex>=0?xe.centerJustifiedTextSymbolIndex:xe.verticalPlacedTextSymbolIndex),ot=a.evaluateSizeForFeature(y.textSizeData,N,Et),vt=b.get("text-padding");Rt=this.collisionIndex.placeCollisionCircles(J,Et,y.lineVertexArray,y.glyphOffsetArray,ot,T,C,M,p,te,ee.predicate,xe.collisionCircleDiameter*ot/a.ONE_EM,vt,this.retainedQueryData[y.bucketInstanceId].tileID),Ee=J||Rt.circles.length>0&&!Rt.collisionDetected,et=et&&Rt.offscreen}if(Ae.iconFeatureIndex&&(Yt=Ae.iconFeatureIndex),Ae.iconBox){const Et=ot=>{vi(ot);const vt=de&&ht?kn(ht.x,ht.y,K,te,this.transform.angle):new a.pointGeometry(0,0),oi=y.getSymbolInstanceIconSize($,this.transform.zoom,me);return this.collisionIndex.placeCollisionBox(oi,ot,vt,H,P,T,ee.predicate)};Ke&&Ke.box&&Ke.box.length&&Ae.verticalIconBox?(jt=Et(Ae.verticalIconBox),Xe=jt.box.length>0):(jt=Et(Ae.iconBox),Xe=jt.box.length>0),et=et&&jt.offscreen}const kr=V||xe.numHorizontalGlyphVertices===0&&xe.numVerticalGlyphVertices===0,$r=Y||xe.numIconVertices===0;if(kr||$r?$r?kr||(Xe=Xe&&Ee):Ee=Xe&&Ee:Xe=Ee=Xe&&Ee,Ee&&st&&st.box&&this.collisionIndex.insertCollisionBox(st.box,b.get("text-ignore-placement"),y.bucketInstanceId,Ke&&Ke.box&&_t?_t:nt,ee.ID),Xe&&jt&&this.collisionIndex.insertCollisionBox(jt.box,b.get("icon-ignore-placement"),y.bucketInstanceId,Yt,ee.ID),Rt&&(Ee&&this.collisionIndex.insertCollisionCircles(Rt.circles,b.get("text-ignore-placement"),y.bucketInstanceId,nt,ee.ID),p)){const Et=y.bucketInstanceId;let ot=this.collisionCircleArrays[Et];ot===void 0&&(ot=this.collisionCircleArrays[Et]=new wo);for(let vt=0;vt<Rt.circles.length;vt+=4)ot.circles.push(Rt.circles[vt+0]),ot.circles.push(Rt.circles[vt+1]),ot.circles.push(Rt.circles[vt+2]),ot.circles.push(Rt.collisionDetected?1:0)}this.placements[xe.crossTileID]=new Ds(Ee||Be,Xe||ke,et||y.justReloaded),l[xe.crossTileID]=!0};if(_e){const xe=y.getSortedSymbolIndexes(this.transform.angle);for(let me=xe.length-1;me>=0;--me){const Ae=xe[me];Ce(y.symbolInstances.get(Ae),Ae,y.collisionArrays[Ae])}}else for(let xe=i.symbolInstanceStart;xe<i.symbolInstanceEnd;xe++)Ce(y.symbolInstances.get(xe),xe,y.collisionArrays[xe]);if(p&&y.bucketInstanceId in this.collisionCircleArrays){const xe=this.collisionCircleArrays[y.bucketInstanceId];a.invert(xe.invProjMatrix,T),xe.viewportMatrix=this.collisionIndex.getViewportMatrix()}y.justReloaded=!1}markUsedJustification(i,l,p,_){let y;y=_===a.WritingMode.vertical?p.verticalPlacedTextSymbolIndex:{left:p.leftJustifiedTextSymbolIndex,center:p.centerJustifiedTextSymbolIndex,right:p.rightJustifiedTextSymbolIndex}[a.getAnchorJustification(l)];const b=[p.leftJustifiedTextSymbolIndex,p.centerJustifiedTextSymbolIndex,p.rightJustifiedTextSymbolIndex,p.verticalPlacedTextSymbolIndex];for(const T of b)T>=0&&(i.text.placedSymbolArray.get(T).crossTileID=y>=0&&T!==y?0:p.crossTileID)}markUsedOrientation(i,l,p){const _=l===a.WritingMode.horizontal||l===a.WritingMode.horizontalOnly?l:0,y=l===a.WritingMode.vertical?l:0,b=[p.leftJustifiedTextSymbolIndex,p.centerJustifiedTextSymbolIndex,p.rightJustifiedTextSymbolIndex];for(const T of b)i.text.placedSymbolArray.get(T).placedOrientation=_;p.verticalPlacedTextSymbolIndex&&(i.text.placedSymbolArray.get(p.verticalPlacedTextSymbolIndex).placedOrientation=y)}commit(i){this.commitTime=i,this.zoomAtLastRecencyCheck=this.transform.zoom;const l=this.prevPlacement;let p=!1;this.prevZoomAdjustment=l?l.zoomAdjustment(this.transform.zoom):0;const _=l?l.symbolFadeChange(i):1,y=l?l.opacities:{},b=l?l.variableOffsets:{},T=l?l.placedOrientations:{};for(const C in this.placements){const M=this.placements[C],k=y[C];k?(this.opacities[C]=new ks(k,_,M.text,M.icon,null,M.clipped),p=p||M.text!==k.text.placed||M.icon!==k.icon.placed):(this.opacities[C]=new ks(null,_,M.text,M.icon,M.skipFade,M.clipped),p=p||M.text||M.icon)}for(const C in y){const M=y[C];if(!this.opacities[C]){const k=new ks(M,_,!1,!1);k.isHidden()||(this.opacities[C]=k,p=p||M.text.placed||M.icon.placed)}}for(const C in b)this.variableOffsets[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.variableOffsets[C]=b[C]);for(const C in T)this.placedOrientations[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.placedOrientations[C]=T[C]);p?this.lastPlacementChangeTime=i:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=l?l.lastPlacementChangeTime:i)}updateLayerOpacities(i,l){const p={};for(const _ of l){const y=_.getBucket(i);y&&_.latestFeatureIndex&&i.id===y.layerIds[0]&&this.updateBucketOpacities(y,p,_.collisionBoxArray)}}updateBucketOpacities(i,l,p){i.hasTextData()&&i.text.opacityVertexArray.clear(),i.hasIconData()&&i.icon.opacityVertexArray.clear(),i.hasIconCollisionBoxData()&&i.iconCollisionBox.collisionVertexArray.clear(),i.hasTextCollisionBoxData()&&i.textCollisionBox.collisionVertexArray.clear();const _=i.layers[0].layout,y=!!i.layers[0].dynamicFilter(),b=new ks(null,0,!1,!1,!0),T=_.get("text-allow-overlap"),C=_.get("icon-allow-overlap"),M=_.get("text-variable-anchor"),k=_.get("text-rotation-alignment")==="map",P=_.get("text-pitch-alignment")==="map",F=_.get("icon-text-fit")!=="none",j=new ks(null,0,T&&(C||!i.hasIconData()||_.get("icon-optional")),C&&(T||!i.hasTextData()||_.get("text-optional")),!0);!i.collisionArrays&&p&&(i.hasIconCollisionBoxData()||i.hasTextCollisionBoxData())&&i.deserializeCollisionBoxes(p);const N=(ee,V,Y)=>{for(let J=0;J<V/4;J++)ee.opacityVertexArray.emplaceBack(Y)};let $=0;for(let ee=0;ee<i.symbolInstances.length;ee++){const V=i.symbolInstances.get(ee),{numHorizontalGlyphVertices:Y,numVerticalGlyphVertices:J,crossTileID:H}=V;let K=this.opacities[H];l[H]?K=b:K||(K=j,this.opacities[H]=K),l[H]=!0;const te=Y>0||J>0,de=V.numIconVertices>0,_e=this.placedOrientations[V.crossTileID],Be=_e===a.WritingMode.vertical,ke=_e===a.WritingMode.horizontal||_e===a.WritingMode.horizontalOnly;if(!te&&!de||K.isHidden()||$++,te){const Ce=Ca(K.text);N(i.text,Y,Be?Pn:Ce),N(i.text,J,ke?Pn:Ce);const xe=K.text.isHidden();[V.rightJustifiedTextSymbolIndex,V.centerJustifiedTextSymbolIndex,V.leftJustifiedTextSymbolIndex].forEach(Ee=>{Ee>=0&&(i.text.placedSymbolArray.get(Ee).hidden=xe||Be?1:0)}),V.verticalPlacedTextSymbolIndex>=0&&(i.text.placedSymbolArray.get(V.verticalPlacedTextSymbolIndex).hidden=xe||ke?1:0);const me=this.variableOffsets[V.crossTileID];me&&this.markUsedJustification(i,me.anchor,V,_e);const Ae=this.placedOrientations[V.crossTileID];Ae&&(this.markUsedJustification(i,"left",V,Ae),this.markUsedOrientation(i,Ae,V))}if(de){const Ce=Ca(K.icon);V.placedIconSymbolIndex>=0&&(N(i.icon,V.numIconVertices,Be?Pn:Ce),i.icon.placedSymbolArray.get(V.placedIconSymbolIndex).hidden=K.icon.isHidden()),V.verticalPlacedIconSymbolIndex>=0&&(N(i.icon,V.numVerticalIconVertices,ke?Pn:Ce),i.icon.placedSymbolArray.get(V.verticalPlacedIconSymbolIndex).hidden=K.icon.isHidden())}if(i.hasIconCollisionBoxData()||i.hasTextCollisionBoxData()){const Ce=i.collisionArrays[ee];if(Ce){let xe=new a.pointGeometry(0,0),me=!0;if(Ce.textBox||Ce.verticalTextBox){if(M){const Ee=this.variableOffsets[H];Ee?(xe=Ia(Ee.anchor,Ee.width,Ee.height,Ee.textOffset,Ee.textScale),k&&xe._rotate(P?this.transform.angle:-this.transform.angle)):me=!1}y&&(me=!K.clipped),Ce.textBox&&Dn(i.textCollisionBox.collisionVertexArray,K.text.placed,!me||Be,xe.x,xe.y),Ce.verticalTextBox&&Dn(i.textCollisionBox.collisionVertexArray,K.text.placed,!me||ke,xe.x,xe.y)}const Ae=me&&Boolean(!ke&&Ce.verticalIconBox);Ce.iconBox&&Dn(i.iconCollisionBox.collisionVertexArray,K.icon.placed,Ae,F?xe.x:0,F?xe.y:0),Ce.verticalIconBox&&Dn(i.iconCollisionBox.collisionVertexArray,K.icon.placed,!Ae,F?xe.x:0,F?xe.y:0)}}}if(i.fullyClipped=$===0,i.sortFeatures(this.transform.angle),this.retainedQueryData[i.bucketInstanceId]&&(this.retainedQueryData[i.bucketInstanceId].featureSortOrder=i.featureSortOrder),i.hasTextData()&&i.text.opacityVertexBuffer&&i.text.opacityVertexBuffer.updateData(i.text.opacityVertexArray),i.hasIconData()&&i.icon.opacityVertexBuffer&&i.icon.opacityVertexBuffer.updateData(i.icon.opacityVertexArray),i.hasIconCollisionBoxData()&&i.iconCollisionBox.collisionVertexBuffer&&i.iconCollisionBox.collisionVertexBuffer.updateData(i.iconCollisionBox.collisionVertexArray),i.hasTextCollisionBoxData()&&i.textCollisionBox.collisionVertexBuffer&&i.textCollisionBox.collisionVertexBuffer.updateData(i.textCollisionBox.collisionVertexArray),i.bucketInstanceId in this.collisionCircleArrays){const ee=this.collisionCircleArrays[i.bucketInstanceId];i.placementInvProjMatrix=ee.invProjMatrix,i.placementViewportMatrix=ee.viewportMatrix,i.collisionCircleArray=ee.circles,delete this.collisionCircleArrays[i.bucketInstanceId]}}symbolFadeChange(i){return this.fadeDuration===0?1:(i-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(i){return Math.max(0,(this.transform.zoom-i)/1.5)}hasTransitions(i){return this.stale||i-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(i,l){const p=this.zoomAtLastRecencyCheck===l?1-this.zoomAdjustment(l):1;return this.zoomAtLastRecencyCheck=l,this.commitTime+this.fadeDuration*p>i}setStale(){this.stale=!0}}function Dn(d,i,l,p,_){d.emplaceBack(i?1:0,l?1:0,p||0,_||0),d.emplaceBack(i?1:0,l?1:0,p||0,_||0),d.emplaceBack(i?1:0,l?1:0,p||0,_||0),d.emplaceBack(i?1:0,l?1:0,p||0,_||0)}const ye=Math.pow(2,25),Ue=Math.pow(2,24),Rh=Math.pow(2,17),zn=Math.pow(2,16),li=Math.pow(2,9),fn=Math.pow(2,8),tn=Math.pow(2,1);function Ca(d){if(d.opacity===0&&!d.placed)return 0;if(d.opacity===1&&d.placed)return 4294967295;const i=d.placed?1:0,l=Math.floor(127*d.opacity);return l*ye+i*Ue+l*Rh+i*zn+l*li+i*fn+l*tn+i}const Pn=0;class Ne{constructor(i){this._sortAcrossTiles=i.layout.get("symbol-z-order")!=="viewport-y"&&i.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(i,l,p,_,y){const b=this._bucketParts;for(;this._currentTileIndex<i.length;)if(l.getBucketParts(b,_,i[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,y())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,b.sort((T,C)=>T.sortKey-C.sortKey));this._currentPartIndex<b.length;){const T=b[this._currentPartIndex];if(l.placeLayerBucketPart(T,this._seenCrossTileIDs,p,T.symbolInstanceStart===0),this._currentPartIndex++,y())return!0}return!1}}class xt{constructor(i,l,p,_,y,b,T,C){this.placement=new Aa(i,y,b,T,C),this._currentPlacementIndex=l.length-1,this._forceFullPlacement=p,this._showCollisionBoxes=_,this._done=!1}isDone(){return this._done}continuePlacement(i,l,p){const _=a.exported.now(),y=()=>{const b=a.exported.now()-_;return!this._forceFullPlacement&&b>2};for(;this._currentPlacementIndex>=0;){const b=l[i[this._currentPlacementIndex]],T=this.placement.collisionIndex.transform.zoom;if(b.type==="symbol"&&(!b.minzoom||b.minzoom<=T)&&(!b.maxzoom||b.maxzoom>T)){if(this._inProgressLayer||(this._inProgressLayer=new Ne(b)),this._inProgressLayer.continuePlacement(p[b.source],this.placement,this._showCollisionBoxes,b,y))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(i){return this.placement.commit(i),this.placement}}const pt=512/a.EXTENT/2;class rn{constructor(i,l,p){this.tileID=i,this.indexedSymbolInstances={},this.bucketInstanceId=p;for(let _=0;_<l.length;_++){const y=l.get(_),b=y.key;this.indexedSymbolInstances[b]||(this.indexedSymbolInstances[b]=[]),this.indexedSymbolInstances[b].push({crossTileID:y.crossTileID,coord:this.getScaledCoordinates(y,i)})}}getScaledCoordinates(i,l){const p=pt/Math.pow(2,l.canonical.z-this.tileID.canonical.z);return{x:Math.floor((l.canonical.x*a.EXTENT+i.tileAnchorX)*p),y:Math.floor((l.canonical.y*a.EXTENT+i.tileAnchorY)*p)}}findMatches(i,l,p){const _=this.tileID.canonical.z<l.canonical.z?1:Math.pow(2,this.tileID.canonical.z-l.canonical.z);for(let y=0;y<i.length;y++){const b=i.get(y);if(b.crossTileID)continue;const T=this.indexedSymbolInstances[b.key];if(!T)continue;const C=this.getScaledCoordinates(b,l);for(const M of T)if(Math.abs(M.coord.x-C.x)<=_&&Math.abs(M.coord.y-C.y)<=_&&!p[M.crossTileID]){p[M.crossTileID]=!0,b.crossTileID=M.crossTileID;break}}}}class zs{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class ft{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(i){const l=Math.round((i-this.lng)/360);if(l!==0)for(const p in this.indexes){const _=this.indexes[p],y={};for(const b in _){const T=_[b];T.tileID=T.tileID.unwrapTo(T.tileID.wrap+l),y[T.tileID.key]=T}this.indexes[p]=y}this.lng=i}addBucket(i,l,p){if(this.indexes[i.overscaledZ]&&this.indexes[i.overscaledZ][i.key]){if(this.indexes[i.overscaledZ][i.key].bucketInstanceId===l.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(i.overscaledZ,this.indexes[i.overscaledZ][i.key])}for(let y=0;y<l.symbolInstances.length;y++)l.symbolInstances.get(y).crossTileID=0;this.usedCrossTileIDs[i.overscaledZ]||(this.usedCrossTileIDs[i.overscaledZ]={});const _=this.usedCrossTileIDs[i.overscaledZ];for(const y in this.indexes){const b=this.indexes[y];if(Number(y)>i.overscaledZ)for(const T in b){const C=b[T];C.tileID.isChildOf(i)&&C.findMatches(l.symbolInstances,i,_)}else{const T=b[i.scaledTo(Number(y)).key];T&&T.findMatches(l.symbolInstances,i,_)}}for(let y=0;y<l.symbolInstances.length;y++){const b=l.symbolInstances.get(y);b.crossTileID||(b.crossTileID=p.generate(),_[b.crossTileID]=!0)}return this.indexes[i.overscaledZ]===void 0&&(this.indexes[i.overscaledZ]={}),this.indexes[i.overscaledZ][i.key]=new rn(i,l.symbolInstances,l.bucketInstanceId),!0}removeBucketCrossTileIDs(i,l){for(const p in l.indexedSymbolInstances)for(const _ of l.indexedSymbolInstances[p])delete this.usedCrossTileIDs[i][_.crossTileID]}removeStaleBuckets(i){let l=!1;for(const p in this.indexes){const _=this.indexes[p];for(const y in _)i[_[y].bucketInstanceId]||(this.removeBucketCrossTileIDs(p,_[y]),delete _[y],l=!0)}return l}}class To{constructor(){this.layerIndexes={},this.crossTileIDs=new zs,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(i,l,p,_){let y=this.layerIndexes[i.id];y===void 0&&(y=this.layerIndexes[i.id]=new ft);let b=!1;const T={};_.name!=="globe"&&y.handleWrapJump(p);for(const C of l){const M=C.getBucket(i);M&&i.id===M.layerIds[0]&&(M.bucketInstanceId||(M.bucketInstanceId=++this.maxBucketInstanceId),y.addBucket(C.tileID,M,this.crossTileIDs)&&(b=!0),T[M.bucketInstanceId]=!0)}return y.removeStaleBuckets(T)&&(b=!0),b}pruneUnusedLayers(i){const l={};i.forEach(p=>{l[p]=!0});for(const p in this.layerIndexes)l[p]||delete this.layerIndexes[p]}}const Ln=(d,i)=>a.emitValidationErrors(d,i&&i.filter(l=>l.identifier!=="source.canvas")),Eo=a.pick(Se,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),Ir=a.pick(Se,["setCenter","setZoom","setBearing","setPitch"]),ri=function(){const d={},i=a.spec.$version;for(const l in a.spec.$root){const p=a.spec.$root[l];if(p.required){let _=null;_=l==="version"?i:p.type==="array"?[]:{},_!=null&&(d[l]=_)}}return d}(),Kd={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class ir extends a.Evented{constructor(i,l={}){super(),this.map=i,this.dispatcher=new Hr(se(),this),this.imageManager=new Ti,this.imageManager.setEventedParent(this),this.glyphManager=new a.GlyphManager(i._requestManager,l.localFontFamily?a.LocalGlyphMode.all:l.localIdeographFontFamily?a.LocalGlyphMode.ideographs:a.LocalGlyphMode.none,l.localFontFamily||l.localIdeographFontFamily),this.lineAtlas=new a.LineAtlas(256,512),this.crossTileSymbolIndex=new To,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this.zoomHistory=new a.ZoomHistory,this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",a.getReferrer());const p=this;this._rtlTextPluginCallback=ir.registerForPluginStateChange(_=>{p.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:_.pluginStatus,pluginURL:_.pluginURL},(y,b)=>{if(a.triggerPluginCompletionEvent(y),b&&b.every(T=>T))for(const T in p._sourceCaches){const C=p._sourceCaches[T],M=C.getSource().type;M!=="vector"&&M!=="geojson"||C.reload()}})}),this.on("data",_=>{if(_.dataType!=="source"||_.sourceDataType!=="metadata")return;const y=this.getSource(_.sourceId);if(y&&y.vectorLayerIds)for(const b in this._layers){const T=this._layers[b];T.source===y.id&&this._validateLayer(T)}})}loadURL(i,l={}){this.fire(new a.Event("dataloading",{dataType:"style"}));const p=typeof l.validate=="boolean"?l.validate:!a.isMapboxURL(i);i=this.map._requestManager.normalizeStyleURL(i,l.accessToken);const _=this.map._requestManager.transformRequest(i,a.ResourceType.Style);this._request=a.getJSON(_,(y,b)=>{this._request=null,y?this.fire(new a.ErrorEvent(y)):b&&this._load(b,p)})}loadJSON(i,l={}){this.fire(new a.Event("dataloading",{dataType:"style"})),this._request=a.exported.frame(()=>{this._request=null,this._load(i,l.validate!==!1)})}loadEmpty(){this.fire(new a.Event("dataloading",{dataType:"style"})),this._load(ri,!1)}_updateLayerCount(i,l){const p=l?1:-1;i.is3D()&&(this._num3DLayers+=p),i.type==="circle"&&(this._numCircleLayers+=p),i.type==="symbol"&&(this._numSymbolLayers+=p)}_load(i,l){if(l&&Ln(this,a.validateStyle(i)))return;this._loaded=!0,this.stylesheet=i,this.updateProjection();for(const _ in i.sources)this.addSource(_,i.sources[_],{validate:!1});this._changed=!1,i.sprite?this._loadSprite(i.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(i.glyphs);const p=Te(this.stylesheet.layers);this._order=p.map(_=>_.id),this._layers={},this._serializedLayers={};for(let _ of p)_=a.createStyleLayer(_),_.setEventedParent(this,{layer:{id:_.id}}),this._layers[_.id]=_,this._serializedLayers[_.id]=_.serialize(),this._updateLayerCount(_,!0);this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new Xr(this.stylesheet.light),this.stylesheet.terrain&&!this.terrainSetForDrapingOnly()&&this._createTerrain(this.stylesheet.terrain,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new a.Event("data",{dataType:"style"})),this.fire(new a.Event("style.load"))}terrainSetForDrapingOnly(){return this.terrain&&this.terrain.drapeRenderMode===0}setProjection(i){i?this.stylesheet.projection=i:delete this.stylesheet.projection,this.updateProjection()}updateProjection(){const i=this.map.transform.projection,l=this.map.transform.setProjection(this.map._runtimeProjection||(this.stylesheet?this.stylesheet.projection:void 0)),p=this.map.transform.projection;if(this._loaded&&(p.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null)),this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),l){if(p.isReprojectedInTileSpace||i.isReprojectedInTileSpace){this.map.painter.clearBackgroundTiles();for(const _ in this._sourceCaches)this._sourceCaches[_].clearTiles()}else this._forceSymbolLayerUpdate();this.map._update(!0)}}_loadSprite(i){this._spriteRequest=function(l,p,_){let y,b,T;const C=a.exported.devicePixelRatio>1?"@2x":"";let M=a.getJSON(p.transformRequest(p.normalizeSpriteURL(l,C,".json"),a.ResourceType.SpriteJSON),(F,j)=>{M=null,T||(T=F,y=j,P())}),k=a.getImage(p.transformRequest(p.normalizeSpriteURL(l,C,".png"),a.ResourceType.SpriteImage),(F,j)=>{k=null,T||(T=F,b=j,P())});function P(){if(T)_(T);else if(y&&b){const F=a.exported.getImageData(b),j={};for(const N in y){const{width:$,height:ee,x:V,y:Y,sdf:J,pixelRatio:H,stretchX:K,stretchY:te,content:de}=y[N],_e=new a.RGBAImage({width:$,height:ee});a.RGBAImage.copy(F,_e,{x:V,y:Y},{x:0,y:0},{width:$,height:ee}),j[N]={data:_e,pixelRatio:H,sdf:J,stretchX:K,stretchY:te,content:de}}_(null,j)}}return{cancel(){M&&(M.cancel(),M=null),k&&(k.cancel(),k=null)}}}(i,this.map._requestManager,(l,p)=>{if(this._spriteRequest=null,l)this.fire(new a.ErrorEvent(l));else if(p)for(const _ in p)this.imageManager.addImage(_,p[_]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new a.Event("data",{dataType:"style"}))})}_validateLayer(i){const l=this.getSource(i.source);if(!l)return;const p=i.sourceLayer;p&&(l.type==="geojson"||l.vectorLayerIds&&l.vectorLayerIds.indexOf(p)===-1)&&this.fire(new a.ErrorEvent(new Error(`Source layer "${p}" does not exist on source "${l.id}" as specified by style layer "${i.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const i in this._sourceCaches)if(!this._sourceCaches[i].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(i){const l=[];for(const p of i){const _=this._layers[p];_.type!=="custom"&&l.push(_.serialize())}return l}hasTransitions(){if(this.light&&this.light.hasTransition()||this.fog&&this.fog.hasTransition())return!0;for(const i in this._sourceCaches)if(this._sourceCaches[i].hasTransition())return!0;for(const i in this._layers)if(this._layers[i].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(i){return!!this.terrain&&Kd[i.type]}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(i){if(!this._loaded)return;const l=this._changed;if(this._changed){const _=Object.keys(this._updatedLayers),y=Object.keys(this._removedLayers);(_.length||y.length)&&this._updateWorkerLayers(_,y);for(const b in this._updatedSources){const T=this._updatedSources[b];T==="reload"?this._reloadSource(b):T==="clear"&&this._clearSource(b)}this._updateTilesForChangedImages();for(const b in this._updatedPaintProps)this._layers[b].updateTransitions(i);this.light.updateTransitions(i),this.fog&&this.fog.updateTransitions(i),this._resetUpdates()}const p={};for(const _ in this._sourceCaches){const y=this._sourceCaches[_];p[_]=y.used,y.used=!1}for(const _ of this._order){const y=this._layers[_];if(y.recalculate(i,this._availableImages),!y.isHidden(i.zoom)){const T=this._getLayerSourceCache(y);T&&(T.used=!0)}const b=this.map.painter;if(b){const T=y.getProgramIds();if(!T)continue;const C=y.getProgramConfiguration(i.zoom);for(const M of T)b.useProgram(M,C)}}for(const _ in p){const y=this._sourceCaches[_];p[_]!==y.used&&y.getSource().fire(new a.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:y.getSource().id}))}this.light.recalculate(i),this.terrain&&this.terrain.recalculate(i),this.fog&&this.fog.recalculate(i),this.z=i.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),l&&this.fire(new a.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const i=Object.keys(this._changedImages);if(i.length){for(const l in this._sourceCaches)this._sourceCaches[l].reloadTilesForDependencies(["icons","patterns"],i);this._changedImages={}}}_updateWorkerLayers(i,l){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(i),removedIds:l})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(i){if(this._checkLoaded(),Ln(this,a.validateStyle(i)))return!1;(i=a.clone$1(i)).layers=Te(i.layers);const l=function(_,y){if(!_)return[{command:Se.setStyle,args:[y]}];let b=[];try{if(!ze(_.version,y.version))return[{command:Se.setStyle,args:[y]}];ze(_.center,y.center)||b.push({command:Se.setCenter,args:[y.center]}),ze(_.zoom,y.zoom)||b.push({command:Se.setZoom,args:[y.zoom]}),ze(_.bearing,y.bearing)||b.push({command:Se.setBearing,args:[y.bearing]}),ze(_.pitch,y.pitch)||b.push({command:Se.setPitch,args:[y.pitch]}),ze(_.sprite,y.sprite)||b.push({command:Se.setSprite,args:[y.sprite]}),ze(_.glyphs,y.glyphs)||b.push({command:Se.setGlyphs,args:[y.glyphs]}),ze(_.transition,y.transition)||b.push({command:Se.setTransition,args:[y.transition]}),ze(_.light,y.light)||b.push({command:Se.setLight,args:[y.light]}),ze(_.fog,y.fog)||b.push({command:Se.setFog,args:[y.fog]}),ze(_.projection,y.projection)||b.push({command:Se.setProjection,args:[y.projection]});const T={},C=[];(function(P,F,j,N){let $;for($ in F=F||{},P=P||{})P.hasOwnProperty($)&&(F.hasOwnProperty($)||We($,j,N));for($ in F)F.hasOwnProperty($)&&(P.hasOwnProperty($)?ze(P[$],F[$])||(P[$].type==="geojson"&&F[$].type==="geojson"&&Qe(P,F,$)?j.push({command:Se.setGeoJSONSourceData,args:[$,F[$].data]}):Je($,F,j,N)):Me($,F,j))})(_.sources,y.sources,C,T);const M=[];_.layers&&_.layers.forEach(P=>{T[P.source]?b.push({command:Se.removeLayer,args:[P.id]}):M.push(P)});let k=_.terrain;k&&T[k.source]&&(b.push({command:Se.setTerrain,args:[void 0]}),k=void 0),b=b.concat(C),ze(k,y.terrain)||b.push({command:Se.setTerrain,args:[y.terrain]}),function(P,F,j){F=F||[];const N=(P=P||[]).map(mt),$=F.map(mt),ee=P.reduce(qt,{}),V=F.reduce(qt,{}),Y=N.slice(),J=Object.create(null);let H,K,te,de,_e,Be,ke;for(H=0,K=0;H<N.length;H++)te=N[H],V.hasOwnProperty(te)?K++:(j.push({command:Se.removeLayer,args:[te]}),Y.splice(Y.indexOf(te,K),1));for(H=0,K=0;H<$.length;H++)te=$[$.length-1-H],Y[Y.length-1-H]!==te&&(ee.hasOwnProperty(te)?(j.push({command:Se.removeLayer,args:[te]}),Y.splice(Y.lastIndexOf(te,Y.length-K),1)):K++,Be=Y[Y.length-H],j.push({command:Se.addLayer,args:[V[te],Be]}),Y.splice(Y.length-H,0,te),J[te]=!0);for(H=0;H<$.length;H++)if(te=$[H],de=ee[te],_e=V[te],!J[te]&&!ze(de,_e))if(ze(de.source,_e.source)&&ze(de["source-layer"],_e["source-layer"])&&ze(de.type,_e.type)){for(ke in tt(de.layout,_e.layout,j,te,null,Se.setLayoutProperty),tt(de.paint,_e.paint,j,te,null,Se.setPaintProperty),ze(de.filter,_e.filter)||j.push({command:Se.setFilter,args:[te,_e.filter]}),ze(de.minzoom,_e.minzoom)&&ze(de.maxzoom,_e.maxzoom)||j.push({command:Se.setLayerZoomRange,args:[te,_e.minzoom,_e.maxzoom]}),de)de.hasOwnProperty(ke)&&ke!=="layout"&&ke!=="paint"&&ke!=="filter"&&ke!=="metadata"&&ke!=="minzoom"&&ke!=="maxzoom"&&(ke.indexOf("paint.")===0?tt(de[ke],_e[ke],j,te,ke.slice(6),Se.setPaintProperty):ze(de[ke],_e[ke])||j.push({command:Se.setLayerProperty,args:[te,ke,_e[ke]]}));for(ke in _e)_e.hasOwnProperty(ke)&&!de.hasOwnProperty(ke)&&ke!=="layout"&&ke!=="paint"&&ke!=="filter"&&ke!=="metadata"&&ke!=="minzoom"&&ke!=="maxzoom"&&(ke.indexOf("paint.")===0?tt(de[ke],_e[ke],j,te,ke.slice(6),Se.setPaintProperty):ze(de[ke],_e[ke])||j.push({command:Se.setLayerProperty,args:[te,ke,_e[ke]]}))}else j.push({command:Se.removeLayer,args:[te]}),Be=Y[Y.lastIndexOf(te)+1],j.push({command:Se.addLayer,args:[_e,Be]})}(M,y.layers,b)}catch(T){console.warn("Unable to compute style diff:",T),b=[{command:Se.setStyle,args:[y]}]}return b}(this.serialize(),i).filter(_=>!(_.command in Ir));if(l.length===0)return!1;const p=l.filter(_=>!(_.command in Eo));if(p.length>0)throw new Error(`Unimplemented: ${p.map(_=>_.command).join(", ")}.`);return l.forEach(_=>{_.command!=="setTransition"&&this[_.command].apply(this,_.args)}),this.stylesheet=i,this.updateProjection(),!0}addImage(i,l){if(this.getImage(i))return this.fire(new a.ErrorEvent(new Error("An image with this name already exists.")));this.imageManager.addImage(i,l),this._afterImageUpdated(i)}updateImage(i,l){this.imageManager.updateImage(i,l)}getImage(i){return this.imageManager.getImage(i)}removeImage(i){if(!this.getImage(i))return this.fire(new a.ErrorEvent(new Error("No image with this name exists.")));this.imageManager.removeImage(i),this._afterImageUpdated(i)}_afterImageUpdated(i){this._availableImages=this.imageManager.listImages(),this._changedImages[i]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new a.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addSource(i,l,p={}){if(this._checkLoaded(),this.getSource(i)!==void 0)throw new Error("There is already a source with this ID");if(!l.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(l).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(l.type)>=0&&this._validate(a.validateStyle.source,`sources.${i}`,l,null,p))return;this.map&&this.map._collectResourceTiming&&(l.collectResourceTiming=!0);const _=ur(i,l,this.dispatcher,this);_.setEventedParent(this,()=>({isSourceLoaded:this.loaded(),source:_.serialize(),sourceId:i}));const y=b=>{const T=(b?"symbol:":"other:")+i,C=this._sourceCaches[T]=new a.SourceCache(T,_,b);(b?this._symbolSourceCaches:this._otherSourceCaches)[i]=C,C.style=this,C.onAdd(this.map)};y(!1),l.type!=="vector"&&l.type!=="geojson"||y(!0),_.onAdd&&_.onAdd(this.map),this._changed=!0}removeSource(i){this._checkLoaded();const l=this.getSource(i);if(l===void 0)throw new Error("There is no source with this ID");for(const _ in this._layers)if(this._layers[_].source===i)return this.fire(new a.ErrorEvent(new Error(`Source "${i}" cannot be removed while layer "${_}" is using it.`)));if(this.terrain&&this.terrain.get().source===i)return this.fire(new a.ErrorEvent(new Error(`Source "${i}" cannot be removed while terrain is using it.`)));const p=this._getSourceCaches(i);for(const _ of p)delete this._sourceCaches[_.id],delete this._updatedSources[_.id],_.fire(new a.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:_.getSource().id})),_.setEventedParent(null),_.clearTiles();delete this._otherSourceCaches[i],delete this._symbolSourceCaches[i],l.setEventedParent(null),l.onRemove&&l.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(i,l){this._checkLoaded(),this.getSource(i).setData(l),this._changed=!0}getSource(i){const l=this._getSourceCache(i);return l&&l.getSource()}addLayer(i,l,p={}){this._checkLoaded();const _=i.id;if(this.getLayer(_))return void this.fire(new a.ErrorEvent(new Error(`Layer with id "${_}" already exists on this map`)));let y;if(i.type==="custom"){if(Ln(this,a.validateCustomStyleLayer(i)))return;y=a.createStyleLayer(i)}else{if(typeof i.source=="object"&&(this.addSource(_,i.source),i=a.clone$1(i),i=a.extend(i,{source:_})),this._validate(a.validateStyle.layer,`layers.${_}`,i,{arrayIndex:-1},p))return;y=a.createStyleLayer(i),this._validateLayer(y),y.setEventedParent(this,{layer:{id:_}}),this._serializedLayers[y.id]=y.serialize(),this._updateLayerCount(y,!0)}const b=l?this._order.indexOf(l):this._order.length;if(l&&b===-1)return void this.fire(new a.ErrorEvent(new Error(`Layer with id "${l}" does not exist on this map.`)));this._order.splice(b,0,_),this._layerOrderChanged=!0,this._layers[_]=y;const T=this._getLayerSourceCache(y);if(this._removedLayers[_]&&y.source&&T&&y.type!=="custom"){const C=this._removedLayers[_];delete this._removedLayers[_],C.type!==y.type?this._updatedSources[y.source]="clear":(this._updatedSources[y.source]="reload",T.pause())}this._updateLayer(y),y.onAdd&&y.onAdd(this.map),this._updateDrapeFirstLayers()}moveLayer(i,l){if(this._checkLoaded(),this._changed=!0,!this._layers[i])return void this.fire(new a.ErrorEvent(new Error(`The layer '${i}' does not exist in the map's style and cannot be moved.`)));if(i===l)return;const p=this._order.indexOf(i);this._order.splice(p,1);const _=l?this._order.indexOf(l):this._order.length;l&&_===-1?this.fire(new a.ErrorEvent(new Error(`Layer with id "${l}" does not exist on this map.`))):(this._order.splice(_,0,i),this._layerOrderChanged=!0,this._updateDrapeFirstLayers())}removeLayer(i){this._checkLoaded();const l=this._layers[i];if(!l)return void this.fire(new a.ErrorEvent(new Error(`The layer '${i}' does not exist in the map's style and cannot be removed.`)));l.setEventedParent(null),this._updateLayerCount(l,!1);const p=this._order.indexOf(i);this._order.splice(p,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[i]=l,delete this._layers[i],delete this._serializedLayers[i],delete this._updatedLayers[i],delete this._updatedPaintProps[i],l.onRemove&&l.onRemove(this.map),this._updateDrapeFirstLayers()}getLayer(i){return this._layers[i]}hasLayer(i){return i in this._layers}hasLayerType(i){for(const l in this._layers)if(this._layers[l].type===i)return!0;return!1}setLayerZoomRange(i,l,p){this._checkLoaded();const _=this.getLayer(i);_?_.minzoom===l&&_.maxzoom===p||(l!=null&&(_.minzoom=l),p!=null&&(_.maxzoom=p),this._updateLayer(_)):this.fire(new a.ErrorEvent(new Error(`The layer '${i}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(i,l,p={}){this._checkLoaded();const _=this.getLayer(i);if(_){if(!ze(_.filter,l))return l==null?(_.filter=void 0,void this._updateLayer(_)):void(this._validate(a.validateStyle.filter,`layers.${_.id}.filter`,l,{layerType:_.type},p)||(_.filter=a.clone$1(l),this._updateLayer(_)))}else this.fire(new a.ErrorEvent(new Error(`The layer '${i}' does not exist in the map's style and cannot be filtered.`)))}getFilter(i){return a.clone$1(this.getLayer(i).filter)}setLayoutProperty(i,l,p,_={}){this._checkLoaded();const y=this.getLayer(i);y?ze(y.getLayoutProperty(l),p)||(y.setLayoutProperty(l,p,_),this._updateLayer(y)):this.fire(new a.ErrorEvent(new Error(`The layer '${i}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(i,l){const p=this.getLayer(i);if(p)return p.getLayoutProperty(l);this.fire(new a.ErrorEvent(new Error(`The layer '${i}' does not exist in the map's style.`)))}setPaintProperty(i,l,p,_={}){this._checkLoaded();const y=this.getLayer(i);y?ze(y.getPaintProperty(l),p)||(y.setPaintProperty(l,p,_)&&this._updateLayer(y),this._changed=!0,this._updatedPaintProps[i]=!0):this.fire(new a.ErrorEvent(new Error(`The layer '${i}' does not exist in the map's style and cannot be styled.`)))}getPaintProperty(i,l){return this.getLayer(i).getPaintProperty(l)}setFeatureState(i,l){this._checkLoaded();const p=i.source,_=i.sourceLayer,y=this.getSource(p);if(y===void 0)return void this.fire(new a.ErrorEvent(new Error(`The source '${p}' does not exist in the map's style.`)));const b=y.type;if(b==="geojson"&&_)return void this.fire(new a.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(b==="vector"&&!_)return void this.fire(new a.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));i.id===void 0&&this.fire(new a.ErrorEvent(new Error("The feature id parameter must be provided.")));const T=this._getSourceCaches(p);for(const C of T)C.setFeatureState(_,i.id,l)}removeFeatureState(i,l){this._checkLoaded();const p=i.source,_=this.getSource(p);if(_===void 0)return void this.fire(new a.ErrorEvent(new Error(`The source '${p}' does not exist in the map's style.`)));const y=_.type,b=y==="vector"?i.sourceLayer:void 0;if(y==="vector"&&!b)return void this.fire(new a.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(l&&typeof i.id!="string"&&typeof i.id!="number")return void this.fire(new a.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const T=this._getSourceCaches(p);for(const C of T)C.removeFeatureState(b,i.id,l)}getFeatureState(i){this._checkLoaded();const l=i.source,p=i.sourceLayer,_=this.getSource(l);if(_!==void 0){if(_.type!=="vector"||p)return i.id===void 0&&this.fire(new a.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(l)[0].getFeatureState(p,i.id);this.fire(new a.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new a.ErrorEvent(new Error(`The source '${l}' does not exist in the map's style.`)))}getTransition(){return a.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){const i={};for(const l in this._sourceCaches){const p=this._sourceCaches[l].getSource();i[p.id]||(i[p.id]=p.serialize())}return a.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.stylesheet.terrain,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:i,layers:this._serializeLayers(this._order)},l=>l!==void 0)}_updateLayer(i){this._updatedLayers[i.id]=!0;const l=this._getLayerSourceCache(i);i.source&&!this._updatedSources[i.source]&&l&&l.getSource().type!=="raster"&&(this._updatedSources[i.source]="reload",l.pause()),this._changed=!0,i.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(i){const l=b=>this._layers[b].type==="fill-extrusion",p={},_=[];for(let b=this._order.length-1;b>=0;b--){const T=this._order[b];if(l(T)){p[T]=b;for(const C of i){const M=C[T];if(M)for(const k of M)_.push(k)}}}_.sort((b,T)=>T.intersectionZ-b.intersectionZ);const y=[];for(let b=this._order.length-1;b>=0;b--){const T=this._order[b];if(l(T))for(let C=_.length-1;C>=0;C--){const M=_[C].feature;if(p[M.layer.id]<b)break;y.push(M),_.pop()}else for(const C of i){const M=C[T];if(M)for(const k of M)y.push(k.feature)}}return y}queryRenderedFeatures(i,l,p){l&&l.filter&&this._validate(a.validateStyle.filter,"queryRenderedFeatures.filter",l.filter,null,l);const _={};if(l&&l.layers){if(!Array.isArray(l.layers))return this.fire(new a.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const C of l.layers){const M=this._layers[C];if(!M)return this.fire(new a.ErrorEvent(new Error(`The layer '${C}' does not exist in the map's style and cannot be queried for features.`))),[];_[M.source]=!0}}const y=[];l.availableImages=this._availableImages;const b=l&&l.layers?l.layers.some(C=>{const M=this.getLayer(C);return M&&M.is3D()}):this.has3DLayers(),T=As.createFromScreenPoints(i,p);for(const C in this._sourceCaches){const M=this._sourceCaches[C].getSource().id;l.layers&&!_[M]||y.push(D(this._sourceCaches[C],this._layers,this._serializedLayers,T,l,p,b,!!this.map._showQueryGeometry))}return this.placement&&y.push(function(C,M,k,P,F,j,N){const $={},ee=j.queryRenderedSymbols(P),V=[];for(const Y of Object.keys(ee).map(Number))V.push(N[Y]);V.sort(G);for(const Y of V){const J=Y.featureIndex.lookupSymbolFeatures(ee[Y.bucketInstanceId],M,Y.bucketIndex,Y.sourceLayerIndex,F.filter,F.layers,F.availableImages,C);for(const H in J){const K=$[H]=$[H]||[],te=J[H];te.sort((de,_e)=>{const Be=Y.featureSortOrder;if(Be){const ke=Be.indexOf(de.featureIndex);return Be.indexOf(_e.featureIndex)-ke}return _e.featureIndex-de.featureIndex});for(const de of te)K.push(de)}}for(const Y in $)$[Y].forEach(J=>{const H=J.feature,K=k(C[Y]).getFeatureState(H.layer["source-layer"],H.id);H.source=H.layer.source,H.layer["source-layer"]&&(H.sourceLayer=H.layer["source-layer"]),H.state=K});return $}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),T.screenGeometry,l,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(y)}querySourceFeatures(i,l){l&&l.filter&&this._validate(a.validateStyle.filter,"querySourceFeatures.filter",l.filter,null,l);const p=this._getSourceCaches(i);let _=[];for(const y of p)_=_.concat(B(y,l));return _}addSourceType(i,l,p){return ir.getSourceType(i)?p(new Error(`A source type called "${i}" already exists.`)):(ir.setSourceType(i,l),l.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:i,url:l.workerSourceURL},p):p(null,null))}getLight(){return this.light.getLight()}setLight(i,l={}){this._checkLoaded();const p=this.light.getLight();let _=!1;for(const b in i)if(!ze(i[b],p[b])){_=!0;break}if(!_)return;const y={now:a.exported.now(),transition:a.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(i,l),this.light.updateTransitions(y)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(i,l=1){if(this._checkLoaded(),!i)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);if(l===1){if(typeof i.source=="object"){const p="terrain-dem-src";this.addSource(p,i.source),i=a.clone$1(i),i=a.extend(i,{source:p})}if(this._validate(a.validateStyle.terrain,"terrain",i))return}if(!this.terrain||this.terrain&&l!==this.terrain.drapeRenderMode)this._createTerrain(i,l);else{const p=this.terrain,_=p.get();for(const y in i)if(!ze(i[y],_[y])){p.set(i),this.stylesheet.terrain=i;const b={now:a.exported.now(),transition:a.extend({duration:0},this.stylesheet.transition)};p.updateTransitions(b);break}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(i){const l=this.fog=new Zl(i,this.map.transform);this.stylesheet.fog=i;const p={now:a.exported.now(),transition:a.extend({duration:0},this.stylesheet.transition)};l.updateTransitions(p)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const i of this.map._markers)i._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(i){if(this._checkLoaded(),!i)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const l=this.fog,p=l.get();for(const _ in i)if(!ze(i[_],p[_])){l.set(i),this.stylesheet.fog=i;const y={now:a.exported.now(),transition:a.extend({duration:0},this.stylesheet.transition)};l.updateTransitions(y);break}}else this._createFog(i);this._markersNeedUpdate=!0}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const i=this._order.filter(p=>this.isLayerDraped(this._layers[p])),l=this._order.filter(p=>!this.isLayerDraped(this._layers[p]));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...i),this._drapedFirstOrder.push(...l)}_createTerrain(i,l){const p=this.terrain=new _a(i,l);this.stylesheet.terrain=i,this.dispatcher.broadcast("enableTerrain",!0),this._force3DLayerUpdate();const _={now:a.exported.now(),transition:a.extend({duration:0},this.stylesheet.transition)};p.updateTransitions(_)}_force3DLayerUpdate(){for(const i in this._layers){const l=this._layers[i];l.type==="fill-extrusion"&&this._updateLayer(l)}}_forceSymbolLayerUpdate(){for(const i in this._layers){const l=this._layers[i];l.type==="symbol"&&this._updateLayer(l)}}_validate(i,l,p,_,y={}){return(!y||y.validate!==!1)&&Ln(this,i.call(a.validateStyle,a.extend({key:l,style:this.serialize(),value:p,styleSpec:a.spec},_)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),a.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const i in this._layers)this._layers[i].setEventedParent(null);for(const i in this._sourceCaches)this._sourceCaches[i].clearTiles(),this._sourceCaches[i].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(i){const l=this._getSourceCaches(i);for(const p of l)p.clearTiles()}_reloadSource(i){const l=this._getSourceCaches(i);for(const p of l)p.resume(),p.reload()}_updateSources(i){for(const l in this._sourceCaches)this._sourceCaches[l].update(i)}_generateCollisionBoxes(){for(const i in this._sourceCaches){const l=this._sourceCaches[i];l.resume(),l.reload()}}_updatePlacement(i,l,p,_,y=!1){let b=!1,T=!1;const C={};for(const M of this._order){const k=this._layers[M];if(k.type!=="symbol")continue;if(!C[k.source]){const F=this._getLayerSourceCache(k);if(!F)continue;C[k.source]=F.getRenderableIds(!0).map(j=>F.getTileByID(j)).sort((j,N)=>N.tileID.overscaledZ-j.tileID.overscaledZ||(j.tileID.isLessThan(N.tileID)?-1:1))}const P=this.crossTileSymbolIndex.addLayer(k,C[k.source],i.center.lng,i.projection);b=b||P}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),y=y||this._layerOrderChanged||p===0,this._layerOrderChanged&&this.fire(new a.Event("neworder")),(y||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(a.exported.now(),i.zoom))&&(this.pauseablePlacement=new xt(i,this._order,y,l,p,_,this.placement,this.fog&&i.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,C),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(a.exported.now()),T=!0),b&&this.pauseablePlacement.placement.setStale()),T||b)for(const M of this._order){const k=this._layers[M];k.type==="symbol"&&this.placement.updateLayerOpacities(k,C[k.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(a.exported.now())}_releaseSymbolFadeTiles(){for(const i in this._sourceCaches)this._sourceCaches[i].releaseSymbolFadeTiles()}getImages(i,l,p){this.imageManager.getImages(l.icons,p),this._updateTilesForChangedImages();const _=y=>{y&&y.setDependencies(l.tileID.key,l.type,l.icons)};_(this._otherSourceCaches[l.source]),_(this._symbolSourceCaches[l.source])}getGlyphs(i,l,p){this.glyphManager.getGlyphs(l.stacks,p)}getResource(i,l,p){return a.makeRequest(l,p)}_getSourceCache(i){return this._otherSourceCaches[i]}_getLayerSourceCache(i){return i.type==="symbol"?this._symbolSourceCaches[i.source]:this._otherSourceCaches[i.source]}_getSourceCaches(i){const l=[];return this._otherSourceCaches[i]&&l.push(this._otherSourceCaches[i]),this._symbolSourceCaches[i]&&l.push(this._symbolSourceCaches[i]),l}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}ir.getSourceType=function(d){return Ms[d]},ir.setSourceType=function(d,i){Ms[d]=i},ir.registerForPluginStateChange=a.registerForPluginStateChange;var Ma=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#define EXTENT 8192.0
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}
#endif`,Ps="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}";let Ls={},Rs={};Ls=lt("",`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
#ifdef TERRAIN_DEM_FLOAT_FORMAT
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;
#else
uniform sampler2D u_dem;uniform sampler2D u_dem_prev;
#endif
uniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));
#ifdef TERRAIN_DEM_NEAREST_FILTER
return u_exaggeration*tl;
#endif
float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {return currentElevation(apos);}
#endif
float unpack_depth(vec4 rgba_depth)
{const vec4 bit_shift=vec4(1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
float tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;
#else
vec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);
#endif
return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;vec4 bounds=vec4(d,vec2(1.0)-d);h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,!0),Rs=lt(`#ifdef FOG
uniform float u_fog_temporal_offset;float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,`#ifdef FOG
uniform mat4 u_fog_matrix;vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,!0);const At=lt(`
highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef TERRAIN
highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(256.0*256.0*256.0,256.0*256.0,256.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/256.0,1.0/256.0,1.0/256.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#endif`,`
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#if defined(PROJECTION_GLOBE_VIEW) && !defined(PROJECTED_POS_ON_VIEWPORT)
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {
#if defined(PROJECTION_GLOBE_VIEW) && !defined(PROJECTED_POS_ON_VIEWPORT)
return mix(globe,mercator,t);
#else
return globe;
#endif
}
#ifdef PROJECTION_GLOBE_VIEW
mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered.`),ka=Ma;var Yl={background:lt(`uniform vec4 u_color;uniform float u_opacity;void main() {vec4 out_color=u_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:lt(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_mix);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:lt(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
gl_FragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);
#ifdef PROJECTION_GLOBE_VIEW
vec2 scaled_extrude=extrude*a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=scaled_extrude.x*surface_vectors[0]+scaled_extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);vec4 world_center=vec4(pos,1);
#else 
mat3 surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);vec4 world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
#if defined(SCALE_WITH_MAP) && defined(PROJECTION_GLOBE_VIEW)
view_scale*=a_scale;
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);vec4 occlusion_world_center=vec4(circle_center,cantilevered_height,1);vec4 occlusion_projected_center=u_matrix*occlusion_world_center;
#else
vec4 occlusion_world_center=world_center;vec4 occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:lt("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:lt(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);
#ifdef PROJECTION_GLOBE_VIEW
extrude*=a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
vec3 pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:lt(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:lt("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:lt("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}",`attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:lt("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}",`attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;
#endif
varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:lt(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:lt(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:lt(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:lt(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:lt(`varying vec4 v_color;void main() {vec4 color=v_color;
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 pos=vec3(pos_nx.xy,h);
#else
vec3 pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(pos.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.rgb+=clamp(color.rgb*directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionPattern:lt(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);out_color=out_color*v_lighting;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 p=vec3(pos_nx.xy,h);
#else
vec3 p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),hillshadePrepare:lt(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
return texture2D(u_image,coord).a/4.0;
#else
vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;
#endif
}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos);float f=getElevation(v_pos+vec2(epsilon.x,0));float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float h=getElevation(v_pos+vec2(0,epsilon.y));float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:lt(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef FOG
gl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:lt(`uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;uniform float u_mix;uniform vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;varying highp vec2 v_uv;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist_a=texture2D(u_dash_image,v_tex_a).a;float sdfdist_b=texture2D(u_dash_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfwidth=min(dash_from.z*u_scale.y,dash_to.z*u_scale.z);float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/sdfwidth;alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
#ifdef RENDER_LINE_GRADIENT
vec4 out_color=texture2D(u_gradient_image,v_uv);
#else
vec4 out_color=color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef RENDER_LINE_ALPHA_DISCARD
if (alpha < u_alpha_discard_threshold) {discard;}
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define EXTRUDE_SCALE 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;
#ifdef RENDER_LINE_GRADIENT
attribute vec3 a_packed;
#else
attribute float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform mediump vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;varying highp vec2 v_uv;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_GRADIENT
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];float a_linesofar=a_packed[2];highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);
#endif
#ifdef RENDER_LINE_DASH
float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;float scaleA=dash_from.z==0.0 ? 0.0 : tileZoomRatio/(dash_from.z*fromScale);float scaleB=dash_to.z==0.0 ? 0.0 : tileZoomRatio/(dash_to.z*toScale);float heightA=dash_from.y;float heightB=dash_to.y;v_tex_a=vec2(a_linesofar*scaleA/floorwidth,(-normal.y*heightA+dash_from.x+0.5)/u_texsize.y);v_tex_b=vec2(a_linesofar*scaleB/floorwidth,(-normal.y*heightB+dash_to.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:lt(`uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:lt(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef FOG
out_color=fog_dither(fog_apply(out_color,v_fog_pos));
#endif
gl_FragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),symbolIcon:lt(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}`),symbolSDF:lt(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_tile_id;uniform float u_zoom_transition;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}`),symbolTextAndIcon:lt(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}`),terrainRaster:lt(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
void main() {vec4 color=texture2D(u_image0,v_pos0);
#ifdef FOG
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
const float skirtOffset=24575.0;const float wireframeOffset=0.00015;void main() {v_pos0=a_texture_pos/8192.0;float skirt=float(a_pos.x >=skirtOffset);float elevation=elevation(a_texture_pos)-skirt*u_skirt_height;
#ifdef TERRAIN_WIREFRAME
elevation+=u_skirt_height*u_skirt_height*wireframeOffset;
#endif
vec2 decodedPos=a_pos-vec2(skirt*skirtOffset,0.0);gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
}`),terrainDepth:lt(`#ifdef GL_ES
precision highp float;
#endif
varying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying float v_depth;void main() {float elevation=elevation(a_texture_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:lt(`
varying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,Ps),skyboxGradient:lt(`varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,Ps),skyboxCapture:lt(`
varying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;
#ifdef GL_ES
precision highp float;
#endif
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}`,"attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:lt(`uniform sampler2D u_image0;varying vec2 v_pos0;void main() {gl_FragColor=texture2D(u_image0,v_pos0);
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_proj_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;attribute vec3 a_globe_pos;attribute vec2 a_merc_pos;attribute vec2 a_uv;varying vec2 v_pos0;const float wireframeOffset=1e3;void main() {v_pos0=a_uv;vec2 uv=a_uv*EXTENT;vec4 up_vector=vec4(elevationVector(uv),1.0);float height=elevation(uv);
#ifdef TERRAIN_WIREFRAME
height+=wireframeOffset;
#endif
vec4 globe=u_globe_matrix*vec4(a_globe_pos+up_vector.xyz*height,1.0);vec4 mercator=vec4(0.0);if (u_zoom_transition > 0.0) {mercator=vec4(a_merc_pos,height,1.0);mercator.xy-=u_merc_center;mercator.x=wrap(mercator.x,-0.5,0.5);mercator=u_merc_matrix*mercator;}vec3 position=mix(globe.xyz,mercator.xyz,u_zoom_transition);gl_Position=u_proj_matrix*vec4(position,1.0);}`),globeAtmosphere:lt(`uniform vec2 u_center;uniform float u_radius;uniform vec2 u_screen_size;uniform float u_opacity;uniform highp float u_fadeout_range;uniform vec3 u_start_color;uniform vec3 u_end_color;uniform float u_pixel_ratio;void main() {highp vec2 fragCoord=gl_FragCoord.xy/u_pixel_ratio;fragCoord.y=u_screen_size.y-fragCoord.y;float distFromCenter=length(fragCoord-u_center);float normDistFromCenter=length(fragCoord-u_center)/u_radius;if (normDistFromCenter < 1.0)
discard;float t=clamp(1.0-sqrt(normDistFromCenter-1.0)/u_fadeout_range,0.0,1.0);vec3 color=mix(u_start_color,u_end_color,1.0-t);gl_FragColor=vec4(color*t*u_opacity,u_opacity);}`,"attribute vec3 a_pos;void main() {gl_Position=vec4(a_pos,1.0);}")};function lt(d,i,l){const p=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,_=/uniform (highp |mediump |lowp )?([\w]+) ([\w]+)([\s]*)([\w]*)/g,y=i.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),b=d.match(_),T=i.match(_),C=Ma.match(_);let M=T?T.concat(b):b;l||(Ls.staticUniforms&&(M=Ls.staticUniforms.concat(M)),Rs.staticUniforms&&(M=Rs.staticUniforms.concat(M))),M&&(M=M.concat(C));const k={};return{fragmentSource:d=d.replace(p,(P,F,j,N,$)=>(k[$]=!0,F==="define"?`
#ifndef HAS_UNIFORM_u_${$}
varying ${j} ${N} ${$};
#else
uniform ${j} ${N} u_${$};
#endif
`:`
#ifdef HAS_UNIFORM_u_${$}
    ${j} ${N} ${$} = u_${$};
#endif
`)),vertexSource:i=i.replace(p,(P,F,j,N,$)=>{const ee=N==="float"?"vec2":"vec4",V=$.match(/color/)?"color":ee;return k[$]?F==="define"?`
#ifndef HAS_UNIFORM_u_${$}
uniform lowp float u_${$}_t;
attribute ${j} ${ee} a_${$};
varying ${j} ${N} ${$};
#else
uniform ${j} ${N} u_${$};
#endif
`:V==="vec4"?`
#ifndef HAS_UNIFORM_u_${$}
    ${$} = a_${$};
#else
    ${j} ${N} ${$} = u_${$};
#endif
`:`
#ifndef HAS_UNIFORM_u_${$}
    ${$} = unpack_mix_${V}(a_${$}, u_${$}_t);
#else
    ${j} ${N} ${$} = u_${$};
#endif
`:F==="define"?`
#ifndef HAS_UNIFORM_u_${$}
uniform lowp float u_${$}_t;
attribute ${j} ${ee} a_${$};
#else
uniform ${j} ${N} u_${$};
#endif
`:V==="vec4"?`
#ifndef HAS_UNIFORM_u_${$}
    ${j} ${N} ${$} = a_${$};
#else
    ${j} ${N} ${$} = u_${$};
#endif
`:`
#ifndef HAS_UNIFORM_u_${$}
    ${j} ${N} ${$} = unpack_mix_${V}(a_${$}, u_${$}_t);
#else
    ${j} ${N} ${$} = u_${$};
#endif
`}),staticAttributes:y,staticUniforms:M}}class Ar{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(i,l,p,_,y,b,T,C){this.context=i;let M=this.boundPaintVertexBuffers.length!==_.length;for(let k=0;!M&&k<_.length;k++)this.boundPaintVertexBuffers[k]!==_[k]&&(M=!0);i.extVertexArrayObject&&this.vao&&this.boundProgram===l&&this.boundLayoutVertexBuffer===p&&!M&&this.boundIndexBuffer===y&&this.boundVertexOffset===b&&this.boundDynamicVertexBuffer===T&&this.boundDynamicVertexBuffer2===C?(i.bindVertexArrayOES.set(this.vao),T&&T.bind(),y&&y.dynamicDraw&&y.bind(),C&&C.bind()):this.freshBind(l,p,_,y,b,T,C)}freshBind(i,l,p,_,y,b,T){let C;const M=i.numAttributes,k=this.context,P=k.gl;if(k.extVertexArrayObject)this.vao&&this.destroy(),this.vao=k.extVertexArrayObject.createVertexArrayOES(),k.bindVertexArrayOES.set(this.vao),C=0,this.boundProgram=i,this.boundLayoutVertexBuffer=l,this.boundPaintVertexBuffers=p,this.boundIndexBuffer=_,this.boundVertexOffset=y,this.boundDynamicVertexBuffer=b,this.boundDynamicVertexBuffer2=T;else{C=k.currentNumAttributes||0;for(let F=M;F<C;F++)P.disableVertexAttribArray(F)}l.enableAttributes(P,i);for(const F of p)F.enableAttributes(P,i);b&&b.enableAttributes(P,i),T&&T.enableAttributes(P,i),l.bind(),l.setVertexAttribPointers(P,i,y);for(const F of p)F.bind(),F.setVertexAttribPointers(P,i,y);b&&(b.bind(),b.setVertexAttribPointers(P,i,y)),_&&_.bind(),T&&(T.bind(),T.setVertexAttribPointers(P,i,y)),k.currentNumAttributes=M}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function Bh(d,i){const l=Math.pow(2,i.canonical.z),p=i.canonical.y;return[new a.MercatorCoordinate(0,p/l).toLngLat().lat,new a.MercatorCoordinate(0,(p+1)/l).toLngLat().lat]}function Da(d,i,l,p,_,y,b){const T=d.context,C=T.gl,M=l.fbo;if(!M)return;d.prepareDrawTile(i);const k=d.useProgram("hillshade");T.activeTexture.set(C.TEXTURE0),C.bindTexture(C.TEXTURE_2D,M.colorAttachment.get());const P=(($,ee,V,Y)=>{const J=V.paint.get("hillshade-shadow-color"),H=V.paint.get("hillshade-highlight-color"),K=V.paint.get("hillshade-accent-color");let te=V.paint.get("hillshade-illumination-direction")*(Math.PI/180);V.paint.get("hillshade-illumination-anchor")==="viewport"&&(te-=$.transform.angle);const de=!$.options.moving;return{u_matrix:Y||$.transform.calculateProjMatrix(ee.tileID.toUnwrapped(),de),u_image:0,u_latrange:Bh(0,ee.tileID),u_light:[V.paint.get("hillshade-exaggeration"),te],u_shadow:J,u_highlight:H,u_accent:K}})(d,l,p,d.terrain?i.projMatrix:null);d.prepareDrawProgram(T,k,i.toUnwrapped());const{tileBoundsBuffer:F,tileBoundsIndexBuffer:j,tileBoundsSegments:N}=d.getTileBoundsBuffers(l);k.draw(T,C.TRIANGLES,_,y,b,a.CullFaceMode.disabled,P,p.id,F,j,N)}function fi(d,i,l){if(!i.needsDEMTextureUpload)return;const p=d.context,_=p.gl;p.pixelStoreUnpackPremultiplyAlpha.set(!1),i.demTexture=i.demTexture||d.getTileTexture(l.stride);const y=l.getPixels();i.demTexture?i.demTexture.update(y,{premultiply:!1}):i.demTexture=new a.Texture(p,y,_.RGBA,{premultiply:!1}),i.needsDEMTextureUpload=!1}function So(d,i,l,p,_,y){const b=d.context,T=b.gl;if(!i.dem)return;const C=i.dem;if(b.activeTexture.set(T.TEXTURE1),fi(d,i,C),!i.demTexture)return;i.demTexture.bind(T.NEAREST,T.CLAMP_TO_EDGE);const M=C.dim;b.activeTexture.set(T.TEXTURE0);let k=i.fbo;if(!k){const N=new a.Texture(b,{width:M,height:M,data:null},T.RGBA);N.bind(T.LINEAR,T.CLAMP_TO_EDGE),k=i.fbo=b.createFramebuffer(M,M,!0),k.colorAttachment.set(N.texture)}b.bindFramebuffer.set(k.framebuffer),b.viewport.set([0,0,M,M]);const{tileBoundsBuffer:P,tileBoundsIndexBuffer:F,tileBoundsSegments:j}=d.getMercatorTileBoundsBuffers();d.useProgram("hillshadePrepare").draw(b,T.TRIANGLES,p,_,y,a.CullFaceMode.disabled,((N,$)=>{const ee=$.stride,V=a.create();return a.ortho(V,0,a.EXTENT,-a.EXTENT,0,0,1),a.translate(V,V,[0,-a.EXTENT,0]),{u_matrix:V,u_image:1,u_dimension:[ee,ee],u_zoom:N.overscaledZ,u_unpack:$.unpackVector}})(i.tileID,C),l.id,P,F,j),i.needsHillshadePrepare=!1}const Rn=(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_image0:new a.Uniform1i(d,i.u_image0),u_skirt_height:new a.Uniform1f(d,i.u_skirt_height)}),Ei=(d,i)=>({u_matrix:d,u_image0:0,u_skirt_height:i}),za=(d,i,l,p,_)=>({u_proj_matrix:Float32Array.from(d),u_globe_matrix:i,u_merc_matrix:l,u_zoom_transition:p,u_merc_center:_,u_image0:0});function Cr(d,i){return d!=null&&i!=null&&!(!d.hasData()||!i.hasData())&&d.demTexture!=null&&i.demTexture!=null&&d.tileID.key!==i.tileID.key}const nn=new class{constructor(){this.operations={}}newMorphing(d,i,l,p,_){if(d in this.operations){const y=this.operations[d];y.to.tileID.key!==l.tileID.key&&(y.queued=l)}else this.operations[d]={startTime:p,phase:0,duration:_,from:i,to:l,queued:null}}getMorphValuesForProxy(d){if(!(d in this.operations))return null;const i=this.operations[d];return{from:i.from,to:i.to,phase:i.phase}}update(d){for(const i in this.operations){const l=this.operations[i];for(l.phase=(d-l.startTime)/l.duration;l.phase>=1||!this._validOp(l);)if(!this._nextOp(l,d)){delete this.operations[i];break}}}_nextOp(d,i){return!!d.queued&&(d.from=d.to,d.to=d.queued,d.queued=null,d.phase=0,d.startTime=i,!0)}_validOp(d){return d.from.hasData()&&d.to.hasData()}},is={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function Yd(d,i){const l=1<<d.z;return!i&&(d.x===0||d.x===l-1)||d.y===0||d.y===l-1}const sn=d=>({u_matrix:d});function Fh(d,i,l,p,_){if(_>0){const y=a.exported.now(),b=(y-d.timeAdded)/_,T=i?(y-i.timeAdded)/_:-1,C=l.getSource(),M=p.coveringZoomLevel({tileSize:C.tileSize,roundZoom:C.roundZoom}),k=!i||Math.abs(i.tileID.overscaledZ-M)>Math.abs(d.tileID.overscaledZ-M),P=k&&d.refreshedUponExpiration?1:a.clamp(k?b:1-T,0,1);return d.refreshedUponExpiration&&b>=1&&(d.refreshedUponExpiration=!1),i?{opacity:1,mix:1-P}:{opacity:P,mix:0}}return{opacity:1,mix:0}}class Oh extends a.SourceCache{constructor(i){const l={type:"raster-dem",maxzoom:i.transform.maxZoom},p=new Hr(se(),null),_=ur("mock-dem",l,p,i.style);super("mock-dem",_,!1),_.setEventedParent(this),this._sourceLoaded=!0}_loadTile(i,l){i.state="loaded",l(null)}}class dr extends a.SourceCache{constructor(i){const l=ur("proxy",{type:"geojson",maxzoom:i.transform.maxZoom},new Hr(se(),null),i.style);super("proxy",l,!1),l.setEventedParent(this),this.map=this.getSource().map=i,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(i,l,p){if(i.freezeTileCoverage)return;this.transform=i;const _=i.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((y,b)=>{if(y[b.key]="",!this._tiles[b.key]){const T=new a.Tile(b,this._source.tileSize*b.overscaleFactor(),i.tileZoom);T.state="loaded",this._tiles[b.key]=T}return y},{});for(const y in this._tiles)y in _||(this.freeFBO(y),this._tiles[y].unloadVectorData(),delete this._tiles[y])}freeFBO(i){const l=this.proxyCachedFBO[i];if(l!==void 0){const p=Object.values(l);this.renderCachePool.push(...p),delete this.proxyCachedFBO[i]}}deallocRenderCache(){this.renderCache.forEach(i=>i.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Io extends a.OverscaledTileID{constructor(i,l,p){super(i.overscaledZ,i.wrap,i.canonical.z,i.canonical.x,i.canonical.y),this.proxyTileKey=l,this.projMatrix=p}}class Bn extends a.Elevation{constructor(i,l){super(),this.painter=i,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[p,_,y]=function(C){const M=new a.StructArrayLayout4i8,k=new a.StructArrayLayout3ui6,P=131;M.reserve(17161),k.reserve(33800);const F=a.EXTENT/128,j=a.EXTENT+F/2,N=j+F;for(let ee=-F;ee<N;ee+=F)for(let V=-F;V<N;V+=F){const Y=V<0||V>j||ee<0||ee>j?24575:0,J=a.clamp(Math.round(V),0,a.EXTENT),H=a.clamp(Math.round(ee),0,a.EXTENT);M.emplaceBack(J+Y,H,J,H)}const $=(ee,V)=>{const Y=V*P+ee;k.emplaceBack(Y+1,Y,Y+P),k.emplaceBack(Y+P,Y+P+1,Y+1)};for(let ee=1;ee<129;ee++)for(let V=1;V<129;V++)$(V,ee);return[0,129].forEach(ee=>{for(let V=0;V<130;V++)$(V,ee),$(ee,V)}),[M,k,32768]}(),b=i.context;this.gridBuffer=b.createVertexBuffer(p,a.boundsAttributes.members),this.gridIndexBuffer=b.createIndexBuffer(_),this.gridSegments=a.SegmentVector.simpleSegment(0,0,p.length,_.length),this.gridNoSkirtSegments=a.SegmentVector.simpleSegment(0,0,p.length,y),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new dr(l.map),this.orthoMatrix=a.create(),a.ortho(this.orthoMatrix,0,a.EXTENT,0,a.EXTENT,0,1);const T=b.gl;this._overlapStencilMode=new a.StencilMode({func:T.GEQUAL,mask:255},0,255,T.KEEP,T.KEEP,T.REPLACE),this._previousZoom=i.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=l,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Oh(l.map)}set style(i){i.on("data",this._onStyleDataEvent.bind(this)),i.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=i,this._checkRenderCacheEfficiency()}update(i,l,p){if(i&&i.terrain){this._style!==i&&(this.style=i),this.enabled=!0;const _=i.terrain.properties;this.sourceCache=i.terrain.drapeRenderMode===0?this._mockSourceCache:i._getSourceCache(_.get("source")),this._exaggeration=_.get("exaggeration");const y=()=>{this.sourceCache.used&&a.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const b=this.getScaledDemTileSize();this.sourceCache.update(l,b,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,y(),this._initializing=!0),y(),l.updateElevation(!p),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(l),this._emptyDEMTextureDirty=!0}else this._disable()}resetTileLookupCache(i){this._findCoveringTileCache[i]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_checkRenderCacheEfficiency(){const i=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||i.efficiency!==100&&a.warnOnce(`Terrain render cache efficiency is not optimal (${i.efficiency}%) and performance
                may be affected negatively, consider placing all background, fill and line layers before layer
                with id '${i.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(i){i.coord&&i.dataType==="source"?this._clearRenderCacheForTile(i.sourceCacheId,i.coord):i.dataType==="style"&&(this._invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const i in this._style._sourceCaches)this._style._sourceCaches[i].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(i=>i.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),delete this._depthFBO,delete this._depthTexture)}_source(){return this.enabled?this.sourceCache:null}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const i=2*this.proxySourceCache.getSource().tileSize;return[i,i]}set useVertexMorphing(i){this._useVertexMorphing=i}updateTileBinding(i){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const l=this.proxySourceCache,p=this.painter.transform;this._initializing&&(this._initializing=p._centerAltitude===0&&this.getAtPointOrZero(a.MercatorCoordinate.fromLngLat(p.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const _=this.proxyCoords=l.getIds().map(C=>{const M=l.getTileByID(C).tileID;return M.projMatrix=p.calculateProjMatrix(M.toUnwrapped()),M});(function(C,M){const k=M.transform.pointCoordinate(M.transform.getCameraPoint()),P=new a.pointGeometry(k.x,k.y);C.sort((F,j)=>{if(j.overscaledZ-F.overscaledZ)return j.overscaledZ-F.overscaledZ;const N=new a.pointGeometry(F.canonical.x+(1<<F.canonical.z)*F.wrap,F.canonical.y),$=new a.pointGeometry(j.canonical.x+(1<<j.canonical.z)*j.wrap,j.canonical.y),ee=P.mult(1<<F.canonical.z);return ee.x-=.5,ee.y-=.5,ee.distSqr(N)-ee.distSqr($)})})(_,this.painter),this._previousZoom=p.zoom;const y=this.proxyToSource||{};this.proxyToSource={},_.forEach(C=>{this.proxyToSource[C.key]={}}),this.terrainTileForTile={};const b=this._style._sourceCaches;for(const C in b){const M=b[C];if(!M.used||(M!==this.sourceCache&&this.resetTileLookupCache(M.id),this._setupProxiedCoordsForOrtho(M,i[C],y),M.usedForTerrain))continue;const k=i[C];M.getSource().reparseOverscaled&&this._assignTerrainTiles(k)}this.proxiedCoords[l.id]=_.map(C=>new Io(C,C.key,this.orthoMatrix)),this._assignTerrainTiles(_),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(y),this.renderingToTexture=!1,this._updateTimestamp=a.exported.now();const T={};this._visibleDemTiles=[];for(const C of this.proxyCoords){const M=this.terrainTileForTile[C.key];if(!M)continue;const k=M.tileID.key;k in T||(this._visibleDemTiles.push(M),T[k]=k)}}_assignTerrainTiles(i){this._initializing||i.forEach(l=>{if(this.terrainTileForTile[l.key])return;const p=this._findTileCoveringTileID(l,this.sourceCache);p&&(this.terrainTileForTile[l.key]=p)})}_prepareDEMTextures(){const i=this.painter.context,l=i.gl;for(const p in this.terrainTileForTile){const _=this.terrainTileForTile[p],y=_.dem;!y||_.demTexture&&!_.needsDEMTextureUpload||(i.activeTexture.set(l.TEXTURE1),fi(this.painter,_,y))}}_prepareDemTileUniforms(i,l,p,_){if(!l||l.demTexture==null)return!1;const y=i.tileID.canonical,b=Math.pow(2,l.tileID.canonical.z-y.z),T=_||"";return p[`u_dem_tl${T}`]=[y.x*b%1,y.y*b%1],p[`u_dem_scale${T}`]=b,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const i=this.painter.context,l=i.gl;if(!this._emptyDepthBufferTexture){const p={width:1,height:1,data:new Uint8Array([255,255,255,255])};this._emptyDepthBufferTexture=new a.Texture(i,p,l.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let i=0;const l=this._visibleDemTiles.reduce((p,_)=>{if(!_.dem)return p;const y=_.dem.tree.minimums[0];return y>0&&i++,p+y},0);return i?l/i:0}_updateEmptyDEMTexture(){const i=this.painter.context,l=i.gl;i.activeTexture.set(l.TEXTURE2);const p=this._getLoadedAreaMinimum(),_={width:1,height:1,data:new Uint8Array(a.DEMData.pack(p,this.sourceCache.getSource().encoding))};this._emptyDEMTextureDirty=!1;let y=this._emptyDEMTexture;return y?y.update(_,{premultiply:!1}):y=this._emptyDEMTexture=new a.Texture(i,_,l.RGBA,{premultiply:!1}),y}setupElevationDraw(i,l,p){const _=this.painter.context,y=_.gl,b=(T=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:a.DEMData.getUnpackVector(T),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0,u_tile_tl_up:[0,0,1],u_tile_tr_up:[0,0,1],u_tile_br_up:[0,0,1],u_tile_bl_up:[0,0,1],u_tile_up_scale:1});var T;b.u_dem_size=this.sourceCache.getSource().tileSize,b.u_exaggeration=this.exaggeration();const C=this.painter.transform,M=C.projection.createTileTransform(C,C.worldSize),k=i.tileID.canonical;b.u_tile_tl_up=M.upVector(k,0,0),b.u_tile_tr_up=M.upVector(k,a.EXTENT,0),b.u_tile_br_up=M.upVector(k,a.EXTENT,a.EXTENT),b.u_tile_bl_up=M.upVector(k,0,a.EXTENT),b.u_tile_up_scale=M.upVectorScale(k);let P=null,F=null,j=1;if(p&&p.morphing&&this._useVertexMorphing){const N=p.morphing.srcDemTile,$=p.morphing.dstDemTile;j=p.morphing.phase,N&&$&&(this._prepareDemTileUniforms(i,N,b,"_prev")&&(F=N),this._prepareDemTileUniforms(i,$,b)&&(P=$))}if(F&&P?(_.activeTexture.set(y.TEXTURE2),P.demTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE,y.NEAREST),_.activeTexture.set(y.TEXTURE4),F.demTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE,y.NEAREST),b.u_dem_lerp=j):(P=this.terrainTileForTile[i.tileID.key],_.activeTexture.set(y.TEXTURE2),(this._prepareDemTileUniforms(i,P,b)?P.demTexture:this.emptyDEMTexture).bind(y.NEAREST,y.CLAMP_TO_EDGE)),_.activeTexture.set(y.TEXTURE3),p&&p.useDepthForOcclusion?(this._depthTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE),b.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height]):(this.emptyDepthBufferTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE),b.u_depth_size_inv=[1,1]),p&&p.useMeterToDem&&P){const N=(1<<P.tileID.canonical.z)*a.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;b.u_meter_to_dem=N}p&&p.labelPlaneMatrixInv&&(b.u_label_plane_matrix_inv=p.labelPlaneMatrixInv),l.setTerrainUniformValues(_,b)}renderToBackBuffer(i){const l=this.painter,p=this.painter.context;i.length!==0&&(p.bindFramebuffer.set(null),p.viewport.set([0,0,l.width,l.height]),this.renderingToTexture=!1,function(_,y,b,T,C){if(_.transform.projection.name==="globe")(function(M,k,P,F,j){const N=M.context,$=N.gl;let ee,V;const Y=M.options.showTerrainWireframe?2:0,J=(Ce,xe)=>{if(V===Ce)return;const me=[];xe&&me.push(is[Y]),me.push(is[Ce]),me.push("PROJECTION_GLOBE_VIEW"),ee=M.useProgram("globeRaster",null,me),V=Ce},H=M.colorModeForRenderPass(),K=new a.DepthMode($.LEQUAL,a.DepthMode.ReadWrite,M.depthRangeFor3D);nn.update(j);const te=M.transform,de=a.calculateGlobeMatrix(te,te.worldSize),_e=a.calculateGlobeMercatorMatrix(te),Be=[a.mercatorXfromLng(te.center.lng),a.mercatorYfromLat(te.center.lat)],ke=M.globeSharedBuffers;(Y?[!1,!0]:[!1]).forEach(Ce=>{V=-1;const xe=Ce?$.LINES:$.TRIANGLES;for(const me of F){const Ae=P.getTile(me),Ee=Math.pow(2,me.canonical.z),[Xe,et]=a.globeBuffersForTileMesh(M,Ae,me,Ee),ht=a.StencilMode.disabled,Re=k.prevTerrainTileForTile[me.key],Ke=k.terrainTileForTile[me.key];Cr(Re,Ke)&&nn.newMorphing(me.key,Re,Ke,j,250),N.activeTexture.set($.TEXTURE0),Ae.texture.bind($.LINEAR,$.CLAMP_TO_EDGE);const st=nn.getMorphValuesForProxy(me.key),Rt=st?1:0,jt={};st&&a.extend$1(jt,{morphing:{srcDemTile:st.from,dstDemTile:st.to,phase:a.easeCubicInOut(st.phase)}});const nt=a.globeMatrixForTile(me.canonical,de),_t=za(te.projMatrix,nt,_e,a.globeToMercatorTransition(te.zoom),Be);if(J(Rt,Ce),k.setupElevationDraw(Ae,ee,jt),M.prepareDrawProgram(N,ee,me.toUnwrapped()),ke){const[Yt,vi]=Ce?ke.getWirefameBuffer(M.context):[ke.gridIndexBuffer,ke.gridSegments];ee.draw(N,xe,K,ht,H,a.CullFaceMode.backCCW,_t,"globe_raster",Xe,Yt,vi)}if(!Ce){const Yt=[me.canonical.y===0?a.globePoleMatrixForTile(me.canonical,!1,te):null,me.canonical.y===Ee-1?a.globePoleMatrixForTile(me.canonical,!0,te):null];for(const vi of Yt){if(!vi)continue;const nr=za(te.projMatrix,vi,vi,0,Be);ke&&ee.draw(N,xe,K,ht,H,a.CullFaceMode.disabled,nr,"globe_pole_raster",et,ke.poleIndexBuffer,ke.poleSegments)}}}})})(_,y,b,T,C);else{const M=_.context,k=M.gl;let P,F;const j=_.options.showTerrainWireframe?2:0,N=(J,H)=>{if(F===J)return;const K=[is[J]];H&&K.push(is[j]),P=_.useProgram("terrainRaster",null,K),F=J},$=_.colorModeForRenderPass(),ee=new a.DepthMode(k.LEQUAL,a.DepthMode.ReadWrite,_.depthRangeFor3D);nn.update(C);const V=_.transform,Y=6*Math.pow(1.5,22-V.zoom)*y.exaggeration();(j?[!1,!0]:[!1]).forEach(J=>{F=-1;const H=J?k.LINES:k.TRIANGLES,[K,te]=J?y.getWirefameBuffer():[y.gridIndexBuffer,y.gridSegments];for(const de of T){const _e=b.getTile(de),Be=a.StencilMode.disabled,ke=y.prevTerrainTileForTile[de.key],Ce=y.terrainTileForTile[de.key];Cr(ke,Ce)&&nn.newMorphing(de.key,ke,Ce,C,250),M.activeTexture.set(k.TEXTURE0),_e.texture.bind(k.LINEAR,k.CLAMP_TO_EDGE,k.LINEAR_MIPMAP_NEAREST);const xe=nn.getMorphValuesForProxy(de.key),me=xe?1:0;let Ae;xe&&(Ae={morphing:{srcDemTile:xe.from,dstDemTile:xe.to,phase:a.easeCubicInOut(xe.phase)}});const Ee=Ei(de.projMatrix,Yd(de.canonical,V.renderWorldCopies)?Y/10:Y);N(me,J),y.setupElevationDraw(_e,P,Ae),_.prepareDrawProgram(M,P,de.toUnwrapped()),P.draw(M,H,ee,Be,$,a.CullFaceMode.backCCW,Ee,"terrain_raster",y.gridBuffer,K,te)}})}}(l,this,this.proxySourceCache,i,this._updateTimestamp),this.renderingToTexture=!0,i.splice(0,i.length))}renderBatch(i){if(this._drapedRenderBatches.length===0)return i+1;this.renderingToTexture=!0;const l=this.painter,p=this.painter.context,_=this.proxySourceCache,y=this.proxiedCoords[_.id],b=this._drapedRenderBatches.shift(),T=[],C=l.style.order;let M=0;for(const k of y){const P=_.getTileByID(k.proxyTileKey),F=_.proxyCachedFBO[k.key]?_.proxyCachedFBO[k.key][i]:void 0,j=F!==void 0?_.renderCache[F]:this.pool[M++],N=F!==void 0;if(P.texture=j.tex,N&&!j.dirty){T.push(P.tileID);continue}let $;p.bindFramebuffer.set(j.fb.framebuffer),this.renderedToTile=!1,j.dirty&&(p.clear({color:a.Color.transparent,stencil:0}),j.dirty=!1);for(let ee=b.start;ee<=b.end;++ee){const V=l.style._layers[C[ee]];if(V.isHidden(l.transform.zoom))continue;const Y=l.style._getLayerSourceCache(V),J=Y?this.proxyToSource[k.key][Y.id]:[k];if(!J)continue;const H=J;p.viewport.set([0,0,j.fb.width,j.fb.height]),$!==(Y?Y.id:null)&&(this._setupStencil(j,J,V,Y),$=Y?Y.id:null),l.renderLayer(l,Y,V,H)}this.renderedToTile?(j.dirty=!0,T.push(P.tileID)):N||--M,M===5&&(M=0,this.renderToBackBuffer(T))}return this.renderToBackBuffer(T),this.renderingToTexture=!1,p.bindFramebuffer.set(null),p.viewport.set([0,0,l.width,l.height]),b.end+1}postRender(){}renderCacheEfficiency(i){const l=i.order.length;if(l===0)return{efficiency:100};let p,_=0,y=0,b=!1;for(let T=0;T<l;++T){const C=i._layers[i.order[T]];this._style.isLayerDraped(C)?(b&&++_,++y):b||(b=!0,p=C.id)}return y===0?{efficiency:100}:{efficiency:100*(1-_/y),firstUndrapedLayer:p}}getMinElevationBelowMSL(){let i=0;return this._visibleDemTiles.filter(l=>l.dem).forEach(l=>{i=Math.min(i,l.dem.tree.minimums[0])}),i===0?i:(i-30)*this._exaggeration}raycast(i,l,p){if(!this._visibleDemTiles)return null;const _=this._visibleDemTiles.filter(y=>y.dem).map(y=>{const b=y.tileID,T=Math.pow(2,b.overscaledZ),{x:C,y:M}=b.canonical,k=C/T,P=(C+1)/T,F=M/T,j=(M+1)/T;return{minx:k,miny:F,maxx:P,maxy:j,t:y.dem.tree.raycastRoot(k,F,P,j,i,l,p),tile:y}});_.sort((y,b)=>(y.t!==null?y.t:Number.MAX_VALUE)-(b.t!==null?b.t:Number.MAX_VALUE));for(const y of _){if(y.t==null)return null;const b=y.tile.dem.tree.raycast(y.minx,y.miny,y.maxx,y.maxy,i,l,p);if(b!=null)return b}return null}_createFBO(){const i=this.painter.context,l=i.gl,p=this.drapeBufferSize;i.activeTexture.set(l.TEXTURE0);const _=new a.Texture(i,{width:p[0],height:p[1],data:null},l.RGBA);_.bind(l.LINEAR,l.CLAMP_TO_EDGE);const y=i.createFramebuffer(p[0],p[1],!1);return y.colorAttachment.set(_.texture),y.depthAttachment=new wa(i,y.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=i.createRenderbuffer(i.gl.DEPTH_STENCIL,p[0],p[1]),this._stencilRef=0,y.depthAttachment.set(this._sharedDepthStencil),i.clear({stencil:0})):y.depthAttachment.set(this._sharedDepthStencil),i.extTextureFilterAnisotropic&&!i.extTextureFilterAnisotropicForceOff&&l.texParameterf(l.TEXTURE_2D,i.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,i.extTextureFilterAnisotropicMax),{fb:y,tex:_,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const i in this._style._sourceCaches)if(this._style._sourceCaches[i].hasTransition())return!0;return this._style.order.some(i=>{const l=this._style._layers[i],p=l.isHidden(this.painter.transform.zoom),_=l.getCrossfadeParameters(),y=!!_&&_.t!==1,b=l.hasTransition();return l.type!=="custom"&&!p&&(y||b)})}_clearRasterFadeFromRenderCache(){let i=!1;for(const l in this._style._sourceCaches)if(this._style._sourceCaches[l]._source instanceof dn){i=!0;break}if(i)for(let l=0;l<this._style.order.length;++l){const p=this._style._layers[this._style.order[l]],_=p.isHidden(this.painter.transform.zoom),y=this._style._getLayerSourceCache(p);if(p.type!=="raster"||_||!y)continue;const b=p.paint.get("raster-fade-duration");for(const T of this.proxyCoords){const C=this.proxyToSource[T.key][y.id];if(C)for(const M of C){const k=Fh(y.getTile(M),y.findLoadedParent(M,0),y,this.painter.transform,b);(k.opacity!==1||k.mix!==0)&&this._clearRenderCacheForTile(y.id,M)}}}}_setupDrapedRenderBatches(){const i=this._style.order,l=i.length;if(l===0)return;const p=[];let _,y=0,b=this._style._layers[i[y]];for(;!this._style.isLayerDraped(b)&&b.isHidden(this.painter.transform.zoom)&&++y<l;)b=this._style._layers[i[y]];for(;y<l;++y){const T=this._style._layers[i[y]];T.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(T)?_===void 0&&(_=y):_!==void 0&&(p.push({start:_,end:y-1}),_=void 0))}_!==void 0&&p.push({start:_,end:y-1}),this._drapedRenderBatches=p}_setupRenderCache(i){const l=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,l.renderCache.length>l.renderCachePool.length){const b=Object.values(l.proxyCachedFBO);l.proxyCachedFBO={};for(let T=0;T<b.length;++T){const C=Object.values(b[T]);l.renderCachePool.push(...C)}}return}this._clearRasterFadeFromRenderCache();const p=this.proxyCoords,_=this._tilesDirty;for(let b=p.length-1;b>=0;b--){const T=p[b];if(l.getTileByID(T.key),l.proxyCachedFBO[T.key]!==void 0){const C=i[T.key],M=this.proxyToSource[T.key];let k=0;for(const P in M){const F=M[P],j=C[P];if(!j||j.length!==F.length||F.some((N,$)=>N!==j[$]||_[P]&&_[P].hasOwnProperty(N.key))){k=-1;break}++k}for(const P in l.proxyCachedFBO[T.key])l.renderCache[l.proxyCachedFBO[T.key][P]].dirty=k<0||k!==Object.values(C).length}}const y=[...this._drapedRenderBatches];y.sort((b,T)=>T.end-T.start-(b.end-b.start));for(const b of y)for(const T of p){if(l.proxyCachedFBO[T.key])continue;let C=l.renderCachePool.pop();C===void 0&&l.renderCache.length<50&&(C=l.renderCache.length,l.renderCache.push(this._createFBO())),C!==void 0&&(l.proxyCachedFBO[T.key]={},l.proxyCachedFBO[T.key][b.start]=C,l.renderCache[C].dirty=!0)}this._tilesDirty={}}_setupStencil(i,l,p,_){if(!_||!this._sourceTilesOverlap[_.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const y=this.painter.context,b=y.gl;if(l.length<=1)return void(this._overlapStencilType=!1);let T;if(p.isTileClipped())T=l.length,this._overlapStencilMode.test={func:b.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(l[0].overscaledZ>l[l.length-1].overscaledZ))return void(this._overlapStencilType=!1);T=1,this._overlapStencilMode.test={func:b.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+T>255&&(y.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=T,this._overlapStencilMode.ref=this._stencilRef,p.isTileClipped()&&this._renderTileClippingMasks(l,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(i){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[i.key]),this._overlapStencilMode):a.StencilMode.disabled}_renderTileClippingMasks(i,l){const p=this.painter,_=this.painter.context,y=_.gl;p._tileClippingMaskIDs={},_.setColorMode(a.ColorMode.disabled),_.setDepthMode(a.DepthMode.disabled);const b=p.useProgram("clippingMask");for(const T of i){const C=p._tileClippingMaskIDs[T.key]=--l;b.draw(_,y.TRIANGLES,a.DepthMode.disabled,new a.StencilMode({func:y.ALWAYS,mask:0},C,255,y.KEEP,y.KEEP,y.REPLACE),a.ColorMode.disabled,a.CullFaceMode.disabled,sn(T.projMatrix),"$clipping",p.tileExtentBuffer,p.quadTriangleIndexBuffer,p.tileExtentSegments)}}pointCoordinate(i){const l=this.painter.transform;if(i.x<0||i.x>l.width||i.y<0||i.y>l.height)return null;const p=[i.x,i.y,1,1];a.transformMat4$1(p,p,l.pixelMatrixInverse),a.scale$1(p,p,1/p[3]),p[0]/=l.worldSize,p[1]/=l.worldSize;const _=l._camera.position,y=a.mercatorZfromAltitude(1,l.center.lat),b=[_[0],_[1],_[2]/y,0],T=a.subtract([],p.slice(0,3),b);a.normalize(T,T);const C=this.raycast(b,T,this._exaggeration);return C!==null&&C?(a.scaleAndAdd(b,b,T,C),b[3]=b[2],b[2]*=y,b):null}drawDepth(){const i=this.painter,l=i.context,p=this.proxySourceCache,_=Math.ceil(i.width),y=Math.ceil(i.height);if(!this._depthFBO||this._depthFBO.width===_&&this._depthFBO.height===y||(this._depthFBO.destroy(),delete this._depthFBO,delete this._depthTexture),!this._depthFBO){const b=l.gl,T=l.createFramebuffer(_,y,!0);l.activeTexture.set(b.TEXTURE0);const C=new a.Texture(l,{width:_,height:y,data:null},b.RGBA);C.bind(b.NEAREST,b.CLAMP_TO_EDGE),T.colorAttachment.set(C.texture);const M=l.createRenderbuffer(l.gl.DEPTH_COMPONENT16,_,y);T.depthAttachment.set(M),this._depthFBO=T,this._depthTexture=C}l.bindFramebuffer.set(this._depthFBO.framebuffer),l.viewport.set([0,0,_,y]),function(b,T,C,M){if(b.transform.projection.name==="globe")return;const k=b.context,P=k.gl;k.clear({depth:1});const F=b.useProgram("terrainDepth"),j=new a.DepthMode(P.LESS,a.DepthMode.ReadWrite,b.depthRangeFor3D);for(const N of M){const $=C.getTile(N),ee=Ei(N.projMatrix,0);T.setupElevationDraw($,F),F.draw(k,P.TRIANGLES,j,a.StencilMode.disabled,a.ColorMode.unblended,a.CullFaceMode.backCCW,ee,"terrain_depth",T.gridBuffer,T.gridIndexBuffer,T.gridNoSkirtSegments)}}(i,this,p,this.proxyCoords)}_setupProxiedCoordsForOrtho(i,l,p){if(i.getSource()instanceof Or)return this._setupProxiedCoordsForImageSource(i,l,p);this._findCoveringTileCache[i.id]=this._findCoveringTileCache[i.id]||{};const _=this.proxiedCoords[i.id]=[],y=this.proxyCoords;for(let T=0;T<y.length;T++){const C=y[T],M=this._findTileCoveringTileID(C,i);if(M){const k=this._createProxiedId(C,M,p[C.key]&&p[C.key][i.id]);_.push(k),this.proxyToSource[C.key][i.id]=[k]}}let b=!1;for(let T=0;T<l.length;T++){const C=i.getTile(l[T]);if(!C||!C.hasData())continue;const M=this._findTileCoveringTileID(C.tileID,this.proxySourceCache);if(M&&M.tileID.canonical.z!==C.tileID.canonical.z){const k=this.proxyToSource[M.tileID.key][i.id],P=this._createProxiedId(M.tileID,C,p[M.tileID.key]&&p[M.tileID.key][i.id]);k?k.splice(k.length-1,0,P):this.proxyToSource[M.tileID.key][i.id]=[P],_.push(P),b=!0}}this._sourceTilesOverlap[i.id]=b}_setupProxiedCoordsForImageSource(i,l,p){if(!i.getSource().loaded())return;const _=this.proxiedCoords[i.id]=[],y=this.proxyCoords,b=i.getSource(),T=new a.pointGeometry(b.tileID.x,b.tileID.y)._div(1<<b.tileID.z),C=b.coordinates.map(a.MercatorCoordinate.fromLngLat).reduce((k,P)=>(k.min.x=Math.min(k.min.x,P.x-T.x),k.min.y=Math.min(k.min.y,P.y-T.y),k.max.x=Math.max(k.max.x,P.x-T.x),k.max.y=Math.max(k.max.y,P.y-T.y),k),{min:new a.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE),max:new a.pointGeometry(-Number.MAX_VALUE,-Number.MAX_VALUE)}),M=(k,P)=>{const F=k.wrap+k.canonical.x/(1<<k.canonical.z),j=k.canonical.y/(1<<k.canonical.z),N=a.EXTENT/(1<<k.canonical.z),$=P.wrap+P.canonical.x/(1<<P.canonical.z),ee=P.canonical.y/(1<<P.canonical.z);return F+N<$+C.min.x||F>$+C.max.x||j+N<ee+C.min.y||j>ee+C.max.y};for(let k=0;k<y.length;k++){const P=y[k];for(let F=0;F<l.length;F++){const j=i.getTile(l[F]);if(!j||!j.hasData()||M(P,j.tileID))continue;const N=this._createProxiedId(P,j,p[P.key]&&p[P.key][i.id]),$=this.proxyToSource[P.key][i.id];$?$.push(N):this.proxyToSource[P.key][i.id]=[N],_.push(N)}}}_createProxiedId(i,l,p){let _=this.orthoMatrix;if(p){const y=p.find(b=>b.key===l.tileID.key);if(y)return y}if(l.tileID.key!==i.key){const y=i.canonical.z-l.tileID.canonical.z;let b,T,C;_=a.create();const M=l.tileID.wrap-i.wrap<<i.overscaledZ;y>0?(b=a.EXTENT>>y,T=b*((l.tileID.canonical.x<<y)-i.canonical.x+M),C=b*((l.tileID.canonical.y<<y)-i.canonical.y)):(b=a.EXTENT<<-y,T=a.EXTENT*(l.tileID.canonical.x-(i.canonical.x+M<<-y)),C=a.EXTENT*(l.tileID.canonical.y-(i.canonical.y<<-y))),a.ortho(_,0,b,0,b,0,1),a.translate(_,_,[T,C,0])}return new Io(l.tileID,i.key,_)}_findTileCoveringTileID(i,l){let p=l.getTile(i);if(p&&p.hasData())return p;const _=this._findCoveringTileCache[l.id],y=_[i.key];if(p=y?l.getTileByID(y):null,p&&p.hasData()||y===null)return p;let b=p?p.tileID:i,T=b.overscaledZ;const C=l.getSource().minzoom,M=[];if(!y){const P=l.getSource().maxzoom;if(i.canonical.z>=P){const F=i.canonical.z-P;l.getSource().reparseOverscaled?(T=Math.max(i.canonical.z+2,l.transform.tileZoom),b=new a.OverscaledTileID(T,i.wrap,P,i.canonical.x>>F,i.canonical.y>>F)):F!==0&&(T=P,b=new a.OverscaledTileID(T,i.wrap,P,i.canonical.x>>F,i.canonical.y>>F))}b.key!==i.key&&(M.push(b.key),p=l.getTile(b))}const k=P=>{M.forEach(F=>{_[F]=P}),M.length=0};for(T-=1;T>=C&&(!p||!p.hasData());T--){p&&k(p.tileID.key);const P=b.calculateScaledKey(T);if(p=l.getTileByID(P),p&&p.hasData())break;const F=_[P];if(F===null)break;F===void 0?M.push(P):p=l.getTileByID(F)}return k(p?p.tileID.key:null),p&&p.hasData()?p:null}findDEMTileFor(i){return this.enabled?this._findTileCoveringTileID(i,this.sourceCache):null}prepareDrawTile(i){this.renderedToTile=!0}_clearRenderCacheForTile(i,l){let p=this._tilesDirty[i];p||(p=this._tilesDirty[i]={}),p[l.key]=!0}getWirefameBuffer(){if(!this.wireframeSegments){const i=function(l){let p,_,y;const b=new a.StructArrayLayout2ui4,T=131;for(_=1;_<129;_++){for(p=1;p<129;p++)y=_*T+p,b.emplaceBack(y,y+1),b.emplaceBack(y,y+T),b.emplaceBack(y+1,y+T),_===128&&b.emplaceBack(y+T,y+T+1);b.emplaceBack(y+1,y+1+T)}return b}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(i),this.wireframeSegments=a.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,i.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}}function Pa(d){const i=[];for(let l=0;l<d.length;l++){if(d[l]===null)continue;const p=d[l].split(" ");i.push(p.pop())}return i}class Ao{static cacheKey(i,l,p){let _=`${i}${p?p.cacheKey:""}`;for(const y of l)_+=`/${y}`;return _}constructor(i,l,p,_,y,b){const T=i.gl;this.program=T.createProgram();const C=Pa(p.staticAttributes),M=_?_.getBinderAttributes():[],k=C.concat(M),P=p.staticUniforms?Pa(p.staticUniforms):[],F=_?_.getBinderUniforms():[],j=P.concat(F),N=[];for(const K of j)N.indexOf(K)<0&&N.push(K);let $=_?_.defines():[];$=$.concat(b.map(K=>`#define ${K}`));const ee=$.concat(`
#ifdef GL_ES
precision mediump float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,ka,At.fragmentSource,Rs.fragmentSource,p.fragmentSource).join(`
`),V=$.concat(`
#ifdef GL_ES
precision highp float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,ka,At.vertexSource,Rs.vertexSource,Ls.vertexSource,p.vertexSource).join(`
`),Y=T.createShader(T.FRAGMENT_SHADER);if(T.isContextLost())return void(this.failedToCreate=!0);T.shaderSource(Y,ee),T.compileShader(Y),T.attachShader(this.program,Y);const J=T.createShader(T.VERTEX_SHADER);if(T.isContextLost())return void(this.failedToCreate=!0);T.shaderSource(J,V),T.compileShader(J),T.attachShader(this.program,J),this.attributes={};const H={};this.numAttributes=k.length;for(let K=0;K<this.numAttributes;K++)k[K]&&(T.bindAttribLocation(this.program,K,k[K]),this.attributes[k[K]]=K);T.linkProgram(this.program),T.deleteShader(J),T.deleteShader(Y);for(let K=0;K<N.length;K++){const te=N[K];if(te&&!H[te]){const de=T.getUniformLocation(this.program,te);de&&(H[te]=de)}}this.fixedUniforms=y(i,H),this.binderUniforms=_?_.getUniforms(i,H):[],b.indexOf("TERRAIN")!==-1&&(this.terrainUniforms=((K,te)=>({u_dem:new a.Uniform1i(K,te.u_dem),u_dem_prev:new a.Uniform1i(K,te.u_dem_prev),u_dem_unpack:new a.Uniform4f(K,te.u_dem_unpack),u_dem_tl:new a.Uniform2f(K,te.u_dem_tl),u_dem_scale:new a.Uniform1f(K,te.u_dem_scale),u_dem_tl_prev:new a.Uniform2f(K,te.u_dem_tl_prev),u_dem_scale_prev:new a.Uniform1f(K,te.u_dem_scale_prev),u_dem_size:new a.Uniform1f(K,te.u_dem_size),u_dem_lerp:new a.Uniform1f(K,te.u_dem_lerp),u_exaggeration:new a.Uniform1f(K,te.u_exaggeration),u_depth:new a.Uniform1i(K,te.u_depth),u_depth_size_inv:new a.Uniform2f(K,te.u_depth_size_inv),u_meter_to_dem:new a.Uniform1f(K,te.u_meter_to_dem),u_label_plane_matrix_inv:new a.UniformMatrix4f(K,te.u_label_plane_matrix_inv),u_tile_tl_up:new a.Uniform3f(K,te.u_tile_tl_up),u_tile_tr_up:new a.Uniform3f(K,te.u_tile_tr_up),u_tile_br_up:new a.Uniform3f(K,te.u_tile_br_up),u_tile_bl_up:new a.Uniform3f(K,te.u_tile_bl_up),u_tile_up_scale:new a.Uniform1f(K,te.u_tile_up_scale)}))(i,H)),b.indexOf("FOG")!==-1&&(this.fogUniforms=((K,te)=>({u_fog_matrix:new a.UniformMatrix4f(K,te.u_fog_matrix),u_fog_range:new a.Uniform2f(K,te.u_fog_range),u_fog_color:new a.Uniform4f(K,te.u_fog_color),u_fog_horizon_blend:new a.Uniform1f(K,te.u_fog_horizon_blend),u_fog_temporal_offset:new a.Uniform1f(K,te.u_fog_temporal_offset)}))(i,H))}setTerrainUniformValues(i,l){if(!this.terrainUniforms)return;const p=this.terrainUniforms;if(!this.failedToCreate){i.program.set(this.program);for(const _ in l)p[_].set(l[_])}}setFogUniformValues(i,l){if(!this.fogUniforms)return;const p=this.fogUniforms;if(!this.failedToCreate){i.program.set(this.program);for(const _ in l)p[_].location&&p[_].set(l[_])}}draw(i,l,p,_,y,b,T,C,M,k,P,F,j,N,$,ee){const V=i.gl;if(this.failedToCreate)return;i.program.set(this.program),i.setDepthMode(p),i.setStencilMode(_),i.setColorMode(y),i.setCullFace(b);for(const J of Object.keys(this.fixedUniforms))this.fixedUniforms[J].set(T[J]);N&&N.setUniforms(i,this.binderUniforms,F,{zoom:j});const Y={[V.LINES]:2,[V.TRIANGLES]:3,[V.LINE_STRIP]:1}[l];for(const J of P.get()){const H=J.vaos||(J.vaos={});(H[C]||(H[C]=new Ar)).bind(i,this,M,N?N.getPaintVertexBuffers():[],k,J.vertexOffset,$,ee),V.drawElements(l,J.primitiveLength*Y,V.UNSIGNED_SHORT,J.primitiveOffset*Y*2)}}}function Nh(d,i,l){const p=1/wr(l,1,i.transform.tileZoom),_=Math.pow(2,l.tileID.overscaledZ),y=l.tileSize*Math.pow(2,i.transform.tileZoom)/_,b=y*(l.tileID.canonical.x+l.tileID.wrap*_),T=y*l.tileID.canonical.y;return{u_image:0,u_texsize:l.imageAtlasTexture.size,u_scale:[p,d.fromScale,d.toScale],u_fade:d.t,u_pixel_coord_upper:[b>>16,T>>16],u_pixel_coord_lower:[65535&b,65535&T]}}const Uh=(d,i,l,p)=>{const _=i.style.light,y=_.properties.get("position"),b=[y.x,y.y,y.z],T=a.create$1();_.properties.get("anchor")==="viewport"&&(a.fromRotation(T,-i.transform.angle),a.transformMat3(b,b,T));const C=_.properties.get("color");return{u_matrix:d,u_lightpos:b,u_lightintensity:_.properties.get("intensity"),u_lightcolor:[C.r,C.g,C.b],u_vertical_gradient:+l,u_opacity:p}},Jl=(d,i,l,p,_,y,b)=>a.extend(Uh(d,i,l,p),Nh(y,i,b),{u_height_factor:-Math.pow(2,_.overscaledZ)/b.tileSize/8}),Vh=d=>({u_matrix:d}),Ql=(d,i,l,p)=>a.extend(Vh(d),Nh(l,i,p)),Jd=(d,i)=>({u_matrix:d,u_world:i}),jh=(d,i,l,p,_)=>a.extend(Ql(d,i,l,p),{u_world:_}),Qd=(d,i,l,p)=>{const _=d.transform;let y;return y=p.paint.get("circle-pitch-alignment")==="map"?_.calculatePixelsToTileUnitsMatrix(l):new Float32Array([_.pixelsToGLUnits[0],0,0,_.pixelsToGLUnits[1]]),{u_camera_to_center_distance:_.cameraToCenterDistance,u_matrix:d.translatePosMatrix(i.projMatrix,l,p.paint.get("circle-translate"),p.paint.get("circle-translate-anchor")),u_device_pixel_ratio:a.exported.devicePixelRatio,u_extrude_scale:y}},ec=d=>{const i=[];return d.paint.get("circle-pitch-alignment")==="map"&&i.push("PITCH_WITH_MAP"),d.paint.get("circle-pitch-scale")==="map"&&i.push("SCALE_WITH_MAP"),i},$h=(d,i,l)=>{const p=a.EXTENT/l.tileSize;return{u_matrix:d,u_camera_to_center_distance:i.cameraToCenterDistance,u_extrude_scale:[i.pixelsToGLUnits[0]/p,i.pixelsToGLUnits[1]/p]}},tc=(d,i,l=1)=>({u_matrix:d,u_color:i,u_overlay:0,u_overlay_scale:l}),Gh=(d,i,l,p)=>({u_matrix:d,u_extrude_scale:wr(i,1,l),u_intensity:p}),qh=(d,i,l,p,_,y)=>{const b=d.transform,T=b.calculatePixelsToTileUnitsMatrix(i),C={u_matrix:Co(d,i,l,_),u_pixels_to_tile_units:T,u_device_pixel_ratio:a.exported.devicePixelRatio,u_units_to_pixels:[1/b.pixelsToGLUnits[0],1/b.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:y,u_texsize:[0,0],u_scale:[0,0,0],u_mix:0,u_alpha_discard_threshold:0};if(Mo(l)){const M=Bs(i,d.transform);C.u_texsize=i.lineAtlasTexture.size,C.u_scale=[M,p.fromScale,p.toScale],C.u_mix=p.t}return C},rs=(d,i,l,p,_)=>{const y=d.transform,b=Bs(i,y);return{u_matrix:Co(d,i,l,_),u_texsize:i.imageAtlasTexture.size,u_pixels_to_tile_units:y.calculatePixelsToTileUnitsMatrix(i),u_device_pixel_ratio:a.exported.devicePixelRatio,u_image:0,u_scale:[b,p.fromScale,p.toScale],u_fade:p.t,u_units_to_pixels:[1/y.pixelsToGLUnits[0],1/y.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function Bs(d,i){return 1/wr(d,1,i.tileZoom)}function Co(d,i,l,p){return d.translatePosMatrix(p||i.tileID.projMatrix,i,l.paint.get("line-translate"),l.paint.get("line-translate-anchor"))}function Mo(d){const i=d.paint.get("line-dasharray").value;return i.value||i.kind!=="constant"}const La=(d,i,l,p,_,y)=>{return{u_matrix:d,u_tl_parent:i,u_scale_parent:l,u_fade_t:p.mix,u_opacity:p.opacity*_.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:_.paint.get("raster-brightness-min"),u_brightness_high:_.paint.get("raster-brightness-max"),u_saturation_factor:(T=_.paint.get("raster-saturation"),T>0?1-1/(1.001-T):-T),u_contrast_factor:(b=_.paint.get("raster-contrast"),b>0?1/(1-b):1+b),u_spin_weights:Ra(_.paint.get("raster-hue-rotate")),u_perspective_transform:y};var b,T};function Ra(d){d*=Math.PI/180;const i=Math.sin(d),l=Math.cos(d);return[(2*l+1)/3,(-Math.sqrt(3)*i-l+1)/3,(Math.sqrt(3)*i-l+1)/3]}const Ba=(d,i,l,p,_,y,b,T,C,M,k,P,F,j)=>{const N=_.transform;return{u_is_size_zoom_constant:+(d==="constant"||d==="source"),u_is_size_feature_constant:+(d==="constant"||d==="camera"),u_size_t:i?i.uSizeT:0,u_size:i?i.uSize:0,u_camera_to_center_distance:N.cameraToCenterDistance,u_pitch:N.pitch/360*2*Math.PI,u_rotate_symbol:+l,u_aspect_ratio:N.width/N.height,u_fade_change:_.options.fadeDuration?_.symbolFadeChange:1,u_matrix:y,u_label_plane_matrix:b,u_coord_matrix:T,u_is_text:+C,u_pitch_with_map:+p,u_texsize:M,u_tile_id:k,u_zoom_transition:P,u_inv_rot_matrix:F,u_merc_center:j,u_texture:0}},ko=(d,i,l,p,_,y,b,T,C,M,k,P,F,j,N)=>{const{cameraToCenterDistance:$,_pitch:ee}=_.transform;return a.extend(Ba(d,i,l,p,_,y,b,T,C,M,P,F,j,N),{u_gamma_scale:p?$*Math.cos(_.terrain?0:ee):1,u_device_pixel_ratio:a.exported.devicePixelRatio,u_is_halo:+k})},Do=(d,i,l,p,_,y,b,T,C,M,k,P,F,j)=>a.extend(ko(d,i,l,p,_,y,b,T,!0,C,!0,k,P,F,j),{u_texsize_icon:M,u_texture_icon:1}),Lt=(d,i,l)=>({u_matrix:d,u_opacity:i,u_color:l}),Fa=(d,i,l,p,_,y)=>a.extend(function(b,T,C,M){const k=C.imageManager.getPattern(b.from.toString()),P=C.imageManager.getPattern(b.to.toString()),{width:F,height:j}=C.imageManager.getPixelSize(),N=Math.pow(2,M.tileID.overscaledZ),$=M.tileSize*Math.pow(2,C.transform.tileZoom)/N,ee=$*(M.tileID.canonical.x+M.tileID.wrap*N),V=$*M.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:k.tl,u_pattern_br_a:k.br,u_pattern_tl_b:P.tl,u_pattern_br_b:P.br,u_texsize:[F,j],u_mix:T.t,u_pattern_size_a:k.displaySize,u_pattern_size_b:P.displaySize,u_scale_a:T.fromScale,u_scale_b:T.toScale,u_tile_units_to_pixels:1/wr(M,1,C.transform.tileZoom),u_pixel_coord_upper:[ee>>16,V>>16],u_pixel_coord_lower:[65535&ee,65535&V]}}(p,y,l,_),{u_matrix:d,u_opacity:i}),Zh={fillExtrusion:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_lightpos:new a.Uniform3f(d,i.u_lightpos),u_lightintensity:new a.Uniform1f(d,i.u_lightintensity),u_lightcolor:new a.Uniform3f(d,i.u_lightcolor),u_vertical_gradient:new a.Uniform1f(d,i.u_vertical_gradient),u_opacity:new a.Uniform1f(d,i.u_opacity)}),fillExtrusionPattern:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_lightpos:new a.Uniform3f(d,i.u_lightpos),u_lightintensity:new a.Uniform1f(d,i.u_lightintensity),u_lightcolor:new a.Uniform3f(d,i.u_lightcolor),u_vertical_gradient:new a.Uniform1f(d,i.u_vertical_gradient),u_height_factor:new a.Uniform1f(d,i.u_height_factor),u_image:new a.Uniform1i(d,i.u_image),u_texsize:new a.Uniform2f(d,i.u_texsize),u_pixel_coord_upper:new a.Uniform2f(d,i.u_pixel_coord_upper),u_pixel_coord_lower:new a.Uniform2f(d,i.u_pixel_coord_lower),u_scale:new a.Uniform3f(d,i.u_scale),u_fade:new a.Uniform1f(d,i.u_fade),u_opacity:new a.Uniform1f(d,i.u_opacity)}),fill:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix)}),fillPattern:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_image:new a.Uniform1i(d,i.u_image),u_texsize:new a.Uniform2f(d,i.u_texsize),u_pixel_coord_upper:new a.Uniform2f(d,i.u_pixel_coord_upper),u_pixel_coord_lower:new a.Uniform2f(d,i.u_pixel_coord_lower),u_scale:new a.Uniform3f(d,i.u_scale),u_fade:new a.Uniform1f(d,i.u_fade)}),fillOutline:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_world:new a.Uniform2f(d,i.u_world)}),fillOutlinePattern:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_world:new a.Uniform2f(d,i.u_world),u_image:new a.Uniform1i(d,i.u_image),u_texsize:new a.Uniform2f(d,i.u_texsize),u_pixel_coord_upper:new a.Uniform2f(d,i.u_pixel_coord_upper),u_pixel_coord_lower:new a.Uniform2f(d,i.u_pixel_coord_lower),u_scale:new a.Uniform3f(d,i.u_scale),u_fade:new a.Uniform1f(d,i.u_fade)}),circle:(d,i)=>({u_camera_to_center_distance:new a.Uniform1f(d,i.u_camera_to_center_distance),u_extrude_scale:new a.UniformMatrix2f(d,i.u_extrude_scale),u_device_pixel_ratio:new a.Uniform1f(d,i.u_device_pixel_ratio),u_matrix:new a.UniformMatrix4f(d,i.u_matrix)}),collisionBox:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_camera_to_center_distance:new a.Uniform1f(d,i.u_camera_to_center_distance),u_extrude_scale:new a.Uniform2f(d,i.u_extrude_scale)}),collisionCircle:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_inv_matrix:new a.UniformMatrix4f(d,i.u_inv_matrix),u_camera_to_center_distance:new a.Uniform1f(d,i.u_camera_to_center_distance),u_viewport_size:new a.Uniform2f(d,i.u_viewport_size)}),debug:(d,i)=>({u_color:new a.UniformColor(d,i.u_color),u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_overlay:new a.Uniform1i(d,i.u_overlay),u_overlay_scale:new a.Uniform1f(d,i.u_overlay_scale)}),clippingMask:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix)}),heatmap:(d,i)=>({u_extrude_scale:new a.Uniform1f(d,i.u_extrude_scale),u_intensity:new a.Uniform1f(d,i.u_intensity),u_matrix:new a.UniformMatrix4f(d,i.u_matrix)}),heatmapTexture:(d,i)=>({u_image:new a.Uniform1i(d,i.u_image),u_color_ramp:new a.Uniform1i(d,i.u_color_ramp),u_opacity:new a.Uniform1f(d,i.u_opacity)}),hillshade:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_image:new a.Uniform1i(d,i.u_image),u_latrange:new a.Uniform2f(d,i.u_latrange),u_light:new a.Uniform2f(d,i.u_light),u_shadow:new a.UniformColor(d,i.u_shadow),u_highlight:new a.UniformColor(d,i.u_highlight),u_accent:new a.UniformColor(d,i.u_accent)}),hillshadePrepare:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_image:new a.Uniform1i(d,i.u_image),u_dimension:new a.Uniform2f(d,i.u_dimension),u_zoom:new a.Uniform1f(d,i.u_zoom),u_unpack:new a.Uniform4f(d,i.u_unpack)}),line:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_pixels_to_tile_units:new a.UniformMatrix2f(d,i.u_pixels_to_tile_units),u_device_pixel_ratio:new a.Uniform1f(d,i.u_device_pixel_ratio),u_units_to_pixels:new a.Uniform2f(d,i.u_units_to_pixels),u_dash_image:new a.Uniform1i(d,i.u_dash_image),u_gradient_image:new a.Uniform1i(d,i.u_gradient_image),u_image_height:new a.Uniform1f(d,i.u_image_height),u_texsize:new a.Uniform2f(d,i.u_texsize),u_scale:new a.Uniform3f(d,i.u_scale),u_mix:new a.Uniform1f(d,i.u_mix),u_alpha_discard_threshold:new a.Uniform1f(d,i.u_alpha_discard_threshold)}),linePattern:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_texsize:new a.Uniform2f(d,i.u_texsize),u_pixels_to_tile_units:new a.UniformMatrix2f(d,i.u_pixels_to_tile_units),u_device_pixel_ratio:new a.Uniform1f(d,i.u_device_pixel_ratio),u_image:new a.Uniform1i(d,i.u_image),u_units_to_pixels:new a.Uniform2f(d,i.u_units_to_pixels),u_scale:new a.Uniform3f(d,i.u_scale),u_fade:new a.Uniform1f(d,i.u_fade),u_alpha_discard_threshold:new a.Uniform1f(d,i.u_alpha_discard_threshold)}),raster:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_tl_parent:new a.Uniform2f(d,i.u_tl_parent),u_scale_parent:new a.Uniform1f(d,i.u_scale_parent),u_fade_t:new a.Uniform1f(d,i.u_fade_t),u_opacity:new a.Uniform1f(d,i.u_opacity),u_image0:new a.Uniform1i(d,i.u_image0),u_image1:new a.Uniform1i(d,i.u_image1),u_brightness_low:new a.Uniform1f(d,i.u_brightness_low),u_brightness_high:new a.Uniform1f(d,i.u_brightness_high),u_saturation_factor:new a.Uniform1f(d,i.u_saturation_factor),u_contrast_factor:new a.Uniform1f(d,i.u_contrast_factor),u_spin_weights:new a.Uniform3f(d,i.u_spin_weights),u_perspective_transform:new a.Uniform2f(d,i.u_perspective_transform)}),symbolIcon:(d,i)=>({u_is_size_zoom_constant:new a.Uniform1i(d,i.u_is_size_zoom_constant),u_is_size_feature_constant:new a.Uniform1i(d,i.u_is_size_feature_constant),u_size_t:new a.Uniform1f(d,i.u_size_t),u_size:new a.Uniform1f(d,i.u_size),u_camera_to_center_distance:new a.Uniform1f(d,i.u_camera_to_center_distance),u_pitch:new a.Uniform1f(d,i.u_pitch),u_rotate_symbol:new a.Uniform1i(d,i.u_rotate_symbol),u_aspect_ratio:new a.Uniform1f(d,i.u_aspect_ratio),u_fade_change:new a.Uniform1f(d,i.u_fade_change),u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_label_plane_matrix:new a.UniformMatrix4f(d,i.u_label_plane_matrix),u_coord_matrix:new a.UniformMatrix4f(d,i.u_coord_matrix),u_is_text:new a.Uniform1i(d,i.u_is_text),u_pitch_with_map:new a.Uniform1i(d,i.u_pitch_with_map),u_texsize:new a.Uniform2f(d,i.u_texsize),u_tile_id:new a.Uniform3f(d,i.u_tile_id),u_zoom_transition:new a.Uniform1f(d,i.u_zoom_transition),u_inv_rot_matrix:new a.UniformMatrix4f(d,i.u_inv_rot_matrix),u_merc_center:new a.Uniform2f(d,i.u_merc_center),u_texture:new a.Uniform1i(d,i.u_texture)}),symbolSDF:(d,i)=>({u_is_size_zoom_constant:new a.Uniform1i(d,i.u_is_size_zoom_constant),u_is_size_feature_constant:new a.Uniform1i(d,i.u_is_size_feature_constant),u_size_t:new a.Uniform1f(d,i.u_size_t),u_size:new a.Uniform1f(d,i.u_size),u_camera_to_center_distance:new a.Uniform1f(d,i.u_camera_to_center_distance),u_pitch:new a.Uniform1f(d,i.u_pitch),u_rotate_symbol:new a.Uniform1i(d,i.u_rotate_symbol),u_aspect_ratio:new a.Uniform1f(d,i.u_aspect_ratio),u_fade_change:new a.Uniform1f(d,i.u_fade_change),u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_label_plane_matrix:new a.UniformMatrix4f(d,i.u_label_plane_matrix),u_coord_matrix:new a.UniformMatrix4f(d,i.u_coord_matrix),u_is_text:new a.Uniform1i(d,i.u_is_text),u_pitch_with_map:new a.Uniform1i(d,i.u_pitch_with_map),u_texsize:new a.Uniform2f(d,i.u_texsize),u_texture:new a.Uniform1i(d,i.u_texture),u_gamma_scale:new a.Uniform1f(d,i.u_gamma_scale),u_device_pixel_ratio:new a.Uniform1f(d,i.u_device_pixel_ratio),u_tile_id:new a.Uniform3f(d,i.u_tile_id),u_zoom_transition:new a.Uniform1f(d,i.u_zoom_transition),u_inv_rot_matrix:new a.UniformMatrix4f(d,i.u_inv_rot_matrix),u_merc_center:new a.Uniform2f(d,i.u_merc_center),u_is_halo:new a.Uniform1i(d,i.u_is_halo)}),symbolTextAndIcon:(d,i)=>({u_is_size_zoom_constant:new a.Uniform1i(d,i.u_is_size_zoom_constant),u_is_size_feature_constant:new a.Uniform1i(d,i.u_is_size_feature_constant),u_size_t:new a.Uniform1f(d,i.u_size_t),u_size:new a.Uniform1f(d,i.u_size),u_camera_to_center_distance:new a.Uniform1f(d,i.u_camera_to_center_distance),u_pitch:new a.Uniform1f(d,i.u_pitch),u_rotate_symbol:new a.Uniform1i(d,i.u_rotate_symbol),u_aspect_ratio:new a.Uniform1f(d,i.u_aspect_ratio),u_fade_change:new a.Uniform1f(d,i.u_fade_change),u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_label_plane_matrix:new a.UniformMatrix4f(d,i.u_label_plane_matrix),u_coord_matrix:new a.UniformMatrix4f(d,i.u_coord_matrix),u_is_text:new a.Uniform1i(d,i.u_is_text),u_pitch_with_map:new a.Uniform1i(d,i.u_pitch_with_map),u_texsize:new a.Uniform2f(d,i.u_texsize),u_texsize_icon:new a.Uniform2f(d,i.u_texsize_icon),u_texture:new a.Uniform1i(d,i.u_texture),u_texture_icon:new a.Uniform1i(d,i.u_texture_icon),u_gamma_scale:new a.Uniform1f(d,i.u_gamma_scale),u_device_pixel_ratio:new a.Uniform1f(d,i.u_device_pixel_ratio),u_is_halo:new a.Uniform1i(d,i.u_is_halo)}),background:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_opacity:new a.Uniform1f(d,i.u_opacity),u_color:new a.UniformColor(d,i.u_color)}),backgroundPattern:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_opacity:new a.Uniform1f(d,i.u_opacity),u_image:new a.Uniform1i(d,i.u_image),u_pattern_tl_a:new a.Uniform2f(d,i.u_pattern_tl_a),u_pattern_br_a:new a.Uniform2f(d,i.u_pattern_br_a),u_pattern_tl_b:new a.Uniform2f(d,i.u_pattern_tl_b),u_pattern_br_b:new a.Uniform2f(d,i.u_pattern_br_b),u_texsize:new a.Uniform2f(d,i.u_texsize),u_mix:new a.Uniform1f(d,i.u_mix),u_pattern_size_a:new a.Uniform2f(d,i.u_pattern_size_a),u_pattern_size_b:new a.Uniform2f(d,i.u_pattern_size_b),u_scale_a:new a.Uniform1f(d,i.u_scale_a),u_scale_b:new a.Uniform1f(d,i.u_scale_b),u_pixel_coord_upper:new a.Uniform2f(d,i.u_pixel_coord_upper),u_pixel_coord_lower:new a.Uniform2f(d,i.u_pixel_coord_lower),u_tile_units_to_pixels:new a.Uniform1f(d,i.u_tile_units_to_pixels)}),terrainRaster:Rn,terrainDepth:Rn,skybox:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_sun_direction:new a.Uniform3f(d,i.u_sun_direction),u_cubemap:new a.Uniform1i(d,i.u_cubemap),u_opacity:new a.Uniform1f(d,i.u_opacity),u_temporal_offset:new a.Uniform1f(d,i.u_temporal_offset)}),skyboxGradient:(d,i)=>({u_matrix:new a.UniformMatrix4f(d,i.u_matrix),u_color_ramp:new a.Uniform1i(d,i.u_color_ramp),u_center_direction:new a.Uniform3f(d,i.u_center_direction),u_radius:new a.Uniform1f(d,i.u_radius),u_opacity:new a.Uniform1f(d,i.u_opacity),u_temporal_offset:new a.Uniform1f(d,i.u_temporal_offset)}),skyboxCapture:(d,i)=>({u_matrix_3f:new a.UniformMatrix3f(d,i.u_matrix_3f),u_sun_direction:new a.Uniform3f(d,i.u_sun_direction),u_sun_intensity:new a.Uniform1f(d,i.u_sun_intensity),u_color_tint_r:new a.Uniform4f(d,i.u_color_tint_r),u_color_tint_m:new a.Uniform4f(d,i.u_color_tint_m),u_luminance:new a.Uniform1f(d,i.u_luminance)}),globeRaster:(d,i)=>({u_proj_matrix:new a.UniformMatrix4f(d,i.u_proj_matrix),u_globe_matrix:new a.UniformMatrix4f(d,i.u_globe_matrix),u_merc_matrix:new a.UniformMatrix4f(d,i.u_merc_matrix),u_zoom_transition:new a.Uniform1f(d,i.u_zoom_transition),u_merc_center:new a.Uniform2f(d,i.u_merc_center),u_image0:new a.Uniform1i(d,i.u_image0)}),globeAtmosphere:(d,i)=>({u_center:new a.Uniform2f(d,i.u_center),u_radius:new a.Uniform1f(d,i.u_radius),u_screen_size:new a.Uniform2f(d,i.u_screen_size),u_pixel_ratio:new a.Uniform1f(d,i.u_pixel_ratio),u_opacity:new a.Uniform1f(d,i.u_opacity),u_fadeout_range:new a.Uniform1f(d,i.u_fadeout_range),u_start_color:new a.Uniform3f(d,i.u_start_color),u_end_color:new a.Uniform3f(d,i.u_end_color)})};let zo;function ic(d,i,l,p,_,y,b){const T=d.context,C=T.gl,M=d.useProgram("collisionBox"),k=[];let P=0,F=0;for(let J=0;J<p.length;J++){const H=p[J],K=i.getTile(H),te=K.getBucket(l);if(!te)continue;let de=H.projMatrix;_[0]===0&&_[1]===0||(de=d.translatePosMatrix(H.projMatrix,K,_,y));const _e=b?te.textCollisionBox:te.iconCollisionBox,Be=te.collisionCircleArray;if(Be.length>0){const ke=a.create(),Ce=de;a.mul(ke,te.placementInvProjMatrix,d.transform.glCoordMatrix),a.mul(ke,ke,te.placementViewportMatrix),k.push({circleArray:Be,circleOffset:F,transform:Ce,invTransform:ke}),P+=Be.length/4,F=P}_e&&(d.terrain&&d.terrain.setupElevationDraw(K,M),M.draw(T,C.LINES,a.DepthMode.disabled,a.StencilMode.disabled,d.colorModeForRenderPass(),a.CullFaceMode.disabled,$h(de,d.transform,K),l.id,_e.layoutVertexBuffer,_e.indexBuffer,_e.segments,null,d.transform.zoom,null,_e.collisionVertexBuffer,_e.collisionVertexBufferExt))}if(!b||!k.length)return;const j=d.useProgram("collisionCircle"),N=new a.StructArrayLayout2f1f2i16;N.resize(4*P),N._trim();let $=0;for(const J of k)for(let H=0;H<J.circleArray.length/4;H++){const K=4*H,te=J.circleArray[K+0],de=J.circleArray[K+1],_e=J.circleArray[K+2],Be=J.circleArray[K+3];N.emplace($++,te,de,_e,Be,0),N.emplace($++,te,de,_e,Be,1),N.emplace($++,te,de,_e,Be,2),N.emplace($++,te,de,_e,Be,3)}(!zo||zo.length<2*P)&&(zo=function(J){const H=2*J,K=new a.StructArrayLayout3ui6;K.resize(H),K._trim();for(let te=0;te<H;te++){const de=6*te;K.uint16[de+0]=4*te+0,K.uint16[de+1]=4*te+1,K.uint16[de+2]=4*te+2,K.uint16[de+3]=4*te+2,K.uint16[de+4]=4*te+3,K.uint16[de+5]=4*te+0}return K}(P));const ee=T.createIndexBuffer(zo,!0),V=T.createVertexBuffer(N,a.collisionCircleLayout.members,!0);for(const J of k){const H={u_matrix:J.transform,u_inv_matrix:J.invTransform,u_camera_to_center_distance:(Y=d.transform).cameraToCenterDistance,u_viewport_size:[Y.width,Y.height]};j.draw(T,C.TRIANGLES,a.DepthMode.disabled,a.StencilMode.disabled,d.colorModeForRenderPass(),a.CullFaceMode.disabled,H,l.id,V,ee,a.SegmentVector.simpleSegment(0,2*J.circleOffset,J.circleArray.length,J.circleArray.length/2),null,d.transform.zoom,null,null,null)}var Y;V.destroy(),ee.destroy()}const Oa=a.identity(new Float32Array(16));function Wh(d,i,l,p,_,y){const{horizontalAlign:b,verticalAlign:T}=a.getAnchorAlignment(d),C=-(b-.5)*i,M=-(T-.5)*l,k=a.evaluateVariableOffset(d,p);return new a.pointGeometry((C/_+k[0])*y,(M/_+k[1])*y)}function ep(d,i,l,p,_,y,b,T,C,M,k,P){const F=d.text.placedSymbolArray,j=d.text.dynamicLayoutVertexArray,N=d.icon.dynamicLayoutVertexArray,$={},ee=T.projMatrix,V=y.elevation,Y=V?V.getAtTileOffsetFunc(T,P):J=>[0,0,0];j.clear();for(let J=0;J<F.length;J++){const H=F.get(J),K=d.allowVerticalPlacement&&!H.placedOrientation,te=H.hidden||!H.crossTileID||K?null:p[H.crossTileID];if(te){const de=new a.pointGeometry(H.tileAnchorX,H.tileAnchorY),_e=Y(de),Be=Ri(de,l?ee:b,_e[2]),ke=Qr(y.cameraToCenterDistance,Be.signedDistanceFromCamera);let Ce=_.evaluateSizeForFeature(d.textSizeData,M,H)*ke/a.ONE_EM;l&&(Ce*=d.tilePixelRatio/C);const{width:xe,height:me,anchor:Ae,textOffset:Ee,textScale:Xe}=te,et=Wh(Ae,xe,me,Ee,Xe,Ce),ht=l?Ri(de.add(et),b,_e[2]).point:Be.point.add(i?et.rotate(-y.angle):et),Re=d.allowVerticalPlacement&&H.placedOrientation===a.WritingMode.vertical?Math.PI/2:0;for(let Ke=0;Ke<H.numGlyphs;Ke++)a.addDynamicAttributes(j,ht,Re);k&&H.associatedIconIndex>=0&&($[H.associatedIconIndex]={shiftedAnchor:ht,angle:Re})}else Nr(H.numGlyphs,j)}if(k){N.clear();const J=d.icon.placedSymbolArray;for(let H=0;H<J.length;H++){const K=J.get(H);if(K.hidden)Nr(K.numGlyphs,N);else{const te=$[H];if(te)for(let de=0;de<K.numGlyphs;de++)a.addDynamicAttributes(N,te.shiftedAnchor,te.angle);else Nr(K.numGlyphs,N)}}d.icon.dynamicLayoutVertexBuffer.updateData(N)}d.text.dynamicLayoutVertexBuffer.updateData(j)}function tp(d,i,l){return l.iconsInText&&i?"symbolTextAndIcon":d?"symbolSDF":"symbolIcon"}function Na(d,i,l,p,_,y,b,T,C,M,k,P){const F=d.context,j=F.gl,N=d.transform,$=N.projection.createTileTransform(N,N.worldSize),ee=T==="map",V=C==="map",Y=ee&&l.layout.get("symbol-placement")!=="point",J=ee&&!V&&!Y,H=l.layout.get("symbol-sort-key").constantOr(1)!==void 0;let K=!1;const te=d.depthModeForSublayer(0,a.DepthMode.ReadOnly),de=[a.mercatorXfromLng(N.center.lng),a.mercatorYfromLat(N.center.lat)],_e=l.layout.get("text-variable-anchor"),Be=N.projection.name==="globe",ke=Be?a.globeToMercatorTransition(N.zoom):0,Ce=[],xe=[];d.terrain&&V&&xe.push("PITCH_WITH_MAP_TERRAIN"),Be&&xe.push("PROJECTION_GLOBE_VIEW"),Y&&xe.push("PROJECTED_POS_ON_VIEWPORT");for(const me of p){const Ae=i.getTile(me),Ee=Ae.getBucket(l);if(!Ee||Ee.projection!==N.projection.name)continue;const Xe=_?Ee.text:Ee.icon;if(!Xe||Ee.fullyClipped||!Xe.segments.get().length)continue;const et=Xe.programConfigurations.get(l.id),ht=_||Ee.sdfIcons,Re=_?Ee.textSizeData:Ee.iconSizeData,Ke=V||N.pitch!==0,st=d.useProgram(tp(ht,_,Ee),et,xe),Rt=a.evaluateSizeForZoom(Re,N.zoom),jt=[me.canonical.x,me.canonical.y,1<<me.canonical.z];let nt,_t,Yt,vi,nr=[0,0],kr=null;if(_){if(_t=Ae.glyphAtlasTexture,Yt=j.LINEAR,nt=Ae.glyphAtlasTexture.size,Ee.iconsInText){nr=Ae.imageAtlasTexture.size,kr=Ae.imageAtlasTexture;const Ii=Re.kind==="composite"||Re.kind==="camera";vi=Ke||d.options.rotating||d.options.zooming||Ii?j.LINEAR:j.NEAREST}}else{const Ii=l.layout.get("icon-size").constantOr(0)!==1||Ee.iconsNeedLinear;_t=Ae.imageAtlasTexture,Yt=ht||d.options.rotating||d.options.zooming||Ii||Ke?j.LINEAR:j.NEAREST,nt=Ae.imageAtlasTexture.size}const $r=d.transform.calculatePixelsToTileUnitsMatrix(Ae),Et=Mn(me.projMatrix,Ae.tileID.canonical,V,ee,d.transform,$r),ot=d.terrain&&V&&Y?a.invert(new Float32Array(16),Et):Oa,vt=pn(me.projMatrix,Ae.tileID.canonical,V,ee,d.transform,$r),oi=_e&&Ee.hasTextData(),pr=l.layout.get("icon-text-fit")!=="none"&&oi&&Ee.hasIconData();if(Y){const Ii=N.elevation,os=Ii?Ii.getAtTileOffsetFunc(me,$):Vn=>[0,0,0];Dh(Ee,me.projMatrix,d,_,Et,vt,V,M,os,me)}const Wt=d.translatePosMatrix(me.projMatrix,Ae,y,b),fr=Y||_&&_e||pr?Oa:Et,Wo=d.translatePosMatrix(vt,Ae,y,b,!0),sr=ht&&l.paint.get(_?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let ss;const Ge=$.createInversionMatrix(me.toUnwrapped());ss=ht?Ee.iconsInText?Do(Re.kind,Rt,J,V,d,Wt,fr,Wo,nt,nr,jt,ke,Ge,de):ko(Re.kind,Rt,J,V,d,Wt,fr,Wo,_,nt,!0,jt,ke,Ge,de):Ba(Re.kind,Rt,J,V,d,Wt,fr,Wo,_,nt,jt,ke,Ge,de);const Ye={program:st,buffers:Xe,uniformValues:ss,atlasTexture:_t,atlasTextureIcon:kr,atlasInterpolation:Yt,atlasInterpolationIcon:vi,isSDF:ht,hasHalo:sr,tile:Ae,labelPlaneMatrixInv:ot};if(H&&Ee.canOverlap){K=!0;const Ii=Xe.segments.get();for(const os of Ii)Ce.push({segments:new a.SegmentVector([os]),sortKey:os.sortKey,state:Ye})}else Ce.push({segments:Xe.segments,sortKey:0,state:Ye})}K&&Ce.sort((me,Ae)=>me.sortKey-Ae.sortKey);for(const me of Ce){const Ae=me.state;if(d.terrain&&d.terrain.setupElevationDraw(Ae.tile,Ae.program,{useDepthForOcclusion:!Be,labelPlaneMatrixInv:Ae.labelPlaneMatrixInv}),F.activeTexture.set(j.TEXTURE0),Ae.atlasTexture.bind(Ae.atlasInterpolation,j.CLAMP_TO_EDGE),Ae.atlasTextureIcon&&(F.activeTexture.set(j.TEXTURE1),Ae.atlasTextureIcon&&Ae.atlasTextureIcon.bind(Ae.atlasInterpolationIcon,j.CLAMP_TO_EDGE)),Ae.isSDF){const Ee=Ae.uniformValues;Ae.hasHalo&&(Ee.u_is_halo=1,Ua(Ae.buffers,me.segments,l,d,Ae.program,te,k,P,Ee)),Ee.u_is_halo=0}Ua(Ae.buffers,me.segments,l,d,Ae.program,te,k,P,Ae.uniformValues)}}function Ua(d,i,l,p,_,y,b,T,C){const M=p.context;_.draw(M,M.gl.TRIANGLES,y,b,T,a.CullFaceMode.disabled,C,l.id,d.layoutVertexBuffer,d.indexBuffer,i,l.paint,p.transform.zoom,d.programConfigurations.get(l.id),d.dynamicLayoutVertexBuffer,d.opacityVertexBuffer)}function Va(d,i,l,p,_,y,b){const T=d.context.gl,C=l.paint.get("fill-pattern"),M=C&&C.constantOr(1),k=l.getCrossfadeParameters();let P,F,j,N,$;b?(F=M&&!l.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",P=T.LINES):(F=M?"fillPattern":"fill",P=T.TRIANGLES);for(const ee of p){const V=i.getTile(ee);if(M&&!V.patternsLoaded())continue;const Y=V.getBucket(l);if(!Y)continue;d.prepareDrawTile(ee);const J=Y.programConfigurations.get(l.id),H=d.useProgram(F,J);M&&(d.context.activeTexture.set(T.TEXTURE0),V.imageAtlasTexture.bind(T.LINEAR,T.CLAMP_TO_EDGE),J.updatePaintBuffers(k));const K=C.constantOr(null);if(K&&V.imageAtlas){const de=V.imageAtlas,_e=de.patternPositions[K.to.toString()],Be=de.patternPositions[K.from.toString()];_e&&Be&&J.setConstantPatternPositions(_e,Be)}const te=d.translatePosMatrix(ee.projMatrix,V,l.paint.get("fill-translate"),l.paint.get("fill-translate-anchor"));if(b){N=Y.indexBuffer2,$=Y.segments2;const de=d.terrain&&d.terrain.renderingToTexture?d.terrain.drapeBufferSize:[T.drawingBufferWidth,T.drawingBufferHeight];j=F==="fillOutlinePattern"&&M?jh(te,d,k,V,de):Jd(te,de)}else N=Y.indexBuffer,$=Y.segments,j=M?Ql(te,d,k,V):Vh(te);d.prepareDrawProgram(d.context,H,ee.toUnwrapped()),H.draw(d.context,P,_,d.stencilModeForClipping(ee),y,a.CullFaceMode.disabled,j,l.id,Y.layoutVertexBuffer,N,$,l.paint,d.transform.zoom,J)}}function Po(d,i,l,p,_,y,b){const T=d.context,C=T.gl,M=l.paint.get("fill-extrusion-pattern"),k=M.constantOr(1),P=l.getCrossfadeParameters(),F=l.paint.get("fill-extrusion-opacity");for(const j of p){const N=i.getTile(j),$=N.getBucket(l);if(!$)continue;const ee=$.programConfigurations.get(l.id),V=d.useProgram(k?"fillExtrusionPattern":"fillExtrusion",ee);if(d.terrain){const te=d.terrain;if(!$.enableTerrain)continue;if(te.setupElevationDraw(N,V,{useMeterToDem:!0}),Xh(T,i,j,$,l,te),!$.centroidVertexBuffer){const de=V.attributes.a_centroid_pos;de!==void 0&&C.vertexAttrib2f(de,0,0)}}k&&(d.context.activeTexture.set(C.TEXTURE0),N.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),ee.updatePaintBuffers(P));const Y=M.constantOr(null);if(Y&&N.imageAtlas){const te=N.imageAtlas,de=te.patternPositions[Y.to.toString()],_e=te.patternPositions[Y.from.toString()];de&&_e&&ee.setConstantPatternPositions(de,_e)}const J=d.translatePosMatrix(j.projMatrix,N,l.paint.get("fill-extrusion-translate"),l.paint.get("fill-extrusion-translate-anchor")),H=l.paint.get("fill-extrusion-vertical-gradient"),K=k?Jl(J,d,H,F,j,P,N):Uh(J,d,H,F);d.prepareDrawProgram(T,V,j.toUnwrapped()),V.draw(T,T.gl.TRIANGLES,_,y,b,a.CullFaceMode.backCCW,K,l.id,$.layoutVertexBuffer,$.indexBuffer,$.segments,l.paint,d.transform.zoom,ee,d.terrain?$.centroidVertexBuffer:null)}}function Xh(d,i,l,p,_,y){const b=[V=>{let Y=V.canonical.x-1,J=V.wrap;return Y<0&&(Y=(1<<V.canonical.z)-1,J--),new a.OverscaledTileID(V.overscaledZ,J,V.canonical.z,Y,V.canonical.y)},V=>{let Y=V.canonical.x+1,J=V.wrap;return Y===1<<V.canonical.z&&(Y=0,J++),new a.OverscaledTileID(V.overscaledZ,J,V.canonical.z,Y,V.canonical.y)},V=>new a.OverscaledTileID(V.overscaledZ,V.wrap,V.canonical.z,V.canonical.x,(V.canonical.y===0?1<<V.canonical.z:V.canonical.y)-1),V=>new a.OverscaledTileID(V.overscaledZ,V.wrap,V.canonical.z,V.canonical.x,V.canonical.y===(1<<V.canonical.z)-1?0:V.canonical.y+1)],T=V=>{const Y=i.getSource().maxzoom,J=de=>{const _e=i.getTileByID(de);if(_e&&_e.hasData())return _e.getBucket(_)};let H,K,te;return(V.overscaledZ===V.canonical.z||V.overscaledZ>=Y)&&(H=J(V.key)),V.overscaledZ>=Y&&(K=J(V.calculateScaledKey(V.overscaledZ+1))),V.overscaledZ>Y&&(te=J(V.calculateScaledKey(V.overscaledZ-1))),H||K||te},C=[0,0,0],M=(V,Y)=>(C[0]=Math.min(V.min.y,Y.min.y),C[1]=Math.max(V.max.y,Y.max.y),C[2]=a.EXTENT-Y.min.x>V.max.x?Y.min.x-a.EXTENT:V.max.x,C),k=(V,Y)=>(C[0]=Math.min(V.min.x,Y.min.x),C[1]=Math.max(V.max.x,Y.max.x),C[2]=a.EXTENT-Y.min.y>V.max.y?Y.min.y-a.EXTENT:V.max.y,C),P=[(V,Y)=>M(V,Y),(V,Y)=>M(Y,V),(V,Y)=>k(V,Y),(V,Y)=>k(Y,V)],F=new a.pointGeometry(0,0);let j,N,$;const ee=(V,Y,J,H,K)=>{const te=[[H?J:V,H?V:J,0],[H?J:Y,H?Y:J,0]],de=K<0?a.EXTENT+K:K,_e=[H?de:(V+Y)/2,H?(V+Y)/2:de,0];return J===0&&K<0||J!==0&&K>0?y.getForTilePoints($,[_e],!0,N):te.push(_e),y.getForTilePoints(l,te,!0,j),Math.max(te[0][2],te[1][2],_e[2])/y.exaggeration()};for(let V=0;V<4;V++){const Y=p.borders[V];if(Y.length===0&&(p.borderDone[V]=!0),p.borderDone[V])continue;const J=$=b[V](l),H=T(J);if(!H||!H.enableTerrain||(N=y.findDEMTileFor(J),!N||!N.dem))continue;if(!j){const _e=y.findDEMTileFor(l);if(!_e||!_e.dem)return;j=_e}const K=(V<2?1:5)-V,te=H.borders[K];let de=0;for(let _e=0;_e<Y.length;_e++){const Be=p.featuresOnBorder[Y[_e]],ke=Be.borders[V];let Ce;for(;de<te.length&&(Ce=H.featuresOnBorder[te[de]],!(Ce.borders[K][1]>ke[0]+3));)H.borderDone[K]||H.encodeCentroid(void 0,Ce,!1),de++;if(Ce&&de<te.length){const xe=de;let me=0;for(;!(Ce.borders[K][0]>ke[1]-3)&&(me++,++de!==te.length);)Ce=H.featuresOnBorder[te[de]];if(Ce=H.featuresOnBorder[te[xe]],Be.intersectsCount()>1||Ce.intersectsCount()>1||me!==1){me!==1&&(de=xe),p.encodeCentroid(void 0,Be,!1),H.borderDone[K]||H.encodeCentroid(void 0,Ce,!1);continue}const Ae=P[V](Be,Ce),Ee=V%2?a.EXTENT-1:0;F.x=ee(Ae[0],Math.min(a.EXTENT-1,Ae[1]),Ee,V<2,Ae[2]),F.y=0,p.encodeCentroid(F,Be,!1),H.borderDone[K]||H.encodeCentroid(F,Ce,!1)}else p.encodeCentroid(void 0,Be,!1)}p.borderDone[V]=p.needsCentroidUpdate=!0,H.borderDone[K]||(H.borderDone[K]=H.needsCentroidUpdate=!0)}(p.needsCentroidUpdate||!p.centroidVertexBuffer&&p.centroidVertexArray.length!==0)&&p.uploadCentroid(d)}const Hh=new a.Color(1,0,0,1),ip=new a.Color(0,1,0,1),Lo=new a.Color(0,0,1,1),Ro=new a.Color(1,0,1,1),Kh=new a.Color(0,1,1,1);function rr(d,i,l,p){ns(d,0,i+l/2,d.transform.width,l,p)}function ja(d,i,l,p){ns(d,i-l/2,0,l,d.transform.height,p)}function ns(d,i,l,p,_,y){const b=d.context,T=b.gl;T.enable(T.SCISSOR_TEST),T.scissor(i*a.exported.devicePixelRatio,l*a.exported.devicePixelRatio,p*a.exported.devicePixelRatio,_*a.exported.devicePixelRatio),b.clear({color:y}),T.disable(T.SCISSOR_TEST)}function $a(d,i,l){const p=d.context,_=p.gl,y=l.projMatrix,b=d.useProgram("debug"),T=i.getTileByID(l.key);d.terrain&&d.terrain.setupElevationDraw(T,b);const C=a.DepthMode.disabled,M=a.StencilMode.disabled,k=d.colorModeForRenderPass(),P="$debug";p.activeTexture.set(_.TEXTURE0),d.emptyTexture.bind(_.LINEAR,_.CLAMP_TO_EDGE),T._makeDebugTileBoundsBuffers(d.context,d.transform.projection);const F=T._tileDebugBuffer||d.debugBuffer,j=T._tileDebugIndexBuffer||d.debugIndexBuffer,N=T._tileDebugSegments||d.debugSegments;b.draw(p,_.LINE_STRIP,C,M,k,a.CullFaceMode.disabled,tc(y,a.Color.red),P,F,j,N);const $=T.latestRawTileData,ee=Math.floor(($&&$.byteLength||0)/1024),V=i.getTile(l).tileSize,Y=512/Math.min(V,512)*(l.overscaledZ/d.transform.zoom)*.5;let J=l.canonical.toString();l.overscaledZ!==l.canonical.z&&(J+=` => ${l.overscaledZ}`),function(H,K){H.initDebugOverlayCanvas();const te=H.debugOverlayCanvas,de=H.context.gl,_e=H.debugOverlayCanvas.getContext("2d");_e.clearRect(0,0,te.width,te.height),_e.shadowColor="white",_e.shadowBlur=2,_e.lineWidth=1.5,_e.strokeStyle="white",_e.textBaseline="top",_e.font="bold 36px Open Sans, sans-serif",_e.fillText(K,5,5),_e.strokeText(K,5,5),H.debugOverlayTexture.update(te),H.debugOverlayTexture.bind(de.LINEAR,de.CLAMP_TO_EDGE)}(d,`${J} ${ee}kb`),b.draw(p,_.TRIANGLES,C,M,a.ColorMode.alphaBlended,a.CullFaceMode.disabled,tc(y,a.Color.transparent,Y),P,d.debugBuffer,d.quadTriangleIndexBuffer,d.debugSegments)}const rc=a.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:nc}=rc;function Ur(d,i,l,p){d.emplaceBack(i,l,p)}class Ga{constructor(i){this.vertexArray=new a.StructArrayLayout3f12,this.indices=new a.StructArrayLayout3ui6,Ur(this.vertexArray,-1,-1,1),Ur(this.vertexArray,1,-1,1),Ur(this.vertexArray,-1,1,1),Ur(this.vertexArray,1,1,1),Ur(this.vertexArray,-1,-1,-1),Ur(this.vertexArray,1,-1,-1),Ur(this.vertexArray,-1,1,-1),Ur(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=i.createVertexBuffer(this.vertexArray,nc),this.indexBuffer=i.createIndexBuffer(this.indices),this.segment=a.SegmentVector.simpleSegment(0,0,36,12)}}function Fn(d,i,l,p,_,y){const b=d.gl,T=i.paint.get("sky-atmosphere-color"),C=i.paint.get("sky-atmosphere-halo-color"),M=i.paint.get("sky-atmosphere-sun-intensity"),k=((P,F,j,N,$)=>({u_matrix_3f:P,u_sun_direction:F,u_sun_intensity:j,u_color_tint_r:[N.r,N.g,N.b,N.a],u_color_tint_m:[$.r,$.g,$.b,$.a],u_luminance:5e-5}))(a.fromMat4([],p),_,M,T,C);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_CUBE_MAP_POSITIVE_X+y,i.skyboxTexture,0),l.draw(d,b.TRIANGLES,a.DepthMode.disabled,a.StencilMode.disabled,a.ColorMode.unblended,a.CullFaceMode.frontCW,k,"skyboxCapture",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}const Bo={symbol:function(d,i,l,p,_){if(d.renderPass!=="translucent")return;const y=a.StencilMode.disabled,b=d.colorModeForRenderPass();l.layout.get("text-variable-anchor")&&function(T,C,M,k,P,F,j){const N=C.transform,$=P==="map",ee=F==="map",V=N.projection.createTileTransform(N,N.worldSize);for(const Y of T){const J=k.getTile(Y),H=J.getBucket(M);if(!H||H.projection!==N.projection.name||!H.text||!H.text.segments.get().length)continue;const K=a.evaluateSizeForZoom(H.textSizeData,N.zoom),te=C.transform.calculatePixelsToTileUnitsMatrix(J),de=Mn(Y.projMatrix,J.tileID.canonical,ee,$,C.transform,te),_e=M.layout.get("icon-text-fit")!=="none"&&H.hasIconData();if(K){const Be=Math.pow(2,N.zoom-J.tileID.overscaledZ);ep(H,$,ee,j,a.symbolSize,N,de,Y,Be,K,_e,V)}}}(p,d,l,i,l.layout.get("text-rotation-alignment"),l.layout.get("text-pitch-alignment"),_),l.paint.get("icon-opacity").constantOr(1)!==0&&Na(d,i,l,p,!1,l.paint.get("icon-translate"),l.paint.get("icon-translate-anchor"),l.layout.get("icon-rotation-alignment"),l.layout.get("icon-pitch-alignment"),l.layout.get("icon-keep-upright"),y,b),l.paint.get("text-opacity").constantOr(1)!==0&&Na(d,i,l,p,!0,l.paint.get("text-translate"),l.paint.get("text-translate-anchor"),l.layout.get("text-rotation-alignment"),l.layout.get("text-pitch-alignment"),l.layout.get("text-keep-upright"),y,b),i.map.showCollisionBoxes&&(ic(d,i,l,p,l.paint.get("text-translate"),l.paint.get("text-translate-anchor"),!0),ic(d,i,l,p,l.paint.get("icon-translate"),l.paint.get("icon-translate-anchor"),!1))},circle:function(d,i,l,p){if(d.renderPass!=="translucent")return;const _=l.paint.get("circle-opacity"),y=l.paint.get("circle-stroke-width"),b=l.paint.get("circle-stroke-opacity"),T=l.layout.get("circle-sort-key").constantOr(1)!==void 0;if(_.constantOr(1)===0&&(y.constantOr(1)===0||b.constantOr(1)===0))return;const C=d.context,M=C.gl,k=d.depthModeForSublayer(0,a.DepthMode.ReadOnly),P=a.StencilMode.disabled,F=d.colorModeForRenderPass(),j=[];for(let $=0;$<p.length;$++){const ee=p[$],V=i.getTile(ee),Y=V.getBucket(l);if(!Y)continue;const J=Y.programConfigurations.get(l.id),H=ec(l),K={programConfiguration:J,program:d.useProgram("circle",J,H),layoutVertexBuffer:Y.layoutVertexBuffer,indexBuffer:Y.indexBuffer,uniformValues:Qd(d,ee,V,l),tile:V};if(T){const te=Y.segments.get();for(const de of te)j.push({segments:new a.SegmentVector([de]),sortKey:de.sortKey,state:K})}else j.push({segments:Y.segments,sortKey:0,state:K})}T&&j.sort(($,ee)=>$.sortKey-ee.sortKey);const N={useDepthForOcclusion:d.transform.projection.name!=="globe"};for(const $ of j){const{programConfiguration:ee,program:V,layoutVertexBuffer:Y,indexBuffer:J,uniformValues:H,tile:K}=$.state,te=$.segments;d.terrain&&d.terrain.setupElevationDraw(K,V,N),d.prepareDrawProgram(C,V,K.tileID.toUnwrapped()),V.draw(C,M.TRIANGLES,k,P,F,a.CullFaceMode.disabled,H,l.id,Y,J,te,l.paint,d.transform.zoom,ee)}},heatmap:function(d,i,l,p){if(l.paint.get("heatmap-opacity")!==0)if(d.renderPass==="offscreen"){const _=d.context,y=_.gl,b=a.StencilMode.disabled,T=new a.ColorMode([y.ONE,y.ONE],a.Color.transparent,[!0,!0,!0,!0]);(function(C,M,k){const P=C.gl;C.activeTexture.set(P.TEXTURE1),C.viewport.set([0,0,M.width/4,M.height/4]);let F=k.heatmapFbo;if(F)P.bindTexture(P.TEXTURE_2D,F.colorAttachment.get()),C.bindFramebuffer.set(F.framebuffer);else{const j=P.createTexture();P.bindTexture(P.TEXTURE_2D,j),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MIN_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MAG_FILTER,P.LINEAR),F=k.heatmapFbo=C.createFramebuffer(M.width/4,M.height/4,!1),function(N,$,ee,V){const Y=N.gl;Y.texImage2D(Y.TEXTURE_2D,0,Y.RGBA,$.width/4,$.height/4,0,Y.RGBA,N.extRenderToTextureHalfFloat?N.extTextureHalfFloat.HALF_FLOAT_OES:Y.UNSIGNED_BYTE,null),V.colorAttachment.set(ee)}(C,M,j,F)}})(_,d,l),_.clear({color:a.Color.transparent});for(let C=0;C<p.length;C++){const M=p[C];if(i.hasRenderableParent(M))continue;const k=i.getTile(M),P=k.getBucket(l);if(!P)continue;const F=P.programConfigurations.get(l.id),j=d.useProgram("heatmap",F),{zoom:N}=d.transform;d.terrain&&d.terrain.setupElevationDraw(k,j),d.prepareDrawProgram(_,j,M.toUnwrapped()),j.draw(_,y.TRIANGLES,a.DepthMode.disabled,b,T,a.CullFaceMode.disabled,Gh(M.projMatrix,k,N,l.paint.get("heatmap-intensity")),l.id,P.layoutVertexBuffer,P.indexBuffer,P.segments,l.paint,d.transform.zoom,F)}_.viewport.set([0,0,d.width,d.height])}else d.renderPass==="translucent"&&(d.context.setColorMode(d.colorModeForRenderPass()),function(_,y){const b=_.context,T=b.gl,C=y.heatmapFbo;if(!C)return;b.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,C.colorAttachment.get()),b.activeTexture.set(T.TEXTURE1);let M=y.colorRampTexture;M||(M=y.colorRampTexture=new a.Texture(b,y.colorRamp,T.RGBA)),M.bind(T.LINEAR,T.CLAMP_TO_EDGE),_.useProgram("heatmapTexture").draw(b,T.TRIANGLES,a.DepthMode.disabled,a.StencilMode.disabled,_.colorModeForRenderPass(),a.CullFaceMode.disabled,((k,P,F,j)=>({u_image:0,u_color_ramp:1,u_opacity:P.paint.get("heatmap-opacity")}))(0,y),y.id,_.viewportBuffer,_.quadTriangleIndexBuffer,_.viewportSegments,y.paint,_.transform.zoom)}(d,l))},line:function(d,i,l,p){if(d.renderPass!=="translucent")return;const _=l.paint.get("line-opacity"),y=l.paint.get("line-width");if(_.constantOr(1)===0||y.constantOr(1)===0)return;const b=d.depthModeForSublayer(0,a.DepthMode.ReadOnly),T=d.colorModeForRenderPass(),C=l.paint.get("line-dasharray"),M=C.constantOr(1),k=l.layout.get("line-cap"),P=l.paint.get("line-pattern"),F=P.constantOr(1),j=l.paint.get("line-gradient"),N=l.getCrossfadeParameters(),$=F?"linePattern":"line",ee=d.context,V=ee.gl,Y=(H=>{const K=[];Mo(H)&&K.push("RENDER_LINE_DASH"),H.paint.get("line-gradient")&&K.push("RENDER_LINE_GRADIENT");const te=H.paint.get("line-pattern").constantOr(1),de=H.paint.get("line-opacity").constantOr(1)!==1;return!te&&de&&K.push("RENDER_LINE_ALPHA_DISCARD"),K})(l);let J=Y.includes("RENDER_LINE_ALPHA_DISCARD");d.terrain&&d.terrain.clipOrMaskOverlapStencilType()&&(J=!1);for(const H of p){const K=i.getTile(H);if(F&&!K.patternsLoaded())continue;const te=K.getBucket(l);if(!te)continue;d.prepareDrawTile(H);const de=te.programConfigurations.get(l.id),_e=d.useProgram($,de,Y),Be=P.constantOr(null);if(Be&&K.imageAtlas){const Ee=K.imageAtlas,Xe=Ee.patternPositions[Be.to.toString()],et=Ee.patternPositions[Be.from.toString()];Xe&&et&&de.setConstantPatternPositions(Xe,et)}const ke=C.constantOr(null),Ce=k.constantOr(null);if(!F&&ke&&Ce&&K.lineAtlas){const Ee=K.lineAtlas,Xe=Ee.getDash(ke.to,Ce),et=Ee.getDash(ke.from,Ce);Xe&&et&&de.setConstantPatternPositions(Xe,et)}const xe=d.terrain?H.projMatrix:null,me=F?rs(d,K,l,N,xe):qh(d,K,l,N,xe,te.lineClipsArray.length);if(j){const Ee=te.gradients[l.id];let Xe=Ee.texture;if(l.gradientVersion!==Ee.version){let et=256;if(l.stepInterpolant){const ht=i.getSource().maxzoom,Re=H.canonical.z===ht?Math.ceil(1<<d.transform.maxZoom-H.canonical.z):1;et=a.clamp(a.nextPowerOfTwo(te.maxLineLength/a.EXTENT*1024*Re),256,ee.maxTextureSize)}Ee.gradient=a.renderColorRamp({expression:l.gradientExpression(),evaluationKey:"lineProgress",resolution:et,image:Ee.gradient||void 0,clips:te.lineClipsArray}),Ee.texture?Ee.texture.update(Ee.gradient):Ee.texture=new a.Texture(ee,Ee.gradient,V.RGBA),Ee.version=l.gradientVersion,Xe=Ee.texture}ee.activeTexture.set(V.TEXTURE1),Xe.bind(l.stepInterpolant?V.NEAREST:V.LINEAR,V.CLAMP_TO_EDGE)}M&&(ee.activeTexture.set(V.TEXTURE0),K.lineAtlasTexture.bind(V.LINEAR,V.REPEAT),de.updatePaintBuffers(N)),F&&(ee.activeTexture.set(V.TEXTURE0),K.imageAtlasTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE),de.updatePaintBuffers(N)),d.prepareDrawProgram(ee,_e,H.toUnwrapped());const Ae=Ee=>{_e.draw(ee,V.TRIANGLES,b,Ee,T,a.CullFaceMode.disabled,me,l.id,te.layoutVertexBuffer,te.indexBuffer,te.segments,l.paint,d.transform.zoom,de,te.layoutVertexBuffer2)};if(J){const Ee=d.stencilModeForClipping(H).ref;Ee===0&&d.terrain&&ee.clear({stencil:0});const Xe={func:V.EQUAL,mask:255};me.u_alpha_discard_threshold=.8,Ae(new a.StencilMode(Xe,Ee,255,V.KEEP,V.KEEP,V.INVERT)),me.u_alpha_discard_threshold=0,Ae(new a.StencilMode(Xe,Ee,255,V.KEEP,V.KEEP,V.KEEP))}else Ae(d.stencilModeForClipping(H))}J&&(d.resetStencilClippingMasks(),d.terrain&&ee.clear({stencil:0}))},fill:function(d,i,l,p){const _=l.paint.get("fill-color"),y=l.paint.get("fill-opacity");if(y.constantOr(1)===0)return;const b=d.colorModeForRenderPass(),T=l.paint.get("fill-pattern"),C=d.opaquePassEnabledForLayer()&&!T.constantOr(1)&&_.constantOr(a.Color.transparent).a===1&&y.constantOr(0)===1?"opaque":"translucent";if(d.renderPass===C){const M=d.depthModeForSublayer(1,d.renderPass==="opaque"?a.DepthMode.ReadWrite:a.DepthMode.ReadOnly);Va(d,i,l,p,M,b,!1)}if(d.renderPass==="translucent"&&l.paint.get("fill-antialias")){const M=d.depthModeForSublayer(l.getPaintProperty("fill-outline-color")?2:0,a.DepthMode.ReadOnly);Va(d,i,l,p,M,b,!0)}},"fill-extrusion":function(d,i,l,p){const _=l.paint.get("fill-extrusion-opacity");if(_!==0&&d.renderPass==="translucent"){const y=new a.DepthMode(d.context.gl.LEQUAL,a.DepthMode.ReadWrite,d.depthRangeFor3D);if(_!==1||l.paint.get("fill-extrusion-pattern").constantOr(1))Po(d,i,l,p,y,a.StencilMode.disabled,a.ColorMode.disabled),Po(d,i,l,p,y,d.stencilModeFor3D(),d.colorModeForRenderPass()),d.resetStencilClippingMasks();else{const b=d.colorModeForRenderPass();Po(d,i,l,p,y,a.StencilMode.disabled,b)}}},hillshade:function(d,i,l,p){if(d.renderPass!=="offscreen"&&d.renderPass!=="translucent")return;const _=d.context,y=d.depthModeForSublayer(0,a.DepthMode.ReadOnly),b=d.colorModeForRenderPass(),T=d.terrain&&d.terrain.renderingToTexture,[C,M]=d.renderPass!=="translucent"||T?[{},p]:d.stencilConfigForOverlap(p);for(const k of M){const P=i.getTile(k);if(P.needsHillshadePrepare&&d.renderPass==="offscreen")So(d,P,l,y,a.StencilMode.disabled,b);else if(d.renderPass==="translucent"){const F=T&&d.terrain?d.terrain.stencilModeForRTTOverlap(k):C[k.overscaledZ];Da(d,k,P,l,y,F,b)}}_.viewport.set([0,0,d.width,d.height]),d.resetStencilClippingMasks()},raster:function(d,i,l,p,_,y){if(d.renderPass!=="translucent"||l.paint.get("raster-opacity")===0||!p.length)return;const b=d.context,T=b.gl,C=i.getSource(),M=d.useProgram("raster"),k=d.colorModeForRenderPass(),P=d.terrain&&d.terrain.renderingToTexture,[F,j]=C instanceof Or||P?[{},p]:d.stencilConfigForOverlap(p),N=j[j.length-1].overscaledZ,$=!d.options.moving;for(const ee of j){const V=P?a.DepthMode.disabled:d.depthModeForSublayer(ee.overscaledZ-N,l.paint.get("raster-opacity")===1?a.DepthMode.ReadWrite:a.DepthMode.ReadOnly,T.LESS),Y=ee.toUnwrapped(),J=i.getTile(ee);if(P&&(!J||!J.hasData()))continue;const H=P?ee.projMatrix:d.transform.calculateProjMatrix(Y,$),K=d.terrain&&P?d.terrain.stencilModeForRTTOverlap(ee):F[ee.overscaledZ],te=y?0:l.paint.get("raster-fade-duration");J.registerFadeDuration(te);const de=i.findLoadedParent(ee,0),_e=Fh(J,de,i,d.transform,te);let Be,ke;d.terrain&&d.terrain.prepareDrawTile(ee);const Ce=l.paint.get("raster-resampling")==="nearest"?T.NEAREST:T.LINEAR;b.activeTexture.set(T.TEXTURE0),J.texture.bind(Ce,T.CLAMP_TO_EDGE),b.activeTexture.set(T.TEXTURE1),de?(de.texture.bind(Ce,T.CLAMP_TO_EDGE),Be=Math.pow(2,de.tileID.overscaledZ-J.tileID.overscaledZ),ke=[J.tileID.canonical.x*Be%1,J.tileID.canonical.y*Be%1]):J.texture.bind(Ce,T.CLAMP_TO_EDGE);const xe=La(H,ke||[0,0],Be||1,_e,l,C instanceof Or?C.perspectiveTransform:[0,0]);if(d.prepareDrawProgram(b,M,Y),C instanceof Or)M.draw(b,T.TRIANGLES,V,a.StencilMode.disabled,k,a.CullFaceMode.disabled,xe,l.id,C.boundsBuffer,d.quadTriangleIndexBuffer,C.boundsSegments);else{const{tileBoundsBuffer:me,tileBoundsIndexBuffer:Ae,tileBoundsSegments:Ee}=d.getTileBoundsBuffers(J);M.draw(b,T.TRIANGLES,V,K,k,a.CullFaceMode.disabled,xe,l.id,me,Ae,Ee)}}d.resetStencilClippingMasks()},background:function(d,i,l,p){const _=l.paint.get("background-color"),y=l.paint.get("background-opacity");if(y===0)return;const b=d.context,T=b.gl,C=d.transform,M=C.tileSize,k=l.paint.get("background-pattern");if(d.isPatternMissing(k))return;const P=!k&&_.a===1&&y===1&&d.opaquePassEnabledForLayer()?"opaque":"translucent";if(d.renderPass!==P)return;const F=a.StencilMode.disabled,j=d.depthModeForSublayer(0,P==="opaque"?a.DepthMode.ReadWrite:a.DepthMode.ReadOnly),N=d.colorModeForRenderPass(),$=d.useProgram(k?"backgroundPattern":"background");let ee,V=p;V||(ee=d.getBackgroundTiles(),V=Object.values(ee).map(J=>J.tileID)),k&&(b.activeTexture.set(T.TEXTURE0),d.imageManager.bind(d.context));const Y=l.getCrossfadeParameters();for(const J of V){const H=J.toUnwrapped(),K=p?J.projMatrix:d.transform.calculateProjMatrix(H);d.prepareDrawTile(J);const te=i?i.getTile(J):ee?ee[J.key]:new a.Tile(J,M,C.zoom,d),de=k?Fa(K,y,d,k,{tileID:J,tileSize:M},Y):Lt(K,y,_);d.prepareDrawProgram(b,$,H);const{tileBoundsBuffer:_e,tileBoundsIndexBuffer:Be,tileBoundsSegments:ke}=d.getTileBoundsBuffers(te);$.draw(b,T.TRIANGLES,j,F,N,a.CullFaceMode.disabled,de,l.id,_e,Be,ke)}},sky:function(d,i,l){const p=d.transform,_=p.projection.name==="mercator"||p.projection.name==="globe"?1:a.smoothstep(7,8,p.zoom),y=l.paint.get("sky-opacity")*_;if(y===0)return;const b=d.context,T=l.paint.get("sky-type"),C=new a.DepthMode(b.gl.LEQUAL,a.DepthMode.ReadOnly,[0,1]),M=d.frameCounter/1e3%1;T==="atmosphere"?d.renderPass==="offscreen"?l.needsSkyboxCapture(d)&&(function(k,P,F,j){const N=k.context,$=N.gl;let ee=P.skyboxFbo;if(!ee){ee=P.skyboxFbo=N.createFramebuffer(32,32,!1),P.skyboxGeometry=new Ga(N),P.skyboxTexture=N.gl.createTexture(),$.bindTexture($.TEXTURE_CUBE_MAP,P.skyboxTexture),$.texParameteri($.TEXTURE_CUBE_MAP,$.TEXTURE_WRAP_S,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_CUBE_MAP,$.TEXTURE_WRAP_T,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_CUBE_MAP,$.TEXTURE_MIN_FILTER,$.LINEAR),$.texParameteri($.TEXTURE_CUBE_MAP,$.TEXTURE_MAG_FILTER,$.LINEAR);for(let H=0;H<6;++H)$.texImage2D($.TEXTURE_CUBE_MAP_POSITIVE_X+H,0,$.RGBA,32,32,0,$.RGBA,$.UNSIGNED_BYTE,null)}N.bindFramebuffer.set(ee.framebuffer),N.viewport.set([0,0,32,32]);const V=P.getCenter(k,!0),Y=k.useProgram("skyboxCapture"),J=new Float64Array(16);a.identity(J),a.rotateY(J,J,.5*-Math.PI),Fn(N,P,Y,J,V,0),a.identity(J),a.rotateY(J,J,.5*Math.PI),Fn(N,P,Y,J,V,1),a.identity(J),a.rotateX(J,J,.5*-Math.PI),Fn(N,P,Y,J,V,2),a.identity(J),a.rotateX(J,J,.5*Math.PI),Fn(N,P,Y,J,V,3),a.identity(J),Fn(N,P,Y,J,V,4),a.identity(J),a.rotateY(J,J,Math.PI),Fn(N,P,Y,J,V,5),N.viewport.set([0,0,k.width,k.height])}(d,l),l.markSkyboxValid(d)):d.renderPass==="sky"&&function(k,P,F,j,N){const $=k.context,ee=$.gl,V=k.transform,Y=k.useProgram("skybox");$.activeTexture.set(ee.TEXTURE0),ee.bindTexture(ee.TEXTURE_CUBE_MAP,P.skyboxTexture);const J=((H,K,te,de,_e)=>({u_matrix:H,u_sun_direction:K,u_cubemap:0,u_opacity:de,u_temporal_offset:_e}))(V.skyboxMatrix,P.getCenter(k,!1),0,j,N);k.prepareDrawProgram($,Y),Y.draw($,ee.TRIANGLES,F,a.StencilMode.disabled,k.colorModeForRenderPass(),a.CullFaceMode.backCW,J,"skybox",P.skyboxGeometry.vertexBuffer,P.skyboxGeometry.indexBuffer,P.skyboxGeometry.segment)}(d,l,C,y,M):T==="gradient"&&d.renderPass==="sky"&&function(k,P,F,j,N){const $=k.context,ee=$.gl,V=k.transform,Y=k.useProgram("skyboxGradient");P.skyboxGeometry||(P.skyboxGeometry=new Ga($)),$.activeTexture.set(ee.TEXTURE0);let J=P.colorRampTexture;J||(J=P.colorRampTexture=new a.Texture($,P.colorRamp,ee.RGBA)),J.bind(ee.LINEAR,ee.CLAMP_TO_EDGE);const H=((K,te,de,_e,Be)=>({u_matrix:K,u_color_ramp:0,u_center_direction:te,u_radius:a.degToRad(de),u_opacity:_e,u_temporal_offset:Be}))(V.skyboxMatrix,P.getCenter(k,!1),P.paint.get("sky-gradient-radius"),j,N);k.prepareDrawProgram($,Y),Y.draw($,ee.TRIANGLES,F,a.StencilMode.disabled,k.colorModeForRenderPass(),a.CullFaceMode.backCW,H,"skyboxGradient",P.skyboxGeometry.vertexBuffer,P.skyboxGeometry.indexBuffer,P.skyboxGeometry.segment)}(d,l,C,y,M)},debug:function(d,i,l){for(let p=0;p<l.length;p++)$a(d,i,l[p])},custom:function(d,i,l){const p=d.context,_=l.implementation;if(d.transform.projection.unsupportedLayers&&d.transform.projection.unsupportedLayers.includes("custom"))a.warnOnce("Custom layers are not yet supported with non-mercator projections. Use mercator to enable custom layers.");else if(d.renderPass==="offscreen"){const y=_.prerender;y&&(d.setCustomLayerDefaults(),p.setColorMode(d.colorModeForRenderPass()),y.call(_,p.gl,d.transform.customLayerMatrix()),p.setDirty(),d.setBaseState())}else if(d.renderPass==="translucent"){d.setCustomLayerDefaults(),p.setColorMode(d.colorModeForRenderPass()),p.setStencilMode(a.StencilMode.disabled);const y=_.renderingMode==="3d"?new a.DepthMode(d.context.gl.LEQUAL,a.DepthMode.ReadWrite,d.depthRangeFor3D):d.depthModeForSublayer(0,a.DepthMode.ReadOnly);p.setDepthMode(y),_.render(p.gl,d.transform.customLayerMatrix()),p.setDirty(),d.setBaseState(),p.bindFramebuffer.set(null)}}};class Yh{constructor(i,l){this.context=new Sr(i),this.transform=l,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=a.SourceCache.maxUnderzooming+a.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new To,this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={}}updateTerrain(i,l){const p=!!i&&!!i.terrain&&this.transform.projection.supportsTerrain;if(!(p||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Bn(this,i));const _=this._terrain;this.transform.elevation=p?_:null,_.update(i,this.transform,l)}_updateFog(i){const l=i.fog;if(!l||l.getOpacity(this.transform.pitch)<1||l.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[p,_]=l.getFovAdjustedRange(this.transform._fov);if(p>_)return void(this.transform.fogCullDistSq=null);const y=p+.78*(_-p);this.transform.fogCullDistSq=y*y}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}resize(i,l){if(this.width=i*a.exported.devicePixelRatio,this.height=l*a.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const p of this.style.order)this.style._layers[p].resize()}setup(){const i=this.context,l=new a.StructArrayLayout2i4;l.emplaceBack(0,0),l.emplaceBack(a.EXTENT,0),l.emplaceBack(0,a.EXTENT),l.emplaceBack(a.EXTENT,a.EXTENT),this.tileExtentBuffer=i.createVertexBuffer(l,a.posAttributes.members),this.tileExtentSegments=a.SegmentVector.simpleSegment(0,0,4,2);const p=new a.StructArrayLayout2i4;p.emplaceBack(0,0),p.emplaceBack(a.EXTENT,0),p.emplaceBack(0,a.EXTENT),p.emplaceBack(a.EXTENT,a.EXTENT),this.debugBuffer=i.createVertexBuffer(p,a.posAttributes.members),this.debugSegments=a.SegmentVector.simpleSegment(0,0,4,5);const _=new a.StructArrayLayout2i4;_.emplaceBack(-1,-1),_.emplaceBack(1,-1),_.emplaceBack(-1,1),_.emplaceBack(1,1),this.viewportBuffer=i.createVertexBuffer(_,a.posAttributes.members),this.viewportSegments=a.SegmentVector.simpleSegment(0,0,4,2);const y=new a.StructArrayLayout4i8;y.emplaceBack(0,0,0,0),y.emplaceBack(a.EXTENT,0,a.EXTENT,0),y.emplaceBack(0,a.EXTENT,0,a.EXTENT),y.emplaceBack(a.EXTENT,a.EXTENT,a.EXTENT,a.EXTENT),this.mercatorBoundsBuffer=i.createVertexBuffer(y,a.boundsAttributes.members),this.mercatorBoundsSegments=a.SegmentVector.simpleSegment(0,0,4,2);const b=new a.StructArrayLayout3ui6;b.emplaceBack(0,1,2),b.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=i.createIndexBuffer(b);const T=new a.StructArrayLayout1ui2;for(const M of[0,1,3,2,0])T.emplaceBack(M);this.debugIndexBuffer=i.createIndexBuffer(T),this.emptyTexture=new a.Texture(i,{width:1,height:1,data:new Uint8Array([0,0,0,0])},i.gl.RGBA),this.identityMat=a.create();const C=this.context.gl;this.stencilClearMode=new a.StencilMode({func:C.ALWAYS,mask:0},0,255,C.ZERO,C.ZERO,C.ZERO),this.loadTimeStamps.push(a.window.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(i){return i._makeTileBoundsBuffers(this.context,this.transform.projection),i._tileBoundsBuffer?{tileBoundsBuffer:i._tileBoundsBuffer,tileBoundsIndexBuffer:i._tileBoundsIndexBuffer,tileBoundsSegments:i._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const i=this.context,l=i.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.useProgram("clippingMask").draw(i,l.TRIANGLES,a.DepthMode.disabled,this.stencilClearMode,a.ColorMode.disabled,a.CullFaceMode.disabled,sn(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(i,l,p){if(!l||this.currentStencilSource===l.id||!i.isTileClipped()||!p||p.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let T=!1;for(const C of p)if(this._tileClippingMaskIDs[C.key]===void 0){T=!0;break}if(!T)return}this.currentStencilSource=l.id;const _=this.context,y=_.gl;this.nextStencilID+p.length>256&&this.clearStencil(),_.setColorMode(a.ColorMode.disabled),_.setDepthMode(a.DepthMode.disabled);const b=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const T of p){const C=l.getTile(T),M=this._tileClippingMaskIDs[T.key]=this.nextStencilID++,{tileBoundsBuffer:k,tileBoundsIndexBuffer:P,tileBoundsSegments:F}=this.getTileBoundsBuffers(C);b.draw(_,y.TRIANGLES,a.DepthMode.disabled,new a.StencilMode({func:y.ALWAYS,mask:0},M,255,y.KEEP,y.KEEP,y.REPLACE),a.ColorMode.disabled,a.CullFaceMode.disabled,sn(T.projMatrix),"$clipping",k,P,F)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const i=this.nextStencilID++,l=this.context.gl;return new a.StencilMode({func:l.NOTEQUAL,mask:255},i,255,l.KEEP,l.KEEP,l.REPLACE)}stencilModeForClipping(i){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(i);const l=this.context.gl;return new a.StencilMode({func:l.EQUAL,mask:255},this._tileClippingMaskIDs[i.key],0,l.KEEP,l.KEEP,l.REPLACE)}stencilConfigForOverlap(i){const l=this.context.gl,p=i.sort((b,T)=>T.overscaledZ-b.overscaledZ),_=p[p.length-1].overscaledZ,y=p[0].overscaledZ-_+1;if(y>1){this.currentStencilSource=void 0,this.nextStencilID+y>256&&this.clearStencil();const b={};for(let T=0;T<y;T++)b[T+_]=new a.StencilMode({func:l.GEQUAL,mask:255},T+this.nextStencilID,255,l.KEEP,l.KEEP,l.REPLACE);return this.nextStencilID+=y,[b,p]}return[{[_]:a.StencilMode.disabled},p]}colorModeForRenderPass(){const i=this.context.gl;return this._showOverdrawInspector?new a.ColorMode([i.CONSTANT_COLOR,i.ONE],new a.Color(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?a.ColorMode.unblended:a.ColorMode.alphaBlended}depthModeForSublayer(i,l,p){if(!this.opaquePassEnabledForLayer())return a.DepthMode.disabled;const _=1-((1+this.currentLayer)*this.numSublayers+i)*this.depthEpsilon;return new a.DepthMode(p||this.context.gl.LEQUAL,l,[_,_])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(i,l){this.style=i,this.options=l,this.lineAtlas=i.lineAtlas,this.imageManager=i.imageManager,this.glyphManager=i.glyphManager,this.symbolFadeChange=i.placement.symbolFadeChange(a.exported.now()),this.imageManager.beginFrame();const p=this.style.order,_=this.style._sourceCaches;for(const M in _){const k=_[M];k.used&&k.prepare(this.context)}const y={},b={},T={};for(const M in _){const k=_[M];y[M]=k.getVisibleCoordinates(),b[M]=y[M].slice().reverse(),T[M]=k.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let M=0;M<p.length;M++)if(this.style._layers[p[M]].is3D()){this.opaquePassCutoff=M;break}if(this.terrain&&(this.terrain.updateTileBinding(T),this.opaquePassCutoff=0),this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new a.GlobeSharedBuffers(this.context)),!a.isMapAuthenticated(this.context.gl))return;this.renderPass="offscreen";for(const M of p){const k=this.style._layers[M],P=i._getLayerSourceCache(k);if(!k.hasOffscreenPass()||k.isHidden(this.transform.zoom))continue;const F=P?b[P.id]:void 0;(k.type==="custom"||k.isSky()||F&&F.length)&&this.renderLayer(this,P,k,F)}this.depthRangeFor3D=[0,1-(i.order.length+2)*this.numSublayers*this.depthEpsilon],this.terrain&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&this.terrain.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let C=a.Color.transparent;if(this.style.fog&&this.style.fog.getOpacity(this.transform.pitch)&&(C=this.style.fog.properties.get("color")),this.context.clear({color:l.showOverdrawInspector?a.Color.black:C,depth:1}),this.clearStencil(),this._showOverdrawInspector=l.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=p.length-1;this.currentLayer>=0;this.currentLayer--){const M=this.style._layers[p[this.currentLayer]],k=i._getLayerSourceCache(M);if(M.isSky())continue;const P=k?b[k.id]:void 0;this._renderTileClippingMasks(M,k,P),this.renderLayer(this,k,M,P)}if(this.renderPass="sky",(a.globeToMercatorTransition(this.transform.zoom)>0||this.transform.projection.name!=="globe")&&this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<p.length;this.currentLayer++){const M=this.style._layers[p[this.currentLayer]],k=i._getLayerSourceCache(M);M.isSky()&&this.renderLayer(this,k,M,k?b[k.id]:void 0)}for(this.transform.projection.name==="globe"&&function(M){const k=M.context,P=k.gl,F=M.transform,j=new a.DepthMode(P.LEQUAL,a.DepthMode.ReadOnly,[0,1]),N=M.useProgram("globeAtmosphere"),$=F._camera.getWorldToCamera(F.worldSize,1),ee=F._camera.getCameraToClipPerspective(F._fov,F.width/F.height,F._nearZ,F._farZ),V=a.mul([],$,a.calculateGlobeMatrix(F,F.worldSize)),Y=a.mul([],F.labelPlaneMatrix,ee),J=a.transformMat4([],[0,0,0],V),H=a.add([],J,[F.worldSize/Math.PI/2,0,0]),K=a.transformMat4([],J,Y),te=a.transformMat4([],H,Y),de=a.length(a.sub([],te,K)),_e=1-a.globeToMercatorTransition(F.zoom),Be={u_center:K,u_radius:de,u_screen_size:[F.width,F.height],u_pixel_ratio:a.exported.devicePixelRatio,u_opacity:_e,u_fadeout_range:2,u_start_color:[1,1,1],u_end_color:[.0118,.7451,.9882]};M.prepareDrawProgram(k,N);const ke=M.globeSharedBuffers;ke&&N.draw(k,P.TRIANGLES,j,a.StencilMode.disabled,a.ColorMode.alphaBlended,a.CullFaceMode.backCW,Be,"skybox",ke.atmosphereVertexBuffer,ke.atmosphereIndexBuffer,ke.atmosphereSegments)}(this),this.renderPass="translucent",this.currentLayer=0;this.currentLayer<p.length;){const M=this.style._layers[p[this.currentLayer]],k=i._getLayerSourceCache(M);if(M.isSky()){++this.currentLayer;continue}if(this.terrain&&this.style.isLayerDraped(M)){if(M.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue}const P=k?(M.type==="symbol"?T:b)[k.id]:void 0;this._renderTileClippingMasks(M,k,k?y[k.id]:void 0),this.renderLayer(this,k,M,P),++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry){let M=null;a.values(this.style._layers).forEach(k=>{const P=i._getLayerSourceCache(k);P&&!k.isHidden(this.transform.zoom)&&(!M||M.getSource().maxzoom<P.getSource().maxzoom)&&(M=P)}),M&&this.options.showTileBoundaries&&Bo.debug(this,M,M.getVisibleCoordinates())}this.options.showPadding&&function(M){const k=M.transform.padding;rr(M,M.transform.height-(k.top||0),3,Hh),rr(M,k.bottom||0,3,ip),ja(M,k.left||0,3,Lo),ja(M,M.transform.width-(k.right||0),3,Ro);const P=M.transform.centerPoint;(function(F,j,N,$){ns(F,j-1,N-10,2,20,$),ns(F,j-10,N-1,20,2,$)})(M,P.x,M.transform.height-P.y,Kh)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(a.window.performance.now()),this.saveCanvasCopy())}renderLayer(i,l,p,_){p.isHidden(this.transform.zoom)||(p.type==="background"||p.type==="sky"||p.type==="custom"||_&&_.length)&&(this.id=p.id,this.gpuTimingStart(p),i.transform.projection.unsupportedLayers&&i.transform.projection.unsupportedLayers.includes(p.type)||Bo[p.type](i,l,p,_,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(i){if(!this.options.gpuTiming)return;const l=this.context.extTimerQuery;let p=this.gpuTimers[i.id];p||(p=this.gpuTimers[i.id]={calls:0,cpuTime:0,query:l.createQueryEXT()}),p.calls++,l.beginQueryEXT(l.TIME_ELAPSED_EXT,p.query)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const i=this.context.extTimerQuery;i.endQueryEXT(i.TIME_ELAPSED_EXT)}collectGpuTimers(){const i=this.gpuTimers;return this.gpuTimers={},i}queryGpuTimers(i){const l={};for(const p in i){const _=i[p],y=this.context.extTimerQuery,b=y.getQueryObjectEXT(_.query,y.QUERY_RESULT_EXT)/1e6;y.deleteQueryEXT(_.query),l[p]=b}return l}translatePosMatrix(i,l,p,_,y){if(!p[0]&&!p[1])return i;const b=y?_==="map"?this.transform.angle:0:_==="viewport"?-this.transform.angle:0;if(b){const M=Math.sin(b),k=Math.cos(b);p=[p[0]*k-p[1]*M,p[0]*M+p[1]*k]}const T=[y?p[0]:wr(l,p[0],this.transform.zoom),y?p[1]:wr(l,p[1],this.transform.zoom),0],C=new Float32Array(16);return a.translate(C,i,T),C}saveTileTexture(i){const l=this._tileTextures[i.size[0]];l?l.push(i):this._tileTextures[i.size[0]]=[i]}getTileTexture(i){const l=this._tileTextures[i];return l&&l.length>0?l.pop():null}isPatternMissing(i){if(!i)return!1;if(!i.from||!i.to)return!0;const l=this.imageManager.getPattern(i.from.toString()),p=this.imageManager.getPattern(i.to.toString());return!l||!p}currentGlobalDefines(){const i=this.terrain&&this.terrain.renderingToTexture,l=this.style&&this.style.fog,p=[];return this.terrain&&!this.terrain.renderingToTexture&&p.push("TERRAIN"),l&&!i&&l.getOpacity(this.transform.pitch)!==0&&p.push("FOG"),i&&p.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&p.push("OVERDRAW_INSPECTOR"),p}useProgram(i,l,p){this.cache=this.cache||{};const _=p||[],y=this.currentGlobalDefines().concat(_),b=Ao.cacheKey(i,y,l);return this.cache[b]||(this.cache[b]=new Ao(this.context,i,Yl[i],l,Zh[i],y)),this.cache[b]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const i=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(i.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=a.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new a.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}prepareDrawTile(i){this.terrain&&this.terrain.prepareDrawTile(i)}prepareDrawProgram(i,l,p){if(this.terrain&&this.terrain.renderingToTexture)return;const _=this.style.fog;if(_){const y=_.getOpacity(this.transform.pitch);y!==0&&l.setFogUniformValues(i,((b,T,C,M)=>{const k=T.properties.get("color"),P=b.frameCounter/1e3%1,F=[k.r/k.a,k.g/k.a,k.b/k.a,M];return{u_fog_matrix:C?b.transform.calculateFogTileMatrix(C):b.identityMat,u_fog_range:T.getFovAdjustedRange(b.transform._fov),u_fog_color:F,u_fog_horizon_blend:T.properties.get("horizon-blend"),u_fog_temporal_offset:P}})(this,_,p,y))}}setTileLoadedFlag(i){this.tileLoaded=i}saveCanvasCopy(){this.frameCopies.push(this.canvasCopy()),this.tileLoaded=!1}canvasCopy(){const i=this.context.gl,l=i.createTexture();return i.bindTexture(i.TEXTURE_2D,l),i.copyTexImage2D(i.TEXTURE_2D,0,i.RGBA,0,0,i.drawingBufferWidth,i.drawingBufferHeight,0),l}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const i=this.style&&this.style.fog;return!!i&&i.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const i=this._backgroundTiles,l=this._backgroundTiles={},p=this.transform.coveringTiles({tileSize:512});for(const _ of p)l[_.key]=i[_.key]||new a.Tile(_,512,this.transform.tileZoom,this);return l}clearBackgroundTiles(){this._backgroundTiles={}}}class qa{constructor(i=0,l=0,p=0,_=0){if(isNaN(i)||i<0||isNaN(l)||l<0||isNaN(p)||p<0||isNaN(_)||_<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=i,this.bottom=l,this.left=p,this.right=_}interpolate(i,l,p){return l.top!=null&&i.top!=null&&(this.top=a.number(i.top,l.top,p)),l.bottom!=null&&i.bottom!=null&&(this.bottom=a.number(i.bottom,l.bottom,p)),l.left!=null&&i.left!=null&&(this.left=a.number(i.left,l.left,p)),l.right!=null&&i.right!=null&&(this.right=a.number(i.right,l.right,p)),this}getCenter(i,l){const p=a.clamp((this.left+i-this.right)/2,0,i),_=a.clamp((this.top+l-this.bottom)/2,0,l);return new a.pointGeometry(p,_)}equals(i){return this.top===i.top&&this.bottom===i.bottom&&this.left===i.left&&this.right===i.right}clone(){return new qa(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function On(d,i){const l=a.getColumn(d,3);a.fromQuat(d,i),a.setColumn(d,3,l)}function Jh(d,i){a.setColumn(d,3,[i[0],i[1],i[2],1])}function sc(d,i){const l=a.identity$1([]);return a.rotateZ$1(l,l,-i),a.rotateX$1(l,l,-d),l}function oc(d,i){const l=[d[0],d[1],0],p=[i[0],i[1],0];if(a.length(l)>=1e-15){const b=a.normalize([],l);a.scale$2(p,b,a.dot(p,b)),i[0]=p[0],i[1]=p[1]}const _=a.cross([],i,d);if(a.len(_)<1e-15)return null;const y=Math.atan2(-_[1],_[0]);return sc(Math.atan2(Math.sqrt(d[0]*d[0]+d[1]*d[1]),-d[2]),y)}class Qh{constructor(i,l){this.position=i,this.orientation=l}get position(){return this._position}set position(i){this._position=this._renderWorldCopies?function(l){if(!l)return;const p=Array.isArray(l)?new a.MercatorCoordinate(l[0],l[1],l[2]):l;return p.x=a.wrap(p.x,0,1),p}(i):i}lookAtPoint(i,l){if(this.orientation=null,!this.position)return;const p=this._elevation?this._elevation.getAtPointOrZero(a.MercatorCoordinate.fromLngLat(i)):0,_=this.position,y=a.MercatorCoordinate.fromLngLat(i,p),b=[y.x-_.x,y.y-_.y,y.z-_.z];l||(l=[0,0,1]),l[2]=Math.abs(l[2]),this.orientation=oc(b,l)}setPitchBearing(i,l){this.orientation=sc(a.degToRad(i),a.degToRad(-l))}}class ac{constructor(i,l){this._transform=a.identity([]),this._orientation=a.identity$1([]),l&&(this._orientation=l,On(this._transform,this._orientation)),i&&Jh(this._transform,i)}get mercatorPosition(){const i=this.position;return new a.MercatorCoordinate(i[0],i[1],i[2])}get position(){const i=a.getColumn(this._transform,3);return[i[0],i[1],i[2]]}set position(i){Jh(this._transform,i)}get orientation(){return this._orientation}set orientation(i){this._orientation=i,On(this._transform,this._orientation)}getPitchBearing(){const i=this.forward(),l=this.right();return{bearing:Math.atan2(-l[1],l[0]),pitch:Math.atan2(Math.sqrt(i[0]*i[0]+i[1]*i[1]),-i[2])}}setPitchBearing(i,l){this._orientation=sc(i,l),On(this._transform,this._orientation)}forward(){const i=a.getColumn(this._transform,2);return[-i[0],-i[1],-i[2]]}up(){const i=a.getColumn(this._transform,1);return[-i[0],-i[1],-i[2]]}right(){const i=a.getColumn(this._transform,0);return[i[0],i[1],i[2]]}getCameraToWorld(i,l){const p=new Float64Array(16);return a.invert(p,this.getWorldToCamera(i,l)),p}getWorldToCameraPosition(i,l,p){const _=this.position;a.scale$2(_,_,-i);const y=new Float64Array(16);return a.fromScaling(y,[p,p,p]),a.translate(y,y,_),y[10]*=l,y}getWorldToCamera(i,l){const p=new Float64Array(16),_=new Float64Array(4),y=this.position;return a.conjugate(_,this._orientation),a.scale$2(y,y,-i),a.fromQuat(p,_),a.translate(p,p,y),p[1]*=-1,p[5]*=-1,p[9]*=-1,p[13]*=-1,p[8]*=l,p[9]*=l,p[10]*=l,p[11]*=l,p}getCameraToClipPerspective(i,l,p,_){const y=new Float64Array(16);return a.perspective(y,i,l,p,_),y}getDistanceToElevation(i){const l=i===0?0:a.mercatorZfromAltitude(i,this.position[1]),p=this.forward();return(l-this.position[2])/p[2]}clone(){return new ac([...this.position],[...this.orientation])}}function eu(d,i){const l=Wa(d),p=function(y,b,T,C,M){const k=new a.LngLat(T.lng-180*Vr,T.lat),P=new a.LngLat(T.lng+180*Vr,T.lat),F=y.project(k.lng,k.lat),j=y.project(P.lng,P.lat),N=-Math.atan2(j.y-F.y,j.x-F.x),$=a.MercatorCoordinate.fromLngLat(T);$.y=a.clamp($.y,-.999975,.999975);const ee=$.toLngLat(),V=y.project(ee.lng,ee.lat),Y=a.MercatorCoordinate.fromLngLat(ee);Y.x+=Vr;const J=Y.toLngLat(),H=y.project(J.lng,J.lat),K=cc(H.x-V.x,H.y-V.y,N),te=a.MercatorCoordinate.fromLngLat(ee);te.y+=Vr;const de=te.toLngLat(),_e=y.project(de.lng,de.lat),Be=cc(_e.x-V.x,_e.y-V.y,N),ke=Math.abs(K.x)/Math.abs(Be.y),Ce=a.identity([]);a.rotateZ(Ce,Ce,-N*(1-(M?0:C)));const xe=a.identity([]);return a.scale(xe,xe,[1,1-(1-ke)*C,1]),xe[4]=-Be.x/Be.y*C,a.rotateZ(xe,xe,N),a.multiply$1(xe,Ce,xe),xe}(d.projection,0,d.center,l,i),_=Za(d);return a.scale(p,p,[_,_,1]),p}function Za(d){const i=d.projection,l=Wa(d),p=lc(i,d.center),_=lc(i,a.LngLat.convert(i.center));return Math.pow(2,p*l+(1-l)*_)}function Wa(d){const i=d.projection.range;if(!i)return 0;const l=Math.max(d.width,d.height),p=Math.log(l/1024)/Math.LN2;return a.smoothstep(i[0]+p,i[1]+p,d.zoom)}const Vr=1/4e4;function lc(d,i){const l=a.clamp(i.lat,-a.MAX_MERCATOR_LATITUDE,a.MAX_MERCATOR_LATITUDE),p=new a.LngLat(i.lng-180*Vr,l),_=new a.LngLat(i.lng+180*Vr,l),y=d.project(p.lng,l),b=d.project(_.lng,l),T=a.MercatorCoordinate.fromLngLat(p),C=a.MercatorCoordinate.fromLngLat(_),M=b.x-y.x,k=b.y-y.y,P=C.x-T.x,F=C.y-T.y,j=Math.sqrt((P*P+F*F)/(M*M+k*k));return Math.log(j)/Math.LN2}function cc(d,i,l){const p=Math.cos(l),_=Math.sin(l);return{x:d*p-i*_,y:d*_+i*p}}class Fo{constructor(i,l,p,_,y){this.tileSize=512,this._renderWorldCopies=y===void 0||y,this._minZoom=i||0,this._maxZoom=l||22,this._minPitch=p==null?0:p,this._maxPitch=_==null?60:_,this.setProjection(),this.setMaxBounds(),this.width=0,this.height=0,this._center=new a.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new qa,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new ac,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._projectionScaler=1,this._horizonShift=.1}clone(){const i=new Fo(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return i.setProjection(this.getProjection()),i._elevation=this._elevation,i._centerAltitude=this._centerAltitude,i.tileSize=this.tileSize,i.setMaxBounds(this.getMaxBounds()),i.width=this.width,i.height=this.height,i.cameraElevationReference=this.cameraElevationReference,i._center=this._center,i._setZoom(this.zoom),i._cameraZoom=this._cameraZoom,i.angle=this.angle,i._fov=this._fov,i._pitch=this._pitch,i._nearZ=this._nearZ,i._farZ=this._farZ,i._averageElevation=this._averageElevation,i._unmodified=this._unmodified,i._edgeInsets=this._edgeInsets.clone(),i._camera=this._camera.clone(),i._calcMatrices(),i.freezeTileCoverage=this.freezeTileCoverage,i}get elevation(){return this._elevation}set elevation(i){this._elevation!==i&&(this._elevation=i,i?this._updateCenterElevation()&&this._updateCameraOnTerrain():(this._cameraZoom=null,this._centerAltitude=0),this._calcMatrices())}updateElevation(i){this._terrainEnabled()&&this._cameraZoom==null&&this._updateCenterElevation()&&this._updateCameraOnTerrain(),i&&this._constrainCameraAltitude(),this._calcMatrices()}getProjection(){return a.pick(this.projection,["name","center","parallels"])}setProjection(i){i==null&&(i={name:"mercator"}),this.projectionOptions=i;const l=this.projection?this.getProjection():void 0;return this.projection=a.getProjection(i),!ze(l,this.getProjection())&&(this._calcMatrices(),!0)}get minZoom(){return this._minZoom}set minZoom(i){this._minZoom!==i&&(this._minZoom=i,this.zoom=Math.max(this.zoom,i))}get maxZoom(){return this._maxZoom}set maxZoom(i){this._maxZoom!==i&&(this._maxZoom=i,this.zoom=Math.min(this.zoom,i))}get minPitch(){return this._minPitch}set minPitch(i){this._minPitch!==i&&(this._minPitch=i,this.pitch=Math.max(this.pitch,i))}get maxPitch(){return this._maxPitch}set maxPitch(i){this._maxPitch!==i&&(this._maxPitch=i,this.pitch=Math.min(this.pitch,i))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(i){i===void 0?i=!0:i===null&&(i=!1),this._renderWorldCopies=i}get worldSize(){return this.tileSize*this.scale}get cameraWorldSize(){const i=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(i))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.cameraWorldSize)}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new a.pointGeometry(this.width,this.height)}get bearing(){return a.wrap(this.rotation,-180,180)}set bearing(i){this.rotation=i}get rotation(){return-this.angle/Math.PI*180}set rotation(i){const l=-i*Math.PI/180;var p;this.angle!==l&&(this._unmodified=!1,this.angle=l,this._calcMatrices(),this.rotationMatrix=(p=new a.ARRAY_TYPE(4),a.ARRAY_TYPE!=Float32Array&&(p[1]=0,p[2]=0),p[0]=1,p[3]=1,p),function(_,y,b){var T=y[0],C=y[1],M=y[2],k=y[3],P=Math.sin(b),F=Math.cos(b);_[0]=T*F+M*P,_[1]=C*F+k*P,_[2]=T*-P+M*F,_[3]=C*-P+k*F}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(i){const l=a.clamp(i,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==l&&(this._unmodified=!1,this._pitch=l,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(i){i=Math.max(.01,Math.min(60,i)),this._fov!==i&&(this._unmodified=!1,this._fov=i/180*Math.PI,this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(i){this._averageElevation=i,this._calcFogMatrices()}get zoom(){return this._zoom}set zoom(i){const l=Math.min(Math.max(i,this.minZoom),this.maxZoom);this._zoom!==l&&(this._unmodified=!1,this._setZoom(l),this._terrainEnabled()&&this._updateCameraOnTerrain(),this._constrain(),this._calcMatrices())}_setZoom(i){this._zoom=i,this.scale=this.zoomScale(i),this.tileZoom=Math.floor(i),this.zoomFraction=i-this.tileZoom}_updateCenterElevation(){if(!this._elevation)return!1;const i=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center),-1);return i===-1?(this._cameraZoom=null,!1):(this._centerAltitude=i,!0)}_updateCameraOnTerrain(){this._cameraZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize)}sampleAverageElevation(){if(!this._elevation)return 0;const i=this._elevation,l=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],p=this.horizonLineFromTop();let _=0,y=0;for(let b=0;b<l.length;b++){const T=new a.pointGeometry(l[b][0]*this.width,p+l[b][1]*(this.height-p)),C=i.pointCoordinate(T);if(!C)continue;const M=1/Math.hypot(C[0]-this._camera.position[0],C[1]-this._camera.position[1]);_+=C[3]*M,y+=M}return y===0?NaN:_/y}get center(){return this._center}set center(i){i.lat===this._center.lat&&i.lng===this._center.lng||(this._unmodified=!1,this._center=i,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCenterElevation()?this._updateCameraOnTerrain():this._cameraZoom=null:this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._cameraZoom==null||!this._elevation)return;const i=this._cameraZoom,l=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),p=this.pixelsPerMeter/this.worldSize*l,_=this._mercatorZfromZoom(i),y=this._mercatorZfromZoom(this._maxZoom),b=Math.max(_-p,y);this._setZoom(this._zoomFromMercatorZ(b))}get padding(){return this._edgeInsets.toJSON()}set padding(i){this._edgeInsets.equals(i)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,i,1),this._calcMatrices())}computeZoomRelativeTo(i){const l=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,i.toAltitude()));let p;p=i.z<this._camera.position[2]?[l.x,l.y,l.z]:[i.x,i.y,i.z];const _=a.length(a.sub([],this._camera.position,p));return a.clamp(this._zoomFromMercatorZ(_),this._minZoom,this._maxZoom)}setFreeCameraOptions(i){if(!this.height||!i.position&&!i.orientation)return;this._updateCameraState();let l=!1;if(i.orientation&&!a.exactEquals(i.orientation,this._camera.orientation)&&(l=this._setCameraOrientation(i.orientation)),i.position){const p=[i.position.x,i.position.y,i.position.z];a.exactEquals$1(p,this._camera.position)||(this._setCameraPosition(p),l=!0)}l&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const i=this._camera.position,l=new Qh;return l.position=new a.MercatorCoordinate(i[0],i[1],i[2]),l.orientation=this._camera.orientation,l._elevation=this.elevation,l._renderWorldCopies=this.renderWorldCopies,l}_setCameraOrientation(i){if(!a.length$1(i))return!1;a.normalize$1(i,i);const l=a.transformQuat([],[0,0,-1],i),p=a.transformQuat([],[0,-1,0],i);if(p[2]<0)return!1;const _=oc(l,p);return!!_&&(this._camera.orientation=_,!0)}_setCameraPosition(i){const l=this.zoomScale(this.minZoom)*this.tileSize,p=this.zoomScale(this.maxZoom)*this.tileSize,_=this.cameraToCenterDistance;i[2]=a.clamp(i[2],_/p,_/l),this._camera.position=i}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(i){return this._edgeInsets.equals(i)}interpolatePadding(i,l,p){this._unmodified=!1,this._edgeInsets.interpolate(i,l,p),this._constrain(),this._calcMatrices()}coveringZoomLevel(i){const l=(i.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/i.tileSize));return Math.max(0,l)}getVisibleUnwrappedCoordinates(i){const l=[new a.UnwrappedTileID(0,i)];if(this.renderWorldCopies){const p=this.pointCoordinate(new a.pointGeometry(0,0)),_=this.pointCoordinate(new a.pointGeometry(this.width,0)),y=this.pointCoordinate(new a.pointGeometry(this.width,this.height)),b=this.pointCoordinate(new a.pointGeometry(0,this.height)),T=Math.floor(Math.min(p.x,_.x,y.x,b.x)),C=Math.floor(Math.max(p.x,_.x,y.x,b.x)),M=1;for(let k=T-M;k<=C+M;k++)k!==0&&l.push(new a.UnwrappedTileID(k,i))}return l}coveringTiles(i){let l=this.coveringZoomLevel(i);const p=l,_=this.elevation&&!i.isTerrainDEM,y=this.projection.name==="mercator";if(i.minzoom!==void 0&&l<i.minzoom)return[];i.maxzoom!==void 0&&l>i.maxzoom&&(l=i.maxzoom);const b=this.locationCoordinate(this.center),T=1<<l,C=[T*b.x,T*b.y,0],M=a.Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,l,this.projection.name!=="globe"),k=this.pointCoordinate(this.getCameraPoint()),P=T*a.mercatorZfromAltitude(1,this.center.lat),F=this._camera.position[2]/a.mercatorZfromAltitude(1,this.center.lat),j=[T*k.x,T*k.y,F],N=this.cameraToCenterDistance/i.tileSize*(i.roundZoom?1:.502),$=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?l:0,ee=i.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,V=i.isTerrainDEM?-ee:this._elevation?this._elevation.getMinElevationBelowMSL():0,Y=this.projection.isReprojectedInTileSpace?Za(this):1,J=me=>{const Ee=new a.MercatorCoordinate(me.x+25e-6,me.y,me.z),Xe=new a.MercatorCoordinate(me.x,me.y+25e-6,me.z),et=me.toLngLat(),ht=Ee.toLngLat(),Re=Xe.toLngLat(),Ke=this.locationCoordinate(et),st=this.locationCoordinate(ht),Rt=this.locationCoordinate(Re),jt=Math.hypot(st.x-Ke.x,st.y-Ke.y),nt=Math.hypot(Rt.x-Ke.x,Rt.y-Ke.y);return Math.sqrt(jt*nt)*Y/25e-6},H=me=>{const Ae=ee,Ee=V;return{aabb:a.tileAABB(this,T,0,0,0,me,Ee,Ae,this.projection),zoom:0,x:0,y:0,minZ:Ee,maxZ:Ae,wrap:me,fullyVisible:!1}},K=[];let te=[];const de=l,_e=i.reparseOverscaled?p:l,Be=me=>me*me,ke=Be((F-this._centerAltitude)*P),Ce=me=>{if(!this._elevation||!me.tileID||!y)return;const Ae=this._elevation.getMinMaxForTile(me.tileID),Ee=me.aabb;Ae?(Ee.min[2]=Ae.min,Ee.max[2]=Ae.max,Ee.center[2]=(Ee.min[2]+Ee.max[2])/2):(me.shouldSplit=xe(me),me.shouldSplit||(Ee.min[2]=Ee.max[2]=Ee.center[2]=this._centerAltitude))},xe=me=>{if(me.zoom<$)return!0;if(me.zoom===de)return!1;if(me.shouldSplit!=null)return me.shouldSplit;const Ae=me.aabb.distanceX(j),Ee=me.aabb.distanceY(j);let Xe=ke;_&&(Xe=Be(me.aabb.distanceZ(j)*P));let et=1;if(this.projection.isReprojectedInTileSpace&&p<=5){const Re=Math.pow(2,me.zoom),Ke=J(new a.MercatorCoordinate((me.x+.5)/Re,(me.y+.5)/Re));et=Ke>.85?1:Ke}const ht=Ae*Ae+Ee*Ee+Xe;return ht<Be((1<<de-me.zoom)*N*et*((Re,Ke)=>{if(Ke*Be(.707)<Re)return 1;const st=Math.sqrt(Ke/Re);return st/(1.4144271570014144+(Math.pow(1.1,st-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(Xe,ke),ht))};if(this.renderWorldCopies)for(let me=1;me<=3;me++)K.push(H(-me)),K.push(H(me));for(K.push(H(0));K.length>0;){const me=K.pop(),Ae=me.x,Ee=me.y;let Xe=me.fullyVisible;if(!Xe){const et=me.aabb.intersects(M);if(et===0)continue;Xe=et===2}if(me.zoom!==de&&xe(me))for(let et=0;et<4;et++){const ht=(Ae<<1)+et%2,Re=(Ee<<1)+(et>>1),Ke={aabb:y?me.aabb.quadrant(et):a.tileAABB(this,T,me.zoom+1,ht,Re,me.wrap,me.minZ,me.maxZ,this.projection),zoom:me.zoom+1,x:ht,y:Re,wrap:me.wrap,fullyVisible:Xe,tileID:void 0,shouldSplit:void 0,minZ:me.minZ,maxZ:me.maxZ};_&&(Ke.tileID=new a.OverscaledTileID(me.zoom+1===de?_e:me.zoom+1,me.wrap,me.zoom+1,ht,Re),Ce(Ke)),K.push(Ke)}else{const et=me.zoom===de?_e:me.zoom;if(i.minzoom&&i.minzoom>et)continue;const ht=C[0]-(.5+Ae+(me.wrap<<me.zoom))*(1<<l-me.zoom),Re=C[1]-.5-Ee,Ke=me.tileID?me.tileID:new a.OverscaledTileID(et,me.wrap,me.zoom,Ae,Ee);te.push({tileID:Ke,distanceSq:ht*ht+Re*Re})}}if(this.fogCullDistSq){const me=this.fogCullDistSq,Ae=this.horizonLineFromTop();te=te.filter(Ee=>{const Xe=[0,0,0,1],et=[a.EXTENT,a.EXTENT,0,1],ht=this.calculateFogTileMatrix(Ee.tileID.toUnwrapped());a.transformMat4$1(Xe,Xe,ht),a.transformMat4$1(et,et,ht);const Re=a.getAABBPointSquareDist(Xe,et);if(Re===0)return!0;let Ke=!1;const st=this._elevation;if(st&&Re>me&&Ae!==0){const Rt=this.calculateProjMatrix(Ee.tileID.toUnwrapped());let jt;i.isTerrainDEM||(jt=st.getMinMaxForTile(Ee.tileID)),jt||(jt={min:V,max:ee});const nt=a.furthestTileCorner(this.rotation),_t=[nt[0]*a.EXTENT,nt[1]*a.EXTENT,jt.max];a.transformMat4(_t,_t,Rt),Ke=(1-_t[1])*this.height*.5<Ae}return Re<me||Ke})}return te.sort((me,Ae)=>me.distanceSq-Ae.distanceSq).map(me=>me.tileID)}resize(i,l){this.width=i,this.height=l,this.pixelsToGLUnits=[2/i,-2/l],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(i){return Math.pow(2,i)}scaleZoom(i){return Math.log(i)/Math.LN2}project(i){const l=a.clamp(i.lat,-a.MAX_MERCATOR_LATITUDE,a.MAX_MERCATOR_LATITUDE),p=this.projection.project(i.lng,l);return new a.pointGeometry(p.x*this.worldSize,p.y*this.worldSize)}unproject(i){return this.projection.unproject(i.x/this.worldSize,i.y/this.worldSize)}get point(){return this.project(this.center)}setLocationAtPoint(i,l){const p=this.pointCoordinate(l),_=this.pointCoordinate(this.centerPoint),y=this.locationCoordinate(i);this.setLocation(new a.MercatorCoordinate(y.x-(p.x-_.x),y.y-(p.y-_.y)))}setLocation(i){this.center=this.coordinateLocation(i),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(i){return this.projection.locationPoint(this,i)}locationPoint3D(i){return this._coordinatePoint(this.locationCoordinate(i),!0)}pointLocation(i){return this.coordinateLocation(this.pointCoordinate(i))}pointLocation3D(i){return this.coordinateLocation(this.pointCoordinate3D(i))}locationCoordinate(i,l){const p=l?a.mercatorZfromAltitude(l,i.lat):void 0,_=this.projection.project(i.lng,i.lat);return new a.MercatorCoordinate(_.x,_.y,p)}coordinateLocation(i){return this.projection.unproject(i.x,i.y)}pointRayIntersection(i,l){const p=l!=null?l:this._centerAltitude,_=[i.x,i.y,0,1],y=[i.x,i.y,1,1];a.transformMat4$1(_,_,this.pixelMatrixInverse),a.transformMat4$1(y,y,this.pixelMatrixInverse);const b=y[3];a.scale$1(_,_,1/_[3]),a.scale$1(y,y,1/b);const T=_[2],C=y[2];return{p0:_,p1:y,t:T===C?0:(p-T)/(C-T)}}screenPointToMercatorRay(i){const l=[i.x,i.y,0,1],p=[i.x,i.y,1,1];return a.transformMat4$1(l,l,this.pixelMatrixInverse),a.transformMat4$1(p,p,this.pixelMatrixInverse),a.scale$1(l,l,1/l[3]),a.scale$1(p,p,1/p[3]),l[2]=a.mercatorZfromAltitude(l[2],this._center.lat)*this.worldSize,p[2]=a.mercatorZfromAltitude(p[2],this._center.lat)*this.worldSize,a.scale$1(l,l,1/this.worldSize),a.scale$1(p,p,1/this.worldSize),new a.Ray([l[0],l[1],l[2]],a.normalize([],a.sub([],p,l)))}rayIntersectionCoordinate(i){const{p0:l,p1:p,t:_}=i,y=a.mercatorZfromAltitude(l[2],this._center.lat),b=a.mercatorZfromAltitude(p[2],this._center.lat);return new a.MercatorCoordinate(a.number(l[0],p[0],_)/this.worldSize,a.number(l[1],p[1],_)/this.worldSize,a.number(y,b,_))}pointCoordinate(i,l=this._centerAltitude){return this.projection.createTileTransform(this,this.worldSize).pointCoordinate(i.x,i.y,l)}pointCoordinate3D(i){if(!this.elevation)return this.pointCoordinate(i);const l=this.elevation;let p=this.elevation.pointCoordinate(i);if(p)return new a.MercatorCoordinate(p[0],p[1],p[2]);let _=0,y=this.horizonLineFromTop();if(i.y>y)return this.pointCoordinate(i);const b=.02*y,T=i.clone();for(let C=0;C<10&&y-_>b;C++){T.y=a.number(_,y,.66);const M=l.pointCoordinate(T);M?(y=T.y,p=M):_=T.y}return p?new a.MercatorCoordinate(p[0],p[1],p[2]):this.pointCoordinate(i)}isPointAboveHorizon(i){if(this.elevation)return!this.elevation.pointCoordinate(i);{const l=this.horizonLineFromTop();return i.y<l}}_coordinatePoint(i,l){const p=l&&this.elevation?this.elevation.getAtPointOrZero(i,this._centerAltitude):this._centerAltitude,_=[i.x*this.worldSize,i.y*this.worldSize,p+i.toAltitude(),1];return a.transformMat4$1(_,_,this.pixelMatrix),_[3]>0?new a.pointGeometry(_[0]/_[3],_[1]/_[3]):new a.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE)}_getBounds(i,l){const p=new a.pointGeometry(this._edgeInsets.left,this._edgeInsets.top),_=new a.pointGeometry(this.width-this._edgeInsets.right,this._edgeInsets.top),y=new a.pointGeometry(this.width-this._edgeInsets.right,this.height-this._edgeInsets.bottom),b=new a.pointGeometry(this._edgeInsets.left,this.height-this._edgeInsets.bottom);let T=this.pointCoordinate(p,i),C=this.pointCoordinate(_,i);const M=this.pointCoordinate(y,l),k=this.pointCoordinate(b,l),P=(F,j)=>(j.y-F.y)/(j.x-F.x);return T.y>1&&C.y>=0?T=new a.MercatorCoordinate((1-k.y)/P(k,T)+k.x,1):T.y<0&&C.y<=1&&(T=new a.MercatorCoordinate(-k.y/P(k,T)+k.x,0)),C.y>1&&T.y>=0?C=new a.MercatorCoordinate((1-M.y)/P(M,C)+M.x,1):C.y<0&&T.y<=1&&(C=new a.MercatorCoordinate(-M.y/P(M,C)+M.x,0)),new a.LngLatBounds().extend(this.coordinateLocation(T)).extend(this.coordinateLocation(C)).extend(this.coordinateLocation(k)).extend(this.coordinateLocation(M))}_getBounds3D(){const i=this.elevation;if(!i.visibleDemTiles.length)return this._getBounds(0,0);const l=i.visibleDemTiles.reduce((p,_)=>{if(_.dem){const y=_.dem.tree;p.min=Math.min(p.min,y.minimums[0]),p.max=Math.max(p.max,y.maximums[0])}return p},{min:Number.MAX_VALUE,max:0});return this._getBounds(l.min*i.exaggeration(),l.max*i.exaggeration())}getBounds(){return this._terrainEnabled()?this._getBounds3D():this._getBounds(0,0)}horizonLineFromTop(i=!0){const l=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,p=this.height/2-l*(1-this._horizonShift);return i?Math.max(0,p):p}getMaxBounds(){return this.maxBounds}setMaxBounds(i){this.maxBounds=i,this.minLat=-a.MAX_MERCATOR_LATITUDE,this.maxLat=a.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,i&&(this.minLat=i.getSouth(),this.maxLat=i.getNorth(),this.minLng=i.getWest(),this.maxLng=i.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=a.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=a.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=a.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=a.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(i,l){return this.projection.createTileTransform(this,l).createTileMatrix(i)}calculateDistanceTileData(i){const l=i.key,p=this._distanceTileDataCache;if(p[l])return p[l];const _=i.canonical,y=1/this.height,b=this.cameraWorldSize/this.zoomScale(_.z),T=(_.x+Math.pow(2,_.z)*i.wrap)*b,C=_.y*b,M=this.point,k=this.angle,P=Math.sin(-k),F=-Math.cos(-k);return p[l]={bearing:[P,F],center:[(M.x-T)*y,(M.y-C)*y],scale:b/a.EXTENT*y},p[l]}calculateFogTileMatrix(i){const l=i.key,p=this._fogTileMatrixCache;if(p[l])return p[l];const _=this.calculatePosMatrix(i,this.cameraWorldSize);return a.multiply$1(_,this.worldToFogMatrix,_),p[l]=new Float32Array(_),p[l]}calculateProjMatrix(i,l=!1){const p=i.key,_=l?this._alignedProjMatrixCache:this._projMatrixCache;if(_[p])return _[p];const y=this.calculatePosMatrix(i,this.worldSize);return a.multiply$1(y,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:l?this.alignedProjMatrix:this.projMatrix,y),_[p]=new Float32Array(y),_[p]}calculatePixelsToTileUnitsMatrix(i){const l=i.tileID.key,p=this._pixelsToTileUnitsCache;if(p[l])return p[l];const _=function(y,b){const{scale:T}=y.tileTransform,C=T*a.EXTENT/(y.tileSize*Math.pow(2,b.zoom-y.tileID.overscaledZ+y.tileID.canonical.z));return M=new Float32Array(4),F=(k=b.inverseAdjustmentMatrix)[1],j=k[2],N=k[3],ee=(P=[C,C])[1],M[0]=k[0]*($=P[0]),M[1]=F*$,M[2]=j*ee,M[3]=N*ee,M;var M,k,P,F,j,N,$,ee}(i,this);return p[l]=_,p[l]}customLayerMatrix(){return this.mercatorMatrix.slice()}recenterOnTerrain(){if(!this._elevation)return;const i=this._elevation;this._updateCameraState();const l=a.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,p=this._computeCameraPosition(l),_=this._camera.forward(),y=a.mercatorZfromAltitude(1,this._center.lat);p[2]/=y,_[2]/=y,a.normalize(_,_);const b=i.raycast(p,_,i.exaggeration());if(b){const T=a.scaleAndAdd([],p,_,b),C=new a.MercatorCoordinate(T[0],T[1],a.mercatorZfromAltitude(T[2],a.latFromMercatorY(T[1]))),M=(C.z+a.length([C.x-p[0],C.y-p[1],C.z-p[2]*y]))*this._projectionScaler;this._cameraZoom=this._zoomFromMercatorZ(M),this._centerAltitude=C.toAltitude(),this._center=this.coordinateLocation(C),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCameraAltitude(){if(!this._elevation)return;const i=this._elevation;this._updateCameraState();const l=a.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,p=this._computeCameraPosition(l),_=i.getAtPointOrZero(new a.MercatorCoordinate(...p)),y=this._minimumHeightOverTerrain()*Math.cos(a.degToRad(this._maxPitch)),b=this._camera.position[2]-this.pixelsPerMeter/this.worldSize*_;if(b<y){const T=this.locationCoordinate(this._center,this._centerAltitude),C=[T.x-p[0],T.y-p[1],T.z-p[2]],M=a.length(C);C[2]-=(y-b)/this._projectionScaler;const k=a.length(C);if(k===0)return;a.scale$2(C,C,M/k*this._projectionScaler),this._camera.position=[T.x-C[0],T.y-C[1],T.z*this._projectionScaler-C[2]],this._camera.orientation=oc(C,this._camera.up()),this._updateStateFromCamera()}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;if(this._constraining=!0,this.projection.isReprojectedInTileSpace){const P=this.center;return P.lat=a.clamp(P.lat,this.minLat,this.maxLat),!this.maxBounds&&this.renderWorldCopies||(P.lng=a.clamp(P.lng,this.minLng,this.maxLng)),this.center=P,void(this._constraining=!1)}const i=this._unmodified,{x:l,y:p}=this.point;let _=0,y=l,b=p;const T=this.width/2,C=this.height/2,M=this.worldMinY*this.scale,k=this.worldMaxY*this.scale;if(p-C<M&&(b=M+C),p+C>k&&(b=k-C),k-M<this.height&&(_=Math.max(_,this.height/(k-M)),b=(k+M)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const P=this.worldMinX*this.scale,F=this.worldMaxX*this.scale,j=this.worldSize/2-(P+F)/2;y=(l+j+this.worldSize)%this.worldSize-j,y-T<P&&(y=P+T),y+T>F&&(y=F-T),F-P<this.width&&(_=Math.max(_,this.width/(F-P)),y=(F+P)/2)}y===l&&b===p||(this.center=this.unproject(new a.pointGeometry(y,b))),_&&(this.zoom+=this.scaleZoom(_)),this._constrainCameraAltitude(),this._unmodified=i,this._constraining=!1}_minZoomForBounds(){let i=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(i=Math.max(i,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),i}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const i=this._fov/2,l=this.centerOffset,p=this.pixelsPerMeter;this._projectionScaler=p/(a.mercatorZfromAltitude(1,this.center.lat)*this.worldSize),this.cameraToCenterDistance=.5/Math.tan(i)*this.height*this._projectionScaler,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const _=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?p:1),y=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);y[8]=2*-l.x/this.width,y[9]=2*l.y/this.height;let b=a.mul([],y,_);if(this.projection.isReprojectedInTileSpace){const H=this.locationCoordinate(this.center),K=a.identity([]);a.translate(K,K,[H.x*this.worldSize,H.y*this.worldSize,0]),a.multiply$1(K,K,eu(this)),a.translate(K,K,[-H.x*this.worldSize,-H.y*this.worldSize,0]),a.multiply$1(b,b,K),this.inverseAdjustmentMatrix=function(te){const de=eu(te,!0);return ue([],[de[0],de[1],de[4],de[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=a.scale([],b,[this.worldSize,this.worldSize,this.worldSize/p,1]),this.projMatrix=b,this.invProjMatrix=a.invert(new Float64Array(16),this.projMatrix);const T=new Float32Array(16);a.identity(T),a.scale(T,T,[1,-1,1]),a.rotateX(T,T,this._pitch),a.rotateZ(T,T,this.angle);const C=a.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ),M=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;C[8]=2*-l.x/this.width,C[9]=2*(l.y+M)/this.height,this.skyboxMatrix=a.multiply$1(T,C,T);const k=this.point,P=k.x,F=k.y,j=this.width%2/2,N=this.height%2/2,$=Math.cos(this.angle),ee=Math.sin(this.angle),V=P-Math.round(P)+$*j+ee*N,Y=F-Math.round(F)+$*N+ee*j,J=new Float64Array(b);if(a.translate(J,J,[V>.5?V-1:V,Y>.5?Y-1:Y,0]),this.alignedProjMatrix=J,b=a.create(),a.scale(b,b,[this.width/2,-this.height/2,1]),a.translate(b,b,[1,-1,0]),this.labelPlaneMatrix=b,b=a.create(),a.scale(b,b,[1,-1,1]),a.translate(b,b,[-1,-1,0]),a.scale(b,b,[2/this.width,2/this.height,1]),this.glCoordMatrix=b,this.pixelMatrix=a.multiply$1(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},b=a.invert(new Float64Array(16),this.pixelMatrix),!b)throw new Error("failed to invert matrix");this.pixelMatrixInverse=b,this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const i=this.cameraWorldSize,l=this.cameraPixelsPerMeter,p=this._camera.position,_=1/this.height,y=[i,i,l];a.scale$2(y,y,_),a.scale$2(p,p,-1),a.multiply$2(p,p,y);const b=a.create();a.translate(b,b,p),a.scale(b,b,y),this.mercatorFogMatrix=b,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(i,l,_)}_computeCameraPosition(i){const l=(i=i||this.pixelsPerMeter)/this.pixelsPerMeter,p=this._camera.forward(),_=this.point,y=this._mercatorZfromZoom(this._cameraZoom?this._cameraZoom:this._zoom)*l-i/this.worldSize*this._centerAltitude;return[_.x/this.worldSize-p[0]*y,_.y/this.worldSize-p[1]*y,i/this.worldSize*this._centerAltitude-p[2]*y]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(i){const l=this._maxCameraBoundsDistance()*Math.cos(this._pitch),p=i[2];let _=1;p>0&&(_=Math.min((l-this._camera.position[2])/p,1)),this._camera.position=a.scaleAndAdd([],this._camera.position,i,_),this._updateStateFromCamera()}_updateStateFromCamera(){const i=this._camera.position,l=this._camera.forward(),{pitch:p,bearing:_}=this._camera.getPitchBearing(),y=a.mercatorZfromAltitude(this._centerAltitude,this.center.lat)*this._projectionScaler,b=this._mercatorZfromZoom(this._maxZoom)*Math.cos(a.degToRad(this._maxPitch)),T=Math.max((i[2]-y)/Math.cos(p),b),C=this._zoomFromMercatorZ(T);a.scaleAndAdd(i,i,l,T),this._pitch=a.clamp(p,a.degToRad(this.minPitch),a.degToRad(this.maxPitch)),this.angle=a.wrap(_,-Math.PI,Math.PI),this._setZoom(a.clamp(C,this._minZoom,this._maxZoom)),this._terrainEnabled()&&this._updateCameraOnTerrain(),this._center=this.coordinateLocation(new a.MercatorCoordinate(i[0],i[1],i[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(i){return Math.pow(2,i)*this.tileSize}_mercatorZfromZoom(i){return this.cameraToCenterDistance/this._worldSizeFromZoom(i)}_minimumHeightOverTerrain(){const i=Math.min((this._cameraZoom!=null?this._cameraZoom:this._zoom)+2,this._maxZoom);return this._mercatorZfromZoom(i)}_zoomFromMercatorZ(i){return this.scaleZoom(this.cameraToCenterDistance/(i*this.tileSize))}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(a.warnOnce("Terrain is not yet supported with alternate projections. Use mercator to enable terrain."),1))}anyCornerOffEdge(i,l){const p=Math.min(i.x,l.x),_=Math.max(i.x,l.x),y=Math.min(i.y,l.y),b=Math.max(i.y,l.y);if(y<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const T=[new a.pointGeometry(p,y),new a.pointGeometry(_,b),new a.pointGeometry(p,b),new a.pointGeometry(_,y)],C=this.renderWorldCopies?-3:0,M=this.renderWorldCopies?4:1;for(const k of T){const P=this.pointRayIntersection(k);if(P.t<0)return!0;const F=this.rayIntersectionCoordinate(P);if(F.x<C||F.y<0||F.x>M||F.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+a.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new a.pointGeometry(0,0),new a.pointGeometry(this.width,this.height))}zoomDeltaToMovement(i,l){const p=a.length(a.sub([],this._camera.position,i)),_=this._zoomFromMercatorZ(p)+l;return p-this._mercatorZfromZoom(_)}getCameraPoint(){const i=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new a.pointGeometry(0,i))}}function Nn(d,i){let l=!1,p=null;const _=()=>{p=null,l&&(d(),p=setTimeout(_,i),l=!1)};return()=>(l=!0,p||_(),p)}class tu{constructor(i){this._hashName=i&&encodeURIComponent(i),a.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Nn(this._updateHashUnthrottled.bind(this),300)}addTo(i){return this._map=i,a.window.addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return a.window.removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this}getHashString(i){const l=this._map.getCenter(),p=Math.round(100*this._map.getZoom())/100,_=Math.ceil((p*Math.LN2+Math.log(512/360/.5))/Math.LN10),y=Math.pow(10,_),b=Math.round(l.lng*y)/y,T=Math.round(l.lat*y)/y,C=this._map.getBearing(),M=this._map.getPitch();let k="";if(k+=i?`/${b}/${T}/${p}`:`${p}/${T}/${b}`,(C||M)&&(k+="/"+Math.round(10*C)/10),M&&(k+=`/${Math.round(M)}`),this._hashName){const P=this._hashName;let F=!1;const j=a.window.location.hash.slice(1).split("&").map(N=>{const $=N.split("=")[0];return $===P?(F=!0,`${$}=${k}`):N}).filter(N=>N);return F||j.push(`${P}=${k}`),`#${j.join("&")}`}return`#${k}`}_getCurrentHash(){const i=a.window.location.hash.replace("#","");if(this._hashName){let l;return i.split("&").map(p=>p.split("=")).forEach(p=>{p[0]===this._hashName&&(l=p)}),(l&&l[1]||"").split("/")}return i.split("/")}_onHashChange(){const i=this._getCurrentHash();if(i.length>=3&&!i.some(l=>isNaN(l))){const l=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(i[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+i[2],+i[1]],zoom:+i[0],bearing:l,pitch:+(i[4]||0)}),!0}return!1}_updateHashUnthrottled(){const i=a.window.location.href.replace(/(#.+)?$/,this.getHashString());a.window.history.replaceState(a.window.history.state,null,i)}}const mn={linearity:.3,easing:a.bezier(0,0,.3,1)},Fs=a.extend({deceleration:2500,maxSpeed:1400},mn),iu=a.extend({deceleration:20,maxSpeed:1400},mn),hc=a.extend({deceleration:1e3,maxSpeed:360},mn),Dt=a.extend({deceleration:1e3,maxSpeed:90},mn);class Xa{constructor(i){this._map=i,this.clear()}clear(){this._inertiaBuffer=[]}record(i){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:a.exported.now(),settings:i})}_drainInertiaBuffer(){const i=this._inertiaBuffer,l=a.exported.now();for(;i.length>0&&l-i[0].time>160;)i.shift()}_onMoveEnd(i){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const l={zoom:0,bearing:0,pitch:0,pan:new a.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:y}of this._inertiaBuffer)l.zoom+=y.zoomDelta||0,l.bearing+=y.bearingDelta||0,l.pitch+=y.pitchDelta||0,y.panDelta&&l.pan._add(y.panDelta),y.around&&(l.around=y.around),y.pinchAround&&(l.pinchAround=y.pinchAround);const p=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,_={};if(l.pan.mag()){const y=Oo(l.pan.mag(),p,a.extend({},Fs,i||{}));_.offset=l.pan.mult(y.amount/l.pan.mag()),_.center=this._map.transform.center,Ha(_,y)}if(l.zoom){const y=Oo(l.zoom,p,iu);_.zoom=this._map.transform.zoom+y.amount,Ha(_,y)}if(l.bearing){const y=Oo(l.bearing,p,hc);_.bearing=this._map.transform.bearing+a.clamp(y.amount,-179,179),Ha(_,y)}if(l.pitch){const y=Oo(l.pitch,p,Dt);_.pitch=this._map.transform.pitch+y.amount,Ha(_,y)}if(_.zoom||_.bearing){const y=l.pinchAround===void 0?l.around:l.pinchAround;_.around=y?this._map.unproject(y):this._map.getCenter()}return this.clear(),a.extend(_,{noMoveStart:!0})}}function Ha(d,i){(!d.duration||d.duration<i.duration)&&(d.duration=i.duration,d.easing=i.easing)}function Oo(d,i,l){const{maxSpeed:p,linearity:_,deceleration:y}=l,b=a.clamp(d*_/(i/1e3),-p,p),T=Math.abs(b)/(y*_);return{easing:l.easing,duration:1e3*T,amount:b*(T/2)}}class Bi extends a.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,l,p,_={}){const y=fe.mousePos(l.getCanvasContainer(),p),b=l.unproject(y);super(i,a.extend({point:y,lngLat:b,originalEvent:p},_)),this._defaultPrevented=!1,this.target=l}}class Ka extends a.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,l,p){const _=i==="touchend"?p.changedTouches:p.touches,y=fe.touchPos(l.getCanvasContainer(),_),b=y.map(C=>l.unproject(C)),T=y.reduce((C,M,k,P)=>C.add(M.div(P.length)),new a.pointGeometry(0,0));super(i,{points:y,point:T,lngLats:b,lngLat:l.unproject(T),originalEvent:p}),this._defaultPrevented=!1}}class rp extends a.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,l,p){super(i,{originalEvent:p}),this._defaultPrevented=!1}}class ru{constructor(i,l){this._map=i,this._clickTolerance=l.clickTolerance}reset(){delete this._mousedownPos}wheel(i){return this._firePreventable(new rp(i.type,this._map,i))}mousedown(i,l){return this._mousedownPos=l,this._firePreventable(new Bi(i.type,this._map,i))}mouseup(i){this._map.fire(new Bi(i.type,this._map,i))}preclick(i){const l=a.extend({},i);l.type="preclick",this._map.fire(new Bi(l.type,this._map,l))}click(i,l){this._mousedownPos&&this._mousedownPos.dist(l)>=this._clickTolerance||(this.preclick(i),this._map.fire(new Bi(i.type,this._map,i)))}dblclick(i){return this._firePreventable(new Bi(i.type,this._map,i))}mouseover(i){this._map.fire(new Bi(i.type,this._map,i))}mouseout(i){this._map.fire(new Bi(i.type,this._map,i))}touchstart(i){return this._firePreventable(new Ka(i.type,this._map,i))}touchmove(i){this._map.fire(new Ka(i.type,this._map,i))}touchend(i){this._map.fire(new Ka(i.type,this._map,i))}touchcancel(i){this._map.fire(new Ka(i.type,this._map,i))}_firePreventable(i){if(this._map.fire(i),i.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class np{constructor(i){this._map=i}reset(){this._delayContextMenu=!1,delete this._contextMenuEvent}mousemove(i){this._map.fire(new Bi(i.type,this._map,i))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Bi("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(i){this._delayContextMenu?this._contextMenuEvent=i:this._map.fire(new Bi(i.type,this._map,i)),this._map.listens("contextmenu")&&i.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class uc{constructor(i,l){this._map=i,this._el=i.getCanvasContainer(),this._container=i.getContainer(),this._clickTolerance=l.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(i,l){this.isEnabled()&&i.shiftKey&&i.button===0&&(fe.disableDrag(),this._startPos=this._lastPos=l,this._active=!0)}mousemoveWindow(i,l){if(!this._active)return;const p=l;if(this._lastPos.equals(p)||!this._box&&p.dist(this._startPos)<this._clickTolerance)return;const _=this._startPos;this._lastPos=p,this._box||(this._box=fe.create("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",i));const y=Math.min(_.x,p.x),b=Math.max(_.x,p.x),T=Math.min(_.y,p.y),C=Math.max(_.y,p.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${y}px,${T}px)`,this._box.style.width=b-y+"px",this._box.style.height=C-T+"px")})}mouseupWindow(i,l){if(!this._active||i.button!==0)return;const p=this._startPos,_=l;if(this.reset(),fe.suppressClick(),p.x!==_.x||p.y!==_.y)return this._map.fire(new a.Event("boxzoomend",{originalEvent:i})),{cameraAnimation:y=>y.fitScreenCoordinates(p,_,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",i)}keydown(i){this._active&&i.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",i))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),fe.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(i,l){return this._map.fire(new a.Event(i,{originalEvent:l}))}}function Os(d,i){const l={};for(let p=0;p<d.length;p++)l[d[p].identifier]=i[p];return l}class No{constructor(i){this.reset(),this.numTouches=i.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(i,l,p){(this.centroid||p.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=i.timeStamp),p.length===this.numTouches&&(this.centroid=function(_){const y=new a.pointGeometry(0,0);for(const b of _)y._add(b);return y.div(_.length)}(l),this.touches=Os(p,l)))}touchmove(i,l,p){if(this.aborted||!this.centroid)return;const _=Os(p,l);for(const y in this.touches){const b=this.touches[y],T=_[y];(!T||T.dist(b)>30)&&(this.aborted=!0)}}touchend(i,l,p){if((!this.centroid||i.timeStamp-this.startTime>500)&&(this.aborted=!0),p.length===0){const _=!this.aborted&&this.centroid;if(this.reset(),_)return _}}}class Uo{constructor(i){this.singleTap=new No(i),this.numTaps=i.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(i,l,p){this.singleTap.touchstart(i,l,p)}touchmove(i,l,p){this.singleTap.touchmove(i,l,p)}touchend(i,l,p){const _=this.singleTap.touchend(i,l,p);if(_){const y=i.timeStamp-this.lastTime<500,b=!this.lastTap||this.lastTap.dist(_)<30;if(y&&b||this.reset(),this.count++,this.lastTime=i.timeStamp,this.lastTap=_,this.count===this.numTaps)return this.reset(),_}}}class dc{constructor(){this._zoomIn=new Uo({numTouches:1,numTaps:2}),this._zoomOut=new Uo({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(i,l,p){this._zoomIn.touchstart(i,l,p),this._zoomOut.touchstart(i,l,p)}touchmove(i,l,p){this._zoomIn.touchmove(i,l,p),this._zoomOut.touchmove(i,l,p)}touchend(i,l,p){const _=this._zoomIn.touchend(i,l,p),y=this._zoomOut.touchend(i,l,p);return _?(this._active=!0,i.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()+1,around:b.unproject(_)},{originalEvent:i})}):y?(this._active=!0,i.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()-1,around:b.unproject(y)},{originalEvent:i})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const nu={0:1,2:2};class Ns{constructor(i){this.reset(),this._clickTolerance=i.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,delete this._lastPoint,delete this._eventButton}_correctButton(i,l){return!1}_move(i,l){return{}}mousedown(i,l){if(this._lastPoint)return;const p=fe.mouseButton(i);this._correctButton(i,p)&&(this._lastPoint=l,this._eventButton=p)}mousemoveWindow(i,l){const p=this._lastPoint;if(p){if(i.preventDefault(),function(_,y){const b=nu[y];return _.buttons===void 0||(_.buttons&b)!==b}(i,this._eventButton))this.reset();else if(this._moved||!(l.dist(p)<this._clickTolerance))return this._moved=!0,this._lastPoint=l,this._move(p,l)}}mouseupWindow(i){this._lastPoint&&fe.mouseButton(i)===this._eventButton&&(this._moved&&fe.suppressClick(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ya extends Ns{mousedown(i,l){super.mousedown(i,l),this._lastPoint&&(this._active=!0)}_correctButton(i,l){return l===0&&!i.ctrlKey}_move(i,l){return{around:l,panDelta:l.sub(i)}}}class Mr extends Ns{_correctButton(i,l){return l===0&&i.ctrlKey||l===2}_move(i,l){const p=.8*(l.x-i.x);if(p)return this._active=!0,{bearingDelta:p}}contextmenu(i){i.preventDefault()}}class pc extends Ns{_correctButton(i,l){return l===0&&i.ctrlKey||l===2}_move(i,l){const p=-.5*(l.y-i.y);if(p)return this._active=!0,{pitchDelta:p}}contextmenu(i){i.preventDefault()}}class su{constructor(i,l){this._map=i,this._el=i.getCanvasContainer(),this._minTouches=1,this._clickTolerance=l.clickTolerance||1,this.reset(),a.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new a.pointGeometry(0,0)}touchstart(i,l,p){return this._calculateTransform(i,l,p)}touchmove(i,l,p){if(this._active&&!(p.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(p.length===1)return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return i.preventDefault(),this._calculateTransform(i,l,p)}}touchend(i,l,p){this._calculateTransform(i,l,p),this._active&&p.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(i,l,p){p.length>0&&(this._active=!0);const _=Os(p,l),y=new a.pointGeometry(0,0),b=new a.pointGeometry(0,0);let T=0;for(const M in _){const k=_[M],P=this._touches[M];P&&(y._add(k),b._add(k.sub(P)),T++,_[M]=k)}if(this._touches=_,T<this._minTouches||!b.mag())return;const C=b.div(T);return this._sum._add(C),this._sum.mag()<this._clickTolerance?void 0:{around:y.div(T),panDelta:C}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=fe.create("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility==="hidden"&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show")},500)}}class Ja{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}_start(i){}_move(i,l,p){return{}}touchstart(i,l,p){this._firstTwoTouches||p.length<2||(this._firstTwoTouches=[p[0].identifier,p[1].identifier],this._start([l[0],l[1]]))}touchmove(i,l,p){if(!this._firstTwoTouches)return;i.preventDefault();const[_,y]=this._firstTwoTouches,b=_n(p,l,_),T=_n(p,l,y);if(!b||!T)return;const C=this._aroundCenter?null:b.add(T).div(2);return this._move([b,T],C,i)}touchend(i,l,p){if(!this._firstTwoTouches)return;const[_,y]=this._firstTwoTouches,b=_n(p,l,_),T=_n(p,l,y);b&&T||(this._active&&fe.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(i){this._enabled=!0,this._aroundCenter=!!i&&i.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function _n(d,i,l){for(let p=0;p<d.length;p++)if(d[p].identifier===l)return i[p]}function fc(d,i){return Math.log(d/i)/Math.LN2}class Qa extends Ja{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(i){this._startDistance=this._distance=i[0].dist(i[1])}_move(i,l){const p=this._distance;if(this._distance=i[0].dist(i[1]),this._active||!(Math.abs(fc(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:fc(this._distance,p),pinchAround:l}}}function el(d,i){return 180*d.angleWith(i)/Math.PI}class tl extends Ja{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(i){this._startVector=this._vector=i[0].sub(i[1]),this._minDiameter=i[0].dist(i[1])}_move(i,l){const p=this._vector;if(this._vector=i[0].sub(i[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:el(this._vector,p),pinchAround:l}}_isBelowThreshold(i){this._minDiameter=Math.min(this._minDiameter,i.mag());const l=25/(Math.PI*this._minDiameter)*360,p=el(i,this._startVector);return Math.abs(p)<l}}function il(d){return Math.abs(d.y)>Math.abs(d.x)}class ou extends Ja{constructor(i){super(),this._map=i}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}_start(i){this._lastPoints=i,il(i[0].sub(i[1]))&&(this._valid=!1)}_move(i,l,p){const _=i[0].sub(this._lastPoints[0]),y=i[1].sub(this._lastPoints[1]);if(!(this._map._cooperativeGestures&&p.touches.length<3)&&(this._valid=this.gestureBeginsVertically(_,y,p.timeStamp),this._valid))return this._lastPoints=i,this._active=!0,{pitchDelta:(_.y+y.y)/2*-.5}}gestureBeginsVertically(i,l,p){if(this._valid!==void 0)return this._valid;const _=i.mag()>=2,y=l.mag()>=2;if(!_&&!y)return;if(!_||!y)return this._firstMove===void 0&&(this._firstMove=p),p-this._firstMove<100&&void 0;const b=i.y>0==l.y>0;return il(i)&&il(l)&&b}}const Us={panStep:100,bearingStep:15,pitchStep:10};class sp{constructor(){const i=Us;this._panStep=i.panStep,this._bearingStep=i.bearingStep,this._pitchStep=i.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(i){if(i.altKey||i.ctrlKey||i.metaKey)return;let l=0,p=0,_=0,y=0,b=0;switch(i.keyCode){case 61:case 107:case 171:case 187:l=1;break;case 189:case 109:case 173:l=-1;break;case 37:i.shiftKey?p=-1:(i.preventDefault(),y=-1);break;case 39:i.shiftKey?p=1:(i.preventDefault(),y=1);break;case 38:i.shiftKey?_=1:(i.preventDefault(),b=-1);break;case 40:i.shiftKey?_=-1:(i.preventDefault(),b=1);break;default:return}return this._rotationDisabled&&(p=0,_=0),{cameraAnimation:T=>{const C=T.getZoom();T.easeTo({duration:300,easeId:"keyboardHandler",easing:op,zoom:l?Math.round(C)+l*(i.shiftKey?2:1):C,bearing:T.getBearing()+p*this._bearingStep,pitch:T.getPitch()+_*this._pitchStep,offset:[-y*this._panStep,-b*this._panStep],center:T.getCenter()},{originalEvent:i})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function op(d){return d*(2-d)}const mc=4.000244140625;class rl{constructor(i,l){this._map=i,this._el=i.getCanvasContainer(),this._handler=l,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,a.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert","_isFullscreen"],this)}setZoomRate(i){this._defaultZoomRate=i}setWheelZoomRate(i){this._wheelZoomRate=i}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(i){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!i&&i.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(i){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(i.ctrlKey||i.metaKey||this.isZooming()||this._isFullscreen()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let l=i.deltaMode===a.window.WheelEvent.DOM_DELTA_LINE?40*i.deltaY:i.deltaY;const p=a.exported.now(),_=p-(this._lastWheelEventTime||0);this._lastWheelEventTime=p,l!==0&&l%mc==0?this._type="wheel":l!==0&&Math.abs(l)<4?this._type="trackpad":_>400?(this._type=null,this._lastValue=l,this._timeout=setTimeout(this._onTimeout,40,i)):this._type||(this._type=Math.abs(_*l)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,l+=this._lastValue)),i.shiftKey&&l&&(l/=4),this._type&&(this._lastWheelEvent=i,this._delta-=l,this._active||this._start(i)),i.preventDefault()}_onTimeout(i){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(i)}_start(i){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const l=fe.mousePos(this._el,i);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:l,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const i=this._map.transform,l=()=>i._terrainEnabled()&&this._aroundCoord?i.computeZoomRelativeTo(this._aroundCoord):i.zoom;if(this._delta!==0){const C=this._type==="wheel"&&Math.abs(this._delta)>mc?this._wheelZoomRate:this._defaultZoomRate;let M=2/(1+Math.exp(-Math.abs(this._delta*C)));this._delta<0&&M!==0&&(M=1/M);const k=l(),P=Math.pow(2,k),F=typeof this._targetZoom=="number"?i.zoomScale(this._targetZoom):P;this._targetZoom=Math.min(i.maxZoom,Math.max(i.minZoom,i.scaleZoom(F*M))),this._type==="wheel"&&(this._startZoom=l(),this._easing=this._smoothOutEasing(200)),this._delta=0}const p=typeof this._targetZoom=="number"?this._targetZoom:l(),_=this._startZoom,y=this._easing;let b,T=!1;if(this._type==="wheel"&&_&&y){const C=Math.min((a.exported.now()-this._lastWheelEventTime)/200,1),M=y(C);b=a.number(_,p,M),C<1?this._frameId||(this._frameId=!0):T=!0}else b=p,T=!0;return this._active=!0,T&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!T,zoomDelta:b-l(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(i){let l=a.ease;if(this._prevEase){const p=this._prevEase,_=(a.exported.now()-p.start)/p.duration,y=p.easing(_+.01)-p.easing(_),b=.27/Math.sqrt(y*y+1e-4)*.01,T=Math.sqrt(.0729-b*b);l=a.bezier(b,T,.25,1)}return this._prevEase={start:a.exported.now(),duration:i,easing:l},l}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=fe.create("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(a.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_isFullscreen(){return!!a.window.document.fullscreenElement||!!a.window.document.webkitFullscreenElement}_showBlockerAlert(){this._alertContainer.style.visibility==="hidden"&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show")},200)}}class _c{constructor(i,l){this._clickZoom=i,this._tapZoom=l}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class au{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(i,l){return i.preventDefault(),{cameraAnimation:p=>{p.easeTo({duration:300,zoom:p.getZoom()+(i.shiftKey?-1:1),around:p.unproject(l)},{originalEvent:i})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class lu{constructor(){this._tap=new Uo({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,this._tap.reset()}touchstart(i,l,p){this._swipePoint||(this._tapTime&&i.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?p.length>0&&(this._swipePoint=l[0],this._swipeTouch=p[0].identifier):this._tap.touchstart(i,l,p))}touchmove(i,l,p){if(this._tapTime){if(this._swipePoint){if(p[0].identifier!==this._swipeTouch)return;const _=l[0],y=_.y-this._swipePoint.y;return this._swipePoint=_,i.preventDefault(),this._active=!0,{zoomDelta:y/128}}}else this._tap.touchmove(i,l,p)}touchend(i,l,p){this._tapTime?this._swipePoint&&p.length===0&&this.reset():this._tap.touchend(i,l,p)&&(this._tapTime=i.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class nl{constructor(i,l,p){this._el=i,this._mousePan=l,this._touchPan=p}enable(i){this._inertiaOptions=i||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class gc{constructor(i,l,p){this._pitchWithRotate=i.pitchWithRotate,this._mouseRotate=l,this._mousePitch=p}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class cu{constructor(i,l,p,_){this._el=i,this._touchZoom=l,this._touchRotate=p,this._tapDragZoom=_,this._rotationDisabled=!1,this._enabled=!0}enable(i){this._touchZoom.enable(i),this._rotationDisabled||this._touchRotate.enable(i),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Vo=d=>d.zoom||d.drag||d.pitch||d.rotate;class hu extends a.Event{}class uu{constructor(){this.constants=[1,1,.01],this.radius=0}setup(i,l){const p=a.sub([],l,i);this.radius=a.length(p[2]<0?a.div([],p,this.constants):[p[0],p[1],0])}projectRay(i){a.div(i,i,this.constants),a.normalize(i,i),a.mul$1(i,i,this.constants);const l=a.scale$2([],i,this.radius);if(l[2]>0){const p=a.scale$2([],[0,0,1],a.dot(l,[0,0,1])),_=a.scale$2([],a.normalize([],[l[0],l[1],0]),this.radius),y=a.add([],l,a.scale$2([],a.sub([],a.add([],_,p),l),2));l[0]=y[0],l[1]=y[1]}return l}}function jo(d){return d.panDelta&&d.panDelta.mag()||d.zoomDelta||d.bearingDelta||d.pitchDelta}class Vs{constructor(i,l){this._map=i,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Xa(i),this._bearingSnap=l.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new uu,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(l),a.bindAll(["handleEvent","handleWindowEvent"],this);const p=this._el;this._listeners=[[p,"touchstart",{passive:!0}],[p,"touchmove",{passive:!1}],[p,"touchend",void 0],[p,"touchcancel",void 0],[p,"mousedown",void 0],[p,"mousemove",void 0],[p,"mouseup",void 0],[a.window.document,"mousemove",{capture:!0}],[a.window.document,"mouseup",void 0],[p,"mouseover",void 0],[p,"mouseout",void 0],[p,"dblclick",void 0],[p,"click",void 0],[p,"keydown",{capture:!1}],[p,"keyup",void 0],[p,"wheel",{passive:!1}],[p,"contextmenu",void 0],[a.window,"blur",void 0]];for(const[_,y,b]of this._listeners)_.addEventListener(y,_===a.window.document?this.handleWindowEvent:this.handleEvent,b)}destroy(){for(const[i,l,p]of this._listeners)i.removeEventListener(l,i===a.window.document?this.handleWindowEvent:this.handleEvent,p)}_addDefaultHandlers(i){const l=this._map,p=l.getCanvasContainer();this._add("mapEvent",new ru(l,i));const _=l.boxZoom=new uc(l,i);this._add("boxZoom",_);const y=new dc,b=new au;l.doubleClickZoom=new _c(b,y),this._add("tapZoom",y),this._add("clickZoom",b);const T=new lu;this._add("tapDragZoom",T);const C=l.touchPitch=new ou(l);this._add("touchPitch",C);const M=new Mr(i),k=new pc(i);l.dragRotate=new gc(i,M,k),this._add("mouseRotate",M,["mousePitch"]),this._add("mousePitch",k,["mouseRotate"]);const P=new Ya(i),F=new su(l,i);l.dragPan=new nl(p,P,F),this._add("mousePan",P),this._add("touchPan",F,["touchZoom","touchRotate"]);const j=new tl,N=new Qa;l.touchZoomRotate=new cu(p,N,j,T),this._add("touchRotate",j,["touchPan","touchZoom"]),this._add("touchZoom",N,["touchPan","touchRotate"]),this._add("blockableMapEvent",new np(l));const $=l.scrollZoom=new rl(l,this);this._add("scrollZoom",$,["mousePan"]);const ee=l.keyboard=new sp;this._add("keyboard",ee);for(const V of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])i.interactive&&i[V]&&l[V].enable(i[V])}_add(i,l,p){this._handlers.push({handlerName:i,handler:l,allowed:p}),this._handlersById[i]=l}stop(i){if(!this._updatingCamera){for(const{handler:l}of this._handlers)l.reset();this._inertia.clear(),this._fireEvents({},{},i),this._changes=[]}}isActive(){for(const{handler:i}of this._handlers)if(i.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return Boolean(Vo(this._eventsInProgress))||this.isZooming()}_blockedByActive(i,l,p){for(const _ in i)if(_!==p&&(!l||l.indexOf(_)<0))return!0;return!1}handleWindowEvent(i){this.handleEvent(i,`${i.type}Window`)}_getMapTouches(i){const l=[];for(const p of i)this._el.contains(p.target)&&l.push(p);return l}handleEvent(i,l){this._updatingCamera=!0;const p=i.type==="renderFrame",_=p?void 0:i,y={needsRenderFrame:!1},b={},T={},C=i.touches?this._getMapTouches(i.touches):void 0,M=C?fe.touchPos(this._el,C):p?void 0:fe.mousePos(this._el,i);for(const{handlerName:F,handler:j,allowed:N}of this._handlers){if(!j.isEnabled())continue;let $;this._blockedByActive(T,N,F)?j.reset():j[l||i.type]&&($=j[l||i.type](i,M,C),this.mergeHandlerResult(y,b,$,F,_),$&&$.needsRenderFrame&&this._triggerRenderFrame()),($||j.isActive())&&(T[F]=j)}const k={};for(const F in this._previousActiveHandlers)T[F]||(k[F]=_);this._previousActiveHandlers=T,(Object.keys(k).length||jo(y))&&(this._changes.push([y,b,k]),this._triggerRenderFrame()),(Object.keys(T).length||jo(y))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:P}=y;P&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],P(this._map))}mergeHandlerResult(i,l,p,_,y){if(!p)return;a.extend(i,p);const b={handlerName:_,originalEvent:p.originalEvent||y};p.zoomDelta!==void 0&&(l.zoom=b),p.panDelta!==void 0&&(l.drag=b),p.pitchDelta!==void 0&&(l.pitch=b),p.bearingDelta!==void 0&&(l.rotate=b)}_applyChanges(){const i={},l={},p={};for(const[_,y,b]of this._changes)_.panDelta&&(i.panDelta=(i.panDelta||new a.pointGeometry(0,0))._add(_.panDelta)),_.zoomDelta&&(i.zoomDelta=(i.zoomDelta||0)+_.zoomDelta),_.bearingDelta&&(i.bearingDelta=(i.bearingDelta||0)+_.bearingDelta),_.pitchDelta&&(i.pitchDelta=(i.pitchDelta||0)+_.pitchDelta),_.around!==void 0&&(i.around=_.around),_.aroundCoord!==void 0&&(i.aroundCoord=_.aroundCoord),_.pinchAround!==void 0&&(i.pinchAround=_.pinchAround),_.noInertia&&(i.noInertia=_.noInertia),a.extend(l,y),a.extend(p,b);this._updateMapTransform(i,l,p),this._changes=[]}_updateMapTransform(i,l,p){const _=this._map,y=_.transform,b=Y=>[Y.x,Y.y,Y.z];if((Y=>{const J=this._eventsInProgress.drag;return J&&!this._handlersById[J.handlerName].isActive()})()&&!jo(i)){const Y=y.zoom;y.cameraElevationReference="sea",y.recenterOnTerrain(),y.cameraElevationReference="ground",Y!==y.zoom&&this._map._update(!0)}if(!jo(i))return this._fireEvents(l,p,!0);let{panDelta:T,zoomDelta:C,bearingDelta:M,pitchDelta:k,around:P,aroundCoord:F,pinchAround:j}=i;j!==void 0&&(P=j),(Y=>l.drag&&!this._eventsInProgress.drag)()&&P&&(this._dragOrigin=b(y.pointCoordinate3D(P)),this._trackingEllipsoid.setup(y._camera.position,this._dragOrigin)),y.cameraElevationReference="sea",_._stop(!0),P=P||_.transform.centerPoint,M&&(y.bearing+=M),k&&(y.pitch+=k),y._updateCameraState();const N=[0,0,0];if(T){const Y=y.pointCoordinate(P),J=y.pointCoordinate(P.sub(T));Y&&J&&(N[0]=J.x-Y.x,N[1]=J.y-Y.y)}const $=y.zoom,ee=[0,0,0];if(C){const Y=b(F||y.pointCoordinate3D(P)),J={dir:a.normalize([],a.sub([],Y,y._camera.position))};if(J.dir[2]<0){const H=y.zoomDeltaToMovement(Y,C);a.scale$2(ee,J.dir,H)}}const V=a.add(N,N,ee);y._translateCameraConstrained(V),C&&Math.abs(y.zoom-$)>1e-4&&y.recenterOnTerrain(),y.cameraElevationReference="ground",this._map._update(),i.noInertia||this._inertia.record(i),this._fireEvents(l,p,!0)}_fireEvents(i,l,p){const _=Vo(this._eventsInProgress),y=Vo(i),b={};for(const k in i){const{originalEvent:P}=i[k];this._eventsInProgress[k]||(b[`${k}start`]=P),this._eventsInProgress[k]=i[k]}!_&&y&&this._fireEvent("movestart",y.originalEvent);for(const k in b)this._fireEvent(k,b[k]);y&&this._fireEvent("move",y.originalEvent);for(const k in i){const{originalEvent:P}=i[k];this._fireEvent(k,P)}const T={};let C;for(const k in this._eventsInProgress){const{handlerName:P,originalEvent:F}=this._eventsInProgress[k];this._handlersById[P].isActive()||(delete this._eventsInProgress[k],C=l[P]||F,T[`${k}end`]=C)}for(const k in T)this._fireEvent(k,T[k]);const M=Vo(this._eventsInProgress);if(p&&(_||y)&&!M){this._updatingCamera=!0;const k=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),P=F=>F!==0&&-this._bearingSnap<F&&F<this._bearingSnap;k?(P(k.bearing||this._map.getBearing())&&(k.bearing=0),this._map.easeTo(k,{originalEvent:C})):(this._map.fire(new a.Event("moveend",{originalEvent:C})),P(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(i,l){this._map.fire(new a.Event(i,l?{originalEvent:l}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(i=>{delete this._frameId,this.handleEvent(new hu("renderFrame",{timeStamp:i})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const yc="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class du extends a.Evented{constructor(i,l){super(),this._moving=!1,this._zooming=!1,this.transform=i,this._bearingSnap=l.bearingSnap,a.bindAll(["_renderFrameCallback"],this)}getCenter(){return new a.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(i,l){return this.jumpTo({center:i},l)}panBy(i,l,p){return i=a.pointGeometry.convert(i).mult(-1),this.panTo(this.transform.center,a.extend({offset:i},l),p)}panTo(i,l,p){return this.easeTo(a.extend({center:i},l),p)}getZoom(){return this.transform.zoom}setZoom(i,l){return this.jumpTo({zoom:i},l),this}zoomTo(i,l,p){return this.easeTo(a.extend({zoom:i},l),p)}zoomIn(i,l){return this.zoomTo(this.getZoom()+1,i,l),this}zoomOut(i,l){return this.zoomTo(this.getZoom()-1,i,l),this}getBearing(){return this.transform.bearing}setBearing(i,l){return this.jumpTo({bearing:i},l),this}getPadding(){return this.transform.padding}setPadding(i,l){return this.jumpTo({padding:i},l),this}rotateTo(i,l,p){return this.easeTo(a.extend({bearing:i},l),p)}resetNorth(i,l){return this.rotateTo(0,a.extend({duration:1e3},i),l),this}resetNorthPitch(i,l){return this.easeTo(a.extend({bearing:0,pitch:0,duration:1e3},i),l),this}snapToNorth(i,l){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(i,l):this}getPitch(){return this.transform.pitch}setPitch(i,l){return this.jumpTo({pitch:i},l),this}cameraForBounds(i,l){i=a.LngLatBounds.convert(i);const p=l&&l.bearing||0;return this._cameraForBoxAndBearing(i.getNorthWest(),i.getSouthEast(),p,l)}_extendCameraOptions(i){const l={top:0,bottom:0,right:0,left:0};if(typeof(i=a.extend({padding:l,offset:[0,0],maxZoom:this.transform.maxZoom},i)).padding=="number"){const p=i.padding;i.padding={top:p,bottom:p,right:p,left:p}}return i.padding=a.extend(l,i.padding),i}_cameraForBoxAndBearing(i,l,p,_){const y=this._extendCameraOptions(_),b=this.transform,T=b.padding,C=b.project(a.LngLat.convert(i)),M=b.project(a.LngLat.convert(l)),k=C.rotate(-a.degToRad(p)),P=M.rotate(-a.degToRad(p)),F=new a.pointGeometry(Math.max(k.x,P.x),Math.max(k.y,P.y)),j=new a.pointGeometry(Math.min(k.x,P.x),Math.min(k.y,P.y)),N=F.sub(j),$=(b.width-(T.left+T.right+y.padding.left+y.padding.right))/N.x,ee=(b.height-(T.top+T.bottom+y.padding.top+y.padding.bottom))/N.y;if(ee<0||$<0)return void a.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const V=Math.min(b.scaleZoom(b.scale*Math.min($,ee)),y.maxZoom),Y=typeof y.offset.x=="number"?new a.pointGeometry(y.offset.x,y.offset.y):a.pointGeometry.convert(y.offset),J=new a.pointGeometry((y.padding.left-y.padding.right)/2,(y.padding.top-y.padding.bottom)/2).rotate(p*Math.PI/180),H=Y.add(J).mult(b.scale/b.zoomScale(V));return{center:b.unproject(C.add(M).div(2).sub(H)),zoom:V,bearing:p}}_cameraForBox(i,l,p,_,y){const b=this._extendCameraOptions(y);p=p||0,_=_||0,i=a.LngLat.convert(i),l=a.LngLat.convert(l);const T=this.transform.clone();T.padding=b.padding;const C=this.getFreeCameraOptions(),M=new a.LngLat(.5*(i.lng+l.lng),.5*(i.lat+l.lat)),k=.5*(p+_);if(T._camera.position[2]<a.mercatorZfromAltitude(k,M.lat))return void a.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");C.lookAtPoint(M),T.setFreeCameraOptions(C);const P=a.MercatorCoordinate.fromLngLat(i),F=a.MercatorCoordinate.fromLngLat(l),j=T.pointRayIntersection(T.centerPoint,k),N=[($=T.rayIntersectionCoordinate(j)).x,$.y,$.z];var $;const ee=T.screenPointToMercatorRay(T.centerPoint),V=T.projection.name!=="globe";let Y,J=0;do{const H=Math.floor(T.zoom),K=1<<H,te=Math.min(K*P.x,K*F.x),de=Math.min(K*P.y,K*F.y),_e=Math.max(K*P.x,K*F.x),Be=Math.max(K*P.y,K*F.y),ke=new a.Aabb([te,de,p],[_e,Be,_]),Ce=a.Frustum.fromInvProjectionMatrix(T.invProjMatrix,T.worldSize,H,V);if(ke.intersects(Ce)!==2){Y&&(T._camera.position=a.scaleAndAdd([],T._camera.position,ee.dir,-Y),T._updateStateFromCamera());break}const xe=a.sub([],T._camera.position,N);Y=.5*a.length(xe),T._camera.position=a.scaleAndAdd([],T._camera.position,ee.dir,Y);try{T._updateStateFromCamera()}catch{return void a.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}}while(++J<10);return{center:T.center,zoom:T.zoom,bearing:T.bearing,pitch:T.pitch}}fitBounds(i,l,p){return this._fitInternal(this.cameraForBounds(i,l),l,p)}_raycastElevationBox(i,l){const p=this.transform.elevation;if(!p)return;const _=new a.pointGeometry(i.x,l.y),y=new a.pointGeometry(l.x,i.y),b=p.pointCoordinate(i);if(!b)return;const T=p.pointCoordinate(l);if(!T)return;const C=p.pointCoordinate(_);if(!C)return;const M=p.pointCoordinate(y);if(!M)return;const k=new a.MercatorCoordinate(b[0],b[1]).toLngLat(),P=new a.MercatorCoordinate(T[0],T[1]).toLngLat(),F=new a.MercatorCoordinate(C[0],C[1]).toLngLat(),j=new a.MercatorCoordinate(M[0],M[1]).toLngLat(),N=Math.min(k.lng,Math.min(P.lng,Math.min(F.lng,j.lng))),$=Math.min(k.lat,Math.min(P.lat,Math.min(F.lat,j.lat))),ee=Math.max(k.lng,Math.max(P.lng,Math.max(F.lng,j.lng))),V=Math.max(k.lat,Math.max(P.lat,Math.max(F.lat,j.lat))),Y=Math.min(b[3],Math.min(T[3],Math.min(C[3],M[3]))),J=Math.max(b[3],Math.max(T[3],Math.max(C[3],M[3])));return{minLngLat:new a.LngLat(N,$),maxLngLat:new a.LngLat(ee,V),minAltitude:Y,maxAltitude:J}}fitScreenCoordinates(i,l,p,_,y){let b,T,C,M;const k=a.pointGeometry.convert(i),P=a.pointGeometry.convert(l),F=this._raycastElevationBox(k,P);if(F)b=F.minLngLat,T=F.maxLngLat,C=F.minAltitude,M=F.maxAltitude;else{if(this.transform.anyCornerOffEdge(k,P))return this;b=this.transform.pointLocation(k),T=this.transform.pointLocation(P)}return this._fitInternal(this.transform.pitch===0?this._cameraForBoxAndBearing(this.transform.pointLocation(a.pointGeometry.convert(i)),this.transform.pointLocation(a.pointGeometry.convert(l)),p,_):this._cameraForBox(b,T,C,M,_),_,y)}_fitInternal(i,l,p){return i?(delete(l=a.extend(i,l)).padding,l.linear?this.easeTo(l,p):this.flyTo(l,p)):this}jumpTo(i,l){this.stop();const p=i.preloadOnly?this.transform.clone():this.transform;let _=!1,y=!1,b=!1;return"zoom"in i&&p.zoom!==+i.zoom&&(_=!0,p.zoom=+i.zoom),i.center!==void 0&&(p.center=a.LngLat.convert(i.center)),"bearing"in i&&p.bearing!==+i.bearing&&(y=!0,p.bearing=+i.bearing),"pitch"in i&&p.pitch!==+i.pitch&&(b=!0,p.pitch=+i.pitch),i.padding==null||p.isPaddingEqual(i.padding)||(p.padding=i.padding),i.preloadOnly?(this._preloadTiles(p),this):(this.fire(new a.Event("movestart",l)).fire(new a.Event("move",l)),_&&this.fire(new a.Event("zoomstart",l)).fire(new a.Event("zoom",l)).fire(new a.Event("zoomend",l)),y&&this.fire(new a.Event("rotatestart",l)).fire(new a.Event("rotate",l)).fire(new a.Event("rotateend",l)),b&&this.fire(new a.Event("pitchstart",l)).fire(new a.Event("pitch",l)).fire(new a.Event("pitchend",l)),this.fire(new a.Event("moveend",l)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||a.warnOnce(yc),this.transform.getFreeCameraOptions()}setFreeCameraOptions(i,l){const p=this.transform;if(!p.projection.supportsFreeCamera)return void a.warnOnce(yc);this.stop();const _=p.zoom,y=p.pitch,b=p.bearing;p.setFreeCameraOptions(i);const T=_!==p.zoom,C=y!==p.pitch,M=b!==p.bearing;return this.fire(new a.Event("movestart",l)).fire(new a.Event("move",l)),T&&this.fire(new a.Event("zoomstart",l)).fire(new a.Event("zoom",l)).fire(new a.Event("zoomend",l)),M&&this.fire(new a.Event("rotatestart",l)).fire(new a.Event("rotate",l)).fire(new a.Event("rotateend",l)),C&&this.fire(new a.Event("pitchstart",l)).fire(new a.Event("pitch",l)).fire(new a.Event("pitchend",l)),this.fire(new a.Event("moveend",l)),this}easeTo(i,l){this._stop(!1,i.easeId),((i=a.extend({offset:[0,0],duration:500,easing:a.ease},i)).animate===!1||!i.essential&&a.exported.prefersReducedMotion)&&(i.duration=0);const p=this.transform,_=this.getZoom(),y=this.getBearing(),b=this.getPitch(),T=this.getPadding(),C="zoom"in i?+i.zoom:_,M="bearing"in i?this._normalizeBearing(i.bearing,y):y,k="pitch"in i?+i.pitch:b,P="padding"in i?i.padding:p.padding,F=a.pointGeometry.convert(i.offset);let j=p.centerPoint.add(F);const N=p.projection.name==="globe"?p.pointCoordinate(j).toLngLat():p.pointLocation(j),$=a.LngLat.convert(i.center||N);this._normalizeCenter($);const ee=p.project(N),V=p.project($).sub(ee),Y=p.zoomScale(C-_);let J,H;i.around&&(J=a.LngLat.convert(i.around),H=p.locationPoint(J));const K=this._zooming||C!==_,te=this._rotating||y!==M,de=this._pitching||k!==b,_e=!p.isPaddingEqual(P),Be=Ce=>xe=>{if(K&&(Ce.zoom=a.number(_,C,xe)),te&&(Ce.bearing=a.number(y,M,xe)),de&&(Ce.pitch=a.number(b,k,xe)),_e&&(Ce.interpolatePadding(T,P,xe),j=Ce.centerPoint.add(F)),J)Ce.setLocationAtPoint(J,H);else{const me=Ce.zoomScale(Ce.zoom-_),Ae=C>_?Math.min(2,Y):Math.max(.5,Y),Ee=Math.pow(Ae,1-xe),Xe=Ce.unproject(ee.add(V.mult(xe*Ee)).mult(me));Ce.setLocationAtPoint(Ce.renderWorldCopies?Xe.wrap():Xe,j)}return i.preloadOnly||this._fireMoveEvents(l),Ce};if(i.preloadOnly){const Ce=this._emulate(Be,i.duration,p);return this._preloadTiles(Ce),this}const ke={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=K,this._rotating=te,this._pitching=de,this._padding=_e,this._easeId=i.easeId,this._prepareEase(l,i.noMoveStart,ke),this._ease(Be(p),Ce=>{p.recenterOnTerrain(),this._afterEase(l,Ce)},i),this}_prepareEase(i,l,p={}){this._moving=!0,this.transform.cameraElevationReference="sea",l||p.moving||this.fire(new a.Event("movestart",i)),this._zooming&&!p.zooming&&this.fire(new a.Event("zoomstart",i)),this._rotating&&!p.rotating&&this.fire(new a.Event("rotatestart",i)),this._pitching&&!p.pitching&&this.fire(new a.Event("pitchstart",i))}_fireMoveEvents(i){this.fire(new a.Event("move",i)),this._zooming&&this.fire(new a.Event("zoom",i)),this._rotating&&this.fire(new a.Event("rotate",i)),this._pitching&&this.fire(new a.Event("pitch",i))}_afterEase(i,l){if(this._easeId&&l&&this._easeId===l)return;delete this._easeId,this.transform.cameraElevationReference="ground";const p=this._zooming,_=this._rotating,y=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,p&&this.fire(new a.Event("zoomend",i)),_&&this.fire(new a.Event("rotateend",i)),y&&this.fire(new a.Event("pitchend",i)),this.fire(new a.Event("moveend",i))}flyTo(i,l){if(!i.essential&&a.exported.prefersReducedMotion){const Re=a.pick(i,["center","zoom","bearing","pitch","around"]);return this.jumpTo(Re,l)}this.stop(),i=a.extend({offset:[0,0],speed:1.2,curve:1.42,easing:a.ease},i);const p=this.transform,_=this.getZoom(),y=this.getBearing(),b=this.getPitch(),T=this.getPadding(),C="zoom"in i?a.clamp(+i.zoom,p.minZoom,p.maxZoom):_,M="bearing"in i?this._normalizeBearing(i.bearing,y):y,k="pitch"in i?+i.pitch:b,P="padding"in i?i.padding:p.padding,F=p.zoomScale(C-_),j=a.pointGeometry.convert(i.offset);let N=p.centerPoint.add(j);const $=p.pointLocation(N),ee=a.LngLat.convert(i.center||$);this._normalizeCenter(ee);const V=p.project($),Y=p.project(ee).sub(V);let J=i.curve;const H=Math.max(p.width,p.height),K=H/F,te=Y.mag();if("minZoom"in i){const Re=a.clamp(Math.min(i.minZoom,_,C),p.minZoom,p.maxZoom),Ke=H/p.zoomScale(Re-_);J=Math.sqrt(Ke/te*2)}const de=J*J;function _e(Re){const Ke=(K*K-H*H+(Re?-1:1)*de*de*te*te)/(2*(Re?K:H)*de*te);return Math.log(Math.sqrt(Ke*Ke+1)-Ke)}function Be(Re){return(Math.exp(Re)-Math.exp(-Re))/2}function ke(Re){return(Math.exp(Re)+Math.exp(-Re))/2}const Ce=_e(0);let xe=function(Re){return ke(Ce)/ke(Ce+J*Re)},me=function(Re){return H*((ke(Ce)*(Be(Ke=Ce+J*Re)/ke(Ke))-Be(Ce))/de)/te;var Ke},Ae=(_e(1)-Ce)/J;if(Math.abs(te)<1e-6||!isFinite(Ae)){if(Math.abs(H-K)<1e-6)return this.easeTo(i,l);const Re=K<H?-1:1;Ae=Math.abs(Math.log(K/H))/J,me=function(){return 0},xe=function(Ke){return Math.exp(Re*J*Ke)}}i.duration="duration"in i?+i.duration:1e3*Ae/("screenSpeed"in i?+i.screenSpeed/J:+i.speed),i.maxDuration&&i.duration>i.maxDuration&&(i.duration=0);const Ee=y!==M,Xe=k!==b,et=!p.isPaddingEqual(P),ht=Re=>Ke=>{const st=Ke*Ae,Rt=1/xe(st);Re.zoom=Ke===1?C:_+Re.scaleZoom(Rt),Ee&&(Re.bearing=a.number(y,M,Ke)),Xe&&(Re.pitch=a.number(b,k,Ke)),et&&(Re.interpolatePadding(T,P,Ke),N=Re.centerPoint.add(j));const jt=Ke===1?ee:Re.unproject(V.add(Y.mult(me(st))).mult(Rt));return Re.setLocationAtPoint(Re.renderWorldCopies?jt.wrap():jt,N),Re._updateCenterElevation(),i.preloadOnly||this._fireMoveEvents(l),Re};if(i.preloadOnly){const Re=this._emulate(ht,i.duration,p);return this._preloadTiles(Re),this}return this._zooming=!0,this._rotating=Ee,this._pitching=Xe,this._padding=et,this._prepareEase(l,!1),this._ease(ht(p),()=>this._afterEase(l),i),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(i,l){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const p=this._onEaseEnd;delete this._onEaseEnd,p.call(this,l)}if(!i){const p=this.handlers;p&&p.stop(!1)}return this}_ease(i,l,p){p.animate===!1||p.duration===0?(i(1),l()):(this._easeStart=a.exported.now(),this._easeOptions=p,this._onEaseFrame=i,this._onEaseEnd=l,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const i=Math.min((a.exported.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(i)),i<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(i,l){i=a.wrap(i,-180,180);const p=Math.abs(i-l);return Math.abs(i-360-l)<p&&(i-=360),Math.abs(i+360-l)<p&&(i+=360),i}_normalizeCenter(i){const l=this.transform;if(!l.renderWorldCopies||l.maxBounds)return;const p=i.lng-l.center.lng;i.lng+=p>180?-360:p<-180?360:0}_emulate(i,l,p){const _=Math.ceil(15*l/1e3),y=[],b=i(p.clone());for(let T=0;T<=_;T++){const C=b(T/_);y.push(C.clone())}return y}}class xc{constructor(i={}){this.options=i,a.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(i){const l=this.options&&this.options.compact;return this._map=i,this._container=fe.create("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=fe.create("button","mapboxgl-ctrl-attrib-button",this._container),fe.create("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden",!0),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=fe.create("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),l&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),l===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(i,l){const p=this._map._getUIString(`AttributionControl.${l}`);i.setAttribute("aria-label",p),i.removeAttribute("title"),i.firstElementChild&&i.firstElementChild.setAttribute("title",p)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let i=this._editLink;i||(i=this._editLink=this._container.querySelector(".mapbox-improve-map"));const l=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||a.config.ACCESS_TOKEN}];if(i){const p=l.reduce((_,y,b)=>(y.value&&(_+=`${y.key}=${y.value}${b<l.length-1?"&":""}`),_),"?");i.href=`${a.config.FEEDBACK_URL}/${p}${this._map._hash?this._map._hash.getHashString(!0):""}`,i.rel="noopener nofollow",this._setElementTitle(i,"MapFeedback")}}_updateData(i){!i||i.sourceDataType!=="metadata"&&i.sourceDataType!=="visibility"&&i.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let i=[];if(this._map.style.stylesheet){const _=this._map.style.stylesheet;this.styleOwner=_.owner,this.styleId=_.id}const l=this._map.style._sourceCaches;for(const _ in l){const y=l[_];if(y.used){const b=y.getSource();b.attribution&&i.indexOf(b.attribution)<0&&i.push(b.attribution)}}i.sort((_,y)=>_.length-y.length),i=i.filter((_,y)=>{for(let b=y+1;b<i.length;b++)if(i[b].indexOf(_)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?i=[...this.options.customAttribution,...i]:i.unshift(this.options.customAttribution));const p=i.join(" | ");p!==this._attribHTML&&(this._attribHTML=p,i.length?(this._innerContainer.innerHTML=p,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class vc{constructor(){a.bindAll(["_updateLogo"],this),a.bindAll(["_updateCompact"],this)}onAdd(i){this._map=i,this._container=fe.create("div","mapboxgl-ctrl");const l=fe.create("a","mapboxgl-ctrl-logo");return l.target="_blank",l.rel="noopener nofollow",l.href="https://www.mapbox.com/",l.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),l.setAttribute("rel","noopener nofollow"),this._container.appendChild(l),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(i){i&&i.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const i=this._map.style._sourceCaches;if(Object.entries(i).length===0)return!0;for(const l in i){const p=i[l].getSource();if(p.hasOwnProperty("mapbox_logo")&&!p.mapbox_logo)return!1}return!0}_updateCompact(){const i=this._container.children;if(i.length){const l=i[0];this._map.getCanvasContainer().offsetWidth<250?l.classList.add("mapboxgl-compact"):l.classList.remove("mapboxgl-compact")}}}class bc{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(i){const l=++this._id;return this._queue.push({callback:i,id:l,cancelled:!1}),l}remove(i){const l=this._currentlyRunning,p=l?this._queue.concat(l):this._queue;for(const _ of p)if(_.id===i)return void(_.cancelled=!0)}run(i=0){const l=this._currentlyRunning=this._queue;this._queue=[];for(const p of l)if(!p.cancelled&&(p.callback(i),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function wc(d,i,l){if(d=new a.LngLat(d.lng,d.lat),i){const p=new a.LngLat(d.lng-360,d.lat),_=new a.LngLat(d.lng+360,d.lat),y=360*Math.ceil(Math.abs(d.lng-l.center.lng)/360),b=l.locationPoint(d).distSqr(i),T=i.x<0||i.y<0||i.x>l.width||i.y>l.height;l.locationPoint(p).distSqr(i)<b&&(T||Math.abs(p.lng-l.center.lng)<y)?d=p:l.locationPoint(_).distSqr(i)<b&&(T||Math.abs(_.lng-l.center.lng)<y)&&(d=_)}for(;Math.abs(d.lng-l.center.lng)>180;){const p=l.locationPoint(d);if(p.x>=0&&p.y>=0&&p.x<=l.width&&p.y<=l.height)break;d.lng>l.center.lng?d.lng-=360:d.lng+=360}return d}const Si={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Tc extends a.Evented{constructor(i,l){if(super(),(i instanceof a.window.HTMLElement||l)&&(i=a.extend({element:i},l)),a.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=i&&i.anchor||"center",this._color=i&&i.color||"#3FB1CE",this._scale=i&&i.scale||1,this._draggable=i&&i.draggable||!1,this._clickTolerance=i&&i.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=i&&i.rotation||0,this._rotationAlignment=i&&i.rotationAlignment||"auto",this._pitchAlignment=i&&i.pitchAlignment&&i.pitchAlignment!=="auto"?i.pitchAlignment:this._rotationAlignment,this._updateMoving=()=>this._update(!0),i&&i.element)this._element=i.element,this._offset=a.pointGeometry.convert(i&&i.offset||[0,0]);else{this._defaultMarker=!0,this._element=fe.create("div");const _=41,y=27,b=fe.createSVG("svg",{display:"block",height:_*this._scale+"px",width:y*this._scale+"px",viewBox:`0 0 ${y} ${_}`},this._element),T=fe.createSVG("radialGradient",{id:"shadowGradient"},fe.createSVG("defs",{},b));fe.createSVG("stop",{offset:"10%","stop-opacity":.4},T),fe.createSVG("stop",{offset:"100%","stop-opacity":.05},T),fe.createSVG("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},b),fe.createSVG("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},b),fe.createSVG("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},b),fe.createSVG("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},b),this._offset=a.pointGeometry.convert(i&&i.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",_=>{_.preventDefault()}),this._element.addEventListener("mousedown",_=>{_.preventDefault()});const p=this._element.classList;for(const _ in Si)p.remove(`mapboxgl-marker-anchor-${_}`);p.add(`mapboxgl-marker-anchor-${this._anchor}`),this._popup=null}addTo(i){return i===this._map||(this.remove(),this._map=i,i.getCanvasContainer().appendChild(this._element),i.on("move",this._updateMoving),i.on("moveend",this._update),i.on("remove",this._clearFadeTimer),i._addMarker(this),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick)),this}remove(){return this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._updateMoving),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._map.off("remove",this._clearFadeTimer),this._map._removeMarker(this),delete this._map),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(i){return this._lngLat=a.LngLat.convert(i),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(i){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),i){if(!("offset"in i.options)){const _=Math.sqrt(Math.pow(13.5,2)/2);i.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[_,-1*(38.1-13.5+_)],"bottom-right":[-_,-1*(38.1-13.5+_)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=i,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(i){const l=i.code,p=i.charCode||i.keyCode;l!=="Space"&&l!=="Enter"&&p!==32&&p!==13||this.togglePopup()}_onMapClick(i){const l=i.originalEvent.target,p=this._element;this._popup&&(l===p||p.contains(l))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const i=this._popup;return i?(i.isOpen()?(i.remove(),this._element.setAttribute("aria-expanded","false")):(i.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_evaluateOpacity(){const i=this._pos?this._pos.sub(this._transformedOffset()):null;if(!this._withinScreenBounds(i))return void this._clearFadeTimer();const l=this._map.unproject(i);let p=!1;if(this._map.transform._terrainEnabled()&&this._map.getTerrain()){const y=this._map.getFreeCameraOptions();if(y.position){const b=y.position.toLngLat();p=b.distanceTo(l)<.9*b.distanceTo(this._lngLat)}}const _=(1-this._map._queryFogOpacity(l))*(p?.2:1);this._element.style.opacity=`${_}`,this._popup&&this._popup._setOpacity(`${_}`),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_withinScreenBounds(i){const l=this._map.transform;return!!i&&i.x>=0&&i.x<l.width&&i.y>=0&&i.y<l.height}_updateDOM(){const i=this._pos||new a.pointGeometry(0,0),l=this._calculatePitch(),p=this._calculateRotation();this._element.style.transform=`${Si[this._anchor]} translate(${i.x}px, ${i.y}px) rotateX(${l}deg) rotateZ(${p}deg)`}_calculatePitch(){return this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?0:this._pitchAlignment==="map"?this._map.getPitch():0}_calculateRotation(){return this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?this._rotation:this._rotationAlignment==="map"?this._rotation-this._map.getBearing():0}_update(i){a.window.cancelAnimationFrame(this._updateFrameId),this._map&&(this._map.transform.renderWorldCopies&&(this._lngLat=wc(this._lngLat,this._pos,this._map.transform)),this._pos=this._map.project(this._lngLat)._add(this._transformedOffset()),i===!0?this._updateFrameId=a.window.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),this._map._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),!this._map.getTerrain()&&!this._map.getFog()||this._fadeTimer||(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}_transformedOffset(){if(!this._defaultMarker)return this._offset;const i=this._map.transform,l=this._offset.mult(this._scale);return this._rotationAlignment==="map"&&l._rotate(i.angle),this._pitchAlignment==="map"&&(l.y*=Math.cos(i._pitch)),l}getOffset(){return this._offset}setOffset(i){return this._offset=a.pointGeometry.convert(i),this._update(),this}_onMove(i){if(!this._isDragging){const l=this._clickTolerance||this._map._clickTolerance;this._isDragging=i.point.dist(this._pointerdownPos)>=l}this._isDragging&&(this._pos=i.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new a.Event("dragstart"))),this.fire(new a.Event("drag")))}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new a.Event("dragend")),this._state="inactive"}_addDragHandler(i){this._element.contains(i.originalEvent.target)&&(i.preventDefault(),this._positionDelta=i.point.sub(this._pos).add(this._transformedOffset()),this._pointerdownPos=i.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))}setDraggable(i){return this._draggable=!!i,this._map&&(i?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(i){return this._rotation=i||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(i){return this._rotationAlignment=i||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(i){return this._pitchAlignment=i&&i!=="auto"?i:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}}class gn{constructor(i){this.jumpTo(i)}getValue(i){if(i<=this._startTime)return this._start;if(i>=this._endTime)return this._end;const l=a.easeCubicInOut((i-this._startTime)/(this._endTime-this._startTime));return this._start*(1-l)+this._end*l}isEasing(i){return i>=this._startTime&&i<=this._endTime}jumpTo(i){this._startTime=-1/0,this._endTime=-1/0,this._start=i,this._end=i}easeTo(i,l,p){this._start=this.getValue(l),this._end=i,this._startTime=l,this._endTime=l+p}}const pu={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},{HTMLImageElement:jr,HTMLElement:js,ImageBitmap:$s}=a.window,ap={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,crossSourceCollisions:!0};function Ec(d){d.parentNode&&d.parentNode.removeChild(d)}const lp={showCompass:!0,showZoom:!0,visualizePitch:!1};class fu{constructor(i,l,p=!1){this._clickTolerance=10,this.element=l,this.mouseRotate=new Mr({clickTolerance:i.dragRotate._mouseRotate._clickTolerance}),this.map=i,p&&(this.mousePitch=new pc({clickTolerance:i.dragRotate._mousePitch._clickTolerance})),a.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),l.addEventListener("mousedown",this.mousedown),l.addEventListener("touchstart",this.touchstart,{passive:!1}),l.addEventListener("touchmove",this.touchmove),l.addEventListener("touchend",this.touchend),l.addEventListener("touchcancel",this.reset)}down(i,l){this.mouseRotate.mousedown(i,l),this.mousePitch&&this.mousePitch.mousedown(i,l),fe.disableDrag()}move(i,l){const p=this.map,_=this.mouseRotate.mousemoveWindow(i,l);if(_&&_.bearingDelta&&p.setBearing(p.getBearing()+_.bearingDelta),this.mousePitch){const y=this.mousePitch.mousemoveWindow(i,l);y&&y.pitchDelta&&p.setPitch(p.getPitch()+y.pitchDelta)}}off(){const i=this.element;i.removeEventListener("mousedown",this.mousedown),i.removeEventListener("touchstart",this.touchstart,{passive:!1}),i.removeEventListener("touchmove",this.touchmove),i.removeEventListener("touchend",this.touchend),i.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){fe.enableDrag(),a.window.removeEventListener("mousemove",this.mousemove),a.window.removeEventListener("mouseup",this.mouseup)}mousedown(i){this.down(a.extend({},i,{ctrlKey:!0,preventDefault:()=>i.preventDefault()}),fe.mousePos(this.element,i)),a.window.addEventListener("mousemove",this.mousemove),a.window.addEventListener("mouseup",this.mouseup)}mousemove(i){this.move(i,fe.mousePos(this.element,i))}mouseup(i){this.mouseRotate.mouseupWindow(i),this.mousePitch&&this.mousePitch.mouseupWindow(i),this.offTemp()}touchstart(i){i.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=fe.touchPos(this.element,i.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>i.preventDefault()},this._startPos))}touchmove(i){i.targetTouches.length!==1?this.reset():(this._lastPos=fe.touchPos(this.element,i.targetTouches)[0],this.move({preventDefault:()=>i.preventDefault()},this._lastPos))}touchend(i){i.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const $o={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1};let qi,Go=0,Gs=!1;const qo={maxWidth:100,unit:"metric"};function je(d,i,l){const p=l&&l.maxWidth||100,_=d._containerHeight/2,y=d.unproject([0,_]),b=d.unproject([p,_]),T=y.distanceTo(b);if(l&&l.unit==="imperial"){const C=3.2808*T;C>5280?qs(i,p,C/5280,d._getUIString("ScaleControl.Miles"),d):qs(i,p,C,d._getUIString("ScaleControl.Feet"),d)}else l&&l.unit==="nautical"?qs(i,p,T/1852,d._getUIString("ScaleControl.NauticalMiles"),d):T>=1e3?qs(i,p,T/1e3,d._getUIString("ScaleControl.Kilometers"),d):qs(i,p,T,d._getUIString("ScaleControl.Meters"),d)}function qs(d,i,l,p,_){const y=function(T){const C=Math.pow(10,`${Math.floor(T)}`.length-1);let M=T/C;return M=M>=10?10:M>=5?5:M>=3?3:M>=2?2:M>=1?1:function(k){const P=Math.pow(10,Math.ceil(-Math.log(k)/Math.LN10));return Math.round(k*P)/P}(M),C*M}(l),b=y/l;_._requestDomTask(()=>{d.style.width=i*b+"px",d.innerHTML=`${y}&nbsp;${p}`})}const mu={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Zo=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", "),Un={version:a.version,supported:W,setRTLTextPlugin:a.setRTLTextPlugin,getRTLTextPluginStatus:a.getRTLTextPluginStatus,Map:class extends du{constructor(d){if((d=a.extend({},ap,d)).minZoom!=null&&d.maxZoom!=null&&d.minZoom>d.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(d.minPitch!=null&&d.maxPitch!=null&&d.minPitch>d.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(d.minPitch!=null&&d.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(d.maxPitch!=null&&d.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(d.antialias&&a.isSafariWithAntialiasingBug(a.window)&&(d.antialias=!1,a.warnOnce("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Fo(d.minZoom,d.maxZoom,d.minPitch,d.maxPitch,d.renderWorldCopies),d),this._interactive=d.interactive,this._minTileCacheSize=d.minTileCacheSize,this._maxTileCacheSize=d.maxTileCacheSize,this._failIfMajorPerformanceCaveat=d.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=d.preserveDrawingBuffer,this._antialias=d.antialias,this._trackResize=d.trackResize,this._bearingSnap=d.bearingSnap,this._refreshExpiredTiles=d.refreshExpiredTiles,this._fadeDuration=d.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=d.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=d.collectResourceTiming,this._optimizeForTerrain=d.optimizeForTerrain,this._renderTaskQueue=new bc,this._domRenderTaskQueue=new bc,this._controls=[],this._markers=[],this._mapId=a.uniqueId(),this._locale=a.extend({},pu,d.locale),this._clickTolerance=d.clickTolerance,this._cooperativeGestures=d.cooperativeGestures,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevation=new gn(0),this._requestManager=new a.RequestManager(d.transformRequest,d.accessToken,d.testMode),this._silenceAuthErrors=!!d.testMode,typeof d.container=="string"){if(this._container=a.window.document.getElementById(d.container),!this._container)throw new Error(`Container '${d.container}' not found.`)}else{if(!(d.container instanceof js))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=d.container}if(this._container.childNodes.length>0&&a.warnOnce("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),d.maxBounds&&this.setMaxBounds(d.maxBounds),a.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),a.window!==void 0&&(a.window.addEventListener("online",this._onWindowOnline,!1),a.window.addEventListener("resize",this._onWindowResize,!1),a.window.addEventListener("orientationchange",this._onWindowResize,!1),a.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1)),this.handlers=new Vs(this,d),this._localFontFamily=d.localFontFamily,this._localIdeographFontFamily=d.localIdeographFontFamily,d.style&&this.setStyle(d.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),d.projection&&this.setProjection(d.projection),this._hash=d.hash&&new tu(typeof d.hash=="string"&&d.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:d.center,zoom:d.zoom,bearing:d.bearing,pitch:d.pitch}),d.bounds&&(this.resize(),this.fitBounds(d.bounds,a.extend({},d.fitBoundsOptions,{duration:0})))),this.resize(),d.attributionControl&&this.addControl(new xc({customAttribution:d.customAttribution})),this._logoControl=new vc,this.addControl(this._logoControl,d.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",i=>{this._update(i.dataType==="style"),this.fire(new a.Event(`${i.dataType}data`,i))}),this.on("dataloading",i=>{this.fire(new a.Event(`${i.dataType}dataloading`,i))})}_getMapId(){return this._mapId}addControl(d,i){if(i===void 0&&(i=d.getDefaultPosition?d.getDefaultPosition():"top-right"),!d||!d.onAdd)return this.fire(new a.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const l=d.onAdd(this);this._controls.push(d);const p=this._controlPositions[i];return i.indexOf("bottom")!==-1?p.insertBefore(l,p.firstChild):p.appendChild(l),this}removeControl(d){if(!d||!d.onRemove)return this.fire(new a.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const i=this._controls.indexOf(d);return i>-1&&this._controls.splice(i,1),d.onRemove(this),this}hasControl(d){return this._controls.indexOf(d)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(d){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const i=!this._moving;return i&&this.fire(new a.Event("movestart",d)).fire(new a.Event("move",d)),this.fire(new a.Event("resize",d)),i&&this.fire(new a.Event("moveend",d)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(d){return this.transform.setMaxBounds(a.LngLatBounds.convert(d)),this._update()}setMinZoom(d){if((d=d==null?-2:d)>=-2&&d<=this.transform.maxZoom)return this.transform.minZoom=d,this._update(),this.getZoom()<d?this.setZoom(d):this.fire(new a.Event("zoomstart")).fire(new a.Event("zoom")).fire(new a.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(d){if((d=d==null?22:d)>=this.transform.minZoom)return this.transform.maxZoom=d,this._update(),this.getZoom()>d?this.setZoom(d):this.fire(new a.Event("zoomstart")).fire(new a.Event("zoom")).fire(new a.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(d){if((d=d==null?0:d)<0)throw new Error("minPitch must be greater than or equal to 0");if(d>=0&&d<=this.transform.maxPitch)return this.transform.minPitch=d,this._update(),this.getPitch()<d?this.setPitch(d):this.fire(new a.Event("pitchstart")).fire(new a.Event("pitch")).fire(new a.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(d){if((d=d==null?85:d)>85)throw new Error("maxPitch must be less than or equal to 85");if(d>=this.transform.minPitch)return this.transform.maxPitch=d,this._update(),this.getPitch()>d?this.setPitch(d):this.fire(new a.Event("pitchstart")).fire(new a.Event("pitch")).fire(new a.Event("pitchend")),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(d){return this.transform.renderWorldCopies=d,this._update()}getProjection(){return this.transform.getProjection()}setProjection(d){return this._lazyInitEmptyStyle(),typeof d=="string"&&(d={name:d}),this._runtimeProjection=d,this.style.updateProjection(),this._transitionFromGlobe=!1,this}project(d){return this.transform.locationPoint3D(a.LngLat.convert(d))}unproject(d){return this.transform.pointLocation3D(a.pointGeometry.convert(d))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()}_createDelegatedListener(d,i,l){if(d==="mouseenter"||d==="mouseover"){let p=!1;const _=b=>{const T=i.filter(M=>this.getLayer(M)),C=T.length?this.queryRenderedFeatures(b.point,{layers:T}):[];C.length?p||(p=!0,l.call(this,new Bi(d,this,b.originalEvent,{features:C}))):p=!1},y=()=>{p=!1};return{layers:new Set(i),listener:l,delegates:{mousemove:_,mouseout:y}}}if(d==="mouseleave"||d==="mouseout"){let p=!1;const _=b=>{const T=i.filter(C=>this.getLayer(C));(T.length?this.queryRenderedFeatures(b.point,{layers:T}):[]).length?p=!0:p&&(p=!1,l.call(this,new Bi(d,this,b.originalEvent)))},y=b=>{p&&(p=!1,l.call(this,new Bi(d,this,b.originalEvent)))};return{layers:new Set(i),listener:l,delegates:{mousemove:_,mouseout:y}}}{const p=_=>{const y=i.filter(T=>this.getLayer(T)),b=y.length?this.queryRenderedFeatures(_.point,{layers:y}):[];b.length&&(_.features=b,l.call(this,_),delete _.features)};return{layers:new Set(i),listener:l,delegates:{[d]:p}}}}on(d,i,l){if(l===void 0)return super.on(d,i);Array.isArray(i)||(i=[i]);const p=this._createDelegatedListener(d,i,l);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[d]=this._delegatedListeners[d]||[],this._delegatedListeners[d].push(p);for(const _ in p.delegates)this.on(_,p.delegates[_]);return this}once(d,i,l){if(l===void 0)return super.once(d,i);Array.isArray(i)||(i=[i]);const p=this._createDelegatedListener(d,i,l);for(const _ in p.delegates)this.once(_,p.delegates[_]);return this}off(d,i,l){if(l===void 0)return super.off(d,i);i=new Set(Array.isArray(i)?i:[i]);const p=(y,b)=>{if(y.size!==b.size)return!1;for(const T of y)if(!b.has(T))return!1;return!0},_=this._delegatedListeners?this._delegatedListeners[d]:void 0;return _&&(y=>{for(let b=0;b<y.length;b++){const T=y[b];if(T.listener===l&&p(T.layers,i)){for(const C in T.delegates)this.off(C,T.delegates[C]);return y.splice(b,1),this}}})(_),this}queryRenderedFeatures(d,i){return this.style?(i!==void 0||d===void 0||d instanceof a.pointGeometry||Array.isArray(d)||(i=d,d=void 0),this.style.queryRenderedFeatures(d=d||[[0,0],[this.transform.width,this.transform.height]],i=i||{},this.transform)):[]}querySourceFeatures(d,i){return this.style.querySourceFeatures(d,i)}queryTerrainElevation(d,i){const l=this.transform.elevation;return l?(i=a.extend({},{exaggerated:!0},i),l.getAtPoint(a.MercatorCoordinate.fromLngLat(d),null,i.exaggerated)):null}setStyle(d,i){return(i=a.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},i)).diff!==!1&&i.localIdeographFontFamily===this._localIdeographFontFamily&&i.localFontFamily===this._localFontFamily&&this.style&&d?(this._diffStyle(d,i),this):(this._localIdeographFontFamily=i.localIdeographFontFamily,this._localFontFamily=i.localFontFamily,this._updateStyle(d,i))}_getUIString(d){const i=this._locale[d];if(i==null)throw new Error(`Missing UI string '${d}'`);return i}_updateStyle(d,i){return this.style&&(this.style.setEventedParent(null),this.style._remove(),delete this.style),d&&(this.style=new ir(this,i||{}),this.style.setEventedParent(this,{style:this.style}),typeof d=="string"?this.style.loadURL(d):this.style.loadJSON(d)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new ir(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(d,i){if(typeof d=="string"){const l=this._requestManager.normalizeStyleURL(d),p=this._requestManager.transformRequest(l,a.ResourceType.Style);a.getJSON(p,(_,y)=>{_?this.fire(new a.ErrorEvent(_)):y&&this._updateDiff(y,i)})}else typeof d=="object"&&this._updateDiff(d,i)}_updateDiff(d,i){try{this.style.setState(d)&&this._update(!0)}catch(l){a.warnOnce(`Unable to perform style diff: ${l.message||l.error||l}.  Rebuilding the style from scratch.`),this._updateStyle(d,i)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():a.warnOnce("There is no style added to the map.")}addSource(d,i){return this._lazyInitEmptyStyle(),this.style.addSource(d,i),this._update(!0)}isSourceLoaded(d){const i=this.style&&this.style._getSourceCaches(d);if(i.length!==0)return i.every(l=>l.loaded());this.fire(new a.ErrorEvent(new Error(`There is no source with ID '${d}'`)))}areTilesLoaded(){const d=this.style&&this.style._sourceCaches;for(const i in d){const l=d[i]._tiles;for(const p in l){const _=l[p];if(_.state!=="loaded"&&_.state!=="errored")return!1}}return!0}addSourceType(d,i,l){return this._lazyInitEmptyStyle(),this.style.addSourceType(d,i,l)}removeSource(d){return this.style.removeSource(d),this._updateTerrain(),this._update(!0)}getSource(d){return this.style.getSource(d)}addImage(d,i,{pixelRatio:l=1,sdf:p=!1,stretchX:_,stretchY:y,content:b}={}){if(this._lazyInitEmptyStyle(),i instanceof jr||$s&&i instanceof $s){const{width:T,height:C,data:M}=a.exported.getImageData(i);this.style.addImage(d,{data:new a.RGBAImage({width:T,height:C},M),pixelRatio:l,stretchX:_,stretchY:y,content:b,sdf:p,version:0})}else{if(i.width===void 0||i.height===void 0)return this.fire(new a.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:T,height:C,data:M}=i,k=i;this.style.addImage(d,{data:new a.RGBAImage({width:T,height:C},new Uint8Array(M)),pixelRatio:l,stretchX:_,stretchY:y,content:b,sdf:p,version:0,userImage:k}),k.onAdd&&k.onAdd(this,d)}}}updateImage(d,i){const l=this.style.getImage(d);if(!l)return this.fire(new a.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const p=i instanceof jr||$s&&i instanceof $s?a.exported.getImageData(i):i,{width:_,height:y,data:b}=p;return _===void 0||y===void 0?this.fire(new a.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`"))):_!==l.data.width||y!==l.data.height?this.fire(new a.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image"))):(l.data.replace(b,!(i instanceof jr||$s&&i instanceof $s)),void this.style.updateImage(d,l))}hasImage(d){return d?!!this.style.getImage(d):(this.fire(new a.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(d){this.style.removeImage(d)}loadImage(d,i){a.getImage(this._requestManager.transformRequest(d,a.ResourceType.Image),(l,p)=>{i(l,p instanceof jr?a.exported.getImageData(p):p)})}listImages(){return this.style.listImages()}addLayer(d,i){return this._lazyInitEmptyStyle(),this.style.addLayer(d,i),this._update(!0)}moveLayer(d,i){return this.style.moveLayer(d,i),this._update(!0)}removeLayer(d){return this.style.removeLayer(d),this._update(!0)}getLayer(d){return this.style.getLayer(d)}setLayerZoomRange(d,i,l){return this.style.setLayerZoomRange(d,i,l),this._update(!0)}setFilter(d,i,l={}){return this.style.setFilter(d,i,l),this._update(!0)}getFilter(d){return this.style.getFilter(d)}setPaintProperty(d,i,l,p={}){return this.style.setPaintProperty(d,i,l,p),this._update(!0)}getPaintProperty(d,i){return this.style.getPaintProperty(d,i)}setLayoutProperty(d,i,l,p={}){return this.style.setLayoutProperty(d,i,l,p),this._update(!0)}getLayoutProperty(d,i){return this.style.getLayoutProperty(d,i)}setLight(d,i={}){return this._lazyInitEmptyStyle(),this.style.setLight(d,i),this._update(!0)}getLight(){return this.style.getLight()}setTerrain(d){return this._lazyInitEmptyStyle(),!d&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(d),this._averageElevationLastSampledAt=-1/0,this._update(!0)}_updateProjection(){this.transform.projection.name==="globe"&&this.transform.zoom>=a.GLOBE_ZOOM_THRESHOLD_MAX&&!this._transitionFromGlobe&&(this.setProjection({name:"mercator"}),this._transitionFromGlobe=!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(d){return this._lazyInitEmptyStyle(),this.style.setFog(d),this._update(!0)}getFog(){return this.style?this.style.getFog():null}_queryFogOpacity(d){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(a.LngLat.convert(d),this.transform):0}setFeatureState(d,i){return this.style.setFeatureState(d,i),this._update()}removeFeatureState(d,i){return this.style.removeFeatureState(d,i),this._update()}getFeatureState(d){return this.style.getFeatureState(d)}_updateContainerDimensions(){if(!this._container)return;const d=this._container.getBoundingClientRect().width||400,i=this._container.getBoundingClientRect().height||300;let l,p=this._container;for(;p&&!l;){const _=a.window.getComputedStyle(p).transform;_&&_!=="none"&&(l=_.match(/matrix.*\((.+)\)/)[1].split(", ")),p=p.parentElement}l?(this._containerWidth=l[0]&&l[0]!=="0"?Math.abs(d/l[0]):d,this._containerHeight=l[3]&&l[3]!=="0"?Math.abs(i/l[3]):i):(this._containerWidth=d,this._containerHeight=i)}_detectMissingCSS(){a.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&a.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const d=this._container;d.classList.add("mapboxgl-map"),(this._missingCSSCanary=fe.create("div","mapboxgl-canary",d)).style.visibility="hidden",this._detectMissingCSS();const i=this._canvasContainer=fe.create("div","mapboxgl-canvas-container",d);this._interactive&&i.classList.add("mapboxgl-interactive"),this._canvas=fe.create("canvas","mapboxgl-canvas",i),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const l=this._controlContainer=fe.create("div","mapboxgl-control-container",d),p=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(_=>{p[_]=fe.create("div",`mapboxgl-ctrl-${_}`,l)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(d,i){const l=a.exported.devicePixelRatio||1;this._canvas.width=l*Math.ceil(d),this._canvas.height=l*Math.ceil(i),this._canvas.style.width=`${d}px`,this._canvas.style.height=`${i}px`}_addMarker(d){this._markers.push(d)}_removeMarker(d){const i=this._markers.indexOf(d);i!==-1&&this._markers.splice(i,1)}_setupPainter(){const d=a.extend({},W.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),i=this._canvas.getContext("webgl",d)||this._canvas.getContext("experimental-webgl",d);i?(a.storeAuthState(i,!0),this.painter=new Yh(i,this.transform),this.on("data",l=>{l.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),a.exported$1.testSupport(i)):this.fire(new a.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(d){d.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new a.Event("webglcontextlost",{originalEvent:d}))}_contextRestored(d){this._setupPainter(),this.resize(),this._update(),this.fire(new a.Event("webglcontextrestored",{originalEvent:d}))}_onMapScroll(d){if(d.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(d){return this.style?(this._styleDirty=this._styleDirty||d,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(d){return this._update(),this._renderTaskQueue.add(d)}_cancelRenderFrame(d){this._renderTaskQueue.remove(d)}_requestDomTask(d){!this.loaded()||this.loaded()&&!this.isMoving()?d():this._domRenderTaskQueue.add(d)}_render(d){let i;const l=this.painter.context.extTimerQuery,p=a.exported.now();this.listens("gpu-timing-frame")&&(i=l.createQueryEXT(),l.beginQueryEXT(l.TIME_ELAPSED_EXT,i));let _=this._updateAverageElevation(p);if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(d),this._domRenderTaskQueue.run(d),this._removed)return;this._updateProjection();let y=!1;const b=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const C=this.transform.zoom,M=this.transform.pitch,k=a.exported.now();this.style.zoomHistory.update(C,k);const P=new a.EvaluationParameters(C,{now:k,fadeDuration:b,pitch:M,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),F=P.crossFadingFactor();F===1&&F===this._crossFadingFactor||(y=!0,this._crossFadingFactor=F),this.style.update(P)}if(this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0),this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),this.style._updateSources(this.transform),this._forceMarkerUpdate()),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,b,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:b,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),speedIndexTiming:this.speedIndexTiming}),this.fire(new a.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new a.Event("load"))),this.style&&(this.style.hasTransitions()||y)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),this.listens("gpu-timing-frame")){const C=a.exported.now()-p;l.endQueryEXT(l.TIME_ELAPSED_EXT,i),setTimeout(()=>{const M=l.getQueryObjectEXT(i,l.QUERY_RESULT_EXT)/1e6;l.deleteQueryEXT(i),this.fire(new a.Event("gpu-timing-frame",{cpuTime:C,gpuTime:M}))},50)}if(this.listens("gpu-timing-layer")){const C=this.painter.collectGpuTimers();setTimeout(()=>{const M=this.painter.queryGpuTimers(C);this.fire(new a.Event("gpu-timing-layer",{layerTimes:M}))},50)}const T=this._sourcesDirty||this._styleDirty||this._placementDirty||_;if(T||this._repaint)this.triggerRepaint();else{const C=!this.isMoving()&&this.loaded();if(C&&(_=this._updateAverageElevation(p,!0)),_)this.triggerRepaint();else if(this._triggerFrame(!1),C&&(this.fire(new a.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const M=this._calculateSpeedIndex();this.fire(new a.Event("speedindexcompleted",{speedIndex:M})),this.speedIndexTiming=!1}}return!this._loaded||this._fullyLoaded||T||(this._fullyLoaded=!0,this._authenticate()),this}_forceMarkerUpdate(){for(const d of this._markers)d._update()}_updateAverageElevation(d,i=!1){const l=p=>(this.transform.averageElevation=p,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&l(0);if((i||d-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(d)){const p=this.transform.averageElevation;let _=this.transform.sampleAverageElevation();isNaN(_)?_=0:this._averageElevationLastSampledAt=d;const y=Math.abs(p-_);if(y>1){if(this._isInitialLoad)return this._averageElevation.jumpTo(_),l(_);this._averageElevation.easeTo(_,d,300)}else if(y>1e-4)return this._averageElevation.jumpTo(_),l(_)}return!!this._averageElevation.isEasing(d)&&l(this._averageElevation.getValue(d))}_authenticate(){a.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,d=>{if(d&&(d.message===a.AUTH_ERR_MSG||d.status===401)){const i=this.painter.context.gl;a.storeAuthState(i,!1),this._logoControl instanceof vc&&this._logoControl._updateLogo(),i&&i.clear(i.DEPTH_BUFFER_BIT|i.COLOR_BUFFER_BIT|i.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new a.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),a.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){this.painter.updateTerrain(this.style,this.isMoving()||this.isRotating()||this.isZooming())}_calculateSpeedIndex(){const d=this.painter.canvasCopy(),i=this.painter.getCanvasCopiesAndTimestamps();i.timeStamps.push(performance.now());const l=this.painter.context.gl,p=l.createFramebuffer();function _(y){l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,y,0);const b=new Uint8Array(l.drawingBufferWidth*l.drawingBufferHeight*4);return l.readPixels(0,0,l.drawingBufferWidth,l.drawingBufferHeight,l.RGBA,l.UNSIGNED_BYTE,b),b}return l.bindFramebuffer(l.FRAMEBUFFER,p),this._canvasPixelComparison(_(d),i.canvasCopies.map(_),i.timeStamps)}_canvasPixelComparison(d,i,l){let p=l[1]-l[0];const _=d.length/4;for(let y=0;y<i.length;y++){const b=i[y];let T=0;for(let C=0;C<b.length;C+=4)b[C]===d[C]&&b[C+1]===d[C+1]&&b[C+2]===d[C+2]&&b[C+3]===d[C+3]&&(T+=1);p+=(l[y+2]-l[y+1])*(1-T/_)}return p}remove(){this._hash&&this._hash.remove();for(const i of this._controls)i.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),a.window!==void 0&&(a.window.removeEventListener("resize",this._onWindowResize,!1),a.window.removeEventListener("orientationchange",this._onWindowResize,!1),a.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),a.window.removeEventListener("online",this._onWindowOnline,!1));const d=this.painter.context.gl.getExtension("WEBGL_lose_context");d&&d.loseContext(),Ec(this._canvasContainer),Ec(this._controlContainer),Ec(this._missingCSSCanary),this._container.classList.remove("mapboxgl-map"),a.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new a.Event("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(d){this._renderNextFrame=this._renderNextFrame||d,this.style&&!this._frame&&(this._frame=a.exported.frame(i=>{const l=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,l&&this._render(i)}))}_preloadTiles(d){const i=this.style&&Object.values(this.style._sourceCaches)||[];return a.asyncAll(i,(l,p)=>l._preloadTiles(d,p),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(d){this._trackResize&&this.resize({originalEvent:d})._update()}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(d){this._showTileBoundaries!==d&&(this._showTileBoundaries=d,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(d){this._showTerrainWireframe!==d&&(this._showTerrainWireframe=d,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(d){this._speedIndexTiming!==d&&(this._speedIndexTiming=d,this._update())}get showPadding(){return!!this._showPadding}set showPadding(d){this._showPadding!==d&&(this._showPadding=d,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(d){this._showCollisionBoxes!==d&&(this._showCollisionBoxes=d,d?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(d){this._showOverdrawInspector!==d&&(this._showOverdrawInspector=d,this._update())}get repaint(){return!!this._repaint}set repaint(d){this._repaint!==d&&(this._repaint=d,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(d){this._vertices=d,this._update()}_setCacheLimits(d,i){a.setCacheLimits(d,i)}get version(){return a.version}},NavigationControl:class{constructor(d){this.options=a.extend({},lp,d),this._container=fe.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",i=>i.preventDefault()),this.options.showZoom&&(a.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",i=>this._map.zoomIn({},{originalEvent:i})),fe.create("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden",!0),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",i=>this._map.zoomOut({},{originalEvent:i})),fe.create("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden",!0)),this.options.showCompass&&(a.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",i=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:i}):this._map.resetNorth({},{originalEvent:i})}),this._compassIcon=fe.create("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden",!0))}_updateZoomButtons(){const d=this._map.getZoom(),i=d===this._map.getMaxZoom(),l=d===this._map.getMinZoom();this._zoomInButton.disabled=i,this._zoomOutButton.disabled=l,this._zoomInButton.setAttribute("aria-disabled",i.toString()),this._zoomOutButton.setAttribute("aria-disabled",l.toString())}_rotateCompassArrow(){const d=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._map._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=d)})}onAdd(d){return this._map=d,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new fu(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){this._container.remove(),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(d,i){const l=fe.create("button",d,this._container);return l.type="button",l.addEventListener("click",i),l}_setButtonTitle(d,i){const l=this._map._getUIString(`NavigationControl.${i}`);d.setAttribute("aria-label",l),d.firstElementChild&&d.firstElementChild.setAttribute("title",l)}},GeolocateControl:class extends a.Evented{constructor(d){super(),this.options=a.extend({},$o,d),a.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation"],this),this._onDeviceOrientationListener=this._onDeviceOrientation.bind(this),this._updateMarkerRotationThrottled=Nn(this._updateMarkerRotation,20)}onAdd(d){var i;return this._map=d,this._container=fe.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),i=this._setupUI,qi!==void 0?i(qi):a.window.navigator.permissions!==void 0?a.window.navigator.permissions.query({name:"geolocation"}).then(l=>{qi=l.state!=="denied",i(qi)}):(qi=!!a.window.navigator.geolocation,i(qi)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(a.window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,Go=0,Gs=!1}_isOutOfMapMaxBounds(d){const i=this._map.getMaxBounds(),l=d.coords;return i&&(l.longitude<i.getWest()||l.longitude>i.getEast()||l.latitude<i.getSouth()||l.latitude>i.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(d){if(this._map){if(this._isOutOfMapMaxBounds(d))return this._setErrorState(),this.fire(new a.Event("outofmaxbounds",d)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=d,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(d),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(d),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new a.Event("geolocate",d)),this._finish()}}_updateCamera(d){const i=new a.LngLat(d.coords.longitude,d.coords.latitude),l=d.coords.accuracy,p=this._map.getBearing(),_=a.extend({bearing:p},this.options.fitBoundsOptions);this._map.fitBounds(i.toBounds(l),_,{geolocateSource:!0})}_updateMarker(d){if(d){const i=new a.LngLat(d.coords.longitude,d.coords.latitude);this._accuracyCircleMarker.setLngLat(i).addTo(this._map),this._userLocationDotMarker.setLngLat(i).addTo(this._map),this._accuracy=d.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const d=this._map._containerHeight/2,i=this._map.unproject([0,d]),l=this._map.unproject([100,d]),p=i.distanceTo(l)/100,_=Math.ceil(2*this._accuracy/p);this._circleElement.style.width=`${_}px`,this._circleElement.style.height=`${_}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(d){if(this._map){if(this.options.trackUserLocation)if(d.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const i=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",i),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",i),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(d.code===3&&Gs)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new a.Event("error",d)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(d){if(this._container.addEventListener("contextmenu",i=>i.preventDefault()),this._geolocateButton=fe.create("button","mapboxgl-ctrl-geolocate",this._container),fe.create("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden",!0),this._geolocateButton.type="button",d===!1){a.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const i=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",i),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",i)}else{const i=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",i),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",i)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=fe.create("div","mapboxgl-user-location"),this._dotElement.appendChild(fe.create("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(fe.create("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Tc({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=fe.create("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Tc({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",i=>{i.geolocateSource||this._watchState!=="ACTIVE_LOCK"||i.originalEvent&&i.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new a.Event("trackuserlocationend")))})}_onDeviceOrientation(d){this._userLocationDotMarker&&(d.webkitCompassHeading?this._heading=d.webkitCompassHeading:d.absolute===!0&&(this._heading=-1*d.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return a.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new a.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Go--,Gs=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new a.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new a.Event("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let d;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Go++,Go>1?(d={maximumAge:6e5,timeout:0},Gs=!0):(d=this.options.positionOptions,Gs=!1),this._geolocationWatchID=a.window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,d),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else a.window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const d=()=>{a.window.addEventListener("ondeviceorientationabsolute"in a.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientationListener)};a.window.DeviceMotionEvent!==void 0&&typeof a.window.DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"&&d()}).catch(console.error):d()}_clearWatch(){a.window.navigator.geolocation.clearWatch(this._geolocationWatchID),a.window.removeEventListener("deviceorientation",this._onDeviceOrientationListener),a.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientationListener),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:xc,ScaleControl:class{constructor(d){this.options=a.extend({},qo,d),a.bindAll(["_onMove","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_onMove(){je(this._map,this._container,this.options)}onAdd(d){return this._map=d,this._container=fe.create("div","mapboxgl-ctrl mapboxgl-ctrl-scale",d.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._onMove),this._map=void 0}setUnit(d){this.options.unit=d,je(this._map,this._container,this.options)}},FullscreenControl:class{constructor(d){this._fullscreen=!1,d&&d.container&&(d.container instanceof a.window.HTMLElement?this._container=d.container:a.warnOnce("Full screen control 'container' must be a DOM element.")),a.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in a.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in a.window.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(d){return this._map=d,this._container||(this._container=this._map.getContainer()),this._controlContainer=fe.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",a.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,a.window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!a.window.document.fullscreenEnabled&&!a.window.document.webkitFullscreenEnabled)}_setupUI(){const d=this._fullscreenButton=fe.create("button","mapboxgl-ctrl-fullscreen",this._controlContainer);fe.create("span","mapboxgl-ctrl-icon",d).setAttribute("aria-hidden",!0),d.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),a.window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const d=this._getTitle();this._fullscreenButton.setAttribute("aria-label",d),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",d)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(a.window.document.fullscreenElement||a.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?a.window.document.exitFullscreen?a.window.document.exitFullscreen():a.window.document.webkitCancelFullScreen&&a.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends a.Evented{constructor(d){super(),this.options=a.extend(Object.create(mu),d),a.bindAll(["_update","_onClose","remove","_onMouseMove","_onMouseUp","_onDrag"],this),this._classList=new Set(d&&d.className?d.className.trim().split(/\s+/):[])}addTo(d){return this._map&&this.remove(),this._map=d,this.options.closeOnClick&&this._map.on("preclick",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._map._canvasContainer.classList.add("mapboxgl-track-pointer")):this._map.on("move",this._update),this.fire(new a.Event("open")),this}isOpen(){return!!this._map}remove(){return this._content&&this._content.remove(),this._container&&(this._container.remove(),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),delete this._map),this.fire(new a.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(d){return this._lngLat=a.LngLat.convert(d),this._pos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._map._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._map._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(d){return this.setDOMContent(a.window.document.createTextNode(d))}setHTML(d){const i=a.window.document.createDocumentFragment(),l=a.window.document.createElement("body");let p;for(l.innerHTML=d;p=l.firstChild,p;)i.appendChild(p);return this.setDOMContent(i)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(d){return this.options.maxWidth=d,this._update(),this}setDOMContent(d){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=fe.create("div","mapboxgl-popup-content",this._container);return this._content.appendChild(d),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(d){return this._classList.add(d),this._container&&this._updateClassList(),this}removeClassName(d){return this._classList.delete(d),this._container&&this._updateClassList(),this}setOffset(d){return this.options.offset=d,this._update(),this}toggleClassName(d){let i;return this._classList.delete(d)?i=!1:(this._classList.add(d),i=!0),this._container&&this._updateClassList(),i}_createCloseButton(){this.options.closeButton&&(this._closeButton=fe.create("button","mapboxgl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.setAttribute("aria-hidden","true"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_onMouseUp(d){this._update(d.point)}_onMouseMove(d){this._update(d.point)}_onDrag(d){this._update(d.point)}_getAnchor(d){if(this.options.anchor)return this.options.anchor;const i=this._pos,l=this._container.offsetWidth,p=this._container.offsetHeight;let _;return _=i.y+d.bottom.y<p?["top"]:i.y>this._map.transform.height-p?["bottom"]:[],i.x<l/2?_.push("left"):i.x>this._map.transform.width-l/2&&_.push("right"),_.length===0?"bottom":_.join("-")}_updateClassList(){const d=[...this._classList];d.push("mapboxgl-popup"),this._anchor&&d.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&d.push("mapboxgl-popup-track-pointer"),this._container.className=d.join(" ")}_update(d){if(this._map&&(this._lngLat||this._trackPointer)&&this._content){if(this._container||(this._container=fe.create("div","mapboxgl-popup",this._map.getContainer()),this._tip=fe.create("div","mapboxgl-popup-tip",this._container),this._container.appendChild(this._content)),this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._map.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=wc(this._lngLat,this._pos,this._map.transform)),!this._trackPointer||d){const i=this._pos=this._trackPointer&&d?d:this._map.project(this._lngLat),l=function(y){if(y||(y=new a.pointGeometry(0,0)),typeof y=="number"){const b=Math.round(Math.sqrt(.5*Math.pow(y,2)));return{center:new a.pointGeometry(0,0),top:new a.pointGeometry(0,y),"top-left":new a.pointGeometry(b,b),"top-right":new a.pointGeometry(-b,b),bottom:new a.pointGeometry(0,-y),"bottom-left":new a.pointGeometry(b,-b),"bottom-right":new a.pointGeometry(-b,-b),left:new a.pointGeometry(y,0),right:new a.pointGeometry(-y,0)}}if(y instanceof a.pointGeometry||Array.isArray(y)){const b=a.pointGeometry.convert(y);return{center:b,top:b,"top-left":b,"top-right":b,bottom:b,"bottom-left":b,"bottom-right":b,left:b,right:b}}return{center:a.pointGeometry.convert(y.center||[0,0]),top:a.pointGeometry.convert(y.top||[0,0]),"top-left":a.pointGeometry.convert(y["top-left"]||[0,0]),"top-right":a.pointGeometry.convert(y["top-right"]||[0,0]),bottom:a.pointGeometry.convert(y.bottom||[0,0]),"bottom-left":a.pointGeometry.convert(y["bottom-left"]||[0,0]),"bottom-right":a.pointGeometry.convert(y["bottom-right"]||[0,0]),left:a.pointGeometry.convert(y.left||[0,0]),right:a.pointGeometry.convert(y.right||[0,0])}}(this.options.offset),p=this._anchor=this._getAnchor(l),_=i.add(l[p]).round();this._map._requestDomTask(()=>{this._container&&p&&(this._container.style.transform=`${Si[p]} translate(${_.x}px,${_.y}px)`)})}this._updateClassList()}}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const d=this._container.querySelector(Zo);d&&d.focus()}_onClose(){this.remove()}_setOpacity(d){this._content&&(this._content.style.opacity=d),this._tip&&(this._tip.style.opacity=d)}},Marker:Tc,Style:ir,LngLat:a.LngLat,LngLatBounds:a.LngLatBounds,Point:a.pointGeometry,MercatorCoordinate:a.MercatorCoordinate,FreeCameraOptions:Qh,Evented:a.Evented,config:a.config,prewarm:function(){se().acquire(re)},clearPrewarmedResources:function(){const d=he;d&&(d.isPreloaded()&&d.numActive()===1?(d.release(re),he=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return a.config.ACCESS_TOKEN},set accessToken(d){a.config.ACCESS_TOKEN=d},get baseApiUrl(){return a.config.API_URL},set baseApiUrl(d){a.config.API_URL=d},get workerCount(){return ce.workerCount},set workerCount(d){ce.workerCount=d},get maxParallelImageRequests(){return a.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(d){a.config.MAX_PARALLEL_IMAGE_REQUESTS=d},clearStorage(d){a.clearTileCache(d)},workerUrl:"",workerClass:null,setNow:a.exported.setNow,restoreNow:a.exported.restoreNow};return Un});var L=v;return L})})(bx);var VI=bx.exports;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Tx=function(o){const n=[];let c=0;for(let m=0;m<o.length;m++){let v=o.charCodeAt(m);v<128?n[c++]=v:v<2048?(n[c++]=v>>6|192,n[c++]=v&63|128):(v&64512)===55296&&m+1<o.length&&(o.charCodeAt(m+1)&64512)===56320?(v=65536+((v&1023)<<10)+(o.charCodeAt(++m)&1023),n[c++]=v>>18|240,n[c++]=v>>12&63|128,n[c++]=v>>6&63|128,n[c++]=v&63|128):(n[c++]=v>>12|224,n[c++]=v>>6&63|128,n[c++]=v&63|128)}return n},ow=function(o){const n=[];let c=0,m=0;for(;c<o.length;){const v=o[c++];if(v<128)n[m++]=String.fromCharCode(v);else if(v>191&&v<224){const S=o[c++];n[m++]=String.fromCharCode((v&31)<<6|S&63)}else if(v>239&&v<365){const S=o[c++],L=o[c++],a=o[c++],W=((v&7)<<18|(S&63)<<12|(L&63)<<6|a&63)-65536;n[m++]=String.fromCharCode(55296+(W>>10)),n[m++]=String.fromCharCode(56320+(W&1023))}else{const S=o[c++],L=o[c++];n[m++]=String.fromCharCode((v&15)<<12|(S&63)<<6|L&63)}}return n.join("")},aw={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(o,n){if(!Array.isArray(o))throw Error("encodeByteArray takes an array as a parameter");this.init_();const c=n?this.byteToCharMapWebSafe_:this.byteToCharMap_,m=[];for(let v=0;v<o.length;v+=3){const S=o[v],L=v+1<o.length,a=L?o[v+1]:0,W=v+2<o.length,ie=W?o[v+2]:0,ge=S>>2,ue=(S&3)<<4|a>>4;let ze=(a&15)<<2|ie>>6,fe=ie&63;W||(fe=64,L||(ze=64)),m.push(c[ge],c[ue],c[ze],c[fe])}return m.join("")},encodeString(o,n){return this.HAS_NATIVE_SUPPORT&&!n?btoa(o):this.encodeByteArray(Tx(o),n)},decodeString(o,n){return this.HAS_NATIVE_SUPPORT&&!n?atob(o):ow(this.decodeStringToByteArray(o,n))},decodeStringToByteArray(o,n){this.init_();const c=n?this.charToByteMapWebSafe_:this.charToByteMap_,m=[];for(let v=0;v<o.length;){const S=c[o.charAt(v++)],a=v<o.length?c[o.charAt(v)]:0;++v;const ie=v<o.length?c[o.charAt(v)]:64;++v;const ue=v<o.length?c[o.charAt(v)]:64;if(++v,S==null||a==null||ie==null||ue==null)throw Error();const ze=S<<2|a>>4;if(m.push(ze),ie!==64){const fe=a<<4&240|ie>>2;if(m.push(fe),ue!==64){const it=ie<<6&192|ue;m.push(it)}}}return m},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let o=0;o<this.ENCODED_VALS.length;o++)this.byteToCharMap_[o]=this.ENCODED_VALS.charAt(o),this.charToByteMap_[this.byteToCharMap_[o]]=o,this.byteToCharMapWebSafe_[o]=this.ENCODED_VALS_WEBSAFE.charAt(o),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[o]]=o,o>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(o)]=o,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(o)]=o)}}},lw=function(o){const n=Tx(o);return aw.encodeByteArray(n,!0)},Ex=function(o){return lw(o).replace(/\./g,"")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cw{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((n,c)=>{this.resolve=n,this.reject=c})}wrapCallback(n){return(c,m)=>{c?this.reject(c):this.resolve(m),typeof n=="function"&&(this.promise.catch(()=>{}),n.length===1?n(c):n(c,m))}}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Cd(){return typeof navigator!="undefined"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function hw(){return typeof window!="undefined"&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(Cd())}function uw(){const o=typeof chrome=="object"?chrome.runtime:typeof browser=="object"?browser.runtime:void 0;return typeof o=="object"&&o.id!==void 0}function dw(){return typeof navigator=="object"&&navigator.product==="ReactNative"}function pw(){return Cd().indexOf("Electron/")>=0}function fw(){const o=Cd();return o.indexOf("MSIE ")>=0||o.indexOf("Trident/")>=0}function mw(){return Cd().indexOf("MSAppHost/")>=0}function _w(){return typeof indexedDB=="object"}function gw(){return new Promise((o,n)=>{try{let c=!0;const m="validate-browser-context-for-indexeddb-analytics-module",v=self.indexedDB.open(m);v.onsuccess=()=>{v.result.close(),c||self.indexedDB.deleteDatabase(m),o(!0)},v.onupgradeneeded=()=>{c=!1},v.onerror=()=>{var S;n(((S=v.error)===null||S===void 0?void 0:S.message)||"")}}catch(c){n(c)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const yw="FirebaseError";class Md extends Error{constructor(n,c,m){super(c);this.code=n,this.customData=m,this.name=yw,Object.setPrototypeOf(this,Md.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Sx.prototype.create)}}class Sx{constructor(n,c,m){this.service=n,this.serviceName=c,this.errors=m}create(n,...c){const m=c[0]||{},v=`${this.service}/${n}`,S=this.errors[n],L=S?xw(S,m):"Error",a=`${this.serviceName}: ${L} (${v}).`;return new Md(v,a,m)}}function xw(o,n){return o.replace(vw,(c,m)=>{const v=n[m];return v!=null?String(v):`<${m}?>`})}const vw=/\{\$([^}]+)}/g;function Of(o,n){if(o===n)return!0;const c=Object.keys(o),m=Object.keys(n);for(const v of c){if(!m.includes(v))return!1;const S=o[v],L=n[v];if(py(S)&&py(L)){if(!Of(S,L))return!1}else if(S!==L)return!1}for(const v of m)if(!c.includes(v))return!1;return!0}function py(o){return o!==null&&typeof o=="object"}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ix(o){return o&&o._delegate?o._delegate:o}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Hc(o,n){return new Promise((c,m)=>{o.onsuccess=v=>{c(v.target.result)},o.onerror=v=>{var S;m(`${n}: ${(S=v.target.error)===null||S===void 0?void 0:S.message}`)}})}class fy{constructor(n){this._db=n,this.objectStoreNames=this._db.objectStoreNames}transaction(n,c){return new Ax(this._db.transaction.call(this._db,n,c))}createObjectStore(n,c){return new Cx(this._db.createObjectStore(n,c))}close(){this._db.close()}}class Ax{constructor(n){this._transaction=n,this.complete=new Promise((c,m)=>{this._transaction.oncomplete=function(){c()},this._transaction.onerror=()=>{m(this._transaction.error)},this._transaction.onabort=()=>{m(this._transaction.error)}})}objectStore(n){return new Cx(this._transaction.objectStore(n))}}class Cx{constructor(n){this._store=n}index(n){return new my(this._store.index(n))}createIndex(n,c,m){return new my(this._store.createIndex(n,c,m))}get(n){const c=this._store.get(n);return Hc(c,"Error reading from IndexedDB")}put(n,c){const m=this._store.put(n,c);return Hc(m,"Error writing to IndexedDB")}delete(n){const c=this._store.delete(n);return Hc(c,"Error deleting from IndexedDB")}clear(){const n=this._store.clear();return Hc(n,"Error clearing IndexedDB object store")}}class my{constructor(n){this._index=n}get(n){const c=this._index.get(n);return Hc(c,"Error reading from IndexedDB")}}function bw(o,n,c){return new Promise((m,v)=>{try{const S=indexedDB.open(o,n);S.onsuccess=L=>{m(new fy(L.target.result))},S.onerror=L=>{var a;v(`Error opening indexedDB: ${(a=L.target.error)===null||a===void 0?void 0:a.message}`)},S.onupgradeneeded=L=>{c(new fy(S.result),L.oldVersion,L.newVersion,new Ax(S.transaction))}}catch(S){v(`Error opening indexedDB: ${S.message}`)}})}class nh{constructor(n,c,m){this.name=n,this.instanceFactory=c,this.type=m,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(n){return this.instantiationMode=n,this}setMultipleInstances(n){return this.multipleInstances=n,this}setServiceProps(n){return this.serviceProps=n,this}setInstanceCreatedCallback(n){return this.onInstanceCreated=n,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ia="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ww{constructor(n,c){this.name=n,this.container=c,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(n){const c=this.normalizeInstanceIdentifier(n);if(!this.instancesDeferred.has(c)){const m=new cw;if(this.instancesDeferred.set(c,m),this.isInitialized(c)||this.shouldAutoInitialize())try{const v=this.getOrInitializeService({instanceIdentifier:c});v&&m.resolve(v)}catch{}}return this.instancesDeferred.get(c).promise}getImmediate(n){var c;const m=this.normalizeInstanceIdentifier(n==null?void 0:n.identifier),v=(c=n==null?void 0:n.optional)!==null&&c!==void 0?c:!1;if(this.isInitialized(m)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:m})}catch(S){if(v)return null;throw S}else{if(v)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(n){if(n.name!==this.name)throw Error(`Mismatching Component ${n.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=n,!!this.shouldAutoInitialize()){if(Ew(n))try{this.getOrInitializeService({instanceIdentifier:ia})}catch{}for(const[c,m]of this.instancesDeferred.entries()){const v=this.normalizeInstanceIdentifier(c);try{const S=this.getOrInitializeService({instanceIdentifier:v});m.resolve(S)}catch{}}}}clearInstance(n=ia){this.instancesDeferred.delete(n),this.instancesOptions.delete(n),this.instances.delete(n)}async delete(){const n=Array.from(this.instances.values());await Promise.all([...n.filter(c=>"INTERNAL"in c).map(c=>c.INTERNAL.delete()),...n.filter(c=>"_delete"in c).map(c=>c._delete())])}isComponentSet(){return this.component!=null}isInitialized(n=ia){return this.instances.has(n)}getOptions(n=ia){return this.instancesOptions.get(n)||{}}initialize(n={}){const{options:c={}}=n,m=this.normalizeInstanceIdentifier(n.instanceIdentifier);if(this.isInitialized(m))throw Error(`${this.name}(${m}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const v=this.getOrInitializeService({instanceIdentifier:m,options:c});for(const[S,L]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(S);m===a&&L.resolve(v)}return v}onInit(n,c){var m;const v=this.normalizeInstanceIdentifier(c),S=(m=this.onInitCallbacks.get(v))!==null&&m!==void 0?m:new Set;S.add(n),this.onInitCallbacks.set(v,S);const L=this.instances.get(v);return L&&n(L,v),()=>{S.delete(n)}}invokeOnInitCallbacks(n,c){const m=this.onInitCallbacks.get(c);if(!!m)for(const v of m)try{v(n,c)}catch{}}getOrInitializeService({instanceIdentifier:n,options:c={}}){let m=this.instances.get(n);if(!m&&this.component&&(m=this.component.instanceFactory(this.container,{instanceIdentifier:Tw(n),options:c}),this.instances.set(n,m),this.instancesOptions.set(n,c),this.invokeOnInitCallbacks(m,n),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,n,m)}catch{}return m||null}normalizeInstanceIdentifier(n=ia){return this.component?this.component.multipleInstances?n:ia:n}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function Tw(o){return o===ia?void 0:o}function Ew(o){return o.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sw{constructor(n){this.name=n,this.providers=new Map}addComponent(n){const c=this.getProvider(n.name);if(c.isComponentSet())throw new Error(`Component ${n.name} has already been registered with ${this.name}`);c.setComponent(n)}addOrOverwriteComponent(n){this.getProvider(n.name).isComponentSet()&&this.providers.delete(n.name),this.addComponent(n)}getProvider(n){if(this.providers.has(n))return this.providers.get(n);const c=new ww(n,this);return this.providers.set(n,c),c}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Zt;(function(o){o[o.DEBUG=0]="DEBUG",o[o.VERBOSE=1]="VERBOSE",o[o.INFO=2]="INFO",o[o.WARN=3]="WARN",o[o.ERROR=4]="ERROR",o[o.SILENT=5]="SILENT"})(Zt||(Zt={}));const Iw={debug:Zt.DEBUG,verbose:Zt.VERBOSE,info:Zt.INFO,warn:Zt.WARN,error:Zt.ERROR,silent:Zt.SILENT},Aw=Zt.INFO,Cw={[Zt.DEBUG]:"log",[Zt.VERBOSE]:"log",[Zt.INFO]:"info",[Zt.WARN]:"warn",[Zt.ERROR]:"error"},Mw=(o,n,...c)=>{if(n<o.logLevel)return;const m=new Date().toISOString(),v=Cw[n];if(v)console[v](`[${m}]  ${o.name}:`,...c);else throw new Error(`Attempted to log a message with an invalid logType (value: ${n})`)};class Mx{constructor(n){this.name=n,this._logLevel=Aw,this._logHandler=Mw,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(n){if(!(n in Zt))throw new TypeError(`Invalid value "${n}" assigned to \`logLevel\``);this._logLevel=n}setLogLevel(n){this._logLevel=typeof n=="string"?Iw[n]:n}get logHandler(){return this._logHandler}set logHandler(n){if(typeof n!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=n}get userLogHandler(){return this._userLogHandler}set userLogHandler(n){this._userLogHandler=n}debug(...n){this._userLogHandler&&this._userLogHandler(this,Zt.DEBUG,...n),this._logHandler(this,Zt.DEBUG,...n)}log(...n){this._userLogHandler&&this._userLogHandler(this,Zt.VERBOSE,...n),this._logHandler(this,Zt.VERBOSE,...n)}info(...n){this._userLogHandler&&this._userLogHandler(this,Zt.INFO,...n),this._logHandler(this,Zt.INFO,...n)}warn(...n){this._userLogHandler&&this._userLogHandler(this,Zt.WARN,...n),this._logHandler(this,Zt.WARN,...n)}error(...n){this._userLogHandler&&this._userLogHandler(this,Zt.ERROR,...n),this._logHandler(this,Zt.ERROR,...n)}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kw{constructor(n){this.container=n}getPlatformInfoString(){return this.container.getProviders().map(c=>{if(Dw(c)){const m=c.getImmediate();return`${m.library}/${m.version}`}else return null}).filter(c=>c).join(" ")}}function Dw(o){const n=o.getComponent();return(n==null?void 0:n.type)==="VERSION"}const Nf="@firebase/app",_y="0.7.20";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fm=new Mx("@firebase/app"),zw="@firebase/app-compat",Pw="@firebase/analytics-compat",Lw="@firebase/analytics",Rw="@firebase/app-check-compat",Bw="@firebase/app-check",Fw="@firebase/auth",Ow="@firebase/auth-compat",Nw="@firebase/database",Uw="@firebase/database-compat",Vw="@firebase/functions",jw="@firebase/functions-compat",$w="@firebase/installations",Gw="@firebase/installations-compat",qw="@firebase/messaging",Zw="@firebase/messaging-compat",Ww="@firebase/performance",Xw="@firebase/performance-compat",Hw="@firebase/remote-config",Kw="@firebase/remote-config-compat",Yw="@firebase/storage",Jw="@firebase/storage-compat",Qw="@firebase/firestore",eT="@firebase/firestore-compat",tT="firebase",iT="9.6.10";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const kx="[DEFAULT]",rT={[Nf]:"fire-core",[zw]:"fire-core-compat",[Lw]:"fire-analytics",[Pw]:"fire-analytics-compat",[Bw]:"fire-app-check",[Rw]:"fire-app-check-compat",[Fw]:"fire-auth",[Ow]:"fire-auth-compat",[Nw]:"fire-rtdb",[Uw]:"fire-rtdb-compat",[Vw]:"fire-fn",[jw]:"fire-fn-compat",[$w]:"fire-iid",[Gw]:"fire-iid-compat",[qw]:"fire-fcm",[Zw]:"fire-fcm-compat",[Ww]:"fire-perf",[Xw]:"fire-perf-compat",[Hw]:"fire-rc",[Kw]:"fire-rc-compat",[Yw]:"fire-gcs",[Jw]:"fire-gcs-compat",[Qw]:"fire-fst",[eT]:"fire-fst-compat","fire-js":"fire-js",[tT]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const dd=new Map,Uf=new Map;function nT(o,n){try{o.container.addComponent(n)}catch(c){fm.debug(`Component ${n.name} failed to register with FirebaseApp ${o.name}`,c)}}function pd(o){const n=o.name;if(Uf.has(n))return fm.debug(`There were multiple attempts to register component ${n}.`),!1;Uf.set(n,o);for(const c of dd.values())nT(c,o);return!0}function sT(o,n){const c=o.container.getProvider("heartbeat").getImmediate({optional:!0});return c&&c.triggerHeartbeat(),o.container.getProvider(n)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const oT={["no-app"]:"No Firebase App '{$appName}' has been created - call Firebase App.initializeApp()",["bad-app-name"]:"Illegal App name: '{$appName}",["duplicate-app"]:"Firebase App named '{$appName}' already exists with different options or config",["app-deleted"]:"Firebase App named '{$appName}' already deleted",["invalid-app-argument"]:"firebase.{$appName}() takes either no argument or a Firebase App instance.",["invalid-log-argument"]:"First argument to `onLog` must be null or a function.",["storage-open"]:"Error thrown when opening storage. Original error: {$originalErrorMessage}.",["storage-get"]:"Error thrown when reading from storage. Original error: {$originalErrorMessage}.",["storage-set"]:"Error thrown when writing to storage. Original error: {$originalErrorMessage}.",["storage-delete"]:"Error thrown when deleting from storage. Original error: {$originalErrorMessage}."},la=new Sx("app","Firebase",oT);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class aT{constructor(n,c,m){this._isDeleted=!1,this._options=Object.assign({},n),this._config=Object.assign({},c),this._name=c.name,this._automaticDataCollectionEnabled=c.automaticDataCollectionEnabled,this._container=m,this.container.addComponent(new nh("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(n){this.checkDestroyed(),this._automaticDataCollectionEnabled=n}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(n){this._isDeleted=n}checkDestroyed(){if(this.isDeleted)throw la.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const lT=iT;function jI(o,n={}){typeof n!="object"&&(n={name:n});const c=Object.assign({name:kx,automaticDataCollectionEnabled:!1},n),m=c.name;if(typeof m!="string"||!m)throw la.create("bad-app-name",{appName:String(m)});const v=dd.get(m);if(v){if(Of(o,v.options)&&Of(c,v.config))return v;throw la.create("duplicate-app",{appName:m})}const S=new Sw(m);for(const a of Uf.values())S.addComponent(a);const L=new aT(o,c,S);return dd.set(m,L),L}function cT(o=kx){const n=dd.get(o);if(!n)throw la.create("no-app",{appName:o});return n}function Ml(o,n,c){var m;let v=(m=rT[o])!==null&&m!==void 0?m:o;c&&(v+=`-${c}`);const S=v.match(/\s|\//),L=n.match(/\s|\//);if(S||L){const a=[`Unable to register library "${v}" with version "${n}":`];S&&a.push(`library name "${v}" contains illegal characters (whitespace or "/")`),S&&L&&a.push("and"),L&&a.push(`version name "${n}" contains illegal characters (whitespace or "/")`),fm.warn(a.join(" "));return}pd(new nh(`${v}-version`,()=>({library:v,version:n}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hT="firebase-heartbeat-database",uT=1,sh="firebase-heartbeat-store";let bf=null;function Dx(){return bf||(bf=bw(hT,uT,(o,n)=>{switch(n){case 0:o.createObjectStore(sh)}}).catch(o=>{throw la.create("storage-open",{originalErrorMessage:o.message})})),bf}async function dT(o){try{return(await Dx()).transaction(sh).objectStore(sh).get(zx(o))}catch(n){throw la.create("storage-get",{originalErrorMessage:n.message})}}async function gy(o,n){try{const m=(await Dx()).transaction(sh,"readwrite");return await m.objectStore(sh).put(n,zx(o)),m.complete}catch(c){throw la.create("storage-set",{originalErrorMessage:c.message})}}function zx(o){return`${o.name}!${o.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pT=1024,fT=30*24*60*60*1e3;class mT{constructor(n){this.container=n,this._heartbeatsCache=null;const c=this.container.getProvider("app").getImmediate();this._storage=new gT(c),this._heartbeatsCachePromise=this._storage.read().then(m=>(this._heartbeatsCache=m,m))}async triggerHeartbeat(){const c=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),m=yy();if(this._heartbeatsCache===null&&(this._heartbeatsCache=await this._heartbeatsCachePromise),!(this._heartbeatsCache.lastSentHeartbeatDate===m||this._heartbeatsCache.heartbeats.some(v=>v.date===m)))return this._heartbeatsCache.heartbeats.push({date:m,agent:c}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter(v=>{const S=new Date(v.date).valueOf();return Date.now()-S<=fT}),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache===null||this._heartbeatsCache.heartbeats.length===0)return"";const n=yy(),{heartbeatsToSend:c,unsentEntries:m}=_T(this._heartbeatsCache.heartbeats),v=Ex(JSON.stringify({version:2,heartbeats:c}));return this._heartbeatsCache.lastSentHeartbeatDate=n,m.length>0?(this._heartbeatsCache.heartbeats=m,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),v}}function yy(){return new Date().toISOString().substring(0,10)}function _T(o,n=pT){const c=[];let m=o.slice();for(const v of o){const S=c.find(L=>L.agent===v.agent);if(S){if(S.dates.push(v.date),xy(c)>n){S.dates.pop();break}}else if(c.push({agent:v.agent,dates:[v.date]}),xy(c)>n){c.pop();break}m=m.slice(1)}return{heartbeatsToSend:c,unsentEntries:m}}class gT{constructor(n){this.app=n,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return _w()?gw().then(()=>!0).catch(()=>!1):!1}async read(){return await this._canUseIndexedDBPromise?await dT(this.app)||{heartbeats:[]}:{heartbeats:[]}}async overwrite(n){var c;if(await this._canUseIndexedDBPromise){const v=await this.read();return gy(this.app,{lastSentHeartbeatDate:(c=n.lastSentHeartbeatDate)!==null&&c!==void 0?c:v.lastSentHeartbeatDate,heartbeats:n.heartbeats})}else return}async add(n){var c;if(await this._canUseIndexedDBPromise){const v=await this.read();return gy(this.app,{lastSentHeartbeatDate:(c=n.lastSentHeartbeatDate)!==null&&c!==void 0?c:v.lastSentHeartbeatDate,heartbeats:[...v.heartbeats,...n.heartbeats]})}else return}}function xy(o){return Ex(JSON.stringify({version:2,heartbeats:o})).length}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function yT(o){pd(new nh("platform-logger",n=>new kw(n),"PRIVATE")),pd(new nh("heartbeat",n=>new mT(n),"PRIVATE")),Ml(Nf,_y,o),Ml(Nf,_y,"esm2017"),Ml("fire-js","")}yT("");var xT="firebase",vT="9.6.10";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ml(xT,vT,"app");var bT=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},He,mm=mm||{},ut=bT||self;function fd(){}function Vf(o){var n=typeof o;return n=n!="object"?n:o?Array.isArray(o)?"array":n:"null",n=="array"||n=="object"&&typeof o.length=="number"}function yh(o){var n=typeof o;return n=="object"&&o!=null||n=="function"}function wT(o){return Object.prototype.hasOwnProperty.call(o,wf)&&o[wf]||(o[wf]=++TT)}var wf="closure_uid_"+(1e9*Math.random()>>>0),TT=0;function ET(o,n,c){return o.call.apply(o.bind,arguments)}function ST(o,n,c){if(!o)throw Error();if(2<arguments.length){var m=Array.prototype.slice.call(arguments,2);return function(){var v=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(v,m),o.apply(n,v)}}return function(){return o.apply(n,arguments)}}function Ki(o,n,c){return Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?Ki=ET:Ki=ST,Ki.apply(null,arguments)}function id(o,n){var c=Array.prototype.slice.call(arguments,1);return function(){var m=c.slice();return m.push.apply(m,arguments),o.apply(this,m)}}function tr(o,n){function c(){}c.prototype=n.prototype,o.Z=n.prototype,o.prototype=new c,o.prototype.constructor=o,o.Vb=function(m,v,S){for(var L=Array(arguments.length-2),a=2;a<arguments.length;a++)L[a-2]=arguments[a];return n.prototype[v].apply(m,L)}}function oo(){this.s=this.s,this.o=this.o}var IT=0,AT={};oo.prototype.s=!1;oo.prototype.na=function(){if(!this.s&&(this.s=!0,this.M(),IT!=0)){var o=wT(this);delete AT[o]}};oo.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const Px=Array.prototype.indexOf?function(o,n){return Array.prototype.indexOf.call(o,n,void 0)}:function(o,n){if(typeof o=="string")return typeof n!="string"||n.length!=1?-1:o.indexOf(n,0);for(let c=0;c<o.length;c++)if(c in o&&o[c]===n)return c;return-1},Lx=Array.prototype.forEach?function(o,n,c){Array.prototype.forEach.call(o,n,c)}:function(o,n,c){const m=o.length,v=typeof o=="string"?o.split(""):o;for(let S=0;S<m;S++)S in v&&n.call(c,v[S],S,o)};function CT(o){e:{var n=xE;const c=o.length,m=typeof o=="string"?o.split(""):o;for(let v=0;v<c;v++)if(v in m&&n.call(void 0,m[v],v,o)){n=v;break e}n=-1}return 0>n?null:typeof o=="string"?o.charAt(n):o[n]}function vy(o){return Array.prototype.concat.apply([],arguments)}function _m(o){const n=o.length;if(0<n){const c=Array(n);for(let m=0;m<n;m++)c[m]=o[m];return c}return[]}function md(o){return/^[\s\xa0]*$/.test(o)}var by=String.prototype.trim?function(o){return o.trim()}:function(o){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(o)[1]};function yr(o,n){return o.indexOf(n)!=-1}function Tf(o,n){return o<n?-1:o>n?1:0}var xr;e:{var wy=ut.navigator;if(wy){var Ty=wy.userAgent;if(Ty){xr=Ty;break e}}xr=""}function gm(o,n,c){for(const m in o)n.call(c,o[m],m,o)}function Rx(o){const n={};for(const c in o)n[c]=o[c];return n}var Ey="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Bx(o,n){let c,m;for(let v=1;v<arguments.length;v++){m=arguments[v];for(c in m)o[c]=m[c];for(let S=0;S<Ey.length;S++)c=Ey[S],Object.prototype.hasOwnProperty.call(m,c)&&(o[c]=m[c])}}function ym(o){return ym[" "](o),o}ym[" "]=fd;function MT(o){var n=zT;return Object.prototype.hasOwnProperty.call(n,9)?n[9]:n[9]=o(9)}var kT=yr(xr,"Opera"),zl=yr(xr,"Trident")||yr(xr,"MSIE"),Fx=yr(xr,"Edge"),jf=Fx||zl,Ox=yr(xr,"Gecko")&&!(yr(xr.toLowerCase(),"webkit")&&!yr(xr,"Edge"))&&!(yr(xr,"Trident")||yr(xr,"MSIE"))&&!yr(xr,"Edge"),DT=yr(xr.toLowerCase(),"webkit")&&!yr(xr,"Edge");function Nx(){var o=ut.document;return o?o.documentMode:void 0}var _d;e:{var Ef="",Sf=function(){var o=xr;if(Ox)return/rv:([^\);]+)(\)|;)/.exec(o);if(Fx)return/Edge\/([\d\.]+)/.exec(o);if(zl)return/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(o);if(DT)return/WebKit\/(\S+)/.exec(o);if(kT)return/(?:Version)[ \/]?(\S+)/.exec(o)}();if(Sf&&(Ef=Sf?Sf[1]:""),zl){var If=Nx();if(If!=null&&If>parseFloat(Ef)){_d=String(If);break e}}_d=Ef}var zT={};function PT(){return MT(function(){let o=0;const n=by(String(_d)).split("."),c=by("9").split("."),m=Math.max(n.length,c.length);for(let L=0;o==0&&L<m;L++){var v=n[L]||"",S=c[L]||"";do{if(v=/(\d*)(\D*)(.*)/.exec(v)||["","","",""],S=/(\d*)(\D*)(.*)/.exec(S)||["","","",""],v[0].length==0&&S[0].length==0)break;o=Tf(v[1].length==0?0:parseInt(v[1],10),S[1].length==0?0:parseInt(S[1],10))||Tf(v[2].length==0,S[2].length==0)||Tf(v[2],S[2]),v=v[3],S=S[3]}while(o==0)}return 0<=o})}var $f;if(ut.document&&zl){var Sy=Nx();$f=Sy||parseInt(_d,10)||void 0}else $f=void 0;var LT=$f,RT=function(){if(!ut.addEventListener||!Object.defineProperty)return!1;var o=!1,n=Object.defineProperty({},"passive",{get:function(){o=!0}});try{ut.addEventListener("test",fd,n),ut.removeEventListener("test",fd,n)}catch{}return o}();function cr(o,n){this.type=o,this.g=this.target=n,this.defaultPrevented=!1}cr.prototype.h=function(){this.defaultPrevented=!0};function oh(o,n){if(cr.call(this,o?o.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,o){var c=this.type=o.type,m=o.changedTouches&&o.changedTouches.length?o.changedTouches[0]:null;if(this.target=o.target||o.srcElement,this.g=n,n=o.relatedTarget){if(Ox){e:{try{ym(n.nodeName);var v=!0;break e}catch{}v=!1}v||(n=null)}}else c=="mouseover"?n=o.fromElement:c=="mouseout"&&(n=o.toElement);this.relatedTarget=n,m?(this.clientX=m.clientX!==void 0?m.clientX:m.pageX,this.clientY=m.clientY!==void 0?m.clientY:m.pageY,this.screenX=m.screenX||0,this.screenY=m.screenY||0):(this.clientX=o.clientX!==void 0?o.clientX:o.pageX,this.clientY=o.clientY!==void 0?o.clientY:o.pageY,this.screenX=o.screenX||0,this.screenY=o.screenY||0),this.button=o.button,this.key=o.key||"",this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.shiftKey=o.shiftKey,this.metaKey=o.metaKey,this.pointerId=o.pointerId||0,this.pointerType=typeof o.pointerType=="string"?o.pointerType:BT[o.pointerType]||"",this.state=o.state,this.i=o,o.defaultPrevented&&oh.Z.h.call(this)}}tr(oh,cr);var BT={2:"touch",3:"pen",4:"mouse"};oh.prototype.h=function(){oh.Z.h.call(this);var o=this.i;o.preventDefault?o.preventDefault():o.returnValue=!1};var xh="closure_listenable_"+(1e6*Math.random()|0),FT=0;function OT(o,n,c,m,v){this.listener=o,this.proxy=null,this.src=n,this.type=c,this.capture=!!m,this.ia=v,this.key=++FT,this.ca=this.fa=!1}function kd(o){o.ca=!0,o.listener=null,o.proxy=null,o.src=null,o.ia=null}function Dd(o){this.src=o,this.g={},this.h=0}Dd.prototype.add=function(o,n,c,m,v){var S=o.toString();o=this.g[S],o||(o=this.g[S]=[],this.h++);var L=qf(o,n,m,v);return-1<L?(n=o[L],c||(n.fa=!1)):(n=new OT(n,this.src,S,!!m,v),n.fa=c,o.push(n)),n};function Gf(o,n){var c=n.type;if(c in o.g){var m=o.g[c],v=Px(m,n),S;(S=0<=v)&&Array.prototype.splice.call(m,v,1),S&&(kd(n),o.g[c].length==0&&(delete o.g[c],o.h--))}}function qf(o,n,c,m){for(var v=0;v<o.length;++v){var S=o[v];if(!S.ca&&S.listener==n&&S.capture==!!c&&S.ia==m)return v}return-1}var xm="closure_lm_"+(1e6*Math.random()|0),Af={};function Ux(o,n,c,m,v){if(m&&m.once)return jx(o,n,c,m,v);if(Array.isArray(n)){for(var S=0;S<n.length;S++)Ux(o,n[S],c,m,v);return null}return c=wm(c),o&&o[xh]?o.N(n,c,yh(m)?!!m.capture:!!m,v):Vx(o,n,c,!1,m,v)}function Vx(o,n,c,m,v,S){if(!n)throw Error("Invalid event type");var L=yh(v)?!!v.capture:!!v,a=bm(o);if(a||(o[xm]=a=new Dd(o)),c=a.add(n,c,m,L,S),c.proxy)return c;if(m=NT(),c.proxy=m,m.src=o,m.listener=c,o.addEventListener)RT||(v=L),v===void 0&&(v=!1),o.addEventListener(n.toString(),m,v);else if(o.attachEvent)o.attachEvent(Gx(n.toString()),m);else if(o.addListener&&o.removeListener)o.addListener(m);else throw Error("addEventListener and attachEvent are unavailable.");return c}function NT(){function o(c){return n.call(o.src,o.listener,c)}var n=UT;return o}function jx(o,n,c,m,v){if(Array.isArray(n)){for(var S=0;S<n.length;S++)jx(o,n[S],c,m,v);return null}return c=wm(c),o&&o[xh]?o.O(n,c,yh(m)?!!m.capture:!!m,v):Vx(o,n,c,!0,m,v)}function $x(o,n,c,m,v){if(Array.isArray(n))for(var S=0;S<n.length;S++)$x(o,n[S],c,m,v);else m=yh(m)?!!m.capture:!!m,c=wm(c),o&&o[xh]?(o=o.i,n=String(n).toString(),n in o.g&&(S=o.g[n],c=qf(S,c,m,v),-1<c&&(kd(S[c]),Array.prototype.splice.call(S,c,1),S.length==0&&(delete o.g[n],o.h--)))):o&&(o=bm(o))&&(n=o.g[n.toString()],o=-1,n&&(o=qf(n,c,m,v)),(c=-1<o?n[o]:null)&&vm(c))}function vm(o){if(typeof o!="number"&&o&&!o.ca){var n=o.src;if(n&&n[xh])Gf(n.i,o);else{var c=o.type,m=o.proxy;n.removeEventListener?n.removeEventListener(c,m,o.capture):n.detachEvent?n.detachEvent(Gx(c),m):n.addListener&&n.removeListener&&n.removeListener(m),(c=bm(n))?(Gf(c,o),c.h==0&&(c.src=null,n[xm]=null)):kd(o)}}}function Gx(o){return o in Af?Af[o]:Af[o]="on"+o}function UT(o,n){if(o.ca)o=!0;else{n=new oh(n,this);var c=o.listener,m=o.ia||o.src;o.fa&&vm(o),o=c.call(m,n)}return o}function bm(o){return o=o[xm],o instanceof Dd?o:null}var Cf="__closure_events_fn_"+(1e9*Math.random()>>>0);function wm(o){return typeof o=="function"?o:(o[Cf]||(o[Cf]=function(n){return o.handleEvent(n)}),o[Cf])}function ji(){oo.call(this),this.i=new Dd(this),this.P=this,this.I=null}tr(ji,oo);ji.prototype[xh]=!0;ji.prototype.removeEventListener=function(o,n,c,m){$x(this,o,n,c,m)};function Yi(o,n){var c,m=o.I;if(m)for(c=[];m;m=m.I)c.push(m);if(o=o.P,m=n.type||n,typeof n=="string")n=new cr(n,o);else if(n instanceof cr)n.target=n.target||o;else{var v=n;n=new cr(m,o),Bx(n,v)}if(v=!0,c)for(var S=c.length-1;0<=S;S--){var L=n.g=c[S];v=rd(L,m,!0,n)&&v}if(L=n.g=o,v=rd(L,m,!0,n)&&v,v=rd(L,m,!1,n)&&v,c)for(S=0;S<c.length;S++)L=n.g=c[S],v=rd(L,m,!1,n)&&v}ji.prototype.M=function(){if(ji.Z.M.call(this),this.i){var o=this.i,n;for(n in o.g){for(var c=o.g[n],m=0;m<c.length;m++)kd(c[m]);delete o.g[n],o.h--}}this.I=null};ji.prototype.N=function(o,n,c,m){return this.i.add(String(o),n,!1,c,m)};ji.prototype.O=function(o,n,c,m){return this.i.add(String(o),n,!0,c,m)};function rd(o,n,c,m){if(n=o.i.g[String(n)],!n)return!0;n=n.concat();for(var v=!0,S=0;S<n.length;++S){var L=n[S];if(L&&!L.ca&&L.capture==c){var a=L.listener,W=L.ia||L.src;L.fa&&Gf(o.i,L),v=a.call(W,m)!==!1&&v}}return v&&!m.defaultPrevented}var Tm=ut.JSON.stringify;function VT(){var o=Zx;let n=null;return o.g&&(n=o.g,o.g=o.g.next,o.g||(o.h=null),n.next=null),n}class jT{constructor(){this.h=this.g=null}add(n,c){const m=qx.get();m.set(n,c),this.h?this.h.next=m:this.g=m,this.h=m}}var qx=new class{constructor(o,n){this.i=o,this.j=n,this.h=0,this.g=null}get(){let o;return 0<this.h?(this.h--,o=this.g,this.g=o.next,o.next=null):o=this.i(),o}}(()=>new $T,o=>o.reset());class $T{constructor(){this.next=this.g=this.h=null}set(n,c){this.h=n,this.g=c,this.next=null}reset(){this.next=this.g=this.h=null}}function GT(o){ut.setTimeout(()=>{throw o},0)}function Em(o,n){Zf||qT(),Wf||(Zf(),Wf=!0),Zx.add(o,n)}var Zf;function qT(){var o=ut.Promise.resolve(void 0);Zf=function(){o.then(ZT)}}var Wf=!1,Zx=new jT;function ZT(){for(var o;o=VT();){try{o.h.call(o.g)}catch(c){GT(c)}var n=qx;n.j(o),100>n.h&&(n.h++,o.next=n.g,n.g=o)}Wf=!1}function zd(o,n){ji.call(this),this.h=o||1,this.g=n||ut,this.j=Ki(this.kb,this),this.l=Date.now()}tr(zd,ji);He=zd.prototype;He.da=!1;He.S=null;He.kb=function(){if(this.da){var o=Date.now()-this.l;0<o&&o<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-o):(this.S&&(this.g.clearTimeout(this.S),this.S=null),Yi(this,"tick"),this.da&&(Sm(this),this.start()))}};He.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())};function Sm(o){o.da=!1,o.S&&(o.g.clearTimeout(o.S),o.S=null)}He.M=function(){zd.Z.M.call(this),Sm(this),delete this.g};function Im(o,n,c){if(typeof o=="function")c&&(o=Ki(o,c));else if(o&&typeof o.handleEvent=="function")o=Ki(o.handleEvent,o);else throw Error("Invalid listener argument");return 2147483647<Number(n)?-1:ut.setTimeout(o,n||0)}function Wx(o){o.g=Im(()=>{o.g=null,o.i&&(o.i=!1,Wx(o))},o.j);const n=o.h;o.h=null,o.m.apply(null,n)}class WT extends oo{constructor(n,c){super();this.m=n,this.j=c,this.h=null,this.i=!1,this.g=null}l(n){this.h=arguments,this.g?this.i=!0:Wx(this)}M(){super.M(),this.g&&(ut.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ah(o){oo.call(this),this.h=o,this.g={}}tr(ah,oo);var Iy=[];function Xx(o,n,c,m){Array.isArray(c)||(c&&(Iy[0]=c.toString()),c=Iy);for(var v=0;v<c.length;v++){var S=Ux(n,c[v],m||o.handleEvent,!1,o.h||o);if(!S)break;o.g[S.key]=S}}function Hx(o){gm(o.g,function(n,c){this.g.hasOwnProperty(c)&&vm(n)},o),o.g={}}ah.prototype.M=function(){ah.Z.M.call(this),Hx(this)};ah.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};function Pd(){this.g=!0}Pd.prototype.Aa=function(){this.g=!1};function XT(o,n,c,m,v,S){o.info(function(){if(o.g)if(S)for(var L="",a=S.split("&"),W=0;W<a.length;W++){var ie=a[W].split("=");if(1<ie.length){var ge=ie[0];ie=ie[1];var ue=ge.split("_");L=2<=ue.length&&ue[1]=="type"?L+(ge+"="+ie+"&"):L+(ge+"=redacted&")}}else L=null;else L=S;return"XMLHTTP REQ ("+m+") [attempt "+v+"]: "+n+`
`+c+`
`+L})}function HT(o,n,c,m,v,S,L){o.info(function(){return"XMLHTTP RESP ("+m+") [ attempt "+v+"]: "+n+`
`+c+`
`+S+" "+L})}function Al(o,n,c,m){o.info(function(){return"XMLHTTP TEXT ("+n+"): "+YT(o,c)+(m?" "+m:"")})}function KT(o,n){o.info(function(){return"TIMEOUT: "+n})}Pd.prototype.info=function(){};function YT(o,n){if(!o.g)return n;if(!n)return null;try{var c=JSON.parse(n);if(c){for(o=0;o<c.length;o++)if(Array.isArray(c[o])){var m=c[o];if(!(2>m.length)){var v=m[1];if(Array.isArray(v)&&!(1>v.length)){var S=v[0];if(S!="noop"&&S!="stop"&&S!="close")for(var L=1;L<v.length;L++)v[L]=""}}}}return Tm(c)}catch{return n}}var ma={},Ay=null;function Ld(){return Ay=Ay||new ji}ma.Ma="serverreachability";function Kx(o){cr.call(this,ma.Ma,o)}tr(Kx,cr);function lh(o){const n=Ld();Yi(n,new Kx(n,o))}ma.STAT_EVENT="statevent";function Yx(o,n){cr.call(this,ma.STAT_EVENT,o),this.stat=n}tr(Yx,cr);function vr(o){const n=Ld();Yi(n,new Yx(n,o))}ma.Na="timingevent";function Jx(o,n){cr.call(this,ma.Na,o),this.size=n}tr(Jx,cr);function vh(o,n){if(typeof o!="function")throw Error("Fn must not be null and must be a function");return ut.setTimeout(function(){o()},n)}var Rd={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},Qx={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function Am(){}Am.prototype.h=null;function Cy(o){return o.h||(o.h=o.i())}function ev(){}var bh={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function Cm(){cr.call(this,"d")}tr(Cm,cr);function Mm(){cr.call(this,"c")}tr(Mm,cr);var Xf;function Bd(){}tr(Bd,Am);Bd.prototype.g=function(){return new XMLHttpRequest};Bd.prototype.i=function(){return{}};Xf=new Bd;function wh(o,n,c,m){this.l=o,this.j=n,this.m=c,this.X=m||1,this.V=new ah(this),this.P=JT,o=jf?125:void 0,this.W=new zd(o),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new tv}function tv(){this.i=null,this.g="",this.h=!1}var JT=45e3,Hf={},gd={};He=wh.prototype;He.setTimeout=function(o){this.P=o};function Kf(o,n,c){o.K=1,o.v=Od(_s(n)),o.s=c,o.U=!0,iv(o,null)}function iv(o,n){o.F=Date.now(),Th(o),o.A=_s(o.v);var c=o.A,m=o.X;Array.isArray(m)||(m=[String(m)]),cv(c.h,"t",m),o.C=0,c=o.l.H,o.h=new tv,o.g=Mv(o.l,c?n:null,!o.s),0<o.O&&(o.L=new WT(Ki(o.Ia,o,o.g),o.O)),Xx(o.V,o.g,"readystatechange",o.gb),n=o.H?Rx(o.H):{},o.s?(o.u||(o.u="POST"),n["Content-Type"]="application/x-www-form-urlencoded",o.g.ea(o.A,o.u,o.s,n)):(o.u="GET",o.g.ea(o.A,o.u,null,n)),lh(1),XT(o.j,o.u,o.A,o.m,o.X,o.s)}He.gb=function(o){o=o.target;const n=this.L;n&&ms(o)==3?n.l():this.Ia(o)};He.Ia=function(o){try{if(o==this.g)e:{const ge=ms(this.g);var n=this.g.Da();const ue=this.g.ba();if(!(3>ge)&&(ge!=3||jf||this.g&&(this.h.h||this.g.ga()||zy(this.g)))){this.I||ge!=4||n==7||(n==8||0>=ue?lh(3):lh(2)),Fd(this);var c=this.g.ba();this.N=c;t:if(rv(this)){var m=zy(this.g);o="";var v=m.length,S=ms(this.g)==4;if(!this.h.i){if(typeof TextDecoder=="undefined"){na(this),Qc(this);var L="";break t}this.h.i=new ut.TextDecoder}for(n=0;n<v;n++)this.h.h=!0,o+=this.h.i.decode(m[n],{stream:S&&n==v-1});m.splice(0,v),this.h.g+=o,this.C=0,L=this.h.g}else L=this.g.ga();if(this.i=c==200,HT(this.j,this.u,this.A,this.m,this.X,ge,c),this.i){if(this.$&&!this.J){t:{if(this.g){var a,W=this.g;if((a=W.g?W.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!md(a)){var ie=a;break t}}ie=null}if(c=ie)Al(this.j,this.m,c,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Yf(this,c);else{this.i=!1,this.o=3,vr(12),na(this),Qc(this);break e}}this.U?(nv(this,ge,L),jf&&this.i&&ge==3&&(Xx(this.V,this.W,"tick",this.fb),this.W.start())):(Al(this.j,this.m,L,null),Yf(this,L)),ge==4&&na(this),this.i&&!this.I&&(ge==4?Sv(this.l,this):(this.i=!1,Th(this)))}else c==400&&0<L.indexOf("Unknown SID")?(this.o=3,vr(12)):(this.o=0,vr(13)),na(this),Qc(this)}}}catch{}finally{}};function rv(o){return o.g?o.u=="GET"&&o.K!=2&&o.l.Ba:!1}function nv(o,n,c){let m=!0,v;for(;!o.I&&o.C<c.length;)if(v=QT(o,c),v==gd){n==4&&(o.o=4,vr(14),m=!1),Al(o.j,o.m,null,"[Incomplete Response]");break}else if(v==Hf){o.o=4,vr(15),Al(o.j,o.m,c,"[Invalid Chunk]"),m=!1;break}else Al(o.j,o.m,v,null),Yf(o,v);rv(o)&&v!=gd&&v!=Hf&&(o.h.g="",o.C=0),n!=4||c.length!=0||o.h.h||(o.o=1,vr(16),m=!1),o.i=o.i&&m,m?0<c.length&&!o.aa&&(o.aa=!0,n=o.l,n.g==o&&n.$&&!n.L&&(n.h.info("Great, no buffering proxy detected. Bytes received: "+c.length),Om(n),n.L=!0,vr(11))):(Al(o.j,o.m,c,"[Invalid Chunked Response]"),na(o),Qc(o))}He.fb=function(){if(this.g){var o=ms(this.g),n=this.g.ga();this.C<n.length&&(Fd(this),nv(this,o,n),this.i&&o!=4&&Th(this))}};function QT(o,n){var c=o.C,m=n.indexOf(`
`,c);return m==-1?gd:(c=Number(n.substring(c,m)),isNaN(c)?Hf:(m+=1,m+c>n.length?gd:(n=n.substr(m,c),o.C=m+c,n)))}He.cancel=function(){this.I=!0,na(this)};function Th(o){o.Y=Date.now()+o.P,sv(o,o.P)}function sv(o,n){if(o.B!=null)throw Error("WatchDog timer not null");o.B=vh(Ki(o.eb,o),n)}function Fd(o){o.B&&(ut.clearTimeout(o.B),o.B=null)}He.eb=function(){this.B=null;const o=Date.now();0<=o-this.Y?(KT(this.j,this.A),this.K!=2&&(lh(3),vr(17)),na(this),this.o=2,Qc(this)):sv(this,this.Y-o)};function Qc(o){o.l.G==0||o.I||Sv(o.l,o)}function na(o){Fd(o);var n=o.L;n&&typeof n.na=="function"&&n.na(),o.L=null,Sm(o.W),Hx(o.V),o.g&&(n=o.g,o.g=null,n.abort(),n.na())}function Yf(o,n){try{var c=o.l;if(c.G!=0&&(c.g==o||Jf(c.i,o))){if(c.I=o.N,!o.J&&Jf(c.i,o)&&c.G==3){try{var m=c.Ca.g.parse(n)}catch{m=null}if(Array.isArray(m)&&m.length==3){var v=m;if(v[0]==0)e:if(!c.u){if(c.g)if(c.g.F+3e3<o.F)bd(c),Vd(c);else break e;Fm(c),vr(18)}else c.ta=v[1],0<c.ta-c.U&&37500>v[2]&&c.N&&c.A==0&&!c.v&&(c.v=vh(Ki(c.ab,c),6e3));if(1>=dv(c.i)&&c.ka){try{c.ka()}catch{}c.ka=void 0}}else sa(c,11)}else if((o.J||c.g==o)&&bd(c),!md(n))for(v=c.Ca.g.parse(n),n=0;n<v.length;n++){let ie=v[n];if(c.U=ie[0],ie=ie[1],c.G==2)if(ie[0]=="c"){c.J=ie[1],c.la=ie[2];const ge=ie[3];ge!=null&&(c.ma=ge,c.h.info("VER="+c.ma));const ue=ie[4];ue!=null&&(c.za=ue,c.h.info("SVER="+c.za));const ze=ie[5];ze!=null&&typeof ze=="number"&&0<ze&&(m=1.5*ze,c.K=m,c.h.info("backChannelRequestTimeoutMs_="+m)),m=c;const fe=o.g;if(fe){const it=fe.g?fe.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(it){var S=m.i;!S.g&&(yr(it,"spdy")||yr(it,"quic")||yr(it,"h2"))&&(S.j=S.l,S.g=new Set,S.h&&(zm(S,S.h),S.h=null))}if(m.D){const dt=fe.g?fe.g.getResponseHeader("X-HTTP-Session-Id"):null;dt&&(m.sa=dt,hi(m.F,m.D,dt))}}c.G=3,c.j&&c.j.xa(),c.$&&(c.O=Date.now()-o.F,c.h.info("Handshake RTT: "+c.O+"ms")),m=c;var L=o;if(m.oa=Cv(m,m.H?m.la:null,m.W),L.J){pv(m.i,L);var a=L,W=m.K;W&&a.setTimeout(W),a.B&&(Fd(a),Th(a)),m.g=L}else Tv(m);0<c.l.length&&jd(c)}else ie[0]!="stop"&&ie[0]!="close"||sa(c,7);else c.G==3&&(ie[0]=="stop"||ie[0]=="close"?ie[0]=="stop"?sa(c,7):Bm(c):ie[0]!="noop"&&c.j&&c.j.wa(ie),c.A=0)}}lh(4)}catch{}}function eE(o){if(o.R&&typeof o.R=="function")return o.R();if(typeof o=="string")return o.split("");if(Vf(o)){for(var n=[],c=o.length,m=0;m<c;m++)n.push(o[m]);return n}n=[],c=0;for(m in o)n[c++]=o[m];return n}function km(o,n){if(o.forEach&&typeof o.forEach=="function")o.forEach(n,void 0);else if(Vf(o)||typeof o=="string")Lx(o,n,void 0);else{if(o.T&&typeof o.T=="function")var c=o.T();else if(o.R&&typeof o.R=="function")c=void 0;else if(Vf(o)||typeof o=="string"){c=[];for(var m=o.length,v=0;v<m;v++)c.push(v)}else for(v in c=[],m=0,o)c[m++]=v;m=eE(o),v=m.length;for(var S=0;S<v;S++)n.call(void 0,m[S],c&&c[S],o)}}function Nl(o,n){this.h={},this.g=[],this.i=0;var c=arguments.length;if(1<c){if(c%2)throw Error("Uneven number of arguments");for(var m=0;m<c;m+=2)this.set(arguments[m],arguments[m+1])}else if(o)if(o instanceof Nl)for(c=o.T(),m=0;m<c.length;m++)this.set(c[m],o.get(c[m]));else for(m in o)this.set(m,o[m])}He=Nl.prototype;He.R=function(){Dm(this);for(var o=[],n=0;n<this.g.length;n++)o.push(this.h[this.g[n]]);return o};He.T=function(){return Dm(this),this.g.concat()};function Dm(o){if(o.i!=o.g.length){for(var n=0,c=0;n<o.g.length;){var m=o.g[n];ca(o.h,m)&&(o.g[c++]=m),n++}o.g.length=c}if(o.i!=o.g.length){var v={};for(c=n=0;n<o.g.length;)m=o.g[n],ca(v,m)||(o.g[c++]=m,v[m]=1),n++;o.g.length=c}}He.get=function(o,n){return ca(this.h,o)?this.h[o]:n};He.set=function(o,n){ca(this.h,o)||(this.i++,this.g.push(o)),this.h[o]=n};He.forEach=function(o,n){for(var c=this.T(),m=0;m<c.length;m++){var v=c[m],S=this.get(v);o.call(n,S,v,this)}};function ca(o,n){return Object.prototype.hasOwnProperty.call(o,n)}var ov=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function tE(o,n){if(o){o=o.split("&");for(var c=0;c<o.length;c++){var m=o[c].indexOf("="),v=null;if(0<=m){var S=o[c].substring(0,m);v=o[c].substring(m+1)}else S=o[c];n(S,v?decodeURIComponent(v.replace(/\+/g," ")):"")}}}function ha(o,n){if(this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,o instanceof ha){this.g=n!==void 0?n:o.g,yd(this,o.j),this.s=o.s,xd(this,o.i),vd(this,o.m),this.l=o.l,n=o.h;var c=new ch;c.i=n.i,n.g&&(c.g=new Nl(n.g),c.h=n.h),My(this,c),this.o=o.o}else o&&(c=String(o).match(ov))?(this.g=!!n,yd(this,c[1]||"",!0),this.s=eh(c[2]||""),xd(this,c[3]||"",!0),vd(this,c[4]),this.l=eh(c[5]||"",!0),My(this,c[6]||"",!0),this.o=eh(c[7]||"")):(this.g=!!n,this.h=new ch(null,this.g))}ha.prototype.toString=function(){var o=[],n=this.j;n&&o.push(Kc(n,ky,!0),":");var c=this.i;return(c||n=="file")&&(o.push("//"),(n=this.s)&&o.push(Kc(n,ky,!0),"@"),o.push(encodeURIComponent(String(c)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),c=this.m,c!=null&&o.push(":",String(c))),(c=this.l)&&(this.i&&c.charAt(0)!="/"&&o.push("/"),o.push(Kc(c,c.charAt(0)=="/"?oE:sE,!0))),(c=this.h.toString())&&o.push("?",c),(c=this.o)&&o.push("#",Kc(c,lE)),o.join("")};function _s(o){return new ha(o)}function yd(o,n,c){o.j=c?eh(n,!0):n,o.j&&(o.j=o.j.replace(/:$/,""))}function xd(o,n,c){o.i=c?eh(n,!0):n}function vd(o,n){if(n){if(n=Number(n),isNaN(n)||0>n)throw Error("Bad port number "+n);o.m=n}else o.m=null}function My(o,n,c){n instanceof ch?(o.h=n,cE(o.h,o.g)):(c||(n=Kc(n,aE)),o.h=new ch(n,o.g))}function hi(o,n,c){o.h.set(n,c)}function Od(o){return hi(o,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),o}function iE(o){return o instanceof ha?_s(o):new ha(o,void 0)}function rE(o,n,c,m){var v=new ha(null,void 0);return o&&yd(v,o),n&&xd(v,n),c&&vd(v,c),m&&(v.l=m),v}function eh(o,n){return o?n?decodeURI(o.replace(/%25/g,"%2525")):decodeURIComponent(o):""}function Kc(o,n,c){return typeof o=="string"?(o=encodeURI(o).replace(n,nE),c&&(o=o.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),o):null}function nE(o){return o=o.charCodeAt(0),"%"+(o>>4&15).toString(16)+(o&15).toString(16)}var ky=/[#\/\?@]/g,sE=/[#\?:]/g,oE=/[#\?]/g,aE=/[#\?@]/g,lE=/#/g;function ch(o,n){this.h=this.g=null,this.i=o||null,this.j=!!n}function ao(o){o.g||(o.g=new Nl,o.h=0,o.i&&tE(o.i,function(n,c){o.add(decodeURIComponent(n.replace(/\+/g," ")),c)}))}He=ch.prototype;He.add=function(o,n){ao(this),this.i=null,o=Ul(this,o);var c=this.g.get(o);return c||this.g.set(o,c=[]),c.push(n),this.h+=1,this};function av(o,n){ao(o),n=Ul(o,n),ca(o.g.h,n)&&(o.i=null,o.h-=o.g.get(n).length,o=o.g,ca(o.h,n)&&(delete o.h[n],o.i--,o.g.length>2*o.i&&Dm(o)))}function lv(o,n){return ao(o),n=Ul(o,n),ca(o.g.h,n)}He.forEach=function(o,n){ao(this),this.g.forEach(function(c,m){Lx(c,function(v){o.call(n,v,m,this)},this)},this)};He.T=function(){ao(this);for(var o=this.g.R(),n=this.g.T(),c=[],m=0;m<n.length;m++)for(var v=o[m],S=0;S<v.length;S++)c.push(n[m]);return c};He.R=function(o){ao(this);var n=[];if(typeof o=="string")lv(this,o)&&(n=vy(n,this.g.get(Ul(this,o))));else{o=this.g.R();for(var c=0;c<o.length;c++)n=vy(n,o[c])}return n};He.set=function(o,n){return ao(this),this.i=null,o=Ul(this,o),lv(this,o)&&(this.h-=this.g.get(o).length),this.g.set(o,[n]),this.h+=1,this};He.get=function(o,n){return o?(o=this.R(o),0<o.length?String(o[0]):n):n};function cv(o,n,c){av(o,n),0<c.length&&(o.i=null,o.g.set(Ul(o,n),_m(c)),o.h+=c.length)}He.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var o=[],n=this.g.T(),c=0;c<n.length;c++){var m=n[c],v=encodeURIComponent(String(m));m=this.R(m);for(var S=0;S<m.length;S++){var L=v;m[S]!==""&&(L+="="+encodeURIComponent(String(m[S]))),o.push(L)}}return this.i=o.join("&")};function Ul(o,n){return n=String(n),o.j&&(n=n.toLowerCase()),n}function cE(o,n){n&&!o.j&&(ao(o),o.i=null,o.g.forEach(function(c,m){var v=m.toLowerCase();m!=v&&(av(this,m),cv(this,v,c))},o)),o.j=n}var hE=class{constructor(o,n){this.h=o,this.g=n}};function hv(o){this.l=o||uE,ut.PerformanceNavigationTiming?(o=ut.performance.getEntriesByType("navigation"),o=0<o.length&&(o[0].nextHopProtocol=="hq"||o[0].nextHopProtocol=="h2")):o=!!(ut.g&&ut.g.Ea&&ut.g.Ea()&&ut.g.Ea().Zb),this.j=o?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var uE=10;function uv(o){return o.h?!0:o.g?o.g.size>=o.j:!1}function dv(o){return o.h?1:o.g?o.g.size:0}function Jf(o,n){return o.h?o.h==n:o.g?o.g.has(n):!1}function zm(o,n){o.g?o.g.add(n):o.h=n}function pv(o,n){o.h&&o.h==n?o.h=null:o.g&&o.g.has(n)&&o.g.delete(n)}hv.prototype.cancel=function(){if(this.i=fv(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const o of this.g.values())o.cancel();this.g.clear()}};function fv(o){if(o.h!=null)return o.i.concat(o.h.D);if(o.g!=null&&o.g.size!==0){let n=o.i;for(const c of o.g.values())n=n.concat(c.D);return n}return _m(o.i)}function Pm(){}Pm.prototype.stringify=function(o){return ut.JSON.stringify(o,void 0)};Pm.prototype.parse=function(o){return ut.JSON.parse(o,void 0)};function dE(){this.g=new Pm}function pE(o,n,c){const m=c||"";try{km(o,function(v,S){let L=v;yh(v)&&(L=Tm(v)),n.push(m+S+"="+encodeURIComponent(L))})}catch(v){throw n.push(m+"type="+encodeURIComponent("_badmap")),v}}function fE(o,n){const c=new Pd;if(ut.Image){const m=new Image;m.onload=id(nd,c,m,"TestLoadImage: loaded",!0,n),m.onerror=id(nd,c,m,"TestLoadImage: error",!1,n),m.onabort=id(nd,c,m,"TestLoadImage: abort",!1,n),m.ontimeout=id(nd,c,m,"TestLoadImage: timeout",!1,n),ut.setTimeout(function(){m.ontimeout&&m.ontimeout()},1e4),m.src=o}else n(!1)}function nd(o,n,c,m,v){try{n.onload=null,n.onerror=null,n.onabort=null,n.ontimeout=null,v(m)}catch{}}function Eh(o){this.l=o.$b||null,this.j=o.ib||!1}tr(Eh,Am);Eh.prototype.g=function(){return new Nd(this.l,this.j)};Eh.prototype.i=function(o){return function(){return o}}({});function Nd(o,n){ji.call(this),this.D=o,this.u=n,this.m=void 0,this.readyState=Lm,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}tr(Nd,ji);var Lm=0;He=Nd.prototype;He.open=function(o,n){if(this.readyState!=Lm)throw this.abort(),Error("Error reopening a connection");this.C=o,this.B=n,this.readyState=1,hh(this)};He.send=function(o){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const n={headers:this.v,method:this.C,credentials:this.m,cache:void 0};o&&(n.body=o),(this.D||ut).fetch(new Request(this.B,n)).then(this.Va.bind(this),this.ha.bind(this))};He.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,Sh(this)),this.readyState=Lm};He.Va=function(o){if(this.g&&(this.l=o,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=o.headers,this.readyState=2,hh(this)),this.g&&(this.readyState=3,hh(this),this.g)))if(this.responseType==="arraybuffer")o.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(typeof ut.ReadableStream!="undefined"&&"body"in o){if(this.j=o.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;mv(this)}else o.text().then(this.Ua.bind(this),this.ha.bind(this))};function mv(o){o.j.read().then(o.Sa.bind(o)).catch(o.ha.bind(o))}He.Sa=function(o){if(this.g){if(this.u&&o.value)this.response.push(o.value);else if(!this.u){var n=o.value?o.value:new Uint8Array(0);(n=this.A.decode(n,{stream:!o.done}))&&(this.response=this.responseText+=n)}o.done?Sh(this):hh(this),this.readyState==3&&mv(this)}};He.Ua=function(o){this.g&&(this.response=this.responseText=o,Sh(this))};He.Ta=function(o){this.g&&(this.response=o,Sh(this))};He.ha=function(){this.g&&Sh(this)};function Sh(o){o.readyState=4,o.l=null,o.j=null,o.A=null,hh(o)}He.setRequestHeader=function(o,n){this.v.append(o,n)};He.getResponseHeader=function(o){return this.h&&this.h.get(o.toLowerCase())||""};He.getAllResponseHeaders=function(){if(!this.h)return"";const o=[],n=this.h.entries();for(var c=n.next();!c.done;)c=c.value,o.push(c[0]+": "+c[1]),c=n.next();return o.join(`\r
`)};function hh(o){o.onreadystatechange&&o.onreadystatechange.call(o)}Object.defineProperty(Nd.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(o){this.m=o?"include":"same-origin"}});var mE=ut.JSON.parse;function Li(o){ji.call(this),this.headers=new Nl,this.u=o||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=_v,this.K=this.L=!1}tr(Li,ji);var _v="",_E=/^https?$/i,gE=["POST","PUT"];He=Li.prototype;He.ea=function(o,n,c,m){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+o);n=n?n.toUpperCase():"GET",this.H=o,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():Xf.g(),this.C=this.u?Cy(this.u):Cy(Xf),this.g.onreadystatechange=Ki(this.Fa,this);try{this.F=!0,this.g.open(n,String(o),!0),this.F=!1}catch(S){Dy(this,S);return}o=c||"";const v=new Nl(this.headers);m&&km(m,function(S,L){v.set(L,S)}),m=CT(v.T()),c=ut.FormData&&o instanceof ut.FormData,!(0<=Px(gE,n))||m||c||v.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),v.forEach(function(S,L){this.g.setRequestHeader(L,S)},this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{xv(this),0<this.B&&((this.K=yE(this.g))?(this.g.timeout=this.B,this.g.ontimeout=Ki(this.pa,this)):this.A=Im(this.pa,this.B,this)),this.v=!0,this.g.send(o),this.v=!1}catch(S){Dy(this,S)}};function yE(o){return zl&&PT()&&typeof o.timeout=="number"&&o.ontimeout!==void 0}function xE(o){return o.toLowerCase()=="content-type"}He.pa=function(){typeof mm!="undefined"&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Yi(this,"timeout"),this.abort(8))};function Dy(o,n){o.h=!1,o.g&&(o.l=!0,o.g.abort(),o.l=!1),o.j=n,o.m=5,gv(o),Ud(o)}function gv(o){o.D||(o.D=!0,Yi(o,"complete"),Yi(o,"error"))}He.abort=function(o){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=o||7,Yi(this,"complete"),Yi(this,"abort"),Ud(this))};He.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Ud(this,!0)),Li.Z.M.call(this)};He.Fa=function(){this.s||(this.F||this.v||this.l?yv(this):this.cb())};He.cb=function(){yv(this)};function yv(o){if(o.h&&typeof mm!="undefined"&&(!o.C[1]||ms(o)!=4||o.ba()!=2)){if(o.v&&ms(o)==4)Im(o.Fa,0,o);else if(Yi(o,"readystatechange"),ms(o)==4){o.h=!1;try{const a=o.ba();e:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var n=!0;break e;default:n=!1}var c;if(!(c=n)){var m;if(m=a===0){var v=String(o.H).match(ov)[1]||null;if(!v&&ut.self&&ut.self.location){var S=ut.self.location.protocol;v=S.substr(0,S.length-1)}m=!_E.test(v?v.toLowerCase():"")}c=m}if(c)Yi(o,"complete"),Yi(o,"success");else{o.m=6;try{var L=2<ms(o)?o.g.statusText:""}catch{L=""}o.j=L+" ["+o.ba()+"]",gv(o)}}finally{Ud(o)}}}}function Ud(o,n){if(o.g){xv(o);const c=o.g,m=o.C[0]?fd:null;o.g=null,o.C=null,n||Yi(o,"ready");try{c.onreadystatechange=m}catch{}}}function xv(o){o.g&&o.K&&(o.g.ontimeout=null),o.A&&(ut.clearTimeout(o.A),o.A=null)}function ms(o){return o.g?o.g.readyState:0}He.ba=function(){try{return 2<ms(this)?this.g.status:-1}catch{return-1}};He.ga=function(){try{return this.g?this.g.responseText:""}catch{return""}};He.Qa=function(o){if(this.g){var n=this.g.responseText;return o&&n.indexOf(o)==0&&(n=n.substring(o.length)),mE(n)}};function zy(o){try{if(!o.g)return null;if("response"in o.g)return o.g.response;switch(o.J){case _v:case"text":return o.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in o.g)return o.g.mozResponseArrayBuffer}return null}catch{return null}}He.Da=function(){return this.m};He.La=function(){return typeof this.j=="string"?this.j:String(this.j)};function vE(o){let n="";return gm(o,function(c,m){n+=m,n+=":",n+=c,n+=`\r
`}),n}function Rm(o,n,c){e:{for(m in c){var m=!1;break e}m=!0}m||(c=vE(c),typeof o=="string"?c!=null&&encodeURIComponent(String(c)):hi(o,n,c))}function Wc(o,n,c){return c&&c.internalChannelParams&&c.internalChannelParams[o]||n}function vv(o){this.za=0,this.l=[],this.h=new Pd,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Wc("failFast",!1,o),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Wc("baseRetryDelayMs",5e3,o),this.$a=Wc("retryDelaySeedMs",1e4,o),this.Ya=Wc("forwardChannelMaxRetries",2,o),this.ra=Wc("forwardChannelRequestTimeoutMs",2e4,o),this.qa=o&&o.xmlHttpFactory||void 0,this.Ba=o&&o.Yb||!1,this.K=void 0,this.H=o&&o.supportsCrossDomainXhr||!1,this.J="",this.i=new hv(o&&o.concurrentRequestLimit),this.Ca=new dE,this.ja=o&&o.fastHandshake||!1,this.Ra=o&&o.Wb||!1,o&&o.Aa&&this.h.Aa(),o&&o.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&o&&o.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!o||o.Xb!==!1}He=vv.prototype;He.ma=8;He.G=1;function Bm(o){if(bv(o),o.G==3){var n=o.V++,c=_s(o.F);hi(c,"SID",o.J),hi(c,"RID",n),hi(c,"TYPE","terminate"),Ih(o,c),n=new wh(o,o.h,n,void 0),n.K=2,n.v=Od(_s(c)),c=!1,ut.navigator&&ut.navigator.sendBeacon&&(c=ut.navigator.sendBeacon(n.v.toString(),"")),!c&&ut.Image&&(new Image().src=n.v,c=!0),c||(n.g=Mv(n.l,null),n.g.ea(n.v)),n.F=Date.now(),Th(n)}Av(o)}He.hb=function(o){try{this.h.info("Origin Trials invoked: "+o)}catch{}};function Vd(o){o.g&&(Om(o),o.g.cancel(),o.g=null)}function bv(o){Vd(o),o.u&&(ut.clearTimeout(o.u),o.u=null),bd(o),o.i.cancel(),o.m&&(typeof o.m=="number"&&ut.clearTimeout(o.m),o.m=null)}function Mf(o,n){o.l.push(new hE(o.Za++,n)),o.G==3&&jd(o)}function jd(o){uv(o.i)||o.m||(o.m=!0,Em(o.Ha,o),o.C=0)}function bE(o,n){return dv(o.i)>=o.i.j-(o.m?1:0)?!1:o.m?(o.l=n.D.concat(o.l),!0):o.G==1||o.G==2||o.C>=(o.Xa?0:o.Ya)?!1:(o.m=vh(Ki(o.Ha,o,n),Iv(o,o.C)),o.C++,!0)}He.Ha=function(o){if(this.m)if(this.m=null,this.G==1){if(!o){this.V=Math.floor(1e5*Math.random()),o=this.V++;const v=new wh(this,this.h,o,void 0);let S=this.s;if(this.P&&(S?(S=Rx(S),Bx(S,this.P)):S=this.P),this.o===null&&(v.H=S),this.ja)e:{for(var n=0,c=0;c<this.l.length;c++){t:{var m=this.l[c];if("__data__"in m.g&&(m=m.g.__data__,typeof m=="string")){m=m.length;break t}m=void 0}if(m===void 0)break;if(n+=m,4096<n){n=c;break e}if(n===4096||c===this.l.length-1){n=c+1;break e}}n=1e3}else n=1e3;n=wv(this,v,n),c=_s(this.F),hi(c,"RID",o),hi(c,"CVER",22),this.D&&hi(c,"X-HTTP-Session-Id",this.D),Ih(this,c),this.o&&S&&Rm(c,this.o,S),zm(this.i,v),this.Ra&&hi(c,"TYPE","init"),this.ja?(hi(c,"$req",n),hi(c,"SID","null"),v.$=!0,Kf(v,c,null)):Kf(v,c,n),this.G=2}}else this.G==3&&(o?Py(this,o):this.l.length==0||uv(this.i)||Py(this))};function Py(o,n){var c;n?c=n.m:c=o.V++;const m=_s(o.F);hi(m,"SID",o.J),hi(m,"RID",c),hi(m,"AID",o.U),Ih(o,m),o.o&&o.s&&Rm(m,o.o,o.s),c=new wh(o,o.h,c,o.C+1),o.o===null&&(c.H=o.s),n&&(o.l=n.D.concat(o.l)),n=wv(o,c,1e3),c.setTimeout(Math.round(.5*o.ra)+Math.round(.5*o.ra*Math.random())),zm(o.i,c),Kf(c,m,n)}function Ih(o,n){o.j&&km({},function(c,m){hi(n,m,c)})}function wv(o,n,c){c=Math.min(o.l.length,c);var m=o.j?Ki(o.j.Oa,o.j,o):null;e:{var v=o.l;let S=-1;for(;;){const L=["count="+c];S==-1?0<c?(S=v[0].h,L.push("ofs="+S)):S=0:L.push("ofs="+S);let a=!0;for(let W=0;W<c;W++){let ie=v[W].h;const ge=v[W].g;if(ie-=S,0>ie)S=Math.max(0,v[W].h-100),a=!1;else try{pE(ge,L,"req"+ie+"_")}catch{m&&m(ge)}}if(a){m=L.join("&");break e}}}return o=o.l.splice(0,c),n.D=o,m}function Tv(o){o.g||o.u||(o.Y=1,Em(o.Ga,o),o.A=0)}function Fm(o){return o.g||o.u||3<=o.A?!1:(o.Y++,o.u=vh(Ki(o.Ga,o),Iv(o,o.A)),o.A++,!0)}He.Ga=function(){if(this.u=null,Ev(this),this.$&&!(this.L||this.g==null||0>=this.O)){var o=2*this.O;this.h.info("BP detection timer enabled: "+o),this.B=vh(Ki(this.bb,this),o)}};He.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,vr(10),Vd(this),Ev(this))};function Om(o){o.B!=null&&(ut.clearTimeout(o.B),o.B=null)}function Ev(o){o.g=new wh(o,o.h,"rpc",o.Y),o.o===null&&(o.g.H=o.s),o.g.O=0;var n=_s(o.oa);hi(n,"RID","rpc"),hi(n,"SID",o.J),hi(n,"CI",o.N?"0":"1"),hi(n,"AID",o.U),Ih(o,n),hi(n,"TYPE","xmlhttp"),o.o&&o.s&&Rm(n,o.o,o.s),o.K&&o.g.setTimeout(o.K);var c=o.g;o=o.la,c.K=1,c.v=Od(_s(n)),c.s=null,c.U=!0,iv(c,o)}He.ab=function(){this.v!=null&&(this.v=null,Vd(this),Fm(this),vr(19))};function bd(o){o.v!=null&&(ut.clearTimeout(o.v),o.v=null)}function Sv(o,n){var c=null;if(o.g==n){bd(o),Om(o),o.g=null;var m=2}else if(Jf(o.i,n))c=n.D,pv(o.i,n),m=1;else return;if(o.I=n.N,o.G!=0){if(n.i)if(m==1){c=n.s?n.s.length:0,n=Date.now()-n.F;var v=o.C;m=Ld(),Yi(m,new Jx(m,c,n,v)),jd(o)}else Tv(o);else if(v=n.o,v==3||v==0&&0<o.I||!(m==1&&bE(o,n)||m==2&&Fm(o)))switch(c&&0<c.length&&(n=o.i,n.i=n.i.concat(c)),v){case 1:sa(o,5);break;case 4:sa(o,10);break;case 3:sa(o,6);break;default:sa(o,2)}}}function Iv(o,n){let c=o.Pa+Math.floor(Math.random()*o.$a);return o.j||(c*=2),c*n}function sa(o,n){if(o.h.info("Error code "+n),n==2){var c=null;o.j&&(c=null);var m=Ki(o.jb,o);c||(c=new ha("//www.google.com/images/cleardot.gif"),ut.location&&ut.location.protocol=="http"||yd(c,"https"),Od(c)),fE(c.toString(),m)}else vr(2);o.G=0,o.j&&o.j.va(n),Av(o),bv(o)}He.jb=function(o){o?(this.h.info("Successfully pinged google.com"),vr(2)):(this.h.info("Failed to ping google.com"),vr(1))};function Av(o){o.G=0,o.I=-1,o.j&&((fv(o.i).length!=0||o.l.length!=0)&&(o.i.i.length=0,_m(o.l),o.l.length=0),o.j.ua())}function Cv(o,n,c){let m=iE(c);if(m.i!="")n&&xd(m,n+"."+m.i),vd(m,m.m);else{const v=ut.location;m=rE(v.protocol,n?n+"."+v.hostname:v.hostname,+v.port,c)}return o.aa&&gm(o.aa,function(v,S){hi(m,S,v)}),n=o.D,c=o.sa,n&&c&&hi(m,n,c),hi(m,"VER",o.ma),Ih(o,m),m}function Mv(o,n,c){if(n&&!o.H)throw Error("Can't create secondary domain capable XhrIo object.");return n=c&&o.Ba&&!o.qa?new Li(new Eh({ib:!0})):new Li(o.qa),n.L=o.H,n}function kv(){}He=kv.prototype;He.xa=function(){};He.wa=function(){};He.va=function(){};He.ua=function(){};He.Oa=function(){};function wd(){if(zl&&!(10<=Number(LT)))throw Error("Environmental error: no available transport.")}wd.prototype.g=function(o,n){return new Wr(o,n)};function Wr(o,n){ji.call(this),this.g=new vv(n),this.l=o,this.h=n&&n.messageUrlParams||null,o=n&&n.messageHeaders||null,n&&n.clientProtocolHeaderRequired&&(o?o["X-Client-Protocol"]="webchannel":o={"X-Client-Protocol":"webchannel"}),this.g.s=o,o=n&&n.initMessageHeaders||null,n&&n.messageContentType&&(o?o["X-WebChannel-Content-Type"]=n.messageContentType:o={"X-WebChannel-Content-Type":n.messageContentType}),n&&n.ya&&(o?o["X-WebChannel-Client-Profile"]=n.ya:o={"X-WebChannel-Client-Profile":n.ya}),this.g.P=o,(o=n&&n.httpHeadersOverwriteParam)&&!md(o)&&(this.g.o=o),this.A=n&&n.supportsCrossDomainXhr||!1,this.v=n&&n.sendRawJson||!1,(n=n&&n.httpSessionIdParam)&&!md(n)&&(this.g.D=n,o=this.h,o!==null&&n in o&&(o=this.h,n in o&&delete o[n])),this.j=new Vl(this)}tr(Wr,ji);Wr.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var o=this.g,n=this.l,c=this.h||void 0;o.Wa&&(o.h.info("Origin Trials enabled."),Em(Ki(o.hb,o,n))),vr(0),o.W=n,o.aa=c||{},o.N=o.X,o.F=Cv(o,null,o.W),jd(o)};Wr.prototype.close=function(){Bm(this.g)};Wr.prototype.u=function(o){if(typeof o=="string"){var n={};n.__data__=o,Mf(this.g,n)}else this.v?(n={},n.__data__=Tm(o),Mf(this.g,n)):Mf(this.g,o)};Wr.prototype.M=function(){this.g.j=null,delete this.j,Bm(this.g),delete this.g,Wr.Z.M.call(this)};function Dv(o){Cm.call(this);var n=o.__sm__;if(n){e:{for(const c in n){o=c;break e}o=void 0}(this.i=o)&&(o=this.i,n=n!==null&&o in n?n[o]:void 0),this.data=n}else this.data=o}tr(Dv,Cm);function zv(){Mm.call(this),this.status=1}tr(zv,Mm);function Vl(o){this.g=o}tr(Vl,kv);Vl.prototype.xa=function(){Yi(this.g,"a")};Vl.prototype.wa=function(o){Yi(this.g,new Dv(o))};Vl.prototype.va=function(o){Yi(this.g,new zv(o))};Vl.prototype.ua=function(){Yi(this.g,"b")};wd.prototype.createWebChannel=wd.prototype.g;Wr.prototype.send=Wr.prototype.u;Wr.prototype.open=Wr.prototype.m;Wr.prototype.close=Wr.prototype.close;Rd.NO_ERROR=0;Rd.TIMEOUT=8;Rd.HTTP_ERROR=6;Qx.COMPLETE="complete";ev.EventType=bh;bh.OPEN="a";bh.CLOSE="b";bh.ERROR="c";bh.MESSAGE="d";ji.prototype.listen=ji.prototype.N;Li.prototype.listenOnce=Li.prototype.O;Li.prototype.getLastError=Li.prototype.La;Li.prototype.getLastErrorCode=Li.prototype.Da;Li.prototype.getStatus=Li.prototype.ba;Li.prototype.getResponseJson=Li.prototype.Qa;Li.prototype.getResponseText=Li.prototype.ga;Li.prototype.send=Li.prototype.ea;var wE=function(){return new wd},TE=function(){return Ld()},kf=Rd,EE=Qx,SE=ma,Ly={rb:0,ub:1,vb:2,Ob:3,Tb:4,Qb:5,Rb:6,Pb:7,Nb:8,Sb:9,PROXY:10,NOPROXY:11,Lb:12,Hb:13,Ib:14,Gb:15,Jb:16,Kb:17,nb:18,mb:19,ob:20},IE=Eh,sd=ev,AE=Li;const Ry="@firebase/firestore";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rr{constructor(n){this.uid=n}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(n){return n.uid===this.uid}}Rr.UNAUTHENTICATED=new Rr(null),Rr.GOOGLE_CREDENTIALS=new Rr("google-credentials-uid"),Rr.FIRST_PARTY=new Rr("first-party-uid"),Rr.MOCK_USER=new Rr("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let jl="9.6.10";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ua=new Mx("@firebase/firestore");function By(){return ua.logLevel}function rt(o,...n){if(ua.logLevel<=Zt.DEBUG){const c=n.map(Nm);ua.debug(`Firestore (${jl}): ${o}`,...c)}}function no(o,...n){if(ua.logLevel<=Zt.ERROR){const c=n.map(Nm);ua.error(`Firestore (${jl}): ${o}`,...c)}}function Fy(o,...n){if(ua.logLevel<=Zt.WARN){const c=n.map(Nm);ua.warn(`Firestore (${jl}): ${o}`,...c)}}function Nm(o){if(typeof o=="string")return o;try{return n=o,JSON.stringify(n)}catch{return o}/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var n}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function kt(o="Unexpected state"){const n=`FIRESTORE (${jl}) INTERNAL ASSERTION FAILED: `+o;throw no(n),new Error(n)}function Pi(o,n){o||kt()}function Ut(o,n){return o}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ze={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class ct extends Md{constructor(n,c){super(n,c),this.code=n,this.message=c,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class oa{constructor(){this.promise=new Promise((n,c)=>{this.resolve=n,this.reject=c})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class CE{constructor(n,c){this.user=c,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${n}`)}}class ME{getToken(){return Promise.resolve(null)}invalidateToken(){}start(n,c){n.enqueueRetryable(()=>c(Rr.UNAUTHENTICATED))}shutdown(){}}class kE{constructor(n){this.t=n,this.currentUser=Rr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(n,c){let m=this.i;const v=W=>this.i!==m?(m=this.i,c(W)):Promise.resolve();let S=new oa;this.o=()=>{this.i++,this.currentUser=this.u(),S.resolve(),S=new oa,n.enqueueRetryable(()=>v(this.currentUser))};const L=()=>{const W=S;n.enqueueRetryable(async()=>{await W.promise,await v(this.currentUser)})},a=W=>{rt("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=W,this.auth.addAuthTokenListener(this.o),L()};this.t.onInit(W=>a(W)),setTimeout(()=>{if(!this.auth){const W=this.t.getImmediate({optional:!0});W?a(W):(rt("FirebaseAuthCredentialsProvider","Auth not yet detected"),S.resolve(),S=new oa)}},0),L()}getToken(){const n=this.i,c=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(c).then(m=>this.i!==n?(rt("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):m?(Pi(typeof m.accessToken=="string"),new CE(m.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const n=this.auth&&this.auth.getUid();return Pi(n===null||typeof n=="string"),new Rr(n)}}class DE{constructor(n,c,m){this.type="FirstParty",this.user=Rr.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",c);const v=n.auth.getAuthHeaderValueForFirstParty([]);v&&this.headers.set("Authorization",v),m&&this.headers.set("X-Goog-Iam-Authorization-Token",m)}}class zE{constructor(n,c,m){this.h=n,this.l=c,this.m=m}getToken(){return Promise.resolve(new DE(this.h,this.l,this.m))}start(n,c){n.enqueueRetryable(()=>c(Rr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class PE{constructor(n){this.value=n,this.type="AppCheck",this.headers=new Map,n&&n.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class LE{constructor(n){this.g=n,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(n,c){const m=S=>{S.error!=null&&rt("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${S.error.message}`);const L=S.token!==this.p;return this.p=S.token,rt("FirebaseAppCheckTokenProvider",`Received ${L?"new":"existing"} token.`),L?c(S.token):Promise.resolve()};this.o=S=>{n.enqueueRetryable(()=>m(S))};const v=S=>{rt("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=S,this.appCheck.addTokenListener(this.o)};this.g.onInit(S=>v(S)),setTimeout(()=>{if(!this.appCheck){const S=this.g.getImmediate({optional:!0});S?v(S):rt("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){const n=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(n).then(c=>c?(Pi(typeof c.token=="string"),this.p=c.token,new PE(c.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Um{constructor(n,c){this.previousValue=n,c&&(c.sequenceNumberHandler=m=>this.I(m),this.T=m=>c.writeSequenceNumber(m))}I(n){return this.previousValue=Math.max(n,this.previousValue),this.previousValue}next(){const n=++this.previousValue;return this.T&&this.T(n),n}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function RE(o){const n=typeof self!="undefined"&&(self.crypto||self.msCrypto),c=new Uint8Array(o);if(n&&typeof n.getRandomValues=="function")n.getRandomValues(c);else for(let m=0;m<o;m++)c[m]=Math.floor(256*Math.random());return c}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Um.A=-1;class Pv{static R(){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=Math.floor(256/n.length)*n.length;let m="";for(;m.length<20;){const v=RE(40);for(let S=0;S<v.length;++S)m.length<20&&v[S]<c&&(m+=n.charAt(v[S]%n.length))}return m}}function Xt(o,n){return o<n?-1:o>n?1:0}function uh(o,n,c){return o.length===n.length&&o.every((m,v)=>c(m,n[v]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sn{constructor(n,c){if(this.seconds=n,this.nanoseconds=c,c<0)throw new ct(Ze.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+c);if(c>=1e9)throw new ct(Ze.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+c);if(n<-62135596800)throw new ct(Ze.INVALID_ARGUMENT,"Timestamp seconds out of range: "+n);if(n>=253402300800)throw new ct(Ze.INVALID_ARGUMENT,"Timestamp seconds out of range: "+n)}static now(){return Sn.fromMillis(Date.now())}static fromDate(n){return Sn.fromMillis(n.getTime())}static fromMillis(n){const c=Math.floor(n/1e3),m=Math.floor(1e6*(n-1e3*c));return new Sn(c,m)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(n){return this.seconds===n.seconds?Xt(this.nanoseconds,n.nanoseconds):Xt(this.seconds,n.seconds)}isEqual(n){return n.seconds===this.seconds&&n.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const n=this.seconds- -62135596800;return String(n).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mt{constructor(n){this.timestamp=n}static fromTimestamp(n){return new Mt(n)}static min(){return new Mt(new Sn(0,0))}static max(){return new Mt(new Sn(253402300799,999999999))}compareTo(n){return this.timestamp._compareTo(n.timestamp)}isEqual(n){return this.timestamp.isEqual(n.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Oy(o){let n=0;for(const c in o)Object.prototype.hasOwnProperty.call(o,c)&&n++;return n}function $d(o,n){for(const c in o)Object.prototype.hasOwnProperty.call(o,c)&&n(c,o[c])}function BE(o){for(const n in o)if(Object.prototype.hasOwnProperty.call(o,n))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dh{constructor(n,c,m){c===void 0?c=0:c>n.length&&kt(),m===void 0?m=n.length-c:m>n.length-c&&kt(),this.segments=n,this.offset=c,this.len=m}get length(){return this.len}isEqual(n){return dh.comparator(this,n)===0}child(n){const c=this.segments.slice(this.offset,this.limit());return n instanceof dh?n.forEach(m=>{c.push(m)}):c.push(n),this.construct(c)}limit(){return this.offset+this.length}popFirst(n){return n=n===void 0?1:n,this.construct(this.segments,this.offset+n,this.length-n)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(n){return this.segments[this.offset+n]}isEmpty(){return this.length===0}isPrefixOf(n){if(n.length<this.length)return!1;for(let c=0;c<this.length;c++)if(this.get(c)!==n.get(c))return!1;return!0}isImmediateParentOf(n){if(this.length+1!==n.length)return!1;for(let c=0;c<this.length;c++)if(this.get(c)!==n.get(c))return!1;return!0}forEach(n){for(let c=this.offset,m=this.limit();c<m;c++)n(this.segments[c])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(n,c){const m=Math.min(n.length,c.length);for(let v=0;v<m;v++){const S=n.get(v),L=c.get(v);if(S<L)return-1;if(S>L)return 1}return n.length<c.length?-1:n.length>c.length?1:0}}class ui extends dh{construct(n,c,m){return new ui(n,c,m)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...n){const c=[];for(const m of n){if(m.indexOf("//")>=0)throw new ct(Ze.INVALID_ARGUMENT,`Invalid segment (${m}). Paths must not contain // in them.`);c.push(...m.split("/").filter(v=>v.length>0))}return new ui(c)}static emptyPath(){return new ui([])}}const FE=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class En extends dh{construct(n,c,m){return new En(n,c,m)}static isValidIdentifier(n){return FE.test(n)}canonicalString(){return this.toArray().map(n=>(n=n.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),En.isValidIdentifier(n)||(n="`"+n+"`"),n)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new En(["__name__"])}static fromServerFormat(n){const c=[];let m="",v=0;const S=()=>{if(m.length===0)throw new ct(Ze.INVALID_ARGUMENT,`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);c.push(m),m=""};let L=!1;for(;v<n.length;){const a=n[v];if(a==="\\"){if(v+1===n.length)throw new ct(Ze.INVALID_ARGUMENT,"Path has trailing escape character: "+n);const W=n[v+1];if(W!=="\\"&&W!=="."&&W!=="`")throw new ct(Ze.INVALID_ARGUMENT,"Path has invalid escape sequence: "+n);m+=W,v+=2}else a==="`"?(L=!L,v++):a!=="."||L?(m+=a,v++):(S(),v++)}if(S(),L)throw new ct(Ze.INVALID_ARGUMENT,"Unterminated ` in path: "+n);return new En(c)}static emptyPath(){return new En([])}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qi{constructor(n){this.binaryString=n}static fromBase64String(n){const c=atob(n);return new Qi(c)}static fromUint8Array(n){const c=function(m){let v="";for(let S=0;S<m.length;++S)v+=String.fromCharCode(m[S]);return v}(n);return new Qi(c)}[Symbol.iterator](){let n=0;return{next:()=>n<this.binaryString.length?{value:this.binaryString.charCodeAt(n++),done:!1}:{value:void 0,done:!0}}}toBase64(){return n=this.binaryString,btoa(n);var n}toUint8Array(){return function(n){const c=new Uint8Array(n.length);for(let m=0;m<n.length;m++)c[m]=n.charCodeAt(m);return c}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(n){return Xt(this.binaryString,n.binaryString)}isEqual(n){return this.binaryString===n.binaryString}}Qi.EMPTY_BYTE_STRING=new Qi("");const OE=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function so(o){if(Pi(!!o),typeof o=="string"){let n=0;const c=OE.exec(o);if(Pi(!!c),c[1]){let v=c[1];v=(v+"000000000").substr(0,9),n=Number(v)}const m=new Date(o);return{seconds:Math.floor(m.getTime()/1e3),nanos:n}}return{seconds:zi(o.seconds),nanos:zi(o.nanos)}}function zi(o){return typeof o=="number"?o:typeof o=="string"?Number(o):0}function Pl(o){return typeof o=="string"?Qi.fromBase64String(o):Qi.fromUint8Array(o)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Lv(o){var n,c;return((c=(((n=o==null?void 0:o.mapValue)===null||n===void 0?void 0:n.fields)||{}).__type__)===null||c===void 0?void 0:c.stringValue)==="server_timestamp"}function Rv(o){const n=o.mapValue.fields.__previous_value__;return Lv(n)?Rv(n):n}function ph(o){const n=so(o.mapValue.fields.__local_write_time__.timestampValue);return new Sn(n.seconds,n.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class NE{constructor(n,c,m,v,S,L,a,W){this.databaseId=n,this.appId=c,this.persistenceKey=m,this.host=v,this.ssl=S,this.forceLongPolling=L,this.autoDetectLongPolling=a,this.useFetchStreams=W}}class Ll{constructor(n,c){this.projectId=n,this.database=c||"(default)"}static empty(){return new Ll("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(n){return n instanceof Ll&&n.projectId===this.projectId&&n.database===this.database}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $l(o){return o==null}function Qf(o){return o===0&&1/o==-1/0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class at{constructor(n){this.path=n}static fromPath(n){return new at(ui.fromString(n))}static fromName(n){return new at(ui.fromString(n).popFirst(5))}static empty(){return new at(ui.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(n){return this.path.length>=2&&this.path.get(this.path.length-2)===n}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(n){return n!==null&&ui.comparator(this.path,n.path)===0}toString(){return this.path.toString()}static comparator(n,c){return ui.comparator(n.path,c.path)}static isDocumentKey(n){return n.length%2==0}static fromSegments(n){return new at(new ui(n.slice()))}}function da(o){return"nullValue"in o?0:"booleanValue"in o?1:"integerValue"in o||"doubleValue"in o?2:"timestampValue"in o?3:"stringValue"in o?5:"bytesValue"in o?6:"referenceValue"in o?7:"geoPointValue"in o?8:"arrayValue"in o?9:"mapValue"in o?Lv(o)?4:UE(o)?9:10:kt()}function Hn(o,n){if(o===n)return!0;const c=da(o);if(c!==da(n))return!1;switch(c){case 0:case 9007199254740991:return!0;case 1:return o.booleanValue===n.booleanValue;case 4:return ph(o).isEqual(ph(n));case 3:return function(m,v){if(typeof m.timestampValue=="string"&&typeof v.timestampValue=="string"&&m.timestampValue.length===v.timestampValue.length)return m.timestampValue===v.timestampValue;const S=so(m.timestampValue),L=so(v.timestampValue);return S.seconds===L.seconds&&S.nanos===L.nanos}(o,n);case 5:return o.stringValue===n.stringValue;case 6:return function(m,v){return Pl(m.bytesValue).isEqual(Pl(v.bytesValue))}(o,n);case 7:return o.referenceValue===n.referenceValue;case 8:return function(m,v){return zi(m.geoPointValue.latitude)===zi(v.geoPointValue.latitude)&&zi(m.geoPointValue.longitude)===zi(v.geoPointValue.longitude)}(o,n);case 2:return function(m,v){if("integerValue"in m&&"integerValue"in v)return zi(m.integerValue)===zi(v.integerValue);if("doubleValue"in m&&"doubleValue"in v){const S=zi(m.doubleValue),L=zi(v.doubleValue);return S===L?Qf(S)===Qf(L):isNaN(S)&&isNaN(L)}return!1}(o,n);case 9:return uh(o.arrayValue.values||[],n.arrayValue.values||[],Hn);case 10:return function(m,v){const S=m.mapValue.fields||{},L=v.mapValue.fields||{};if(Oy(S)!==Oy(L))return!1;for(const a in S)if(S.hasOwnProperty(a)&&(L[a]===void 0||!Hn(S[a],L[a])))return!1;return!0}(o,n);default:return kt()}}function fh(o,n){return(o.values||[]).find(c=>Hn(c,n))!==void 0}function Rl(o,n){if(o===n)return 0;const c=da(o),m=da(n);if(c!==m)return Xt(c,m);switch(c){case 0:case 9007199254740991:return 0;case 1:return Xt(o.booleanValue,n.booleanValue);case 2:return function(v,S){const L=zi(v.integerValue||v.doubleValue),a=zi(S.integerValue||S.doubleValue);return L<a?-1:L>a?1:L===a?0:isNaN(L)?isNaN(a)?0:-1:1}(o,n);case 3:return Ny(o.timestampValue,n.timestampValue);case 4:return Ny(ph(o),ph(n));case 5:return Xt(o.stringValue,n.stringValue);case 6:return function(v,S){const L=Pl(v),a=Pl(S);return L.compareTo(a)}(o.bytesValue,n.bytesValue);case 7:return function(v,S){const L=v.split("/"),a=S.split("/");for(let W=0;W<L.length&&W<a.length;W++){const ie=Xt(L[W],a[W]);if(ie!==0)return ie}return Xt(L.length,a.length)}(o.referenceValue,n.referenceValue);case 8:return function(v,S){const L=Xt(zi(v.latitude),zi(S.latitude));return L!==0?L:Xt(zi(v.longitude),zi(S.longitude))}(o.geoPointValue,n.geoPointValue);case 9:return function(v,S){const L=v.values||[],a=S.values||[];for(let W=0;W<L.length&&W<a.length;++W){const ie=Rl(L[W],a[W]);if(ie)return ie}return Xt(L.length,a.length)}(o.arrayValue,n.arrayValue);case 10:return function(v,S){const L=v.fields||{},a=Object.keys(L),W=S.fields||{},ie=Object.keys(W);a.sort(),ie.sort();for(let ge=0;ge<a.length&&ge<ie.length;++ge){const ue=Xt(a[ge],ie[ge]);if(ue!==0)return ue;const ze=Rl(L[a[ge]],W[ie[ge]]);if(ze!==0)return ze}return Xt(a.length,ie.length)}(o.mapValue,n.mapValue);default:throw kt()}}function Ny(o,n){if(typeof o=="string"&&typeof n=="string"&&o.length===n.length)return Xt(o,n);const c=so(o),m=so(n),v=Xt(c.seconds,m.seconds);return v!==0?v:Xt(c.nanos,m.nanos)}function kl(o){return em(o)}function em(o){return"nullValue"in o?"null":"booleanValue"in o?""+o.booleanValue:"integerValue"in o?""+o.integerValue:"doubleValue"in o?""+o.doubleValue:"timestampValue"in o?function(m){const v=so(m);return`time(${v.seconds},${v.nanos})`}(o.timestampValue):"stringValue"in o?o.stringValue:"bytesValue"in o?Pl(o.bytesValue).toBase64():"referenceValue"in o?(c=o.referenceValue,at.fromName(c).toString()):"geoPointValue"in o?`geo(${(n=o.geoPointValue).latitude},${n.longitude})`:"arrayValue"in o?function(m){let v="[",S=!0;for(const L of m.values||[])S?S=!1:v+=",",v+=em(L);return v+"]"}(o.arrayValue):"mapValue"in o?function(m){const v=Object.keys(m.fields||{}).sort();let S="{",L=!0;for(const a of v)L?L=!1:S+=",",S+=`${a}:${em(m.fields[a])}`;return S+"}"}(o.mapValue):kt();var n,c}function tm(o){return!!o&&"integerValue"in o}function Vm(o){return!!o&&"arrayValue"in o}function Uy(o){return!!o&&"nullValue"in o}function Vy(o){return!!o&&"doubleValue"in o&&isNaN(Number(o.doubleValue))}function Df(o){return!!o&&"mapValue"in o}function th(o){if(o.geoPointValue)return{geoPointValue:Object.assign({},o.geoPointValue)};if(o.timestampValue&&typeof o.timestampValue=="object")return{timestampValue:Object.assign({},o.timestampValue)};if(o.mapValue){const n={mapValue:{fields:{}}};return $d(o.mapValue.fields,(c,m)=>n.mapValue.fields[c]=th(m)),n}if(o.arrayValue){const n={arrayValue:{values:[]}};for(let c=0;c<(o.arrayValue.values||[]).length;++c)n.arrayValue.values[c]=th(o.arrayValue.values[c]);return n}return Object.assign({},o)}function UE(o){return(((o.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fs{constructor(n){this.value=n}static empty(){return new fs({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let c=this.value;for(let m=0;m<n.length-1;++m)if(c=(c.mapValue.fields||{})[n.get(m)],!Df(c))return null;return c=(c.mapValue.fields||{})[n.lastSegment()],c||null}}set(n,c){this.getFieldsMap(n.popLast())[n.lastSegment()]=th(c)}setAll(n){let c=En.emptyPath(),m={},v=[];n.forEach((L,a)=>{if(!c.isImmediateParentOf(a)){const W=this.getFieldsMap(c);this.applyChanges(W,m,v),m={},v=[],c=a.popLast()}L?m[a.lastSegment()]=th(L):v.push(a.lastSegment())});const S=this.getFieldsMap(c);this.applyChanges(S,m,v)}delete(n){const c=this.field(n.popLast());Df(c)&&c.mapValue.fields&&delete c.mapValue.fields[n.lastSegment()]}isEqual(n){return Hn(this.value,n.value)}getFieldsMap(n){let c=this.value;c.mapValue.fields||(c.mapValue={fields:{}});for(let m=0;m<n.length;++m){let v=c.mapValue.fields[n.get(m)];Df(v)&&v.mapValue.fields||(v={mapValue:{fields:{}}},c.mapValue.fields[n.get(m)]=v),c=v}return c.mapValue.fields}applyChanges(n,c,m){$d(c,(v,S)=>n[v]=S);for(const v of m)delete n[v]}clone(){return new fs(th(this.value))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lr{constructor(n,c,m,v,S,L){this.key=n,this.documentType=c,this.version=m,this.readTime=v,this.data=S,this.documentState=L}static newInvalidDocument(n){return new lr(n,0,Mt.min(),Mt.min(),fs.empty(),0)}static newFoundDocument(n,c,m){return new lr(n,1,c,Mt.min(),m,0)}static newNoDocument(n,c){return new lr(n,2,c,Mt.min(),fs.empty(),0)}static newUnknownDocument(n,c){return new lr(n,3,c,Mt.min(),fs.empty(),2)}convertToFoundDocument(n,c){return this.version=n,this.documentType=1,this.data=c,this.documentState=0,this}convertToNoDocument(n){return this.version=n,this.documentType=2,this.data=fs.empty(),this.documentState=0,this}convertToUnknownDocument(n){return this.version=n,this.documentType=3,this.data=fs.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}setReadTime(n){return this.readTime=n,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(n){return n instanceof lr&&this.key.isEqual(n.key)&&this.version.isEqual(n.version)&&this.documentType===n.documentType&&this.documentState===n.documentState&&this.data.isEqual(n.data)}mutableCopy(){return new lr(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}function VE(o,n){const c=o.toTimestamp().seconds,m=o.toTimestamp().nanoseconds+1,v=Mt.fromTimestamp(m===1e9?new Sn(c+1,0):new Sn(c,m));return new Bl(v,at.empty(),n)}function jE(o){return new Bl(o.readTime,o.key,-1)}class Bl{constructor(n,c,m){this.readTime=n,this.documentKey=c,this.largestBatchId=m}static min(){return new Bl(Mt.min(),at.empty(),-1)}static max(){return new Bl(Mt.max(),at.empty(),-1)}}function $E(o,n){let c=o.readTime.compareTo(n.readTime);return c!==0?c:(c=at.comparator(o.documentKey,n.documentKey),c!==0?c:Xt(o.largestBatchId,n.largestBatchId))}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class GE{constructor(n,c=null,m=[],v=[],S=null,L=null,a=null){this.path=n,this.collectionGroup=c,this.orderBy=m,this.filters=v,this.limit=S,this.startAt=L,this.endAt=a,this.P=null}}function jy(o,n=null,c=[],m=[],v=null,S=null,L=null){return new GE(o,n,c,m,v,S,L)}function jm(o){const n=Ut(o);if(n.P===null){let c=n.path.canonicalString();n.collectionGroup!==null&&(c+="|cg:"+n.collectionGroup),c+="|f:",c+=n.filters.map(m=>{return(v=m).field.canonicalString()+v.op.toString()+kl(v.value);var v}).join(","),c+="|ob:",c+=n.orderBy.map(m=>function(v){return v.field.canonicalString()+v.dir}(m)).join(","),$l(n.limit)||(c+="|l:",c+=n.limit),n.startAt&&(c+="|lb:",c+=n.startAt.inclusive?"b:":"a:",c+=n.startAt.position.map(m=>kl(m)).join(",")),n.endAt&&(c+="|ub:",c+=n.endAt.inclusive?"a:":"b:",c+=n.endAt.position.map(m=>kl(m)).join(",")),n.P=c}return n.P}function qE(o){let n=o.path.canonicalString();return o.collectionGroup!==null&&(n+=" collectionGroup="+o.collectionGroup),o.filters.length>0&&(n+=`, filters: [${o.filters.map(c=>{return`${(m=c).field.canonicalString()} ${m.op} ${kl(m.value)}`;var m}).join(", ")}]`),$l(o.limit)||(n+=", limit: "+o.limit),o.orderBy.length>0&&(n+=`, orderBy: [${o.orderBy.map(c=>function(m){return`${m.field.canonicalString()} (${m.dir})`}(c)).join(", ")}]`),o.startAt&&(n+=", startAt: ",n+=o.startAt.inclusive?"b:":"a:",n+=o.startAt.position.map(c=>kl(c)).join(",")),o.endAt&&(n+=", endAt: ",n+=o.endAt.inclusive?"a:":"b:",n+=o.endAt.position.map(c=>kl(c)).join(",")),`Target(${n})`}function $m(o,n){if(o.limit!==n.limit||o.orderBy.length!==n.orderBy.length)return!1;for(let v=0;v<o.orderBy.length;v++)if(!QE(o.orderBy[v],n.orderBy[v]))return!1;if(o.filters.length!==n.filters.length)return!1;for(let v=0;v<o.filters.length;v++)if(c=o.filters[v],m=n.filters[v],c.op!==m.op||!c.field.isEqual(m.field)||!Hn(c.value,m.value))return!1;var c,m;return o.collectionGroup===n.collectionGroup&&!!o.path.isEqual(n.path)&&!!Gy(o.startAt,n.startAt)&&Gy(o.endAt,n.endAt)}function im(o){return at.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}class Br extends class{}{constructor(n,c,m){super(),this.field=n,this.op=c,this.value=m}static create(n,c,m){return n.isKeyField()?c==="in"||c==="not-in"?this.V(n,c,m):new ZE(n,c,m):c==="array-contains"?new HE(n,m):c==="in"?new KE(n,m):c==="not-in"?new YE(n,m):c==="array-contains-any"?new JE(n,m):new Br(n,c,m)}static V(n,c,m){return c==="in"?new WE(n,m):new XE(n,m)}matches(n){const c=n.data.field(this.field);return this.op==="!="?c!==null&&this.v(Rl(c,this.value)):c!==null&&da(this.value)===da(c)&&this.v(Rl(c,this.value))}v(n){switch(this.op){case"<":return n<0;case"<=":return n<=0;case"==":return n===0;case"!=":return n!==0;case">":return n>0;case">=":return n>=0;default:return kt()}}S(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class ZE extends Br{constructor(n,c,m){super(n,c,m),this.key=at.fromName(m.referenceValue)}matches(n){const c=at.comparator(n.key,this.key);return this.v(c)}}class WE extends Br{constructor(n,c){super(n,"in",c),this.keys=Bv("in",c)}matches(n){return this.keys.some(c=>c.isEqual(n.key))}}class XE extends Br{constructor(n,c){super(n,"not-in",c),this.keys=Bv("not-in",c)}matches(n){return!this.keys.some(c=>c.isEqual(n.key))}}function Bv(o,n){var c;return(((c=n.arrayValue)===null||c===void 0?void 0:c.values)||[]).map(m=>at.fromName(m.referenceValue))}class HE extends Br{constructor(n,c){super(n,"array-contains",c)}matches(n){const c=n.data.field(this.field);return Vm(c)&&fh(c.arrayValue,this.value)}}class KE extends Br{constructor(n,c){super(n,"in",c)}matches(n){const c=n.data.field(this.field);return c!==null&&fh(this.value.arrayValue,c)}}class YE extends Br{constructor(n,c){super(n,"not-in",c)}matches(n){if(fh(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const c=n.data.field(this.field);return c!==null&&!fh(this.value.arrayValue,c)}}class JE extends Br{constructor(n,c){super(n,"array-contains-any",c)}matches(n){const c=n.data.field(this.field);return!(!Vm(c)||!c.arrayValue.values)&&c.arrayValue.values.some(m=>fh(this.value.arrayValue,m))}}class Td{constructor(n,c){this.position=n,this.inclusive=c}}class ih{constructor(n,c="asc"){this.field=n,this.dir=c}}function QE(o,n){return o.dir===n.dir&&o.field.isEqual(n.field)}function $y(o,n,c){let m=0;for(let v=0;v<o.position.length;v++){const S=n[v],L=o.position[v];if(S.field.isKeyField()?m=at.comparator(at.fromName(L.referenceValue),c.key):m=Rl(L,c.data.field(S.field)),S.dir==="desc"&&(m*=-1),m!==0)break}return m}function Gy(o,n){if(o===null)return n===null;if(n===null||o.inclusive!==n.inclusive||o.position.length!==n.position.length)return!1;for(let c=0;c<o.position.length;c++)if(!Hn(o.position[c],n.position[c]))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gd{constructor(n,c=null,m=[],v=[],S=null,L="F",a=null,W=null){this.path=n,this.collectionGroup=c,this.explicitOrderBy=m,this.filters=v,this.limit=S,this.limitType=L,this.startAt=a,this.endAt=W,this.D=null,this.C=null,this.startAt,this.endAt}}function e2(o,n,c,m,v,S,L,a){return new Gd(o,n,c,m,v,S,L,a)}function Gm(o){return new Gd(o)}function cd(o){return!$l(o.limit)&&o.limitType==="F"}function rm(o){return!$l(o.limit)&&o.limitType==="L"}function t2(o){return o.explicitOrderBy.length>0?o.explicitOrderBy[0].field:null}function i2(o){for(const n of o.filters)if(n.S())return n.field;return null}function r2(o){return o.collectionGroup!==null}function mh(o){const n=Ut(o);if(n.D===null){n.D=[];const c=i2(n),m=t2(n);if(c!==null&&m===null)c.isKeyField()||n.D.push(new ih(c)),n.D.push(new ih(En.keyField(),"asc"));else{let v=!1;for(const S of n.explicitOrderBy)n.D.push(S),S.field.isKeyField()&&(v=!0);if(!v){const S=n.explicitOrderBy.length>0?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.D.push(new ih(En.keyField(),S))}}}return n.D}function pa(o){const n=Ut(o);if(!n.C)if(n.limitType==="F")n.C=jy(n.path,n.collectionGroup,mh(n),n.filters,n.limit,n.startAt,n.endAt);else{const c=[];for(const S of mh(n)){const L=S.dir==="desc"?"asc":"desc";c.push(new ih(S.field,L))}const m=n.endAt?new Td(n.endAt.position,!n.endAt.inclusive):null,v=n.startAt?new Td(n.startAt.position,!n.startAt.inclusive):null;n.C=jy(n.path,n.collectionGroup,c,n.filters,n.limit,m,v)}return n.C}function n2(o,n,c){return new Gd(o.path,o.collectionGroup,o.explicitOrderBy.slice(),o.filters.slice(),n,c,o.startAt,o.endAt)}function qd(o,n){return $m(pa(o),pa(n))&&o.limitType===n.limitType}function Fv(o){return`${jm(pa(o))}|lt:${o.limitType}`}function nm(o){return`Query(target=${qE(pa(o))}; limitType=${o.limitType})`}function qm(o,n){return n.isFoundDocument()&&function(c,m){const v=m.key.path;return c.collectionGroup!==null?m.key.hasCollectionId(c.collectionGroup)&&c.path.isPrefixOf(v):at.isDocumentKey(c.path)?c.path.isEqual(v):c.path.isImmediateParentOf(v)}(o,n)&&function(c,m){for(const v of c.explicitOrderBy)if(!v.field.isKeyField()&&m.data.field(v.field)===null)return!1;return!0}(o,n)&&function(c,m){for(const v of c.filters)if(!v.matches(m))return!1;return!0}(o,n)&&function(c,m){return!(c.startAt&&!function(v,S,L){const a=$y(v,S,L);return v.inclusive?a<=0:a<0}(c.startAt,mh(c),m)||c.endAt&&!function(v,S,L){const a=$y(v,S,L);return v.inclusive?a>=0:a>0}(c.endAt,mh(c),m))}(o,n)}function s2(o){return o.collectionGroup||(o.path.length%2==1?o.path.lastSegment():o.path.get(o.path.length-2))}function Ov(o){return(n,c)=>{let m=!1;for(const v of mh(o)){const S=o2(v,n,c);if(S!==0)return S;m=m||v.field.isKeyField()}return 0}}function o2(o,n,c){const m=o.field.isKeyField()?at.comparator(n.key,c.key):function(v,S,L){const a=S.data.field(v),W=L.data.field(v);return a!==null&&W!==null?Rl(a,W):kt()}(o.field,n,c);switch(o.dir){case"asc":return m;case"desc":return-1*m;default:return kt()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function a2(o,n){if(o.N){if(isNaN(n))return{doubleValue:"NaN"};if(n===1/0)return{doubleValue:"Infinity"};if(n===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Qf(n)?"-0":n}}function l2(o){return{integerValue:""+o}}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zd{constructor(){this._=void 0}}function c2(o,n,c){return o instanceof sm?function(m,v){const S={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:m.seconds,nanos:m.nanoseconds}}}};return v&&(S.fields.__previous_value__=v),{mapValue:S}}(c,n):o instanceof Ed?Nv(o,n):o instanceof Sd?Uv(o,n):function(m,v){const S=u2(m,v),L=qy(S)+qy(m.k);return tm(S)&&tm(m.k)?l2(L):a2(m.M,L)}(o,n)}function h2(o,n,c){return o instanceof Ed?Nv(o,n):o instanceof Sd?Uv(o,n):c}function u2(o,n){return o instanceof om?tm(c=n)||function(m){return!!m&&"doubleValue"in m}(c)?n:{integerValue:0}:null;var c}class sm extends Zd{}class Ed extends Zd{constructor(n){super(),this.elements=n}}function Nv(o,n){const c=Vv(n);for(const m of o.elements)c.some(v=>Hn(v,m))||c.push(m);return{arrayValue:{values:c}}}class Sd extends Zd{constructor(n){super(),this.elements=n}}function Uv(o,n){let c=Vv(n);for(const m of o.elements)c=c.filter(v=>!Hn(v,m));return{arrayValue:{values:c}}}class om extends Zd{constructor(n,c){super(),this.M=n,this.k=c}}function qy(o){return zi(o.integerValue||o.doubleValue)}function Vv(o){return Vm(o)&&o.arrayValue.values?o.arrayValue.values.slice():[]}function d2(o,n){return o.field.isEqual(n.field)&&function(c,m){return c instanceof Ed&&m instanceof Ed||c instanceof Sd&&m instanceof Sd?uh(c.elements,m.elements,Hn):c instanceof om&&m instanceof om?Hn(c.k,m.k):c instanceof sm&&m instanceof sm}(o.transform,n.transform)}function hd(o,n){return o.updateTime!==void 0?n.isFoundDocument()&&n.version.isEqual(o.updateTime):o.exists===void 0||o.exists===n.isFoundDocument()}class jv{}function p2(o,n,c){o instanceof $v?function(m,v,S){const L=m.value.clone(),a=Xy(m.fieldTransforms,v,S.transformResults);L.setAll(a),v.convertToFoundDocument(S.version,L).setHasCommittedMutations()}(o,n,c):o instanceof Gv?function(m,v,S){if(!hd(m.precondition,v))return void v.convertToUnknownDocument(S.version);const L=Xy(m.fieldTransforms,v,S.transformResults),a=v.data;a.setAll(qv(m)),a.setAll(L),v.convertToFoundDocument(S.version,a).setHasCommittedMutations()}(o,n,c):function(m,v,S){v.convertToNoDocument(S.version).setHasCommittedMutations()}(0,n,c)}function am(o,n,c){o instanceof $v?function(m,v,S){if(!hd(m.precondition,v))return;const L=m.value.clone(),a=Hy(m.fieldTransforms,S,v);L.setAll(a),v.convertToFoundDocument(Wy(v),L).setHasLocalMutations()}(o,n,c):o instanceof Gv?function(m,v,S){if(!hd(m.precondition,v))return;const L=Hy(m.fieldTransforms,S,v),a=v.data;a.setAll(qv(m)),a.setAll(L),v.convertToFoundDocument(Wy(v),a).setHasLocalMutations()}(o,n,c):function(m,v){hd(m.precondition,v)&&v.convertToNoDocument(Mt.min())}(o,n)}function Zy(o,n){return o.type===n.type&&!!o.key.isEqual(n.key)&&!!o.precondition.isEqual(n.precondition)&&!!function(c,m){return c===void 0&&m===void 0||!(!c||!m)&&uh(c,m,(v,S)=>d2(v,S))}(o.fieldTransforms,n.fieldTransforms)&&(o.type===0?o.value.isEqual(n.value):o.type!==1||o.data.isEqual(n.data)&&o.fieldMask.isEqual(n.fieldMask))}function Wy(o){return o.isFoundDocument()?o.version:Mt.min()}class $v extends jv{constructor(n,c,m,v=[]){super(),this.key=n,this.value=c,this.precondition=m,this.fieldTransforms=v,this.type=0}}class Gv extends jv{constructor(n,c,m,v,S=[]){super(),this.key=n,this.data=c,this.fieldMask=m,this.precondition=v,this.fieldTransforms=S,this.type=1}}function qv(o){const n=new Map;return o.fieldMask.fields.forEach(c=>{if(!c.isEmpty()){const m=o.data.field(c);n.set(c,m)}}),n}function Xy(o,n,c){const m=new Map;Pi(o.length===c.length);for(let v=0;v<c.length;v++){const S=o[v],L=S.transform,a=n.data.field(S.field);m.set(S.field,h2(L,a,c[v]))}return m}function Hy(o,n,c){const m=new Map;for(const v of o){const S=v.transform,L=c.data.field(v.field);m.set(v.field,c2(S,L,n))}return m}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class f2{constructor(n){this.count=n}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Di,Bt;function Zv(o){if(o===void 0)return no("GRPC error has no .code"),Ze.UNKNOWN;switch(o){case Di.OK:return Ze.OK;case Di.CANCELLED:return Ze.CANCELLED;case Di.UNKNOWN:return Ze.UNKNOWN;case Di.DEADLINE_EXCEEDED:return Ze.DEADLINE_EXCEEDED;case Di.RESOURCE_EXHAUSTED:return Ze.RESOURCE_EXHAUSTED;case Di.INTERNAL:return Ze.INTERNAL;case Di.UNAVAILABLE:return Ze.UNAVAILABLE;case Di.UNAUTHENTICATED:return Ze.UNAUTHENTICATED;case Di.INVALID_ARGUMENT:return Ze.INVALID_ARGUMENT;case Di.NOT_FOUND:return Ze.NOT_FOUND;case Di.ALREADY_EXISTS:return Ze.ALREADY_EXISTS;case Di.PERMISSION_DENIED:return Ze.PERMISSION_DENIED;case Di.FAILED_PRECONDITION:return Ze.FAILED_PRECONDITION;case Di.ABORTED:return Ze.ABORTED;case Di.OUT_OF_RANGE:return Ze.OUT_OF_RANGE;case Di.UNIMPLEMENTED:return Ze.UNIMPLEMENTED;case Di.DATA_LOSS:return Ze.DATA_LOSS;default:return kt()}}(Bt=Di||(Di={}))[Bt.OK=0]="OK",Bt[Bt.CANCELLED=1]="CANCELLED",Bt[Bt.UNKNOWN=2]="UNKNOWN",Bt[Bt.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Bt[Bt.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Bt[Bt.NOT_FOUND=5]="NOT_FOUND",Bt[Bt.ALREADY_EXISTS=6]="ALREADY_EXISTS",Bt[Bt.PERMISSION_DENIED=7]="PERMISSION_DENIED",Bt[Bt.UNAUTHENTICATED=16]="UNAUTHENTICATED",Bt[Bt.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Bt[Bt.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Bt[Bt.ABORTED=10]="ABORTED",Bt[Bt.OUT_OF_RANGE=11]="OUT_OF_RANGE",Bt[Bt.UNIMPLEMENTED=12]="UNIMPLEMENTED",Bt[Bt.INTERNAL=13]="INTERNAL",Bt[Bt.UNAVAILABLE=14]="UNAVAILABLE",Bt[Bt.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gl{constructor(n,c){this.mapKeyFn=n,this.equalsFn=c,this.inner={},this.innerSize=0}get(n){const c=this.mapKeyFn(n),m=this.inner[c];if(m!==void 0){for(const[v,S]of m)if(this.equalsFn(v,n))return S}}has(n){return this.get(n)!==void 0}set(n,c){const m=this.mapKeyFn(n),v=this.inner[m];if(v===void 0)return this.inner[m]=[[n,c]],void this.innerSize++;for(let S=0;S<v.length;S++)if(this.equalsFn(v[S][0],n))return void(v[S]=[n,c]);v.push([n,c]),this.innerSize++}delete(n){const c=this.mapKeyFn(n),m=this.inner[c];if(m===void 0)return!1;for(let v=0;v<m.length;v++)if(this.equalsFn(m[v][0],n))return m.length===1?delete this.inner[c]:m.splice(v,1),this.innerSize--,!0;return!1}forEach(n){$d(this.inner,(c,m)=>{for(const[v,S]of m)n(v,S)})}isEmpty(){return BE(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class er{constructor(n,c){this.comparator=n,this.root=c||Hi.EMPTY}insert(n,c){return new er(this.comparator,this.root.insert(n,c,this.comparator).copy(null,null,Hi.BLACK,null,null))}remove(n){return new er(this.comparator,this.root.remove(n,this.comparator).copy(null,null,Hi.BLACK,null,null))}get(n){let c=this.root;for(;!c.isEmpty();){const m=this.comparator(n,c.key);if(m===0)return c.value;m<0?c=c.left:m>0&&(c=c.right)}return null}indexOf(n){let c=0,m=this.root;for(;!m.isEmpty();){const v=this.comparator(n,m.key);if(v===0)return c+m.left.size;v<0?m=m.left:(c+=m.left.size+1,m=m.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(n){return this.root.inorderTraversal(n)}forEach(n){this.inorderTraversal((c,m)=>(n(c,m),!1))}toString(){const n=[];return this.inorderTraversal((c,m)=>(n.push(`${c}:${m}`),!1)),`{${n.join(", ")}}`}reverseTraversal(n){return this.root.reverseTraversal(n)}getIterator(){return new od(this.root,null,this.comparator,!1)}getIteratorFrom(n){return new od(this.root,n,this.comparator,!1)}getReverseIterator(){return new od(this.root,null,this.comparator,!0)}getReverseIteratorFrom(n){return new od(this.root,n,this.comparator,!0)}}class od{constructor(n,c,m,v){this.isReverse=v,this.nodeStack=[];let S=1;for(;!n.isEmpty();)if(S=c?m(n.key,c):1,c&&v&&(S*=-1),S<0)n=this.isReverse?n.left:n.right;else{if(S===0){this.nodeStack.push(n);break}this.nodeStack.push(n),n=this.isReverse?n.right:n.left}}getNext(){let n=this.nodeStack.pop();const c={key:n.key,value:n.value};if(this.isReverse)for(n=n.left;!n.isEmpty();)this.nodeStack.push(n),n=n.right;else for(n=n.right;!n.isEmpty();)this.nodeStack.push(n),n=n.left;return c}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const n=this.nodeStack[this.nodeStack.length-1];return{key:n.key,value:n.value}}}class Hi{constructor(n,c,m,v,S){this.key=n,this.value=c,this.color=m!=null?m:Hi.RED,this.left=v!=null?v:Hi.EMPTY,this.right=S!=null?S:Hi.EMPTY,this.size=this.left.size+1+this.right.size}copy(n,c,m,v,S){return new Hi(n!=null?n:this.key,c!=null?c:this.value,m!=null?m:this.color,v!=null?v:this.left,S!=null?S:this.right)}isEmpty(){return!1}inorderTraversal(n){return this.left.inorderTraversal(n)||n(this.key,this.value)||this.right.inorderTraversal(n)}reverseTraversal(n){return this.right.reverseTraversal(n)||n(this.key,this.value)||this.left.reverseTraversal(n)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(n,c,m){let v=this;const S=m(n,v.key);return v=S<0?v.copy(null,null,null,v.left.insert(n,c,m),null):S===0?v.copy(null,c,null,null,null):v.copy(null,null,null,null,v.right.insert(n,c,m)),v.fixUp()}removeMin(){if(this.left.isEmpty())return Hi.EMPTY;let n=this;return n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.removeMin(),null),n.fixUp()}remove(n,c){let m,v=this;if(c(n,v.key)<0)v.left.isEmpty()||v.left.isRed()||v.left.left.isRed()||(v=v.moveRedLeft()),v=v.copy(null,null,null,v.left.remove(n,c),null);else{if(v.left.isRed()&&(v=v.rotateRight()),v.right.isEmpty()||v.right.isRed()||v.right.left.isRed()||(v=v.moveRedRight()),c(n,v.key)===0){if(v.right.isEmpty())return Hi.EMPTY;m=v.right.min(),v=v.copy(m.key,m.value,null,null,v.right.removeMin())}v=v.copy(null,null,null,null,v.right.remove(n,c))}return v.fixUp()}isRed(){return this.color}fixUp(){let n=this;return n.right.isRed()&&!n.left.isRed()&&(n=n.rotateLeft()),n.left.isRed()&&n.left.left.isRed()&&(n=n.rotateRight()),n.left.isRed()&&n.right.isRed()&&(n=n.colorFlip()),n}moveRedLeft(){let n=this.colorFlip();return n.right.left.isRed()&&(n=n.copy(null,null,null,null,n.right.rotateRight()),n=n.rotateLeft(),n=n.colorFlip()),n}moveRedRight(){let n=this.colorFlip();return n.left.left.isRed()&&(n=n.rotateRight(),n=n.colorFlip()),n}rotateLeft(){const n=this.copy(null,null,Hi.RED,null,this.right.left);return this.right.copy(null,null,this.color,n,null)}rotateRight(){const n=this.copy(null,null,Hi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,n)}colorFlip(){const n=this.left.copy(null,null,!this.left.color,null,null),c=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,n,c)}checkMaxDepth(){const n=this.check();return Math.pow(2,n)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw kt();const n=this.left.check();if(n!==this.right.check())throw kt();return n+(this.isRed()?0:1)}}Hi.EMPTY=null,Hi.RED=!0,Hi.BLACK=!1;Hi.EMPTY=new class{constructor(){this.size=0}get key(){throw kt()}get value(){throw kt()}get color(){throw kt()}get left(){throw kt()}get right(){throw kt()}copy(o,n,c,m,v){return this}insert(o,n,c){return new Hi(o,n)}remove(o,n){return this}isEmpty(){return!0}inorderTraversal(o){return!1}reverseTraversal(o){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ji{constructor(n){this.comparator=n,this.data=new er(this.comparator)}has(n){return this.data.get(n)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(n){return this.data.indexOf(n)}forEach(n){this.data.inorderTraversal((c,m)=>(n(c),!1))}forEachInRange(n,c){const m=this.data.getIteratorFrom(n[0]);for(;m.hasNext();){const v=m.getNext();if(this.comparator(v.key,n[1])>=0)return;c(v.key)}}forEachWhile(n,c){let m;for(m=c!==void 0?this.data.getIteratorFrom(c):this.data.getIterator();m.hasNext();)if(!n(m.getNext().key))return}firstAfterOrEqual(n){const c=this.data.getIteratorFrom(n);return c.hasNext()?c.getNext().key:null}getIterator(){return new Ky(this.data.getIterator())}getIteratorFrom(n){return new Ky(this.data.getIteratorFrom(n))}add(n){return this.copy(this.data.remove(n).insert(n,!0))}delete(n){return this.has(n)?this.copy(this.data.remove(n)):this}isEmpty(){return this.data.isEmpty()}unionWith(n){let c=this;return c.size<n.size&&(c=n,n=this),n.forEach(m=>{c=c.add(m)}),c}isEqual(n){if(!(n instanceof Ji)||this.size!==n.size)return!1;const c=this.data.getIterator(),m=n.data.getIterator();for(;c.hasNext();){const v=c.getNext().key,S=m.getNext().key;if(this.comparator(v,S)!==0)return!1}return!0}toArray(){const n=[];return this.forEach(c=>{n.push(c)}),n}toString(){const n=[];return this.forEach(c=>n.push(c)),"SortedSet("+n.toString()+")"}copy(n){const c=new Ji(this.comparator);return c.data=n,c}}class Ky{constructor(n){this.iter=n}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const m2=new er(at.comparator);function fa(){return m2}const _2=new er(at.comparator);function lm(){return _2}function zf(){return new Gl(o=>o.toString(),(o,n)=>o.isEqual(n))}new er(at.comparator);const g2=new Ji(at.comparator);function di(...o){let n=g2;for(const c of o)n=n.add(c);return n}const y2=new Ji(Xt);function Wv(){return y2}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wd{constructor(n,c,m,v,S){this.snapshotVersion=n,this.targetChanges=c,this.targetMismatches=m,this.documentUpdates=v,this.resolvedLimboDocuments=S}static createSynthesizedRemoteEventForCurrentChange(n,c){const m=new Map;return m.set(n,Ah.createSynthesizedTargetChangeForCurrentChange(n,c)),new Wd(Mt.min(),m,Wv(),fa(),di())}}class Ah{constructor(n,c,m,v,S){this.resumeToken=n,this.current=c,this.addedDocuments=m,this.modifiedDocuments=v,this.removedDocuments=S}static createSynthesizedTargetChangeForCurrentChange(n,c){return new Ah(Qi.EMPTY_BYTE_STRING,c,di(),di(),di())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ud{constructor(n,c,m,v){this.O=n,this.removedTargetIds=c,this.key=m,this.F=v}}class Xv{constructor(n,c){this.targetId=n,this.$=c}}class Hv{constructor(n,c,m=Qi.EMPTY_BYTE_STRING,v=null){this.state=n,this.targetIds=c,this.resumeToken=m,this.cause=v}}class Yy{constructor(){this.B=0,this.L=Qy(),this.U=Qi.EMPTY_BYTE_STRING,this.q=!1,this.G=!0}get current(){return this.q}get resumeToken(){return this.U}get K(){return this.B!==0}get j(){return this.G}W(n){n.approximateByteSize()>0&&(this.G=!0,this.U=n)}H(){let n=di(),c=di(),m=di();return this.L.forEach((v,S)=>{switch(S){case 0:n=n.add(v);break;case 2:c=c.add(v);break;case 1:m=m.add(v);break;default:kt()}}),new Ah(this.U,this.q,n,c,m)}J(){this.G=!1,this.L=Qy()}Y(n,c){this.G=!0,this.L=this.L.insert(n,c)}X(n){this.G=!0,this.L=this.L.remove(n)}Z(){this.B+=1}tt(){this.B-=1}et(){this.G=!0,this.q=!0}}class x2{constructor(n){this.nt=n,this.st=new Map,this.it=fa(),this.rt=Jy(),this.ot=new Ji(Xt)}ut(n){for(const c of n.O)n.F&&n.F.isFoundDocument()?this.at(c,n.F):this.ct(c,n.key,n.F);for(const c of n.removedTargetIds)this.ct(c,n.key,n.F)}ht(n){this.forEachTarget(n,c=>{const m=this.lt(c);switch(n.state){case 0:this.ft(c)&&m.W(n.resumeToken);break;case 1:m.tt(),m.K||m.J(),m.W(n.resumeToken);break;case 2:m.tt(),m.K||this.removeTarget(c);break;case 3:this.ft(c)&&(m.et(),m.W(n.resumeToken));break;case 4:this.ft(c)&&(this.dt(c),m.W(n.resumeToken));break;default:kt()}})}forEachTarget(n,c){n.targetIds.length>0?n.targetIds.forEach(c):this.st.forEach((m,v)=>{this.ft(v)&&c(v)})}_t(n){const c=n.targetId,m=n.$.count,v=this.wt(c);if(v){const S=v.target;if(im(S))if(m===0){const L=new at(S.path);this.ct(c,L,lr.newNoDocument(L,Mt.min()))}else Pi(m===1);else this.gt(c)!==m&&(this.dt(c),this.ot=this.ot.add(c))}}yt(n){const c=new Map;this.st.forEach((S,L)=>{const a=this.wt(L);if(a){if(S.current&&im(a.target)){const W=new at(a.target.path);this.it.get(W)!==null||this.It(L,W)||this.ct(L,W,lr.newNoDocument(W,n))}S.j&&(c.set(L,S.H()),S.J())}});let m=di();this.rt.forEach((S,L)=>{let a=!0;L.forEachWhile(W=>{const ie=this.wt(W);return!ie||ie.purpose===2||(a=!1,!1)}),a&&(m=m.add(S))}),this.it.forEach((S,L)=>L.setReadTime(n));const v=new Wd(n,c,this.ot,this.it,m);return this.it=fa(),this.rt=Jy(),this.ot=new Ji(Xt),v}at(n,c){if(!this.ft(n))return;const m=this.It(n,c.key)?2:0;this.lt(n).Y(c.key,m),this.it=this.it.insert(c.key,c),this.rt=this.rt.insert(c.key,this.Tt(c.key).add(n))}ct(n,c,m){if(!this.ft(n))return;const v=this.lt(n);this.It(n,c)?v.Y(c,1):v.X(c),this.rt=this.rt.insert(c,this.Tt(c).delete(n)),m&&(this.it=this.it.insert(c,m))}removeTarget(n){this.st.delete(n)}gt(n){const c=this.lt(n).H();return this.nt.getRemoteKeysForTarget(n).size+c.addedDocuments.size-c.removedDocuments.size}Z(n){this.lt(n).Z()}lt(n){let c=this.st.get(n);return c||(c=new Yy,this.st.set(n,c)),c}Tt(n){let c=this.rt.get(n);return c||(c=new Ji(Xt),this.rt=this.rt.insert(n,c)),c}ft(n){const c=this.wt(n)!==null;return c||rt("WatchChangeAggregator","Detected inactive target",n),c}wt(n){const c=this.st.get(n);return c&&c.K?null:this.nt.Et(n)}dt(n){this.st.set(n,new Yy),this.nt.getRemoteKeysForTarget(n).forEach(c=>{this.ct(n,c,null)})}It(n,c){return this.nt.getRemoteKeysForTarget(n).has(c)}}function Jy(){return new er(at.comparator)}function Qy(){return new er(at.comparator)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const v2=(()=>({asc:"ASCENDING",desc:"DESCENDING"}))(),b2=(()=>({"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"}))();class w2{constructor(n,c){this.databaseId=n,this.N=c}}function T2(o,n){return o.N?`${new Date(1e3*n.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+n.nanoseconds).slice(-9)}Z`:{seconds:""+n.seconds,nanos:n.nanoseconds}}function E2(o,n){return o.N?n.toBase64():n.toUint8Array()}function _h(o){return Pi(!!o),Mt.fromTimestamp(function(n){const c=so(n);return new Sn(c.seconds,c.nanos)}(o))}function S2(o,n){return function(c){return new ui(["projects",c.projectId,"databases",c.database])}(o).child("documents").child(n).canonicalString()}function Kv(o){const n=ui.fromString(o);return Pi(Qv(n)),n}function Pf(o,n){const c=Kv(n);if(c.get(1)!==o.databaseId.projectId)throw new ct(Ze.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+c.get(1)+" vs "+o.databaseId.projectId);if(c.get(3)!==o.databaseId.database)throw new ct(Ze.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+c.get(3)+" vs "+o.databaseId.database);return new at(Yv(c))}function cm(o,n){return S2(o.databaseId,n)}function I2(o){const n=Kv(o);return n.length===4?ui.emptyPath():Yv(n)}function ex(o){return new ui(["projects",o.databaseId.projectId,"databases",o.databaseId.database]).canonicalString()}function Yv(o){return Pi(o.length>4&&o.get(4)==="documents"),o.popFirst(5)}function A2(o,n){let c;if("targetChange"in n){n.targetChange;const m=function(W){return W==="NO_CHANGE"?0:W==="ADD"?1:W==="REMOVE"?2:W==="CURRENT"?3:W==="RESET"?4:kt()}(n.targetChange.targetChangeType||"NO_CHANGE"),v=n.targetChange.targetIds||[],S=function(W,ie){return W.N?(Pi(ie===void 0||typeof ie=="string"),Qi.fromBase64String(ie||"")):(Pi(ie===void 0||ie instanceof Uint8Array),Qi.fromUint8Array(ie||new Uint8Array))}(o,n.targetChange.resumeToken),L=n.targetChange.cause,a=L&&function(W){const ie=W.code===void 0?Ze.UNKNOWN:Zv(W.code);return new ct(ie,W.message||"")}(L);c=new Hv(m,v,S,a||null)}else if("documentChange"in n){n.documentChange;const m=n.documentChange;m.document,m.document.name,m.document.updateTime;const v=Pf(o,m.document.name),S=_h(m.document.updateTime),L=new fs({mapValue:{fields:m.document.fields}}),a=lr.newFoundDocument(v,S,L),W=m.targetIds||[],ie=m.removedTargetIds||[];c=new ud(W,ie,a.key,a)}else if("documentDelete"in n){n.documentDelete;const m=n.documentDelete;m.document;const v=Pf(o,m.document),S=m.readTime?_h(m.readTime):Mt.min(),L=lr.newNoDocument(v,S),a=m.removedTargetIds||[];c=new ud([],a,L.key,L)}else if("documentRemove"in n){n.documentRemove;const m=n.documentRemove;m.document;const v=Pf(o,m.document),S=m.removedTargetIds||[];c=new ud([],S,v,null)}else{if(!("filter"in n))return kt();{n.filter;const m=n.filter;m.targetId;const v=m.count||0,S=new f2(v),L=m.targetId;c=new Xv(L,S)}}return c}function C2(o,n){return{documents:[cm(o,n.path)]}}function M2(o,n){const c={structuredQuery:{}},m=n.path;n.collectionGroup!==null?(c.parent=cm(o,m),c.structuredQuery.from=[{collectionId:n.collectionGroup,allDescendants:!0}]):(c.parent=cm(o,m.popLast()),c.structuredQuery.from=[{collectionId:m.lastSegment()}]);const v=function(W){if(W.length===0)return;const ie=W.map(ge=>function(ue){if(ue.op==="=="){if(Vy(ue.value))return{unaryFilter:{field:Il(ue.field),op:"IS_NAN"}};if(Uy(ue.value))return{unaryFilter:{field:Il(ue.field),op:"IS_NULL"}}}else if(ue.op==="!="){if(Vy(ue.value))return{unaryFilter:{field:Il(ue.field),op:"IS_NOT_NAN"}};if(Uy(ue.value))return{unaryFilter:{field:Il(ue.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Il(ue.field),op:P2(ue.op),value:ue.value}}}(ge));return ie.length===1?ie[0]:{compositeFilter:{op:"AND",filters:ie}}}(n.filters);v&&(c.structuredQuery.where=v);const S=function(W){if(W.length!==0)return W.map(ie=>function(ge){return{field:Il(ge.field),direction:z2(ge.dir)}}(ie))}(n.orderBy);S&&(c.structuredQuery.orderBy=S);const L=function(W,ie){return W.N||$l(ie)?ie:{value:ie}}(o,n.limit);var a;return L!==null&&(c.structuredQuery.limit=L),n.startAt&&(c.structuredQuery.startAt={before:(a=n.startAt).inclusive,values:a.position}),n.endAt&&(c.structuredQuery.endAt=function(W){return{before:!W.inclusive,values:W.position}}(n.endAt)),c}function k2(o){let n=I2(o.parent);const c=o.structuredQuery,m=c.from?c.from.length:0;let v=null;if(m>0){Pi(m===1);const ge=c.from[0];ge.allDescendants?v=ge.collectionId:n=n.child(ge.collectionId)}let S=[];c.where&&(S=Jv(c.where));let L=[];c.orderBy&&(L=c.orderBy.map(ge=>function(ue){return new ih(Cl(ue.field),function(ze){switch(ze){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(ue.direction))}(ge)));let a=null;c.limit&&(a=function(ge){let ue;return ue=typeof ge=="object"?ge.value:ge,$l(ue)?null:ue}(c.limit));let W=null;c.startAt&&(W=function(ge){const ue=!!ge.before,ze=ge.values||[];return new Td(ze,ue)}(c.startAt));let ie=null;return c.endAt&&(ie=function(ge){const ue=!ge.before,ze=ge.values||[];return new Td(ze,ue)}(c.endAt)),e2(n,v,L,S,a,"F",W,ie)}function D2(o,n){const c=function(m,v){switch(v){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return kt()}}(0,n.purpose);return c==null?null:{"goog-listen-tags":c}}function Jv(o){return o?o.unaryFilter!==void 0?[R2(o)]:o.fieldFilter!==void 0?[L2(o)]:o.compositeFilter!==void 0?o.compositeFilter.filters.map(n=>Jv(n)).reduce((n,c)=>n.concat(c)):kt():[]}function z2(o){return v2[o]}function P2(o){return b2[o]}function Il(o){return{fieldPath:o.canonicalString()}}function Cl(o){return En.fromServerFormat(o.fieldPath)}function L2(o){return Br.create(Cl(o.fieldFilter.field),function(n){switch(n){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return kt()}}(o.fieldFilter.op),o.fieldFilter.value)}function R2(o){switch(o.unaryFilter.op){case"IS_NAN":const n=Cl(o.unaryFilter.field);return Br.create(n,"==",{doubleValue:NaN});case"IS_NULL":const c=Cl(o.unaryFilter.field);return Br.create(c,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const m=Cl(o.unaryFilter.field);return Br.create(m,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const v=Cl(o.unaryFilter.field);return Br.create(v,"!=",{nullValue:"NULL_VALUE"});default:return kt()}}function Qv(o){return o.length>=4&&o.get(0)==="projects"&&o.get(2)==="databases"}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const B2="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class F2{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(n){this.onCommittedListeners.push(n)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(n=>n())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $e{constructor(n){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,n(c=>{this.isDone=!0,this.result=c,this.nextCallback&&this.nextCallback(c)},c=>{this.isDone=!0,this.error=c,this.catchCallback&&this.catchCallback(c)})}catch(n){return this.next(void 0,n)}next(n,c){return this.callbackAttached&&kt(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(c,this.error):this.wrapSuccess(n,this.result):new $e((m,v)=>{this.nextCallback=S=>{this.wrapSuccess(n,S).next(m,v)},this.catchCallback=S=>{this.wrapFailure(c,S).next(m,v)}})}toPromise(){return new Promise((n,c)=>{this.next(n,c)})}wrapUserFunction(n){try{const c=n();return c instanceof $e?c:$e.resolve(c)}catch(c){return $e.reject(c)}}wrapSuccess(n,c){return n?this.wrapUserFunction(()=>n(c)):$e.resolve(c)}wrapFailure(n,c){return n?this.wrapUserFunction(()=>n(c)):$e.reject(c)}static resolve(n){return new $e((c,m)=>{c(n)})}static reject(n){return new $e((c,m)=>{m(n)})}static waitFor(n){return new $e((c,m)=>{let v=0,S=0,L=!1;n.forEach(a=>{++v,a.next(()=>{++S,L&&S===v&&c()},W=>m(W))}),L=!0,S===v&&c()})}static or(n){let c=$e.resolve(!1);for(const m of n)c=c.next(v=>v?$e.resolve(v):m());return c}static forEach(n,c){const m=[];return n.forEach((v,S)=>{m.push(c.call(this,v,S))}),this.waitFor(m)}}function Ch(o){return o.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class O2{constructor(n,c,m,v){this.batchId=n,this.localWriteTime=c,this.baseMutations=m,this.mutations=v}applyToRemoteDocument(n,c){const m=c.mutationResults;for(let v=0;v<this.mutations.length;v++){const S=this.mutations[v];S.key.isEqual(n.key)&&p2(S,n,m[v])}}applyToLocalView(n){for(const c of this.baseMutations)c.key.isEqual(n.key)&&am(c,n,this.localWriteTime);for(const c of this.mutations)c.key.isEqual(n.key)&&am(c,n,this.localWriteTime)}applyToLocalDocumentSet(n){this.mutations.forEach(c=>{const m=n.get(c.key),v=m;this.applyToLocalView(v),m.isValidDocument()||v.convertToNoDocument(Mt.min())})}keys(){return this.mutations.reduce((n,c)=>n.add(c.key),di())}isEqual(n){return this.batchId===n.batchId&&uh(this.mutations,n.mutations,(c,m)=>Zy(c,m))&&uh(this.baseMutations,n.baseMutations,(c,m)=>Zy(c,m))}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class N2{constructor(n,c){this.largestBatchId=n,this.mutation=c}getKey(){return this.mutation.key}isEqual(n){return n!==null&&this.mutation===n.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class aa{constructor(n,c,m,v,S=Mt.min(),L=Mt.min(),a=Qi.EMPTY_BYTE_STRING){this.target=n,this.targetId=c,this.purpose=m,this.sequenceNumber=v,this.snapshotVersion=S,this.lastLimboFreeSnapshotVersion=L,this.resumeToken=a}withSequenceNumber(n){return new aa(this.target,this.targetId,this.purpose,n,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(n,c){return new aa(this.target,this.targetId,this.purpose,this.sequenceNumber,c,this.lastLimboFreeSnapshotVersion,n)}withLastLimboFreeSnapshotVersion(n){return new aa(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,n,this.resumeToken)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class U2{constructor(n){this.Jt=n}}function V2(o){const n=k2({parent:o.parent,structuredQuery:o.structuredQuery});return o.limitType==="LAST"?n2(n,n.limit,"L"):n}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class j2{constructor(){this.qe=new $2}addToCollectionParentIndex(n,c){return this.qe.add(c),$e.resolve()}getCollectionParents(n,c){return $e.resolve(this.qe.getEntries(c))}addFieldIndex(n,c){return $e.resolve()}deleteFieldIndex(n,c){return $e.resolve()}getDocumentsMatchingTarget(n,c){return $e.resolve(null)}getFieldIndex(n,c){return $e.resolve(null)}getFieldIndexes(n,c){return $e.resolve([])}getNextCollectionGroupToUpdate(n){return $e.resolve(null)}updateCollectionGroup(n,c,m){return $e.resolve()}updateIndexEntries(n,c){return $e.resolve()}}class $2{constructor(){this.index={}}add(n){const c=n.lastSegment(),m=n.popLast(),v=this.index[c]||new Ji(ui.comparator),S=!v.has(m);return this.index[c]=v.add(m),S}has(n){const c=n.lastSegment(),m=n.popLast(),v=this.index[c];return v&&v.has(m)}getEntries(n){return(this.index[n]||new Ji(ui.comparator)).toArray()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fl{constructor(n){this.wn=n}next(){return this.wn+=2,this.wn}static mn(){return new Fl(0)}static gn(){return new Fl(-1)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Zm(o){if(o.code!==Ze.FAILED_PRECONDITION||o.message!==B2)throw o;rt("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class G2{constructor(){this.changes=new Gl(n=>n.toString(),(n,c)=>n.isEqual(c)),this.changesApplied=!1}addEntry(n){this.assertNotApplied(),this.changes.set(n.key,n)}removeEntry(n,c){this.assertNotApplied(),this.changes.set(n,lr.newInvalidDocument(n).setReadTime(c))}getEntry(n,c){this.assertNotApplied();const m=this.changes.get(c);return m!==void 0?$e.resolve(m):this.getFromCache(n,c)}getEntries(n,c){return this.getAllFromCache(n,c)}apply(n){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(n)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class q2{constructor(n,c,m){this.fs=n,this.$s=c,this.indexManager=m}Bs(n,c){return this.$s.getAllMutationBatchesAffectingDocumentKey(n,c).next(m=>this.Ls(n,c,m))}Ls(n,c,m){return this.fs.getEntry(n,c).next(v=>{for(const S of m)S.applyToLocalView(v);return v})}Us(n,c){n.forEach((m,v)=>{for(const S of c)S.applyToLocalView(v)})}qs(n,c){return this.fs.getEntries(n,c).next(m=>this.Gs(n,m).next(()=>m))}Gs(n,c){return this.$s.getAllMutationBatchesAffectingDocumentKeys(n,c).next(m=>this.Us(c,m))}Ks(n,c,m){return function(v){return at.isDocumentKey(v.path)&&v.collectionGroup===null&&v.filters.length===0}(c)?this.Qs(n,c.path):r2(c)?this.js(n,c,m):this.Ws(n,c,m)}Qs(n,c){return this.Bs(n,new at(c)).next(m=>{let v=lm();return m.isFoundDocument()&&(v=v.insert(m.key,m)),v})}js(n,c,m){const v=c.collectionGroup;let S=lm();return this.indexManager.getCollectionParents(n,v).next(L=>$e.forEach(L,a=>{const W=function(ie,ge){return new Gd(ge,null,ie.explicitOrderBy.slice(),ie.filters.slice(),ie.limit,ie.limitType,ie.startAt,ie.endAt)}(c,a.child(v));return this.Ws(n,W,m).next(ie=>{ie.forEach((ge,ue)=>{S=S.insert(ge,ue)})})}).next(()=>S))}Ws(n,c,m){let v;return this.fs.getAllFromCollection(n,c.path,m).next(S=>(v=S,this.$s.getAllMutationBatchesAffectingQuery(n,c))).next(S=>{for(const L of S)for(const a of L.mutations){const W=a.key;let ie=v.get(W);ie==null&&(ie=lr.newInvalidDocument(W),v=v.insert(W,ie)),am(a,ie,L.localWriteTime),ie.isFoundDocument()||(v=v.remove(W))}}).next(()=>(v.forEach((S,L)=>{qm(c,L)||(v=v.remove(S))}),v))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wm{constructor(n,c,m,v){this.targetId=n,this.fromCache=c,this.zs=m,this.Hs=v}static Js(n,c){let m=di(),v=di();for(const S of c.docChanges)switch(S.type){case 0:m=m.add(S.doc.key);break;case 1:v=v.add(S.doc.key)}return new Wm(n,c.fromCache,m,v)}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Z2{Ys(n){this.Xs=n}Ks(n,c,m,v){return function(S){return S.filters.length===0&&S.limit===null&&S.startAt==null&&S.endAt==null&&(S.explicitOrderBy.length===0||S.explicitOrderBy.length===1&&S.explicitOrderBy[0].field.isKeyField())}(c)||m.isEqual(Mt.min())?this.Zs(n,c):this.Xs.qs(n,v).next(S=>{const L=this.ti(c,S);return(cd(c)||rm(c))&&this.ei(c.limitType,L,v,m)?this.Zs(n,c):(By()<=Zt.DEBUG&&rt("QueryEngine","Re-using previous result from %s to execute query: %s",m.toString(),nm(c)),this.Xs.Ks(n,c,VE(m,-1)).next(a=>(L.forEach(W=>{a=a.insert(W.key,W)}),a)))})}ti(n,c){let m=new Ji(Ov(n));return c.forEach((v,S)=>{qm(n,S)&&(m=m.add(S))}),m}ei(n,c,m,v){if(m.size!==c.size)return!0;const S=n==="F"?c.last():c.first();return!!S&&(S.hasPendingWrites||S.version.compareTo(v)>0)}Zs(n,c){return By()<=Zt.DEBUG&&rt("QueryEngine","Using full collection scan to execute query:",nm(c)),this.Xs.Ks(n,c,Bl.min())}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class W2{constructor(n,c,m,v){this.persistence=n,this.ni=c,this.M=v,this.si=new er(Xt),this.ii=new Gl(S=>jm(S),$m),this.ri=new Map,this.oi=n.getRemoteDocumentCache(),this.ls=n.getTargetCache(),this.ds=n.getBundleCache(),this.ui(m)}ui(n){this.indexManager=this.persistence.getIndexManager(n),this.$s=this.persistence.getMutationQueue(n,this.indexManager),this.ai=new q2(this.oi,this.$s,this.indexManager),this.oi.setIndexManager(this.indexManager),this.ni.Ys(this.ai)}collectGarbage(n){return this.persistence.runTransaction("Collect garbage","readwrite-primary",c=>n.collect(c,this.si))}}function X2(o,n,c,m){return new W2(o,n,c,m)}async function e0(o,n){const c=Ut(o);return await c.persistence.runTransaction("Handle user change","readonly",m=>{let v;return c.$s.getAllMutationBatches(m).next(S=>(v=S,c.ui(n),c.$s.getAllMutationBatches(m))).next(S=>{const L=[],a=[];let W=di();for(const ie of v){L.push(ie.batchId);for(const ge of ie.mutations)W=W.add(ge.key)}for(const ie of S){a.push(ie.batchId);for(const ge of ie.mutations)W=W.add(ge.key)}return c.ai.qs(m,W).next(ie=>({ci:ie,removedBatchIds:L,addedBatchIds:a}))})})}function t0(o){const n=Ut(o);return n.persistence.runTransaction("Get last remote snapshot version","readonly",c=>n.ls.getLastRemoteSnapshotVersion(c))}function H2(o,n){const c=Ut(o),m=n.snapshotVersion;let v=c.si;return c.persistence.runTransaction("Apply remote event","readwrite-primary",S=>{const L=c.oi.newChangeBuffer({trackRemovals:!0});v=c.si;const a=[];n.targetChanges.forEach((ie,ge)=>{const ue=v.get(ge);if(!ue)return;a.push(c.ls.removeMatchingKeys(S,ie.removedDocuments,ge).next(()=>c.ls.addMatchingKeys(S,ie.addedDocuments,ge)));let ze=ue.withSequenceNumber(S.currentSequenceNumber);n.targetMismatches.has(ge)?ze=ze.withResumeToken(Qi.EMPTY_BYTE_STRING,Mt.min()).withLastLimboFreeSnapshotVersion(Mt.min()):ie.resumeToken.approximateByteSize()>0&&(ze=ze.withResumeToken(ie.resumeToken,m)),v=v.insert(ge,ze),function(fe,it,dt){return fe.resumeToken.approximateByteSize()===0||it.snapshotVersion.toMicroseconds()-fe.snapshotVersion.toMicroseconds()>=3e8?!0:dt.addedDocuments.size+dt.modifiedDocuments.size+dt.removedDocuments.size>0}(ue,ze,ie)&&a.push(c.ls.updateTargetData(S,ze))});let W=fa();if(n.documentUpdates.forEach(ie=>{n.resolvedLimboDocuments.has(ie)&&a.push(c.persistence.referenceDelegate.updateLimboDocument(S,ie))}),a.push(K2(S,L,n.documentUpdates).next(ie=>{W=ie})),!m.isEqual(Mt.min())){const ie=c.ls.getLastRemoteSnapshotVersion(S).next(ge=>c.ls.setTargetsMetadata(S,S.currentSequenceNumber,m));a.push(ie)}return $e.waitFor(a).next(()=>L.apply(S)).next(()=>c.ai.Gs(S,W)).next(()=>W)}).then(S=>(c.si=v,S))}function K2(o,n,c){let m=di();return c.forEach(v=>m=m.add(v)),n.getEntries(o,m).next(v=>{let S=fa();return c.forEach((L,a)=>{const W=v.get(L);a.isNoDocument()&&a.version.isEqual(Mt.min())?(n.removeEntry(L,a.readTime),S=S.insert(L,a)):!W.isValidDocument()||a.version.compareTo(W.version)>0||a.version.compareTo(W.version)===0&&W.hasPendingWrites?(n.addEntry(a),S=S.insert(L,a)):rt("LocalStore","Ignoring outdated watch update for ",L,". Current version:",W.version," Watch version:",a.version)}),S})}function Y2(o,n){const c=Ut(o);return c.persistence.runTransaction("Allocate target","readwrite",m=>{let v;return c.ls.getTargetData(m,n).next(S=>S?(v=S,$e.resolve(v)):c.ls.allocateTargetId(m).next(L=>(v=new aa(n,L,0,m.currentSequenceNumber),c.ls.addTargetData(m,v).next(()=>v))))}).then(m=>{const v=c.si.get(m.targetId);return(v===null||m.snapshotVersion.compareTo(v.snapshotVersion)>0)&&(c.si=c.si.insert(m.targetId,m),c.ii.set(n,m.targetId)),m})}async function hm(o,n,c){const m=Ut(o),v=m.si.get(n),S=c?"readwrite":"readwrite-primary";try{c||await m.persistence.runTransaction("Release target",S,L=>m.persistence.referenceDelegate.removeTarget(L,v))}catch(L){if(!Ch(L))throw L;rt("LocalStore",`Failed to update sequence numbers for target ${n}: ${L}`)}m.si=m.si.remove(n),m.ii.delete(v.target)}function tx(o,n,c){const m=Ut(o);let v=Mt.min(),S=di();return m.persistence.runTransaction("Execute query","readonly",L=>function(a,W,ie){const ge=Ut(a),ue=ge.ii.get(ie);return ue!==void 0?$e.resolve(ge.si.get(ue)):ge.ls.getTargetData(W,ie)}(m,L,pa(n)).next(a=>{if(a)return v=a.lastLimboFreeSnapshotVersion,m.ls.getMatchingKeysForTargetId(L,a.targetId).next(W=>{S=W})}).next(()=>m.ni.Ks(L,n,c?v:Mt.min(),c?S:di())).next(a=>(J2(m,s2(n),a),{documents:a,hi:S})))}function J2(o,n,c){let m=Mt.min();c.forEach((v,S)=>{S.readTime.compareTo(m)>0&&(m=S.readTime)}),o.ri.set(n,m)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Q2{constructor(n){this.M=n,this._i=new Map,this.wi=new Map}getBundleMetadata(n,c){return $e.resolve(this._i.get(c))}saveBundleMetadata(n,c){var m;return this._i.set(c.id,{id:(m=c).id,version:m.version,createTime:_h(m.createTime)}),$e.resolve()}getNamedQuery(n,c){return $e.resolve(this.wi.get(c))}saveNamedQuery(n,c){return this.wi.set(c.name,function(m){return{name:m.name,query:V2(m.bundledQuery),readTime:_h(m.readTime)}}(c)),$e.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class eS{constructor(){this.overlays=new er(at.comparator),this.mi=new Map}getOverlay(n,c){return $e.resolve(this.overlays.get(c))}saveOverlays(n,c,m){return m.forEach((v,S)=>{this.Xt(n,c,S)}),$e.resolve()}removeOverlaysForBatchId(n,c,m){const v=this.mi.get(m);return v!==void 0&&(v.forEach(S=>this.overlays=this.overlays.remove(S)),this.mi.delete(m)),$e.resolve()}getOverlaysForCollection(n,c,m){const v=zf(),S=c.length+1,L=new at(c.child("")),a=this.overlays.getIteratorFrom(L);for(;a.hasNext();){const W=a.getNext().value,ie=W.getKey();if(!c.isPrefixOf(ie.path))break;ie.path.length===S&&W.largestBatchId>m&&v.set(W.getKey(),W)}return $e.resolve(v)}getOverlaysForCollectionGroup(n,c,m,v){let S=new er((ie,ge)=>ie-ge);const L=this.overlays.getIterator();for(;L.hasNext();){const ie=L.getNext().value;if(ie.getKey().getCollectionGroup()===c&&ie.largestBatchId>m){let ge=S.get(ie.largestBatchId);ge===null&&(ge=zf(),S=S.insert(ie.largestBatchId,ge)),ge.set(ie.getKey(),ie)}}const a=zf(),W=S.getIterator();for(;W.hasNext()&&(W.getNext().value.forEach((ie,ge)=>a.set(ie,ge)),!(a.size()>=v)););return $e.resolve(a)}Xt(n,c,m){if(m===null)return;const v=this.overlays.get(m.key);if(v!==null){const L=this.mi.get(v.largestBatchId).delete(m.key);this.mi.set(v.largestBatchId,L)}this.overlays=this.overlays.insert(m.key,new N2(c,m));let S=this.mi.get(c);S===void 0&&(S=di(),this.mi.set(c,S)),this.mi.set(c,S.add(m.key))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xm{constructor(){this.gi=new Ji(Vi.yi),this.pi=new Ji(Vi.Ii)}isEmpty(){return this.gi.isEmpty()}addReference(n,c){const m=new Vi(n,c);this.gi=this.gi.add(m),this.pi=this.pi.add(m)}Ti(n,c){n.forEach(m=>this.addReference(m,c))}removeReference(n,c){this.Ei(new Vi(n,c))}Ai(n,c){n.forEach(m=>this.removeReference(m,c))}Ri(n){const c=new at(new ui([])),m=new Vi(c,n),v=new Vi(c,n+1),S=[];return this.pi.forEachInRange([m,v],L=>{this.Ei(L),S.push(L.key)}),S}bi(){this.gi.forEach(n=>this.Ei(n))}Ei(n){this.gi=this.gi.delete(n),this.pi=this.pi.delete(n)}Pi(n){const c=new at(new ui([])),m=new Vi(c,n),v=new Vi(c,n+1);let S=di();return this.pi.forEachInRange([m,v],L=>{S=S.add(L.key)}),S}containsKey(n){const c=new Vi(n,0),m=this.gi.firstAfterOrEqual(c);return m!==null&&n.isEqual(m.key)}}class Vi{constructor(n,c){this.key=n,this.Vi=c}static yi(n,c){return at.comparator(n.key,c.key)||Xt(n.Vi,c.Vi)}static Ii(n,c){return Xt(n.Vi,c.Vi)||at.comparator(n.key,c.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tS{constructor(n,c){this.indexManager=n,this.referenceDelegate=c,this.$s=[],this.vi=1,this.Si=new Ji(Vi.yi)}checkEmpty(n){return $e.resolve(this.$s.length===0)}addMutationBatch(n,c,m,v){const S=this.vi;this.vi++,this.$s.length>0&&this.$s[this.$s.length-1];const L=new O2(S,c,m,v);this.$s.push(L);for(const a of v)this.Si=this.Si.add(new Vi(a.key,S)),this.indexManager.addToCollectionParentIndex(n,a.key.path.popLast());return $e.resolve(L)}lookupMutationBatch(n,c){return $e.resolve(this.Di(c))}getNextMutationBatchAfterBatchId(n,c){const m=c+1,v=this.Ci(m),S=v<0?0:v;return $e.resolve(this.$s.length>S?this.$s[S]:null)}getHighestUnacknowledgedBatchId(){return $e.resolve(this.$s.length===0?-1:this.vi-1)}getAllMutationBatches(n){return $e.resolve(this.$s.slice())}getAllMutationBatchesAffectingDocumentKey(n,c){const m=new Vi(c,0),v=new Vi(c,Number.POSITIVE_INFINITY),S=[];return this.Si.forEachInRange([m,v],L=>{const a=this.Di(L.Vi);S.push(a)}),$e.resolve(S)}getAllMutationBatchesAffectingDocumentKeys(n,c){let m=new Ji(Xt);return c.forEach(v=>{const S=new Vi(v,0),L=new Vi(v,Number.POSITIVE_INFINITY);this.Si.forEachInRange([S,L],a=>{m=m.add(a.Vi)})}),$e.resolve(this.xi(m))}getAllMutationBatchesAffectingQuery(n,c){const m=c.path,v=m.length+1;let S=m;at.isDocumentKey(S)||(S=S.child(""));const L=new Vi(new at(S),0);let a=new Ji(Xt);return this.Si.forEachWhile(W=>{const ie=W.key.path;return!!m.isPrefixOf(ie)&&(ie.length===v&&(a=a.add(W.Vi)),!0)},L),$e.resolve(this.xi(a))}xi(n){const c=[];return n.forEach(m=>{const v=this.Di(m);v!==null&&c.push(v)}),c}removeMutationBatch(n,c){Pi(this.Ni(c.batchId,"removed")===0),this.$s.shift();let m=this.Si;return $e.forEach(c.mutations,v=>{const S=new Vi(v.key,c.batchId);return m=m.delete(S),this.referenceDelegate.markPotentiallyOrphaned(n,v.key)}).next(()=>{this.Si=m})}dn(n){}containsKey(n,c){const m=new Vi(c,0),v=this.Si.firstAfterOrEqual(m);return $e.resolve(c.isEqual(v&&v.key))}performConsistencyCheck(n){return this.$s.length,$e.resolve()}Ni(n,c){return this.Ci(n)}Ci(n){return this.$s.length===0?0:n-this.$s[0].batchId}Di(n){const c=this.Ci(n);return c<0||c>=this.$s.length?null:this.$s[c]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class iS{constructor(n){this.ki=n,this.docs=new er(at.comparator),this.size=0}setIndexManager(n){this.indexManager=n}addEntry(n,c){const m=c.key,v=this.docs.get(m),S=v?v.size:0,L=this.ki(c);return this.docs=this.docs.insert(m,{document:c.mutableCopy(),size:L}),this.size+=L-S,this.indexManager.addToCollectionParentIndex(n,m.path.popLast())}removeEntry(n){const c=this.docs.get(n);c&&(this.docs=this.docs.remove(n),this.size-=c.size)}getEntry(n,c){const m=this.docs.get(c);return $e.resolve(m?m.document.mutableCopy():lr.newInvalidDocument(c))}getEntries(n,c){let m=fa();return c.forEach(v=>{const S=this.docs.get(v);m=m.insert(v,S?S.document.mutableCopy():lr.newInvalidDocument(v))}),$e.resolve(m)}getAllFromCollection(n,c,m){let v=fa();const S=new at(c.child("")),L=this.docs.getIteratorFrom(S);for(;L.hasNext();){const{key:a,value:{document:W}}=L.getNext();if(!c.isPrefixOf(a.path))break;a.path.length>c.length+1||$E(jE(W),m)<=0||(v=v.insert(W.key,W.mutableCopy()))}return $e.resolve(v)}getAllFromCollectionGroup(n,c,m,v){kt()}Mi(n,c){return $e.forEach(this.docs,m=>c(m))}newChangeBuffer(n){return new rS(this)}getSize(n){return $e.resolve(this.size)}}class rS extends G2{constructor(n){super(),this.qn=n}applyChanges(n){const c=[];return this.changes.forEach((m,v)=>{v.isValidDocument()?c.push(this.qn.addEntry(n,v)):this.qn.removeEntry(m)}),$e.waitFor(c)}getFromCache(n,c){return this.qn.getEntry(n,c)}getAllFromCache(n,c){return this.qn.getEntries(n,c)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nS{constructor(n){this.persistence=n,this.Oi=new Gl(c=>jm(c),$m),this.lastRemoteSnapshotVersion=Mt.min(),this.highestTargetId=0,this.Fi=0,this.$i=new Xm,this.targetCount=0,this.Bi=Fl.mn()}forEachTarget(n,c){return this.Oi.forEach((m,v)=>c(v)),$e.resolve()}getLastRemoteSnapshotVersion(n){return $e.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(n){return $e.resolve(this.Fi)}allocateTargetId(n){return this.highestTargetId=this.Bi.next(),$e.resolve(this.highestTargetId)}setTargetsMetadata(n,c,m){return m&&(this.lastRemoteSnapshotVersion=m),c>this.Fi&&(this.Fi=c),$e.resolve()}In(n){this.Oi.set(n.target,n);const c=n.targetId;c>this.highestTargetId&&(this.Bi=new Fl(c),this.highestTargetId=c),n.sequenceNumber>this.Fi&&(this.Fi=n.sequenceNumber)}addTargetData(n,c){return this.In(c),this.targetCount+=1,$e.resolve()}updateTargetData(n,c){return this.In(c),$e.resolve()}removeTargetData(n,c){return this.Oi.delete(c.target),this.$i.Ri(c.targetId),this.targetCount-=1,$e.resolve()}removeTargets(n,c,m){let v=0;const S=[];return this.Oi.forEach((L,a)=>{a.sequenceNumber<=c&&m.get(a.targetId)===null&&(this.Oi.delete(L),S.push(this.removeMatchingKeysForTargetId(n,a.targetId)),v++)}),$e.waitFor(S).next(()=>v)}getTargetCount(n){return $e.resolve(this.targetCount)}getTargetData(n,c){const m=this.Oi.get(c)||null;return $e.resolve(m)}addMatchingKeys(n,c,m){return this.$i.Ti(c,m),$e.resolve()}removeMatchingKeys(n,c,m){this.$i.Ai(c,m);const v=this.persistence.referenceDelegate,S=[];return v&&c.forEach(L=>{S.push(v.markPotentiallyOrphaned(n,L))}),$e.waitFor(S)}removeMatchingKeysForTargetId(n,c){return this.$i.Ri(c),$e.resolve()}getMatchingKeysForTargetId(n,c){const m=this.$i.Pi(c);return $e.resolve(m)}containsKey(n,c){return $e.resolve(this.$i.containsKey(c))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sS{constructor(n,c){this.Li={},this.overlays={},this.ts=new Um(0),this.es=!1,this.es=!0,this.referenceDelegate=n(this),this.ls=new nS(this),this.indexManager=new j2,this.fs=function(m){return new iS(m)}(m=>this.referenceDelegate.Ui(m)),this.M=new U2(c),this.ds=new Q2(this.M)}start(){return Promise.resolve()}shutdown(){return this.es=!1,Promise.resolve()}get started(){return this.es}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(n){return this.indexManager}getDocumentOverlayCache(n){let c=this.overlays[n.toKey()];return c||(c=new eS,this.overlays[n.toKey()]=c),c}getMutationQueue(n,c){let m=this.Li[n.toKey()];return m||(m=new tS(c,this.referenceDelegate),this.Li[n.toKey()]=m),m}getTargetCache(){return this.ls}getRemoteDocumentCache(){return this.fs}getBundleCache(){return this.ds}runTransaction(n,c,m){rt("MemoryPersistence","Starting transaction:",n);const v=new oS(this.ts.next());return this.referenceDelegate.qi(),m(v).next(S=>this.referenceDelegate.Gi(v).next(()=>S)).toPromise().then(S=>(v.raiseOnCommittedEvent(),S))}Ki(n,c){return $e.or(Object.values(this.Li).map(m=>()=>m.containsKey(n,c)))}}class oS extends F2{constructor(n){super(),this.currentSequenceNumber=n}}class Hm{constructor(n){this.persistence=n,this.Qi=new Xm,this.ji=null}static Wi(n){return new Hm(n)}get zi(){if(this.ji)return this.ji;throw kt()}addReference(n,c,m){return this.Qi.addReference(m,c),this.zi.delete(m.toString()),$e.resolve()}removeReference(n,c,m){return this.Qi.removeReference(m,c),this.zi.add(m.toString()),$e.resolve()}markPotentiallyOrphaned(n,c){return this.zi.add(c.toString()),$e.resolve()}removeTarget(n,c){this.Qi.Ri(c.targetId).forEach(v=>this.zi.add(v.toString()));const m=this.persistence.getTargetCache();return m.getMatchingKeysForTargetId(n,c.targetId).next(v=>{v.forEach(S=>this.zi.add(S.toString()))}).next(()=>m.removeTargetData(n,c))}qi(){this.ji=new Set}Gi(n){const c=this.persistence.getRemoteDocumentCache().newChangeBuffer();return $e.forEach(this.zi,m=>{const v=at.fromPath(m);return this.Hi(n,v).next(S=>{S||c.removeEntry(v,Mt.min())})}).next(()=>(this.ji=null,c.apply(n)))}updateLimboDocument(n,c){return this.Hi(n,c).next(m=>{m?this.zi.delete(c.toString()):this.zi.add(c.toString())})}Ui(n){return 0}Hi(n,c){return $e.or([()=>$e.resolve(this.Qi.containsKey(c)),()=>this.persistence.getTargetCache().containsKey(n,c),()=>this.persistence.Ki(n,c)])}}class ix{constructor(){this.activeTargetIds=Wv()}Xi(n){this.activeTargetIds=this.activeTargetIds.add(n)}Zi(n){this.activeTargetIds=this.activeTargetIds.delete(n)}Yi(){const n={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(n)}}class aS{constructor(){this.Fr=new ix,this.$r={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(n){}updateMutationState(n,c,m){}addLocalQueryTarget(n){return this.Fr.Xi(n),this.$r[n]||"not-current"}updateQueryState(n,c,m){this.$r[n]=c}removeLocalQueryTarget(n){this.Fr.Zi(n)}isLocalQueryTarget(n){return this.Fr.activeTargetIds.has(n)}clearQueryState(n){delete this.$r[n]}getAllActiveQueryTargets(){return this.Fr.activeTargetIds}isActiveQueryTarget(n){return this.Fr.activeTargetIds.has(n)}start(){return this.Fr=new ix,Promise.resolve()}handleUserChange(n,c,m){}setOnlineState(n){}shutdown(){}writeSequenceNumber(n){}notifyBundleLoaded(n){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lS{Br(n){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rx{constructor(){this.Lr=()=>this.Ur(),this.qr=()=>this.Gr(),this.Kr=[],this.Qr()}Br(n){this.Kr.push(n)}shutdown(){window.removeEventListener("online",this.Lr),window.removeEventListener("offline",this.qr)}Qr(){window.addEventListener("online",this.Lr),window.addEventListener("offline",this.qr)}Ur(){rt("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const n of this.Kr)n(0)}Gr(){rt("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const n of this.Kr)n(1)}static vt(){return typeof window!="undefined"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cS={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hS{constructor(n){this.jr=n.jr,this.Wr=n.Wr}zr(n){this.Hr=n}Jr(n){this.Yr=n}onMessage(n){this.Xr=n}close(){this.Wr()}send(n){this.jr(n)}Zr(){this.Hr()}eo(n){this.Yr(n)}no(n){this.Xr(n)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uS extends class{constructor(n){this.databaseInfo=n,this.databaseId=n.databaseId;const c=n.ssl?"https":"http";this.so=c+"://"+n.host,this.io="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}ro(n,c,m,v,S){const L=this.oo(n,c);rt("RestConnection","Sending: ",L,m);const a={};return this.uo(a,v,S),this.ao(n,L,a,m).then(W=>(rt("RestConnection","Received: ",W),W),W=>{throw Fy("RestConnection",`${n} failed with error: `,W,"url: ",L,"request:",m),W})}co(n,c,m,v,S){return this.ro(n,c,m,v,S)}uo(n,c,m){n["X-Goog-Api-Client"]="gl-js/ fire/"+jl,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),c&&c.headers.forEach((v,S)=>n[S]=v),m&&m.headers.forEach((v,S)=>n[S]=v)}oo(n,c){const m=cS[n];return`${this.so}/v1/${c}:${m}`}}{constructor(n){super(n),this.forceLongPolling=n.forceLongPolling,this.autoDetectLongPolling=n.autoDetectLongPolling,this.useFetchStreams=n.useFetchStreams}ao(n,c,m,v){return new Promise((S,L)=>{const a=new AE;a.listenOnce(EE.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case kf.NO_ERROR:const ie=a.getResponseJson();rt("Connection","XHR received:",JSON.stringify(ie)),S(ie);break;case kf.TIMEOUT:rt("Connection",'RPC "'+n+'" timed out'),L(new ct(Ze.DEADLINE_EXCEEDED,"Request time out"));break;case kf.HTTP_ERROR:const ge=a.getStatus();if(rt("Connection",'RPC "'+n+'" failed with status:',ge,"response text:",a.getResponseText()),ge>0){const ue=a.getResponseJson().error;if(ue&&ue.status&&ue.message){const ze=function(fe){const it=fe.toLowerCase().replace(/_/g,"-");return Object.values(Ze).indexOf(it)>=0?it:Ze.UNKNOWN}(ue.status);L(new ct(ze,ue.message))}else L(new ct(Ze.UNKNOWN,"Server responded with status "+a.getStatus()))}else L(new ct(Ze.UNAVAILABLE,"Connection failed."));break;default:kt()}}finally{rt("Connection",'RPC "'+n+'" completed.')}});const W=JSON.stringify(v);a.send(c,"POST",W,m,15)})}ho(n,c,m){const v=[this.so,"/","google.firestore.v1.Firestore","/",n,"/channel"],S=wE(),L=TE(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(a.xmlHttpFactory=new IE({})),this.uo(a.initMessageHeaders,c,m),hw()||dw()||pw()||fw()||mw()||uw()||(a.httpHeadersOverwriteParam="$httpHeaders");const W=v.join("");rt("Connection","Creating WebChannel: "+W,a);const ie=S.createWebChannel(W,a);let ge=!1,ue=!1;const ze=new hS({jr:it=>{ue?rt("Connection","Not sending because WebChannel is closed:",it):(ge||(rt("Connection","Opening WebChannel transport."),ie.open(),ge=!0),rt("Connection","WebChannel sending:",it),ie.send(it))},Wr:()=>ie.close()}),fe=(it,dt,pi)=>{it.listen(dt,ti=>{try{pi(ti)}catch($i){setTimeout(()=>{throw $i},0)}})};return fe(ie,sd.EventType.OPEN,()=>{ue||rt("Connection","WebChannel transport opened.")}),fe(ie,sd.EventType.CLOSE,()=>{ue||(ue=!0,rt("Connection","WebChannel transport closed"),ze.eo())}),fe(ie,sd.EventType.ERROR,it=>{ue||(ue=!0,Fy("Connection","WebChannel transport errored:",it),ze.eo(new ct(Ze.UNAVAILABLE,"The operation could not be completed")))}),fe(ie,sd.EventType.MESSAGE,it=>{var dt;if(!ue){const pi=it.data[0];Pi(!!pi);const ti=pi,$i=ti.error||((dt=ti[0])===null||dt===void 0?void 0:dt.error);if($i){rt("Connection","WebChannel received error:",$i);const Gi=$i.status;let Ti=function(br){const Xr=Di[br];if(Xr!==void 0)return Zv(Xr)}(Gi),cn=$i.message;Ti===void 0&&(Ti=Ze.INTERNAL,cn="Unknown error status: "+Gi+" with message "+$i.message),ue=!0,ze.eo(new ct(Ti,cn)),ie.close()}else rt("Connection","WebChannel received:",pi),ze.no(pi)}}),fe(L,SE.STAT_EVENT,it=>{it.stat===Ly.PROXY?rt("Connection","Detected buffering proxy"):it.stat===Ly.NOPROXY&&rt("Connection","Detected no buffering proxy")}),setTimeout(()=>{ze.Zr()},0),ze}}function Lf(){return typeof document!="undefined"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function i0(o){return new w2(o,!0)}class r0{constructor(n,c,m=1e3,v=1.5,S=6e4){this.Jn=n,this.timerId=c,this.lo=m,this.fo=v,this._o=S,this.wo=0,this.mo=null,this.yo=Date.now(),this.reset()}reset(){this.wo=0}po(){this.wo=this._o}Io(n){this.cancel();const c=Math.floor(this.wo+this.To()),m=Math.max(0,Date.now()-this.yo),v=Math.max(0,c-m);v>0&&rt("ExponentialBackoff",`Backing off for ${v} ms (base delay: ${this.wo} ms, delay with jitter: ${c} ms, last attempt: ${m} ms ago)`),this.mo=this.Jn.enqueueAfterDelay(this.timerId,v,()=>(this.yo=Date.now(),n())),this.wo*=this.fo,this.wo<this.lo&&(this.wo=this.lo),this.wo>this._o&&(this.wo=this._o)}Eo(){this.mo!==null&&(this.mo.skipDelay(),this.mo=null)}cancel(){this.mo!==null&&(this.mo.cancel(),this.mo=null)}To(){return(Math.random()-.5)*this.wo}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dS{constructor(n,c,m,v,S,L,a,W){this.Jn=n,this.Ao=m,this.Ro=v,this.bo=S,this.authCredentialsProvider=L,this.appCheckCredentialsProvider=a,this.listener=W,this.state=0,this.Po=0,this.Vo=null,this.vo=null,this.stream=null,this.So=new r0(n,c)}Do(){return this.state===1||this.state===5||this.Co()}Co(){return this.state===2||this.state===3}start(){this.state!==4?this.auth():this.xo()}async stop(){this.Do()&&await this.close(0)}No(){this.state=0,this.So.reset()}ko(){this.Co()&&this.Vo===null&&(this.Vo=this.Jn.enqueueAfterDelay(this.Ao,6e4,()=>this.Mo()))}Oo(n){this.Fo(),this.stream.send(n)}async Mo(){if(this.Co())return this.close(0)}Fo(){this.Vo&&(this.Vo.cancel(),this.Vo=null)}$o(){this.vo&&(this.vo.cancel(),this.vo=null)}async close(n,c){this.Fo(),this.$o(),this.So.cancel(),this.Po++,n!==4?this.So.reset():c&&c.code===Ze.RESOURCE_EXHAUSTED?(no(c.toString()),no("Using maximum backoff delay to prevent overloading the backend."),this.So.po()):c&&c.code===Ze.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.Bo(),this.stream.close(),this.stream=null),this.state=n,await this.listener.Jr(c)}Bo(){}auth(){this.state=1;const n=this.Lo(this.Po),c=this.Po;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([m,v])=>{this.Po===c&&this.Uo(m,v)},m=>{n(()=>{const v=new ct(Ze.UNKNOWN,"Fetching auth token failed: "+m.message);return this.qo(v)})})}Uo(n,c){const m=this.Lo(this.Po);this.stream=this.Go(n,c),this.stream.zr(()=>{m(()=>(this.state=2,this.vo=this.Jn.enqueueAfterDelay(this.Ro,1e4,()=>(this.Co()&&(this.state=3),Promise.resolve())),this.listener.zr()))}),this.stream.Jr(v=>{m(()=>this.qo(v))}),this.stream.onMessage(v=>{m(()=>this.onMessage(v))})}xo(){this.state=5,this.So.Io(async()=>{this.state=0,this.start()})}qo(n){return rt("PersistentStream",`close with error: ${n}`),this.stream=null,this.close(4,n)}Lo(n){return c=>{this.Jn.enqueueAndForget(()=>this.Po===n?c():(rt("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class pS extends dS{constructor(n,c,m,v,S,L){super(n,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",c,m,v,L),this.M=S}Go(n,c){return this.bo.ho("Listen",n,c)}onMessage(n){this.So.reset();const c=A2(this.M,n),m=function(v){if(!("targetChange"in v))return Mt.min();const S=v.targetChange;return S.targetIds&&S.targetIds.length?Mt.min():S.readTime?_h(S.readTime):Mt.min()}(n);return this.listener.Ko(c,m)}Qo(n){const c={};c.database=ex(this.M),c.addTarget=function(v,S){let L;const a=S.target;return L=im(a)?{documents:C2(v,a)}:{query:M2(v,a)},L.targetId=S.targetId,S.resumeToken.approximateByteSize()>0?L.resumeToken=E2(v,S.resumeToken):S.snapshotVersion.compareTo(Mt.min())>0&&(L.readTime=T2(v,S.snapshotVersion.toTimestamp())),L}(this.M,n);const m=D2(this.M,n);m&&(c.labels=m),this.Oo(c)}jo(n){const c={};c.database=ex(this.M),c.removeTarget=n,this.Oo(c)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fS extends class{}{constructor(n,c,m,v){super(),this.authCredentials=n,this.appCheckCredentials=c,this.bo=m,this.M=v,this.Zo=!1}tu(){if(this.Zo)throw new ct(Ze.FAILED_PRECONDITION,"The client has already been terminated.")}ro(n,c,m){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([v,S])=>this.bo.ro(n,c,m,v,S)).catch(v=>{throw v.name==="FirebaseError"?(v.code===Ze.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),v):new ct(Ze.UNKNOWN,v.toString())})}co(n,c,m){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([v,S])=>this.bo.co(n,c,m,v,S)).catch(v=>{throw v.name==="FirebaseError"?(v.code===Ze.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),v):new ct(Ze.UNKNOWN,v.toString())})}terminate(){this.Zo=!0}}class mS{constructor(n,c){this.asyncQueue=n,this.onlineStateHandler=c,this.state="Unknown",this.eu=0,this.nu=null,this.su=!0}iu(){this.eu===0&&(this.ru("Unknown"),this.nu=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.nu=null,this.ou("Backend didn't respond within 10 seconds."),this.ru("Offline"),Promise.resolve())))}uu(n){this.state==="Online"?this.ru("Unknown"):(this.eu++,this.eu>=1&&(this.au(),this.ou(`Connection failed 1 times. Most recent error: ${n.toString()}`),this.ru("Offline")))}set(n){this.au(),this.eu=0,n==="Online"&&(this.su=!1),this.ru(n)}ru(n){n!==this.state&&(this.state=n,this.onlineStateHandler(n))}ou(n){const c=`Could not reach Cloud Firestore backend. ${n}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.su?(no(c),this.su=!1):rt("OnlineStateTracker",c)}au(){this.nu!==null&&(this.nu.cancel(),this.nu=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _S{constructor(n,c,m,v,S){this.localStore=n,this.datastore=c,this.asyncQueue=m,this.remoteSyncer={},this.cu=[],this.hu=new Map,this.lu=new Set,this.fu=[],this.du=S,this.du.Br(L=>{m.enqueueAndForget(async()=>{kh(this)&&(rt("RemoteStore","Restarting streams for network reachability change."),await async function(a){const W=Ut(a);W.lu.add(4),await Mh(W),W._u.set("Unknown"),W.lu.delete(4),await Xd(W)}(this))})}),this._u=new mS(m,v)}}async function Xd(o){if(kh(o))for(const n of o.fu)await n(!0)}async function Mh(o){for(const n of o.fu)await n(!1)}function n0(o,n){const c=Ut(o);c.hu.has(n.targetId)||(c.hu.set(n.targetId,n),Jm(c)?Ym(c):ql(c).Co()&&Km(c,n))}function s0(o,n){const c=Ut(o),m=ql(c);c.hu.delete(n),m.Co()&&o0(c,n),c.hu.size===0&&(m.Co()?m.ko():kh(c)&&c._u.set("Unknown"))}function Km(o,n){o.wu.Z(n.targetId),ql(o).Qo(n)}function o0(o,n){o.wu.Z(n),ql(o).jo(n)}function Ym(o){o.wu=new x2({getRemoteKeysForTarget:n=>o.remoteSyncer.getRemoteKeysForTarget(n),Et:n=>o.hu.get(n)||null}),ql(o).start(),o._u.iu()}function Jm(o){return kh(o)&&!ql(o).Do()&&o.hu.size>0}function kh(o){return Ut(o).lu.size===0}function a0(o){o.wu=void 0}async function gS(o){o.hu.forEach((n,c)=>{Km(o,n)})}async function yS(o,n){a0(o),Jm(o)?(o._u.uu(n),Ym(o)):o._u.set("Unknown")}async function xS(o,n,c){if(o._u.set("Online"),n instanceof Hv&&n.state===2&&n.cause)try{await async function(m,v){const S=v.cause;for(const L of v.targetIds)m.hu.has(L)&&(await m.remoteSyncer.rejectListen(L,S),m.hu.delete(L),m.wu.removeTarget(L))}(o,n)}catch(m){rt("RemoteStore","Failed to remove targets %s: %s ",n.targetIds.join(","),m),await nx(o,m)}else if(n instanceof ud?o.wu.ut(n):n instanceof Xv?o.wu._t(n):o.wu.ht(n),!c.isEqual(Mt.min()))try{const m=await t0(o.localStore);c.compareTo(m)>=0&&await function(v,S){const L=v.wu.yt(S);return L.targetChanges.forEach((a,W)=>{if(a.resumeToken.approximateByteSize()>0){const ie=v.hu.get(W);ie&&v.hu.set(W,ie.withResumeToken(a.resumeToken,S))}}),L.targetMismatches.forEach(a=>{const W=v.hu.get(a);if(!W)return;v.hu.set(a,W.withResumeToken(Qi.EMPTY_BYTE_STRING,W.snapshotVersion)),o0(v,a);const ie=new aa(W.target,a,1,W.sequenceNumber);Km(v,ie)}),v.remoteSyncer.applyRemoteEvent(L)}(o,c)}catch(m){rt("RemoteStore","Failed to raise snapshot:",m),await nx(o,m)}}async function nx(o,n,c){if(!Ch(n))throw n;o.lu.add(1),await Mh(o),o._u.set("Offline"),c||(c=()=>t0(o.localStore)),o.asyncQueue.enqueueRetryable(async()=>{rt("RemoteStore","Retrying IndexedDB access"),await c(),o.lu.delete(1),await Xd(o)})}async function sx(o,n){const c=Ut(o);c.asyncQueue.verifyOperationInProgress(),rt("RemoteStore","RemoteStore received new credentials");const m=kh(c);c.lu.add(3),await Mh(c),m&&c._u.set("Unknown"),await c.remoteSyncer.handleCredentialChange(n),c.lu.delete(3),await Xd(c)}async function vS(o,n){const c=Ut(o);n?(c.lu.delete(2),await Xd(c)):n||(c.lu.add(2),await Mh(c),c._u.set("Unknown"))}function ql(o){return o.mu||(o.mu=function(n,c,m){const v=Ut(n);return v.tu(),new pS(c,v.bo,v.authCredentials,v.appCheckCredentials,v.M,m)}(o.datastore,o.asyncQueue,{zr:gS.bind(null,o),Jr:yS.bind(null,o),Ko:xS.bind(null,o)}),o.fu.push(async n=>{n?(o.mu.No(),Jm(o)?Ym(o):o._u.set("Unknown")):(await o.mu.stop(),a0(o))})),o.mu}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qm{constructor(n,c,m,v,S){this.asyncQueue=n,this.timerId=c,this.targetTimeMs=m,this.op=v,this.removalCallback=S,this.deferred=new oa,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(L=>{})}static createAndSchedule(n,c,m,v,S){const L=Date.now()+m,a=new Qm(n,c,L,v,S);return a.start(m),a}start(n){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),n)}skipDelay(){return this.handleDelayElapsed()}cancel(n){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new ct(Ze.CANCELLED,"Operation cancelled"+(n?": "+n:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(n=>this.deferred.resolve(n))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function l0(o,n){if(no("AsyncQueue",`${n}: ${o}`),Ch(o))return new ct(Ze.UNAVAILABLE,`${n}: ${o}`);throw o}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Dl{constructor(n){this.comparator=n?(c,m)=>n(c,m)||at.comparator(c.key,m.key):(c,m)=>at.comparator(c.key,m.key),this.keyedMap=lm(),this.sortedSet=new er(this.comparator)}static emptySet(n){return new Dl(n.comparator)}has(n){return this.keyedMap.get(n)!=null}get(n){return this.keyedMap.get(n)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(n){const c=this.keyedMap.get(n);return c?this.sortedSet.indexOf(c):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((c,m)=>(n(c),!1))}add(n){const c=this.delete(n.key);return c.copy(c.keyedMap.insert(n.key,n),c.sortedSet.insert(n,null))}delete(n){const c=this.get(n);return c?this.copy(this.keyedMap.remove(n),this.sortedSet.remove(c)):this}isEqual(n){if(!(n instanceof Dl)||this.size!==n.size)return!1;const c=this.sortedSet.getIterator(),m=n.sortedSet.getIterator();for(;c.hasNext();){const v=c.getNext().key,S=m.getNext().key;if(!v.isEqual(S))return!1}return!0}toString(){const n=[];return this.forEach(c=>{n.push(c.toString())}),n.length===0?"DocumentSet ()":`DocumentSet (
  `+n.join(`  
`)+`
)`}copy(n,c){const m=new Dl;return m.comparator=this.comparator,m.keyedMap=n,m.sortedSet=c,m}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ox{constructor(){this.yu=new er(at.comparator)}track(n){const c=n.doc.key,m=this.yu.get(c);m?n.type!==0&&m.type===3?this.yu=this.yu.insert(c,n):n.type===3&&m.type!==1?this.yu=this.yu.insert(c,{type:m.type,doc:n.doc}):n.type===2&&m.type===2?this.yu=this.yu.insert(c,{type:2,doc:n.doc}):n.type===2&&m.type===0?this.yu=this.yu.insert(c,{type:0,doc:n.doc}):n.type===1&&m.type===0?this.yu=this.yu.remove(c):n.type===1&&m.type===2?this.yu=this.yu.insert(c,{type:1,doc:m.doc}):n.type===0&&m.type===1?this.yu=this.yu.insert(c,{type:2,doc:n.doc}):kt():this.yu=this.yu.insert(c,n)}pu(){const n=[];return this.yu.inorderTraversal((c,m)=>{n.push(m)}),n}}class Ol{constructor(n,c,m,v,S,L,a,W){this.query=n,this.docs=c,this.oldDocs=m,this.docChanges=v,this.mutatedKeys=S,this.fromCache=L,this.syncStateChanged=a,this.excludesMetadataChanges=W}static fromInitialDocuments(n,c,m,v){const S=[];return c.forEach(L=>{S.push({type:0,doc:L})}),new Ol(n,c,Dl.emptySet(c),S,m,v,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(n){if(!(this.fromCache===n.fromCache&&this.syncStateChanged===n.syncStateChanged&&this.mutatedKeys.isEqual(n.mutatedKeys)&&qd(this.query,n.query)&&this.docs.isEqual(n.docs)&&this.oldDocs.isEqual(n.oldDocs)))return!1;const c=this.docChanges,m=n.docChanges;if(c.length!==m.length)return!1;for(let v=0;v<c.length;v++)if(c[v].type!==m[v].type||!c[v].doc.isEqual(m[v].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bS{constructor(){this.Iu=void 0,this.listeners=[]}}class wS{constructor(){this.queries=new Gl(n=>Fv(n),qd),this.onlineState="Unknown",this.Tu=new Set}}async function TS(o,n){const c=Ut(o),m=n.query;let v=!1,S=c.queries.get(m);if(S||(v=!0,S=new bS),v)try{S.Iu=await c.onListen(m)}catch(L){const a=l0(L,`Initialization of query '${nm(n.query)}' failed`);return void n.onError(a)}c.queries.set(m,S),S.listeners.push(n),n.Eu(c.onlineState),S.Iu&&n.Au(S.Iu)&&e_(c)}async function ES(o,n){const c=Ut(o),m=n.query;let v=!1;const S=c.queries.get(m);if(S){const L=S.listeners.indexOf(n);L>=0&&(S.listeners.splice(L,1),v=S.listeners.length===0)}if(v)return c.queries.delete(m),c.onUnlisten(m)}function SS(o,n){const c=Ut(o);let m=!1;for(const v of n){const S=v.query,L=c.queries.get(S);if(L){for(const a of L.listeners)a.Au(v)&&(m=!0);L.Iu=v}}m&&e_(c)}function IS(o,n,c){const m=Ut(o),v=m.queries.get(n);if(v)for(const S of v.listeners)S.onError(c);m.queries.delete(n)}function e_(o){o.Tu.forEach(n=>{n.next()})}class AS{constructor(n,c,m){this.query=n,this.Ru=c,this.bu=!1,this.Pu=null,this.onlineState="Unknown",this.options=m||{}}Au(n){if(!this.options.includeMetadataChanges){const m=[];for(const v of n.docChanges)v.type!==3&&m.push(v);n=new Ol(n.query,n.docs,n.oldDocs,m,n.mutatedKeys,n.fromCache,n.syncStateChanged,!0)}let c=!1;return this.bu?this.Vu(n)&&(this.Ru.next(n),c=!0):this.vu(n,this.onlineState)&&(this.Su(n),c=!0),this.Pu=n,c}onError(n){this.Ru.error(n)}Eu(n){this.onlineState=n;let c=!1;return this.Pu&&!this.bu&&this.vu(this.Pu,n)&&(this.Su(this.Pu),c=!0),c}vu(n,c){if(!n.fromCache)return!0;const m=c!=="Offline";return(!this.options.Du||!m)&&(!n.docs.isEmpty()||c==="Offline")}Vu(n){if(n.docChanges.length>0)return!0;const c=this.Pu&&this.Pu.hasPendingWrites!==n.hasPendingWrites;return!(!n.syncStateChanged&&!c)&&this.options.includeMetadataChanges===!0}Su(n){n=Ol.fromInitialDocuments(n.query,n.docs,n.mutatedKeys,n.fromCache),this.bu=!0,this.Ru.next(n)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class c0{constructor(n){this.key=n}}class h0{constructor(n){this.key=n}}class CS{constructor(n,c){this.query=n,this.Fu=c,this.$u=null,this.current=!1,this.Bu=di(),this.mutatedKeys=di(),this.Lu=Ov(n),this.Uu=new Dl(this.Lu)}get qu(){return this.Fu}Gu(n,c){const m=c?c.Ku:new ox,v=c?c.Uu:this.Uu;let S=c?c.mutatedKeys:this.mutatedKeys,L=v,a=!1;const W=cd(this.query)&&v.size===this.query.limit?v.last():null,ie=rm(this.query)&&v.size===this.query.limit?v.first():null;if(n.inorderTraversal((ge,ue)=>{const ze=v.get(ge),fe=qm(this.query,ue)?ue:null,it=!!ze&&this.mutatedKeys.has(ze.key),dt=!!fe&&(fe.hasLocalMutations||this.mutatedKeys.has(fe.key)&&fe.hasCommittedMutations);let pi=!1;ze&&fe?ze.data.isEqual(fe.data)?it!==dt&&(m.track({type:3,doc:fe}),pi=!0):this.Qu(ze,fe)||(m.track({type:2,doc:fe}),pi=!0,(W&&this.Lu(fe,W)>0||ie&&this.Lu(fe,ie)<0)&&(a=!0)):!ze&&fe?(m.track({type:0,doc:fe}),pi=!0):ze&&!fe&&(m.track({type:1,doc:ze}),pi=!0,(W||ie)&&(a=!0)),pi&&(fe?(L=L.add(fe),S=dt?S.add(ge):S.delete(ge)):(L=L.delete(ge),S=S.delete(ge)))}),cd(this.query)||rm(this.query))for(;L.size>this.query.limit;){const ge=cd(this.query)?L.last():L.first();L=L.delete(ge.key),S=S.delete(ge.key),m.track({type:1,doc:ge})}return{Uu:L,Ku:m,ei:a,mutatedKeys:S}}Qu(n,c){return n.hasLocalMutations&&c.hasCommittedMutations&&!c.hasLocalMutations}applyChanges(n,c,m){const v=this.Uu;this.Uu=n.Uu,this.mutatedKeys=n.mutatedKeys;const S=n.Ku.pu();S.sort((ie,ge)=>function(ue,ze){const fe=it=>{switch(it){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return kt()}};return fe(ue)-fe(ze)}(ie.type,ge.type)||this.Lu(ie.doc,ge.doc)),this.ju(m);const L=c?this.Wu():[],a=this.Bu.size===0&&this.current?1:0,W=a!==this.$u;return this.$u=a,S.length!==0||W?{snapshot:new Ol(this.query,n.Uu,v,S,n.mutatedKeys,a===0,W,!1),zu:L}:{zu:L}}Eu(n){return this.current&&n==="Offline"?(this.current=!1,this.applyChanges({Uu:this.Uu,Ku:new ox,mutatedKeys:this.mutatedKeys,ei:!1},!1)):{zu:[]}}Hu(n){return!this.Fu.has(n)&&!!this.Uu.has(n)&&!this.Uu.get(n).hasLocalMutations}ju(n){n&&(n.addedDocuments.forEach(c=>this.Fu=this.Fu.add(c)),n.modifiedDocuments.forEach(c=>{}),n.removedDocuments.forEach(c=>this.Fu=this.Fu.delete(c)),this.current=n.current)}Wu(){if(!this.current)return[];const n=this.Bu;this.Bu=di(),this.Uu.forEach(m=>{this.Hu(m.key)&&(this.Bu=this.Bu.add(m.key))});const c=[];return n.forEach(m=>{this.Bu.has(m)||c.push(new h0(m))}),this.Bu.forEach(m=>{n.has(m)||c.push(new c0(m))}),c}Ju(n){this.Fu=n.hi,this.Bu=di();const c=this.Gu(n.documents);return this.applyChanges(c,!0)}Yu(){return Ol.fromInitialDocuments(this.query,this.Uu,this.mutatedKeys,this.$u===0)}}class MS{constructor(n,c,m){this.query=n,this.targetId=c,this.view=m}}class kS{constructor(n){this.key=n,this.Xu=!1}}class DS{constructor(n,c,m,v,S,L){this.localStore=n,this.remoteStore=c,this.eventManager=m,this.sharedClientState=v,this.currentUser=S,this.maxConcurrentLimboResolutions=L,this.Zu={},this.ta=new Gl(a=>Fv(a),qd),this.ea=new Map,this.na=new Set,this.sa=new er(at.comparator),this.ia=new Map,this.ra=new Xm,this.oa={},this.ua=new Map,this.aa=Fl.gn(),this.onlineState="Unknown",this.ca=void 0}get isPrimaryClient(){return this.ca===!0}}async function zS(o,n){const c=NS(o);let m,v;const S=c.ta.get(n);if(S)m=S.targetId,c.sharedClientState.addLocalQueryTarget(m),v=S.view.Yu();else{const L=await Y2(c.localStore,pa(n));c.isPrimaryClient&&n0(c.remoteStore,L);const a=c.sharedClientState.addLocalQueryTarget(L.targetId);m=L.targetId,v=await PS(c,n,m,a==="current")}return v}async function PS(o,n,c,m){o.ha=(ge,ue,ze)=>async function(fe,it,dt,pi){let ti=it.view.Gu(dt);ti.ei&&(ti=await tx(fe.localStore,it.query,!1).then(({documents:Ti})=>it.view.Gu(Ti,ti)));const $i=pi&&pi.targetChanges.get(it.targetId),Gi=it.view.applyChanges(ti,fe.isPrimaryClient,$i);return lx(fe,it.targetId,Gi.zu),Gi.snapshot}(o,ge,ue,ze);const v=await tx(o.localStore,n,!0),S=new CS(n,v.hi),L=S.Gu(v.documents),a=Ah.createSynthesizedTargetChangeForCurrentChange(c,m&&o.onlineState!=="Offline"),W=S.applyChanges(L,o.isPrimaryClient,a);lx(o,c,W.zu);const ie=new MS(n,c,S);return o.ta.set(n,ie),o.ea.has(c)?o.ea.get(c).push(n):o.ea.set(c,[n]),W.snapshot}async function LS(o,n){const c=Ut(o),m=c.ta.get(n),v=c.ea.get(m.targetId);if(v.length>1)return c.ea.set(m.targetId,v.filter(S=>!qd(S,n))),void c.ta.delete(n);c.isPrimaryClient?(c.sharedClientState.removeLocalQueryTarget(m.targetId),c.sharedClientState.isActiveQueryTarget(m.targetId)||await hm(c.localStore,m.targetId,!1).then(()=>{c.sharedClientState.clearQueryState(m.targetId),s0(c.remoteStore,m.targetId),um(c,m.targetId)}).catch(Zm)):(um(c,m.targetId),await hm(c.localStore,m.targetId,!0))}async function u0(o,n){const c=Ut(o);try{const m=await H2(c.localStore,n);n.targetChanges.forEach((v,S)=>{const L=c.ia.get(S);L&&(Pi(v.addedDocuments.size+v.modifiedDocuments.size+v.removedDocuments.size<=1),v.addedDocuments.size>0?L.Xu=!0:v.modifiedDocuments.size>0?Pi(L.Xu):v.removedDocuments.size>0&&(Pi(L.Xu),L.Xu=!1))}),await p0(c,m,n)}catch(m){await Zm(m)}}function ax(o,n,c){const m=Ut(o);if(m.isPrimaryClient&&c===0||!m.isPrimaryClient&&c===1){const v=[];m.ta.forEach((S,L)=>{const a=L.view.Eu(n);a.snapshot&&v.push(a.snapshot)}),function(S,L){const a=Ut(S);a.onlineState=L;let W=!1;a.queries.forEach((ie,ge)=>{for(const ue of ge.listeners)ue.Eu(L)&&(W=!0)}),W&&e_(a)}(m.eventManager,n),v.length&&m.Zu.Ko(v),m.onlineState=n,m.isPrimaryClient&&m.sharedClientState.setOnlineState(n)}}async function RS(o,n,c){const m=Ut(o);m.sharedClientState.updateQueryState(n,"rejected",c);const v=m.ia.get(n),S=v&&v.key;if(S){let L=new er(at.comparator);L=L.insert(S,lr.newNoDocument(S,Mt.min()));const a=di().add(S),W=new Wd(Mt.min(),new Map,new Ji(Xt),L,a);await u0(m,W),m.sa=m.sa.remove(S),m.ia.delete(n),t_(m)}else await hm(m.localStore,n,!1).then(()=>um(m,n,c)).catch(Zm)}function um(o,n,c=null){o.sharedClientState.removeLocalQueryTarget(n);for(const m of o.ea.get(n))o.ta.delete(m),c&&o.Zu.la(m,c);o.ea.delete(n),o.isPrimaryClient&&o.ra.Ri(n).forEach(m=>{o.ra.containsKey(m)||d0(o,m)})}function d0(o,n){o.na.delete(n.path.canonicalString());const c=o.sa.get(n);c!==null&&(s0(o.remoteStore,c),o.sa=o.sa.remove(n),o.ia.delete(c),t_(o))}function lx(o,n,c){for(const m of c)m instanceof c0?(o.ra.addReference(m.key,n),BS(o,m)):m instanceof h0?(rt("SyncEngine","Document no longer in limbo: "+m.key),o.ra.removeReference(m.key,n),o.ra.containsKey(m.key)||d0(o,m.key)):kt()}function BS(o,n){const c=n.key,m=c.path.canonicalString();o.sa.get(c)||o.na.has(m)||(rt("SyncEngine","New document in limbo: "+c),o.na.add(m),t_(o))}function t_(o){for(;o.na.size>0&&o.sa.size<o.maxConcurrentLimboResolutions;){const n=o.na.values().next().value;o.na.delete(n);const c=new at(ui.fromString(n)),m=o.aa.next();o.ia.set(m,new kS(c)),o.sa=o.sa.insert(c,m),n0(o.remoteStore,new aa(pa(Gm(c.path)),m,2,Um.A))}}async function p0(o,n,c){const m=Ut(o),v=[],S=[],L=[];m.ta.isEmpty()||(m.ta.forEach((a,W)=>{L.push(m.ha(W,n,c).then(ie=>{if(ie){m.isPrimaryClient&&m.sharedClientState.updateQueryState(W.targetId,ie.fromCache?"not-current":"current"),v.push(ie);const ge=Wm.Js(W.targetId,ie);S.push(ge)}}))}),await Promise.all(L),m.Zu.Ko(v),await async function(a,W){const ie=Ut(a);try{await ie.persistence.runTransaction("notifyLocalViewChanges","readwrite",ge=>$e.forEach(W,ue=>$e.forEach(ue.zs,ze=>ie.persistence.referenceDelegate.addReference(ge,ue.targetId,ze)).next(()=>$e.forEach(ue.Hs,ze=>ie.persistence.referenceDelegate.removeReference(ge,ue.targetId,ze)))))}catch(ge){if(!Ch(ge))throw ge;rt("LocalStore","Failed to update sequence numbers: "+ge)}for(const ge of W){const ue=ge.targetId;if(!ge.fromCache){const ze=ie.si.get(ue),fe=ze.snapshotVersion,it=ze.withLastLimboFreeSnapshotVersion(fe);ie.si=ie.si.insert(ue,it)}}}(m.localStore,S))}async function FS(o,n){const c=Ut(o);if(!c.currentUser.isEqual(n)){rt("SyncEngine","User change. New user:",n.toKey());const m=await e0(c.localStore,n);c.currentUser=n,function(v,S){v.ua.forEach(L=>{L.forEach(a=>{a.reject(new ct(Ze.CANCELLED,S))})}),v.ua.clear()}(c,"'waitForPendingWrites' promise is rejected due to a user change."),c.sharedClientState.handleUserChange(n,m.removedBatchIds,m.addedBatchIds),await p0(c,m.ci)}}function OS(o,n){const c=Ut(o),m=c.ia.get(n);if(m&&m.Xu)return di().add(m.key);{let v=di();const S=c.ea.get(n);if(!S)return v;for(const L of S){const a=c.ta.get(L);v=v.unionWith(a.view.qu)}return v}}function NS(o){const n=Ut(o);return n.remoteStore.remoteSyncer.applyRemoteEvent=u0.bind(null,n),n.remoteStore.remoteSyncer.getRemoteKeysForTarget=OS.bind(null,n),n.remoteStore.remoteSyncer.rejectListen=RS.bind(null,n),n.Zu.Ko=SS.bind(null,n.eventManager),n.Zu.la=IS.bind(null,n.eventManager),n}class US{constructor(){this.synchronizeTabs=!1}async initialize(n){this.M=i0(n.databaseInfo.databaseId),this.sharedClientState=this.da(n),this.persistence=this._a(n),await this.persistence.start(),this.gcScheduler=this.wa(n),this.localStore=this.ma(n)}wa(n){return null}ma(n){return X2(this.persistence,new Z2,n.initialUser,this.M)}_a(n){return new sS(Hm.Wi,this.M)}da(n){return new aS}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class VS{async initialize(n,c){this.localStore||(this.localStore=n.localStore,this.sharedClientState=n.sharedClientState,this.datastore=this.createDatastore(c),this.remoteStore=this.createRemoteStore(c),this.eventManager=this.createEventManager(c),this.syncEngine=this.createSyncEngine(c,!n.synchronizeTabs),this.sharedClientState.onlineStateHandler=m=>ax(this.syncEngine,m,1),this.remoteStore.remoteSyncer.handleCredentialChange=FS.bind(null,this.syncEngine),await vS(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(n){return new wS}createDatastore(n){const c=i0(n.databaseInfo.databaseId),m=(v=n.databaseInfo,new uS(v));var v;return function(S,L,a,W){return new fS(S,L,a,W)}(n.authCredentials,n.appCheckCredentials,m,c)}createRemoteStore(n){return c=this.localStore,m=this.datastore,v=n.asyncQueue,S=a=>ax(this.syncEngine,a,0),L=rx.vt()?new rx:new lS,new _S(c,m,v,S,L);var c,m,v,S,L}createSyncEngine(n,c){return function(m,v,S,L,a,W,ie){const ge=new DS(m,v,S,L,a,W);return ie&&(ge.ca=!0),ge}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,n.initialUser,n.maxConcurrentLimboResolutions,c)}terminate(){return async function(n){const c=Ut(n);rt("RemoteStore","RemoteStore shutting down."),c.lu.add(5),await Mh(c),c.du.shutdown(),c._u.set("Unknown")}(this.remoteStore)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jS{constructor(n){this.observer=n,this.muted=!1}next(n){this.observer.next&&this.ya(this.observer.next,n)}error(n){this.observer.error?this.ya(this.observer.error,n):console.error("Uncaught Error in snapshot listener:",n)}pa(){this.muted=!0}ya(n,c){this.muted||setTimeout(()=>{this.muted||n(c)},0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $S{constructor(n,c,m,v){this.authCredentials=n,this.appCheckCredentials=c,this.asyncQueue=m,this.databaseInfo=v,this.user=Rr.UNAUTHENTICATED,this.clientId=Pv.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(m,async S=>{rt("FirestoreClient","Received user=",S.uid),await this.authCredentialListener(S),this.user=S}),this.appCheckCredentials.start(m,S=>(rt("FirestoreClient","Received new app check token=",S),this.appCheckCredentialListener(S,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(n){this.authCredentialListener=n}setAppCheckTokenChangeListener(n){this.appCheckCredentialListener=n}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new ct(Ze.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new oa;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(c){const m=l0(c,"Failed to shutdown persistence");n.reject(m)}}),n.promise}}async function GS(o,n){o.asyncQueue.verifyOperationInProgress(),rt("FirestoreClient","Initializing OfflineComponentProvider");const c=await o.getConfiguration();await n.initialize(c);let m=c.initialUser;o.setCredentialChangeListener(async v=>{m.isEqual(v)||(await e0(n.localStore,v),m=v)}),n.persistence.setDatabaseDeletedListener(()=>o.terminate()),o.offlineComponents=n}async function qS(o,n){o.asyncQueue.verifyOperationInProgress();const c=await ZS(o);rt("FirestoreClient","Initializing OnlineComponentProvider");const m=await o.getConfiguration();await n.initialize(c,m),o.setCredentialChangeListener(v=>sx(n.remoteStore,v)),o.setAppCheckTokenChangeListener((v,S)=>sx(n.remoteStore,S)),o.onlineComponents=n}async function ZS(o){return o.offlineComponents||(rt("FirestoreClient","Using default OfflineComponentProvider"),await GS(o,new US)),o.offlineComponents}async function WS(o){return o.onlineComponents||(rt("FirestoreClient","Using default OnlineComponentProvider"),await qS(o,new VS)),o.onlineComponents}async function XS(o){const n=await WS(o),c=n.eventManager;return c.onListen=zS.bind(null,n.syncEngine),c.onUnlisten=LS.bind(null,n.syncEngine),c}function HS(o,n,c={}){const m=new oa;return o.asyncQueue.enqueueAndForget(async()=>function(v,S,L,a,W){const ie=new jS({next:ue=>{S.enqueueAndForget(()=>ES(v,ge));const ze=ue.docs.has(L);!ze&&ue.fromCache?W.reject(new ct(Ze.UNAVAILABLE,"Failed to get document because the client is offline.")):ze&&ue.fromCache&&a&&a.source==="server"?W.reject(new ct(Ze.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):W.resolve(ue)},error:ue=>W.reject(ue)}),ge=new AS(Gm(L.path),ie,{includeMetadataChanges:!0,Du:!0});return TS(v,ge)}(await XS(o),o.asyncQueue,n,c,m)),m.promise}const cx=new Map;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function f0(o,n,c){if(!c)throw new ct(Ze.INVALID_ARGUMENT,`Function ${o}() cannot be called with an empty ${n}.`)}function KS(o,n,c,m){if(n===!0&&m===!0)throw new ct(Ze.INVALID_ARGUMENT,`${o} and ${c} cannot be used together.`)}function hx(o){if(!at.isDocumentKey(o))throw new ct(Ze.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${o} has ${o.length}.`)}function ux(o){if(at.isDocumentKey(o))throw new ct(Ze.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${o} has ${o.length}.`)}function YS(o){if(o===void 0)return"undefined";if(o===null)return"null";if(typeof o=="string")return o.length>20&&(o=`${o.substring(0,20)}...`),JSON.stringify(o);if(typeof o=="number"||typeof o=="boolean")return""+o;if(typeof o=="object"){if(o instanceof Array)return"an array";{const n=function(c){return c.constructor?c.constructor.name:null}(o);return n?`a custom ${n} object`:"an object"}}return typeof o=="function"?"a function":kt()}function dx(o,n){if("_delegate"in o&&(o=o._delegate),!(o instanceof n)){if(n.name===o.constructor.name)throw new ct(Ze.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const c=YS(o);throw new ct(Ze.INVALID_ARGUMENT,`Expected type '${n.name}', but it was: ${c}`)}}return o}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class px{constructor(n){var c;if(n.host===void 0){if(n.ssl!==void 0)throw new ct(Ze.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=n.host,this.ssl=(c=n.ssl)===null||c===void 0||c;if(this.credentials=n.credentials,this.ignoreUndefinedProperties=!!n.ignoreUndefinedProperties,n.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(n.cacheSizeBytes!==-1&&n.cacheSizeBytes<1048576)throw new ct(Ze.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=n.cacheSizeBytes}this.experimentalForceLongPolling=!!n.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!n.experimentalAutoDetectLongPolling,this.useFetchStreams=!!n.useFetchStreams,KS("experimentalForceLongPolling",n.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",n.experimentalAutoDetectLongPolling)}isEqual(n){return this.host===n.host&&this.ssl===n.ssl&&this.credentials===n.credentials&&this.cacheSizeBytes===n.cacheSizeBytes&&this.experimentalForceLongPolling===n.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===n.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===n.ignoreUndefinedProperties&&this.useFetchStreams===n.useFetchStreams}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class i_{constructor(n,c,m){this._authCredentials=c,this._appCheckCredentials=m,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new px({}),this._settingsFrozen=!1,n instanceof Ll?this._databaseId=n:(this._app=n,this._databaseId=function(v){if(!Object.prototype.hasOwnProperty.apply(v.options,["projectId"]))throw new ct(Ze.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Ll(v.options.projectId)}(n))}get app(){if(!this._app)throw new ct(Ze.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!==void 0}_setSettings(n){if(this._settingsFrozen)throw new ct(Ze.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new px(n),n.credentials!==void 0&&(this._authCredentials=function(c){if(!c)return new ME;switch(c.type){case"gapi":const m=c.client;return Pi(!(typeof m!="object"||m===null||!m.auth||!m.auth.getAuthHeaderValueForFirstParty)),new zE(m,c.sessionIndex||"0",c.iamToken||null);case"provider":return c.client;default:throw new ct(Ze.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(n.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(n){const c=cx.get(n);c&&(rt("ComponentProvider","Removing Datastore"),cx.delete(n),c.terminate())}(this),Promise.resolve()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xn{constructor(n,c,m){this.converter=c,this._key=m,this.type="document",this.firestore=n}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new ro(this.firestore,this.converter,this._key.path.popLast())}withConverter(n){return new Xn(this.firestore,n,this._key)}}class r_{constructor(n,c,m){this.converter=c,this._query=m,this.type="query",this.firestore=n}withConverter(n){return new r_(this.firestore,n,this._query)}}class ro extends r_{constructor(n,c,m){super(n,c,Gm(m)),this._path=m,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const n=this._path.popLast();return n.isEmpty()?null:new Xn(this.firestore,null,new at(n))}withConverter(n){return new ro(this.firestore,n,this._path)}}function $I(o,n,...c){if(o=Ix(o),f0("collection","path",n),o instanceof i_){const m=ui.fromString(n,...c);return ux(m),new ro(o,null,m)}{if(!(o instanceof Xn||o instanceof ro))throw new ct(Ze.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const m=o._path.child(ui.fromString(n,...c));return ux(m),new ro(o.firestore,null,m)}}function GI(o,n,...c){if(o=Ix(o),arguments.length===1&&(n=Pv.R()),f0("doc","path",n),o instanceof i_){const m=ui.fromString(n,...c);return hx(m),new Xn(o,null,new at(m))}{if(!(o instanceof Xn||o instanceof ro))throw new ct(Ze.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const m=o._path.child(ui.fromString(n,...c));return hx(m),new Xn(o.firestore,o instanceof ro?o.converter:null,new at(m))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class JS{constructor(){this.Na=Promise.resolve(),this.ka=[],this.Ma=!1,this.Oa=[],this.Fa=null,this.$a=!1,this.Ba=!1,this.La=[],this.So=new r0(this,"async_queue_retry"),this.Ua=()=>{const c=Lf();c&&rt("AsyncQueue","Visibility state changed to "+c.visibilityState),this.So.Eo()};const n=Lf();n&&typeof n.addEventListener=="function"&&n.addEventListener("visibilitychange",this.Ua)}get isShuttingDown(){return this.Ma}enqueueAndForget(n){this.enqueue(n)}enqueueAndForgetEvenWhileRestricted(n){this.qa(),this.Ga(n)}enterRestrictedMode(n){if(!this.Ma){this.Ma=!0,this.Ba=n||!1;const c=Lf();c&&typeof c.removeEventListener=="function"&&c.removeEventListener("visibilitychange",this.Ua)}}enqueue(n){if(this.qa(),this.Ma)return new Promise(()=>{});const c=new oa;return this.Ga(()=>this.Ma&&this.Ba?Promise.resolve():(n().then(c.resolve,c.reject),c.promise)).then(()=>c.promise)}enqueueRetryable(n){this.enqueueAndForget(()=>(this.ka.push(n),this.Ka()))}async Ka(){if(this.ka.length!==0){try{await this.ka[0](),this.ka.shift(),this.So.reset()}catch(n){if(!Ch(n))throw n;rt("AsyncQueue","Operation failed with retryable error: "+n)}this.ka.length>0&&this.So.Io(()=>this.Ka())}}Ga(n){const c=this.Na.then(()=>(this.$a=!0,n().catch(m=>{this.Fa=m,this.$a=!1;const v=function(S){let L=S.message||"";return S.stack&&(L=S.stack.includes(S.message)?S.stack:S.message+`
`+S.stack),L}(m);throw no("INTERNAL UNHANDLED ERROR: ",v),m}).then(m=>(this.$a=!1,m))));return this.Na=c,c}enqueueAfterDelay(n,c,m){this.qa(),this.La.indexOf(n)>-1&&(c=0);const v=Qm.createAndSchedule(this,n,c,m,S=>this.Qa(S));return this.Oa.push(v),v}qa(){this.Fa&&kt()}verifyOperationInProgress(){}async ja(){let n;do n=this.Na,await n;while(n!==this.Na)}Wa(n){for(const c of this.Oa)if(c.timerId===n)return!0;return!1}za(n){return this.ja().then(()=>{this.Oa.sort((c,m)=>c.targetTimeMs-m.targetTimeMs);for(const c of this.Oa)if(c.skipDelay(),n!=="all"&&c.timerId===n)break;return this.ja()})}Ha(n){this.La.push(n)}Qa(n){const c=this.Oa.indexOf(n);this.Oa.splice(c,1)}}class m0 extends i_{constructor(n,c,m){super(n,c,m),this.type="firestore",this._queue=new JS,this._persistenceKey="name"in n?n.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||_0(this),this._firestoreClient.terminate()}}function qI(o=cT()){return sT(o,"firestore").getImmediate()}function QS(o){return o._firestoreClient||_0(o),o._firestoreClient.verifyNotTerminated(),o._firestoreClient}function _0(o){var n;const c=o._freezeSettings(),m=function(v,S,L,a){return new NE(v,S,L,a.host,a.ssl,a.experimentalForceLongPolling,a.experimentalAutoDetectLongPolling,a.useFetchStreams)}(o._databaseId,((n=o._app)===null||n===void 0?void 0:n.options.appId)||"",o._persistenceKey,c);o._firestoreClient=new $S(o._authCredentials,o._appCheckCredentials,o._queue,m)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class g0{constructor(...n){for(let c=0;c<n.length;++c)if(n[c].length===0)throw new ct(Ze.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new En(n)}isEqual(n){return this._internalPath.isEqual(n._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Id{constructor(n){this._byteString=n}static fromBase64String(n){try{return new Id(Qi.fromBase64String(n))}catch(c){throw new ct(Ze.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+c)}}static fromUint8Array(n){return new Id(Qi.fromUint8Array(n))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(n){return this._byteString.isEqual(n._byteString)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class eI{constructor(n,c){if(!isFinite(n)||n<-90||n>90)throw new ct(Ze.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+n);if(!isFinite(c)||c<-180||c>180)throw new ct(Ze.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+c);this._lat=n,this._long=c}get latitude(){return this._lat}get longitude(){return this._long}isEqual(n){return this._lat===n._lat&&this._long===n._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(n){return Xt(this._lat,n._lat)||Xt(this._long,n._long)}}const tI=new RegExp("[~\\*/\\[\\]]");function iI(o,n,c){if(n.search(tI)>=0)throw fx(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,o,!1,void 0,c);try{return new g0(...n.split("."))._internalPath}catch{throw fx(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,o,!1,void 0,c)}}function fx(o,n,c,m,v){const S=m&&!m.isEmpty(),L=v!==void 0;let a=`Function ${n}() called with invalid data`;c&&(a+=" (via `toFirestore()`)"),a+=". ";let W="";return(S||L)&&(W+=" (found",S&&(W+=` in field ${m}`),L&&(W+=` in document ${v}`),W+=")"),new ct(Ze.INVALID_ARGUMENT,a+o+W)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class y0{constructor(n,c,m,v,S){this._firestore=n,this._userDataWriter=c,this._key=m,this._document=v,this._converter=S}get id(){return this._key.path.lastSegment()}get ref(){return new Xn(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const n=new rI(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(n)}return this._userDataWriter.convertValue(this._document.data.value)}}get(n){if(this._document){const c=this._document.data.field(x0("DocumentSnapshot.get",n));if(c!==null)return this._userDataWriter.convertValue(c)}}}class rI extends y0{data(){return super.data()}}function x0(o,n){return typeof n=="string"?iI(o,n):n instanceof g0?n._internalPath:n._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nI{constructor(n,c){this.hasPendingWrites=n,this.fromCache=c}isEqual(n){return this.hasPendingWrites===n.hasPendingWrites&&this.fromCache===n.fromCache}}class v0 extends y0{constructor(n,c,m,v,S,L){super(n,c,m,v,L),this._firestore=n,this._firestoreImpl=n,this.metadata=S}exists(){return super.exists()}data(n={}){if(this._document){if(this._converter){const c=new sI(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(c,n)}return this._userDataWriter.convertValue(this._document.data.value,n.serverTimestamps)}}get(n,c={}){if(this._document){const m=this._document.data.field(x0("DocumentSnapshot.get",n));if(m!==null)return this._userDataWriter.convertValue(m,c.serverTimestamps)}}}class sI extends v0{data(n={}){return super.data(n)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class oI{convertValue(n,c="none"){switch(da(n)){case 0:return null;case 1:return n.booleanValue;case 2:return zi(n.integerValue||n.doubleValue);case 3:return this.convertTimestamp(n.timestampValue);case 4:return this.convertServerTimestamp(n,c);case 5:return n.stringValue;case 6:return this.convertBytes(Pl(n.bytesValue));case 7:return this.convertReference(n.referenceValue);case 8:return this.convertGeoPoint(n.geoPointValue);case 9:return this.convertArray(n.arrayValue,c);case 10:return this.convertObject(n.mapValue,c);default:throw kt()}}convertObject(n,c){const m={};return $d(n.fields,(v,S)=>{m[v]=this.convertValue(S,c)}),m}convertGeoPoint(n){return new eI(zi(n.latitude),zi(n.longitude))}convertArray(n,c){return(n.values||[]).map(m=>this.convertValue(m,c))}convertServerTimestamp(n,c){switch(c){case"previous":const m=Rv(n);return m==null?null:this.convertValue(m,c);case"estimate":return this.convertTimestamp(ph(n));default:return null}}convertTimestamp(n){const c=so(n);return new Sn(c.seconds,c.nanos)}convertDocumentKey(n,c){const m=ui.fromString(n);Pi(Qv(m));const v=new Ll(m.get(1),m.get(3)),S=new at(m.popFirst(5));return v.isEqual(c)||no(`Document ${S} contains a document reference within a different database (${v.projectId}/${v.database}) which is not supported. It will be treated as a reference in the current database (${c.projectId}/${c.database}) instead.`),S}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ZI(o){o=dx(o,Xn);const n=dx(o.firestore,m0);return HS(QS(n),o._key).then(c=>lI(n,o,c))}class aI extends oI{constructor(n){super(),this.firestore=n}convertBytes(n){return new Id(n)}convertReference(n){const c=this.convertDocumentKey(n,this.firestore._databaseId);return new Xn(this.firestore,null,c)}}function lI(o,n,c){const m=c.docs.get(n._key),v=new aI(o);return new v0(o,v,n._key,m,new nI(c.hasPendingWrites,c.fromCache),n.converter)}(function(o,n=!0){(function(c){jl=c})(lT),pd(new nh("firestore",(c,{options:m})=>{const v=c.getProvider("app").getImmediate(),S=new m0(v,new kE(c.getProvider("auth-internal")),new LE(c.getProvider("app-check-internal")));return m=Object.assign({useFetchStreams:n},m),S._setSettings(m),S},"PUBLIC")),Ml(Ry,"3.4.7",o),Ml(Ry,"3.4.7","esm2017")})();export{LI as A,rw as B,Nb as C,UI as D,CI as E,hI as F,Wb as G,dI as H,pI as I,uI as J,Yc as K,TI as L,gI as M,xI as N,gh as O,jI as P,qI as Q,VI as R,NI as S,$I as T,GI as U,dy as V,RI as W,cI as X,ZI as Y,MI as Z,Kb as a,yI as b,vI as c,Xb as d,Hb as e,EI as f,fI as g,Qb as h,OI as i,wI as j,mI as k,_I as l,bI as m,kI as n,zI as o,DI as p,tw as q,AI as r,Vb as s,dm as t,II as u,SI as v,BI as w,FI as x,iw as y,PI as z};
